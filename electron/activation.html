<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Cerebro - Setup</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0a0a0f;
      color: #e2e8f0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
    }

    .wizard {
      width: 520px;
      min-height: 480px;
      position: relative;
    }

    .step {
      display: none;
      background: radial-gradient(ellipse at center, #1a1025 0%, #0a0a0f 100%);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 20px;
      padding: 48px;
      text-align: center;
      box-shadow: 0 0 60px rgba(139, 92, 246, 0.1);
      animation: fadeIn 0.3s ease-out;
    }

    .step.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .orb-container {
      width: 96px;
      height: 96px;
      margin: 0 auto 24px;
      position: relative;
    }
    .orb-container svg {
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 0 20px rgba(139, 92, 246, 0.5));
    }
    @keyframes orbGlow {
      0%, 100% { filter: drop-shadow(0 0 20px rgba(139, 92, 246, 0.4)); }
      50% { filter: drop-shadow(0 0 35px rgba(139, 92, 246, 0.7)); }
    }
    .orb-animated svg {
      animation: orbGlow 3s ease-in-out infinite;
    }

    h1 {
      font-size: 28px;
      font-weight: 300;
      letter-spacing: 6px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 20px;
      font-weight: 300;
      letter-spacing: 3px;
      margin-bottom: 8px;
    }
    .subtitle {
      color: rgba(139, 92, 246, 0.6);
      font-size: 13px;
      letter-spacing: 1px;
      margin-bottom: 32px;
      line-height: 1.6;
    }
    .tagline {
      color: rgba(139, 92, 246, 0.7);
      font-size: 15px;
      letter-spacing: 2px;
      margin-bottom: 40px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    label {
      display: block;
      font-size: 12px;
      color: rgba(226, 232, 240, 0.5);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    .input-hint {
      font-size: 11px;
      color: rgba(226, 232, 240, 0.3);
      margin-top: 6px;
      text-transform: none;
      letter-spacing: 0;
    }
    input[type="text"] {
      width: 100%;
      padding: 14px 16px;
      background: rgba(139, 92, 246, 0.05);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 16px;
      font-family: 'Courier New', monospace;
      letter-spacing: 2px;
      outline: none;
      transition: border-color 0.2s;
    }
    input[type="text"]:focus {
      border-color: rgba(139, 92, 246, 0.5);
    }
    input[type="text"]::placeholder {
      color: rgba(226, 232, 240, 0.2);
      letter-spacing: 1px;
      font-size: 13px;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 10px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .btn-secondary {
      background: transparent;
      color: rgba(139, 92, 246, 0.7);
      border: 1px solid rgba(139, 92, 246, 0.2);
    }
    .btn-secondary:hover {
      border-color: rgba(139, 92, 246, 0.4);
      color: rgba(139, 92, 246, 0.9);
    }
    .btn-ghost {
      background: transparent;
      color: rgba(226, 232, 240, 0.4);
      font-size: 12px;
      padding: 10px;
    }
    .btn-ghost:hover {
      color: rgba(226, 232, 240, 0.7);
    }

    .status {
      margin-top: 16px;
      font-size: 13px;
      min-height: 20px;
    }
    .status-error { color: #f87171; }
    .status-success { color: #4ade80; }
    .status-loading { color: rgba(139, 92, 246, 0.7); }

    .prereq-list {
      text-align: left;
      margin: 24px 0;
    }
    .prereq-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: rgba(139, 92, 246, 0.03);
      border: 1px solid rgba(139, 92, 246, 0.1);
      border-radius: 10px;
      margin-bottom: 10px;
      transition: all 0.3s;
    }
    .prereq-item.checking { border-color: rgba(139, 92, 246, 0.3); }
    .prereq-item.pass {
      border-color: rgba(74, 222, 128, 0.3);
      background: rgba(74, 222, 128, 0.03);
    }
    .prereq-item.fail {
      border-color: rgba(248, 113, 113, 0.3);
      background: rgba(248, 113, 113, 0.03);
    }
    .prereq-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    .prereq-info { flex: 1; }
    .prereq-name {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 2px;
    }
    .prereq-detail {
      font-size: 11px;
      color: rgba(226, 232, 240, 0.4);
    }
    .prereq-link {
      font-size: 11px;
      color: rgba(139, 92, 246, 0.6);
      text-decoration: none;
      cursor: pointer;
    }
    .prereq-link:hover {
      color: rgba(139, 92, 246, 0.9);
      text-decoration: underline;
    }
    .prereq-action { flex-shrink: 0; }
    .prereq-action .btn-sm {
      padding: 6px 14px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
    }
    .btn-install {
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
    }
    .btn-install:hover {
      box-shadow: 0 2px 12px rgba(139, 92, 246, 0.3);
    }
    .btn-start {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    .btn-start:hover {
      box-shadow: 0 2px 12px rgba(59, 130, 246, 0.3);
    }
    .prereq-item.info {
      border-color: rgba(234, 179, 8, 0.3);
      background: rgba(234, 179, 8, 0.03);
    }
    .prereq-item.info .prereq-icon { color: #eab308; }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(139, 92, 246, 0.2);
      border-top: 2px solid #8b5cf6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .progress-container { margin: 32px 0; }
    .progress-bar-track {
      width: 100%;
      height: 4px;
      background: rgba(139, 92, 246, 0.1);
      border-radius: 2px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #8b5cf6, #a78bfa);
      border-radius: 2px;
      width: 0%;
      transition: width 0.5s ease;
    }
    .progress-status {
      margin-top: 16px;
      font-size: 13px;
      color: rgba(139, 92, 246, 0.7);
      min-height: 40px;
    }
    .progress-step {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
      color: rgba(226, 232, 240, 0.4);
    }
    .progress-step.done { color: #4ade80; }
    .progress-step.active { color: rgba(139, 92, 246, 0.8); }
    .progress-step .icon { width: 16px; text-align: center; }

    .success-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      border-radius: 50%;
      background: rgba(74, 222, 128, 0.1);
      border: 2px solid rgba(74, 222, 128, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: scaleIn 0.4s ease-out;
    }
    @keyframes scaleIn {
      from { transform: scale(0.5); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .success-icon svg {
      width: 40px;
      height: 40px;
      color: #4ade80;
    }
    .plan-badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin: 16px 0 24px;
    }
    .plan-pro { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
    .plan-pro-plus { background: rgba(139, 92, 246, 0.15); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.3); }

    .mcp-info {
      background: rgba(139, 92, 246, 0.05);
      border: 1px solid rgba(139, 92, 246, 0.15);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      text-align: left;
    }
    .mcp-info-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #a78bfa;
    }
    .mcp-info-body {
      font-size: 13px;
      color: rgba(226, 232, 240, 0.5);
      line-height: 1.5;
    }

    .step-dots {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
    }
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(139, 92, 246, 0.2);
      transition: all 0.3s;
    }
    .dot.active { background: #8b5cf6; transform: scale(1.2); }
    .dot.done { background: #4ade80; }

    .links {
      margin-top: 16px;
      font-size: 12px;
      color: rgba(226, 232, 240, 0.3);
    }
    .links a {
      color: rgba(139, 92, 246, 0.6);
      text-decoration: none;
    }
    .links a:hover {
      color: rgba(139, 92, 246, 0.9);
      text-decoration: underline;
    }

    .countdown-container {
      width: 140px;
      height: 140px;
      margin: 24px auto;
    }
    .countdown-ring { width: 100%; height: 100%; }
    .ring-progress {
      transition: stroke-dashoffset 1s linear;
    }
    @keyframes countdownPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .countdown-number { font-family: 'Segoe UI', system-ui, sans-serif; }
  </style>
</head>
<body>
  <div class="wizard">
    <!-- Step 1: Welcome -->
    <div class="step active" id="step-welcome">
      <div class="orb-container orb-animated">
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <radialGradient id="g1" cx="50%" cy="40%" r="50%">
              <stop offset="0%" stop-color="#c4b5fd"/>
              <stop offset="40%" stop-color="#8b5cf6"/>
              <stop offset="100%" stop-color="#4c1d95"/>
            </radialGradient>
          </defs>
          <circle cx="50" cy="50" r="44" fill="url(#g1)" opacity="0.9"/>
          <circle cx="50" cy="50" r="44" fill="none" stroke="rgba(167,139,250,0.3)" stroke-width="0.5"/>
          <circle cx="50" cy="28" r="3" fill="#e2e8f0" opacity="0.8"/>
          <circle cx="33" cy="42" r="2.5" fill="#e2e8f0" opacity="0.6"/>
          <circle cx="67" cy="42" r="2.5" fill="#e2e8f0" opacity="0.6"/>
          <circle cx="38" cy="60" r="2" fill="#e2e8f0" opacity="0.5"/>
          <circle cx="62" cy="60" r="2" fill="#e2e8f0" opacity="0.5"/>
          <circle cx="50" cy="72" r="2.5" fill="#e2e8f0" opacity="0.7"/>
          <line x1="50" y1="28" x2="33" y2="42" stroke="#e2e8f0" stroke-width="0.5" opacity="0.3"/>
          <line x1="50" y1="28" x2="67" y2="42" stroke="#e2e8f0" stroke-width="0.5" opacity="0.3"/>
          <line x1="33" y1="42" x2="38" y2="60" stroke="#e2e8f0" stroke-width="0.5" opacity="0.3"/>
          <line x1="67" y1="42" x2="62" y2="60" stroke="#e2e8f0" stroke-width="0.5" opacity="0.3"/>
          <line x1="38" y1="60" x2="50" y2="72" stroke="#e2e8f0" stroke-width="0.5" opacity="0.3"/>
          <line x1="62" y1="60" x2="50" y2="72" stroke="#e2e8f0" stroke-width="0.5" opacity="0.3"/>
          <line x1="33" y1="42" x2="67" y2="42" stroke="#e2e8f0" stroke-width="0.3" opacity="0.2"/>
          <line x1="38" y1="60" x2="62" y2="60" stroke="#e2e8f0" stroke-width="0.3" opacity="0.2"/>
        </svg>
      </div>
      <h1>Cerebro</h1>
      <div class="tagline">Your AI just came alive</div>
      <button class="btn btn-primary" onclick="goToStep(2)">Get Started</button>
      <div class="links">
        <a href="https://cerebro.life" target="_blank">cerebro.life</a>
      </div>
    </div>

    <!-- Step 2: Activate -->
    <div class="step" id="step-activate">
      <div class="step-dots">
        <div class="dot done"></div>
        <div class="dot active"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <h2>Activate Cerebro</h2>
      <div class="subtitle">Enter your license key or activation code</div>
      <div class="form-group">
        <label for="license-input">License Key / Activation Code</label>
        <input type="text" id="license-input" placeholder="CPRP-XXXXXXXX-... or KPWDH7PY" autocomplete="off" spellcheck="false">
        <div class="input-hint">Accepts license keys (CPRO/CPRP-...) or 8-character activation codes</div>
      </div>
      <button class="btn btn-primary" id="activate-btn" onclick="activateLicense()">Activate</button>
      <button class="btn btn-secondary" onclick="window.open('https://cerebro.life/pricing', '_blank')">Buy a License</button>
      <div class="status" id="activate-status"></div>
    </div>

    <!-- Step 3: Prerequisites -->
    <div class="step" id="step-prereqs">
      <div class="step-dots">
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot active"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <h2>Prerequisites</h2>
      <div class="subtitle">Cerebro needs Docker to run</div>
      <div class="prereq-list">
        <!-- Docker row -->
        <div class="prereq-item" id="prereq-docker">
          <div class="prereq-icon"><div class="spinner"></div></div>
          <div class="prereq-info">
            <div class="prereq-name">Docker Desktop</div>
            <div class="prereq-detail" id="prereq-docker-detail">Checking...</div>
          </div>
          <div class="prereq-action" id="prereq-docker-action"></div>
        </div>
        <!-- Docker install progress (hidden by default) -->
        <div class="prereq-item" id="prereq-docker-progress" style="display:none;">
          <div class="prereq-info" style="width:100%;">
            <div class="prereq-name" id="docker-progress-title">Installing Docker...</div>
            <div class="progress-bar-track" style="margin-top:8px;">
              <div class="progress-bar-fill" id="docker-progress-fill" style="width:0%;"></div>
            </div>
            <div class="prereq-detail" id="docker-progress-detail" style="margin-top:6px;">Preparing...</div>
          </div>
        </div>
        <!-- Claude Code row (informational, not blocking) -->
        <div class="prereq-item" id="prereq-claude">
          <div class="prereq-icon"><div class="spinner"></div></div>
          <div class="prereq-info">
            <div class="prereq-name">Claude Code</div>
            <div class="prereq-detail" id="prereq-claude-detail">Checking...</div>
          </div>
        </div>
      </div>
      <button class="btn btn-primary" id="prereq-continue-btn" disabled onclick="proceedAfterPrereqs()">Continue</button>
      <button class="btn btn-ghost" onclick="checkPrerequisites()">Re-check</button>
      <div class="status" id="prereq-status"></div>
    </div>

    <!-- Step 4: Restart -->
    <div class="step" id="step-restart">
      <div class="step-dots">
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot active"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <h2>Restart Required</h2>
      <div class="subtitle">Docker was installed but needs a restart to finish setup</div>
      <div class="countdown-container">
        <svg class="countdown-ring" viewBox="0 0 120 120">
          <circle class="ring-bg" cx="60" cy="60" r="52" fill="none" stroke="rgba(139,92,246,0.1)" stroke-width="4"/>
          <circle class="ring-progress" cx="60" cy="60" r="52" fill="none" stroke="#8b5cf6" stroke-width="4"
            stroke-linecap="round" stroke-dasharray="326.73" stroke-dashoffset="0"
            transform="rotate(-90 60 60)"/>
          <text class="countdown-number" x="60" y="68" text-anchor="middle" fill="#e2e8f0" font-size="36" font-weight="300">15</text>
        </svg>
      </div>
      <div class="subtitle" id="restart-message">Your computer will restart automatically</div>
      <button class="btn btn-primary" id="restart-now-btn" onclick="restartNow()">Restart Now</button>
      <button class="btn btn-ghost" onclick="restartLater()">I'll restart later</button>
      <div class="status" id="restart-status"></div>
    </div>

    <!-- Step 5: Setup -->
    <div class="step" id="step-setup">
      <div class="step-dots">
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot active"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <h2>Setting Up</h2>
      <div class="subtitle">Downloading and configuring Cerebro</div>
      <div class="progress-container">
        <div class="progress-bar-track">
          <div class="progress-bar-fill" id="setup-progress-fill"></div>
        </div>
        <div class="progress-status" id="setup-progress-steps">
          <div class="progress-step" id="ps-config"><span class="icon">&#9675;</span> Writing configuration...</div>
          <div class="progress-step" id="ps-pull"><span class="icon">&#9675;</span> Pulling Docker images...</div>
          <div class="progress-step" id="ps-ready"><span class="icon">&#9675;</span> Verifying setup...</div>
        </div>
      </div>
      <div class="status" id="setup-status"></div>
    </div>

    <!-- Step 6: MCP Configuration -->
    <div class="step" id="step-mcp">
      <div class="step-dots">
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot active"></div>
        <div class="dot"></div>
      </div>
      <h2>Claude Code Integration</h2>
      <div class="subtitle">Optional: Connect Cerebro's cognitive tools to Claude Code</div>
      <div class="mcp-info">
        <div class="mcp-info-title">What does this do?</div>
        <div class="mcp-info-body">This configures Claude Code to use Cerebro's MCP server running in Docker, giving it access to 49 cognitive tools including memory, reasoning, and goal tracking. Your ~/.claude/mcp.json will be updated.</div>
      </div>
      <button class="btn btn-primary" id="mcp-setup-btn" onclick="setupMcp()">Yes, Set It Up</button>
      <button class="btn btn-ghost" onclick="goToStep(7)">Skip for Now</button>
      <div class="status" id="mcp-status"></div>
    </div>

    <!-- Step 7: Ready -->
    <div class="step" id="step-ready">
      <div class="step-dots">
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot done"></div>
        <div class="dot done"></div>
      </div>
      <div class="success-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </div>
      <h2>Cerebro is Ready!</h2>
      <div id="plan-badge-container"></div>
      <div class="subtitle">All systems operational. Welcome aboard.</div>
      <button id="launch-btn" class="btn btn-primary" onclick="launchCerebro()">Launch Cerebro</button>
      <div id="launch-status" class="status" style="margin-top: 12px;"></div>
    </div>
  </div>

  <script>
    let currentStep = 1;
    let activatedPlan = null;
    let prereqsPassed = false;

    const licenseInput = document.getElementById('license-input');
    const activateBtn = document.getElementById('activate-btn');

    licenseInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') activateLicense();
    });

    if (window.cerebroDesktop.onPullProgress) {
      window.cerebroDesktop.onPullProgress(function(data) {
        var el = document.getElementById('setup-status');
        if (el && data.message) {
          el.textContent = data.message;
          el.className = 'status status-loading';
        }
      });
    }

    function goToStep(step) {
      document.querySelectorAll('.step').forEach(function(s) { s.classList.remove('active'); });
      currentStep = step;

      var stepIds = ['step-welcome', 'step-activate', 'step-prereqs', 'step-restart', 'step-setup', 'step-mcp', 'step-ready'];
      var el = document.getElementById(stepIds[step - 1]);
      if (el) el.classList.add('active');

      if (step === 2) {
        setTimeout(function() { licenseInput.focus(); }, 100);
      }
      if (step === 3) {
        checkPrerequisites();
      }
      if (step === 4) {
        startRestartCountdown();
      }
      if (step === 5) {
        runSetup();
      }
      if (step === 7) {
        showReadyStep();
      }
    }

    function activateLicense() {
      var key = licenseInput.value.trim();
      if (!key) {
        showStatus('activate-status', 'Please enter a license key or activation code', 'error');
        return;
      }

      activateBtn.disabled = true;
      showStatus('activate-status', 'Validating...', 'loading');

      window.cerebroDesktop.activateLicense(key).then(function(result) {
        if (result.success) {
          activatedPlan = result.plan;
          showStatus('activate-status', 'Activated!', 'success');
          setTimeout(function() { goToStep(3); }, 800);
        } else {
          showStatus('activate-status', result.error || 'Activation failed', 'error');
          activateBtn.disabled = false;
        }
      }).catch(function() {
        showStatus('activate-status', 'Connection error. Please check your internet.', 'error');
        activateBtn.disabled = false;
      });
    }

    function setPrereqResult(itemId, detailId, state, detailText, linkUrl, linkText) {
      var item = document.getElementById(itemId);
      var detail = document.getElementById(detailId);
      var iconEl = item.querySelector('.prereq-icon');

      item.className = 'prereq-item ' + state;

      if (state === 'pass') {
        iconEl.textContent = '\u2713';
      } else if (state === 'fail') {
        iconEl.textContent = '\u2717';
      }

      // Clear and rebuild detail content safely using DOM methods
      while (detail.firstChild) detail.removeChild(detail.firstChild);
      detail.appendChild(document.createTextNode(detailText + ' '));

      if (linkUrl && linkText) {
        var a = document.createElement('a');
        a.className = 'prereq-link';
        a.textContent = linkText;
        a.addEventListener('click', function() { window.open(linkUrl, '_blank'); });
        detail.appendChild(a);
      }
    }

    // Listen for install/start progress events
    if (window.cerebroDesktop.onDockerInstallProgress) {
      window.cerebroDesktop.onDockerInstallProgress(function(data) {
        var fill = document.getElementById('docker-progress-fill');
        var detail = document.getElementById('docker-progress-detail');
        var title = document.getElementById('docker-progress-title');
        if (data.percent !== undefined && fill) fill.style.width = data.percent + '%';
        if (data.message && detail) detail.textContent = data.message;
        if (data.stage === 'installing' && title) title.textContent = 'Installing Docker...';
        if (data.stage === 'downloading' && title) title.textContent = 'Downloading Docker...';
      });
    }
    if (window.cerebroDesktop.onDockerStartProgress) {
      window.cerebroDesktop.onDockerStartProgress(function(data) {
        var detail = document.getElementById('docker-progress-detail');
        if (data.message && detail) detail.textContent = data.message;
      });
    }

    function checkPrerequisites() {
      var dockerEl = document.getElementById('prereq-docker');
      var claudeEl = document.getElementById('prereq-claude');
      var actionEl = document.getElementById('prereq-docker-action');
      var progressEl = document.getElementById('prereq-docker-progress');
      var continueBtn = document.getElementById('prereq-continue-btn');

      // Reset to checking state
      dockerEl.className = 'prereq-item checking';
      claudeEl.className = 'prereq-item checking';
      dockerEl.querySelector('.prereq-icon').textContent = '';
      claudeEl.querySelector('.prereq-icon').textContent = '';
      while (actionEl.firstChild) actionEl.removeChild(actionEl.firstChild);
      progressEl.style.display = 'none';

      var spinnerA = document.createElement('div');
      spinnerA.className = 'spinner';
      dockerEl.querySelector('.prereq-icon').appendChild(spinnerA);

      var spinnerB = document.createElement('div');
      spinnerB.className = 'spinner';
      claudeEl.querySelector('.prereq-icon').appendChild(spinnerB);

      document.getElementById('prereq-docker-detail').textContent = 'Checking...';
      document.getElementById('prereq-claude-detail').textContent = 'Checking...';
      continueBtn.disabled = true;
      showStatus('prereq-status', '', '');

      var dockerReady = false;

      // Check Docker
      window.cerebroDesktop.checkDocker().then(function(docker) {
        if (docker.installed && docker.running) {
          // Docker installed + running = green check
          setPrereqResult('prereq-docker', 'prereq-docker-detail', 'pass', 'Installed and running');
          dockerReady = true;
        } else if (docker.installed) {
          // Docker installed but not running = show Start button
          setPrereqResult('prereq-docker', 'prereq-docker-detail', 'fail', 'Installed but not running');
          var btn = document.createElement('button');
          btn.className = 'btn-sm btn-start';
          btn.textContent = 'Start';
          btn.addEventListener('click', startDockerFromWizard);
          actionEl.appendChild(btn);
        } else {
          // Docker not installed = show Install button
          setPrereqResult('prereq-docker', 'prereq-docker-detail', 'fail', 'Not installed');
          var btn = document.createElement('button');
          btn.className = 'btn-sm btn-install';
          btn.textContent = 'Install';
          btn.addEventListener('click', installDockerFromWizard);
          actionEl.appendChild(btn);
        }
      }).catch(function() {
        setPrereqResult('prereq-docker', 'prereq-docker-detail', 'fail', 'Check failed');
        var btn = document.createElement('button');
        btn.className = 'btn-sm btn-install';
        btn.textContent = 'Install';
        btn.addEventListener('click', installDockerFromWizard);
        actionEl.appendChild(btn);
      }).then(function() {
        // Check Claude Code (non-blocking)
        return window.cerebroDesktop.checkClaudeCode();
      }).then(function(claude) {
        if (claude.installed) {
          setPrereqResult('prereq-claude', 'prereq-claude-detail', 'pass', claude.version || 'Installed');
        } else {
          // Yellow info state, NOT red fail — not a blocker
          claudeEl.className = 'prereq-item info';
          claudeEl.querySelector('.prereq-icon').textContent = '\u24D8';
          var detail = document.getElementById('prereq-claude-detail');
          while (detail.firstChild) detail.removeChild(detail.firstChild);
          detail.appendChild(document.createTextNode('Not found (recommended) '));
          var a = document.createElement('a');
          a.className = 'prereq-link';
          a.textContent = 'Install Claude Code';
          a.addEventListener('click', function() { window.open('https://docs.anthropic.com/en/docs/claude-code/overview', '_blank'); });
          detail.appendChild(a);
        }
      }).catch(function() {
        claudeEl.className = 'prereq-item info';
        claudeEl.querySelector('.prereq-icon').textContent = '\u24D8';
        document.getElementById('prereq-claude-detail').textContent = 'Check failed (not required)';
      }).then(function() {
        // Only Docker is a hard prerequisite — Claude Code is not
        continueBtn.disabled = !dockerReady;
        if (!dockerReady) {
          showStatus('prereq-status', 'Docker is required to continue', 'error');
        }
      });
    }

    function installDockerFromWizard() {
      var actionEl = document.getElementById('prereq-docker-action');
      var progressEl = document.getElementById('prereq-docker-progress');
      while (actionEl.firstChild) actionEl.removeChild(actionEl.firstChild);
      progressEl.style.display = 'block';
      document.getElementById('docker-progress-fill').style.width = '0%';
      document.getElementById('docker-progress-title').textContent = 'Downloading Docker...';
      document.getElementById('docker-progress-detail').textContent = 'Starting download...';
      showStatus('prereq-status', '', '');

      window.cerebroDesktop.installDocker().then(function(result) {
        if (result.success) {
          if (result.needsRestart) {
            document.getElementById('docker-progress-title').textContent = 'Restart Required';
            document.getElementById('docker-progress-detail').textContent = 'Docker installed! Please restart your PC for WSL2, then reopen Cerebro.';
            document.getElementById('docker-progress-fill').style.width = '100%';
          } else {
            // Install succeeded, no restart needed — auto-start Docker
            document.getElementById('docker-progress-title').textContent = 'Starting Docker...';
            document.getElementById('docker-progress-detail').textContent = 'Docker installed, now starting daemon...';
            document.getElementById('docker-progress-fill').style.width = '100%';
            startDockerFromWizard();
          }
        } else {
          document.getElementById('docker-progress-title').textContent = 'Installation Failed';
          document.getElementById('docker-progress-detail').textContent = result.error || 'Unknown error';
          showStatus('prereq-status', 'Docker installation failed. Try installing manually.', 'error');
        }
      }).catch(function(err) {
        document.getElementById('docker-progress-title').textContent = 'Installation Failed';
        document.getElementById('docker-progress-detail').textContent = err.message || 'Unknown error';
        showStatus('prereq-status', 'Docker installation failed. Try installing manually.', 'error');
      });
    }

    function startDockerFromWizard() {
      var actionEl = document.getElementById('prereq-docker-action');
      var progressEl = document.getElementById('prereq-docker-progress');
      while (actionEl.firstChild) actionEl.removeChild(actionEl.firstChild);
      progressEl.style.display = 'block';
      document.getElementById('docker-progress-title').textContent = 'Starting Docker...';
      document.getElementById('docker-progress-detail').textContent = 'Waiting for Docker daemon...';
      document.getElementById('docker-progress-fill').style.width = '50%';
      showStatus('prereq-status', '', '');

      window.cerebroDesktop.startDockerDaemon().then(function(result) {
        if (result.success) {
          progressEl.style.display = 'none';
          setPrereqResult('prereq-docker', 'prereq-docker-detail', 'pass', 'Installed and running');
          document.getElementById('prereq-continue-btn').disabled = false;
          showStatus('prereq-status', '', '');
        } else {
          document.getElementById('docker-progress-title').textContent = 'Failed to Start';
          document.getElementById('docker-progress-detail').textContent = result.error || 'Docker daemon did not respond in time';
          showStatus('prereq-status', 'Could not start Docker. Try starting Docker Desktop manually.', 'error');
        }
      }).catch(function(err) {
        document.getElementById('docker-progress-title').textContent = 'Failed to Start';
        document.getElementById('docker-progress-detail').textContent = err.message || 'Unknown error';
        showStatus('prereq-status', 'Could not start Docker. Try starting Docker Desktop manually.', 'error');
      });
    }

    function runSetup() {
      var fill = document.getElementById('setup-progress-fill');

      // Step 1: Write config
      markStep('ps-config', 'active');
      fill.style.width = '10%';
      showStatus('setup-status', 'Writing docker-compose.yml and .env...', 'loading');

      window.cerebroDesktop.setupDocker().then(function(configResult) {
        if (!configResult.success) {
          throw new Error(configResult.error || 'Failed to write configuration');
        }
        markStep('ps-config', 'done');
        fill.style.width = '33%';

        // Step 2: Pull images
        markStep('ps-pull', 'active');
        showStatus('setup-status', 'Pulling Docker images (this may take a few minutes)...', 'loading');
        return window.cerebroDesktop.pullImages();
      }).then(function(pullResult) {
        if (!pullResult.success) {
          throw new Error(pullResult.error || 'Failed to pull images');
        }
        markStep('ps-pull', 'done');
        fill.style.width = '80%';

        // Step 3: Verify
        markStep('ps-ready', 'active');
        showStatus('setup-status', 'Verifying setup...', 'loading');
        return delay(500);
      }).then(function() {
        markStep('ps-ready', 'done');
        fill.style.width = '100%';
        showStatus('setup-status', 'Setup complete!', 'success');
        return delay(800);
      }).then(function() {
        goToStep(6);
      }).catch(function(err) {
        showStatus('setup-status', err.message, 'error');
      });
    }

    function setupMcp() {
      var btn = document.getElementById('mcp-setup-btn');
      btn.disabled = true;
      showStatus('mcp-status', 'Configuring...', 'loading');

      window.cerebroDesktop.configureMcp().then(function(result) {
        if (result.success) {
          showStatus('mcp-status', 'MCP configured at ' + result.configPath, 'success');
          setTimeout(function() { goToStep(7); }, 1200);
        } else {
          showStatus('mcp-status', result.error || 'Configuration failed', 'error');
          btn.disabled = false;
        }
      }).catch(function() {
        showStatus('mcp-status', 'Failed to configure MCP', 'error');
        btn.disabled = false;
      });
    }

    function showReadyStep() {
      var container = document.getElementById('plan-badge-container');
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }

      if (activatedPlan) {
        var isPlus = activatedPlan === 'pro-plus';
        var badge = document.createElement('span');
        badge.className = 'plan-badge ' + (isPlus ? 'plan-pro-plus' : 'plan-pro');
        badge.textContent = isPlus ? 'Pro+' : 'Pro';
        container.appendChild(badge);
      }
    }

    function launchCerebro() {
      var btn = document.getElementById('launch-btn');
      btn.disabled = true;
      btn.textContent = 'Starting Cerebro...';
      showStatus('launch-status', 'Starting containers (this may take up to 2 minutes)...', 'loading');

      window.cerebroDesktop.wizardComplete().then(function(result) {
        if (result && result.success) {
          showStatus('launch-status', 'Cerebro is loading...', 'success');
          // The main process will navigate the window to the frontend
        } else {
          btn.disabled = false;
          btn.textContent = 'Retry Launch';
          var errMsg = result && result.error ? result.error : 'Failed to start. Please try again.';
          // Truncate long error messages (container logs) for display
          if (errMsg.length > 200) {
            errMsg = errMsg.substring(0, 200) + '...';
          }
          showStatus('launch-status', errMsg, 'error');
        }
      }).catch(function(err) {
        btn.disabled = false;
        btn.textContent = 'Retry Launch';
        showStatus('launch-status', err.message || 'Failed to start. Please try again.', 'error');
      });
    }

    function markStep(id, state) {
      var el = document.getElementById(id);
      el.className = 'progress-step ' + state;
      if (state === 'done') {
        el.querySelector('.icon').textContent = '\u2713';
      } else if (state === 'active') {
        el.querySelector('.icon').textContent = '\u25CB';
      }
    }

    function showStatus(elementId, msg, type) {
      if (!elementId) return;
      var el = document.getElementById(elementId);
      if (!el) return;
      el.textContent = msg;
      el.className = 'status status-' + type;
    }

    var countdownTimer = null;

    function proceedAfterPrereqs() {
      window.cerebroDesktop.needsRestart().then(function(needs) {
        if (needs) {
          goToStep(4); // Restart step
        } else {
          goToStep(5); // Skip restart, go to Setup
        }
      }).catch(function() {
        goToStep(5); // On error, skip restart
      });
    }

    function startRestartCountdown() {
      var seconds = 15;
      var circumference = 2 * Math.PI * 52; // r=52
      var ring = document.querySelector('.ring-progress');
      var numberEl = document.querySelector('.countdown-number');

      // Save state + enable autostart before countdown
      window.cerebroDesktop.saveSetupState({ step: 'needs-setup', plan: activatedPlan });
      window.cerebroDesktop.enableAutostart();

      ring.style.strokeDashoffset = '0';
      numberEl.textContent = seconds;

      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(function() {
        seconds--;
        numberEl.textContent = seconds;
        var offset = circumference * (1 - seconds / 15);
        ring.style.strokeDashoffset = offset;

        if (seconds <= 0) {
          clearInterval(countdownTimer);
          countdownTimer = null;
          restartNow();
        }
      }, 1000);
    }

    function restartNow() {
      if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
      var btn = document.getElementById('restart-now-btn');
      btn.disabled = true;
      btn.textContent = 'Restarting...';
      document.getElementById('restart-message').textContent = 'Restarting your computer...';

      window.cerebroDesktop.restartComputer().then(function() {
        // Command sent — app will be killed by the OS
      }).catch(function() {
        btn.textContent = 'Restart Now';
        btn.disabled = false;
        showStatus('restart-status', 'Restart failed. Please restart your computer manually.', 'error');
        document.getElementById('restart-message').textContent = 'Please restart your computer manually, then reopen Cerebro.';
      });
    }

    function restartLater() {
      if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
      // State is already saved — app will resume on next launch
      window.close();
    }

    function resumeAfterRestart(state) {
      // Clear the state file so we don't loop
      window.cerebroDesktop.clearSetupState();
      // Restore plan info if saved
      if (state && state.plan) activatedPlan = state.plan;
      // Jump straight to Setup (step 5)
      goToStep(5);
    }

    // Listen for resume signal from main process (post-restart)
    if (window.cerebroDesktop.onResumeAfterRestart) {
      window.cerebroDesktop.onResumeAfterRestart(function(state) {
        resumeAfterRestart(state);
      });
    }

    function delay(ms) {
      return new Promise(function(resolve) { setTimeout(resolve, ms); });
    }
  </script>
</body>
</html>
