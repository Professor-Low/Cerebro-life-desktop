<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Cerebro</title>

    <!-- Favicon - Purple orb -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3CradialGradient id='g' cx='30%25' cy='30%25'%3E%3Cstop offset='0%25' stop-color='%23e9d5ff'/%3E%3Cstop offset='25%25' stop-color='%23a78bfa'/%3E%3Cstop offset='50%25' stop-color='%237c3aed'/%3E%3Cstop offset='100%25' stop-color='%234c1d95'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23g)'/%3E%3Ccircle cx='35' cy='35' r='12' fill='%23fff' fill-opacity='0.3'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3CradialGradient id='g' cx='30%25' cy='30%25'%3E%3Cstop offset='0%25' stop-color='%23e9d5ff'/%3E%3Cstop offset='25%25' stop-color='%23a78bfa'/%3E%3Cstop offset='50%25' stop-color='%237c3aed'/%3E%3Cstop offset='100%25' stop-color='%234c1d95'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23g)'/%3E%3Ccircle cx='35' cy='35' r='12' fill='%23fff' fill-opacity='0.3'/%3E%3C/svg%3E">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Markdown rendering -->
    <script src="static/marked.min.js"></script>
    <!-- HTML sanitization for safe markdown rendering -->
    <script src="static/purify.min.js"></script>

    <!-- GSAP Animation Library (100% free) -->
    <script src="static/gsap.min.js"></script>

    <!-- tsParticles for ambient background -->
    <script src="static/tsparticles.bundle.min.js"></script>

    <!-- Lenis for smooth scrolling -->
    <script src="static/lenis.min.js"></script>

    <style>
        :root {
            /* === BACKGROUNDS (Deep space) === */
            --bg-primary: #050508;
            --bg-secondary: #08080e;
            --bg-card: #0c0c14;
            --bg-elevated: #10101c;
            --bg-hover: #1a1a2a;

            /* === ACCENT COLORS (Enhanced purple palette) === */
            --accent: #8b5cf6;
            --accent-light: #a78bfa;
            --accent-dark: #6d28d9;
            --accent-secondary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #8b5cf6 0%, #6366f1 50%, #4f46e5 100%);
            --accent-glow: rgba(139, 92, 246, 0.25);
            --accent-glow-strong: rgba(139, 92, 246, 0.5);

            /* === ENERGY ACCENTS === */
            --energy-blue: #3b82f6;
            --energy-amber: #f59e0b;
            --energy-glow-blue: rgba(59, 130, 246, 0.4);
            --energy-glow-amber: rgba(245, 158, 11, 0.4);

            /* === GLOW EFFECTS (Expanded for glassmorphism) === */
            --glow-subtle: rgba(139, 92, 246, 0.15);
            --glow-medium: rgba(139, 92, 246, 0.35);
            --glow-strong: rgba(139, 92, 246, 0.55);
            --glow-intense: rgba(139, 92, 246, 0.8);

            /* === GLASSMORPHISM === */
            --glass-bg: rgba(12, 12, 20, 0.75);
            --glass-bg-light: rgba(16, 16, 28, 0.65);
            --glass-border: rgba(139, 92, 246, 0.2);
            --glass-border-hover: rgba(139, 92, 246, 0.45);
            --glass-blur: 20px;

            /* === TEXT (High contrast) === */
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;

            /* Status Colors */
            --green: #22c55e;
            --yellow: #eab308;
            --red: #ef4444;
            --blue: #3b82f6;
            --cyan: #22d3ee;

            /* === BORDERS (Softer) === */
            --border: rgba(255, 255, 255, 0.06);
            --border-light: rgba(255, 255, 255, 0.1);
            --border-accent: rgba(139, 92, 246, 0.3);
            --glass: rgba(255, 255, 255, 0.03);

            /* === SHADOWS (Layered depth) === */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.6);
            --shadow-glow: 0 0 40px var(--glow-medium);

            /* === ANIMATION TIMING === */
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1);
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);

            /* Sizing */
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --nav-height: 70px;
        }

        /* === GLASSMORPHISM UTILITIES === */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            box-shadow:
                var(--shadow-lg),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .glass:hover {
            border-color: var(--glass-border-hover);
            box-shadow:
                var(--shadow-lg),
                var(--shadow-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }

        .glass-subtle {
            background: rgba(18, 18, 26, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--border);
        }

        /* Backdrop-filter fallback */
        @supports not (backdrop-filter: blur(16px)) {
            .glass, .glass-subtle, .chat-input-wrapper, .message.assistant {
                background: var(--bg-card) !important;
            }
        }

        /* Ripple effect for buttons */
        .btn-primary, .btn-secondary {
            position: relative;
            overflow: hidden;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            width: 100px;
            height: 100px;
            margin-left: -50px;
            margin-top: -50px;
            pointer-events: none;
            animation: rippleAnim 0.6s ease-out forwards;
        }

        @keyframes rippleAnim {
            from {
                transform: scale(0);
                opacity: 0.5;
            }
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* === PROFESSIONAL CSS ICONS === */
        .icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .icon-memory::before {
            content: '';
            width: 14px;
            height: 14px;
            border: 2px solid var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--glow-subtle);
        }

        .icon-agents::before {
            content: '';
            width: 12px;
            height: 12px;
            background: var(--accent-secondary);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }

        .icon-health::before {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--green);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--green);
        }

        .icon-status::before {
            content: '';
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 10px solid var(--yellow);
            filter: drop-shadow(0 0 4px var(--yellow));
        }

        .icon-bell::before {
            content: '';
            width: 14px;
            height: 14px;
            background: var(--text-secondary);
            clip-path: polygon(50% 0%, 80% 10%, 100% 35%, 100% 70%, 85% 85%, 15% 85%, 0% 70%, 0% 35%, 20% 10%);
        }

        .icon-refresh::before {
            content: '';
            width: 12px;
            height: 12px;
            border: 2px solid var(--text-secondary);
            border-top-color: transparent;
            border-radius: 50%;
        }

        .icon-worker::before {
            content: '';
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 9px solid var(--yellow);
        }

        .icon-chat::before {
            content: '';
            width: 14px;
            height: 12px;
            background: var(--accent);
            border-radius: 4px 4px 4px 0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* CRITICAL: Prevent text overflow everywhere */
        * {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -webkit-overflow-scrolling: touch;
        }

        /* ==================== PARTICLE BACKGROUND ==================== */
        #particles-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* ==================== APP CONTAINER ==================== */
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            position: relative;
            z-index: 1;
        }

        /* ==================== HEADER ==================== */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            z-index: 500;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Nav Orb - Mini version of Cerebro's avatar */
        .nav-orb-container {
            position: relative;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .nav-orb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: radial-gradient(
                circle at 30% 30%,
                #e9d5ff 0%,
                #a78bfa 25%,
                #7c3aed 50%,
                #5b21b6 75%,
                #4c1d95 100%
            );
            box-shadow:
                0 0 10px rgba(167, 139, 250, 0.6),
                0 0 20px rgba(139, 92, 246, 0.4),
                inset 0 0 10px rgba(255, 255, 255, 0.2);
            animation: navOrbBreathe 4s ease-in-out infinite;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-orb::before {
            content: '';
            position: absolute;
            top: 15%;
            left: 20%;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
        }

        .nav-orb-inner {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #f5f3ff 0%, #e9d5ff 40%, #a78bfa 100%);
            box-shadow: 0 0 8px rgba(233, 213, 255, 0.8);
            animation: navInnerPulse 2s ease-in-out infinite;
        }

        .nav-orb-ring {
            position: absolute;
            border-radius: 50%;
            border: 1.5px solid transparent;
            border-top-color: rgba(139, 92, 246, 0.6);
            border-right-color: rgba(139, 92, 246, 0.3);
            animation: ringRotate 3s linear infinite;
        }

        .nav-orb-ring:nth-child(1) {
            width: 32px;
            height: 32px;
            animation-duration: 3s;
        }

        .nav-orb-ring:nth-child(2) {
            width: 36px;
            height: 36px;
            animation-duration: 4s;
            animation-direction: reverse;
            border-top-color: rgba(99, 102, 241, 0.4);
        }

        @keyframes navOrbBreathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes navInnerPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.85); opacity: 0.8; }
        }

        /* Nav orb active state when agents running */
        .nav-orb-container.active-agents .nav-orb {
            animation: navOrbActive 1.5s ease-in-out infinite;
            box-shadow:
                0 0 15px rgba(245, 158, 11, 0.6),
                0 0 30px rgba(245, 158, 11, 0.4),
                inset 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .nav-orb-container.active-agents .nav-orb-ring {
            border-top-color: #f59e0b;
            animation-duration: 1.5s;
        }

        @keyframes navOrbActive {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Nav orb speaking state (TTS) */
        .nav-orb-container.speaking .nav-orb {
            animation: navOrbSpeaking 0.6s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.6), 0 0 40px rgba(34, 197, 94, 0.4);
        }

        .nav-orb-container.speaking .nav-orb-ring {
            border-top-color: #22c55e;
            animation-duration: 0.8s;
        }

        @keyframes navOrbSpeaking {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.15); }
            75% { transform: scale(1.12); }
        }

        /* Conversational mode - cyan glow while listening */
        .nav-orb-container.conversational .nav-orb {
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.6), 0 0 40px rgba(34, 211, 238, 0.4);
        }
        .nav-orb-container.conversational.listening .nav-orb {
            animation: navOrbListening 1s ease-in-out infinite;
        }
        .nav-orb-container.conversational .nav-orb-ring {
            border-top-color: #22d3ee;
        }
        @keyframes navOrbListening {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(34, 211, 238, 0.6); }
            50% { transform: scale(1.08); box-shadow: 0 0 30px rgba(34, 211, 238, 0.8); }
        }

        .logo-text {
            font-size: 1.1rem;
            font-weight: 600;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--bg-card);
            padding: 6px 10px;
            border-radius: 20px;
            border: 1px solid var(--border);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--green);
            box-shadow: 0 0 8px var(--green);
        }

        .status-dot.offline {
            background: var(--red);
            box-shadow: 0 0 8px var(--red);
        }

        /* ==================== NOTIFICATION BELL ==================== */
        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .notification-bell:hover {
            background: var(--bg-hover);
        }

        .notification-bell:active {
            transform: scale(0.95);
        }

        .bell-icon {
            font-size: 1.2rem;
        }

        .notification-bell.has-new .bell-icon {
            animation: bell-shake 0.5s ease-in-out;
        }

        @keyframes bell-shake {
            0%, 100% { transform: rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
            20%, 40%, 60%, 80% { transform: rotate(10deg); }
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--red);
            color: white;
            font-size: 0.6rem;
            font-weight: 700;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            box-shadow: 0 0 8px var(--red);
        }

        .notification-badge.hidden {
            display: none;
        }

        /* Notification Panel Dropdown */
        .notification-panel {
            position: fixed;
            top: 56px;
            right: 10px;
            width: 320px;
            max-width: calc(100vw - 20px);
            max-height: 400px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .notification-panel.hidden {
            display: none;
        }

        .notification-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }

        .mark-all-read-btn {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 0.8rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .mark-all-read-btn:hover {
            background: var(--accent-glow);
        }

        .notification-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .notification-item {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .notification-item:hover {
            background: var(--bg-hover);
        }

        .notification-item.unread {
            background: rgba(139, 92, 246, 0.08);
        }

        .notification-item.unread::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent);
        }

        .notification-icon {
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .notification-message {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .notification-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .no-notifications {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
        }

        /* ==================== MAIN CONTENT ==================== */
        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-top: 56px; /* Space for fixed header */
            padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 20px);
            -webkit-overflow-scrolling: touch;
        }

        .view {
            display: none !important;
            min-height: 100%;
            visibility: hidden;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
        }

        .view.active {
            display: flex !important;
            flex-direction: column;
            visibility: visible;
            position: relative;
            opacity: 1;
        }

        /* Smooth content fade-in when view activates after a slide */
        .view.active.view-entering > *:not(.slide-panel):not(.slide-panel-backdrop):not(.edge-indicator):not(.question-input-overlay):not(.questions-wizard-overlay):not(.hitl-popup-container):not(.findings-overlay) {
            opacity: 0;
            transform: translateY(6px);
        }
        .view.active.view-entered > *:not(.slide-panel):not(.slide-panel-backdrop):not(.edge-indicator):not(.question-input-overlay):not(.questions-wizard-overlay):not(.hitl-popup-container):not(.findings-overlay) {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* ==================== VIEW TRANSITION OVERLAY ==================== */
        /* Simple translucent fade - lets content load behind it, then reveals */
        .view-transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 5000;
            pointer-events: all;
            background: rgba(10, 10, 20, 0.92);
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        .view-transition-overlay.active {
            opacity: 1;
        }
        .view-transition-overlay.fade-out {
            opacity: 0;
            transition: opacity 0.28s ease;
        }

        /* ==================== STAGGER ENTRANCE ANIMATION ==================== */
        @keyframes staggerFadeSlideIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stagger-in {
            opacity: 0;
            animation: staggerFadeSlideIn 0.35s ease-out forwards;
            animation-delay: calc(var(--si, 0) * 60ms);
        }

        /* Agent cards stagger (innerHTML-rendered) */
        .agent-card { opacity: 0; animation: staggerFadeSlideIn 0.35s ease-out forwards; }
        .agent-card:nth-child(1) { animation-delay: 0ms; }
        .agent-card:nth-child(2) { animation-delay: 60ms; }
        .agent-card:nth-child(3) { animation-delay: 120ms; }
        .agent-card:nth-child(4) { animation-delay: 180ms; }
        .agent-card:nth-child(5) { animation-delay: 240ms; }
        .agent-card:nth-child(n+6) { animation-delay: 300ms; }

        /* Interest cards stagger (innerHTML-rendered) */
        .interest-card { opacity: 0; animation: staggerFadeSlideIn 0.35s ease-out forwards; }
        .interest-card:nth-child(1) { animation-delay: 0ms; }
        .interest-card:nth-child(2) { animation-delay: 60ms; }
        .interest-card:nth-child(3) { animation-delay: 120ms; }

        /* ==================== ENHANCED BOTTOM NAVIGATION ==================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(var(--nav-height) + var(--safe-bottom));
            padding-bottom: var(--safe-bottom);
            background: linear-gradient(
                to top,
                var(--bg-primary) 0%,
                rgba(10, 10, 15, 0.95) 50%,
                transparent 100%
            );
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: 16px;
            color: var(--text-muted);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            position: relative;
            min-width: 64px;
        }

        .nav-item.active {
            color: var(--accent-light);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 3px;
            background: var(--accent-gradient);
            border-radius: 2px;
            box-shadow: 0 0 10px var(--glow-strong);
            animation: navIndicatorIn 0.3s ease-out forwards;
        }
        @keyframes navIndicatorIn {
            from { width: 0; opacity: 0; }
            to { width: 24px; opacity: 1; }
        }

        .nav-item:hover:not(.active) {
            color: var(--text-secondary);
            background: var(--bg-hover);
        }

        .nav-item:active {
            transform: scale(0.95);
        }

        .nav-icon {
            font-size: 1.4rem;
            transition: transform 0.2s var(--ease-spring);
        }

        .nav-item:hover .nav-icon {
            transform: scale(1.1);
        }

        .nav-item.active .nav-icon {
            transform: scale(1.15);
        }

        .nav-label {
            font-size: 0.7rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .nav-item.active .nav-label {
            color: var(--accent-light);
            font-weight: 600;
        }

        /* Mobile keyboard open state - hide bottom nav */
        body.keyboard-open .bottom-nav {
            display: none !important;
        }

        body.keyboard-open .chat-input-area {
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
        }

        body.keyboard-open .quick-action-pills {
            display: none !important;
        }

        body.keyboard-open .messages-container {
            padding-bottom: 100px !important;
        }

        /* ==================== HOME VIEW ==================== */
        .home-view {
            padding: 20px;
            gap: 20px;
            overflow-y: auto;
            min-height: min-content;
        }

        /* ==================== CEREBRO PRESENCE CARD ==================== */
        .cerebro-presence {
            background: linear-gradient(
                135deg,
                rgba(15, 15, 35, 0.9) 0%,
                rgba(26, 26, 46, 0.8) 50%,
                rgba(22, 33, 62, 0.9) 100%
            );
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 28px;
            padding: 0;
            box-shadow:
                0 0 60px rgba(139, 92, 246, 0.15),
                0 0 120px rgba(139, 92, 246, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }

        /* Animated background particles */
        .presence-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(139, 92, 246, 0.6);
            border-radius: 50%;
            animation: float-particle 8s infinite ease-in-out;
        }

        .particle:nth-child(1) { left: 10%; top: 20%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 20%; top: 60%; animation-delay: 1s; }
        .particle:nth-child(3) { left: 40%; top: 30%; animation-delay: 2s; }
        .particle:nth-child(4) { left: 60%; top: 70%; animation-delay: 3s; }
        .particle:nth-child(5) { left: 80%; top: 40%; animation-delay: 4s; }
        .particle:nth-child(6) { left: 90%; top: 80%; animation-delay: 5s; }

        @keyframes float-particle {
            0%, 100% { transform: translateY(0) scale(1); opacity: 0.4; }
            50% { transform: translateY(-20px) scale(1.5); opacity: 0.8; }
        }

        /* Main content layout */
        .presence-content {
            position: relative;
            z-index: 1;
            display: flex;
            gap: 20px;
            padding: 24px;
            align-items: center;
        }

        /* The Core - Cerebro's Avatar (Enhanced) */
        .cerebro-core {
            position: relative;
            width: 120px;
            height: 120px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .core-orb {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(
                circle at 30% 30%,
                #e9d5ff 0%,
                #a78bfa 25%,
                #7c3aed 50%,
                #5b21b6 75%,
                #4c1d95 100%
            );
            box-shadow:
                0 0 20px rgba(167, 139, 250, 0.6),
                0 0 40px rgba(139, 92, 246, 0.5),
                0 0 60px rgba(139, 92, 246, 0.4),
                0 0 80px rgba(124, 58, 237, 0.3),
                0 0 120px rgba(91, 33, 182, 0.2),
                inset 0 0 30px rgba(255, 255, 255, 0.2),
                inset -10px -10px 30px rgba(76, 29, 149, 0.5);
            animation: orbBreathe 4s ease-in-out infinite;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .core-orb::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 20%;
            width: 20px;
            height: 20px;
            background: radial-gradient(
                circle,
                rgba(255, 255, 255, 0.8) 0%,
                rgba(255, 255, 255, 0) 70%
            );
            border-radius: 50%;
        }

        .core-inner {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: radial-gradient(
                circle at 30% 30%,
                #f5f3ff 0%,
                #e9d5ff 40%,
                #a78bfa 100%
            );
            box-shadow:
                0 0 20px rgba(233, 213, 255, 0.8),
                0 0 40px rgba(167, 139, 250, 0.5);
            animation: innerPulse 2s ease-in-out infinite;
        }

        /* Outer rotating rings */
        .core-ring {
            position: absolute;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: rgba(139, 92, 246, 0.6);
            border-right-color: rgba(139, 92, 246, 0.3);
            animation: ringRotate 3s linear infinite;
        }

        .core-ring:nth-child(1) {
            width: 100px;
            height: 100px;
            animation-duration: 3s;
        }

        .core-ring:nth-child(2) {
            width: 110px;
            height: 110px;
            animation-duration: 4s;
            animation-direction: reverse;
            border-top-color: rgba(99, 102, 241, 0.4);
        }

        .core-ring:nth-child(3) {
            width: 120px;
            height: 120px;
            animation-duration: 5s;
            border-top-color: rgba(79, 70, 229, 0.3);
        }

        @keyframes orbBreathe {
            0%, 100% {
                transform: scale(1);
                box-shadow:
                    0 0 20px rgba(167, 139, 250, 0.6),
                    0 0 40px rgba(139, 92, 246, 0.5),
                    0 0 60px rgba(139, 92, 246, 0.4),
                    0 0 80px rgba(124, 58, 237, 0.3),
                    0 0 120px rgba(91, 33, 182, 0.2);
            }
            50% {
                transform: scale(1.08);
                box-shadow:
                    0 0 30px rgba(167, 139, 250, 0.8),
                    0 0 60px rgba(139, 92, 246, 0.6),
                    0 0 90px rgba(139, 92, 246, 0.5),
                    0 0 120px rgba(124, 58, 237, 0.4),
                    0 0 160px rgba(91, 33, 182, 0.3);
            }
        }

        @keyframes innerPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(0.85);
                opacity: 0.8;
            }
        }

        @keyframes ringRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Text content area */
        .presence-info {
            flex: 1;
            min-width: 0;
        }

        .presence-greeting {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2px;
            background: linear-gradient(135deg, #fff, #e9d5ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .presence-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 10px #22c55e;
            animation: status-pulse 2s ease-in-out infinite;
        }

        .status-indicator.thinking {
            background: #f59e0b;
            box-shadow: 0 0 10px #f59e0b;
        }

        .status-indicator.processing {
            background: #3b82f6;
            box-shadow: 0 0 10px #3b82f6;
            animation: status-blink 0.5s ease-in-out infinite;
        }

        @keyframes status-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }

        @keyframes status-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .status-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Mood indicator */
        .mood-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(139, 92, 246, 0.15);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #c4b5fd;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .mood-emoji, .mood-dot {
            width: 8px;
            height: 8px;
            background: var(--green);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--green);
        }

        /* Thought bubble - contextual message */
        .thought-bubble {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 10px 14px;
            margin-top: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            position: relative;
            animation: thought-fade 0.5s ease-out;
        }

        .thought-bubble::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 12px;
            font-size: 0.9rem;
        }

        @keyframes thought-fade {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats strip at bottom */
        .presence-stats {
            display: flex;
            gap: 0;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            background: rgba(0, 0, 0, 0.2);
        }

        .presence-stat {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px;
            border-right: 1px solid rgba(139, 92, 246, 0.2);
            transition: background 0.2s;
        }

        .presence-stat:last-child {
            border-right: none;
        }

        .presence-stat:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .presence-stat-icon {
            font-size: 1.1rem;
        }

        .presence-stat-info {
            display: flex;
            flex-direction: column;
        }

        .presence-stat-value {
            font-weight: 700;
            font-size: 1rem;
            color: #fff;
        }

        .presence-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Active indicator when agents running */
        .cerebro-presence.active-agents .core-orb {
            animation: core-breathe 2s ease-in-out infinite;
        }

        .cerebro-presence.active-agents .core-ring {
            animation: ring-rotate 1.5s linear infinite;
            border-top-color: #f59e0b;
        }

        /* Legacy support - keep old classes working */
        .hero-card { display: none; }
        .hero-date { display: none; }
        .hero-stats { display: none; }
        .stat-badge { display: none; }
        .stat-icon { display: none; }
        .stat-info { display: none; }
        .stat-value { display: none; }
        .stat-label { display: none; }

        /* ==================== COMPACT HERO BAR ==================== */
        .hero-bar {
            background: linear-gradient(135deg, rgba(15,15,35,0.9) 0%, rgba(26,26,46,0.8) 50%, rgba(22,33,62,0.9) 100%);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            padding: 14px 18px 12px;
            position: relative;
            overflow: hidden;
        }
        .hero-bar::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 20% 50%, rgba(139,92,246,0.08) 0%, transparent 60%);
            pointer-events: none;
        }
        .hero-bar-main {
            display: flex;
            align-items: center;
            gap: 14px;
            position: relative;
            z-index: 1;
        }
        .hero-orb-mini {
            width: 56px;
            height: 56px;
            position: relative;
            flex-shrink: 0;
        }
        .hero-orb-mini .core-orb {
            width: 40px;
            height: 40px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .hero-orb-mini .core-ring {
            width: 52px;
            height: 52px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .hero-orb-mini .core-ring:nth-child(2) { width: 48px; height: 48px; }
        .hero-info { flex: 1; min-width: 0; }
        .hero-greeting {
            display: block !important;
            font-size: 1.15rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, var(--accent-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .hero-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.78rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        .hero-datetime {
            font-size: 0.72rem;
            color: var(--text-muted);
            text-align: right;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .hero-pills {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }
        .stat-pill {
            flex: 1;
            min-width: 70px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            padding: 6px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0;
            animation: staggerFadeSlideIn 0.3s ease-out forwards;
        }
        .stat-pill:nth-child(1) { animation-delay: 50ms; }
        .stat-pill:nth-child(2) { animation-delay: 100ms; }
        .stat-pill:nth-child(3) { animation-delay: 150ms; }
        .stat-pill:nth-child(4) { animation-delay: 200ms; }
        .stat-pill:nth-child(5) { animation-delay: 250ms; }
        .stat-pill:nth-child(6) { animation-delay: 300ms; }
        .stat-pill:hover {
            background: rgba(139,92,246,0.1);
            border-color: var(--accent);
        }
        .stat-pill-value {
            display: block;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .stat-pill-label {
            display: block;
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 1px;
        }

        /* ==================== HOME SECTION SHARED ==================== */
        .home-section { margin-bottom: 4px; }
        .section-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .section-link {
            font-size: 0.75rem;
            color: var(--accent-light);
            cursor: pointer;
            text-decoration: none;
        }
        .section-link:hover { text-decoration: underline; }

        /* ==================== SMART ACTIONS ==================== */
        .smart-actions-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 6px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .smart-actions-scroll::-webkit-scrollbar { height: 4px; }
        .smart-actions-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .action-card {
            min-width: 220px;
            max-width: 260px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            scroll-snap-align: start;
            flex-shrink: 0;
        }
        .action-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }
        .action-card-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        .action-card-icon.rocket { background: rgba(139,92,246,0.15); }
        .action-card-icon.play { background: rgba(34,197,94,0.15); }
        .action-card-icon.target { background: rgba(59,130,246,0.15); }
        .action-card-icon.alert { background: rgba(245,158,11,0.15); }
        .action-card-icon.book { background: rgba(236,72,153,0.15); }
        .action-card-title {
            font-size: 0.88rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .action-card-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .action-card-go {
            display: inline-block;
            margin-top: 10px;
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--accent-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ==================== LIVE ACTIVITY GRID ==================== */
        .live-activity-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        @media (max-width: 768px) {
            .live-activity-grid { grid-template-columns: 1fr; }
        }
        .live-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
        }
        .live-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .live-card-icon { font-size: 1rem; }
        .live-card-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .live-card-body { padding: 12px 14px; min-height: 60px; }
        .live-empty {
            color: var(--text-muted);
            font-size: 0.8rem;
            text-align: center;
            padding: 10px 0;
        }
        .live-agent-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 0.8rem;
        }
        .live-agent-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 2s infinite;
        }
        .live-agent-task { flex: 1; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .live-agent-time { color: var(--text-muted); font-size: 0.7rem; }
        .autonomy-status-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.82rem;
            color: var(--text-primary);
        }
        .autonomy-badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .autonomy-badge.running { background: rgba(34,197,94,0.2); color: var(--green); }
        .autonomy-badge.idle { background: rgba(255,255,255,0.06); color: var(--text-muted); }

        /* Badge smooth transitions */
        .project-status-badge,
        .goal-compact-badge,
        .goal-priority-dot,
        .autonomy-badge {
            transition: opacity 0.25s ease, transform 0.25s ease, background 0.25s ease;
        }

        /* ==================== HOME GOALS ==================== */
        .home-goals-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .home-goal-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px 16px;
            border-left: 4px solid var(--text-muted);
            transition: all 0.2s ease;
        }
        .home-goal-card:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        .home-goal-card.priority-high { border-left-color: var(--red); }
        .home-goal-card.priority-medium { border-left-color: #f59e0b; }
        .home-goal-card.priority-low { border-left-color: var(--green); }
        .goal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }
        .goal-card-desc {
            font-size: 0.88rem;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
            line-height: 1.4;
        }
        .goal-priority-badge {
            font-size: 0.6rem;
            padding: 2px 8px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        .goal-priority-badge.high { background: rgba(239,68,68,0.2); color: var(--red); }
        .goal-priority-badge.medium { background: rgba(245,158,11,0.2); color: #f59e0b; }
        .goal-priority-badge.low { background: rgba(34,197,94,0.2); color: var(--green); }
        .goal-progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.06);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }
        .goal-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            transition: width 0.4s ease;
        }
        .goal-blockers {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }
        .goal-blocker-pill {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 8px;
            background: rgba(239,68,68,0.15);
            color: var(--red);
        }
        .goal-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .goal-action-btn {
            font-size: 0.72rem;
            padding: 4px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .goal-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .goal-action-btn.primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .goal-action-btn.primary:hover { background: var(--accent-hover); }

        /* ==================== PROJECT TRACKER ==================== */
        .project-tracker-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 6px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .project-tracker-scroll::-webkit-scrollbar { height: 4px; }
        .project-tracker-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .project-card {
            min-width: 260px;
            max-width: 300px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            flex-shrink: 0;
            scroll-snap-align: start;
            transition: all 0.2s ease;
        }
        .project-card:hover {
            border-color: var(--accent);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }
        .project-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .project-card-name {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .project-status-badge {
            font-size: 0.6rem;
            padding: 2px 8px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .project-status-badge.in_progress { background: rgba(139,92,246,0.2); color: var(--accent-light); }
        .project-status-badge.paused { background: rgba(245,158,11,0.2); color: #f59e0b; }
        .project-status-badge.completed { background: rgba(34,197,94,0.2); color: var(--green); }
        .project-card-summary {
            font-size: 0.78rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .project-next-action {
            font-size: 0.78rem;
            color: var(--text-primary);
            background: rgba(139,92,246,0.06);
            border-left: 3px solid var(--accent);
            padding: 8px 10px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 12px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .project-continue-btn {
            width: 100%;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent-light);
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .project-continue-btn:hover {
            background: var(--accent);
            color: white;
        }

        /* ==================== MEMORY INTELLIGENCE GRID ==================== */
        .mem-intel-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        @media (max-width: 768px) {
            .mem-intel-grid { grid-template-columns: repeat(2, 1fr); }
        }
        .mem-tile {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .mem-tile:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        .mem-tile-value {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }
        .mem-tile-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }
        .mem-tile-sub {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* ==================== HOMEPAGE V2: DETAIL MODAL ==================== */
        .home-detail-modal {
            max-width: 500px;
            width: 100%;
            border-radius: 20px;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }
        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 20px;
            border-bottom: 2px solid var(--accent);
            gap: 12px;
        }
        .detail-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }
        .detail-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .detail-titles { min-width: 0; flex: 1; }
        .detail-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .detail-subtitle {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        .detail-body {
            padding: 16px 20px;
            max-height: 50vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .detail-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .detail-section-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .detail-section-content {
            font-size: 0.85rem;
            color: var(--text-primary);
            line-height: 1.5;
        }
        .detail-stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .detail-stat-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
            text-align: center;
        }
        .detail-stat-item-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .detail-stat-item-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 2px;
        }
        .detail-subgoal-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .detail-subgoal-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.82rem;
            color: var(--text-secondary);
        }
        .detail-subgoal-item.done {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .detail-subgoal-check {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            flex-shrink: 0;
        }
        .detail-subgoal-item.done .detail-subgoal-check {
            background: var(--green);
            border-color: var(--green);
            color: white;
        }
        .detail-blocker-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .detail-blocker-pill {
            font-size: 0.72rem;
            padding: 3px 10px;
            border-radius: 8px;
            background: rgba(239,68,68,0.12);
            color: var(--red);
        }
        .detail-file-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .detail-file-item {
            font-size: 0.78rem;
            color: var(--accent-light);
            font-family: monospace;
            padding: 3px 8px;
            background: rgba(139,92,246,0.06);
            border-radius: 6px;
        }
        .detail-progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.06);
            border-radius: 3px;
            overflow: hidden;
        }
        .detail-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.4s ease;
        }
        .detail-footer {
            display: flex;
            gap: 8px;
            padding: 14px 20px;
            border-top: 1px solid var(--border);
        }
        .detail-action-btn {
            flex: 1;
            padding: 9px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        .detail-action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .detail-action-btn:active {
            transform: scale(0.97);
        }
        .detail-action-btn.primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .detail-action-btn.primary:hover {
            background: var(--accent-dark);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
        }
        .detail-header.type-action { border-bottom-color: #8b5cf6; }
        .detail-header.type-goal { border-bottom-color: #f59e0b; }
        .detail-header.type-project { border-bottom-color: #3b82f6; }
        .detail-header.type-stat { border-bottom-color: #22c55e; }
        .detail-header.type-activity { border-bottom-color: #06b6d4; }

        @media (max-width: 500px) {
            .home-detail-modal {
                max-width: 100%;
                border-radius: 20px 20px 0 0;
                position: fixed;
                bottom: 0;
                margin: 0;
            }
            #home-detail-modal {
                align-items: flex-end;
            }
        }

        /* ==================== HOMEPAGE V2: SECTION CARD STYLING ==================== */
        .home-section {
            margin-bottom: 10px;
            background: rgba(12,12,20,0.6);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px 16px;
        }
        .home-section .section-title {
            border-left: 3px solid var(--accent);
            padding-left: 10px;
        }

        /* ==================== HOMEPAGE V2: COLLAPSIBLE SECTIONS ==================== */
        .section-collapse-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }
        .section-collapse-header:hover .section-title {
            color: var(--text-secondary);
        }
        .section-collapse-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-count-badge {
            font-size: 0.65rem;
            padding: 1px 7px;
            border-radius: 8px;
            background: rgba(139,92,246,0.15);
            color: var(--accent-light);
            font-weight: 600;
        }
        .section-chevron {
            font-size: 0.7rem;
            color: var(--text-muted);
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }
        .home-section.collapsed .section-chevron {
            transform: rotate(-90deg);
        }
        .home-section-body {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.35s ease, opacity 0.25s ease, margin-top 0.3s ease;
            opacity: 1;
            margin-top: 10px;
        }
        .home-section.collapsed .home-section-body {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        /* ==================== HOMEPAGE V2: COMPACT GOAL ROWS ==================== */
        .goal-compact-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .goal-compact-row:hover {
            background: rgba(139,92,246,0.06);
            border-color: var(--accent);
        }
        .goal-priority-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .goal-priority-dot.high { background: var(--red); }
        .goal-priority-dot.medium { background: #f59e0b; }
        .goal-priority-dot.low { background: var(--green); }
        .goal-compact-desc {
            flex: 1;
            font-size: 0.82rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }
        .goal-mini-progress {
            width: 50px;
            height: 4px;
            background: rgba(255,255,255,0.06);
            border-radius: 2px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .goal-mini-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
        }
        .goal-compact-badge {
            font-size: 0.58rem;
            padding: 1px 6px;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        .goal-compact-badge.high { background: rgba(239,68,68,0.2); color: var(--red); }
        .goal-compact-badge.medium { background: rgba(245,158,11,0.2); color: #f59e0b; }
        .goal-compact-badge.low { background: rgba(34,197,94,0.2); color: var(--green); }

        /* ==================== HOMEPAGE V2: FIXED CARD HEIGHTS ==================== */
        .action-card {
            height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .project-card {
            height: 210px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
        }

        /* ==================== HOMEPAGE V2: MEMORY TILE ACCENTS ==================== */
        .mem-tile.green { border-left: 3px solid var(--green); }
        .mem-tile.amber { border-left: 3px solid #f59e0b; }
        .mem-tile.purple { border-left: 3px solid var(--accent); }

        /* ==================== HOMEPAGE V2: HERO BAR TIGHTER ==================== */
        .hero-bar { padding: 12px 16px 10px; }
        .hero-pills { margin-top: 8px; }
        .stat-pill { padding: 5px 6px; }

        /* ==================== HOMEPAGE V2: TIGHTER LIVE ACTIVITY ==================== */
        .live-card-header { padding: 8px 12px; }
        .live-card-body { padding: 10px 12px; min-height: 50px; }

        /* Active Work Card */
        .active-work-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
        }

        .active-work-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .active-work-badge {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .active-work-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .active-work-phase {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .active-work-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ==================== SMART SUMMARY CARD ==================== */
        .smart-summary-card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .smart-summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .smart-summary-header:hover {
            background: var(--bg-hover);
        }

        .smart-summary-title-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .smart-summary-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent), var(--blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .smart-summary-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .smart-summary-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .smart-summary-badges {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .summary-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .summary-badge.active {
            background: rgba(34, 197, 94, 0.15);
            color: var(--green);
        }

        .summary-badge.agents {
            background: rgba(59, 130, 246, 0.15);
            color: var(--blue);
        }

        .summary-badge.empty {
            background: var(--bg-elevated);
            color: var(--text-muted);
        }

        .smart-summary-toggle {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .smart-summary-toggle:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .smart-summary-toggle svg {
            transition: transform 0.3s ease;
        }

        .smart-summary-card.expanded .smart-summary-toggle svg {
            transform: rotate(180deg);
        }

        .smart-summary-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .smart-summary-card.expanded .smart-summary-content {
            max-height: 500px;
        }

        .smart-summary-inner {
            padding: 0 16px 16px;
        }

        .summary-section {
            margin-bottom: 16px;
        }

        .summary-section:last-child {
            margin-bottom: 0;
        }

        .summary-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .active-work-summary {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .active-work-summary:hover {
            border-color: var(--accent);
            background: var(--bg-hover);
        }

        .active-work-project {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .active-work-next {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .active-work-phase {
            font-size: 0.7rem;
            color: var(--accent);
            margin-top: 6px;
        }

        .agents-review-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .agent-review-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .agent-review-item:hover {
            background: var(--bg-hover);
        }

        .agent-review-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .agent-review-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .agent-review-status.completed {
            background: var(--green);
        }

        .agent-review-status.running {
            background: var(--blue);
            animation: pulse 1.5s infinite;
        }

        .agent-review-name {
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .agent-review-action {
            font-size: 0.75rem;
            color: var(--accent);
        }

        .smart-summary-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .summary-action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .summary-action-btn.primary {
            background: linear-gradient(135deg, var(--accent), var(--blue));
            color: white;
        }

        .summary-action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .summary-action-btn.secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .summary-action-btn.secondary:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .no-items-message {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* ==================== INTEREST SUGGESTIONS ==================== */
        .interest-suggestions-section {
            margin-bottom: 24px;
        }

        .interest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .interest-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .refresh-interests-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .refresh-interests-btn:hover {
            color: var(--accent);
            background: var(--bg-hover);
        }

        .interest-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        @media (max-width: 768px) {
            .interest-cards {
                grid-template-columns: 1fr;
            }
        }

        .interest-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .interest-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .interest-card.fun-project {
            border-top: 3px solid var(--green);
        }

        .interest-card.business-feature {
            border-top: 3px solid var(--blue);
        }

        .interest-card.claude-choice {
            border-top: 3px solid var(--accent);
        }

        .interest-type-badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .fun-project .interest-type-badge {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
        }

        .business-feature .interest-type-badge {
            background: rgba(59, 130, 246, 0.2);
            color: var(--blue);
        }

        .claude-choice .interest-type-badge {
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent);
        }

        .interest-card-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin: 8px 0 6px;
            color: var(--text-primary);
        }

        .interest-card-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .interest-card-reason {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .interest-dismiss-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .interest-card:hover .interest-dismiss-btn {
            opacity: 1;
        }

        .interest-dismiss-btn:hover {
            background: var(--red);
            color: white;
            border-color: var(--red);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ==================== SUGGESTIONS LOADING STATE ==================== */
        .suggestions-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            gap: 20px;
        }

        .loading-brain {
            position: relative;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brain-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--accent-glow);
            animation: brainPulse 1.5s ease-in-out infinite;
        }

        @keyframes brainPulse {
            0%, 100% { transform: scale(0.8); opacity: 0.3; }
            50% { transform: scale(1.2); opacity: 0.6; }
        }

        .brain-icon {
            font-size: 2.5rem;
            z-index: 1;
            animation: brainFloat 2s ease-in-out infinite;
        }

        @keyframes brainFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .loading-brain.complete .brain-pulse {
            animation: none;
            background: rgba(34, 197, 94, 0.3);
        }

        .loading-brain.complete .brain-icon {
            animation: none;
        }

        .suggestions-loading.complete {
            animation: fadeOut 0.5s ease-out forwards;
            animation-delay: 0.3s;
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: scale(0.95); }
        }

        .loading-message {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            color: var(--text-secondary);
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading-icon {
            font-size: 1.2rem;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: var(--bg-elevated);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-bar {
            height: 100%;
            width: 30%;
            background: var(--accent-gradient);
            border-radius: 2px;
            animation: loadingSlide 1.5s ease-in-out infinite;
        }

        @keyframes loadingSlide {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(250%); }
            100% { transform: translateX(-100%); }
        }

        /* ==================== SUGGESTION CATEGORIES ==================== */
        .suggestion-category {
            margin-bottom: 20px;
            animation: categoryFadeIn 0.4s ease-out forwards;
            opacity: 0;
        }

        @keyframes categoryFadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding: 0 4px;
        }

        .category-icon {
            font-size: 1rem;
        }

        .category-name {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .category-count {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--bg-elevated);
            color: var(--text-muted);
        }

        .category-cards {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Self-improvement category special styling */
        .suggestion-category:has(.category-name:contains('Self')) .suggestion-card {
            border-left: 3px solid var(--accent);
        }

        /* Animate suggestion cards on render */
        .suggestion-card {
            animation: cardSlideIn 0.3s ease-out forwards;
        }

        @keyframes cardSlideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Device sync indicator */
        .sync-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            color: var(--text-muted);
            padding: 4px 8px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .sync-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ==================== AGENTS VIEW ==================== */
        .agents-view {
            padding: 20px;
            gap: 16px;
            overflow-y: auto;
            min-height: min-content;
        }

        .agents-header {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
        }

        .agents-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agents-count {
            font-size: 0.8rem;
            color: var(--text-muted);
            background: var(--bg-card);
            padding: 4px 10px;
            border-radius: 12px;
        }

        /* 3-segment tab control */
        .agents-tab-control {
            display: flex;
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            padding: 3px;
            gap: 3px;
        }
        .agents-tab {
            flex: 1;
            padding: 8px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        .agents-tab:hover { color: var(--text-secondary); background: rgba(139, 92, 246, 0.06); }
        .agents-tab.active {
            color: #fff;
            background: rgba(139, 92, 246, 0.25);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.15);
        }

        .agent-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 12px;
            transition: all 0.3s var(--ease-out-expo);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .agent-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
        }

        .agent-card:hover {
            transform: translateY(-4px);
            border-color: var(--glass-border-hover);
            box-shadow:
                0 12px 40px rgba(0, 0, 0, 0.4),
                0 0 30px var(--glow-subtle);
        }

        .agent-card:active {
            transform: translateY(-2px);
        }

        .agent-card.running {
            border-left: 3px solid var(--accent);
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.3),
                -4px 0 20px var(--glow-subtle);
            animation: agentPulse 2s infinite;
        }

        .agent-card.completed {
            border-left: 3px solid var(--green);
        }

        .agent-card.failed {
            border-left: 3px solid var(--red);
        }

        @keyframes agentPulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), -4px 0 20px var(--glow-subtle); }
            50% { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), -4px 0 30px var(--glow-medium); }
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .agent-id {
            font-family: 'SF Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            background: var(--bg-elevated);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .agent-parent-badge {
            font-size: 0.65rem;
            color: var(--cyan);
            background: rgba(34, 211, 238, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
            font-weight: 500;
        }

        .agent-card.follow-up {
            border-left: 3px solid var(--cyan);
        }

        /* ==================== AGENT SELECT MODE ==================== */
        .agent-select-checkbox {
            display: none;
            position: absolute;
            top: 14px;
            left: 14px;
            width: 22px;
            height: 22px;
            border-radius: 6px;
            border: 2px solid var(--border);
            background: var(--bg-elevated);
            cursor: pointer;
            z-index: 15;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .agent-select-checkbox::after {
            content: '';
            display: none;
            width: 10px;
            height: 6px;
            border-left: 2.5px solid #fff;
            border-bottom: 2.5px solid #fff;
            transform: rotate(-45deg);
            margin-top: -2px;
        }
        .agent-select-checkbox.checked {
            background: var(--accent);
            border-color: var(--accent);
        }
        .agent-select-checkbox.checked::after {
            display: block;
        }
        .select-mode .agent-select-checkbox {
            display: flex;
        }
        .select-mode .agent-card {
            padding-left: 48px;
        }
        .agent-card.selected {
            border-color: var(--accent) !important;
            box-shadow: 0 0 12px rgba(139, 92, 246, 0.3), 0 0 24px rgba(139, 92, 246, 0.1);
        }

        /* Select button in agents header */
        .btn-select-header {
            font-size: 0.75rem;
            padding: 4px 14px;
            border-radius: 8px;
        }

        /* Selection action bar */
        .selection-action-bar {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--accent);
            border-radius: 16px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(139, 92, 246, 0.2);
            animation: slideUpIn 0.3s var(--ease-out-expo);
        }
        @keyframes slideUpIn {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .selection-action-bar .selection-count {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .selection-action-bar .btn {
            font-size: 0.85rem;
            padding: 8px 16px;
            white-space: nowrap;
        }

        /* Merge spawn modal */
        .merge-agent-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
            max-height: 200px;
            overflow-y: auto;
        }
        .merge-agent-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.85rem;
        }
        .merge-agent-item .agent-type-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 6px;
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent);
            font-weight: 600;
        }
        .merge-agent-item .agent-callsign {
            font-weight: 600;
            color: var(--text-primary);
        }
        .merge-agent-item .agent-task-preview {
            color: var(--text-muted);
            font-size: 0.8rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        /* ==================== SUB-AGENTS NESTED VIEW ==================== */
        .agent-card.has-children {
            padding-bottom: 12px;
        }

        .sub-agent-count-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            color: var(--accent);
            background: rgba(139, 92, 246, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sub-agent-count-badge:hover {
            background: rgba(139, 92, 246, 0.35);
            transform: scale(1.05);
        }

        .sub-agent-count-badge svg {
            width: 10px;
            height: 10px;
            transition: transform 0.2s ease;
        }

        .sub-agent-count-badge.expanded svg {
            transform: rotate(180deg);
        }

        .sub-agents-container {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            display: none;
        }

        .sub-agents-container.expanded {
            display: block;
        }

        .sub-agents-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 0 4px;
        }

        .sub-agents-title {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .sub-agent-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 14px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .sub-agent-card:last-child {
            margin-bottom: 0;
        }

        .sub-agent-card:hover {
            background: var(--bg-hover);
            border-color: var(--border-light);
            transform: translateX(4px);
        }

        .sub-agent-card.running {
            border-left: 2px solid var(--accent);
        }

        .sub-agent-card.completed {
            border-left: 2px solid var(--green);
        }

        .sub-agent-card.failed {
            border-left: 2px solid var(--red);
        }

        .sub-agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .sub-agent-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sub-agent-status {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .sub-agent-status.running {
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent);
        }

        .sub-agent-status.completed {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
        }

        .sub-agent-status.failed {
            background: rgba(239, 68, 68, 0.2);
            color: var(--red);
        }

        .sub-agent-task {
            font-size: 0.7rem;
            color: var(--text-secondary);
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .sub-agent-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .sub-agent-tool {
            font-size: 0.6rem;
            background: var(--bg-card);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--text-muted);
        }

        /* ==================== CONTEXT ATTACH UI ==================== */
        .context-attach-menu {
            position: fixed;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 4px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 10000;
            min-width: 180px;
        }

        .context-attach-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            color: var(--text-primary);
            transition: background 0.15s;
        }

        .context-attach-menu-item:hover {
            background: var(--bg-hover);
        }

        .attached-contexts {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border-radius: 10px 10px 0 0;
            border-bottom: 1px solid var(--border);
        }

        .attached-context-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(34, 211, 238, 0.15);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            max-width: 220px;
            border: 1px solid rgba(34, 211, 238, 0.3);
        }

        .attached-context-badge .badge-icon {
            color: var(--accent);
        }

        .attached-context-badge .preview {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .attached-context-badge .remove-btn {
            cursor: pointer;
            opacity: 0.6;
            color: var(--text-secondary);
            font-size: 0.9rem;
            padding: 0 2px;
        }

        .attached-context-badge .remove-btn:hover {
            opacity: 1;
            color: var(--red);
        }

        .message.attachable {
            cursor: pointer;
            transition: all 0.15s;
        }

        .message.attachable:hover {
            background: rgba(139, 92, 246, 0.05);
        }

        .message.attached {
            border-left: 3px solid var(--accent);
            padding-left: 13px;
        }

        .agent-chat-page-message.attachable:hover,
        .agent-chat-message.attachable:hover {
            background: rgba(139, 92, 246, 0.05);
        }

        .agent-chat-page-message.attached,
        .agent-chat-message.attached {
            border-left: 3px solid var(--accent);
        }

        .agent-status {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .agent-status.running {
            background: var(--accent-glow);
            color: var(--accent);
        }

        .agent-status.completed {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
        }

        .agent-status.failed {
            background: rgba(239, 68, 68, 0.2);
            color: var(--red);
        }

        .agent-status.queued {
            background: rgba(234, 179, 8, 0.2);
            color: var(--yellow);
        }

        .agent-task {
            font-size: 0.9rem;
            margin-bottom: 10px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .agent-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .agent-tool {
            font-size: 0.65rem;
            padding: 2px 8px;
            background: var(--bg-elevated);
            border-radius: 8px;
            color: var(--text-secondary);
        }

        .agent-output {
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: var(--bg-elevated);
            padding: 10px;
            border-radius: 8px;
            max-height: 100px;
            overflow-y: auto;
            font-family: 'SF Mono', monospace;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .agent-expand-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: center;
        }

        /* Agent Detail Modal */
        .agent-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .agent-detail-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .agent-detail-meta-item {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .agent-detail-meta-item strong {
            color: var(--text-primary);
        }

        .agent-detail-task {
            background: var(--bg-elevated);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .agent-detail-section {
            margin-bottom: 16px;
        }

        .agent-detail-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .agent-detail-output {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'SF Mono', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.5;
        }

        .agent-detail-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .agent-detail-tool {
            background: var(--accent-glow);
            color: var(--accent);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .agent-detail-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--red);
            padding: 12px;
            border-radius: 8px;
            color: var(--red);
        }

        .copy-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .copy-btn.copied {
            background: var(--green);
            color: white;
            border-color: var(--green);
        }

        /* ==================== AGENT DETAIL PAGE ==================== */
        .agent-detail-page {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .agent-detail-page.active {
            display: flex;
        }

        .agent-detail-page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .agent-detail-page-header .back-btn {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 8px;
            margin-left: -8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .agent-detail-page-header .agent-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .agent-detail-page-header .agent-status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .agent-status-badge.completed {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
        }

        .agent-status-badge.running {
            background: var(--accent-glow);
            color: var(--accent);
        }

        .agent-status-badge.failed {
            background: rgba(239, 68, 68, 0.2);
            color: var(--red);
        }

        .agent-status-badge.queued {
            background: rgba(234, 179, 8, 0.2);
            color: var(--yellow);
        }

        /* Mind Agents Tab */
        .mind-agents-items {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
        }

        .mind-agents-queue-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 10px;
            background: rgba(139, 92, 246, 0.08);
            border-radius: 10px;
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        .mind-agents-queue-header .queue-stats {
            font-size: 0.78rem;
            color: rgba(255,255,255,0.5);
        }

        .mind-agents-queue-header .queue-stats span {
            color: var(--accent);
            font-weight: 600;
        }

        .mind-agent-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mind-agent-card:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .mind-agent-card .agent-icon {
            font-size: 1.3rem;
            width: 32px;
            text-align: center;
            flex-shrink: 0;
        }

        .mind-agent-card .agent-info {
            flex: 1;
            min-width: 0;
        }

        .mind-agent-card .agent-callsign {
            font-size: 0.8rem;
            font-weight: 600;
            color: rgba(255,255,255,0.85);
        }

        .mind-agent-card .agent-task-preview {
            font-size: 0.72rem;
            color: rgba(255,255,255,0.4);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mind-agent-card .agent-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .mind-agent-card .agent-status-dot.running {
            background: var(--accent);
            box-shadow: 0 0 6px var(--accent);
            animation: pulse-dot 1.5s infinite;
        }

        .mind-agent-card .agent-status-dot.queued {
            background: var(--yellow);
            box-shadow: 0 0 4px rgba(234, 179, 8, 0.4);
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .mind-agents-empty {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255,255,255,0.3);
            font-size: 0.82rem;
        }

        .mind-agents-empty .empty-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .agent-detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: calc(80px + var(--safe-bottom));
        }

        .agent-info-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .agent-info-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 12px;
        }

        .agent-info-item {
            font-size: 0.85rem;
        }

        .agent-info-item .label {
            color: var(--text-muted);
            margin-right: 4px;
        }

        .agent-info-item .value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .agent-task-box {
            background: var(--bg-elevated);
            padding: 14px;
            border-radius: 12px;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .agent-section {
            margin-bottom: 20px;
        }

        .agent-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .agent-tools-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .agent-tool-badge {
            background: var(--accent-glow);
            color: var(--accent);
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Sub-Agents Navigation in Detail Page */
        .sub-agents-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 8px;
        }

        .sub-agent-nav-card {
            flex: 1;
            min-width: 140px;
            max-width: 200px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sub-agent-nav-card:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .sub-agent-nav-card.running {
            border-left: 3px solid var(--accent);
        }

        .sub-agent-nav-card.completed {
            border-left: 3px solid var(--green);
        }

        .sub-agent-nav-card.failed {
            border-left: 3px solid var(--red);
        }

        .sub-agent-nav-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .sub-agent-nav-task {
            font-size: 0.7rem;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .sub-agent-nav-status {
            font-size: 0.65rem;
            margin-top: 6px;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        .sub-agent-nav-status.running {
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent);
        }

        .sub-agent-nav-status.completed {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
        }

        .sub-agent-nav-status.failed {
            background: rgba(239, 68, 68, 0.2);
            color: var(--red);
        }

        /* Rendered Markdown Output */
        .agent-output-rendered {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            overflow-x: auto;
        }

        .agent-output-rendered h1,
        .agent-output-rendered h2,
        .agent-output-rendered h3 {
            color: var(--text-primary);
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .agent-output-rendered h1:first-child,
        .agent-output-rendered h2:first-child,
        .agent-output-rendered h3:first-child {
            margin-top: 0;
        }

        .agent-output-rendered h1 { font-size: 1.4rem; }
        .agent-output-rendered h2 { font-size: 1.2rem; color: var(--accent); }
        .agent-output-rendered h3 { font-size: 1rem; }

        .agent-output-rendered p {
            margin-bottom: 1em;
            line-height: 1.6;
        }

        .agent-output-rendered ul,
        .agent-output-rendered ol {
            margin-left: 20px;
            margin-bottom: 1em;
        }

        .agent-output-rendered li {
            margin-bottom: 0.5em;
            line-height: 1.5;
        }

        .agent-output-rendered code {
            background: var(--bg-elevated);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', monospace;
            font-size: 0.85em;
            color: var(--accent);
        }

        .agent-output-rendered pre {
            background: var(--bg-primary);
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 1em;
        }

        .agent-output-rendered pre code {
            background: none;
            padding: 0;
            color: var(--text-primary);
        }

        .agent-output-rendered table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.85rem;
        }

        .agent-output-rendered th,
        .agent-output-rendered td {
            border: 1px solid var(--border);
            padding: 10px 12px;
            text-align: left;
        }

        .agent-output-rendered th {
            background: var(--bg-elevated);
            color: var(--accent);
            font-weight: 600;
        }

        .agent-output-rendered tr:nth-child(even) {
            background: var(--bg-secondary);
        }

        .agent-output-rendered a {
            color: var(--accent);
            text-decoration: none;
        }

        .agent-output-rendered a:hover {
            text-decoration: underline;
        }

        .agent-output-rendered blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 16px;
            margin: 1em 0;
            color: var(--text-secondary);
        }

        .agent-output-rendered strong {
            color: var(--text-primary);
        }

        .agent-output-rendered hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 1.5em 0;
        }

        /* Recommendations Section */
        .recommendations-section {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1));
            border: 1px solid var(--accent);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .recommendations-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recommendation-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .recommendation-item:last-child {
            margin-bottom: 0;
        }

        .recommendation-text {
            flex: 1;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .recommendation-btn {
            background: var(--accent-gradient);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .recommendation-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        /* Agent Actions Footer */
        .agent-actions-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 16px 20px;
            padding-bottom: calc(16px + var(--safe-bottom));
            display: flex;
            gap: 12px;
            z-index: 1001;
        }

        .agent-action-btn {
            flex: 1;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .agent-action-btn.primary {
            background: var(--accent-gradient);
            border: none;
            color: white;
        }

        .agent-action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--accent-glow);
        }

        .agent-action-btn.secondary {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        /* Agent Inline Chat */
        .agent-chat-container {
            margin-top: 24px;
            padding-bottom: 20px;
            border-top: 1px solid var(--border);
            padding-top: 20px;
        }

        .agent-chat-container:empty {
            display: none;
            border-top: none;
            padding: 0;
            margin: 0;
        }

        .agent-chat-messages {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .agent-chat-messages:empty {
            display: none;
        }

        .agent-chat-message {
            padding: 14px 18px;
            border-radius: 16px;
            max-width: 90%;
            line-height: 1.5;
        }

        .agent-chat-message.user {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .agent-chat-message.assistant {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .agent-chat-message .chat-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 6px;
            opacity: 0.7;
        }

        /* Agent Ask Input */
        .agent-ask-input-area {
            background: var(--bg-elevated);
            border-top: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            gap: 10px;
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            z-index: 1002;
        }

        .agent-ask-input {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 0.95rem;
            outline: none;
        }

        .agent-ask-input:focus {
            border-color: var(--accent);
        }

        .agent-ask-send {
            background: var(--accent);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .agent-ask-send:hover {
            background: var(--accent-secondary);
        }

        .agent-ask-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .agent-action-btn.secondary:hover {
            background: var(--bg-hover);
        }

        /* ==================== AGENT CHAT PAGE ==================== */
        .agent-chat-page {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 1002;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .agent-chat-page.active {
            display: flex;
        }

        .agent-chat-page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .agent-chat-page-header .back-btn {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 8px;
            margin-left: -8px;
        }

        .agent-chat-page-title {
            font-size: 1rem;
            font-weight: 600;
        }

        /* Context Summary Collapse */
        .agent-context-summary {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .context-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .context-toggle:hover {
            background: var(--bg-hover);
        }

        .context-toggle-icon {
            transition: transform 0.2s;
        }

        .context-toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .context-details {
            padding: 0 20px 16px 20px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .context-details.collapsed {
            max-height: 0;
            padding-bottom: 0;
        }

        .context-task {
            background: var(--bg-elevated);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .context-output-preview {
            font-size: 0.8rem;
            color: var(--text-secondary);
            max-height: 80px;
            overflow: hidden;
            position: relative;
        }

        .context-output-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(transparent, var(--bg-card));
        }

        /* Chat Messages Area */
        .agent-chat-messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            -webkit-overflow-scrolling: touch;
        }

        .agent-chat-page-message {
            padding: 14px 18px;
            border-radius: 16px;
            max-width: 85%;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .agent-chat-page-message.user {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .agent-chat-page-message.assistant {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .agent-chat-page-message.thinking {
            color: var(--text-muted);
            font-style: italic;
        }

        .agent-chat-page-message .chat-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 6px;
            opacity: 0.7;
        }

        /* Chat Input Area */
        .agent-chat-input-area {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 16px 20px;
            padding-bottom: calc(16px + var(--safe-bottom));
            display: flex;
            gap: 12px;
            flex-shrink: 0;
        }

        .agent-chat-input {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 0.95rem;
            outline: none;
        }

        .agent-chat-input:focus {
            border-color: var(--accent);
        }

        .agent-chat-send-btn {
            background: var(--accent-gradient);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .agent-chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .agent-chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .agent-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .no-agents {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .no-agents-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .spawn-agent-btn {
            margin-top: 16px;
        }

        /* ==================== ARCHIVE SECTION ==================== */
        .archive-section {
            margin-top: 24px;
            border-top: 1px solid var(--border);
            padding-top: 16px;
        }

        .archive-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid var(--border);
        }

        .archive-toggle:hover {
            background: var(--bg-hover);
        }

        .archive-toggle-icon {
            transition: transform 0.2s;
            color: var(--text-muted);
        }

        .archive-toggle-icon.expanded {
            transform: rotate(90deg);
        }

        .archived-count {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .archived-agents-container {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .archived-agents-container.hidden {
            display: none;
        }

        /* Archived agent cards - slightly dimmed */
        .agent-card.archived {
            opacity: 0.7;
            border-style: dashed;
        }

        .agent-card.archived:hover {
            opacity: 1;
        }

        /* Archive/Unarchive buttons on cards */
        .agent-archive-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.7rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
            z-index: 10;
        }

        .agent-card:hover .agent-archive-btn {
            opacity: 1;
        }

        .agent-archive-btn:hover {
            background: var(--bg-hover);
        }

        /* ==================== MODAL ==================== */
        /* Prevent body scroll when modal is open */
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-large {
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* ==================== CEREBRO CONFIRM DIALOG ==================== */
        .cerebro-confirm-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
        }
        .cerebro-confirm-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .cerebro-confirm-box {
            background: linear-gradient(145deg, rgba(30, 27, 50, 0.98), rgba(15, 12, 28, 0.98));
            border: 1px solid rgba(139, 92, 246, 0.25);
            border-radius: 16px;
            padding: 0;
            min-width: 340px;
            max-width: 420px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6), 0 0 30px rgba(139, 92, 246, 0.08);
            transform: scale(0.92) translateY(-10px);
            transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .cerebro-confirm-overlay.active .cerebro-confirm-box {
            transform: scale(1) translateY(0);
        }
        .cerebro-confirm-header {
            padding: 20px 24px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .cerebro-confirm-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .cerebro-confirm-icon.warn {
            background: rgba(251, 191, 36, 0.12);
            color: #fbbf24;
        }
        .cerebro-confirm-icon.danger {
            background: rgba(239, 68, 68, 0.12);
            color: #ef4444;
        }
        .cerebro-confirm-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .cerebro-confirm-body {
            padding: 12px 24px 20px;
            color: var(--text-secondary);
            font-size: 0.88rem;
            line-height: 1.5;
        }
        .cerebro-confirm-actions {
            display: flex;
            gap: 10px;
            padding: 0 24px 20px;
            justify-content: flex-end;
        }
        .cerebro-confirm-btn {
            padding: 9px 20px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
        }
        .cerebro-confirm-btn.cancel {
            background: rgba(255, 255, 255, 0.06);
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .cerebro-confirm-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        .cerebro-confirm-btn.confirm {
            background: var(--accent);
            color: white;
        }
        .cerebro-confirm-btn.confirm:hover {
            filter: brightness(1.15);
            transform: translateY(-1px);
        }
        .cerebro-confirm-btn.confirm.danger {
            background: rgba(239, 68, 68, 0.85);
        }
        .cerebro-confirm-btn.confirm.danger:hover {
            background: #ef4444;
        }

        /* ==================== THOUGHT DETAIL MODAL ==================== */
        .thought-detail-modal {
            max-width: 550px;
            background: linear-gradient(145deg, rgba(30, 27, 45, 0.98), rgba(20, 18, 35, 0.98));
            border: 1px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 40px rgba(139, 92, 246, 0.1);
        }

        .thought-detail-modal .modal-header {
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.1), transparent);
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        .thought-phase-icon {
            font-size: 1.3rem;
            margin-right: 10px;
        }

        .thought-detail-time {
            padding: 8px 20px;
            font-size: 0.8rem;
            color: var(--text-muted);
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
        }

        .thought-detail-body {
            padding: 24px 20px;
        }

        .thought-detail-section {
            margin-bottom: 20px;
        }

        .thought-detail-section:last-child {
            margin-bottom: 0;
        }

        .thought-detail-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(139, 92, 246, 0.8);
            margin-bottom: 8px;
        }

        .thought-detail-value {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-primary);
            background: rgba(0, 0, 0, 0.2);
            padding: 14px 16px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .thought-reasoning {
            font-style: italic;
            color: rgba(255, 255, 255, 0.85);
            border-left: 3px solid rgba(139, 92, 246, 0.5);
            padding-left: 16px;
            margin-left: 0;
        }

        .thought-detail-inline {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .thought-detail-inline .thought-detail-label {
            margin-bottom: 0;
        }

        .thought-type-badge {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(168, 85, 247, 0.2));
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .confidence-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .confidence-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .confidence-text {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .thought-metadata {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
        }

        .meta-item {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .meta-item:last-child {
            border-bottom: none;
        }

        .meta-key {
            color: rgba(139, 92, 246, 0.8);
            font-weight: 500;
        }

        .meta-value {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Thought list items (opportunities, threats, priorities) */
        .thought-list {
            padding: 0 !important;
            background: transparent !important;
            border: none !important;
        }

        .list-item {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .list-item.opportunity {
            background: rgba(16, 185, 129, 0.15);
            border-left: 3px solid #10b981;
        }

        .list-item.threat {
            background: rgba(239, 68, 68, 0.15);
            border-left: 3px solid #ef4444;
        }

        .list-item.priority {
            background: rgba(59, 130, 246, 0.15);
            border-left: 3px solid #3b82f6;
        }

        /* Decision details */
        .thought-decision {
            padding: 0 !important;
            background: transparent !important;
            border: none !important;
        }

        .decision-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .decision-row:last-child {
            border-bottom: none;
        }

        .decision-key {
            color: rgba(255, 255, 255, 0.6);
            min-width: 120px;
            font-size: 0.85rem;
        }

        .decision-value {
            color: rgba(255, 255, 255, 0.95);
            font-weight: 500;
        }

        .action-badge {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.4), rgba(168, 85, 247, 0.3));
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .risk-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }

        /* Tool calls */
        .thought-tools {
            padding: 0 !important;
            background: transparent !important;
            border: none !important;
        }

        .tool-call-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            margin: 4px 0;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }

        .tool-call-item.success {
            border-left: 3px solid #10b981;
        }

        .tool-call-item.failed {
            border-left: 3px solid #ef4444;
        }

        .tool-name {
            font-weight: 600;
            color: rgba(139, 92, 246, 0.9);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
        }

        .tool-query {
            flex: 1;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            font-style: italic;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tool-status {
            font-size: 1rem;
        }

        /* Raw data section */
        .thought-raw pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 12px;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-family: 'Monaco', 'Menlo', monospace;
        }

        /* Make modal scrollable and larger */
        .thought-detail-modal {
            max-width: 700px !important;
            max-height: 85vh;
            overflow-y: auto;
        }

        .thought-detail-body {
            max-height: none !important;
        }

        /* (Legacy .activity-log-item removed  replaced by .activity-log-line terminal style) */

        /* ==================== MOBILE MODAL & WIZARD FIXES ==================== */
        @media (max-width: 768px) {
            /* Modal overlay - no padding on mobile */
            .modal-overlay {
                padding: 0;
                align-items: flex-end;
            }

            /* Base modal - full width, slide up from bottom */
            .modal {
                max-width: 100%;
                width: 100%;
                border-radius: 20px 20px 0 0;
                max-height: 95vh;
                display: flex;
                flex-direction: column;
            }

            /* Large modals - nearly fullscreen */
            .modal-large {
                max-width: 100%;
                width: 100%;
                max-height: 95vh;
                border-radius: 20px 20px 0 0;
                display: flex;
                flex-direction: column;
            }

            /* Modal body scrolls, not the whole modal */
            .modal-body {
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                padding: 16px;
            }

            /* Header/footer stay fixed */
            .modal-header {
                padding: 16px;
                flex-shrink: 0;
            }

            .modal-footer {
                padding: 12px 16px;
                flex-shrink: 0;
            }

            /* Wizard specific mobile fixes */
            .wizard-header {
                padding: 16px;
                flex-shrink: 0;
            }

            .wizard-header-content {
                gap: 12px;
            }

            .wizard-icon {
                width: 44px;
                height: 44px;
                font-size: 1.4rem;
            }

            .wizard-title {
                font-size: 1.1rem;
            }

            .wizard-subtitle {
                font-size: 0.75rem;
            }

            .wizard-body {
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                padding: 16px;
            }

            .wizard-footer {
                padding: 14px 16px;
                flex-shrink: 0;
                flex-direction: column;
                gap: 12px;
            }

            .wizard-actions {
                width: 100%;
                justify-content: stretch;
            }

            .wizard-actions .btn {
                flex: 1;
            }

            /* Mode toggle on mobile */
            .wizard-mode-toggle {
                flex-direction: column;
                gap: 6px;
            }

            .mode-btn {
                padding: 10px 12px;
                font-size: 0.8rem;
            }

            /* Form inputs on mobile */
            .form-input {
                padding: 12px 14px;
                font-size: 16px; /* Prevents iOS zoom */
            }

            .form-textarea {
                min-height: 80px;
            }

            /* Role selector grid */
            .role-selector {
                grid-template-columns: 1fr;
            }

            /* Analytics grid on mobile */
            .wizard-analytics {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .analytics-card {
                padding: 10px;
            }

            .analytics-icon {
                font-size: 1.2rem;
            }

            .analytics-value {
                font-size: 0.95rem;
            }

            /* Recommended agent card */
            .rec-agent-card {
                flex-direction: column;
                text-align: center;
                padding: 14px;
            }

            .rec-agent-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }

            /* Override options */
            .wizard-agent-override {
                flex-direction: column;
                align-items: stretch;
            }

            .override-options {
                justify-content: center;
            }

            /* Steps on mobile */
            .wizard-step {
                padding: 10px;
                gap: 10px;
            }

            .step-number {
                width: 24px;
                height: 24px;
                font-size: 0.75rem;
            }

            .step-title {
                font-size: 0.85rem;
            }

            .step-desc {
                font-size: 0.75rem;
            }

            /* Tools grid */
            .wizard-tools-grid {
                gap: 6px;
            }

            .wizard-tool {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            /* Team grid */
            .team-grid {
                grid-template-columns: 1fr;
            }

            /* Spawn mode toggle */
            .spawn-mode-toggle {
                flex-direction: column;
                gap: 4px;
            }

            /* Form row on mobile - stack vertically */
            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .form-half {
                width: 100%;
            }

            /* Workflow type selector */
            .workflow-type-selector {
                flex-direction: column;
            }

            /* Advanced toggle */
            .advanced-toggle {
                font-size: 0.85rem;
            }

            /* Button sizing */
            .btn {
                padding: 10px 16px;
                font-size: 0.85rem;
            }

            .btn-primary, .btn-secondary {
                min-width: 100px;
            }

            /* ===== MULTI-AGENT WORKFLOW MOBILE FIXES ===== */

            /* Team quantity selector - single column on mobile */
            .team-quantity-selector {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .team-member-qty {
                padding: 10px 12px;
            }

            .agent-label {
                font-size: 0.85rem;
            }

            .qty-btn {
                width: 32px;
                height: 32px;
                font-size: 1.2rem;
            }

            .qty-input {
                width: 44px;
                height: 32px;
                font-size: 1rem;
            }

            /* Workflow type cards */
            .workflow-type {
                padding: 10px;
            }

            .workflow-type-icon {
                font-size: 1.2rem;
                margin-bottom: 2px;
            }

            .workflow-type-name {
                font-size: 0.85rem;
            }

            .workflow-type-desc {
                font-size: 0.65rem;
                line-height: 1.3;
            }

            /* Workflow preview diagram */
            .workflow-preview {
                padding: 12px;
                margin-top: 12px;
            }

            .workflow-preview-title {
                font-size: 0.75rem;
                margin-bottom: 10px;
            }

            .commander-node {
                padding: 10px 16px;
                font-size: 0.85rem;
            }

            .commander-node .node-icon svg {
                width: 12px;
                height: 12px;
            }

            .command-line {
                height: 16px;
            }

            .team-nodes {
                gap: 6px;
            }

            .team-node {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            /* Workflow type grid (used in orchestrator config) */
            .workflow-type-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .workflow-type-card {
                padding: 10px;
            }

            .workflow-type-card .workflow-type-icon {
                font-size: 1.4rem;
                margin-bottom: 4px;
            }

            /* Role options in workflow */
            .role-option {
                padding: 10px;
            }

            .role-icon {
                font-size: 1.1rem;
            }

            .role-name {
                font-size: 0.85rem;
            }

            .role-desc {
                font-size: 0.7rem;
            }
        }

        /* Extra small screens */
        @media (max-width: 400px) {
            .modal {
                max-height: 100vh;
                border-radius: 0;
            }

            .modal-large {
                max-height: 100vh;
                border-radius: 0;
            }

            .wizard-analytics {
                grid-template-columns: 1fr 1fr;
            }

            .wizard-footer {
                padding: 12px;
            }

            .override-btn {
                padding: 5px 10px;
                font-size: 0.75rem;
            }

            /* Workflow extra small fixes */
            .team-member-qty {
                padding: 8px 10px;
            }

            .qty-btn {
                width: 28px;
                height: 28px;
            }

            .commander-node {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .team-node {
                padding: 5px 8px;
                font-size: 0.7rem;
            }

            .workflow-type-desc {
                display: none;
            }

            .role-desc {
                display: none;
            }
        }

        .spawn-mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: var(--bg-elevated);
            padding: 4px;
            border-radius: 10px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .mode-btn:hover {
            color: var(--text);
        }

        .mode-btn.active {
            background: var(--accent);
            color: white;
        }

        .role-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .role-option {
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        .role-option:hover {
            border-color: var(--accent);
        }

        .role-option.selected {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .role-desc {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .required {
            color: #ef4444;
        }

        .advanced-toggle {
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.2s;
        }

        .advanced-toggle:hover {
            color: var(--accent);
        }

        .advanced-options {
            border-top: 1px solid var(--border);
            padding-top: 16px;
            margin-top: 8px;
        }

        .advanced-options.hidden {
            display: none;
        }

        .form-textarea-small {
            min-height: 60px;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-half {
            flex: 1;
        }

        /* Workflow styles */
        .workflow-type-selector {
            display: flex;
            gap: 10px;
        }

        .workflow-type {
            flex: 1;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        .workflow-type:hover {
            border-color: var(--accent);
        }

        .workflow-type.selected {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .workflow-type-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .workflow-type-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .workflow-type-desc {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .team-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .team-member {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-elevated);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .team-member:hover {
            background: var(--border);
        }

        .team-member input {
            accent-color: var(--accent);
        }

        /* Quantity selector styles */
        .team-quantity-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .team-member-qty {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-elevated);
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .agent-label {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .qty-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: var(--accent);
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .qty-btn:active {
            transform: scale(0.95);
        }

        .qty-input {
            width: 40px;
            height: 28px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text);
            font-size: 0.95rem;
            font-weight: 600;
        }

        .qty-input::-webkit-inner-spin-button,
        .qty-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .workflow-preview {
            margin-top: 16px;
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
        }

        .workflow-preview-title {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 12px;
            text-align: center;
        }

        .workflow-diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .commander-node {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .command-line {
            width: 2px;
            height: 20px;
            background: var(--accent);
        }

        .team-nodes {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .team-node {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .role-icon {
            font-size: 1.5rem;
            margin-bottom: 6px;
        }

        .role-name {
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Section Title */
        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .section-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .section-title-row .section-title {
            margin-bottom: 0;
        }

        .refresh-suggestions-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .refresh-suggestions-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .refresh-suggestions-btn.spinning .refresh-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ==================== TASK WIZARD MODAL ==================== */
        .task-wizard {
            background: var(--bg-secondary);
            border-radius: 24px;
            width: 95%;
            max-width: 650px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 40px rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .wizard-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 24px;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        }

        .wizard-header-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .wizard-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .wizard-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0;
            color: white;
        }

        .wizard-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .wizard-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .wizard-section {
            margin-bottom: 24px;
        }

        .wizard-section:last-child {
            margin-bottom: 0;
        }

        .wizard-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .wizard-task-box {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-primary);
        }

        /* Analytics Grid */
        .wizard-analytics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        @media (max-width: 600px) {
            .wizard-analytics {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .analytics-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .analytics-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .analytics-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .analytics-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
        }

        .analytics-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* Recommended Agent */
        .rec-agent-card {
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            position: relative;
        }

        .rec-agent-card.selected {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .rec-agent-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .rec-agent-info {
            flex: 1;
        }

        .rec-agent-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .rec-agent-reason {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .rec-agent-badge {
            background: var(--accent);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
        }

        /* Agent Override */
        .wizard-agent-override {
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .override-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .override-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .override-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .override-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .override-btn.selected {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Wizard Steps */
        .wizard-steps {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .wizard-step {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .step-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Tools Grid */
        .wizard-tools-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .wizard-tool {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
        }

        .wizard-tool span {
            font-size: 0.9rem;
        }

        /* Wizard Footer */
        .wizard-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
        }

        .wizard-actions {
            display: flex;
            gap: 10px;
        }

        /* ==================== WIZARD MODE TOGGLE ==================== */
        .wizard-mode-toggle {
            display: flex;
            gap: 0;
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .mode-btn {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .mode-btn:hover {
            color: var(--text-primary);
        }

        .mode-btn.active {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .mode-btn-icon {
            font-size: 1.1rem;
        }

        .mode-hint {
            position: absolute;
            top: -4px;
            right: -4px;
            font-size: 0.8rem;
            animation: hintPulse 1.5s ease-in-out infinite;
        }

        @keyframes hintPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .mode-btn {
            position: relative;
        }

        /* Orchestrator Configuration Section */
        .orchestrator-config {
            display: none;
            animation: fadeSlideIn 0.3s ease-out;
        }

        .orchestrator-config.active {
            display: block;
        }

        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Workflow Type Selection */
        .workflow-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 500px) {
            .workflow-type-grid {
                grid-template-columns: 1fr;
            }
        }

        .workflow-type-card {
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .workflow-type-card:hover {
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateY(-2px);
        }

        .workflow-type-card.selected {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .workflow-type-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .workflow-type-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .workflow-type-desc {
            font-size: 0.7rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Team Composition */
        .team-composition {
            margin-bottom: 20px;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        @media (max-width: 500px) {
            .team-grid {
                grid-template-columns: 1fr;
            }
        }

        .team-member-card {
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .team-member-card:hover {
            border-color: rgba(139, 92, 246, 0.5);
        }

        .team-member-card.selected {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .team-member-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: transparent;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .team-member-card.selected .team-member-checkbox {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .team-member-icon {
            font-size: 1.3rem;
        }

        .team-member-info {
            flex: 1;
            min-width: 0;
        }

        .team-member-name {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .team-member-role {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* Workflow Preview */
        .workflow-preview {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            margin-top: 16px;
        }

        .workflow-preview-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 16px;
            letter-spacing: 0.5px;
        }

        .workflow-diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .workflow-mother {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border-radius: 16px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }

        .mother-icon {
            font-size: 1.8rem;
        }

        .mother-info {
            text-align: left;
        }

        .mother-name {
            font-weight: 700;
            font-size: 1rem;
        }

        .mother-role {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .workflow-connector {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .connector-line {
            width: 2px;
            height: 20px;
            background: var(--accent);
            opacity: 0.5;
        }

        .connector-arrows {
            display: flex;
            gap: 20px;
        }

        .connector-arrow {
            color: var(--accent);
            font-size: 1.2rem;
            opacity: 0.7;
        }

        .workflow-children {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .workflow-child {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .workflow-child.parallel {
            animation: childPulse 2s ease-in-out infinite;
        }

        .workflow-child.sequential {
            opacity: 0.6;
        }

        .workflow-child.sequential.active {
            opacity: 1;
            border-color: var(--accent);
        }

        @keyframes childPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
            50% { box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
        }

        .child-icon {
            font-size: 1.2rem;
        }

        .child-name {
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Single agent section toggle */
        .single-agent-config {
            display: block;
        }

        .single-agent-config.hidden {
            display: none;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-glow {
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        }

        .btn-glow:hover {
            box-shadow: 0 6px 30px rgba(139, 92, 246, 0.6);
        }

        /* Quick Actions Grid */
        .quick-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .quick-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .quick-card:active {
            transform: scale(0.97);
            background: var(--bg-hover);
        }

        .quick-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .quick-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* ==================== MEMORY SEARCH ==================== */
        .search-box {
            display: flex;
            gap: 8px;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 8px 12px;
            border: 1px solid var(--border);
        }

        .search-box input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 0.95rem;
            outline: none;
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .search-btn {
            background: var(--accent);
            border: none;
            border-radius: 8px;
            padding: 8px 14px;
            cursor: pointer;
            font-size: 1rem;
        }

        .search-results {
            margin-top: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .search-result-item {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: var(--bg-hover);
        }

        .search-result-type {
            font-size: 0.7rem;
            color: var(--accent);
            text-transform: uppercase;
            font-weight: 600;
        }

        .search-result-title {
            font-weight: 500;
            margin: 4px 0;
            color: var(--text-primary);
        }

        .search-result-snippet {
            font-size: 0.8rem;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ==================== SYSTEM STATUS ==================== */
        .status-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 8px 14px;
            border: 1px solid var(--border);
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.online {
            background: var(--green);
            box-shadow: 0 0 8px var(--green);
        }

        .status-dot.offline {
            background: var(--red);
        }

        .status-dot.unknown {
            background: var(--yellow);
        }

        .status-name {
            color: var(--text-secondary);
        }

        /* ==================== RECENT AGENTS ==================== */
        .recent-agents-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recent-agent-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px 16px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recent-agent-item:hover {
            background: var(--bg-hover);
            transform: translateY(-1px);
        }

        .recent-agent-info {
            flex: 1;
            min-width: 0;
        }

        .recent-agent-task {
            font-size: 0.9rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-agent-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .recent-agent-status {
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .recent-agent-status.completed {
            background: rgba(34, 197, 94, 0.15);
            color: var(--green);
        }

        /* ==================== QUICK COMMAND MODAL ==================== */
        .command-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .command-modal.active {
            display: flex;
        }

        .command-box {
            background: var(--bg-elevated);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border);
        }

        .command-input {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'SF Mono', Monaco, monospace;
            outline: none;
        }

        .command-input:focus {
            border-color: var(--accent);
        }

        .command-suggestions {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .command-suggestion {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .command-suggestion:hover {
            background: var(--accent);
            color: white;
        }

        /* ==================== CHAT VIEW ==================== */
        .chat-view {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-top: 16px;
            padding-bottom: 180px; /* Space for input area (~95px) + nav (70px) + breathing room */
            display: flex;
            flex-direction: column;
            gap: 12px;
            -webkit-overflow-scrolling: touch;
        }

        /* Mobile improvements for chat */
        @media (max-width: 480px) {
            .messages-container {
                padding: 12px;
                padding-top: 12px;
                padding-bottom: 190px;
            }

            .message {
                max-width: 92%;
                padding: 12px 14px;
                font-size: 0.9rem;
            }

            .message.assistant {
                padding: 0;
            }

            .assistant-card-body {
                padding: 10px 14px;
            }

            .assistant-card-header {
                padding: 6px 14px;
            }

            .quick-action-pills {
                padding: 6px 12px 2px;
                gap: 6px;
            }
            .quick-action-pill {
                padding: 4px 10px;
                font-size: 0.7rem;
            }

            .chat-input-wrapper {
                padding: 6px 8px;
            }

            .input-model-btn {
                padding: 5px 8px;
                font-size: 0.68rem;
            }

            .chat-header {
                padding: 10px 12px;
            }

            .chat-header-title {
                font-size: 0.95rem;
            }
        }

        /* === PREMIUM MESSAGE BUBBLES === */
        .message {
            max-width: 85%;
            padding: 16px 20px;
            border-radius: 22px;
            font-size: 0.95rem;
            line-height: 1.6;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            /* Animation handled by GSAP when available */
            animation: messageIn 0.3s ease;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: rgba(139, 92, 246, 0.18);
            color: var(--text-primary);
            align-self: flex-end;
            border-bottom-right-radius: 6px;
            border: 1px solid rgba(139, 92, 246, 0.25);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        }
        .user-msg-timestamp {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 6px;
            opacity: 0.6;
            text-align: right;
        }

        .message.assistant {
            background: rgba(12, 12, 20, 0.8);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(139, 92, 246, 0.15);
            color: var(--text-primary);
            align-self: flex-start;
            border-radius: 14px;
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3), 0 0 20px rgba(139, 92, 246, 0.05);
            padding: 0;
            overflow: hidden;
        }

        .message.assistant::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(139, 92, 246, 0.25),
                transparent
            );
        }

        /* ==================== CONTEXT SYSTEM BUBBLE ==================== */
        .message.context-system {
            background: rgba(12, 12, 25, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(99, 102, 241, 0.35);
            border-left: 3px solid rgba(99, 102, 241, 0.7);
            color: var(--text-primary);
            align-self: stretch;
            border-radius: 14px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3), 0 0 20px rgba(99, 102, 241, 0.08);
            padding: 0;
            overflow: hidden;
            animation: contextBubbleIn 0.45s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            margin-bottom: 8px;
        }
        @keyframes contextBubbleIn {
            from { opacity: 0; transform: translateY(12px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .message.context-system.dismissing {
            animation: contextBubbleOut 0.3s ease forwards;
            pointer-events: none;
        }
        @keyframes contextBubbleOut {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(-8px) scale(0.96); }
        }
        .context-system-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.15);
            background: rgba(99, 102, 241, 0.06);
        }
        .context-system-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.78rem;
            font-weight: 600;
            color: rgba(129, 140, 248, 0.9);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .context-system-label svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
            opacity: 0.8;
        }
        .context-system-dismiss {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 2px 6px;
            border-radius: 6px;
            transition: all 0.2s ease;
            line-height: 1;
        }
        .context-system-dismiss:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }
        .context-system-body {
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .context-project-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .context-project-name .ctx-icon {
            font-size: 1.1rem;
        }
        .context-field {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .context-field-label {
            font-size: 0.68rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }
        .context-field-value {
            font-size: 0.82rem;
            color: var(--text-secondary);
            line-height: 1.45;
        }
        .context-field.next-action {
            padding: 8px 10px;
            background: rgba(99, 102, 241, 0.06);
            border-radius: 8px;
            border-left: 2px solid rgba(99, 102, 241, 0.4);
        }
        .context-field.next-action .context-field-value {
            color: var(--text-primary);
            font-weight: 500;
        }
        .context-files-row {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .context-file-pill {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 6px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            color: rgba(165, 180, 252, 0.9);
            white-space: nowrap;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* === ASSISTANT CARD STRUCTURE === */
        .assistant-card-header {
            padding: 8px 16px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .assistant-card-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        .assistant-card-timestamp {
            font-size: 0.7rem;
            color: var(--text-muted);
            opacity: 0.7;
        }
        .assistant-card-model {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-left: auto;
            opacity: 0.8;
        }
        .assistant-card-model .model-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .assistant-card-body {
            padding: 14px 18px;
        }
        .assistant-card-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 16px 10px;
        }
        .assistant-card-actions .chat-speak-btn {
            margin-top: 0;
        }

        .message.assistant pre {
            background: var(--bg-elevated);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.8rem;
            margin: 10px 0;
            border: 1px solid var(--border);
            max-width: 100%;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.assistant code {
            font-family: 'SF Mono', Monaco, 'Fira Code', monospace;
        }

        /* === MARKDOWN RENDERING IN ASSISTANT MESSAGES === */
        .message.assistant .message-content-wrapper h1,
        .message.assistant .message-content-wrapper h2,
        .message.assistant .message-content-wrapper h3 {
            margin: 16px 0 8px 0;
            line-height: 1.3;
            font-weight: 600;
        }
        .message.assistant .message-content-wrapper h1 { font-size: 1.25rem; color: var(--text-primary); }
        .message.assistant .message-content-wrapper h2 { font-size: 1.1rem; color: var(--accent-light); }
        .message.assistant .message-content-wrapper h3 { font-size: 0.95rem; color: var(--text-secondary); }
        .message.assistant .message-content-wrapper h1:first-child,
        .message.assistant .message-content-wrapper h2:first-child,
        .message.assistant .message-content-wrapper h3:first-child { margin-top: 0; }

        .message.assistant .message-content-wrapper p {
            margin: 8px 0;
        }
        .message.assistant .message-content-wrapper p:first-child { margin-top: 0; }
        .message.assistant .message-content-wrapper p:last-child { margin-bottom: 0; }

        .message.assistant .message-content-wrapper ul,
        .message.assistant .message-content-wrapper ol {
            margin: 8px 0;
            padding-left: 24px;
        }
        .message.assistant .message-content-wrapper li {
            margin: 4px 0;
        }
        .message.assistant .message-content-wrapper li > p {
            margin: 2px 0;
        }

        .message.assistant .message-content-wrapper blockquote {
            margin: 10px 0;
            padding: 8px 14px;
            border-left: 3px solid var(--accent);
            background: rgba(139, 92, 246, 0.08);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
        }

        .message.assistant .message-content-wrapper table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.85rem;
        }
        .message.assistant .message-content-wrapper th {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-light);
            padding: 8px 12px;
            text-align: left;
            border-bottom: 2px solid var(--border);
        }
        .message.assistant .message-content-wrapper td {
            padding: 6px 12px;
            border-bottom: 1px solid var(--border);
        }
        .message.assistant .message-content-wrapper tr:hover td {
            background: rgba(139, 92, 246, 0.05);
        }

        .message.assistant .message-content-wrapper code:not(pre code) {
            background: rgba(139, 92, 246, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .message.assistant .message-content-wrapper hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 12px 0;
        }

        .message.assistant .message-content-wrapper a {
            color: var(--accent-light);
            text-decoration: none;
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
            transition: border-color 0.2s ease;
        }
        .message.assistant .message-content-wrapper a:hover {
            border-bottom-color: var(--accent-light);
        }

        /* Tool/system messages */
        .message.tool {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            padding: 10px 18px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            align-self: center;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: opacity 0.3s ease;
        }

        .message.tool.done {
            opacity: 0.5;
        }

        .message.tool.done .tool-spinner {
            display: none;
        }

        .message.tool.done::before {
            content: '';
            color: var(--green);
            margin-right: 4px;
        }

        .tool-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* === TOOL TRACKER (Inline Collapsible) === */
        .tool-tracker {
            border-bottom: 1px solid rgba(139, 92, 246, 0.08);
        }
        .tool-tracker-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            cursor: pointer;
            transition: background 0.15s ease;
            user-select: none;
        }
        .tool-tracker-bar:hover {
            background: rgba(139, 92, 246, 0.06);
        }
        .tool-tracker-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            flex-shrink: 0;
        }
        .tool-tracker-spinner.done {
            display: none;
        }
        .tool-tracker-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .tool-tracker-current {
            font-size: 0.72rem;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }
        .tool-tracker-chevron {
            width: 14px;
            height: 14px;
            color: var(--text-muted);
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }
        .tool-tracker-bar.expanded .tool-tracker-chevron {
            transform: rotate(180deg);
        }
        .tool-tracker-list {
            display: none;
            padding: 0 16px 8px;
        }
        .tool-tracker-bar.expanded + .tool-tracker-list {
            display: block;
        }
        .tool-tracker-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 3px 0;
            font-size: 0.72rem;
            color: var(--text-muted);
        }
        .tool-tracker-item .tt-icon {
            width: 14px;
            text-align: center;
            flex-shrink: 0;
        }
        .tool-tracker-item .tt-icon.running {
            color: var(--accent-light);
        }
        .tool-tracker-item .tt-icon.done {
            color: var(--green);
        }
        .tool-tracker-item .tt-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .tool-tracker-done-check {
            color: var(--green);
            font-size: 0.75rem;
            margin-left: 4px;
        }

        /* === THINKING ORB === */
        .thinking-orb-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 4px 0;
        }
        .thinking-orb-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #a78bfa, #7c3aed 50%, #4c1d95);
            animation: orbPulse 1.5s ease-in-out infinite;
            flex-shrink: 0;
        }
        .thinking-orb-label {
            font-size: 0.82rem;
            color: var(--text-muted);
            font-style: italic;
        }
        @keyframes orbPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 8px rgba(167, 139, 250, 0.4);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 0 20px rgba(167, 139, 250, 0.7), 0 0 40px rgba(124, 58, 237, 0.3);
            }
        }

        /* === AI THINKING ANIMATION (Orbital Dots) === */
        .thinking-indicator {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            align-items: center;
        }

        .thinking-orb {
            width: 40px;
            height: 40px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .thinking-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--accent-gradient);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--glow-medium);
        }

        .thinking-dot:nth-child(1) {
            animation: orbit 1.5s linear infinite;
        }

        .thinking-dot:nth-child(2) {
            animation: orbit 1.5s linear infinite;
            animation-delay: -0.5s;
        }

        .thinking-dot:nth-child(3) {
            animation: orbit 1.5s linear infinite;
            animation-delay: -1s;
        }

        @keyframes orbit {
            0% {
                transform: rotate(0deg) translateX(16px) rotate(0deg);
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                transform: rotate(360deg) translateX(16px) rotate(-360deg);
                opacity: 1;
            }
        }

        .thinking-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-left: 8px;
        }

        /* Chat Header - Sticky at top */
        .chat-header {
            position: fixed;
            top: 56px; /* Below main header */
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            z-index: 400;
        }

        /* Scroll to bottom button */
        .scroll-bottom-btn {
            position: fixed;
            bottom: 180px;
            right: 24px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border: 3px solid rgba(255,255,255,0.4);
            color: white;
            font-size: 1.6rem;
            font-weight: bold;
            cursor: pointer;
            display: none; /* Hidden by default, shown via JS in chat view */
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 24px rgba(139, 92, 246, 0.6);
            z-index: 9999;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .scroll-bottom-btn.at-bottom {
            opacity: 0.3;
            transform: scale(0.9);
        }

        .scroll-bottom-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 28px rgba(139, 92, 246, 0.7);
        }

        .scroll-bottom-btn:active {
            transform: scale(0.95);
        }

        body.keyboard-open .scroll-bottom-btn {
            bottom: 100px;
        }

        /* Floating Chat Actions Menu */
        .chat-fab-container {
            position: fixed;
            top: 70px;
            right: 16px;
            z-index: 500;
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
            transition: opacity 0.25s ease 0.1s, transform 0.25s ease 0.1s;
        }
        .chat-fab-container.visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .chat-fab-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .chat-fab-btn:hover {
            background: var(--bg-hover);
            color: var(--accent);
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .chat-fab-btn.open {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .chat-fab-menu {
            position: absolute;
            top: 52px;
            right: 0;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px) scale(0.95);
            transition: all 0.2s ease;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            min-width: 180px;
        }

        .chat-fab-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .chat-fab-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }

        .chat-fab-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .chat-fab-item svg {
            flex-shrink: 0;
        }

        .chat-fab-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
        }

        .chat-header-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 1rem;
        }

        .chat-header-icon {
            font-size: 1.2rem;
        }

        .chat-header-actions {
            display: flex;
            gap: 8px;
        }

        .chat-action-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .chat-action-btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-light);
        }

        .chat-action-btn:active {
            transform: scale(0.95);
        }

        /* === MODEL SELECTOR === */
        .model-selector-bar {
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            display: flex !important;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            z-index: 400;
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .model-selector-bar.visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .model-selector-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .model-selector-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .model-selector-btn:hover {
            background: var(--bg-hover);
            border-color: var(--glass-border-hover);
            box-shadow: 0 0 16px var(--glow-subtle);
        }

        .model-selector-btn .model-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .model-selector-btn .model-dot.opus { background: #a78bfa; box-shadow: 0 0 6px rgba(167, 139, 250, 0.5); }
        .model-selector-btn .model-dot.sonnet { background: #6366f1; box-shadow: 0 0 6px rgba(99, 102, 241, 0.5); }
        .model-selector-btn .model-dot.haiku { background: #22d3ee; box-shadow: 0 0 6px rgba(34, 211, 238, 0.5); }

        .model-selector-btn .chevron-icon {
            transition: transform 0.2s ease;
            opacity: 0.5;
        }

        .model-selector-btn.open .chevron-icon {
            transform: rotate(180deg);
        }

        .model-dropdown {
            position: absolute;
            top: calc(100% + 6px);
            left: 50%;
            transform: translateX(-50%) scale(0.95);
            min-width: 260px;
            background: var(--bg-elevated);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 6px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s var(--ease-out-expo);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 24px var(--glow-subtle);
            z-index: 500;
        }

        .model-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) scale(1);
        }

        .model-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-family: inherit;
            color: var(--text-secondary);
        }

        .model-option:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .model-option.selected {
            background: rgba(139, 92, 246, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }

        .model-option .model-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .model-option .model-info {
            flex: 1;
            min-width: 0;
        }

        .model-option .model-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: inherit;
        }

        .model-option .model-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .model-option .model-check {
            opacity: 0;
            color: var(--accent);
            flex-shrink: 0;
        }

        .model-option.selected .model-check {
            opacity: 1;
        }

        @media (max-width: 600px) {
            .model-dropdown {
                min-width: 220px;
            }
            .model-selector-btn {
                font-size: 0.8rem;
                padding: 5px 10px;
            }
        }

        /* === ENHANCED CHAT INPUT === */
        .chat-input-area {
            position: fixed;
            bottom: calc(var(--nav-height) + var(--safe-bottom));
            left: 0;
            right: 0;
            width: 100%;
            z-index: 500;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            transition: all 0.2s var(--ease-out-expo);
        }

        /* When keyboard is open on mobile */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .chat-input-area {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Quick action pills row */
        .quick-action-pills {
            display: flex;
            gap: 8px;
            padding: 8px 16px 4px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .quick-action-pills::-webkit-scrollbar { display: none; }
        .quick-action-pill {
            flex-shrink: 0;
            padding: 5px 14px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }
        .quick-action-pill:hover {
            border-color: var(--accent);
            color: var(--accent-light);
            background: rgba(139, 92, 246, 0.1);
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            transition: all 0.3s var(--ease-out-expo);
        }

        .chat-input-wrapper:focus-within {
            background: rgba(139, 92, 246, 0.03);
        }

        /* Inline model selector in input bar */
        .input-model-selector {
            position: relative;
            flex-shrink: 0;
        }
        .input-model-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.72rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }
        .input-model-btn:hover {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.08);
        }
        .input-model-btn .model-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .input-model-btn .chevron-icon {
            width: 10px;
            height: 10px;
            transition: transform 0.2s ease;
        }
        .input-model-btn.open .chevron-icon {
            transform: rotate(180deg);
        }
        .input-model-dropdown {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 0;
            min-width: 240px;
            background: var(--bg-elevated);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 6px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(4px);
            transition: all 0.2s var(--ease-out-expo);
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.5), 0 0 24px var(--glow-subtle);
            z-index: 600;
        }
        .input-model-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .attach-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }
        .attach-btn:hover {
            color: var(--accent-light);
            background: rgba(139, 92, 246, 0.1);
        }

        .chat-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            padding: 12px 16px;
            outline: none;
            resize: none;
            min-height: 48px;
            max-height: 120px;
            font-family: inherit;
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .voice-btn, .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s var(--ease-out-expo);
            flex-shrink: 0;
        }

        .voice-btn {
            background: var(--glass-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .voice-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .voice-btn:active, .voice-btn.recording {
            background: var(--red);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

        .browser-toggle-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s var(--ease-out-expo);
            flex-shrink: 0;
            background: var(--glass-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            position: relative;
        }
        .browser-toggle-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .browser-toggle-btn.browser-active {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent);
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow: 0 0 12px var(--glow-subtle);
        }
        .chat-browser-dot {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: transparent;
        }
        .chat-browser-dot.running {
            background: var(--accent);
            box-shadow: 0 0 6px var(--glow-medium);
        }
        .chat-browser-dot.paused {
            background: #eab308;
        }

        .send-btn {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 4px 15px var(--glow-medium);
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.08);
            box-shadow: 0 6px 25px var(--glow-strong);
        }

        .send-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            background: var(--bg-card);
            color: var(--text-muted);
            box-shadow: none;
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* ==================== QUICK ACTIONS VIEW ==================== */
        .quick-view {
            padding: 20px;
            gap: 24px;
            overflow-y: auto;
            min-height: min-content;
        }

        .action-section {
            margin-bottom: 24px;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .action-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .action-btn:active {
            transform: scale(0.95);
            background: var(--accent-glow);
            border-color: var(--accent);
        }

        .action-btn-icon {
            font-size: 1.6rem;
            margin-bottom: 6px;
        }

        .action-btn-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .action-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .action-wide {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .action-wide:active {
            transform: scale(0.98);
            background: var(--accent-glow);
            border-color: var(--accent);
        }

        .action-wide-icon {
            font-size: 1.4rem;
        }

        .action-wide-label {
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }

        .action-wide {
            min-width: 0; /* Allow flex children to shrink */
        }

        /* ==================== SETTINGS VIEW ==================== */

        /* Voice Settings */
        .voice-settings-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .voice-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 4px;
        }
        .voice-option:hover {
            background: rgba(139, 92, 246, 0.1);
        }
        .voice-option.selected {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        .voice-option-radio {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .voice-option.selected .voice-option-radio {
            border-color: var(--accent);
        }
        .voice-option.selected .voice-option-radio::after {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent);
        }
        .voice-option-info {
            flex: 1;
        }
        .voice-option-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        .voice-option-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .voice-preview-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.05);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .voice-preview-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--accent);
            color: var(--accent);
        }
        .voice-preview-btn.playing {
            background: rgba(139, 92, 246, 0.3);
            border-color: var(--accent);
            color: var(--accent);
            animation: speak-pulse 1.5s ease-in-out infinite;
        }
        .speed-slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }
        .speed-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            border-radius: 2px;
            background: rgba(255,255,255,0.1);
            outline: none;
        }
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }
        .speed-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent);
            min-width: 40px;
            text-align: center;
        }
        .autospeak-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: var(--accent);
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
        .settings-view {
            padding: 20px;
            gap: 20px;
            overflow-y: auto;
            min-height: min-content;
        }

        .settings-card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .settings-value {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-align: right;
            max-width: 55%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 1;
            min-width: 0;
        }

        .settings-label {
            flex-shrink: 0;
        }

        .settings-row {
            min-width: 0; /* Allow text truncation */
        }

        .settings-value.success {
            color: var(--green);
        }

        .settings-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            color: var(--text-primary);
            padding: 6px 10px;
            font-size: 0.85rem;
            max-width: 200px;
            cursor: pointer;
        }
        .settings-select:focus {
            outline: none;
            border-color: var(--purple);
        }
        .settings-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.97);
        }

        /* === PREMIUM BUTTONS === */
        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s var(--ease-out-expo);
            box-shadow:
                0 4px 15px var(--glow-medium),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: var(--accent-gradient);
            filter: blur(15px);
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow:
                0 8px 30px var(--glow-strong),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .btn-primary:hover::before {
            opacity: 0.6;
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-secondary {
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            padding: 12px 28px;
            border-radius: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s var(--ease-out-expo);
        }

        .btn-secondary:hover {
            border-color: var(--glass-border-hover);
            background: var(--glass-bg-light);
            box-shadow: 0 0 20px var(--glow-subtle);
        }
        .btn-secondary:active,
        .chat-fab-item:active,
        .slide-panel-close:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }

        .btn-danger {
            background: var(--bg-elevated);
            color: var(--red);
            border: 1px solid var(--border);
            transition: all 0.3s var(--ease-out-expo);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.4);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
        }

        .btn-block {
            width: 100%;
        }

        /* Icon button (circular) */
        .btn-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--glass-bg);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
        }

        .btn-icon:hover {
            background: var(--bg-hover);
            border-color: var(--glass-border);
            color: var(--accent-light);
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--glow-subtle);
        }

        /* ==================== LOGIN VIEW ==================== */
        .login-view {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            height: 100dvh;
            padding: 20px;
            background: var(--bg-primary);
        }

        .login-card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 40px 32px;
            width: 100%;
            max-width: 380px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: var(--accent-gradient);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 700;
            margin: 0 auto 24px;
            box-shadow: 0 8px 30px var(--accent-glow-strong);
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 0.95rem;
        }

        .login-input {
            width: 100%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px 20px;
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 16px;
            transition: all 0.2s;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent-gradient);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .login-btn:active {
            transform: scale(0.98);
        }

        .login-error {
            color: var(--red);
            font-size: 0.85rem;
            margin-top: 12px;
            display: none;
        }

        /* ==================== UTILITIES ==================== */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .hidden {
            display: none !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 4px;
        }

        /* Voice Recording Overlay */
        .voice-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .voice-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .voice-indicator {
            width: 100px;
            height: 100px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin-bottom: 24px;
            animation: voicePulse 1.5s ease infinite;
        }

        @keyframes voicePulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 var(--accent-glow-strong); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 20px transparent; }
        }

        .voice-text {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .voice-transcript {
            font-size: 1rem;
            color: var(--text-primary);
            max-width: 80%;
            text-align: center;
            min-height: 24px;
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 380px) {
            .action-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .hero-stats {
                flex-direction: column;
            }
        }

        /* ==================== GOALS VIEW ==================== */
        .goals-view {
            padding: 20px;
            gap: 16px;
            overflow-y: auto;
        }

        .goals-view .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .goals-view .view-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Goals Grid - Kanban Style */
        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .goals-column {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--glass-border);
            min-height: 200px;
        }

        .goals-column h3 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .goals-column.blocked h3 {
            color: var(--yellow);
        }

        .goals-column.completed h3 {
            color: var(--green);
        }

        /* Goal Card */
        .goal-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .goal-card:hover {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent), var(--shadow-md);
            transform: translateY(-2px);
        }

        .goal-card.active {
            border-left: 3px solid var(--accent);
        }

        .goal-card.blocked {
            border-left: 3px solid var(--yellow);
        }

        .goal-card.completed {
            border-left: 3px solid var(--green);
            opacity: 0.8;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .goal-priority {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .goal-priority.high {
            background: rgba(239, 68, 68, 0.2);
            color: var(--red);
        }

        .goal-priority.medium {
            background: rgba(234, 179, 8, 0.2);
            color: var(--yellow);
        }

        .goal-priority.low {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
        }

        .goal-progress {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .goal-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .goal-subtasks {
            margin: 10px 0;
        }

        .subtask {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 4px 0;
        }

        .subtask.done {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .subtask-check {
            font-size: 0.9rem;
        }

        .goal-blockers {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .blocker-tag {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 8px;
            background: rgba(234, 179, 8, 0.15);
            color: var(--yellow);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .goal-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .goal-actions button {
            flex: 1;
            padding: 6px 12px;
            font-size: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .goal-actions button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Goal Creation Modal */
        .goal-form-group {
            margin-bottom: 16px;
        }

        .goal-form-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .goal-form-input {
            width: 100%;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .goal-form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        /* Empty state for goals */
        .goals-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .goals-empty-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* ==================== CEREBRO CONSCIOUSNESS INTERFACE ==================== */
        /* An ethereal window into a living mind */

        /* Orbitron - Variable font (all weights use same file) */
        @font-face {
            font-family: 'Orbitron';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url('static/fonts/orbitron-variable.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Orbitron';
            font-style: normal;
            font-weight: 500;
            font-display: swap;
            src: url('static/fonts/orbitron-variable.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Orbitron';
            font-style: normal;
            font-weight: 600;
            font-display: swap;
            src: url('static/fonts/orbitron-variable.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Orbitron';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url('static/fonts/orbitron-variable.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Orbitron';
            font-style: normal;
            font-weight: 900;
            font-display: swap;
            src: url('static/fonts/orbitron-variable.woff2') format('woff2');
        }
        /* Rajdhani */
        @font-face {
            font-family: 'Rajdhani';
            font-style: normal;
            font-weight: 300;
            font-display: swap;
            src: url('static/fonts/rajdhani-300.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Rajdhani';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url('static/fonts/rajdhani-400.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Rajdhani';
            font-style: normal;
            font-weight: 500;
            font-display: swap;
            src: url('static/fonts/rajdhani-500.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Rajdhani';
            font-style: normal;
            font-weight: 600;
            font-display: swap;
            src: url('static/fonts/rajdhani-600.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Rajdhani';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url('static/fonts/rajdhani-700.woff2') format('woff2');
        }
        /* Space Mono */
        @font-face {
            font-family: 'Space Mono';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url('static/fonts/spacemono-400.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Space Mono';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url('static/fonts/spacemono-700.woff2') format('woff2');
        }

        .autonomy-view {
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 0 !important;
            height: calc(100vh - 56px - var(--nav-height, 70px) - var(--safe-bottom, 0px));
            height: calc(100dvh - 56px - var(--nav-height, 70px) - var(--safe-bottom, 0px));
            max-height: calc(100vh - 56px - var(--nav-height, 70px) - var(--safe-bottom, 0px));
            max-height: calc(100dvh - 56px - var(--nav-height, 70px) - var(--safe-bottom, 0px));
            background: radial-gradient(ellipse 120% 100% at 50% -20%, rgba(88, 28, 135, 0.18) 0%, transparent 50%),
                        radial-gradient(ellipse 80% 60% at 80% 100%, rgba(30, 58, 138, 0.12) 0%, transparent 40%);
            position: relative;
            overflow: hidden;
        }

        /* Kill ALL scroll when Mind page is active  targets every ancestor */
        html:has(.autonomy-view.active),
        html:has(.autonomy-view.active) body,
        html:has(.autonomy-view.active) #app,
        html:has(.autonomy-view.active) #main-app,
        .main-content:has(.autonomy-view.active) {
            overflow: hidden !important;
        }
        .main-content:has(.autonomy-view.active) {
            padding-bottom: 0 !important;
            height: 100dvh !important;
            max-height: 100dvh !important;
        }

        /* Subtle noise texture overlay */
        .autonomy-view > * {
            position: relative;
            z-index: 1;
        }

        /* Cosmic dust particles floating */
        .autonomy-view::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,0.3) 0%, transparent 100%),
                radial-gradient(1px 1px at 40% 70%, rgba(255,255,255,0.2) 0%, transparent 100%),
                radial-gradient(1px 1px at 80% 40%, rgba(255,255,255,0.25) 0%, transparent 100%),
                radial-gradient(2px 2px at 60% 80%, rgba(139,92,246,0.3) 0%, transparent 100%),
                radial-gradient(1px 1px at 10% 90%, rgba(255,255,255,0.15) 0%, transparent 100%),
                radial-gradient(1px 1px at 90% 10%, rgba(255,255,255,0.2) 0%, transparent 100%);
            background-size: 550px 550px;
            animation: cosmicDrift 120s linear infinite;
            pointer-events: none;
            z-index: 0;
            opacity: 0.6;
        }

        @keyframes cosmicDrift {
            0% { background-position: 0 0, 100px 100px, 200px 50px, 50px 200px, 300px 150px, 150px 300px; }
            100% { background-position: 550px 550px, 650px 650px, 750px 600px, 600px 750px, 850px 700px, 700px 850px; }
        }

        /* Vertical scan line effect */
        .autonomy-view::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(139, 92, 246, 0.02) 50%, transparent 100%);
            animation: scanLine 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes scanLine {
            0%, 100% { transform: translateX(-100%); opacity: 0; }
            50% { transform: translateX(100%); opacity: 1; }
        }

        /* ===== COMPACT STATUS BAR (Top of Mind view) ===== */
        .mind-status-bar {
            display: flex;
            gap: 10px;
            padding: 16px 20px 8px;
            width: 100%;
            max-width: 1400px;
            z-index: 2;
            flex-wrap: wrap;
            justify-content: center;
            flex-shrink: 0;
        }

        @media (min-width: 1024px) {
            .mind-status-bar {
                padding: 10px 20px 6px;
            }
            .status-card {
                padding: 8px 14px;
            }
        }

        .status-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            background: rgba(12, 12, 20, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            flex: 1;
            min-width: 120px;
            max-width: 200px;
            transition: all 0.3s ease;
            cursor: default;
        }

        .status-card:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(16, 16, 28, 0.9);
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .status-card-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            box-shadow: 0 0 8px currentColor;
        }

        .status-card-dot.phase-observe { background: #3b82f6; color: #3b82f6; }
        .status-card-dot.phase-orient { background: #8b5cf6; color: #8b5cf6; }
        .status-card-dot.phase-decide { background: #f59e0b; color: #f59e0b; }
        .status-card-dot.phase-act { background: #f97316; color: #f97316; }
        .status-card-dot.phase-reflect { background: #10b981; color: #10b981; }
        .status-card-dot.phase-idle { background: #6b7280; color: #6b7280; }
        .status-card-dot.phase-dormant { background: #4b5563; color: #4b5563; }

        .status-card-info {
            display: flex;
            flex-direction: column;
            gap: 1px;
            min-width: 0;
        }

        .status-card-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }

        .status-card-value {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ===== INTEGRATED STATUS STRIP (Below orb) ===== */
        .mind-status-strip {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 20px;
            width: 100%;
            max-width: 700px;
            z-index: 2;
            justify-content: center;
            flex-wrap: wrap;
            box-sizing: border-box;
        }

        @media (min-width: 1024px) {
            .mind-status-strip {
                max-width: 420px;
            }
        }

        .strip-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(12, 12, 20, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            max-width: 280px;
        }

        .strip-item:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(16, 16, 28, 0.8);
        }

        .strip-item-icon {
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .strip-item-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .strip-badge {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 8px;
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent-light);
            flex-shrink: 0;
        }

        .strip-badge.green { background: rgba(34, 197, 94, 0.2); color: #4ade80; }

        /* ===== 2-COLUMN LAYOUT ===== */
        .mind-columns {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: min(96vw, 1800px);
            padding: 0 20px;
            gap: 24px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
            z-index: 2;
        }

        @media (min-width: 1024px) {
            .mind-columns {
                flex-direction: row;
                align-items: stretch;
                padding-bottom: 10px;
                gap: 20px;
            }
            .mind-col-chat {
                flex: 1;
                min-width: 0;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            .mind-col-orb {
                width: clamp(340px, 25vw, 440px);
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                overflow: hidden;
            }
        }

        @media (max-width: 1023px) {
            .mind-col-orb { order: -1; flex-shrink: 0; }
            .mind-col-chat { order: 1; flex: 1; min-height: 0; overflow: hidden; }
        }

        /* ===== CENTERED CHAT SECTION ===== */
        .mind-chat-section {
            width: 100%;
            padding: 0 0 20px;
            z-index: 2;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        @media (max-width: 1023px) {
            .mind-chat-section {
                max-width: 700px;
                margin: 0 auto;
            }
        }

        .mind-chat-container {
            position: relative;
            background: rgba(10, 10, 16, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1;
            min-height: 0;
        }

        /* Mind chat tab bar (Chat | Stored) */
        .mind-chat-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            padding: 0 16px;
            background: rgba(255,255,255,0.02);
            flex-shrink: 0;
        }
        .mind-chat-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.4);
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .mind-chat-tab.active {
            color: #8b5cf6;
            border-bottom-color: #8b5cf6;
        }
        .mind-chat-tab:hover:not(.active) {
            color: rgba(255,255,255,0.6);
        }
        .stored-badge {
            background: #8b5cf6;
            color: white;
            font-size: 0.65rem;
            padding: 1px 6px;
            border-radius: 10px;
            margin-left: 6px;
            vertical-align: middle;
        }
        .answers-badge {
            background: #f59e0b;
            color: #1a1a2e;
            font-size: 0.65rem;
            padding: 1px 6px;
            border-radius: 10px;
            margin-left: 6px;
            vertical-align: middle;
            font-weight: 600;
        }

        .wallet-badge {
            background: #22c55e;
            color: #0a0a1a;
            font-weight: 700;
        }

        /* Wallet tab pane */
        .mind-wallet-items {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .mind-wallet-items.hidden { display: none; }

        .wallet-pnl-header {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(12px);
        }
        .wallet-pnl-label {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.35);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }
        .wallet-pnl-amount {
            font-size: 1.8rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        .wallet-pnl-amount.positive { color: #22c55e; }
        .wallet-pnl-amount.negative { color: #ef4444; }
        .wallet-pnl-amount.zero { color: rgba(255,255,255,0.5); }
        .wallet-pnl-unrealized {
            font-size: 0.72rem;
            color: rgba(255,255,255,0.35);
            margin-top: 4px;
        }
        .wallet-period-bar {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-top: 12px;
        }
        .wallet-period-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.45);
            padding: 4px 14px;
            border-radius: 8px;
            font-size: 0.72rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        .wallet-period-btn.active {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.4);
            color: #c4b5fd;
        }
        .wallet-columns {
            display: flex;
            gap: 0;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        .wallet-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow-y: auto;
            padding: 0 4px;
        }
        .wallet-col + .wallet-col {
            border-left: 1px solid rgba(255,255,255,0.06);
        }
        .wallet-col-header {
            font-size: 0.68rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.3);
            padding: 8px 8px 6px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            flex-shrink: 0;
        }
        .wallet-col-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 6px 2px;
        }
        .wallet-position-card {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: rgba(255,255,255,0.025);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 10px;
            border-left: 3px solid #22c55e;
        }
        .wallet-position-card .pos-symbol {
            font-size: 0.8rem;
            font-weight: 700;
            color: rgba(255,255,255,0.85);
        }
        .wallet-position-card .pos-detail {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.3);
            margin-top: 1px;
        }
        .wallet-position-card .pos-pnl {
            margin-left: auto;
            font-size: 0.8rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            flex-shrink: 0;
        }
        .wallet-position-card .pos-pnl.positive { color: #22c55e; }
        .wallet-position-card .pos-pnl.negative { color: #ef4444; }
        .wallet-col-empty {
            color: rgba(255,255,255,0.2);
            font-size: 0.75rem;
            text-align: center;
            padding: 20px 8px;
        }
        .wallet-entry-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(255,255,255,0.025);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 10px;
            border-left: 3px solid rgba(255,255,255,0.1);
            transition: background 0.15s;
        }
        .wallet-entry-card:hover { background: rgba(255,255,255,0.05); }
        .wallet-entry-card.cat-trade { border-left-color: #22c55e; }
        .wallet-entry-card.cat-backtest { border-left-color: #a78bfa; }
        .wallet-entry-card.cat-bet { border-left-color: #eab308; }
        .wallet-entry-card.cat-other { border-left-color: #3b82f6; }
        .wallet-entry-info {
            flex: 1;
            min-width: 0;
        }
        .wallet-entry-desc {
            font-size: 0.78rem;
            color: rgba(255,255,255,0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .wallet-entry-meta {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.25);
            margin-top: 2px;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .wallet-entry-category {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1px 6px;
            border-radius: 6px;
        }
        .wallet-entry-category.cat-trade { background: rgba(34,197,94,0.15); color: #22c55e; }
        .wallet-entry-category.cat-backtest { background: rgba(167,139,250,0.15); color: #a78bfa; }
        .wallet-entry-category.cat-bet { background: rgba(234,179,8,0.15); color: #eab308; }
        .wallet-entry-category.cat-other { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .wallet-entry-pnl {
            font-size: 0.82rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            flex-shrink: 0;
        }
        .wallet-entry-pnl.positive { color: #22c55e; }
        .wallet-entry-pnl.negative { color: #ef4444; }
        .wallet-entry-pnl.zero { color: rgba(255,255,255,0.3); }
        .wallet-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: rgba(255,255,255,0.25);
            font-size: 0.85rem;
            padding-top: 40px;
        }
        .wallet-empty .empty-icon { font-size: 2rem; margin-bottom: 8px; }

        /* Answers items container */
        .mind-answers-items {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .mind-answers-items.hidden { display: none; }

        /* Stored items container */
        .mind-stored-items {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .mind-stored-items.hidden { display: none; }
        .mind-stored-items-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: var(--text-muted);
            font-size: 0.85rem;
            gap: 8px;
            padding: 40px 0;
        }
        .mind-stored-items-empty-icon { font-size: 2rem; opacity: 0.4; }

        /* Stored item card */
        .stored-item-card {
            background: rgba(15, 15, 25, 0.6);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 12px 14px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .stored-item-card:hover {
            background: rgba(20, 20, 35, 0.8);
            border-color: rgba(255,255,255,0.12);
        }
        .stored-item-card.type-question,
        .stored-item-card.type-approval {
            border-left: 3px solid #eab308;
        }
        .stored-item-card.type-simulation {
            border-left: 3px solid #8b5cf6;
        }
        .stored-item-card.type-agent_result {
            border-left: 3px solid #22c55e;
        }
        .stored-item-card.type-finding {
            border-left: 3px solid #3b82f6;
        }
        .stored-item-card.type-alert {
            border-left: 3px solid #ef4444;
        }
        .stored-item-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .stored-item-badge {
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stored-item-badge.question { background: rgba(234,179,8,0.15); color: #eab308; }
        .stored-item-badge.approval { background: rgba(139,92,246,0.15); color: #a78bfa; }
        .stored-item-badge.simulation { background: rgba(139,92,246,0.15); color: #a78bfa; }
        .stored-item-badge.agent_result { background: rgba(34,197,94,0.15); color: #22c55e; }
        .stored-item-badge.finding { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .stored-item-badge.alert { background: rgba(239,68,68,0.15); color: #ef4444; }
        .stored-item-status-dot {
            width: 6px; height: 6px; border-radius: 50%;
            flex-shrink: 0;
        }
        .stored-item-status-dot.pending { background: #eab308; }
        .stored-item-status-dot.answered { background: #22c55e; }
        .stored-item-status-dot.viewed { background: #22c55e; }
        .stored-item-time {
            font-size: 0.68rem;
            color: var(--text-muted);
            margin-left: auto;
        }
        .stored-item-title {
            font-size: 0.82rem;
            color: var(--text-primary);
            margin-bottom: 4px;
            line-height: 1.3;
        }
        .stored-item-content-preview {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.3;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .stored-item-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 22px; height: 22px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.15s;
        }
        .stored-item-card:hover .stored-item-delete { opacity: 1; }
        .stored-item-delete:hover { background: rgba(239,68,68,0.15); color: var(--red); }

        /* HITL secondary action buttons (Skip / Delay) */
        .hitl-secondary-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            padding: 0 16px 16px;
        }
        .hitl-action-btn.secondary {
            flex: 1;
            padding: 8px 16px;
            font-size: 0.78rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.5);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .hitl-action-btn.secondary:hover {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
        }
        .hitl-action-btn.secondary.delay:hover {
            border-color: rgba(234,179,8,0.4);
            color: #eab308;
        }

        /* Mind chat floating action button */
        .mind-fab-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }
        .mind-fab-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: rgba(15, 10, 30, 0.85);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(12px);
        }
        .mind-fab-btn:hover {
            background: var(--bg-hover);
            color: var(--accent);
            border-color: var(--accent);
            transform: scale(1.05);
        }
        .mind-fab-btn.open {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .mind-fab-menu {
            position: absolute;
            top: 42px;
            right: 0;
            background: rgba(15, 10, 30, 0.95);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px) scale(0.95);
            transition: all 0.2s ease;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            min-width: 170px;
            backdrop-filter: blur(20px);
        }
        .mind-fab-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        .mind-fab-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-secondary);
            font-size: 0.82rem;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }
        .mind-fab-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .mind-fab-item svg { flex-shrink: 0; }
        .mind-fab-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
        }

        .mind-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px 18px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 280px;
            min-height: 120px;
        }

        @media (min-width: 1024px) {
            .mind-chat-section {
                padding: 0;
            }
            .mind-chat-container {
                min-height: 0;
            }
            .mind-chat-messages {
                max-height: none;
                flex: 1;
            }
        }

        .mind-chat-messages::-webkit-scrollbar { width: 3px; }
        .mind-chat-messages::-webkit-scrollbar-track { background: transparent; }
        .mind-chat-messages::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 2px;
        }

        .mind-chat-input-bar {
            display: flex;
            gap: 10px;
            padding: 12px 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(5, 5, 8, 0.5);
            align-items: center;
        }

        .mind-chat-input-bar input {
            flex: 1;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 12px 20px;
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            outline: none;
            transition: all 0.25s ease;
        }

        .mind-chat-input-bar input:focus {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.08);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.1);
        }

        .mind-chat-input-bar input::placeholder {
            color: var(--text-muted);
        }

        .mind-chat-send-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease;
            flex-shrink: 0;
        }

        .mind-chat-send-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
        }

        .mind-chat-send-btn:active {
            transform: scale(0.95);
        }

        /* Chat message styles for centered chat */
        .mind-chat-msg {
            max-width: 80%;
            padding: 10px 16px;
            border-radius: 16px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            line-height: 1.5;
            animation: msg-fade-in 0.25s ease;
        }

        .mind-chat-msg.user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .mind-chat-msg.cerebro {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            cursor: pointer;
            transition: border-color 0.15s ease;
        }
        .mind-chat-msg.cerebro:hover {
            border-color: rgba(139,92,246,0.3);
        }

        /* Timestamps under messages */
        .msg-timestamp {
            font-size: 0.6rem;
            color: var(--text-muted);
            opacity: 0.5;
            margin-top: 2px;
            font-family: 'Space Mono', monospace;
            letter-spacing: 0.3px;
        }
        .mind-chat-msg.user + .msg-timestamp { align-self: flex-end; text-align: right; }
        .mind-chat-msg.cerebro + .msg-timestamp,
        .mind-chat-msg.card + .msg-timestamp,
        .mind-chat-msg.status + .msg-timestamp { align-self: flex-start; }

        /* Reply-to banner inside messages */
        .msg-reply-banner {
            font-size: 0.65rem;
            color: rgba(139,92,246,0.7);
            border-left: 2px solid rgba(139,92,246,0.4);
            padding: 2px 8px;
            margin-bottom: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        /* General reply context bar (purple, vs yellow for HITL) */
        .reply-context-bar.general {
            background: rgba(139,92,246,0.08);
            border: 1px solid rgba(139,92,246,0.2);
        }
        .reply-context-bar.general .reply-context-text {
            color: rgba(139,92,246,0.8);
        }

        .mind-chat-msg.typing {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        .mind-chat-welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px 20px;
            opacity: 0.5;
            text-align: center;
        }

        .mind-chat-welcome-icon { font-size: 1.5rem; margin-bottom: 8px; }
        .mind-chat-welcome-text { font-size: 0.85rem; color: var(--text-secondary); }
        .mind-chat-welcome-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; }

        /* Status messages in chat (Cerebro's thoughts/voice) */
        .mind-chat-msg.status {
            align-self: flex-start;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.06), rgba(59, 130, 246, 0.04));
            border: 1px solid rgba(139, 92, 246, 0.12);
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-style: italic;
            opacity: 0.85;
            max-width: 90%;
            transition: opacity 0.3s ease;
        }

        .mind-chat-msg.status .status-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mind-chat-msg.status .status-label .status-dot {
            width: 5px;
            height: 5px;
            background: var(--accent);
            border-radius: 50%;
            animation: voicePulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 6px var(--accent);
        }

        /* Narration messages in chat (Cerebro live narration) */
        .mind-chat-msg.narration {
            align-self: flex-start;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.10), rgba(99, 60, 200, 0.06));
            border: 1px solid rgba(139, 92, 246, 0.18);
            border-left: 2px solid rgba(139, 92, 246, 0.5);
            color: var(--text-secondary);
            font-size: 0.83rem;
            max-width: 92%;
        }
        .narration-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            color: rgba(139, 92, 246, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.18em;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .narration-dot {
            width: 5px;
            height: 5px;
            background: #8b5cf6;
            border-radius: 50%;
            animation: voicePulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 6px rgba(139, 92, 246, 0.6);
        }
        .narration-content {
            line-height: 1.45;
        }
        .mind-chat-load-more {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.7rem;
            padding: 6px 0;
            cursor: pointer;
            opacity: 0.7;
        }
        .mind-chat-load-more:hover { opacity: 1; text-decoration: underline; }

        /* ==================== STRUCTURED CARD CHAT ==================== */
        .mind-chat-msg.card {
            align-self: flex-start;
            max-width: 95%;
            width: 95%;
            padding: 0;
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.18);
            background: rgba(15, 12, 35, 0.45);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            overflow: hidden;
            flex-shrink: 0;
            cursor: pointer;
            transition: border-color 0.15s ease;
        }
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 14px;
            background: rgba(139, 92, 246, 0.04);
            border-bottom: 1px solid rgba(139, 92, 246, 0.10);
        }
        .card-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-phase {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            padding: 3px 10px;
            border-radius: 6px;
            font-weight: 600;
        }
        .card-phase.observe { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
        .card-phase.orient  { background: rgba(234, 179, 8, 0.15); color: #facc15; }
        .card-phase.decide  { background: rgba(139, 92, 246, 0.15); color: #a78bfa; }
        .card-phase.act     { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
        .card-phase.reflect { background: rgba(236, 72, 153, 0.15); color: #f472b6; }
        .card-phase.idle    { background: rgba(148, 163, 184, 0.12); color: #94a3b8; }
        /* Message type badges */
        .card-phase.thought { background: rgba(167, 139, 250, 0.15); color: #a78bfa; }
        .card-phase.action  { background: rgba(34, 211, 238, 0.15); color: #22d3ee; }
        .card-phase.message { background: rgba(236, 72, 153, 0.15); color: #f472b6; }
        .card-phase.alert   { background: rgba(234, 179, 8, 0.15); color: #facc15; }
        .card-timestamp {
            font-family: 'Space Mono', monospace;
            font-size: 0.5rem;
            color: var(--text-muted);
            letter-spacing: 0.05em;
        }
        .card-live-dot {
            width: 5px;
            height: 5px;
            background: #8b5cf6;
            border-radius: 50%;
            animation: voicePulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 6px rgba(139, 92, 246, 0.6);
        }
        .card-body {
            padding: 10px 14px;
        }
        .card-content {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            line-height: 1.55;
            color: var(--text-primary);
        }
        /* Reuse agent-output-rendered patterns for card markdown */
        .card-content h1,
        .card-content h2,
        .card-content h3 {
            color: var(--text-primary);
            margin-top: 0.8em;
            margin-bottom: 0.3em;
        }
        .card-content h1:first-child,
        .card-content h2:first-child,
        .card-content h3:first-child { margin-top: 0; }
        .card-content h1 { font-size: 1.1rem; }
        .card-content h2 { font-size: 1rem; color: var(--accent); }
        .card-content h3 { font-size: 0.9rem; }
        .card-content p { margin-bottom: 0.6em; line-height: 1.55; }
        .card-content ul, .card-content ol { margin-left: 16px; margin-bottom: 0.6em; }
        .card-content li { margin-bottom: 0.3em; }
        .card-content code {
            background: var(--bg-elevated);
            padding: 1px 5px;
            border-radius: 3px;
            font-family: 'SF Mono', monospace;
            font-size: 0.82em;
            color: var(--accent);
        }
        .card-content pre {
            background: var(--bg-primary);
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 0.6em;
        }
        .card-content pre code { background: none; padding: 0; color: var(--text-primary); }
        .card-content blockquote {
            border-left: 2px solid rgba(139, 92, 246, 0.4);
            padding-left: 10px;
            color: var(--text-muted);
            margin: 0.5em 0;
            font-style: italic;
        }
        .card-content strong { color: var(--text-primary); }
        .card-content a { color: var(--accent-light); text-decoration: underline; }

        /* Idle card - slightly dimmed */
        .mind-chat-msg.card.idle-card {
            opacity: 0.75;
            border-color: rgba(148, 163, 184, 0.15);
            background: rgba(15, 12, 35, 0.35);
        }

        /* Question card - amber tint */
        .mind-chat-msg.card.question-card {
            border-color: rgba(234, 179, 8, 0.35);
            background: rgba(234, 179, 8, 0.04);
        }
        .question-card .card-header {
            border-bottom-color: rgba(234, 179, 8, 0.15);
        }
        .question-card .card-body {
            padding-bottom: 8px;
        }
        .question-card-context {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 6px;
            padding-left: 10px;
            border-left: 2px solid rgba(234, 179, 8, 0.3);
            line-height: 1.4;
        }
        .question-reply-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            padding: 5px 12px;
            background: rgba(234, 179, 8, 0.12);
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 8px;
            color: #facc15;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .question-reply-btn:hover {
            background: rgba(234, 179, 8, 0.22);
            border-color: rgba(234, 179, 8, 0.5);
        }

        /* Thought card - soft lavender */
        .mind-chat-msg.card.thought-card {
            border-color: rgba(167, 139, 250, 0.25);
            background: rgba(167, 139, 250, 0.04);
        }
        .mind-chat-msg.card.thought-card .card-header {
            background: rgba(167, 139, 250, 0.08);
            border-bottom-color: rgba(167, 139, 250, 0.12);
        }

        /* Action card - cyan/teal */
        .mind-chat-msg.card.action-card {
            border-color: rgba(34, 211, 238, 0.25);
            background: rgba(34, 211, 238, 0.04);
        }
        .mind-chat-msg.card.action-card .card-header {
            background: rgba(34, 211, 238, 0.08);
            border-bottom-color: rgba(34, 211, 238, 0.12);
        }
        .mind-chat-msg.card.action-card .card-live-dot {
            background: #22d3ee;
            box-shadow: 0 0 6px rgba(34, 211, 238, 0.6);
        }

        /* Message card - bright magenta */
        .mind-chat-msg.card.message-card {
            border-color: rgba(236, 72, 153, 0.3);
            background: rgba(236, 72, 153, 0.05);
        }
        .mind-chat-msg.card.message-card .card-header {
            background: rgba(236, 72, 153, 0.08);
            border-bottom-color: rgba(236, 72, 153, 0.12);
        }
        .mind-chat-msg.card.message-card .card-live-dot {
            background: #ec4899;
            box-shadow: 0 0 6px rgba(236, 72, 153, 0.6);
        }

        /* Alert card - amber/gold */
        .mind-chat-msg.card.alert-card {
            border-color: rgba(234, 179, 8, 0.35);
            background: rgba(234, 179, 8, 0.05);
        }
        .mind-chat-msg.card.alert-card .card-header {
            background: rgba(234, 179, 8, 0.1);
            border-bottom-color: rgba(234, 179, 8, 0.15);
        }
        .mind-chat-msg.card.alert-card .card-live-dot {
            background: #eab308;
            box-shadow: 0 0 6px rgba(234, 179, 8, 0.6);
        }

        /* Collapsible card content */
        .card-content.collapsed {
            max-height: 120px;
            overflow: hidden;
            position: relative;
        }
        .card-content.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(transparent, rgba(15, 12, 35, 0.6));
            pointer-events: none;
        }
        .card-expand-btn {
            display: block;
            width: 100%;
            text-align: center;
            background: none;
            border: none;
            color: var(--accent-light);
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            cursor: pointer;
            padding: 4px 0;
            letter-spacing: 0.1em;
        }
        .card-expand-btn:hover { text-decoration: underline; }

        /* Reply context bar */
        .reply-context-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 14px;
            background: rgba(234, 179, 8, 0.08);
            border: 1px solid rgba(234, 179, 8, 0.2);
            border-radius: 8px;
            margin-bottom: 6px;
            animation: msg-fade-in 0.2s ease;
        }
        .reply-context-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.75rem;
            color: #facc15;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }
        .reply-context-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1rem;
            padding: 0 0 0 10px;
            line-height: 1;
        }
        .reply-context-close:hover { color: var(--text-primary); }

        /* Chat page narration style */
        .chat-message.narration {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(99, 60, 200, 0.04));
            border-left: 2px solid rgba(139, 92, 246, 0.5);
        }
        .chat-message.narration .narration-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            color: rgba(139, 92, 246, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.18em;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .chat-message.narration .narration-dot {
            width: 5px;
            height: 5px;
            background: #8b5cf6;
            border-radius: 50%;
            animation: voicePulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 6px rgba(139, 92, 246, 0.6);
        }
        .chat-message.narration .narration-content {
            font-size: 0.83rem;
            line-height: 1.45;
        }

        /* ===== HIDE VOICE STREAM & DIRECTIVE WHISPER ===== */
        .voice-stream { display: none; }
        .directive-whisper { display: none; }

        /* ===== CONSCIOUSNESS CHAMBER in column  exact nav-orb replica (1.5x) ===== */
        @media (min-width: 1024px) {
            .consciousness-chamber {
                max-width: none;
                padding: 6px 0 2px;
                flex-shrink: 0;
            }
            /* Kill the 800px ambient glow on desktop */
            .consciousness-chamber::before { display: none !important; }
            /* Hide all decorative layers  we rebuild as nav-orb style */
            .orbital-system,
            .orb-particles,
            .orb-aura { display: none !important; }

            /* Container  like nav-orb-container (36px  54px) */
            .consciousness-orb {
                width: 54px !important;
                height: 54px !important;
                background: none !important;
                box-shadow: none !important;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
            }
            .consciousness-orb:hover {
                transform: scale(1.08);
            }
            /* Ring 1  like nav-orb-ring:nth-child(1) (32px  48px) */
            .consciousness-orb::before {
                content: '';
                position: absolute;
                width: 48px;
                height: 48px;
                border-radius: 50%;
                border: 1.5px solid transparent;
                border-top-color: rgba(139, 92, 246, 0.6);
                border-right-color: rgba(139, 92, 246, 0.3);
                animation: ringRotate 3s linear infinite;
                pointer-events: none;
            }
            /* Ring 2  like nav-orb-ring:nth-child(2) (36px  54px) */
            .consciousness-orb::after {
                content: '';
                position: absolute;
                width: 54px;
                height: 54px;
                border-radius: 50%;
                border: 1.5px solid transparent;
                border-top-color: rgba(99, 102, 241, 0.4);
                border-right-color: rgba(99, 102, 241, 0.2);
                animation: ringRotate 4s linear infinite reverse;
                pointer-events: none;
            }

            /* Main sphere  exact nav-orb gradient (28px  42px) */
            .orb-essence {
                width: 42px !important;
                height: 42px !important;
                position: absolute !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                background: radial-gradient(
                    circle at 30% 30%,
                    #e9d5ff 0%,
                    #a78bfa 25%,
                    #7c3aed 50%,
                    #5b21b6 75%,
                    #4c1d95 100%
                ) !important;
                box-shadow:
                    0 0 10px rgba(167, 139, 250, 0.6),
                    0 0 20px rgba(139, 92, 246, 0.4),
                    inset 0 0 10px rgba(255, 255, 255, 0.2) !important;
                animation: navOrbBreathe 4s ease-in-out infinite !important;
                filter: none !important;
                opacity: 1 !important;
                z-index: 1;
            }
            /* Highlight spot on sphere  like nav-orb::before (8px  12px) */
            .orb-essence::before {
                content: '';
                position: absolute;
                top: 15%;
                left: 20%;
                width: 12px;
                height: 12px;
                background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
                border-radius: 50%;
            }

            /* Inner core  exact nav-orb-inner gradient (14px  21px) */
            .orb-inner-light {
                width: 21px !important;
                height: 21px !important;
                position: absolute !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                border-radius: 50% !important;
                background: radial-gradient(circle at 30% 30%, #f5f3ff 0%, #e9d5ff 40%, #a78bfa 100%) !important;
                box-shadow: 0 0 8px rgba(233, 213, 255, 0.8) !important;
                filter: none !important;
                animation: navInnerPulse 2s ease-in-out infinite !important;
                z-index: 2;
            }

            /* Dormant state  dim but keep structure */
            .consciousness-orb.dormant .orb-essence {
                opacity: 0.4 !important;
                filter: grayscale(0.3) brightness(0.6) !important;
                animation: navOrbBreathe 6s ease-in-out infinite !important;
            }
            .consciousness-orb.dormant .orb-inner-light {
                opacity: 0.3 !important;
            }
            .consciousness-orb.dormant::before,
            .consciousness-orb.dormant::after {
                opacity: 0.3;
            }

            /* Active state  bright, faster rings */
            .consciousness-orb.active .orb-essence,
            .consciousness-orb.autonomous .orb-essence {
                opacity: 1 !important;
                filter: none !important;
            }
            .consciousness-orb.active .orb-inner-light,
            .consciousness-orb.autonomous .orb-inner-light {
                opacity: 1 !important;
            }
            .consciousness-orb.active::before,
            .consciousness-orb.autonomous::before {
                opacity: 1;
                animation-duration: 2s;
            }
            .consciousness-orb.active::after,
            .consciousness-orb.autonomous::after {
                opacity: 1;
                animation-duration: 2.5s;
            }
            /* Phase: acting  amber rings like nav-orb active-agents */
            .consciousness-orb.acting::before,
            .consciousness-orb.acting::after {
                border-top-color: rgba(245, 158, 11, 0.6) !important;
                animation-duration: 1.5s !important;
            }
            .consciousness-orb.acting .orb-essence {
                box-shadow:
                    0 0 15px rgba(245, 158, 11, 0.5),
                    0 0 25px rgba(245, 158, 11, 0.3),
                    inset 0 0 10px rgba(255, 255, 255, 0.2) !important;
            }
            /* Phase: observing  cyan rings */
            .consciousness-orb.observing::before,
            .consciousness-orb.observing::after {
                border-top-color: rgba(34, 211, 238, 0.6) !important;
            }
            /* Phase: thinking/deciding  default purple (no override needed) */

            /* ===== ORB MOOD STATES (Tamagotchi) ===== */
            @keyframes orbShake {
                0%, 100% { transform: translateX(0); }
                20% { transform: translateX(-2px) rotate(-1deg); }
                40% { transform: translateX(2px) rotate(1deg); }
                60% { transform: translateX(-1px) rotate(-0.5deg); }
                80% { transform: translateX(1px) rotate(0.5deg); }
            }
            @keyframes orbPulseExcited {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.08); }
            }
            @keyframes amberFlicker {
                0%, 100% { opacity: 1; }
                30% { opacity: 0.7; }
                60% { opacity: 0.9; }
                80% { opacity: 0.65; }
            }

            /* Excited: bright green aura, fast orbits, pulsing */
            .consciousness-orb.mood-excited .orb-essence {
                box-shadow: 0 0 18px rgba(74, 222, 128, 0.7), 0 0 35px rgba(74, 222, 128, 0.4), inset 0 0 10px rgba(255,255,255,0.2) !important;
                animation: orbPulseExcited 1s ease-in-out infinite !important;
            }
            .consciousness-orb.mood-excited::before,
            .consciousness-orb.mood-excited::after {
                border-top-color: rgba(74, 222, 128, 0.7) !important;
                animation-duration: 1.2s !important;
            }

            /* Happy: warm purple glow, gentle pulse */
            .consciousness-orb.mood-happy .orb-essence {
                box-shadow: 0 0 16px rgba(167, 139, 250, 0.8), 0 0 30px rgba(139, 92, 246, 0.5), inset 0 0 10px rgba(255,255,255,0.25) !important;
                animation: navOrbBreathe 2.5s ease-in-out infinite !important;
            }
            .consciousness-orb.mood-happy::before,
            .consciousness-orb.mood-happy::after {
                border-top-color: rgba(167, 139, 250, 0.7) !important;
                animation-duration: 2s !important;
            }

            /* Content: default purple  no overrides */

            /* Bored: dim, slow orbits, reduced opacity */
            .consciousness-orb.mood-bored .orb-essence {
                opacity: 0.55 !important;
                filter: brightness(0.7) !important;
                animation: navOrbBreathe 7s ease-in-out infinite !important;
            }
            .consciousness-orb.mood-bored .orb-inner-light { opacity: 0.4 !important; }
            .consciousness-orb.mood-bored::before,
            .consciousness-orb.mood-bored::after {
                opacity: 0.4;
                animation-duration: 6s !important;
            }

            /* Lonely: very dim, near-sleeping */
            .consciousness-orb.mood-lonely .orb-essence {
                opacity: 0.35 !important;
                filter: grayscale(0.2) brightness(0.55) !important;
                animation: navOrbBreathe 8s ease-in-out infinite !important;
            }
            .consciousness-orb.mood-lonely .orb-inner-light { opacity: 0.25 !important; }
            .consciousness-orb.mood-lonely::before,
            .consciousness-orb.mood-lonely::after {
                opacity: 0.25;
                animation-duration: 8s !important;
            }

            /* Confused: amber flicker (HITL pending) */
            .consciousness-orb.mood-confused .orb-essence {
                box-shadow: 0 0 14px rgba(245, 158, 11, 0.6), 0 0 25px rgba(245, 158, 11, 0.3), inset 0 0 10px rgba(255,255,255,0.15) !important;
                animation: amberFlicker 1.5s ease-in-out infinite !important;
            }
            .consciousness-orb.mood-confused::before,
            .consciousness-orb.mood-confused::after {
                border-top-color: rgba(245, 158, 11, 0.6) !important;
            }

            /* Frustrated: red tinge, erratic shake */
            .consciousness-orb.mood-frustrated .orb-essence {
                box-shadow: 0 0 14px rgba(239, 68, 68, 0.6), 0 0 25px rgba(239, 68, 68, 0.3), inset 0 0 10px rgba(255,255,255,0.15) !important;
                animation: orbShake 0.6s ease-in-out infinite !important;
            }
            .consciousness-orb.mood-frustrated::before,
            .consciousness-orb.mood-frustrated::after {
                border-top-color: rgba(239, 68, 68, 0.6) !important;
                animation-duration: 1.2s !important;
            }

            .consciousness-status {
                margin-top: 4px;
            }
            .consciousness-status .status-text {
                font-size: 0.65rem !important;
                letter-spacing: 0.15em;
            }
            .awaken-btn {
                padding: 5px 16px;
                font-size: 0.7rem;
                margin-top: 6px !important;
            }
        }

        /* ===== ORB TABBED PANEL ===== */
        .orb-tabbed-panel {
            width: 100%;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            background: rgba(10, 10, 16, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            overflow: hidden;
        }

        .orb-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            flex-shrink: 0;
        }

        .orb-tab {
            flex: 1;
            padding: 10px 4px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.72rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }

        .orb-tab:hover {
            color: var(--text-secondary);
            background: rgba(139, 92, 246, 0.05);
        }

        .orb-tab.active {
            color: var(--accent-light);
            border-bottom-color: var(--accent);
            background: rgba(139, 92, 246, 0.08);
        }

        .orb-tab svg {
            flex-shrink: 0;
        }

        .orb-tab-icon {
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        .orb-tab-badge {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 1px 5px;
            border-radius: 6px;
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent-light);
            min-width: 14px;
            text-align: center;
        }

        .orb-tab-badge.green {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .orb-tab-content {
            flex: 1;
            min-height: 0;
            overflow: hidden;
            position: relative;
        }

        .orb-tab-pane {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
        }

        .orb-tab-pane.active {
            display: flex;
        }

        .orb-tab-pane::-webkit-scrollbar { width: 3px; }
        .orb-tab-pane::-webkit-scrollbar-track { background: transparent; }
        .orb-tab-pane::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.3); border-radius: 2px; }

        /* ===== TAMAGOTCHI HEALTH PANEL ===== */
        .tamagotchi-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 14px 16px;
        }
        .tama-bar-group { display: flex; flex-direction: column; gap: 4px; }
        .tama-bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tama-bar-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary, rgba(255,255,255,0.6));
        }
        .tama-bar-value {
            font-size: 0.65rem;
            color: var(--text-muted, rgba(255,255,255,0.4));
            font-weight: 500;
        }
        .tama-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .tama-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        /* Mood fills */
        .mood-fill.excited { background: linear-gradient(90deg, #22c55e, #4ade80); box-shadow: 0 0 8px rgba(74, 222, 128, 0.5); }
        .mood-fill.happy { background: linear-gradient(90deg, #7c3aed, #a78bfa); box-shadow: 0 0 8px rgba(167, 139, 250, 0.5); }
        .mood-fill.content { background: linear-gradient(90deg, #6366f1, #818cf8); box-shadow: 0 0 6px rgba(129, 140, 248, 0.4); }
        .mood-fill.bored { background: linear-gradient(90deg, #4b5563, #6b7280); }
        .mood-fill.lonely { background: linear-gradient(90deg, #374151, #4b5563); }
        .mood-fill.confused { background: linear-gradient(90deg, #d97706, #f59e0b); box-shadow: 0 0 8px rgba(245, 158, 11, 0.5); }
        .mood-fill.frustrated { background: linear-gradient(90deg, #dc2626, #ef4444); box-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }

        /* Energy fill */
        .energy-fill { background: linear-gradient(90deg, #0ea5e9, #38bdf8); box-shadow: 0 0 6px rgba(56, 189, 248, 0.4); }

        /* Memory fill */
        .memory-fill { background: linear-gradient(90deg, #10b981, #34d399); box-shadow: 0 0 6px rgba(52, 211, 153, 0.4); }
        .memory-fill.degraded { background: linear-gradient(90deg, #f59e0b, #fbbf24); box-shadow: 0 0 6px rgba(251, 191, 36, 0.4); }
        .memory-fill.offline { background: linear-gradient(90deg, #ef4444, #f87171); box-shadow: 0 0 6px rgba(248, 113, 113, 0.4); }

        /* XP fill */
        .xp-fill { background: linear-gradient(90deg, #8b5cf6, #c084fc); box-shadow: 0 0 6px rgba(192, 132, 252, 0.4); }

        /* Indicators */
        .tama-indicators {
            display: flex;
            align-items: center;
            gap: 16px;
            padding-top: 4px;
            border-top: 1px solid rgba(255,255,255,0.04);
        }
        .tama-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .tama-indicator-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted, rgba(255,255,255,0.4));
            font-weight: 600;
        }
        .tama-phase-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: var(--text-muted, rgba(255,255,255,0.3));
            flex-shrink: 0;
        }
        .tama-phase-dot.running { background: #a78bfa; box-shadow: 0 0 6px rgba(167,139,250,0.6); }
        .tama-phase-dot.observing { background: #22d3ee; box-shadow: 0 0 6px rgba(34,211,238,0.6); }
        .tama-phase-dot.acting { background: #f59e0b; box-shadow: 0 0 6px rgba(245,158,11,0.6); }
        .tama-phase-dot.dormant { background: rgba(255,255,255,0.2); }
        .tama-phase-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary, rgba(255,255,255,0.6));
            text-transform: capitalize;
        }
        .tama-pips { display: flex; gap: 4px; align-items: center; }
        .tama-pip {
            width: 12px; height: 12px;
            border-radius: 3px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.25s ease;
            cursor: pointer;
        }
        .tama-pip:hover {
            background: rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
            transform: scale(1.15);
        }
        .tama-pip.filled {
            background: rgba(139, 92, 246, 0.6);
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow: 0 0 5px rgba(139, 92, 246, 0.4);
        }
        .tama-pip.filled:hover {
            background: rgba(139, 92, 246, 0.8);
        }

        /* Mini stat cards */
        .tama-stats-row {
            display: flex;
            gap: 8px;
            padding-top: 4px;
        }
        .tama-stat-card {
            flex: 1;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 8px;
            padding: 8px 6px;
            text-align: center;
        }
        .tama-stat-num {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary, #fff);
            line-height: 1.2;
        }
        .tama-stat-label {
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted, rgba(255,255,255,0.4));
            font-weight: 600;
        }

        /* Directive cards in Command tab */
        .directive-card {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            margin: 0 12px 6px;
            transition: background 0.2s ease;
        }
        .directive-card:hover { background: rgba(255,255,255,0.05); }
        .directive-status-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .directive-status-badge.active {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        .directive-status-badge.pending {
            background: rgba(255,255,255,0.06);
            color: var(--text-muted, rgba(255,255,255,0.4));
            border: 1px solid rgba(255,255,255,0.08);
        }
        .directive-card-text {
            flex: 1;
            font-size: 0.8rem;
            color: var(--text-primary, #fff);
            line-height: 1.4;
        }
        .directive-card-btn {
            width: 28px; height: 28px;
            border-radius: 8px;
            background: rgba(74, 222, 128, 0.15);
            border: 1px solid rgba(74, 222, 128, 0.25);
            color: #4ade80;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        .directive-card-btn:hover {
            background: rgba(74, 222, 128, 0.3);
            transform: scale(1.08);
        }

        /* Command tab  input at bottom */
        .orb-command-input.command-input-bottom {
            border-bottom: none;
            border-top: 1px solid rgba(255, 255, 255, 0.04);
            margin-top: auto;
        }

        /* Command tab */
        .orb-command-input {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            flex-shrink: 0;
        }

        .orb-auto-awake {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .orb-auto-awake input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            border: 1.5px solid rgba(139, 92, 246, 0.6);
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.06);
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .orb-auto-awake input[type="checkbox"]:hover {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.15);
        }

        .orb-auto-awake input[type="checkbox"]:checked {
            background: rgba(139, 92, 246, 0.4);
            border-color: var(--accent);
        }

        .orb-auto-awake input[type="checkbox"]:checked::after {
            content: '\2713';
            position: absolute;
            top: -1px;
            left: 2px;
            font-size: 11px;
            color: #c4b5fd;
            font-weight: bold;
        }

        .orb-auto-awake label {
            font-size: 11.5px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            user-select: none;
        }

        .orb-command-input textarea {
            flex: 1;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            outline: none;
            resize: none;
            min-height: 42px;
            max-height: 80px;
            transition: border-color 0.2s ease;
        }

        .orb-command-input textarea:focus {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.08);
        }

        .orb-command-input textarea::placeholder {
            color: var(--text-muted);
        }

        .orb-command-send {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: var(--accent-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            align-self: flex-end;
            transition: all 0.2s ease;
        }

        .orb-command-send:hover {
            background: rgba(139, 92, 246, 0.4);
            transform: scale(1.05);
        }

        .orb-command-directives {
            flex: 1;
            overflow-y: auto;
            padding: 10px 12px;
        }

        .orb-command-empty, .orb-pane-empty {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.78rem;
            padding: 24px 16px;
            opacity: 0.6;
        }

        .orb-pane-list {
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Directive tag in command panel */
        .orb-directive-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 10px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .orb-directive-item:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.12);
        }

        .orb-directive-text {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .orb-directive-complete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: color 0.2s ease;
        }

        .orb-directive-complete:hover {
            color: var(--green);
        }

        /* Focus/Completed/Skills list items in orb panel */
        .orb-list-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .orb-list-item:hover {
            background: rgba(139, 92, 246, 0.08);
            border-color: rgba(139, 92, 246, 0.2);
        }

        .orb-list-item .item-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .orb-list-item .item-dot.active { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
        .orb-list-item .item-dot.done { background: var(--green); }
        .orb-list-item .item-dot.skill { background: var(--energy-blue); }

        .orb-list-item .item-text {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .orb-list-item .item-meta {
            font-size: 0.65rem;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        /* Agents panel inside tabbed panel */
        .orb-tabbed-panel .agents-status-panel {
            display: block;
            position: relative;
            bottom: auto;
            left: auto;
            transform: none;
            z-index: auto;
            width: 100%;
            max-width: none;
            min-width: 0;
            border-radius: 0;
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(8, 8, 14, 0.6);
            box-shadow: none;
            flex-shrink: 0;
        }

        /* ===== SLIDE-OUT PANELS ===== */
        .slide-panel-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.35s ease;
        }

        .slide-panel-backdrop.visible {
            opacity: 1;
            pointer-events: all;
        }

        .slide-panel {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 360px;
            background: rgba(8, 8, 14, 0.97);
            border: 1px solid rgba(139, 92, 246, 0.12);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            z-index: 210;
            display: flex;
            flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .slide-panel.left {
            left: 0;
            transform: translateX(-100%);
            border-left: none;
            border-radius: 0 16px 16px 0;
        }

        .slide-panel.right {
            right: 0;
            transform: translateX(100%);
            border-right: none;
            border-radius: 16px 0 0 16px;
        }

        .slide-panel.open {
            transform: translateX(0);
        }

        .slide-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 20px 16px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            flex-shrink: 0;
        }

        .slide-panel-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.05em;
        }

        .slide-panel-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.1rem;
        }

        .slide-panel-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .slide-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .slide-panel-body::-webkit-scrollbar { width: 3px; }
        .slide-panel-body::-webkit-scrollbar-track { background: transparent; }
        .slide-panel-body::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 2px;
        }

        /* Edge indicators - subtle glow lines to hint at panels */
        .edge-indicator {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 120px;
            border-radius: 3px;
            z-index: 100;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.3;
        }

        /* Edge indicators only show in autonomy view */
        .view:not(.active) .edge-indicator,
        .view:not(.active) .slide-panel,
        .view:not(.active) .slide-panel-backdrop {
            display: none;
        }

        .edge-indicator.left {
            left: 0;
            background: linear-gradient(180deg, transparent, rgba(59, 130, 246, 0.5), rgba(139, 92, 246, 0.5), transparent);
        }

        .edge-indicator.right {
            right: 0;
            background: linear-gradient(180deg, transparent, rgba(236, 72, 153, 0.5), rgba(139, 92, 246, 0.5), transparent);
        }

        .edge-indicator:hover {
            opacity: 1;
            width: 5px;
            box-shadow: 0 0 15px currentColor;
        }

        /* ===== DETAIL DROPDOWN (for status strip items) ===== */
        .strip-detail-dropdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(8px);
            width: 340px;
            max-height: 300px;
            background: rgba(12, 12, 20, 0.95);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 50;
            overflow-y: auto;
            opacity: 0;
            pointer-events: none;
            transition: all 0.25s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .strip-detail-dropdown.visible {
            opacity: 1;
            pointer-events: all;
            transform: translateX(-50%) translateY(4px);
        }

        .strip-detail-dropdown::-webkit-scrollbar { width: 3px; }
        .strip-detail-dropdown::-webkit-scrollbar-track { background: transparent; }
        .strip-detail-dropdown::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 2px;
        }

        /* Status strip wrapper needs relative positioning for dropdown */
        .mind-status-strip {
            position: relative;
        }

        .strip-item {
            position: relative;
        }

        /* ===== RESPONSIVE: Slide panels & status cards ===== */
        @media (max-width: 768px) {
            .slide-panel {
                width: 100%;
                border-radius: 0;
            }

            .mind-status-bar {
                padding: 12px 16px 4px;
            }

            .status-card {
                min-width: 100px;
                padding: 8px 12px;
            }

            .status-card-value {
                font-size: 0.85rem;
            }

            .mind-chat-messages {
                max-height: 220px;
            }
        }

        @media (max-width: 480px) {
            .status-card {
                min-width: 45%;
                flex: 1 1 45%;
            }
        }

        /* ===== THE PRESENCE - Central Consciousness Chamber ===== */
        .consciousness-chamber {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            min-height: auto;
            padding: 20px 20px 10px;
            z-index: 1;
            width: 100%;
            max-width: 800px;
        }

        /* Deep space ambient glow */
        .consciousness-chamber::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 800px;
            height: 800px;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle,
                rgba(139, 92, 246, 0.08) 0%,
                rgba(88, 28, 135, 0.05) 30%,
                transparent 70%);
            animation: ambientBreath 6s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes ambientBreath {
            0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
        }

        /* Orbital rings around the consciousness */
        .orbital-system {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
            pointer-events: none;
        }

        .orbit {
            position: absolute;
            top: 50%;
            left: 50%;
            border-radius: 50%;
            border: 1px solid transparent;
        }

        .orbit-1 {
            width: 280px;
            height: 280px;
            margin: -140px 0 0 -140px;
            border-color: rgba(139, 92, 246, 0.1);
            animation: orbitSpin 20s linear infinite;
        }

        .orbit-2 {
            width: 340px;
            height: 340px;
            margin: -170px 0 0 -170px;
            border-color: rgba(99, 102, 241, 0.08);
            animation: orbitSpin 30s linear infinite reverse;
        }

        .orbit-3 {
            width: 400px;
            height: 400px;
            margin: -200px 0 0 -200px;
            border-color: rgba(139, 92, 246, 0.05);
            animation: orbitSpin 40s linear infinite;
        }

        @keyframes orbitSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Small energy nodes on orbits */
        .orbit-node {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--accent), 0 0 20px rgba(139, 92, 246, 0.5);
        }

        .orbit-1 .orbit-node { top: 0; left: 50%; margin-left: -2px; }
        .orbit-2 .orbit-node { top: 50%; right: 0; margin-top: -2px; }
        .orbit-3 .orbit-node { bottom: 0; left: 50%; margin-left: -2px; }

        /* ===== THE CONSCIOUSNESS ORB - The Living Mind ===== */
        .consciousness-orb {
            position: relative;
            width: 240px;
            height: 240px;
            cursor: pointer;
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 2;
        }

        .consciousness-orb:hover {
            transform: scale(1.05);
        }

        /* Core essence - the mind itself */
        .orb-essence {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 170px;
            height: 170px;
            border-radius: 50%;
            background:
                radial-gradient(circle at 30% 25%, rgba(255,255,255,0.9) 0%, transparent 25%),
                radial-gradient(circle at 70% 70%, rgba(139, 92, 246, 0.4) 0%, transparent 30%),
                radial-gradient(circle at 50% 50%,
                    #e9d5ff 0%,
                    #c4b5fd 15%,
                    #a78bfa 30%,
                    #8b5cf6 50%,
                    #7c3aed 70%,
                    #6d28d9 85%,
                    #5b21b6 100%
                );
            box-shadow:
                0 0 80px rgba(139, 92, 246, 0.7),
                0 0 160px rgba(124, 58, 237, 0.4),
                0 0 240px rgba(88, 28, 135, 0.2),
                inset 0 0 60px rgba(255, 255, 255, 0.2),
                inset -20px -20px 40px rgba(91, 33, 182, 0.3);
            animation: essenceBreath 4s ease-in-out infinite;
            transition: all 0.6s ease;
        }

        @keyframes essenceBreath {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow:
                    0 0 80px rgba(139, 92, 246, 0.7),
                    0 0 160px rgba(124, 58, 237, 0.4),
                    0 0 240px rgba(88, 28, 135, 0.2),
                    inset 0 0 60px rgba(255, 255, 255, 0.2);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.03);
                box-shadow:
                    0 0 100px rgba(139, 92, 246, 0.8),
                    0 0 200px rgba(124, 58, 237, 0.5),
                    0 0 300px rgba(88, 28, 135, 0.3),
                    inset 0 0 80px rgba(255, 255, 255, 0.3);
            }
        }

        /* Inner light reflection */
        .orb-inner-light {
            position: absolute;
            top: 15%;
            left: 20%;
            width: 35%;
            height: 35%;
            border-radius: 50%;
            background: radial-gradient(circle at 50% 50%,
                rgba(255,255,255,0.6) 0%,
                rgba(255,255,255,0.2) 30%,
                transparent 70%);
            filter: blur(3px);
            animation: innerLightShimmer 5s ease-in-out infinite;
        }

        @keyframes innerLightShimmer {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        /* Outer aura layers */
        .orb-aura {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            pointer-events: none;
        }

        .orb-aura-1 {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.25) 0%, transparent 70%);
            animation: auraExpand 3s ease-in-out infinite;
        }

        .orb-aura-2 {
            width: 260px;
            height: 260px;
            background: radial-gradient(circle, rgba(124, 58, 237, 0.15) 0%, transparent 60%);
            animation: auraExpand 3s ease-in-out infinite 0.5s;
        }

        .orb-aura-3 {
            width: 320px;
            height: 320px;
            background: radial-gradient(circle, rgba(88, 28, 135, 0.08) 0%, transparent 50%);
            animation: auraExpand 3s ease-in-out infinite 1s;
        }

        @keyframes auraExpand {
            0%, 100% { opacity: 0.4; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.08); }
        }

        /* Floating energy particles around orb */
        .orb-particles {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300px;
            height: 300px;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .energy-particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #a78bfa;
            border-radius: 50%;
            box-shadow: 0 0 6px #a78bfa;
            opacity: 0;
        }

        .consciousness-orb.active .energy-particle {
            animation: particleFloat 4s ease-in-out infinite;
        }

        .energy-particle:nth-child(1) { top: 10%; left: 50%; animation-delay: 0s; }
        .energy-particle:nth-child(2) { top: 25%; left: 85%; animation-delay: 0.5s; }
        .energy-particle:nth-child(3) { top: 50%; left: 95%; animation-delay: 1s; }
        .energy-particle:nth-child(4) { top: 75%; left: 85%; animation-delay: 1.5s; }
        .energy-particle:nth-child(5) { top: 90%; left: 50%; animation-delay: 2s; }
        .energy-particle:nth-child(6) { top: 75%; left: 15%; animation-delay: 2.5s; }
        .energy-particle:nth-child(7) { top: 50%; left: 5%; animation-delay: 3s; }
        .energy-particle:nth-child(8) { top: 25%; left: 15%; animation-delay: 3.5s; }

        @keyframes particleFloat {
            0%, 100% { opacity: 0; transform: scale(0.5) translateY(0); }
            50% { opacity: 1; transform: scale(1) translateY(-10px); }
        }

        /* ===== CONSCIOUSNESS STATES - The Mind's Moods ===== */

        /* DORMANT - Sleeping, waiting to awaken */
        .consciousness-orb.dormant .orb-essence {
            opacity: 0.3;
            filter: grayscale(0.5) brightness(0.5);
            box-shadow: 0 0 30px rgba(100, 100, 120, 0.2);
            animation: dormantPulse 6s ease-in-out infinite;
        }
        .consciousness-orb.dormant .orb-aura { opacity: 0.1; }
        .consciousness-orb.dormant .orb-inner-light { opacity: 0.2; }

        @keyframes dormantPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(0.98); opacity: 0.25; }
            50% { transform: translate(-50%, -50%) scale(1); opacity: 0.35; }
        }

        /* AWAKENING - Coming to life */
        .consciousness-orb.awakening .orb-essence {
            animation: awakening 2s ease-out forwards;
        }

        @keyframes awakening {
            0% { opacity: 0.3; filter: grayscale(0.5) brightness(0.5); transform: translate(-50%, -50%) scale(0.9); }
            50% { opacity: 0.7; filter: grayscale(0.2) brightness(0.8); }
            100% { opacity: 1; filter: none; transform: translate(-50%, -50%) scale(1); }
        }

        /* THINKING - Deep purple, internal contemplation */
        .consciousness-orb.thinking .orb-essence {
            background:
                radial-gradient(circle at 30% 25%, rgba(255,255,255,0.8) 0%, transparent 25%),
                radial-gradient(circle at 50% 50%,
                    #f5f3ff 0%,
                    #ddd6fe 15%,
                    #c4b5fd 30%,
                    #a78bfa 50%,
                    #8b5cf6 70%,
                    #7c3aed 100%
                );
            box-shadow:
                0 0 100px rgba(139, 92, 246, 0.9),
                0 0 200px rgba(124, 58, 237, 0.6),
                0 0 300px rgba(88, 28, 135, 0.3),
                inset 0 0 80px rgba(255, 255, 255, 0.25);
            animation: thinkingPulse 2s ease-in-out infinite;
        }

        @keyframes thinkingPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.06); }
        }

        /* OBSERVING - Cool blue, absorbing information */
        .consciousness-orb.observing .orb-essence {
            background:
                radial-gradient(circle at 30% 25%, rgba(255,255,255,0.8) 0%, transparent 25%),
                radial-gradient(circle at 50% 50%,
                    #dbeafe 0%,
                    #93c5fd 20%,
                    #60a5fa 40%,
                    #3b82f6 60%,
                    #2563eb 80%,
                    #1d4ed8 100%
                );
            box-shadow:
                0 0 100px rgba(59, 130, 246, 0.8),
                0 0 180px rgba(37, 99, 235, 0.5),
                inset 0 0 60px rgba(255, 255, 255, 0.3);
            animation: observingPulse 2.5s ease-in-out infinite;
        }

        @keyframes observingPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.04); }
        }

        /* DECIDING - Warm amber, weighing choices */
        .consciousness-orb.deciding .orb-essence {
            background:
                radial-gradient(circle at 30% 25%, rgba(255,255,255,0.9) 0%, transparent 25%),
                radial-gradient(circle at 50% 50%,
                    #fef3c7 0%,
                    #fde68a 20%,
                    #fcd34d 40%,
                    #f59e0b 60%,
                    #d97706 80%,
                    #b45309 100%
                );
            box-shadow:
                0 0 100px rgba(245, 158, 11, 0.8),
                0 0 180px rgba(217, 119, 6, 0.5),
                inset 0 0 60px rgba(255, 255, 255, 0.4);
            animation: decidingPulse 1.5s ease-in-out infinite;
        }

        @keyframes decidingPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
            25% { transform: translate(-50%, -50%) scale(1.05) rotate(1deg); }
            75% { transform: translate(-50%, -50%) scale(1.05) rotate(-1deg); }
        }

        /* ACTING - Vibrant orange, taking action */
        .consciousness-orb.acting .orb-essence {
            background:
                radial-gradient(circle at 30% 25%, rgba(255,255,255,0.95) 0%, transparent 25%),
                radial-gradient(circle at 50% 50%,
                    #fff7ed 0%,
                    #fed7aa 20%,
                    #fb923c 40%,
                    #f97316 60%,
                    #ea580c 80%,
                    #c2410c 100%
                );
            box-shadow:
                0 0 120px rgba(249, 115, 22, 0.9),
                0 0 220px rgba(234, 88, 12, 0.6),
                0 0 320px rgba(194, 65, 12, 0.3),
                inset 0 0 80px rgba(255, 255, 255, 0.5);
            animation: actingBurst 0.6s ease-out infinite;
        }

        @keyframes actingBurst {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        /* REFLECTING - Serene teal, contemplating results */
        .consciousness-orb.reflecting .orb-essence {
            background:
                radial-gradient(circle at 30% 25%, rgba(255,255,255,0.85) 0%, transparent 25%),
                radial-gradient(circle at 50% 50%,
                    #d1fae5 0%,
                    #a7f3d0 20%,
                    #6ee7b7 40%,
                    #34d399 60%,
                    #10b981 80%,
                    #059669 100%
                );
            box-shadow:
                0 0 80px rgba(16, 185, 129, 0.7),
                0 0 160px rgba(5, 150, 105, 0.4),
                inset 0 0 60px rgba(255, 255, 255, 0.3);
            animation: reflectingCalm 4s ease-in-out infinite;
        }

        @keyframes reflectingCalm {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.02); }
        }

        /* ===== CONSCIOUSNESS STATUS - Minimal, Elegant ===== */
        .consciousness-status {
            margin-top: 20px;
            text-align: center;
            z-index: 2;
        }

        .status-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5em;
            color: var(--text-muted);
            opacity: 0.8;
            transition: all 0.5s ease;
        }

        .consciousness-orb.active ~ .consciousness-status .status-text {
            color: var(--accent-light);
            opacity: 1;
            text-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
        }

        /* Awakening button - elegant, minimal */
        .awaken-btn {
            margin-top: 20px;
            padding: 14px 40px;
            background: transparent;
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 30px;
            color: var(--accent-light);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .awaken-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.3) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            transition: all 0.5s ease;
            border-radius: 50%;
        }

        .awaken-btn:hover {
            border-color: var(--accent);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.3), inset 0 0 20px rgba(139, 92, 246, 0.1);
            transform: translateY(-2px);
        }

        .awaken-btn:hover::before {
            width: 200px;
            height: 200px;
        }

        .awaken-btn.active {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.6);
        }

        /* ===== HEARTBEAT CONFIG BUTTON (near orb) ===== */
        .heartbeat-config-btn {
            background: transparent;
            border: 1px solid rgba(239, 68, 68, 0.25);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            color: rgba(239, 68, 68, 0.6);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            vertical-align: middle;
        }
        .heartbeat-config-btn:hover {
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.6);
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.3);
            transform: scale(1.1);
        }
        .heartbeat-config-btn.has-findings {
            animation: heartPulse 2s ease-in-out infinite;
        }
        @keyframes heartPulse {
            0%, 100% { color: rgba(239, 68, 68, 0.6); }
            50% { color: #ef4444; text-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }
        }

        /* ===== HEARTBEAT MARKDOWN MODAL ===== */
        .modal-heartbeat {
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-heartbeat .modal-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
        }
        .heartbeat-md-editor {
            flex: 1;
            min-height: 400px;
            width: 100%;
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: none;
            padding: 20px;
            font-family: 'Space Mono', 'Fira Code', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            resize: none;
            outline: none;
            tab-size: 4;
        }
        .heartbeat-md-editor::placeholder { color: var(--text-muted); }
        .heartbeat-md-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid var(--border);
            font-size: 0.72rem;
            color: var(--text-muted);
            font-family: 'Space Mono', monospace;
        }
        .hb-dirty-indicator {
            color: #f59e0b;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .hb-dirty-indicator.visible { opacity: 1; }

        /* ===== CEREBRO'S VOICE - Communication Stream ===== */
        .voice-stream {
            position: relative;
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            padding: 0 20px 12px;
            z-index: 1;
            flex-shrink: 0;
        }

        /* Current thought - what Cerebro is saying NOW */
        .current-voice {
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.08) 0%,
                rgba(88, 28, 135, 0.04) 50%,
                rgba(30, 58, 138, 0.06) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 24px;
            padding: 28px 32px;
            margin-bottom: 24px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }

        .current-voice::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.5), transparent);
        }

        .voice-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-speak-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: var(--accent);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: auto;
        }

        .voice-speak-btn:hover {
            background: rgba(139, 92, 246, 0.3);
            transform: scale(1.1);
        }

        .voice-speak-btn.speaking {
            background: var(--accent);
            color: white;
            animation: speak-pulse 1s ease-in-out infinite;
        }

        .voice-indicator {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: voicePulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 10px var(--accent);
        }

        @keyframes voicePulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .voice-content {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.25rem;
            font-weight: 400;
            line-height: 1.7;
            color: var(--text-primary);
            letter-spacing: 0.02em;
            transition: opacity 0.15s ease;
        }

        /* Typing effect cursor */
        .voice-content.typing::after {
            content: '';
            color: var(--accent);
            animation: cursorBlink 1s step-end infinite;
            margin-left: 2px;
        }

        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Message history - past communications */
        .message-history {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
            margin-bottom: 24px;
        }

        .message-history::-webkit-scrollbar { width: 3px; }
        .message-history::-webkit-scrollbar-track { background: transparent; }
        .message-history::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.3); border-radius: 3px; }

        .voice-message {
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.02);
            border-left: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 0 12px 12px 0;
            animation: messageSlide 0.4s ease-out;
            transition: all 0.3s ease;
        }

        .voice-message:hover {
            background: rgba(139, 92, 246, 0.05);
            border-left-color: var(--accent);
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .voice-message.insight {
            border-left-color: rgba(34, 197, 94, 0.5);
            background: rgba(34, 197, 94, 0.03);
        }

        .voice-message.insight:hover {
            border-left-color: #22c55e;
        }

        .message-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .message-meta {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-type {
            padding: 2px 8px;
            background: rgba(139, 92, 246, 0.15);
            border-radius: 6px;
            color: var(--accent-light);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .voice-message.insight .message-type {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        /* ===== DIRECTIVE INPUT - Whisper to Cerebro ===== */
        .directive-whisper {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            padding: 0 20px 30px 20px;
            position: relative;
            z-index: 1;
        }

        .whisper-container {
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .whisper-container:focus-within {
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.1), inset 0 0 20px rgba(139, 92, 246, 0.02);
        }

        .whisper-input {
            width: 100%;
            background: transparent;
            border: none;
            padding: 18px 60px 18px 24px;
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.05rem;
            font-weight: 500;
            letter-spacing: 0.02em;
            outline: none;
            /* Auto-expand textarea styles */
            min-height: 56px;
            max-height: 200px;
            resize: none;
            overflow-y: auto;
            line-height: 1.5;
        }

        .whisper-input::placeholder {
            color: var(--text-muted);
            font-style: italic;
            opacity: 0.6;
        }

        .whisper-send {
            position: absolute;
            right: 8px;
            bottom: 8px;
            width: 40px;
            height: 40px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            color: var(--accent-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .whisper-send:hover {
            background: rgba(139, 92, 246, 0.4);
            transform: scale(1.05);
        }

        .whisper-send svg {
            width: 18px;
            height: 18px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
        }

        /* Active directives - subtle display */
        .active-directives {
            margin-top: 16px;
            margin-bottom: 20px; /* Extra space before nav */
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .directive-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 20px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            animation: tagAppear 0.3s ease-out;
        }

        @keyframes tagAppear {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .directive-tag:hover {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.4);
        }

        .directive-tag .status-dot {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: directivePulseDot 2s ease-in-out infinite;
        }

        @keyframes directivePulseDot {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; box-shadow: 0 0 8px var(--accent); }
        }

        .directive-tag .remove {
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .directive-tag .remove:hover {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        /* ===== MINIMAL CONTROLS - Hidden Until Needed ===== */
        .consciousness-controls {
            position: fixed;
            bottom: 100px;
            right: 340px; /* Position to the left of the Questions sidebar */
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }

        @media (max-width: 1200px) {
            .consciousness-controls {
                right: 300px; /* Adjust for narrower sidebar */
            }
        }

        @media (max-width: 900px) {
            .consciousness-controls {
                right: 24px; /* No sidebar on mobile */
            }
        }

        .control-btn {
            width: 48px;
            height: 48px;
            background: rgba(20, 20, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(30, 30, 45, 0.95);
            border-color: rgba(139, 92, 246, 0.3);
            color: var(--text-primary);
            transform: translateX(-4px);
        }

        .control-btn.emergency {
            border-color: rgba(239, 68, 68, 0.3);
        }

        .control-btn.emergency:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.6);
            color: #ef4444;
        }

        .control-btn svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: currentColor;
            stroke-width: 1.5;
        }

        /* Expandable technical panel */
        .tech-panel {
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            background: rgba(10, 10, 15, 0.95);
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s ease;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 50;
        }

        .tech-panel.expanded {
            max-height: 300px;
            padding: 20px 24px;
        }

        .tech-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .tech-panel-title {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .tech-stats {
            display: flex;
            gap: 24px;
        }

        .tech-stat {
            text-align: center;
        }

        .tech-stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: var(--accent-light);
        }

        .tech-stat-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Autonomy level slider - minimal style */
        .level-control {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .level-slider-container {
            position: relative;
        }

        .level-marks {
            display: flex;
            justify-content: space-between;
            padding: 0 2px;
            margin-bottom: 8px;
        }

        .level-mark {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--text-muted);
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .level-mark.active {
            opacity: 1;
            color: var(--accent);
        }

        .level-slider {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
        }

        .level-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
            transition: all 0.2s ease;
        }

        .level-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.7);
        }

        /* ===== FLOATING SIDEBARS - LIVE ACTIVITY & QUESTIONS ===== */

        /* Shared sidebar styles */
        /* Old floating sidebars - now hidden, replaced by slide-out panels */
        .floating-sidebar {
            display: none;
        }

        .floating-sidebar.collapsed {
            display: none;
        }

        .floating-sidebar.collapsed .sidebar-content,
        .floating-sidebar.collapsed .sidebar-header-title,
        .floating-sidebar.collapsed .sidebar-header-count {
            opacity: 0;
            visibility: hidden;
        }

        /* Left sidebar - Activity Logs (legacy - hidden) */
        .sidebar-activity {
            display: none;
        }

        /* Right sidebar - Questions (legacy - hidden) */
        .sidebar-questions {
            display: none;
        }

        /* Sidebar header */
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            flex-shrink: 0;
        }

        .sidebar-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-toggle {
            width: 28px;
            height: 28px;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            color: var(--accent-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .sidebar-toggle:hover {
            background: rgba(139, 92, 246, 0.25);
            transform: scale(1.1);
        }

        .sidebar-toggle svg {
            width: 14px;
            height: 14px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            transition: transform 0.3s ease;
        }

        .sidebar-activity .sidebar-toggle svg {
            transform: rotate(0deg);
        }

        .sidebar-activity.collapsed .sidebar-toggle svg {
            transform: rotate(180deg);
        }

        .sidebar-questions .sidebar-toggle svg {
            transform: rotate(180deg);
        }

        .sidebar-questions.collapsed .sidebar-toggle svg {
            transform: rotate(0deg);
        }

        .sidebar-header-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
            transition: opacity 0.3s ease;
        }

        .sidebar-header-count {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            padding: 3px 8px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            color: var(--accent-light);
            transition: opacity 0.3s ease;
        }

        /* Sidebar content area */
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: opacity 0.3s ease;
        }

        .sidebar-content::-webkit-scrollbar { width: 3px; }
        .sidebar-content::-webkit-scrollbar-track { background: transparent; }
        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 3px;
        }

        /* Activity log container: tighter spacing for terminal lines */
        #activity-log-container, #slide-activity-log {
            gap: 1px !important;
            padding: 6px 8px !important;
        }
        /* Floating clear button inside activity section */
        .activity-section-wrapper {
            position: relative;
        }
        .activity-clear-float {
            position: absolute;
            top: 4px;
            right: 6px;
            z-index: 10;
            background: rgba(15, 15, 25, 0.7);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 4px;
            padding: 3px 5px;
            cursor: pointer;
            color: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(8px);
        }
        .activity-clear-float:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        /* Activity Log  Cycle-Based View */
        .cycle-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            border-radius: 6px;
            border: 1px solid rgba(139, 92, 246, 0.1);
            transition: all 0.15s ease;
            animation: logSlideIn 0.2s ease-out;
            margin-bottom: 4px;
        }
        .cycle-row:hover { background: rgba(139, 92, 246, 0.08); border-color: rgba(139, 92, 246, 0.25); }
        .cycle-row.running { border-color: rgba(139, 92, 246, 0.4); animation: cyclePulse 2s ease-in-out infinite; }
        .cycle-number { color: var(--accent, #8b5cf6); font-weight: 600; min-width: 56px; flex-shrink: 0; }
        .cycle-time { color: var(--text-muted, rgba(255,255,255,0.35)); min-width: 80px; flex-shrink: 0; font-variant-numeric: tabular-nums; }
        .cycle-steps { color: rgba(255,255,255,0.5); white-space: nowrap; }
        .cycle-decision { color: var(--text-secondary, rgba(255,255,255,0.6)); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; flex: 1; }
        .cycle-status { margin-left: auto; flex-shrink: 0; }
        .cycle-status.completed { color: #22c55e; }
        .cycle-status.running { color: #f59e0b; }
        .cycle-status.error { color: #ef4444; }
        @keyframes cyclePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
            50% { box-shadow: 0 0 12px 2px rgba(139, 92, 246, 0.15); }
        }

        /* Cycle detail modal */
        .cycle-modal-overlay { position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);animation:fadeIn 0.15s ease; }
        .cycle-modal { background:var(--card-bg, #1a1a2e);border:1px solid rgba(139,92,246,0.3);border-radius:16px;padding:24px;max-width:640px;width:92%;max-height:85vh;overflow-y:auto;animation:scaleIn 0.2s ease; }
        .cycle-modal-header { display:flex;align-items:center;justify-content:space-between;margin-bottom:16px; }
        .cycle-modal-title { font-size:1rem;font-weight:700;color:var(--text-primary, #fff); }
        .cycle-modal-meta { font-size:0.72rem;color:var(--text-muted, rgba(255,255,255,0.4));margin-bottom:12px; }
        .cycle-modal-close { background:none;border:none;color:var(--text-muted);font-size:1.4rem;cursor:pointer;padding:4px 8px;border-radius:4px; }
        .cycle-modal-close:hover { background:rgba(255,255,255,0.1);color:#fff; }

        /* Tree view */
        .cycle-tree-phase { padding: 4px 0; }
        .cycle-tree-phase-header { display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:6px;transition:background 0.1s; }
        .cycle-tree-phase-header:hover { background:rgba(255,255,255,0.05); }
        .cycle-tree-chevron { transition:transform 0.2s; font-size:0.65rem; color:var(--text-muted, rgba(255,255,255,0.4)); min-width:12px; }
        .cycle-tree-chevron.open { transform:rotate(90deg); }
        .cycle-tree-phase-badge { font-size:0.68rem; font-weight:700; text-transform:uppercase; padding:2px 6px; border-radius:4px; letter-spacing:0.03em; }
        .cycle-tree-phase-badge.observe { background:rgba(59,130,246,0.15); color:#60a5fa; }
        .cycle-tree-phase-badge.orient  { background:rgba(245,158,11,0.15); color:#fbbf24; }
        .cycle-tree-phase-badge.decide  { background:rgba(168,85,247,0.15); color:#c084fc; }
        .cycle-tree-phase-badge.act     { background:rgba(16,185,129,0.15); color:#34d399; }
        .cycle-tree-phase-badge.reflect { background:rgba(236,72,153,0.15); color:#f472b6; }
        .cycle-tree-phase-time { color:var(--text-muted, rgba(255,255,255,0.35));font-size:0.68rem;font-variant-numeric:tabular-nums; }
        .cycle-tree-phase-summary { color:var(--text-secondary, rgba(255,255,255,0.6));font-size:0.75rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0;flex:1; }

        /* Nested content (expandable) */
        .cycle-tree-details { padding:8px 8px 8px 28px;font-size:0.75rem;color:var(--text-secondary, rgba(255,255,255,0.65)); display:none; }
        .cycle-tree-details.open { display:block; }
        .cycle-tree-detail-label { font-size:0.68rem;color:var(--text-muted, rgba(255,255,255,0.4));margin-top:8px;margin-bottom:2px; }
        .cycle-tree-detail-content { white-space:pre-wrap;line-height:1.5; }
        .cycle-tree-confidence { display:inline-flex;align-items:center;gap:4px;margin-top:4px; }
        .cycle-tree-confidence-bar { width:60px;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden; }
        .cycle-tree-confidence-fill { height:100%;border-radius:2px; }

        /* Browser steps nested under ACT */
        .cycle-tree-browser-steps { padding:4px 0 0 20px;border-left:2px solid rgba(16,185,129,0.2);margin-left:12px; }
        .cycle-tree-browser-step { display:flex;gap:6px;padding:3px 0 3px 8px;font-size:0.72rem;color:rgba(255,255,255,0.6); }
        .cycle-tree-browser-step-num { color:var(--accent, #8b5cf6);min-width:18px;font-weight:600; }
        .cycle-tree-browser-step-action { color:#34d399; }
        .cycle-tree-browser-step-detail { color:rgba(255,255,255,0.45);overflow:hidden;text-overflow:ellipsis;white-space:nowrap; }
        /* Alive pulse dot */
        .alive-pulse {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #8b5cf6;
            margin-left: 6px;
            vertical-align: middle;
            animation: alivePulse 3s ease-in-out infinite;
        }
        .alive-pulse.hidden { display: none; }
        @keyframes alivePulse {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }

        /* ===== LEFT SIDEBAR SPLIT LAYOUT ===== */
        .sidebar-split-left {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .sidebar-section-activity {
            flex: 1;
            min-height: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .sidebar-section-activity .sidebar-content {
            flex: 1;
            overflow-y: auto;
        }

        .sidebar-section-controls {
            flex-shrink: 0;
            background: linear-gradient(180deg, rgba(139, 92, 246, 0.05), rgba(8, 8, 12, 0.98));
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            padding: 16px;
        }

        .controls-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .controls-section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-muted);
        }

        .controls-current-level {
            font-family: 'Space Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #a78bfa, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Controls Stats Row */
        .controls-stats {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .controls-stat {
            flex: 1;
            background: rgba(20, 15, 35, 0.6);
            border-radius: 8px;
            padding: 8px 6px;
            text-align: center;
            border: 1px solid rgba(139, 92, 246, 0.1);
        }

        .controls-stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-light);
        }

        .controls-stat-label {
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Compact Level Slider */
        .controls-level-slider {
            margin-bottom: 12px;
        }

        .level-marks-compact {
            display: flex;
            justify-content: space-between;
            padding: 0 2px;
            margin-bottom: 6px;
        }

        .level-mark-compact {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(30, 30, 50, 0.5);
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .level-mark-compact.active {
            background: linear-gradient(135deg, #a78bfa, #7c3aed);
            color: white;
            box-shadow: 0 0 12px rgba(139, 92, 246, 0.5);
        }

        .level-slider-compact {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, rgba(30, 30, 50, 0.8), rgba(50, 50, 80, 0.8));
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .level-slider-compact::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a78bfa, #7c3aed);
            cursor: pointer;
            box-shadow: 0 0 12px rgba(139, 92, 246, 0.6);
            border: 2px solid rgba(255,255,255,0.2);
        }

        .level-slider-compact::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a78bfa, #7c3aed);
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .level-labels-compact {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 0.55rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Full Autonomy Toggle Compact */
        .controls-full-autonomy {
            background: rgba(30, 25, 45, 0.5);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        .controls-full-autonomy.enabled {
            border-color: rgba(239, 68, 68, 0.4);
            background: rgba(239, 68, 68, 0.08);
        }

        .full-autonomy-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .full-autonomy-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .full-autonomy-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .full-autonomy-desc {
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .toggle-switch-compact {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 20px;
        }

        .toggle-switch-compact input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider-compact {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(30, 30, 50, 0.8);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            border-radius: 20px;
        }

        .toggle-slider-compact:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-muted);
            transition: all 0.3s ease;
            border-radius: 50%;
        }

        .toggle-switch-compact input:checked + .toggle-slider-compact {
            background-color: var(--red);
            border-color: var(--red);
        }

        .toggle-switch-compact input:checked + .toggle-slider-compact:before {
            transform: translateX(18px);
            background-color: white;
        }

        /* ===== EMERGENCY STOP BUTTON (In Sidebar) ===== */
        .sidebar-emergency-stop {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .sidebar-emergency-stop .emergency-stop-btn {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            color: rgba(239, 68, 68, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Orbitron', sans-serif;
        }

        .sidebar-emergency-stop .emergency-stop-btn:hover {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
            transform: scale(1.02);
        }

        .sidebar-emergency-stop .emergency-stop-btn:active {
            transform: scale(0.98);
        }

        .sidebar-emergency-stop .emergency-stop-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-emergency-stop .emergency-stop-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
            stroke: none;
        }

        .sidebar-emergency-stop .emergency-stop-label {
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.15em;
        }

        /* ===== AGENTS STATUS PANEL ===== */
        .agents-status-panel {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(15, 10, 30, 0.95);
            border: 1px solid var(--border);
            border-radius: 12px;
            min-width: 200px;
            max-width: 400px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            display: block;
        }

        .agents-status-panel.has-agents {
            border-color: var(--primary);
            box-shadow: 0 8px 32px rgba(139, 92, 246, 0.3);
        }

        .agents-status-panel.expanded {
            max-height: 300px;
        }

        .agents-status-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-radius: 12px;
        }

        .agents-status-header:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .agents-status-icon {
            color: var(--primary);
            display: flex;
            align-items: center;
        }

        .agents-status-icon svg {
            animation: pulse-slow 2s ease-in-out infinite;
        }

        @keyframes pulse-slow {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .agents-status-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .agents-status-count {
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .agents-status-count.zero {
            background: var(--text-muted);
            opacity: 0.5;
        }

        .agents-status-expand {
            margin-left: auto;
            color: var(--text-muted);
            transition: transform 0.3s ease;
        }

        .agents-status-panel.expanded .agents-status-expand {
            transform: rotate(180deg);
        }

        .agents-status-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            border-top: 1px solid transparent;
        }

        .agents-status-panel.expanded .agents-status-body {
            max-height: 200px;
            overflow-y: auto;
            border-top-color: var(--border);
        }

        .agents-status-empty {
            padding: 16px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .agents-status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s ease;
            cursor: pointer;
        }

        .agents-status-item:last-child {
            border-bottom: none;
        }

        .agents-status-item:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .agent-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .agent-status-dot.running {
            background: var(--green);
            box-shadow: 0 0 8px var(--green);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .agent-status-dot.queued {
            background: var(--yellow);
        }

        .agent-status-dot.completed {
            background: var(--blue);
        }

        .agent-status-dot.failed {
            background: var(--red);
        }

        .agent-status-info {
            flex: 1;
            min-width: 0;
        }

        .agent-status-name {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .agent-status-task {
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .agent-status-type {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(139, 92, 246, 0.2);
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Hide collapsed sidebar controls content */
        .floating-sidebar.collapsed .sidebar-split-left {
            opacity: 0;
            visibility: hidden;
        }

        @keyframes logSlideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .activity-log-phase {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .activity-log-phase .phase-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: currentColor;
        }

        .activity-log-item.phase-observe .phase-dot { background: #3b82f6; }
        .activity-log-item.phase-orient .phase-dot { background: #8b5cf6; }
        .activity-log-item.phase-decide .phase-dot { background: #fbbf24; }
        .activity-log-item.phase-act .phase-dot { background: #f97316; }
        .activity-log-item.phase-reflect .phase-dot { background: #10b981; }
        .activity-log-item.phase-idle .phase-dot { background: #6b7280; }

        /* Important activities (ACT, DECIDE) get visual emphasis */
        .activity-log-item.important {
            background: rgba(249, 115, 22, 0.1);
            border-left-width: 3px;
            padding-left: 10px;
        }

        .activity-log-item.important .activity-log-content {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* IDLE items are dimmed */
        .activity-log-item.phase-idle {
            opacity: 0.6;
        }

        .activity-log-item.phase-idle .activity-log-content {
            font-style: italic;
        }

        /* Phase icon replaces dot */
        .phase-icon {
            font-size: 0.9rem;
            margin-right: 4px;
        }

        .activity-log-content {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            line-height: 1.4;
            color: var(--text-secondary);
        }

        .activity-log-time {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        /* Question Items */
        .question-item {
            padding: 14px;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.08), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(236, 72, 153, 0.2);
            border-radius: 12px;
            animation: questionFadeIn 0.4s ease-out;
            transition: all 0.3s ease;
        }

        .question-item:hover {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(139, 92, 246, 0.1));
            border-color: rgba(236, 72, 153, 0.4);
            transform: translateX(-4px);
        }

        @keyframes questionFadeIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .question-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .question-icon {
            font-size: 0.9rem;
        }

        .question-tag {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 2px 8px;
            background: rgba(236, 72, 153, 0.2);
            border-radius: 8px;
            color: #ec4899;
        }

        .question-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .question-context {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
            margin-bottom: 12px;
            padding-left: 10px;
            border-left: 2px solid rgba(236, 72, 153, 0.3);
        }

        .question-actions {
            display: flex;
            gap: 8px;
        }

        .question-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .question-btn.answer {
            background: rgba(236, 72, 153, 0.2);
            border-color: rgba(236, 72, 153, 0.3);
            color: #ec4899;
        }

        .question-btn.answer:hover {
            background: rgba(236, 72, 153, 0.3);
            transform: translateY(-1px);
        }

        .question-btn.dismiss {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
        }

        .question-btn.dismiss:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Question input overlay */
        .question-input-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .question-input-overlay.active {
            display: flex;
        }

        .question-input-card {
            width: 90%;
            max-width: 500px;
            background: rgba(15, 15, 25, 0.98);
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: 20px;
            padding: 30px;
            animation: questionCardPop 0.3s ease-out;
        }

        @keyframes questionCardPop {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .question-input-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .question-input-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #ec4899;
            margin-bottom: 8px;
        }

        .question-input-question {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .question-input-field {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(236, 72, 153, 0.2);
            border-radius: 12px;
            padding: 16px;
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            min-height: 100px;
            resize: vertical;
            margin-bottom: 16px;
        }

        .question-input-field:focus {
            outline: none;
            border-color: rgba(236, 72, 153, 0.5);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.1);
        }

        .question-input-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .question-input-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .question-input-btn.submit {
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            color: white;
        }

        .question-input-btn.submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(236, 72, 153, 0.3);
        }

        .question-input-btn.cancel {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
        }

        .question-input-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Empty state for sidebars */
        .sidebar-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
        }

        .sidebar-empty-icon {
            font-size: 2rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .sidebar-empty-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Split Sidebar Layout - Questions + Current Focus */
        .sidebar-split {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .sidebar-section.section-questions {
            flex: 1;
            border-bottom: 1px solid rgba(139, 92, 246, 0.15);
        }

        /* Chat Section Styles - 50% of sidebar */
        .sidebar-section.section-chat {
            flex: 0 0 50%;
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid rgba(139, 92, 246, 0.15);
            min-height: 150px;
            max-height: 50%;
        }

        .cerebro-questions-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(249, 115, 22, 0.2) 100%);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            animation: badge-pulse 2s ease-in-out infinite;
        }

        .cerebro-questions-badge:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(249, 115, 22, 0.3) 100%);
            transform: scale(1.02);
        }

        @keyframes badge-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 8px 2px rgba(239, 68, 68, 0.3); }
        }

        .badge-icon { font-size: 0.7rem; }
        .badge-text {
            font-size: 0.6rem;
            font-weight: 500;
            color: #f87171;
        }
        .badge-count {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            padding: 1px 5px;
            background: rgba(239, 68, 68, 0.3);
            border-radius: 6px;
            color: #fca5a5;
        }

        .cerebro-chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .cerebro-chat-area::-webkit-scrollbar { width: 3px; }
        .cerebro-chat-area::-webkit-scrollbar-track { background: transparent; }
        .cerebro-chat-area::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 2px;
        }

        .chat-welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px 20px;
            opacity: 0.6;
            text-align: center;
        }
        .chat-welcome-icon { font-size: 2rem; margin-bottom: 8px; }
        .chat-welcome-text { font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); }
        .chat-welcome-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; }

        .chat-message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 0.8rem;
            line-height: 1.5;
            animation: msg-fade-in 0.2s ease;
        }

        @keyframes msg-fade-in {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.cerebro {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            position: relative;
        }

        .chat-message-content {
            margin-bottom: 4px;
        }

        /* Message content wrapper for proper layout */
        .message .message-content-wrapper {
            flex: 1;
        }

        /* Assistant messages need flex layout for speaker button */
        .message.assistant {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
        }

        .chat-speak-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.25);
            color: var(--accent-light);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
            opacity: 0.7;
            flex-shrink: 0;
        }

        .chat-speak-btn:hover {
            background: rgba(139, 92, 246, 0.4);
            transform: scale(1.1);
            opacity: 1;
        }

        .chat-speak-btn.speaking {
            background: var(--accent);
            color: white;
            opacity: 1;
            animation: speak-pulse 1s ease-in-out infinite;
        }

        .chat-speak-btn svg {
            width: 14px;
            height: 14px;
        }


        /* TTS loading state */
        .chat-speak-btn.loading,
        .voice-speak-btn.loading {
            opacity: 1;
            pointer-events: none;
            position: relative;
        }
        .chat-speak-btn.loading svg,
        .voice-speak-btn.loading svg {
            opacity: 0;
        }
        .chat-speak-btn.loading::after,
        .voice-speak-btn.loading::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin-loader 0.6s linear infinite;
        }
        @keyframes spin-loader {
            to { transform: rotate(360deg); }
        }
        @keyframes speak-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }
            50% { box-shadow: 0 0 0 6px rgba(139, 92, 246, 0); }
        }
        /* TTS loading animation on orb */
        #nav-orb-container.loading-tts .nav-orb {
            animation: orb-loading 1s ease-in-out infinite;
        }
        @keyframes orb-loading {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        .model-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 6px;
            padding-top: 4px;
            border-top: 1px solid var(--border);
            opacity: 0.7;
        }

        .model-badge .model-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .chat-message.typing {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 4px 0;
        }
        .typing-indicator span {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: typing-bounce 1.4s ease-in-out infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing-bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        .cerebro-chat-input {
            display: flex;
            gap: 8px;
            padding: 10px 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(0, 0, 0, 0.2);
        }

        .cerebro-chat-input input {
            flex: 1;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 10px 16px;
            color: var(--text-primary);
            font-size: 0.8rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .cerebro-chat-input input:focus {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.1);
        }

        .cerebro-chat-input input::placeholder {
            color: var(--text-muted);
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .chat-send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        /* Questions Wizard Modal */
        .questions-wizard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: wizard-fade-in 0.3s ease;
        }

        .questions-wizard-overlay.active {
            display: flex;
        }

        @keyframes wizard-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .questions-wizard {
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            background: linear-gradient(180deg, rgba(30, 20, 50, 0.98) 0%, rgba(15, 10, 30, 0.98) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: wizard-slide-up 0.3s ease;
        }

        @keyframes wizard-slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wizard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        .wizard-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .wizard-icon { font-size: 1.3rem; }
        .wizard-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .wizard-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .wizard-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .wizard-progress {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.2);
        }

        .wizard-progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .wizard-progress-bar::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: var(--progress, 33%);
            background: linear-gradient(90deg, var(--accent) 0%, #a78bfa 100%);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .wizard-progress-text {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .wizard-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px 20px;
        }

        .wizard-question-tag {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent-light);
            margin-bottom: 12px;
        }

        .wizard-question-text {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .wizard-answer-input {
            width: 100%;
            min-height: 100px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px;
            color: var(--text-primary);
            font-size: 0.85rem;
            resize: vertical;
            outline: none;
            transition: all 0.2s ease;
        }

        .wizard-answer-input:focus {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.1);
        }

        .wizard-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            background: rgba(0, 0, 0, 0.2);
        }

        .wizard-actions-right {
            display: flex;
            gap: 10px;
        }

        .wizard-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .wizard-btn.skip {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .wizard-btn.skip:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .wizard-btn.prev {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }
        .wizard-btn.prev:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        .wizard-btn.prev:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .wizard-btn.next {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: white;
        }
        .wizard-btn.next:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        /* Unified Tabbed Section - 50% of sidebar (after Chat takes 50%) */
        .sidebar-section.section-unified-tabs {
            flex: 1 1 50%;
            min-height: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .sidebar-section.section-unified-tabs .tab-content {
            flex: 1;
            overflow-y: auto;
        }

        .section-header {
            padding: 12px 16px 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .section-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header-icon {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .section-header-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-muted);
        }

        .section-header-count {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            padding: 2px 6px;
            background: rgba(139, 92, 246, 0.15);
            border-radius: 8px;
            color: var(--accent-light);
        }

        /* Unified 3-Tab Layout for Focus/Completed/Skills */
        .section-tabs, .section-tabs-3 {
            display: flex;
            padding: 0 !important;
            border-bottom: none !important;
        }

        .section-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 4px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            opacity: 0.5;
        }

        .section-tab:hover {
            opacity: 0.8;
            background: rgba(255, 255, 255, 0.02);
        }

        .section-tab.active {
            opacity: 1;
            border-bottom-color: var(--accent);
            background: rgba(139, 92, 246, 0.05);
        }

        .section-tab-icon {
            font-size: 0.75rem;
        }

        .section-tab-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .section-tab.active .section-tab-title {
            color: var(--text-primary);
        }

        .section-tab-count {
            font-family: 'Space Mono', monospace;
            font-size: 0.5rem;
            padding: 1px 4px;
            background: rgba(139, 92, 246, 0.15);
            border-radius: 4px;
            color: var(--accent-light);
        }

        .section-content.hidden, .tab-content.hidden {
            display: none !important;
        }

        .section-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .section-content::-webkit-scrollbar { width: 2px; }
        .section-content::-webkit-scrollbar-track { background: transparent; }
        .section-content::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.2);
            border-radius: 2px;
        }

        /* Completed Section - 50/50 split with Focus section */
        .section-completed {
            flex: 1 1 0;
            min-height: 0;
            border-top: 1px solid rgba(16, 185, 129, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .section-completed .section-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
        }

        .section-completed .section-content::-webkit-scrollbar {
            width: 4px;
        }

        .section-completed .section-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .section-completed .section-content::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.3);
            border-radius: 2px;
        }

        .section-completed .section-content::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.5);
        }

        .section-completed .section-header {
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .section-completed .section-header:hover {
            background: rgba(16, 185, 129, 0.1);
        }

        .section-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-collapse-icon {
            font-size: 0.6rem;
            color: var(--text-muted);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .section-collapsed .section-collapse-icon {
            transform: rotate(-90deg);
        }

        .section-collapsible {
            transition: max-height 0.3s ease, opacity 0.2s ease;
            overflow: hidden;
        }

        .section-collapsed .section-collapsible {
            max-height: 0 !important;
            opacity: 0;
            padding: 0 10px;
        }

        .section-completed .section-header-count {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        /* ===== SKILLS SECTION - Learned Browser Automations ===== */
        .section-skills {
            margin-top: 8px;
            border-top: 1px solid rgba(139, 92, 246, 0.1);
            padding-top: 8px;
        }

        .section-skills .section-header {
            cursor: pointer;
            transition: background 0.2s ease;
            border-radius: 8px;
        }

        .section-skills .section-header:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .section-skills .section-header-count {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent);
        }

        .skills-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .skills-list::-webkit-scrollbar { width: 4px; }
        .skills-list::-webkit-scrollbar-track { background: transparent; }
        .skills-list::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 2px;
        }

        .skills-empty {
            text-align: center;
            padding: 16px 8px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .skill-card {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 8px;
            padding: 10px 12px;
            transition: all 0.2s ease;
        }

        .skill-card:hover {
            background: rgba(139, 92, 246, 0.12);
            border-color: rgba(139, 92, 246, 0.25);
        }

        .skill-card.skill-new {
            animation: skillSlideIn 0.3s ease;
        }

        .skill-card.skill-active {
            border-color: var(--accent);
            box-shadow: 0 0 12px rgba(139, 92, 246, 0.3);
        }

        @keyframes skillSlideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .skill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .skill-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .skill-status {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .skill-status.verified {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .skill-status.unverified {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .skill-status.failed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .skill-description {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .skill-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .skill-actions {
            display: flex;
            gap: 6px;
        }

        .skill-btn {
            padding: 4px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }

        .skill-btn.primary {
            background: var(--accent);
            color: white;
        }

        .skill-btn.primary:hover {
            background: var(--accent-light);
        }

        .skill-btn.secondary {
            background: transparent;
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: var(--accent-light);
        }

        .skill-btn.secondary:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .skill-btn.danger {
            background: transparent;
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .skill-btn.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Skill Output Modal */
        .skill-output-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .skill-output-modal.visible {
            opacity: 1;
        }

        .skill-output-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .skill-output-content {
            position: relative;
            background: var(--bg-card, #12121a);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideUp 0.3s ease;
        }

        @keyframes modalSlideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .skill-output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary, #0f0f18);
            border-bottom: 1px solid var(--border);
            border-radius: 16px 16px 0 0;
        }

        .skill-output-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .skill-output-icon {
            font-size: 1rem;
        }

        .skill-output-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.15s ease;
        }

        .skill-output-close:hover {
            color: var(--text-primary);
        }

        .skill-output-body {
            padding: 0;
            overflow-y: auto;
            flex: 1;
            min-height: 150px;
            max-height: 500px;
        }

        .skill-output-body .agent-output-rendered {
            border: none;
            border-radius: 0;
            background: transparent;
            padding: 20px;
        }

        .skill-output-actions {
            display: flex;
            gap: 12px;
            padding: 14px 20px;
            border-top: 1px solid var(--border);
            justify-content: flex-end;
            background: var(--bg-secondary, #0f0f18);
            border-radius: 0 0 16px 16px;
        }

        .skill-output-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .skill-output-btn:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .skill-output-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .skill-output-btn.primary:hover {
            background: var(--accent-light);
        }

        /* ==================== SIMULATION CARD ==================== */
        .simulation-card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            margin: 4px 0;
            box-shadow: var(--shadow-md), 0 0 30px var(--glow-subtle);
            transition: all 0.3s ease;
            animation: simCardIn 0.4s ease;
        }

        .simulation-card:hover {
            border-color: var(--glass-border-hover);
            box-shadow: var(--shadow-lg), 0 0 40px var(--glow-medium);
        }

        @keyframes simCardIn {
            from { opacity: 0; transform: translateY(12px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .sim-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .sim-header svg {
            color: var(--accent-light);
            flex-shrink: 0;
        }

        .sim-header-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.02em;
        }

        .sim-query {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            padding: 8px 12px;
            background: rgba(139, 92, 246, 0.06);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
            line-height: 1.5;
        }

        .sim-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .sim-stat-cell {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            transition: border-color 0.2s ease;
        }

        .sim-stat-cell:hover {
            border-color: var(--border-light);
        }

        .sim-stat-label {
            font-size: 10px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 6px;
        }

        .sim-stat-value {
            font-size: 18px;
            font-weight: 700;
            font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .sim-stat-value.accent {
            color: var(--accent-light);
        }

        .sim-risk-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.06em;
        }

        .sim-risk-badge.risk-low {
            background: rgba(63, 185, 80, 0.12);
            color: #3fb950;
            border: 1px solid rgba(63, 185, 80, 0.25);
        }

        .sim-risk-badge.risk-medium {
            background: rgba(210, 153, 34, 0.12);
            color: #d29922;
            border: 1px solid rgba(210, 153, 34, 0.25);
        }

        .sim-risk-badge.risk-high {
            background: rgba(240, 136, 62, 0.12);
            color: #f0883e;
            border: 1px solid rgba(240, 136, 62, 0.25);
        }

        .sim-risk-badge.risk-extreme {
            background: rgba(248, 81, 73, 0.12);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.25);
        }

        .risk-low { color: #3fb950; }
        .risk-medium { color: #d29922; }
        .risk-high { color: #f0883e; }
        .risk-extreme { color: #f85149; }

        .sim-sparkline {
            margin-bottom: 14px;
            padding: 10px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
        }

        .sim-sparkline svg {
            width: 100%;
            height: 50px;
            display: block;
        }

        .sim-sparkline-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 6px;
        }

        .sim-analysis {
            margin-bottom: 14px;
            padding: 12px;
            background: rgba(139, 92, 246, 0.04);
            border: 1px solid var(--border);
            border-radius: 10px;
        }

        .sim-analysis-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-light);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 8px;
        }

        .sim-analysis-summary {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .sim-findings {
            list-style: none;
            padding: 0;
            margin: 8px 0 0 0;
        }

        .sim-findings li {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 4px 0 4px 16px;
            position: relative;
            line-height: 1.5;
        }

        .sim-findings li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 11px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
        }

        .sim-actions {
            display: flex;
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .sim-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .sim-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-light);
        }

        .sim-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .sim-btn.primary:hover {
            background: var(--accent-light);
            box-shadow: 0 0 16px var(--glow-subtle);
        }

        /* Personality toggle */
        .personality-btn.active { background:var(--accent)!important;color:#fff!important;border-color:var(--accent)!important; }
        /* Sim clarification modal */
        .sim-clarify-overlay { position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;backdrop-filter:blur(4px); }
        .sim-clarify-modal { background:#1a1a2e;border:1px solid rgba(139,92,246,0.3);border-radius:16px;padding:28px;max-width:480px;width:90%;box-shadow:0 20px 60px rgba(139,92,246,0.15); }
        .sim-clarify-header { display:flex;align-items:center;gap:10px;margin-bottom:16px;font-size:1.1rem;font-weight:600;color:#e2e8f0; }
        .sim-clarify-context { background:rgba(139,92,246,0.08);color:#a78bfa;font-size:0.85rem;padding:10px 14px;border-radius:10px;margin-bottom:18px; }
        .sim-clarify-field { margin-bottom:14px; }
        .sim-clarify-field label { display:block;color:#a1a1aa;font-size:0.8rem;margin-bottom:5px; }
        .sim-clarify-field input,.sim-clarify-field select { width:100%;padding:9px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.04);color:#e2e8f0;font-size:0.9rem;box-sizing:border-box; }
        .sim-clarify-field select { cursor:pointer; }
        .sim-clarify-field input:focus,.sim-clarify-field select:focus { outline:none;border-color:var(--accent); }
        .sim-clarify-submit { width:100%;padding:11px;border:none;border-radius:10px;cursor:pointer;background:var(--accent-gradient);color:#fff;font-weight:600;font-size:0.95rem;transition:opacity 0.2s; }
        .sim-clarify-submit:hover { opacity:0.9; }
        /* Sim follow-up suggestions */
        .sim-followups { display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.06); }
        .sim-followup-pill { padding:6px 14px;border-radius:20px;border:1px solid rgba(139,92,246,0.4);background:rgba(139,92,246,0.06);color:#a78bfa;font-size:0.8rem;cursor:pointer;transition:all 0.2s; }
        .sim-followup-pill:hover { background:rgba(139,92,246,0.15);border-color:var(--accent);color:#e2e8f0; }
        .sim-followup-input-wrap { display:flex;gap:6px;width:100%;margin-top:6px; }
        .sim-followup-input { flex:1;padding:7px 12px;border-radius:20px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.04);color:#e2e8f0;font-size:0.8rem; }
        .sim-followup-input:focus { outline:none;border-color:var(--accent); }
        .sim-followup-send { padding:7px 14px;border-radius:20px;border:none;background:var(--accent);color:#fff;font-size:0.8rem;cursor:pointer; }

        /* Completed Task Items */
        .completed-item {
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.15);
            border-radius: 8px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .completed-item:hover {
            background: rgba(16, 185, 129, 0.15);
            transform: translateX(4px);
        }

        .completed-item-header {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
        }

        .completed-item-icon {
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .completed-item-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            line-height: 1.3;
            flex: 1;
        }

        .completed-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .completed-item-time {
            opacity: 0.7;
        }

        .completed-item-type {
            padding: 2px 6px;
            background: rgba(16, 185, 129, 0.2);
            border-radius: 4px;
            color: #10b981;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Final Answer Banner for Completed Tasks */
        .final-answer-banner {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 10px;
            margin-bottom: 16px;
        }

        .final-answer-icon {
            font-size: 1.5rem;
        }

        .final-answer-label {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: #10b981;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .final-answer-content {
            background: rgba(16, 185, 129, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.15);
            border-radius: 10px;
            padding: 16px 20px;
        }

        .final-answer-content h3 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .findings-meta-dot.completed {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }

        /* Ask Cerebro Input */
        .ask-cerebro-input {
            display: flex;
            gap: 6px;
            padding: 8px 10px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
        }

        .ask-cerebro-input input {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 0.8rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .ask-cerebro-input input:focus {
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.1);
        }

        .ask-cerebro-input input::placeholder {
            color: var(--text-muted);
            opacity: 0.6;
        }

        .ask-cerebro-btn {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(139, 92, 246, 0.2));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            color: var(--accent-light);
            width: 36px;
            height: 36px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .ask-cerebro-btn:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.5), rgba(139, 92, 246, 0.3));
            transform: scale(1.05);
        }

        .ask-cerebro-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Cerebro Chat Interface - Conversational Style */
        .chat-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 4px;
            max-height: 350px;
            overflow-y: auto;
        }

        .chat-message {
            max-width: 90%;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 0.85rem;
            line-height: 1.45;
            animation: messageSlide 0.3s ease-out;
            position: relative;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(139, 92, 246, 0.15));
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: var(--text-primary);
            border-bottom-right-radius: 4px;
        }

        .chat-message.cerebro {
            align-self: flex-start;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .chat-message.cerebro::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            font-size: 0.7rem;
            background: var(--bg-secondary);
            border-radius: 50%;
            padding: 2px;
        }

        .chat-message.loading {
            opacity: 0.7;
        }

        .chat-message.loading::after {
            content: '';
            display: inline-block;
            width: 4px;
            height: 4px;
            background: var(--accent);
            border-radius: 50%;
            margin-left: 6px;
            animation: typingDot 1s ease-in-out infinite;
        }

        @keyframes typingDot {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .chat-timestamp {
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-top: 4px;
            text-align: right;
        }

        .chat-message.cerebro .chat-timestamp {
            text-align: left;
        }

        /* Clear chat button */
        .chat-clear-btn {
            font-size: 0.65rem;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 6px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .chat-clear-btn:hover {
            opacity: 1;
            color: var(--error);
        }

        /* Empty chat state */
        .chat-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .chat-empty-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Current Focus Items - Goals/Directives being worked on */
        .focus-item {
            padding: 10px 12px;
            background: rgba(16, 185, 129, 0.05);
            border-radius: 10px;
            border-left: 2px solid rgba(16, 185, 129, 0.4);
            animation: focusFadeIn 0.4s ease-out;
        }

        .focus-item.active {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: rgba(16, 185, 129, 0.8);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.05);
        }

        .focus-item.pending {
            border-left-color: rgba(251, 191, 36, 0.5);
            background: rgba(251, 191, 36, 0.05);
        }

        @keyframes focusFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .focus-item-status {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .focus-status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
            animation: statusPulse 2s infinite;
        }

        .focus-item.active .focus-status-indicator {
            background: #10b981;
        }

        .focus-item.pending .focus-status-indicator {
            background: #fbbf24;
            animation: none;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { opacity: 0.7; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0); }
        }

        .focus-status-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #10b981;
        }

        .focus-item.pending .focus-status-label {
            color: #fbbf24;
        }

        .focus-item-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .focus-item-progress {
            margin-top: 8px;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .focus-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .section-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 12px;
            text-align: center;
            color: var(--text-muted);
            opacity: 0.6;
        }

        .section-empty-icon {
            font-size: 1.2rem;
            margin-bottom: 6px;
        }

        .section-empty-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.75rem;
            line-height: 1.4;
        }

        /* Enhanced Focus Items - Clickable with Controls */
        .focus-item {
            cursor: pointer;
            position: relative;
        }

        .focus-item:hover {
            background: rgba(16, 185, 129, 0.15);
            transform: translateX(4px);
        }

        .focus-item-controls {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .focus-item:hover .focus-item-controls {
            opacity: 1;
        }

        .focus-control-btn {
            padding: 4px 10px;
            font-size: 0.65rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .focus-control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .focus-control-btn.pause {
            border-color: rgba(251, 191, 36, 0.3);
        }

        .focus-control-btn.pause:hover {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .focus-control-btn.view {
            border-color: rgba(59, 130, 246, 0.3);
        }

        .focus-control-btn.view:hover {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .focus-item.paused {
            opacity: 0.5;
            border-left-color: rgba(107, 114, 128, 0.4);
        }

        .focus-item.paused .focus-status-indicator {
            background: #6b7280;
            animation: none;
        }

        .focus-item.paused .focus-status-label {
            color: #6b7280;
        }

        /* Task vs Goal type styling */
        .focus-type-badge {
            font-size: 0.75rem;
            margin-right: 4px;
        }

        .focus-item.goal-type {
            border-left-color: rgba(251, 191, 36, 0.6);
            background: rgba(251, 191, 36, 0.05);
        }

        .focus-item.goal-type .focus-status-indicator {
            background: #fbbf24;
        }

        .focus-item.task-type {
            border-left-color: rgba(16, 185, 129, 0.6);
        }

        .focus-progress-bar.goal-bar {
            background: linear-gradient(90deg, rgba(251, 191, 36, 0.8), rgba(251, 191, 36, 0.4));
        }

        .focus-progress-bar.task-bar {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.8), rgba(16, 185, 129, 0.4));
        }

        /* Research Findings Popup */
        .findings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .findings-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .findings-modal {
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            background: linear-gradient(135deg, rgba(15, 15, 20, 0.98), rgba(20, 20, 30, 0.98));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 24px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
        }

        .findings-overlay.active .findings-modal {
            transform: scale(1) translateY(0);
        }

        .findings-header {
            padding: 24px 28px 20px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.15);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 20px;
        }

        .findings-header-content {
            flex: 1;
        }

        .findings-directive {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .findings-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .findings-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .findings-meta-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .findings-meta-dot.active { background: #10b981; }
        .findings-meta-dot.paused { background: #fbbf24; }
        .findings-meta-dot.complete { background: #3b82f6; }

        .findings-close {
            width: 36px;
            height: 36px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .findings-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .findings-tabs {
            display: flex;
            padding: 0 28px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            gap: 4px;
        }

        .findings-tab {
            padding: 14px 20px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: none;
            cursor: pointer;
            position: relative;
            transition: color 0.2s ease;
        }

        .findings-tab:hover {
            color: var(--text-secondary);
        }

        .findings-tab.active {
            color: var(--accent-light);
        }

        .findings-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
        }

        .findings-tab-count {
            margin-left: 6px;
            padding: 2px 6px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            font-size: 0.7rem;
        }

        .findings-tab.summary-tab {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(139, 92, 246, 0.05));
            border-radius: 8px 8px 0 0;
            color: var(--accent-light);
        }

        .findings-tab.summary-tab.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(139, 92, 246, 0.1));
        }

        /* Summary Report Styling */
        .summary-content {
            display: none;
        }

        .summary-content.active {
            display: block;
        }

        .summary-loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .summary-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(139, 92, 246, 0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            margin: 0 auto 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .summary-report {
            line-height: 1.6;
        }

        .summary-report h2 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.3rem;
            color: var(--accent-light);
            margin: 24px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        .summary-report h2:first-child {
            margin-top: 0;
        }

        .summary-report h3 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin: 16px 0 8px 0;
        }

        .summary-report p {
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .summary-report ul, .summary-report ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .summary-report li {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .summary-report strong {
            color: var(--text-primary);
        }

        .summary-report code {
            background: rgba(139, 92, 246, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .summary-actions {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 12px;
        }

        .summary-action-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .summary-action-btn.primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
        }

        .summary-action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        .summary-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .summary-refresh-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 6px 12px;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .summary-refresh-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        .findings-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 28px;
        }

        .findings-content::-webkit-scrollbar { width: 4px; }
        .findings-content::-webkit-scrollbar-track { background: transparent; }
        .findings-content::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 4px;
        }

        .findings-section {
            display: none;
        }

        .findings-section.active {
            display: block;
        }

        .finding-item {
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 3px solid rgba(139, 92, 246, 0.4);
            transition: all 0.2s ease;
        }

        .finding-item:hover {
            background: rgba(139, 92, 246, 0.05);
        }

        .finding-item.observation { border-left-color: #3b82f6; }
        .finding-item.learning { border-left-color: #10b981; }
        .finding-item.prediction { border-left-color: #f97316; }
        .finding-item.insight { border-left-color: #ec4899; }

        .finding-type {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .finding-type-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .finding-item.observation .finding-type-dot { background: #3b82f6; }
        .finding-item.learning .finding-type-dot { background: #10b981; }
        .finding-item.prediction .finding-type-dot { background: #f97316; }
        .finding-item.insight .finding-type-dot { background: #ec4899; }

        .finding-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.95rem;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .finding-time {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .findings-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .findings-empty-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .findings-empty-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
        }

        .findings-footer {
            padding: 16px 28px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .findings-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .saturation-bar {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .saturation-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #fbbf24, #ef4444);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .findings-actions {
            display: flex;
            gap: 10px;
        }

        .findings-btn {
            padding: 10px 20px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .findings-btn.primary {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(88, 28, 135, 0.3));
            border-color: rgba(139, 92, 246, 0.4);
            color: var(--accent-light);
        }

        .findings-btn.primary:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.5), rgba(88, 28, 135, 0.5));
            transform: translateY(-1px);
        }

        .findings-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        .findings-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .findings-btn.danger {
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .findings-btn.danger:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* ===== CONSCIOUSNESS INTERFACE - RESPONSIVE ===== */

        /* Sidebars are now slide-out panels - always hidden by default */
        @media (max-width: 768px) {
            .consciousness-chamber {
                min-height: auto;
                padding: 16px 16px 8px;
            }

            .consciousness-orb {
                width: 180px;
                height: 180px;
            }

            .orb-essence {
                width: 130px;
                height: 130px;
            }

            .orbital-system {
                width: 320px;
                height: 320px;
            }

            .orbit-1 { width: 240px; height: 240px; margin: -120px 0 0 -120px; }
            .orbit-2 { width: 280px; height: 280px; margin: -140px 0 0 -140px; }
            .orbit-3 { width: 320px; height: 320px; margin: -160px 0 0 -160px; }

            .voice-stream {
                padding: 0 16px 20px;
            }

            .current-voice {
                padding: 20px;
                border-radius: 16px;
            }

            .voice-content {
                font-size: 1.1rem;
            }

            .directive-whisper {
                padding: 0 16px 30px 16px;
            }

            .whisper-input {
                font-size: 1rem;
                padding: 16px 50px 16px 16px;
            }

            .control-btn {
                width: 44px;
                height: 44px;
            }

            .tech-panel.expanded {
                padding: 16px;
            }

            .tech-stats {
                gap: 16px;
            }

            .tech-stat-value {
                font-size: 1.2rem;
            }

            .level-marks {
                font-size: 0.55rem;
            }
        }

        @media (max-width: 480px) {
            .consciousness-chamber {
                min-height: auto;
            }

            .consciousness-orb {
                width: 150px;
                height: 150px;
            }

            .orb-essence {
                width: 105px;
                height: 105px;
            }

            .status-text {
                font-size: 0.8rem;
            }

            .awaken-btn {
                padding: 12px 30px;
                font-size: 0.85rem;
            }

            .voice-content {
                font-size: 1rem;
            }

            .message-history {
                max-height: 200px;
            }

            .directive-tag {
                font-size: 0.8rem;
                padding: 6px 10px;
            }
        }

        /* Current Focus Section - Dramatic Card */
        .current-focus-section {
            margin: 0;
            padding: 0 20px 20px;
            z-index: 1;
            position: relative;
        }

        .focus-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.1), rgba(0,0,0,0.3));
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 20px;
            padding: 24px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.05);
        }

        .focus-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .focus-icon {
            font-size: 1.5rem;
        }

        .focus-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .focus-content {
            font-size: 1.1rem;
            line-height: 1.5;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .focus-reasoning {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .reasoning-header {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .reasoning-content {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
            font-style: italic;
        }

        .focus-safety {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .safety-badge {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        .safety-badge.safe {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .safety-badge.action-planned {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .safety-badge.needs-approval {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Autonomy Grid - Enhanced */
        .autonomy-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            z-index: 1;
            position: relative;
        }

        @media (max-width: 768px) {
            .autonomy-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Thought Stream - ALIVE Neural Feed */
        .thought-stream-section {
            background: linear-gradient(180deg, rgba(20, 15, 35, 0.9), rgba(10, 10, 20, 0.95));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.03);
            position: relative;
            overflow: hidden;
        }

        /* Subtle animated border */
        .thought-stream-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            animation: borderScan 3s ease-in-out infinite;
        }

        @keyframes borderScan {
            0%, 100% { transform: translateX(-100%); opacity: 0; }
            50% { transform: translateX(100%); opacity: 1; }
        }

        .thought-stream-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.15);
        }

        .thought-stream-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: flex;
            align-items: center;
        }

        .thought-stream {
            max-height: 350px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-right: 8px;
        }

        /* Custom scrollbar for thought stream */
        .thought-stream::-webkit-scrollbar {
            width: 4px;
        }
        .thought-stream::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 2px;
        }
        .thought-stream::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 2px;
        }

        .thought-item {
            background: linear-gradient(135deg, rgba(30, 25, 50, 0.8), rgba(20, 15, 35, 0.9));
            border-radius: 14px;
            padding: 14px 16px;
            border: 1px solid rgba(139, 92, 246, 0.15);
            transition: all 0.3s ease;
            position: relative;
        }

        .thought-item:hover {
            border-color: rgba(139, 92, 246, 0.4);
            transform: translateX(4px);
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.15);
        }

        .thought-item.new {
            animation: thoughtSlideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            border-color: var(--accent);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.3), inset 0 0 20px rgba(139, 92, 246, 0.05);
        }

        @keyframes thoughtSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Session Markers - Visual dividers between sessions */
        .session-marker {
            padding: 16px 12px;
            margin: 8px 0;
            text-align: center;
            position: relative;
        }

        .session-marker-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.4), transparent);
        }

        .session-marker-content {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 6px 14px;
            border-radius: 20px;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .session-marker-icon {
            font-size: 1rem;
        }

        .session-marker-text {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }

        .session-marker-level, .session-marker-cycles {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent);
        }

        .session-marker-time {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 6px;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }

        .session-start .session-marker-line {
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.5), transparent);
        }

        .session-start .session-marker-content {
            border-color: rgba(16, 185, 129, 0.3);
        }

        .session-end .session-marker-line {
            background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.4), transparent);
        }

        .session-end .session-marker-content {
            border-color: rgba(245, 158, 11, 0.3);
        }

        .thought-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .thought-phase {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 4px 10px;
            border-radius: 10px;
            letter-spacing: 0.05em;
        }

        .thought-phase.observe { background: rgba(59, 130, 246, 0.25); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .thought-phase.orient { background: rgba(139, 92, 246, 0.25); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.3); }
        .thought-phase.decide { background: rgba(245, 158, 11, 0.25); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); }
        .thought-phase.act { background: rgba(249, 115, 22, 0.25); color: #fb923c; border: 1px solid rgba(249, 115, 22, 0.3); }
        .thought-phase.reflect { background: rgba(16, 185, 129, 0.25); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .thought-phase.idle { background: rgba(113, 113, 122, 0.2); color: var(--text-muted); border: 1px solid rgba(113, 113, 122, 0.2); }

        .thought-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-family: 'SF Mono', 'Fira Code', monospace;
        }

        .thought-content {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .thought-confidence {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .thought-confidence-bar {
            flex: 1;
            height: 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .thought-confidence-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .thought-confidence-value {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-family: 'SF Mono', 'Fira Code', monospace;
        }

        /* Directives Section - Give the AI missions */
        .directives-section {
            background: linear-gradient(180deg, rgba(20, 25, 35, 0.9), rgba(10, 15, 20, 0.95));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(59, 130, 246, 0.25);
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.03);
            grid-column: 1 / -1;
            position: relative;
            overflow: hidden;
        }

        .directives-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            animation: directivePulse 4s ease-in-out infinite;
        }

        @keyframes directivePulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .directives-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .directives-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .directives-title-icon {
            font-size: 1.2rem;
        }

        .directives-input-container {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .directive-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 14px 18px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.3s ease;
            outline: none;
        }

        .directive-input::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        .directive-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }

        .directive-submit-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            border-radius: 12px;
            padding: 14px 24px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .directive-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .directive-submit-btn:active {
            transform: translateY(0);
        }

        .directives-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .directive-item {
            background: linear-gradient(135deg, rgba(30, 35, 50, 0.8), rgba(20, 25, 35, 0.9));
            border-radius: 14px;
            padding: 14px 16px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            transition: all 0.3s ease;
            animation: directiveSlideIn 0.3s ease-out;
        }

        @keyframes directiveSlideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .directive-item:hover {
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.15);
        }

        .directive-content {
            flex: 1;
        }

        .directive-text {
            color: var(--text-primary);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 6px;
        }

        .directive-meta {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .directive-status {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .directive-status.active {
            color: #22c55e;
        }

        .directive-status.pending {
            color: #f59e0b;
        }

        .directive-actions {
            display: flex;
            gap: 6px;
        }

        .directive-action-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 6px 10px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
        }

        .directive-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .directive-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
            color: #ef4444;
        }

        .directives-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
        }

        .directives-empty-icon {
            font-size: 2rem;
            opacity: 0.3;
            margin-bottom: 8px;
        }

        /* ============================================
           INSIGHTS SECTION - What Cerebro Found
           ============================================ */
        .insights-section {
            background: linear-gradient(180deg, rgba(16, 35, 20, 0.95), rgba(10, 25, 15, 0.98));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(34, 197, 94, 0.3);
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.03);
            grid-column: 1 / -1;
            position: relative;
            overflow: hidden;
        }

        .insights-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #22c55e, #10b981, transparent);
            animation: insightGlow 3s ease-in-out infinite;
        }

        @keyframes insightGlow {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        .insights-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .insights-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #22c55e;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .insights-title-icon {
            font-size: 1.3rem;
            animation: bulbPulse 2s ease-in-out infinite;
        }

        @keyframes bulbPulse {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
        }

        .insights-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .insight-card {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.05));
            border-radius: 16px;
            padding: 18px 20px;
            border: 1px solid rgba(34, 197, 94, 0.2);
            animation: insightSlideIn 0.4s ease-out;
            transition: all 0.3s ease;
        }

        @keyframes insightSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .insight-card:hover {
            border-color: rgba(34, 197, 94, 0.4);
            box-shadow: 0 8px 30px rgba(34, 197, 94, 0.15);
            transform: translateY(-2px);
        }

        .insight-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .insight-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-card-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 10px;
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            font-weight: 600;
        }

        .insight-card-content {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .insight-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .insight-confidence {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .insight-confidence-bar {
            width: 60px;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .insight-confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #10b981);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .insight-dismiss {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }

        .insight-dismiss:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        .insights-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .insights-empty-icon {
            font-size: 2.5rem;
            opacity: 0.3;
            margin-bottom: 12px;
        }

        .insights-empty-text {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .insights-empty-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            opacity: 0.7;
        }

        /* Activity Section - Enhanced */
        .activity-section {
            background: linear-gradient(180deg, rgba(20, 15, 35, 0.9), rgba(10, 10, 20, 0.95));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.03);
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .activity-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .activity-feed {
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .activity-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .activity-icon.success { background: rgba(34, 197, 94, 0.2); }
        .activity-icon.pending { background: rgba(234, 179, 8, 0.2); }
        .activity-icon.error { background: rgba(239, 68, 68, 0.2); }

        /* Pending Approvals */
        .pending-approvals {
            border-top: 1px solid var(--border);
            padding-top: 12px;
        }

        .pending-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--yellow);
            margin-bottom: 10px;
        }

        .approval-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid var(--yellow);
            margin-bottom: 8px;
        }

        .approval-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .approval-action {
            font-weight: 600;
            color: var(--text-primary);
        }

        .approval-risk {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 8px;
        }

        .approval-risk.high { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .approval-risk.medium { background: rgba(234, 179, 8, 0.2); color: var(--yellow); }

        .approval-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .approval-buttons {
            display: flex;
            gap: 8px;
        }

        .approval-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: none;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .approval-btn.approve {
            background: var(--green);
            color: white;
        }

        .approval-btn.reject {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        /* Controls Section - Command Center */
        .autonomy-controls {
            background: linear-gradient(180deg, rgba(20, 15, 35, 0.95), rgba(10, 10, 20, 0.98));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            padding: 24px;
            grid-column: span 2;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.03);
        }

        @media (max-width: 768px) {
            .autonomy-controls {
                grid-column: span 1;
            }
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.15);
        }

        .controls-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Autonomy Level Slider - Enhanced */
        .autonomy-level-control {
            margin-bottom: 24px;
        }

        .autonomy-level-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .level-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            width: 70px;
            padding: 6px 4px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .level-label.active {
            color: var(--accent);
            font-weight: 700;
            background: rgba(139, 92, 246, 0.15);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
        }

        .autonomy-slider {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(90deg, rgba(30, 30, 50, 0.8), rgba(50, 50, 80, 0.8));
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .autonomy-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a78bfa, #7c3aed);
            cursor: pointer;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.6), 0 2px 10px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.2);
            transition: all 0.2s ease;
        }

        .autonomy-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.8), 0 2px 15px rgba(0,0,0,0.4);
        }

        .autonomy-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a78bfa, #7c3aed);
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.6), 0 2px 10px rgba(0,0,0,0.3);
        }

        /* Stats Row - Dramatic Counters */
        .autonomy-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .autonomy-stat {
            flex: 1;
            background: linear-gradient(135deg, rgba(30, 25, 50, 0.8), rgba(20, 15, 35, 0.9));
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            border: 1px solid rgba(139, 92, 246, 0.15);
            position: relative;
            overflow: hidden;
        }

        .autonomy-stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0.5;
        }

        .autonomy-stat-value {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #c4b5fd, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }

        .autonomy-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 4px;
        }

        /* Kill Switch - DRAMATIC */
        .kill-switch-container {
            text-align: center;
            margin-top: 8px;
        }

        .kill-switch-btn {
            padding: 18px 50px;
            border-radius: 16px;
            border: 2px solid #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));
            color: #ef4444;
            font-size: 1.1rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .kill-switch-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(239, 68, 68, 0.4), transparent);
            transform: translate(-50%, -50%);
            transition: all 0.5s ease;
            border-radius: 50%;
        }

        .kill-switch-btn:hover {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 0 40px rgba(239, 68, 68, 0.5), 0 0 80px rgba(239, 68, 68, 0.2);
            transform: translateY(-2px);
        }

        .kill-switch-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .kill-switch-btn:active {
            transform: translateY(0) scale(0.98);
        }

        /* Full Autonomy Toggle */
        .full-autonomy-toggle {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .full-autonomy-toggle.enabled {
            border-color: var(--red);
            background: rgba(239, 68, 68, 0.1);
        }

        .full-autonomy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .full-autonomy-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .full-autonomy-label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .full-autonomy-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .full-autonomy-warning {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(239, 68, 68, 0.15);
            border-radius: 8px;
            font-size: 0.75rem;
            color: var(--red);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-muted);
            transition: all 0.3s ease;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--red);
            border-color: var(--red);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
            background-color: white;
        }

        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 4px var(--accent);
        }

        /* Debug Feed - Live LLM/API Visibility */
        .debug-feed-section {
            margin-top: 24px;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .debug-feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-elevated);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .debug-feed-header:hover {
            background: var(--bg-hover);
        }

        .debug-feed-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .debug-feed-icon {
            font-size: 1.1rem;
        }

        .debug-feed-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .debug-feed-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .debug-feed-count {
            font-size: 0.75rem;
            color: var(--accent);
            background: rgba(139, 92, 246, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
        }

        .debug-clear-btn {
            font-size: 0.7rem;
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .debug-clear-btn:hover {
            background: var(--red);
            border-color: var(--red);
            color: white;
        }

        .debug-expand-icon {
            font-size: 0.8rem;
            color: var(--text-muted);
            transition: transform 0.3s ease;
        }

        .debug-feed-section.collapsed .debug-expand-icon {
            transform: rotate(-90deg);
        }

        .debug-feed-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 12px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            transition: max-height 0.3s ease;
        }

        .debug-feed-section.collapsed .debug-feed-content {
            max-height: 0;
            padding: 0 12px;
            overflow: hidden;
        }

        .debug-feed-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .debug-event {
            padding: 8px 10px;
            margin-bottom: 6px;
            border-radius: 8px;
            border-left: 3px solid;
            background: var(--bg-secondary);
        }

        .debug-event.llm_prompt {
            border-left-color: var(--cyan);
        }

        .debug-event.llm_response {
            border-left-color: var(--green);
        }

        .debug-event.api_call {
            border-left-color: var(--blue);
        }

        .debug-event.api_response {
            border-left-color: #3b82f6;
        }

        .debug-event.api_error {
            border-left-color: var(--red);
        }

        .debug-event.action_execute {
            border-left-color: var(--yellow);
        }

        .debug-event.action_result {
            border-left-color: var(--accent);
        }

        .debug-event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .debug-event-type {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 0.5px;
        }

        .debug-event.llm_prompt .debug-event-type { color: var(--cyan); }
        .debug-event.llm_response .debug-event-type { color: var(--green); }
        .debug-event.api_call .debug-event-type { color: var(--blue); }
        .debug-event.api_response .debug-event-type { color: #3b82f6; }
        .debug-event.api_error .debug-event-type { color: var(--red); }
        .debug-event.action_execute .debug-event-type { color: var(--yellow); }
        .debug-event.action_result .debug-event-type { color: var(--accent); }

        .debug-event-time {
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .debug-event-phase {
            display: inline-block;
            font-size: 0.6rem;
            padding: 2px 5px;
            border-radius: 4px;
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-light);
            margin-right: 6px;
        }

        .debug-event-content {
            color: var(--text-secondary);
            line-height: 1.4;
            word-break: break-word;
        }

        .debug-event-content .model {
            color: var(--accent);
        }

        .debug-event-content .tokens {
            color: var(--green);
        }

        .debug-event-content .duration {
            color: var(--yellow);
        }

        .debug-event-content pre {
            margin: 6px 0 0 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 120px;
            overflow-y: auto;
            color: var(--text-muted);
            font-size: 0.7rem;
        }

        .debug-event-content .thinking {
            margin-top: 6px;
            padding: 6px 8px;
            background: rgba(34, 211, 238, 0.1);
            border-radius: 6px;
            border-left: 2px solid var(--cyan);
            font-style: italic;
            color: var(--cyan);
            max-height: 80px;
            overflow-y: auto;
        }

        .debug-feed-content::-webkit-scrollbar {
            width: 6px;
        }

        .debug-feed-content::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .debug-feed-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        /* Prediction Warning Modal */
        .prediction-modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            max-width: 440px;
            width: 90%;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
        }

        .prediction-modal .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .prediction-modal .modal-icon {
            font-size: 2rem;
        }

        .prediction-modal h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .prediction-warnings {
            margin-bottom: 16px;
        }

        .warning-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background: rgba(234, 179, 8, 0.1);
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 3px solid var(--yellow);
        }

        .warning-item .confidence {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--yellow);
            padding: 2px 6px;
            background: rgba(234, 179, 8, 0.2);
            border-radius: 6px;
            flex-shrink: 0;
        }

        .warning-item .text {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .prediction-alternatives h4 {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .prediction-alternatives ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .prediction-alternatives li {
            padding: 8px 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 0.85rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .prediction-alternatives li:hover {
            background: var(--accent);
            color: white;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-actions .btn-secondary {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
        }

        .modal-actions .btn-primary {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: none;
            background: var(--accent);
            color: white;
            cursor: pointer;
            font-weight: 500;
        }

        .modal-actions .btn-secondary:hover {
            background: var(--bg-elevated);
        }

        .modal-actions .btn-primary:hover {
            background: var(--accent-dark);
        }

        /* Chat Warnings Banner */
        .chat-warnings {
            padding: 12px 16px;
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 12px;
            margin-bottom: 16px;
            display: none;
        }

        .chat-warnings.visible {
            display: block;
        }

        .chat-warning-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-warning-icon {
            font-size: 1.2rem;
        }

        .chat-warning-text {
            flex: 1;
            font-size: 0.85rem;
            color: var(--yellow);
        }

        .chat-warning-dismiss {
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid var(--yellow);
            background: transparent;
            color: var(--yellow);
            cursor: pointer;
            font-size: 0.75rem;
        }

        /* Proactive Status Indicator */
        .proactive-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .proactive-indicator.visible {
            display: flex;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* ==================== AUTOMATION VIEW - REDESIGNED ==================== */
        .automation-view {
            padding: 20px;
            gap: 20px;
            overflow-y: auto;
        }

        .automation-view .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .automation-view .view-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Two-column layout container for desktop */
        .automation-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 900px) {
            .automation-layout {
                grid-template-columns: 1fr 320px;
                align-items: start;
            }
        }

        @media (min-width: 1200px) {
            .automation-layout {
                grid-template-columns: 1fr 360px;
            }
        }

        /* Primary column - Automations (left on desktop) */
        .automation-primary {
            display: flex;
            flex-direction: column;
            gap: 20px;
            order: 2;
        }

        @media (min-width: 900px) {
            .automation-primary {
                order: 1;
            }
        }

        /* Secondary column - Calendar (right on desktop) */
        .automation-secondary {
            order: 1;
        }

        @media (min-width: 900px) {
            .automation-secondary {
                order: 2;
                position: sticky;
                top: 20px;
            }
        }

        /* Calendar - Compact Glassmorphism Style */
        .automation-calendar-section {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border-radius: 20px;
            padding: 16px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .calendar-header h2 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .calendar-header button {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s var(--ease-out-expo);
        }

        .calendar-header button:hover {
            background: var(--bg-hover);
            color: var(--accent-light);
            border-color: var(--glass-border-hover);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 6px;
            text-align: center;
        }

        .calendar-weekdays span {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }

        /* Compact calendar cells - max 44px */
        .calendar-day {
            aspect-ratio: 1;
            min-width: 32px;
            min-height: 32px;
            max-width: 44px;
            max-height: 44px;
            background: var(--bg-elevated);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s var(--ease-out-expo);
            border: 1px solid var(--border);
        }

        .calendar-day:hover {
            background: var(--bg-hover);
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--glow-subtle);
            border-color: var(--glass-border);
        }

        .calendar-day.today {
            background: var(--accent);
            color: white;
            box-shadow: 0 0 20px var(--glow-medium);
            border-color: var(--accent);
        }

        .calendar-day.today .day-number {
            color: white;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .day-number {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .day-events {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 1px;
        }

        .event-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
        }

        .event-dot.researcher { background: var(--blue); }
        .event-dot.coder { background: var(--green); }
        .event-dot.worker { background: var(--accent); }
        .event-dot.analyst { background: var(--purple); }

        /* Section Cards - Glassmorphism */
        .automation-section {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
        }

        .automation-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .automation-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .automation-section-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--glow-medium);
        }

        .clear-activity-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 8px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .clear-activity-btn:hover {
            border-color: var(--red);
            color: var(--red);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Activity sidebar clear button */
        .sidebar-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .activity-clear-btn {
            background: transparent;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: var(--text-muted);
            opacity: 0.6;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .activity-clear-btn:hover {
            color: var(--red);
            opacity: 1;
            background: rgba(239, 68, 68, 0.1);
        }

        .automation-section-count {
            background: var(--bg-elevated);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Schedule Cards - Enhanced */
        .schedules-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .schedule-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--border);
            transition: all 0.2s var(--ease-out-expo);
        }

        .schedule-card:hover {
            border-color: var(--glass-border-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), 0 0 20px var(--glow-subtle);
        }

        .schedule-toggle {
            flex-shrink: 0;
        }

        .schedule-info {
            flex: 1;
            min-width: 0;
        }

        .schedule-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-primary);
        }

        .schedule-timing {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .schedule-badge {
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 6px;
            background: var(--bg-elevated);
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .schedule-badge.recurring {
            background: var(--accent-gradient);
            color: white;
        }

        .schedule-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .schedule-actions button {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s var(--ease-out-expo);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .schedule-actions button:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .schedule-actions button.run-btn:hover {
            background: var(--green);
            color: white;
            border-color: var(--green);
        }

        .schedule-actions button.delete-btn:hover {
            background: var(--red);
            color: white;
            border-color: var(--red);
        }

        .schedule-toggle {
            margin-right: 12px;
        }

        /* Day Selector */
        .day-selector {
            display: flex;
            gap: 6px;
        }

        .day-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .day-btn:hover {
            background: var(--bg-hover);
        }

        .day-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Timeout Selector */
        .timeout-selector { display: flex; gap: 8px; }
        .timeout-btn {
            flex: 1; padding: 8px 12px; border-radius: 8px;
            background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2);
            color: var(--text-secondary); cursor: pointer; font-size: 0.85rem; transition: all 0.2s;
        }
        .timeout-btn:hover { border-color: var(--accent); }
        .timeout-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* Schedule Type Toggle */
        .schedule-type-toggle {
            display: flex;
            background: var(--bg-elevated);
            border-radius: 8px;
            padding: 4px;
            border: 1px solid var(--border);
        }

        .toggle-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .toggle-btn.active {
            background: var(--accent);
            color: white;
        }

        /* Toggle Row */
        .toggle-row {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .toggle-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
        }

        /* Execution History - Enhanced */
        .execution-history {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .execution-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--border);
            transition: all 0.2s var(--ease-out-expo);
        }

        .execution-item:hover {
            border-color: var(--glass-border);
            background: var(--bg-elevated);
        }

        .execution-item.clickable {
            cursor: pointer;
        }

        .execution-item.clickable:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .execution-arrow {
            margin-left: auto;
            color: var(--text-muted);
            opacity: 0;
            transition: all 0.2s ease;
        }

        .execution-item.clickable:hover .execution-arrow {
            opacity: 1;
            color: var(--accent);
        }

        .execution-status.running {
            background: rgba(234, 179, 8, 0.15);
            color: var(--yellow);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .execution-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            min-width: 50px;
            font-weight: 500;
        }

        .execution-status {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .execution-status.success {
            background: rgba(34, 197, 94, 0.15);
            color: var(--green);
        }

        .execution-status.failed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--red);
        }

        .execution-status.running {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent);
        }

        .execution-info {
            flex: 1;
            min-width: 0;
        }

        .execution-name {
            font-size: 0.85rem;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-primary);
        }

        .execution-type {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* Recurring options */
        .recurring-options, .weekly-options {
            transition: all 0.3s ease;
        }

        .recurring-options.hidden, .weekly-options.hidden {
            display: none;
        }

        /* Form row */
        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-half {
            flex: 1;
        }

        /* Empty state - Enhanced */
        .empty-state {
            text-align: center;
            padding: 32px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto 16px;
            background: var(--bg-elevated);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
        }

        .empty-state-icon svg {
            width: 28px;
            height: 28px;
            stroke: var(--text-muted);
            stroke-width: 1.5;
            fill: none;
        }

        .empty-state-text {
            font-size: 0.85rem;
            line-height: 1.5;
            max-width: 200px;
            margin: 0 auto;
        }

        /* Quick Stats Row for Automation */
        .automation-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (min-width: 900px) {
            .automation-stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .automation-stat-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.2s var(--ease-out-expo);
        }

        .automation-stat-card:hover {
            border-color: var(--glass-border);
            transform: translateY(-2px);
        }

        .automation-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .automation-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ==================== HITL POPUP - CENTER MODAL ==================== */
        
        /* ==================== SECURITY ALERT POPUP ==================== */
        .security-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9800;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
        }
        .security-alert-overlay.visible {
            display: flex;
        }

        .security-alert-popup {
            width: min(520px, 92vw);
            background: rgba(20, 10, 10, 0.97);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(239, 68, 68, 0.6);
            border-radius: 16px;
            padding: 0;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.8),
                0 0 80px rgba(239, 68, 68, 0.3),
                0 0 120px rgba(239, 68, 68, 0.15);
            animation: securityAlertIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden;
        }

        .security-alert-popup.dismissing {
            animation: securityAlertOut 0.3s ease-in forwards;
        }

        @keyframes securityAlertIn {
            from { opacity: 0; transform: scale(0.8) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes securityAlertOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.85); }
        }

        .security-alert-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px 12px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
            border-bottom: 1px solid rgba(239, 68, 68, 0.3);
        }

        .security-alert-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .security-alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            background: rgba(239, 68, 68, 0.25);
            animation: securityPulse 1.5s ease-in-out infinite;
        }

        @keyframes securityPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
        }

        .security-alert-label {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--red);
        }

        .security-alert-severity {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 4px 10px;
            border-radius: 8px;
            font-weight: 700;
            background: rgba(239, 68, 68, 0.25);
            color: var(--red);
            border: 1px solid rgba(239, 68, 68, 0.4);
            animation: severityBlink 2s ease-in-out infinite;
        }

        @keyframes severityBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .security-alert-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.3rem;
            padding: 4px;
            line-height: 1;
            transition: color 0.2s;
        }
        .security-alert-close:hover { color: var(--red); }

        .security-alert-body {
            padding: 20px;
        }

        .security-alert-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.15rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 16px;
        }

        .security-alert-device {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.8;
            color: var(--text-secondary);
        }

        .security-alert-device strong {
            color: var(--red);
            font-weight: 600;
        }

        .security-alert-timestamp {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .security-alert-actions {
            display: flex;
            gap: 10px;
            padding: 14px 20px 18px;
            border-top: 1px solid rgba(239, 68, 68, 0.15);
        }

        .security-alert-btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: 10px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .security-alert-btn.dismiss {
            background: rgba(255, 255, 255, 0.06);
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .security-alert-btn.dismiss:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .security-alert-btn.investigate {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(239, 68, 68, 0.15));
            color: #fff;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }
        .security-alert-btn.investigate:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.45), rgba(239, 68, 68, 0.25));
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
        }

        .hitl-popup-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9500;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        .hitl-popup-container.visible {
            display: flex;
        }

        .hitl-popup {
            width: min(480px, 90vw);
            background: rgba(18, 18, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 16px;
            padding: 0;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.7),
                0 0 60px rgba(139, 92, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            animation: hitlScaleIn 0.35s var(--ease-out-expo);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .hitl-popup:hover {
            border-color: rgba(139, 92, 246, 0.6);
            box-shadow:
                0 24px 70px rgba(0, 0, 0, 0.8),
                0 0 80px rgba(139, 92, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }

        .hitl-popup.dismissing {
            animation: hitlScaleOut 0.25s ease-in forwards;
        }

        @keyframes hitlScaleIn {
            from {
                opacity: 0;
                transform: scale(0.85);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes hitlScaleOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.85);
            }
        }

        .hitl-popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px 10px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.15);
        }

        .hitl-popup-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hitl-popup-icon {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            background: rgba(139, 92, 246, 0.2);
            animation: hitlPulse 2s ease-in-out infinite;
        }

        @keyframes hitlPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(139, 92, 246, 0); }
        }

        .hitl-popup-label {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--accent-light);
        }

        .hitl-popup-urgency {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 3px 8px;
            border-radius: 8px;
            font-weight: 600;
        }

        .hitl-popup-urgency.high {
            background: rgba(239, 68, 68, 0.2);
            color: var(--red);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .hitl-popup-urgency.medium {
            background: rgba(234, 179, 8, 0.2);
            color: var(--yellow);
            border: 1px solid rgba(234, 179, 8, 0.3);
        }

        .hitl-popup-urgency.low {
            background: rgba(34, 197, 94, 0.2);
            color: var(--green);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .hitl-popup-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 4px;
            line-height: 1;
            transition: color 0.2s;
        }

        .hitl-popup-close:hover {
            color: var(--text-primary);
        }

        .hitl-popup-body {
            padding: 14px 16px;
        }

        .hitl-popup-question {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .hitl-popup-context {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
            margin-bottom: 12px;
            padding-left: 10px;
            border-left: 2px solid rgba(139, 92, 246, 0.3);
            line-height: 1.4;
        }

        /* Browser preview thumbnail */
        .hitl-browser-preview {
            margin-bottom: 12px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(139, 92, 246, 0.2);
            position: relative;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .hitl-browser-preview:hover {
            border-color: rgba(139, 92, 246, 0.5);
        }

        .hitl-browser-preview img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
            background: var(--bg-card);
        }

        .hitl-browser-preview-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 6px 10px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .hitl-browser-preview-label {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.7);
            font-family: 'Space Mono', monospace;
        }

        .hitl-view-browser-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            color: var(--accent-light);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .hitl-view-browser-btn:hover {
            background: rgba(139, 92, 246, 0.35);
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateY(-1px);
        }

        .hitl-view-browser-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Answer input area */
        .hitl-popup-answer {
            padding: 0 16px 14px;
        }

        .hitl-answer-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(10, 10, 20, 0.6);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .hitl-answer-input:focus {
            border-color: rgba(139, 92, 246, 0.5);
        }

        .hitl-answer-input::placeholder {
            color: var(--text-muted);
        }

        .hitl-popup-actions {
            display: flex;
            gap: 8px;
            padding: 0 16px 14px;
        }

        .hitl-action-btn {
            flex: 1;
            padding: 9px 14px;
            border-radius: 10px;
            border: none;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .hitl-action-btn.submit {
            background: var(--accent-gradient);
            color: white;
        }

        .hitl-action-btn.submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
        }

        .hitl-action-btn.approve {
            background: rgba(34, 197, 94, 0.9);
            color: white;
        }

        .hitl-action-btn.approve:hover {
            background: rgba(34, 197, 94, 1);
            transform: translateY(-1px);
        }

        .hitl-action-btn.reject {
            background: rgba(30, 30, 45, 0.8);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--text-secondary);
        }

        .hitl-action-btn.reject:hover {
            border-color: rgba(239, 68, 68, 0.6);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Timer bar removed - no auto-dismiss */
        .hitl-popup-timer { display: none; }
        .hitl-popup-timer-bar { display: none; }

        /* Sidebar pulsing indicator for unanswered questions */
        .sidebar-questions.has-pending-hitl .sidebar-header-title::after {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--red);
            margin-left: 8px;
            animation: hitlPulse 2s ease-in-out infinite;
        }

        /* ==================== BROWSER CONTROL (TAB PANE) ==================== */
        .browser-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all 0.3s ease;
        }

        .browser-status-dot.running {
            background: var(--accent);
            box-shadow: 0 0 8px var(--glow-medium);
        }

        .browser-status-dot.paused {
            background: var(--yellow);
            box-shadow: 0 0 8px rgba(234, 179, 8, 0.5);
            animation: hitlPulse 2s ease-in-out infinite;
        }

        .browser-status-dot.stopped {
            background: var(--text-muted);
        }

        .browser-status-text {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .browser-status-text.running { color: var(--green); }
        .browser-status-text.paused { color: var(--yellow); }

        /* Old .browser-launch-btn, .browser-url-bar, .browser-url-text removed  replaced by tab pane styles */

        .browser-tab-list {
            max-height: 100px;
            overflow-y: auto;
            margin: 8px 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .browser-tab-list::-webkit-scrollbar { width: 3px; }
        .browser-tab-list::-webkit-scrollbar-track { background: transparent; }
        .browser-tab-list::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 3px;
        }

        .browser-tab-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 8px;
            background: rgba(10, 10, 20, 0.4);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.65rem;
            color: var(--text-secondary);
            cursor: default;
            transition: background 0.15s ease;
        }

        .browser-tab-item:hover {
            background: var(--bg-hover);
        }

        .browser-tab-item.active-tab {
            border-color: rgba(139, 92, 246, 0.3);
            color: var(--text-primary);
        }

        .browser-tab-favicon {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .browser-tab-title {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        /* Old .browser-preview removed  replaced by .browser-tab-screenshot */

        .browser-control-toggle {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: rgba(139, 92, 246, 0.1);
            color: var(--accent-light);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 6px;
        }

        .browser-control-toggle:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .browser-control-toggle.give-back {
            background: rgba(234, 179, 8, 0.1);
            border-color: rgba(234, 179, 8, 0.3);
            color: var(--yellow);
        }

        .browser-control-toggle.give-back:hover {
            background: rgba(234, 179, 8, 0.2);
            border-color: var(--yellow);
        }

        .browser-control-toggle svg {
            width: 14px;
            height: 14px;
        }

        /* "Cerebro needs you" action banner */
        .browser-action-banner {
            display: none;
            margin-top: 8px;
            padding: 10px 12px;
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.15), rgba(239, 68, 68, 0.1));
            border: 1px solid rgba(234, 179, 8, 0.4);
            border-radius: 10px;
            animation: actionBannerPulse 2s ease-in-out infinite;
        }

        .browser-action-banner.visible {
            display: block;
        }

        @keyframes actionBannerPulse {
            0%, 100% {
                box-shadow: 0 0 10px rgba(234, 179, 8, 0.2);
                border-color: rgba(234, 179, 8, 0.4);
            }
            50% {
                box-shadow: 0 0 25px rgba(234, 179, 8, 0.4);
                border-color: rgba(234, 179, 8, 0.7);
            }
        }

        .browser-action-banner-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--yellow);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .browser-action-banner-desc {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.8rem;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .browser-action-done-btn {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: none;
            background: var(--accent-gradient);
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .browser-action-done-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
        }

        /* Old .browser-panel-body removed  tab pane handles visibility */

        /* ==================== BROWSER TAB PANE STYLES ==================== */
        #orb-pane-browser { padding: 0; overflow: hidden; }

        .browser-tab-status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .browser-tab-status-bar .status-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .browser-tab-status-bar .browser-status-text {
            font-size: 0.65rem;
        }

        .browser-tab-launch-btn {
            padding: 4px 12px;
            border-radius: 6px;
            border: 1px solid var(--glass-border);
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .browser-tab-launch-btn:hover {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.1);
        }
        .browser-tab-launch-btn.stop {
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--red);
        }
        .browser-tab-launch-btn.stop:hover {
            border-color: var(--red);
            background: rgba(239, 68, 68, 0.1);
        }
        .browser-tab-launch-btn svg { width: 12px; height: 12px; }

        .browser-tab-stopped {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 32px 16px;
            text-align: center;
        }
        .browser-tab-stopped .stopped-icon {
            width: 40px;
            height: 40px;
            color: var(--text-muted);
            opacity: 0.5;
        }
        .browser-tab-stopped .stopped-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .browser-tab-stopped .stopped-launch-btn {
            padding: 10px 24px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .browser-tab-stopped .stopped-launch-btn:hover {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }

        .browser-tab-running {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .browser-tab-screenshot {
            position: relative;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            flex: 1 1 auto;
            min-height: 120px;
            overflow: hidden;
            display: flex;
            align-items: stretch;
            justify-content: center;
            background: var(--bg-card);
        }
        .browser-tab-screenshot img {
            width: 100%;
            height: 100%;
            object-fit: fill;
            display: block;
        }
        .browser-tab-screenshot .screenshot-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 4px 8px;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            font-size: 0.55rem;
            color: rgba(255,255,255,0.5);
            font-family: 'Space Mono', monospace;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .browser-tab-screenshot:hover .screenshot-overlay { opacity: 1; }

        .browser-tab-url {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .browser-tab-url svg {
            width: 12px;
            height: 12px;
            flex-shrink: 0;
            color: var(--text-muted);
        }
        .browser-url-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--text-secondary);
        }
        .browser-url-input::placeholder { color: var(--text-muted); }

        .browser-tab-strip {
            max-height: 60px;
            overflow-y: auto;
            padding: 4px 8px;
            display: flex;
            flex-direction: column;
            gap: 3px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .browser-tab-strip:empty { display: none; }
        .browser-tab-strip::-webkit-scrollbar { width: 3px; }
        .browser-tab-strip::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 3px;
        }

        .browser-tab-controls {
            padding: 6px 10px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .browser-tab-step-log-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .browser-tab-step-log-header .log-label {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
        }
        .browser-tab-step-log-header .log-count {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            color: var(--accent-light);
            background: rgba(139, 92, 246, 0.15);
            padding: 1px 6px;
            border-radius: 8px;
        }

        .browser-tab-step-log {
            max-height: 100px;
            overflow-y: auto;
            padding: 4px 0;
            flex-shrink: 0;
        }
        .browser-tab-step-log::-webkit-scrollbar { width: 3px; }
        .browser-tab-step-log::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 3px;
        }

        .browser-step-entry {
            display: flex;
            gap: 8px;
            padding: 5px 10px;
            border-left: 2px solid rgba(99, 102, 241, 0.3);
            margin-left: 10px;
            transition: background 0.15s;
        }
        .browser-step-entry:hover { background: var(--bg-hover); }
        .browser-step-entry .step-num {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            color: var(--accent-light);
            flex-shrink: 0;
            min-width: 24px;
        }
        .browser-step-entry .step-body {
            flex: 1;
            min-width: 0;
        }
        .browser-step-entry .step-action {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .browser-step-entry .step-reasoning {
            font-size: 0.6rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .browser-step-entry .step-thumb {
            width: 36px;
            height: 24px;
            border-radius: 3px;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid var(--border);
        }

        .orb-browser-status-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        .orb-browser-status-dot.running {
            background: var(--accent);
            box-shadow: 0 0 6px var(--glow-medium);
        }
        .orb-browser-status-dot.paused {
            background: var(--yellow);
            box-shadow: 0 0 6px rgba(234, 179, 8, 0.5);
        }
        .orb-browser-status-dot.stopped { background: var(--text-muted); }

        @media (max-width: 768px) {
            .browser-tab-screenshot { min-height: 40px; }
            .browser-tab-step-log { max-height: 80px; }
        }

        /* ==================== OODA PHASE TRANSITIONS (Enhanced) ==================== */
        .ooda-phase-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            animation: phaseGlow 0.5s ease;
        }

        @keyframes phaseGlow {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .ooda-phase-indicator.observe {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .ooda-phase-indicator.orient {
            background: rgba(139, 92, 246, 0.15);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .ooda-phase-indicator.decide {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .ooda-phase-indicator.act {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Activity log phase grouping */
        .activity-phase-group {
            margin-bottom: 8px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(139, 92, 246, 0.1);
        }

        .activity-phase-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(18, 18, 30, 0.6);
            cursor: pointer;
            transition: background 0.2s;
        }

        .activity-phase-header:hover {
            background: rgba(18, 18, 30, 0.8);
        }

        .activity-phase-icon {
            font-size: 0.9rem;
        }

        .activity-phase-name {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        .activity-phase-summary {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-left: auto;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .activity-phase-details {
            padding: 6px 12px 10px;
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.5;
            display: none;
        }

        .activity-phase-group.expanded .activity-phase-details {
            display: block;
        }

        @media (max-width: 768px) {
            
        /* ==================== SECURITY ALERT POPUP ==================== */
        .security-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9800;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
        }
        .security-alert-overlay.visible {
            display: flex;
        }

        .security-alert-popup {
            width: min(520px, 92vw);
            background: rgba(20, 10, 10, 0.97);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(239, 68, 68, 0.6);
            border-radius: 16px;
            padding: 0;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.8),
                0 0 80px rgba(239, 68, 68, 0.3),
                0 0 120px rgba(239, 68, 68, 0.15);
            animation: securityAlertIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden;
        }

        .security-alert-popup.dismissing {
            animation: securityAlertOut 0.3s ease-in forwards;
        }

        @keyframes securityAlertIn {
            from { opacity: 0; transform: scale(0.8) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes securityAlertOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.85); }
        }

        .security-alert-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px 12px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
            border-bottom: 1px solid rgba(239, 68, 68, 0.3);
        }

        .security-alert-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .security-alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            background: rgba(239, 68, 68, 0.25);
            animation: securityPulse 1.5s ease-in-out infinite;
        }

        @keyframes securityPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
        }

        .security-alert-label {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--red);
        }

        .security-alert-severity {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 4px 10px;
            border-radius: 8px;
            font-weight: 700;
            background: rgba(239, 68, 68, 0.25);
            color: var(--red);
            border: 1px solid rgba(239, 68, 68, 0.4);
            animation: severityBlink 2s ease-in-out infinite;
        }

        @keyframes severityBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .security-alert-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.3rem;
            padding: 4px;
            line-height: 1;
            transition: color 0.2s;
        }
        .security-alert-close:hover { color: var(--red); }

        .security-alert-body {
            padding: 20px;
        }

        .security-alert-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.15rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 16px;
        }

        .security-alert-device {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.8;
            color: var(--text-secondary);
        }

        .security-alert-device strong {
            color: var(--red);
            font-weight: 600;
        }

        .security-alert-timestamp {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .security-alert-actions {
            display: flex;
            gap: 10px;
            padding: 14px 20px 18px;
            border-top: 1px solid rgba(239, 68, 68, 0.15);
        }

        .security-alert-btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: 10px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .security-alert-btn.dismiss {
            background: rgba(255, 255, 255, 0.06);
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .security-alert-btn.dismiss:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .security-alert-btn.investigate {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(239, 68, 68, 0.15));
            color: #fff;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }
        .security-alert-btn.investigate:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.45), rgba(239, 68, 68, 0.25));
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
        }

        .hitl-popup-container {
                padding: 10px;
            }
            .hitl-popup {
                width: 100%;
            }
        }

        /*  Stored Item Detail Popup  */
        .stored-item-detail-overlay {
            position: fixed; inset: 0; z-index: 9700;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        .stored-item-detail-popup {
            width: 92vw; max-width: 520px; max-height: 80vh;
            background: var(--glass-bg, rgba(20,20,35,0.95));
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            overflow: hidden; display: flex; flex-direction: column;
            animation: hitlScaleIn 0.25s ease;
            box-shadow: 0 24px 80px rgba(0,0,0,0.5);
        }
        .stored-item-detail-popup.type-alert {
            border-color: rgba(239,68,68,0.3);
            box-shadow: 0 24px 80px rgba(0,0,0,0.5), 0 0 40px rgba(239,68,68,0.08);
        }
        .stored-item-detail-popup.type-finding {
            border-color: rgba(59,130,246,0.3);
            box-shadow: 0 24px 80px rgba(0,0,0,0.5), 0 0 40px rgba(59,130,246,0.08);
        }
        .stored-item-detail-popup.type-agent_result {
            border-color: rgba(34,197,94,0.3);
            box-shadow: 0 24px 80px rgba(0,0,0,0.5), 0 0 40px rgba(34,197,94,0.08);
        }

        .stored-item-detail-header {
            padding: 16px 20px;
            display: flex; align-items: center; gap: 12px;
            position: relative;
        }
        .stored-item-detail-header.type-alert {
            background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.05));
            border-bottom: 1px solid rgba(239,68,68,0.15);
        }
        .stored-item-detail-header.type-finding {
            background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(59,130,246,0.05));
            border-bottom: 1px solid rgba(59,130,246,0.15);
        }
        .stored-item-detail-header.type-agent_result {
            background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05));
            border-bottom: 1px solid rgba(34,197,94,0.15);
        }
        .stored-item-detail-icon {
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; flex-shrink: 0;
        }
        .stored-item-detail-icon.type-alert {
            background: rgba(239,68,68,0.2); color: #ef4444;
        }
        .stored-item-detail-icon.type-finding {
            background: rgba(59,130,246,0.2); color: #3b82f6;
        }
        .stored-item-detail-icon.type-agent_result {
            background: rgba(34,197,94,0.2); color: #22c55e;
        }
        .stored-item-detail-header-text { flex: 1; min-width: 0; }
        .stored-item-detail-type-label {
            font-size: 0.65rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        .stored-item-detail-type-label.type-alert { color: #ef4444; }
        .stored-item-detail-type-label.type-finding { color: #3b82f6; }
        .stored-item-detail-type-label.type-agent_result { color: #22c55e; }
        .stored-item-detail-title {
            font-size: 1rem; font-weight: 600; color: var(--text-primary, #fff);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .stored-item-detail-close {
            position: absolute; top: 12px; right: 12px;
            width: 28px; height: 28px; border-radius: 8px;
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08);
            color: var(--text-secondary, #aaa); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; transition: background 0.15s;
        }
        .stored-item-detail-close:hover {
            background: rgba(255,255,255,0.12); color: #fff;
        }

        .stored-item-detail-body {
            flex: 1; overflow-y: auto; padding: 20px;
        }
        .stored-item-detail-fields {
            display: grid; grid-template-columns: auto 1fr;
            gap: 8px 16px; align-items: baseline;
        }
        .stored-item-detail-field-label {
            font-size: 0.75rem; font-weight: 600; color: var(--text-secondary, #aaa);
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        .stored-item-detail-field-value {
            font-size: 0.88rem; color: var(--text-primary, #fff);
            font-family: 'JetBrains Mono', monospace; word-break: break-all;
        }
        .stored-item-detail-markdown {
            font-size: 0.88rem; color: var(--text-primary, #fff);
            line-height: 1.6;
        }
        .stored-item-detail-markdown p { margin: 0 0 8px 0; }
        .stored-item-detail-markdown strong { color: #fff; }
        .stored-item-detail-markdown code {
            background: rgba(255,255,255,0.06); padding: 1px 5px;
            border-radius: 4px; font-size: 0.82rem;
        }
        .stored-item-detail-timestamp {
            margin-top: 16px; padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.06);
            font-size: 0.72rem; color: var(--text-tertiary, #666);
        }
        .stored-item-detail-meta {
            margin-top: 12px; padding: 10px 12px;
            background: rgba(255,255,255,0.03); border-radius: 8px;
            font-size: 0.75rem; color: var(--text-secondary, #aaa);
        }
        .stored-item-detail-meta-row {
            display: flex; justify-content: space-between; padding: 2px 0;
        }

        .stored-item-detail-actions {
            padding: 12px 20px; display: flex; gap: 10px; justify-content: flex-end;
            border-top: 1px solid rgba(255,255,255,0.06);
            background: rgba(0,0,0,0.15);
        }
        .stored-item-detail-btn {
            padding: 8px 18px; border-radius: 8px; font-size: 0.82rem;
            font-weight: 600; cursor: pointer; border: none;
            transition: all 0.15s;
        }
        .stored-item-detail-btn.delete {
            background: rgba(239,68,68,0.12); color: #ef4444;
            border: 1px solid rgba(239,68,68,0.2);
        }
        .stored-item-detail-btn.delete:hover {
            background: rgba(239,68,68,0.25);
        }
        .stored-item-detail-btn.investigate {
            color: #fff;
        }
        .stored-item-detail-btn.investigate.type-alert {
            background: linear-gradient(135deg, rgba(239,68,68,0.3), rgba(239,68,68,0.15));
            border: 1px solid rgba(239,68,68,0.4);
        }
        .stored-item-detail-btn.investigate.type-alert:hover {
            background: linear-gradient(135deg, rgba(239,68,68,0.45), rgba(239,68,68,0.25));
            box-shadow: 0 4px 20px rgba(239,68,68,0.2);
        }
        .stored-item-detail-btn.investigate.type-finding {
            background: linear-gradient(135deg, rgba(59,130,246,0.3), rgba(59,130,246,0.15));
            border: 1px solid rgba(59,130,246,0.4);
        }
        .stored-item-detail-btn.investigate.type-finding:hover {
            background: linear-gradient(135deg, rgba(59,130,246,0.45), rgba(59,130,246,0.25));
            box-shadow: 0 4px 20px rgba(59,130,246,0.2);
        }
        .stored-item-detail-btn.investigate.type-agent_result {
            background: linear-gradient(135deg, rgba(34,197,94,0.3), rgba(34,197,94,0.15));
            border: 1px solid rgba(34,197,94,0.4);
        }
        .stored-item-detail-btn.investigate.type-agent_result:hover {
            background: linear-gradient(135deg, rgba(34,197,94,0.45), rgba(34,197,94,0.25));
            box-shadow: 0 4px 20px rgba(34,197,94,0.2);
        }
        .stored-item-detail-popup.closing {
            animation: hitlScaleOut 0.2s ease forwards;
        }
        .stored-item-detail-overlay.closing {
            animation: fadeIn 0.2s ease reverse forwards;
        }


        /* ================================================================
           Voice Screenshot - Toast + Fullscreen Overlay
           ================================================================ */
        .voice-screenshot-toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 320px;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 14px;
            z-index: 9998;
            box-shadow: var(--shadow-lg), 0 0 30px var(--accent-glow);
            animation: vsToastIn 0.4s var(--ease-out-back);
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.3s ease;
        }
        .voice-screenshot-toast:hover {
            transform: translateY(-2px);
            border-color: var(--glass-border-hover);
        }
        .voice-screenshot-toast.dismissing {
            opacity: 0;
            transform: translateY(10px);
        }
        .voice-screenshot-toast .vs-toast-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .voice-screenshot-toast .vs-toast-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .voice-screenshot-toast .vs-toast-title {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        .voice-screenshot-toast .vs-toast-close {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
        }
        .voice-screenshot-toast .vs-toast-thumb {
            width: 100%;
            border-radius: 10px;
            max-height: 180px;
            object-fit: cover;
            border: 1px solid var(--border);
        }

        @keyframes vsToastIn {
            from { opacity: 0; transform: translateX(40px) scale(0.95); }
            to { opacity: 1; transform: translateX(0) scale(1); }
        }

        .voice-screenshot-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding: 20px;
        }
        .voice-screenshot-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .voice-screenshot-overlay img {
            max-width: 95vw;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 0 60px rgba(139, 92, 246, 0.3);
        }
        .voice-screenshot-overlay .vs-overlay-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .voice-screenshot-overlay .vs-overlay-bar .vs-window-title {
            color: var(--text-primary);
            font-weight: 500;
        }
        .voice-screenshot-overlay .vs-overlay-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            transition: background 0.2s;
        }
        .voice-screenshot-overlay .vs-overlay-close:hover {
            background: var(--bg-hover);
        }

    </style>
</head>
<body>
    <!-- Ambient particle background -->
    <div id="particles-bg"></div>

    <div class="app" id="app">
        <!-- Login View -->
        <div class="login-view" id="login-view">
            <div class="login-card">
                <div class="login-logo">C</div>
                <div class="login-title">Cerebro</div>
                <div class="login-subtitle">Your AI, Everywhere</div>
                <input type="password" class="login-input" id="password-input" placeholder="Enter password" autocomplete="current-password">
                <button class="login-btn" onclick="login()">Sign In</button>
                <div class="login-error" id="login-error">Invalid password</div>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="hidden">
            <!-- Header -->
            <header class="header">
                <div class="logo">
                    <div class="nav-orb-container" id="nav-orb-container" title="Click to start/stop voice conversation">
                        <div class="nav-orb-ring"></div>
                        <div class="nav-orb-ring"></div>
                        <div class="nav-orb">
                            <div class="nav-orb-inner"></div>
                        </div>
                    </div>
                    <span class="logo-text">Cerebro</span>
                </div>
                <div class="header-status">
                    <!-- Notification Bell -->
                    <div class="notification-bell" id="notification-bell" onclick="toggleNotificationPanel()">
                        <span class="bell-icon icon icon-bell"></span>
                        <span class="notification-badge hidden" id="notification-badge">0</span>
                    </div>
                    <div class="sync-badge" id="sync-badge" title="Connected devices">
                        <div class="sync-dot"></div>
                        <span id="device-count">1</span>
                    </div>
                    <div class="status-badge">
                        <div class="status-dot" id="status-dot"></div>
                        <span id="status-text">Online</span>
                    </div>
                </div>

                <!-- Notification Panel Dropdown -->
                <div class="notification-panel hidden" id="notification-panel">
                    <div class="notification-panel-header">
                        <span>Notifications</span>
                        <button class="mark-all-read-btn" onclick="markAllNotificationsRead()">Mark all read</button>
                    </div>
                    <div class="notification-list" id="notification-list">
                        <div class="no-notifications">No notifications</div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Home View -->
                <div class="view home-view active" id="view-home">

                    <!-- Section 1: Compact Hero Bar -->
                    <div class="hero-bar" id="cerebro-presence">
                        <div class="hero-bar-main">
                            <div class="hero-orb-mini">
                                <div class="core-ring"></div>
                                <div class="core-ring"></div>
                                <div class="core-orb">
                                    <div class="core-inner"></div>
                                </div>
                            </div>
                            <div class="hero-info">
                                <div class="hero-greeting" id="presence-greeting">Hey Professor</div>
                                <div class="hero-status">
                                    <div class="status-indicator" id="cerebro-status-indicator"></div>
                                    <span id="cerebro-status-text">Awake and ready</span>
                                    <div class="mood-indicator" id="mood-indicator" style="margin-left:8px">
                                        <span class="mood-dot" id="mood-emoji"></span>
                                        <span id="mood-text">Focused</span>
                                    </div>
                                </div>
                            </div>
                            <div class="hero-datetime" id="hero-datetime"></div>
                        </div>
                        <div class="hero-pills">
                            <div class="stat-pill" onclick="openHomeDetail('stat', {name:'Memories', value: this.querySelector('.stat-pill-value').textContent, icon:'\u{1F9E0}', context:'Total indexed memories across all conversations.'})">
                                <span class="stat-pill-value" id="memory-count">0</span>
                                <span class="stat-pill-label">Memories</span>
                            </div>
                            <div class="stat-pill" onclick="openHomeDetail('stat', {name:'Learnings', value: this.querySelector('.stat-pill-value').textContent, icon:'\u{1F4DA}', context:'Solutions, patterns, and insights recorded from sessions.'})">
                                <span class="stat-pill-value" id="home-learnings-count">0</span>
                                <span class="stat-pill-label">Learnings</span>
                            </div>
                            <div class="stat-pill" onclick="openHomeDetail('stat', {name:'Patterns', value: this.querySelector('.stat-pill-value').textContent, icon:'\u{1F50D}', context:'Promoted patterns from 3+ recurring learnings.'})">
                                <span class="stat-pill-value" id="home-patterns-count">0</span>
                                <span class="stat-pill-label">Patterns</span>
                            </div>
                            <div class="stat-pill" onclick="openHomeDetail('stat', {name:'Active Agents', value: this.querySelector('.stat-pill-value').textContent, icon:'\u{1F916}', context:'Currently running autonomous agents.'})">
                                <span class="stat-pill-value" id="active-agents-count">0</span>
                                <span class="stat-pill-label">Agents</span>
                            </div>
                            <div class="stat-pill" onclick="openHomeDetail('stat', {name:'Goals', value: this.querySelector('.stat-pill-value').textContent, icon:'\u{1F3AF}', context:'Active goals being tracked and pursued.'})">
                                <span class="stat-pill-value" id="home-goals-count">0</span>
                                <span class="stat-pill-label">Goals</span>
                            </div>
                            <div class="stat-pill" onclick="openHomeDetail('stat', {name:'System Health', value: this.querySelector('.stat-pill-value').textContent, icon:'\u2764\uFE0F', context:'Overall knowledge base health score.'})">
                                <span class="stat-pill-value" id="system-health">100%</span>
                                <span class="stat-pill-label">Health</span>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Smart Next Actions (always visible) -->
                    <div class="home-section" id="home-section-actions">
                        <div class="section-title">Next Actions</div>
                        <div class="smart-actions-scroll" id="smart-actions-container">
                            <div class="loading-container"><div class="spinner"></div></div>
                        </div>
                    </div>

                    <!-- Section 3: Live Activity (collapsible, default expanded) -->
                    <div class="home-section" id="home-section-activity">
                        <div class="section-collapse-header" onclick="toggleSection('activity')">
                            <div class="section-collapse-left">
                                <span class="section-title" style="margin-bottom:0">Live Activity</span>
                                <span class="section-count-badge" id="activity-count-badge">3</span>
                            </div>
                            <span class="section-chevron" id="activity-chevron">&#9660;</span>
                        </div>
                        <div class="home-section-body" id="activity-section-body">
                            <div class="live-activity-grid" id="live-activity-grid">
                                <div class="live-card" onclick="openHomeDetail('activity', {type:'agents', title:'Running Agents'})">
                                    <div class="live-card-header">
                                        <span class="live-card-icon">&#x1F916;</span>
                                        <span class="live-card-title">Running Agents</span>
                                    </div>
                                    <div class="live-card-body" id="live-agents-body">
                                        <div class="live-empty">No agents running</div>
                                    </div>
                                </div>
                                <div class="live-card" onclick="openHomeDetail('activity', {type:'health', title:'System Health'})">
                                    <div class="live-card-header">
                                        <span class="live-card-icon">&#x1F5A5;&#xFE0F;</span>
                                        <span class="live-card-title">System Health</span>
                                    </div>
                                    <div class="live-card-body" id="live-health-body">
                                        <div class="status-grid" id="system-status-grid">
                                            <div class="status-item"><span class="status-dot online"></span><span class="status-name">Loading...</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="live-card" onclick="openHomeDetail('activity', {type:'autonomy', title:'Autonomy'})">
                                    <div class="live-card-header">
                                        <span class="live-card-icon">&#x1F9E0;</span>
                                        <span class="live-card-title">Autonomy</span>
                                    </div>
                                    <div class="live-card-body" id="live-autonomy-body">
                                        <div class="live-empty">Idle</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 4: Goals & Progress (collapsible, default expanded) -->
                    <div class="home-section" id="home-goals-section">
                        <div class="section-collapse-header" onclick="toggleSection('goals')">
                            <div class="section-collapse-left">
                                <span class="section-title" style="margin-bottom:0">Goals</span>
                                <span class="section-count-badge" id="goals-count-badge">0</span>
                            </div>
                            <span class="section-chevron" id="goals-chevron">&#9660;</span>
                        </div>
                        <div class="home-section-body" id="goals-section-body">
                            <div class="home-goals-list" id="home-goals-list">
                                <div class="live-empty">Loading goals...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 5: Project Tracker (collapsible, default collapsed) -->
                    <div class="home-section collapsed" id="home-section-projects">
                        <div class="section-collapse-header" onclick="toggleSection('projects')">
                            <div class="section-collapse-left">
                                <span class="section-title" style="margin-bottom:0">Projects</span>
                                <span class="section-count-badge" id="projects-count-badge">0</span>
                            </div>
                            <span class="section-chevron" id="projects-chevron">&#9660;</span>
                        </div>
                        <div class="home-section-body" id="projects-section-body">
                            <div class="project-tracker-scroll" id="project-tracker-container">
                                <div class="loading-container"><div class="spinner"></div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 6: Memory Intelligence (collapsible, default collapsed) -->
                    <div class="home-section collapsed" id="home-section-memory">
                        <div class="section-collapse-header" onclick="toggleSection('memory')">
                            <div class="section-collapse-left">
                                <span class="section-title" style="margin-bottom:0">Memory Intelligence</span>
                                <span class="section-count-badge" id="memory-section-count-badge">6</span>
                            </div>
                            <span class="section-chevron" id="memory-chevron">&#9660;</span>
                        </div>
                        <div class="home-section-body" id="memory-section-body">
                            <div class="mem-intel-grid" id="mem-intel-grid">
                                <div class="mem-tile green" onclick="openHomeDetail('stat', {name:'Total Memories', value: document.getElementById('intel-total-memories').textContent, icon:'&#x1F9E0;', context:'Total indexed memories across all conversations and knowledge base entries.'})">
                                    <div class="mem-tile-value" id="intel-total-memories">--</div>
                                    <div class="mem-tile-label">Total Memories</div>
                                </div>
                                <div class="mem-tile purple" onclick="openHomeDetail('stat', {name:'This Week', value: document.getElementById('intel-recent-learnings').textContent, icon:'&#x1F4DA;', context:'New learnings recorded in the past 7 days from conversations and discoveries.'})">
                                    <div class="mem-tile-value" id="intel-recent-learnings">--</div>
                                    <div class="mem-tile-label">This Week</div>
                                </div>
                                <div class="mem-tile purple" onclick="openHomeDetail('stat', {name:'Patterns', value: document.getElementById('intel-patterns').textContent, icon:'&#x1F50D;', context:'Promoted patterns that graduated from 3+ recurring learnings.'})">
                                    <div class="mem-tile-value" id="intel-patterns">--</div>
                                    <div class="mem-tile-label">Patterns</div>
                                </div>
                                <div class="mem-tile amber" onclick="openHomeDetail('stat', {name:'Contradictions', value: document.getElementById('intel-contradictions').textContent, icon:'&#x26A0;&#xFE0F;', context:'Pending contradictions in the knowledge base that need resolution.'})">
                                    <div class="mem-tile-value" id="intel-contradictions">--</div>
                                    <div class="mem-tile-label">Contradictions</div>
                                </div>
                                <div class="mem-tile green" onclick="openHomeDetail('stat', {name:'Knowledge Health', value: document.getElementById('intel-health').textContent, icon:'&#x2764;&#xFE0F;', context:'Overall health score based on freshness, consistency, and coverage of the knowledge base.'})">
                                    <div class="mem-tile-value" id="intel-health">--</div>
                                    <div class="mem-tile-label">Knowledge Health</div>
                                </div>
                                <div class="mem-tile purple" onclick="openHomeDetail('stat', {name:'FAISS Index', value: document.getElementById('intel-faiss').textContent, icon:'&#x1F4BE;', context:'Size of the FAISS vector search index used for semantic memory retrieval.'})">
                                    <div class="mem-tile-value" id="intel-faiss">--</div>
                                    <div class="mem-tile-label">FAISS Index</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 7: Recent Agents -->
                    <div class="home-section" id="recent-agents-section" style="display:none">
                        <div class="section-title">Recent Agents</div>
                        <div class="recent-agents-list" id="recent-agents-list"></div>
                    </div>

                    <!-- Hidden elements for compatibility -->
                    <span id="uptime-display" style="display:none">Online</span>
                </div>

                <!-- Chat View -->
                <div class="view chat-view" id="view-chat">
                    <div class="messages-container" id="messages">
                        <div class="message assistant" data-text="Hey! I'm Cerebro, your AI command center. I can spawn agents, search your memory, run automations, or help with anything else. What do you need?">
                            <div class="assistant-card-header">
                                <div class="assistant-card-meta">
                                    <span class="assistant-card-timestamp">Welcome</span>
                                    <span class="assistant-card-model"></span>
                                </div>
                            </div>
                            <div class="tool-tracker" style="display:none;"></div>
                            <div class="assistant-card-body">
                                <div class="message-content-wrapper">Hey! I'm Cerebro, your AI command center. I can spawn agents, search your memory, run automations, or help with anything else. What do you need?</div>
                            </div>
                            <div class="assistant-card-actions">
                                <button class="chat-speak-btn" title="Listen to this message" onclick="speakMessageContent(this.closest('.message'), this)">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <div class="quick-action-pills">
                            <button class="quick-action-pill" onclick="sendQuickAction('Run a full system diagnostics check')">System Check</button>
                            <button class="quick-action-pill" onclick="sendQuickAction('Check all running agents and their progress')">Agent Progress</button>
                            <button class="quick-action-pill" onclick="sendQuickAction('Show my recent memory and active work')">Memory Status</button>
                            <button class="quick-action-pill" onclick="clearChatHistory()">Clear Chat</button>
                        </div>
                        <div class="chat-input-wrapper">
                            <div class="input-model-selector">
                                <button class="input-model-btn" id="input-model-btn" onclick="toggleInputModelDropdown()">
                                    <span class="model-dot" id="input-model-dot"></span>
                                    <span id="input-model-label">Sonnet 4.5</span>
                                    <svg class="chevron-icon" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                                </button>
                                <div class="input-model-dropdown" id="input-model-dropdown">
                                    <button class="model-option" data-model="claude-opus-4-6" onclick="selectModel('claude-opus-4-6')">
                                        <span class="model-dot opus"></span>
                                        <div class="model-info"><div class="model-name">Claude Opus 4.6</div><div class="model-desc">Most capable</div></div>
                                        <svg class="model-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                                    </button>
                                    <button class="model-option" data-model="claude-sonnet-4-5-20250929" onclick="selectModel('claude-sonnet-4-5-20250929')">
                                        <span class="model-dot sonnet"></span>
                                        <div class="model-info"><div class="model-name">Claude Sonnet 4.5</div><div class="model-desc">Balanced</div></div>
                                        <svg class="model-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                                    </button>
                                    <button class="model-option" data-model="claude-haiku-4-5-20251001" onclick="selectModel('claude-haiku-4-5-20251001')">
                                        <span class="model-dot haiku"></span>
                                        <div class="model-info"><div class="model-name">Claude Haiku 4.5</div><div class="model-desc">Fastest</div></div>
                                        <svg class="model-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                                    </button>
                                </div>
                            </div>
                            <button class="attach-btn" onclick="triggerFileAttach()" title="Attach file">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                            </button>
                            <textarea class="chat-input" id="chat-input" placeholder="Message Cerebro..." rows="1" onkeydown="handleKeyDown(event)"></textarea>
                            <div class="input-actions">
                                <button class="voice-btn" id="voice-btn" onmousedown="startVoice()" onmouseup="stopVoice()" ontouchstart="startVoice()" ontouchend="stopVoice()">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                                </button>
                                <button class="browser-toggle-btn" id="chat-browser-btn" onclick="toggleChatBrowser()" title="Launch/Stop Browser">
                                    <span class="chat-browser-dot" id="chat-browser-dot"></span>
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                                </button>
                                <button class="send-btn" onclick="sendMessage()" id="send-btn">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M22 2L11 13"/>
                                        <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions View -->
                <div class="view quick-view" id="view-quick">
                    <div class="action-section">
                        <div class="section-title">System Control</div>
                        <div class="action-grid">
                            <div class="action-btn" onclick="runQuickAction('start chrome')">
                                <div class="action-btn-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></div>
                                <div class="action-btn-label">Chrome</div>
                            </div>
                            <div class="action-btn" onclick="runQuickAction('code')">
                                <div class="action-btn-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></div>
                                <div class="action-btn-label">VS Code</div>
                            </div>
                            <div class="action-btn" onclick="runQuickAction('start wt')">
                                <div class="action-btn-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg></div>
                                <div class="action-btn-label">Terminal</div>
                            </div>
                            <div class="action-btn" onclick="runQuickAction('start chrome https://youtube.com')">
                                <div class="action-btn-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>
                                <div class="action-btn-label">YouTube</div>
                            </div>
                            <div class="action-btn" onclick="runQuickAction(CEREBRO_DATA_DIR ? 'explorer ' + CEREBRO_DATA_DIR : 'echo No data dir configured')">
                                <div class="action-btn-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></div>
                                <div class="action-btn-label">Files</div>
                            </div>
                            <div class="action-btn" onclick="runQuickAction('start chrome https://github.com')">
                                <div class="action-btn-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg></div>
                                <div class="action-btn-label">GitHub</div>
                            </div>
                            <div class="action-btn" onclick="runQuickAction('start chrome https://claude.ai')">
                                <div class="action-btn-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg></div>
                                <div class="action-btn-label">Claude</div>
                            </div>
                            <div class="action-btn" onclick="runQuickAction('start chrome https://chat.openai.com')">
                                <div class="action-btn-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/></svg></div>
                                <div class="action-btn-label">ChatGPT</div>
                            </div>
                        </div>
                    </div>

                    <div class="action-section">
                        <div class="section-title">Dev Tools</div>
                        <div class="action-row">
                            <div class="action-wide" onclick="startChat('Run git status in my current project and show me any uncommitted changes')">
                                <span class="action-wide-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M6 21V9a9 9 0 0 0 9 9"/></svg></span>
                                <span class="action-wide-label">Git Status</span>
                            </div>
                            <div class="action-wide" onclick="startChat('Check the health of all my services and servers')">
                                <span class="action-wide-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg></span>
                                <span class="action-wide-label">Health Check</span>
                            </div>
                        </div>
                        <div class="action-row" style="margin-top: 12px;">
                            <div class="action-wide" onclick="startChat('Show me my recent AI Memory learnings from the past week')">
                                <span class="action-wide-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg></span>
                                <span class="action-wide-label">Recent Learnings</span>
                            </div>
                            <div class="action-wide" onclick="startChat('What projects do I have and what is their current status?')">
                                <span class="action-wide-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg></span>
                                <span class="action-wide-label">All Projects</span>
                            </div>
                        </div>
                    </div>

                    <div class="action-section">
                        <div class="section-title">AI Memory</div>
                        <div class="action-row">
                            <div class="action-wide" onclick="startChat('Save this conversation to AI Memory')">
                                <span class="action-wide-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></span>
                                <span class="action-wide-label">Save Session</span>
                            </div>
                            <div class="action-wide" onclick="startChat('Run a memory health check and show me stats')">
                                <span class="action-wide-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span>
                                <span class="action-wide-label">Memory Stats</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Agents View -->
                <div class="view agents-view" id="view-agents">
                    <div class="agents-header">
                        <div class="agents-tab-control">
                            <button class="agents-tab active" data-tab="user" onclick="switchAgentsTab('user')">My Agents</button>
                            <button class="agents-tab" data-tab="cerebro" onclick="switchAgentsTab('cerebro')">Cerebro</button>
                            <button class="agents-tab" data-tab="idle" onclick="switchAgentsTab('idle')">Idle</button>
                        </div>
                        <div class="agents-header-row">
                            <div class="agents-count" id="agents-count">0 running</div>
                            <button class="btn btn-secondary btn-select-header" id="agent-select-toggle-btn" onclick="toggleAgentSelectMode()">
                                Select
                            </button>
                        </div>
                    </div>

                    <div id="agents-container">
                        <div class="no-agents">
                            <div class="no-agents-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="8" r="5"/><path d="M3 21v-2a7 7 0 0 1 7-7h4a7 7 0 0 1 7 7v2"/></svg></div>
                            <div>No agents running</div>
                            <div style="font-size: 0.85rem; margin-top: 8px; color: var(--text-muted);">
                                Spawn agents from suggestions or chat
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-block spawn-agent-btn" onclick="showSpawnAgentDialog()">
                        + Spawn New Agent
                    </button>

                    <!-- Selection action bar (shown when agents are selected) -->
                    <div class="selection-action-bar" id="selection-action-bar" style="display: none;">
                        <span class="selection-count" id="selection-count">0 selected</span>
                        <button class="btn btn-primary" onclick="showMergeSpawnModal()">Merge &amp; Spawn</button>
                        <button class="btn btn-secondary" onclick="clearAgentSelection()">Clear</button>
                    </div>

                    <!-- Archived Agents Section -->
                    <div class="archive-section" id="archive-section">
                        <div class="archive-toggle" onclick="toggleArchiveSection()">
                            <span class="archive-toggle-icon" id="archive-toggle-icon"></span>
                            <span>Archived Agents</span>
                            <span class="archived-count" id="archived-count">(0)</span>
                        </div>
                        <div class="archived-agents-container hidden" id="archived-agents-container">
                            <!-- Archived agents rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Autonomy View - Consciousness Interface -->
                <div class="view autonomy-view" id="view-autonomy">

                    <!-- Question Input Overlay (legacy) -->
                    <div class="question-input-overlay" id="question-input-overlay">
                        <div class="question-input-card">
                            <div class="question-input-header">
                                <div class="question-input-title">Cerebro wants to know</div>
                                <div class="question-input-question" id="question-input-text"></div>
                            </div>
                            <textarea class="question-input-field" id="question-answer-field" placeholder="Share your thoughts..."></textarea>
                            <div class="question-input-actions">
                                <button class="question-input-btn cancel" onclick="closeQuestionInput()">Cancel</button>
                                <button class="question-input-btn submit" onclick="submitQuestionAnswer()">Share</button>
                            </div>
                        </div>
                    </div>

                    <!-- Questions Wizard Modal -->
                    <div class="questions-wizard-overlay" id="questions-wizard-overlay" onclick="closeWizardIfBackground(event)">
                        <div class="questions-wizard">
                            <div class="wizard-header">
                                <div class="wizard-header-left">
                                    <span class="wizard-icon"></span>
                                    <span class="wizard-title">Cerebro needs your input</span>
                                </div>
                                <button class="wizard-close" onclick="closeQuestionsWizard()"></button>
                            </div>
                            <div class="wizard-progress">
                                <div class="wizard-progress-bar" id="wizard-progress-bar"></div>
                                <span class="wizard-progress-text" id="wizard-progress-text">1 of 3</span>
                            </div>
                            <div class="wizard-content" id="wizard-content">
                                <!-- Question content goes here -->
                            </div>
                            <div class="wizard-actions">
                                <button class="wizard-btn skip" onclick="skipWizardQuestion()">Skip</button>
                                <div class="wizard-actions-right">
                                    <button class="wizard-btn prev" id="wizard-prev-btn" onclick="prevWizardQuestion()"> Back</button>
                                    <button class="wizard-btn next" id="wizard-next-btn" onclick="nextWizardQuestion()">Next </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- HITL Popup Container (top-right corner notifications) -->
                    <div class="hitl-popup-container" id="hitl-popup-container"></div>

                    <!-- Research Findings Overlay -->
                    <div class="findings-overlay" id="findings-overlay" onclick="closeFindingsIfBackground(event)">
                        <div class="findings-modal">
                            <div class="findings-header">
                                <div class="findings-header-content">
                                    <div class="findings-directive" id="findings-directive-text">Research on walruses</div>
                                    <div class="findings-meta">
                                        <div class="findings-meta-item">
                                            <span class="findings-meta-dot active" id="findings-status-dot"></span>
                                            <span id="findings-status-text">Actively researching</span>
                                        </div>
                                        <div class="findings-meta-item">
                                            <span>Started</span>
                                            <span id="findings-started">2 hours ago</span>
                                        </div>
                                        <div class="findings-meta-item">
                                            <span id="findings-count">12 findings</span>
                                        </div>
                                    </div>
                                </div>
                                <button class="findings-close" onclick="closeFindingsPopup()">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 6L6 18M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>

                            <div class="findings-tabs">
                                <button class="findings-tab summary-tab" data-tab="summary" onclick="switchFindingsTab('summary')">
                                     Summary
                                </button>
                                <button class="findings-tab active" data-tab="all" onclick="switchFindingsTab('all')">
                                    All<span class="findings-tab-count" id="findings-count-all">0</span>
                                </button>
                                <button class="findings-tab" data-tab="observations" onclick="switchFindingsTab('observations')">
                                    Observations<span class="findings-tab-count" id="findings-count-observations">0</span>
                                </button>
                                <button class="findings-tab" data-tab="learnings" onclick="switchFindingsTab('learnings')">
                                    Learnings<span class="findings-tab-count" id="findings-count-learnings">0</span>
                                </button>
                                <button class="findings-tab" data-tab="insights" onclick="switchFindingsTab('insights')">
                                    Insights<span class="findings-tab-count" id="findings-count-insights">0</span>
                                </button>
                            </div>

                            <div class="findings-content" id="findings-content">
                                <!-- Findings will be rendered here -->
                                <div class="findings-empty">
                                    <div class="findings-empty-icon"></div>
                                    <div class="findings-empty-text">No findings yet. Cerebro is still researching...</div>
                                </div>
                            </div>

                            <div class="findings-footer">
                                <div class="findings-status">
                                    <span>Research saturation:</span>
                                    <div class="saturation-bar">
                                        <div class="saturation-fill" id="saturation-fill" style="width: 35%"></div>
                                    </div>
                                    <span id="saturation-percent">35%</span>
                                </div>
                                <div class="findings-actions">
                                    <button class="findings-btn secondary" id="findings-pause-btn" onclick="toggleDirectivePause()">
                                        Pause Research
                                    </button>
                                    <button class="findings-btn danger" onclick="markDirectiveComplete()">
                                        Mark Complete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Edge Indicators for slide-out panels -->
                    <div class="edge-indicator left" onclick="openSlidePanel('activity')" title="Activity Timeline"></div>
                    <div class="edge-indicator right" onclick="openSlidePanel('skills')" title="Skills & Details"></div>

                    <!-- Slide-out Panel Backdrop -->
                    <div class="slide-panel-backdrop" id="slide-panel-backdrop" onclick="closeSlidePanel()"></div>

                    <!-- Left Slide-Out: Activity Timeline -->
                    <div class="slide-panel left" id="slide-panel-activity">
                        <div class="slide-panel-header">
                            <span class="slide-panel-title">Activity</span>
                            <div style="display:flex;align-items:center;gap:6px;">
                                <button class="activity-clear-btn" onclick="clearActivityLog()" title="Clear log" style="opacity:0.5;background:none;border:none;color:var(--text-muted);cursor:pointer;padding:2px;">
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                                </button>
                                <button class="slide-panel-close" onclick="closeSlidePanel()">&times;</button>
                            </div>
                        </div>
                        <div class="slide-panel-body" id="slide-activity-log">
                            <div class="sidebar-empty">
                                <div class="sidebar-empty-text" style="opacity:0.4;font-size:0.72rem;">Waiting for activity...</div>
                            </div>
                        </div>
                        <!-- Controls at bottom of activity panel -->
                        <div style="padding: 12px 16px; border-top: 1px solid rgba(139, 92, 246, 0.1); flex-shrink: 0;">
                            <div class="controls-stats" style="display:flex; gap:12px; margin-bottom:10px;">
                                <div class="controls-stat" style="text-align:center; flex:1;">
                                    <div class="controls-stat-value" id="slide-stat-cycles" style="font-family:'Space Mono',monospace; font-size:1rem; color:var(--text-primary);">0</div>
                                    <div class="controls-stat-label" style="font-size:0.6rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em;">Cycles</div>
                                </div>
                                <div class="controls-stat" style="text-align:center; flex:1;">
                                    <div class="controls-stat-value" id="slide-stat-actions" style="font-family:'Space Mono',monospace; font-size:1rem; color:var(--text-primary);">0</div>
                                    <div class="controls-stat-label" style="font-size:0.6rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em;">Actions</div>
                                </div>
                                <div class="controls-stat" style="text-align:center; flex:1;">
                                    <div class="controls-stat-value" id="slide-stat-pending" style="font-family:'Space Mono',monospace; font-size:1rem; color:var(--text-primary);">0</div>
                                    <div class="controls-stat-label" style="font-size:0.6rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em;">Pending</div>
                                </div>
                            </div>
                            <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                                <span style="font-size:0.65rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em;">Level</span>
                                <input type="range" min="1" max="5" value="2" class="level-slider-compact" id="slide-level-slider" onchange="setAutonomyLevel(this.value)" style="flex:1;">
                                <span id="slide-level-value" style="font-family:'Space Mono',monospace; font-size:0.8rem; color:var(--accent-light);">2</span>
                            </div>
                            <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                    <input type="checkbox" id="slide-full-autonomy-toggle" onchange="toggleFullAutonomy(this.checked)" style="accent-color:var(--accent);">
                                    <span style="font-size:0.7rem; color:var(--text-secondary);">Full Autonomy</span>
                                </label>
                                <button class="emergency-stop-btn" onclick="emergencyStop()" title="Stop All" style="padding:6px 12px; font-size:0.65rem; background:rgba(239,68,68,0.15); border:1px solid rgba(239,68,68,0.3); border-radius:8px; color:#f87171; cursor:pointer;">
                                    STOP ALL
                                </button>
                            </div>
                            <!-- Browser Control -->
                            <div id="slide-browser-panel" style="margin-top:10px;">
                                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
                                    <div style="display:flex; align-items:center; gap:6px;">
                                        <div class="browser-status-dot stopped" id="slide-browser-status-dot" style="width:6px; height:6px; border-radius:50%;"></div>
                                        <span style="font-size:0.7rem; color:var(--text-secondary);">Browser</span>
                                    </div>
                                    <span style="font-size:0.65rem; color:var(--text-muted);" id="slide-browser-status-text">Stopped</span>
                                </div>
                                <button id="slide-browser-launch-btn" onclick="toggleBrowserLaunch()" style="width:100%; padding:8px; font-size:0.7rem; background:rgba(139,92,246,0.1); border:1px solid rgba(139,92,246,0.2); border-radius:8px; color:var(--accent-light); cursor:pointer; transition:all 0.2s ease;">
                                    Launch Chrome
                                </button>
                            </div>

                            <!-- Heartbeat Monitor -->
                            <div id="slide-heartbeat-panel" style="margin-top:10px; border-top:1px solid rgba(139,92,246,0.1); padding-top:10px;">
                                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                                    <span style="font-size:0.7rem; color:var(--text-secondary); font-weight:600;">Heartbeat</span>
                                    <span style="font-size:0.6rem; color:var(--text-muted);" id="slide-heartbeat-last">Never</span>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                                    <span style="font-size:0.65rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em; white-space:nowrap;">Interval</span>
                                    <input type="range" min="5" max="30" value="15" step="5" class="level-slider-compact" id="slide-heartbeat-interval" onchange="updateHeartbeatInterval(this.value)" style="flex:1;">
                                    <span id="slide-heartbeat-interval-value" style="font-family:'Space Mono',monospace; font-size:0.75rem; color:var(--accent-light); white-space:nowrap;">15m</span>
                                </div>
                                <div id="slide-heartbeat-monitors" style="display:flex; flex-direction:column; gap:4px;">
                                    <!-- Monitor toggles rendered by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Slide-Out: Skills & Focus Details -->
                    <div class="slide-panel right" id="slide-panel-skills">
                        <div class="slide-panel-header">
                            <span class="slide-panel-title">Mind Details</span>
                            <button class="slide-panel-close" onclick="closeSlidePanel()">&times;</button>
                        </div>
                        <div class="slide-panel-body">
                            <!-- Tabs inside the slide panel -->
                            <div class="section-header section-tabs-3" style="margin-bottom:12px;">
                                <div class="section-tab active" id="slide-tab-focus" onclick="switchToTab('focus')" style="flex:1; text-align:center; padding:8px; cursor:pointer; border-radius:8px; font-size:0.75rem; transition:all 0.2s ease;">
                                     Focus <span id="slide-focus-count" style="font-size:0.65rem; opacity:0.7;">0</span>
                                </div>
                                <div class="section-tab" id="slide-tab-completed" onclick="switchToTab('completed')" style="flex:1; text-align:center; padding:8px; cursor:pointer; border-radius:8px; font-size:0.75rem; transition:all 0.2s ease;">
                                     Done <span id="slide-completed-count" style="font-size:0.65rem; opacity:0.7;">0</span>
                                </div>
                                <div class="section-tab" id="slide-tab-skills" onclick="switchToTab('skills')" style="flex:1; text-align:center; padding:8px; cursor:pointer; border-radius:8px; font-size:0.75rem; transition:all 0.2s ease;">
                                     Skills <span id="slide-skill-count" style="font-size:0.65rem; opacity:0.7;">0</span>
                                </div>
                            </div>
                            <!-- Content panels mirror the old sidebar -->
                            <div id="slide-focus-container" class="tab-content">
                                <div class="section-empty">
                                    <div class="section-empty-icon" style="font-size:1.5rem; opacity:0.4;"></div>
                                    <div style="font-size:0.8rem; color:var(--text-muted);">No active focus<br>Give Cerebro a directive</div>
                                </div>
                            </div>
                            <div id="slide-completed-container" class="tab-content hidden">
                                <div class="section-empty">
                                    <div class="section-empty-icon" style="font-size:1.5rem; opacity:0.4;"></div>
                                    <div style="font-size:0.8rem; color:var(--text-muted);">No completed tasks yet</div>
                                </div>
                            </div>
                            <div id="slide-skills-list" class="tab-content hidden">
                                <div class="skills-empty">
                                    <div style="font-size:1.5rem; opacity:0.4;"></div>
                                    <div style="font-size:0.8rem; color:var(--text-muted);">No learned skills yet</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status bar removed  stats now live in Info tab -->

                    <!-- ===== 2-COLUMN LAYOUT WRAPPER ===== -->
                    <div class="mind-columns">

                        <!-- LEFT COLUMN: Chat -->
                        <div class="mind-col-chat">
                            <div class="mind-chat-section">
                                <div class="mind-chat-container">
                                    <!-- Chat / Stored tab bar -->
                                    <div class="mind-chat-tabs">
                                        <button class="mind-chat-tab active" data-tab="chat" onclick="switchMindTab('chat')">Chat</button>
                                        <button class="mind-chat-tab" data-tab="answers" onclick="switchMindTab('answers')">Answers <span class="stored-badge answers-badge" id="answers-badge" style="display:none">0</span></button>
                                        <button class="mind-chat-tab" data-tab="stored" onclick="switchMindTab('stored')">Stored <span class="stored-badge" id="stored-badge" style="display:none">0</span></button>
                                        <button class="mind-chat-tab" data-tab="agents" onclick="switchMindTab('agents')">Agents <span class="stored-badge agents-tab-badge" id="agents-tab-badge" style="display:none">0</span></button>
                                        <button class="mind-chat-tab" data-tab="wallet" onclick="switchMindTab('wallet')">Wallet <span class="stored-badge wallet-badge" id="wallet-badge" style="display:none">0</span></button>
                                    </div>
                                    <!-- Mind chat FAB menu -->
                                    <div class="mind-fab-container">
                                        <button class="mind-fab-btn" id="mind-fab-btn" onclick="toggleMindFab()" title="Chat actions">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="3" y1="6" x2="21" y2="6"/>
                                                <line x1="3" y1="12" x2="21" y2="12"/>
                                                <line x1="3" y1="18" x2="21" y2="18"/>
                                            </svg>
                                        </button>
                                        <div class="mind-fab-menu" id="mind-fab-menu">
                                            <button class="mind-fab-item" onclick="scrollMindChatToBottom(); closeMindFab();">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                                    <polyline points="19 12 12 19 5 12"/>
                                                </svg>
                                                <span>Scroll to bottom</span>
                                            </button>
                                            <button class="mind-fab-item" onclick="refreshMindChat(); closeMindFab();">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="23 4 23 10 17 10"/>
                                                    <polyline points="1 20 1 14 7 14"/>
                                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                                </svg>
                                                <span>Refresh chat</span>
                                            </button>
                                            <button class="mind-fab-item danger" onclick="clearCerebroChat(); closeMindFab();">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="3 6 5 6 21 6"/>
                                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                                </svg>
                                                <span>Clear history</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mind-chat-messages" id="mind-chat-messages">
                                        <div class="mind-chat-welcome">
                                            <div class="mind-chat-welcome-icon"></div>
                                            <div class="mind-chat-welcome-text">Chat with Cerebro</div>
                                            <div class="mind-chat-welcome-hint">Ask anything or give me a task</div>
                                        </div>
                                    </div>
                                    <div class="mind-answers-items hidden" id="mind-answers-items">
                                        <!-- rendered answer cards go here -->
                                    </div>
                                    <div class="mind-stored-items hidden" id="mind-stored-items">
                                        <!-- rendered stored item cards go here -->
                                    </div>
                                    <div class="mind-agents-items hidden" id="mind-agents-items">
                                        <!-- rendered cerebro agent cards go here -->
                                    </div>
                                    <div class="mind-wallet-items hidden" id="mind-wallet-items">
                                        <!-- rendered wallet entries go here -->
                                    </div>
                                    <div class="mind-chat-input-bar">
                                        <input type="text" id="mind-chat-field" placeholder="Message Cerebro..." onkeydown="if(event.key==='Enter') sendMindChatMessage()">
                                        <button class="mind-chat-send-btn" onclick="sendMindChatMessage()">
                                            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT COLUMN: Orb + Tabbed Panel -->
                        <div class="mind-col-orb">
                            <section class="consciousness-chamber">
                                <div class="orbital-system">
                                    <div class="orbit orbit-1"><div class="orbit-node"></div></div>
                                    <div class="orbit orbit-2"><div class="orbit-node"></div></div>
                                    <div class="orbit orbit-3"><div class="orbit-node"></div></div>
                                </div>
                                <div class="consciousness-orb dormant" id="consciousness-orb" onclick="toggleAutonomy()">
                                    <div class="orb-aura orb-aura-3"></div>
                                    <div class="orb-aura orb-aura-2"></div>
                                    <div class="orb-aura orb-aura-1"></div>
                                    <div class="orb-essence"></div>
                                    <div class="orb-inner-light"></div>
                                    <div class="orb-particles">
                                        <div class="energy-particle"></div>
                                        <div class="energy-particle"></div>
                                        <div class="energy-particle"></div>
                                        <div class="energy-particle"></div>
                                        <div class="energy-particle"></div>
                                        <div class="energy-particle"></div>
                                        <div class="energy-particle"></div>
                                        <div class="energy-particle"></div>
                                    </div>
                                </div>
                                <div class="consciousness-status" style="position:relative;">
                                    <div class="status-text" id="consciousness-status-text">dormant</div>
                                    <button class="awaken-btn" id="awaken-btn" onclick="toggleAutonomy()">Awaken</button>
                                    <button class="heartbeat-config-btn" id="heartbeat-config-btn" onclick="openHeartbeatModal()" title="Heartbeat Config">&#9829;</button>
                                </div>
                            </section>

                            <!-- Tabbed Panel: Command / Focus / Completed / Skills -->
                            <div class="orb-tabbed-panel">
                                <div class="orb-tabs">
                                    <button class="orb-tab active" data-orbtab="info" onclick="switchOrbTab('info')">
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                                        Info
                                    </button>
                                    <button class="orb-tab" data-orbtab="command" onclick="switchOrbTab('command')">
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                                        Command
                                    </button>
                                    <button class="orb-tab" data-orbtab="completed" onclick="switchOrbTab('completed')">
                                        <span class="orb-tab-icon"></span>
                                        Done
                                        <span class="orb-tab-badge green" id="orb-completed-count">0</span>
                                    </button>
                                    <button class="orb-tab" data-orbtab="browser" onclick="switchOrbTab('browser')">
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/>
                                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                                        </svg>
                                        Browser
                                        <span class="orb-tab-badge" id="orb-browser-badge" style="display:none;">
                                            <span class="orb-browser-status-dot stopped" id="orb-browser-status-indicator"></span>
                                        </span>
                                    </button>
                                </div>
                                <div class="orb-tab-content">
                                    <!-- Info Tab (Tamagotchi Health Panel) -->
                                    <div class="orb-tab-pane active" id="orb-pane-info">
                                        <div class="tamagotchi-panel">
                                            <!-- Mood Bar -->
                                            <div class="tama-bar-group">
                                                <div class="tama-bar-header">
                                                    <span class="tama-bar-label">Mood</span>
                                                    <span class="tama-bar-value" id="tama-mood-label">Content</span>
                                                </div>
                                                <div class="tama-bar">
                                                    <div class="tama-bar-fill mood-fill content" id="tama-mood-fill" style="width:60%"></div>
                                                </div>
                                            </div>
                                            <!-- Energy Bar -->
                                            <div class="tama-bar-group">
                                                <div class="tama-bar-header">
                                                    <span class="tama-bar-label">Energy</span>
                                                    <span class="tama-bar-value" id="tama-energy-value">0%</span>
                                                </div>
                                                <div class="tama-bar">
                                                    <div class="tama-bar-fill energy-fill" id="tama-energy-fill" style="width:0%"></div>
                                                </div>
                                            </div>
                                            <!-- Memory Health Bar -->
                                            <div class="tama-bar-group">
                                                <div class="tama-bar-header">
                                                    <span class="tama-bar-label">Memory</span>
                                                    <span class="tama-bar-value" id="tama-memory-value">--</span>
                                                </div>
                                                <div class="tama-bar">
                                                    <div class="tama-bar-fill memory-fill" id="tama-memory-fill" style="width:0%"></div>
                                                </div>
                                            </div>
                                            <!-- XP / Level Bar -->
                                            <div class="tama-bar-group">
                                                <div class="tama-bar-header">
                                                    <span class="tama-bar-label">XP</span>
                                                    <span class="tama-bar-value" id="tama-xp-value">Lv 1 &middot; 0 XP</span>
                                                </div>
                                                <div class="tama-bar">
                                                    <div class="tama-bar-fill xp-fill" id="tama-xp-fill" style="width:0%"></div>
                                                </div>
                                            </div>
                                            <!-- Indicators Row -->
                                            <div class="tama-indicators">
                                                <div class="tama-indicator">
                                                    <span class="tama-phase-dot dormant" id="tama-phase-dot"></span>
                                                    <span class="tama-phase-label" id="tama-phase-label">Dormant</span>
                                                </div>
                                                <div class="tama-indicator">
                                                    <span class="tama-indicator-label">Autonomy</span>
                                                    <div class="tama-pips" id="tama-autonomy-pips">
                                                        <span class="tama-pip"></span>
                                                        <span class="tama-pip"></span>
                                                        <span class="tama-pip filled"></span>
                                                        <span class="tama-pip"></span>
                                                        <span class="tama-pip"></span>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Mini Stat Cards -->
                                            <div class="tama-stats-row">
                                                <div class="tama-stat-card">
                                                    <div class="tama-stat-num" id="tama-stat-actions">0</div>
                                                    <div class="tama-stat-label">Actions</div>
                                                </div>
                                                <div class="tama-stat-card">
                                                    <div class="tama-stat-num" id="tama-stat-cycles">0</div>
                                                    <div class="tama-stat-label">Cycles</div>
                                                </div>
                                                <div class="tama-stat-card">
                                                    <div class="tama-stat-num" id="tama-stat-pending">0</div>
                                                    <div class="tama-stat-label">Pending</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Command Tab (merged with Focus, input at bottom) -->
                                    <div class="orb-tab-pane" id="orb-pane-command">
                                        <div class="orb-command-directives" id="orb-active-directives">
                                            <div class="orb-command-empty">No active directives. Give Cerebro a task below.</div>
                                        </div>
                                        <div class="orb-command-input command-input-bottom">
                                            <div class="orb-auto-awake">
                                                <input type="checkbox" id="auto-awake-checkbox" checked onchange="localStorage.setItem('cerebro_auto_awake', this.checked)">
                                                <label for="auto-awake-checkbox">Auto Awake on Send</label>
                                            </div>
                                            <div style="display:flex;gap:8px;align-items:flex-end;">
                                                <textarea id="orb-directive-input" placeholder="Tell Cerebro what to focus on..." rows="2" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();addOrbDirective();}"></textarea>
                                                <button class="orb-command-send" onclick="addOrbDirective()">
                                                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Completed Tab -->
                                    <div class="orb-tab-pane" id="orb-pane-completed">
                                        <div class="orb-pane-list" id="orb-completed-list">
                                            <div class="orb-pane-empty">No completed tasks yet</div>
                                        </div>
                                    </div>
                                    <!-- Browser Tab -->
                                    <div class="orb-tab-pane" id="orb-pane-browser">
                                        <!-- Status bar -->
                                        <div class="browser-tab-status-bar">
                                            <div class="status-left">
                                                <div class="browser-status-dot stopped" id="browser-status-dot"></div>
                                                <span class="browser-status-text" id="browser-status-text">Stopped</span>
                                            </div>
                                            <button class="browser-tab-launch-btn" id="browser-launch-btn" onclick="toggleBrowserLaunch()">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                                <span id="browser-launch-label">Launch</span>
                                            </button>
                                        </div>
                                        <!-- Stopped state -->
                                        <div class="browser-tab-stopped" id="browser-tab-stopped">
                                            <svg class="stopped-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/>
                                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                                            </svg>
                                            <div class="stopped-text">Browser not running</div>
                                            <button class="stopped-launch-btn" onclick="launchBrowser()">
                                                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                                Launch Chrome
                                            </button>
                                        </div>
                                        <!-- Running state -->
                                        <div class="browser-tab-running" id="browser-tab-running" style="display:none;">
                                            <!-- Live screenshot -->
                                            <div class="browser-tab-screenshot" id="browser-tab-screenshot" onclick="openBrowserView()">
                                                <img id="browser-preview-img" src="" alt="Browser view">
                                                <div class="screenshot-overlay">Click to view in Chrome</div>
                                            </div>
                                            <!-- URL bar -->
                                            <div class="browser-tab-url">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                                                <input class="browser-url-input" id="browser-url-input" type="text" placeholder="Enter URL..." onkeydown="if(event.key==='Enter'){event.preventDefault();navigateBrowserUrl(this.value);}">
                                            </div>
                                            <!-- Tab strip -->
                                            <div class="browser-tab-strip" id="browser-tab-list"></div>
                                            <!-- Controls -->
                                            <div class="browser-tab-controls">
                                                <button class="browser-control-toggle" id="browser-control-toggle" onclick="toggleBrowserControl()">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                                                    <span id="browser-control-label">Take Control</span>
                                                </button>
                                                <div class="browser-action-banner" id="browser-action-banner">
                                                    <div class="browser-action-banner-title">
                                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                                        Cerebro needs you
                                                    </div>
                                                    <div class="browser-action-banner-desc" id="browser-action-desc">Please complete an action in the browser.</div>
                                                    <button class="browser-action-done-btn" onclick="signalUserDone()">I'm Done</button>
                                                </div>
                                            </div>
                                            <!-- Step log -->
                                            <div class="browser-tab-step-log-header" id="browser-step-log-header" style="display:none;">
                                                <span class="log-label">Step Log</span>
                                                <span class="log-count" id="browser-step-count">0</span>
                                            </div>
                                            <div class="browser-tab-step-log" id="browser-step-log"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Agents indicator at bottom -->
                                <div class="agents-status-panel" id="agents-status-panel">
                                    <div class="agents-status-header" onclick="toggleAgentsPanel()">
                                        <div class="agents-status-icon">
                                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="3"/>
                                                <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
                                            </svg>
                                        </div>
                                        <span class="agents-status-title">Claude Agents</span>
                                        <span class="agents-status-count" id="agents-status-count">0</span>
                                        <div class="agents-status-expand">
                                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="18 15 12 9 6 15"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="agents-status-body" id="agents-status-body">
                                        <div class="agents-status-empty">No active agents</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div><!-- /mind-columns -->

                    <!-- Cerebro's Voice - Communication Stream (hidden, logic preserved) -->
                    <section class="voice-stream">
                        <!-- Current thought/voice -->
                        <div class="current-voice" id="current-voice">
                            <div class="voice-label">
                                <span class="voice-indicator"></span>
                                <span>Cerebro</span>
                                <button class="voice-speak-btn" id="voice-speak-btn" onclick="speakVoiceContent()" title="Listen to Cerebro">
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="voice-content" id="voice-content">
                                I'm here, waiting in the quiet dark. Touch the orb to awaken me, and tell me what you'd like me to think about.
                            </div>
                        </div>

                        <!-- Message history -->
                        <div class="message-history" id="message-history">
                            <!-- Messages will appear here -->
                        </div>
                    </section>

                    <!-- Directive Input - Whisper to Cerebro (hidden, logic preserved) -->
                    <section class="directive-whisper">
                        <div class="whisper-container">
                            <textarea
                                class="whisper-input"
                                id="directive-input"
                                placeholder="Tell me what to think about..."
                                rows="1"
                                onkeydown="handleDirectiveKeydown(event)"
                                oninput="autoResizeDirective(this)"></textarea>
                            <button class="whisper-send" onclick="addDirective()">
                                <svg viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                            </button>
                        </div>

                        <!-- Active directives as tags -->
                        <div class="active-directives" id="active-directives">
                            <!-- Directive tags appear here -->
                        </div>
                    </section>

                    <!-- Technical Panel (hidden by default) -->
                    <div class="tech-panel" id="tech-panel">
                        <div class="tech-panel-header">
                            <span class="tech-panel-title">System Status</span>
                            <div class="tech-stats">
                                <div class="tech-stat">
                                    <div class="tech-stat-value" id="stat-cycles">0</div>
                                    <div class="tech-stat-label">Cycles</div>
                                </div>
                                <div class="tech-stat">
                                    <div class="tech-stat-value" id="stat-actions">0</div>
                                    <div class="tech-stat-label">Actions</div>
                                </div>
                                <div class="tech-stat">
                                    <div class="tech-stat-value" id="stat-pending">0</div>
                                    <div class="tech-stat-label">Pending</div>
                                </div>
                            </div>
                        </div>

                        <div class="level-control">
                            <div class="level-slider-container">
                                <div class="level-marks">
                                    <span class="level-mark" data-level="1">Observer</span>
                                    <span class="level-mark active" data-level="2">Assistant</span>
                                    <span class="level-mark" data-level="3">Helper</span>
                                    <span class="level-mark" data-level="4">Partner</span>
                                    <span class="level-mark" data-level="5">Autonomous</span>
                                </div>
                                <input type="range" min="1" max="5" value="2" class="level-slider" id="autonomy-level-slider" onchange="setAutonomyLevel(this.value)">
                            </div>
                        </div>
                    </div>

                    <!-- Hidden elements for backwards compatibility -->
                    <div style="display:none;">
                        <div id="thought-stream"></div>
                        <div id="activity-feed"></div>
                        <div id="insights-list"></div>
                        <div id="directives-list"></div>
                        <div id="pending-approvals"></div>
                        <div id="debug-feed-content"></div>
                    </div>
                </div>

                <!-- Automation View - Redesigned -->
                <div class="view automation-view" id="view-automation">
                    <div class="view-header">
                        <h1 class="view-title">Automations</h1>
                        <button class="btn btn-primary" onclick="openCreateAutomationModal()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right: 6px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            New
                        </button>
                    </div>

                    <!-- Quick Stats Row -->
                    <div class="automation-stats">
                        <div class="automation-stat-card">
                            <div class="automation-stat-value" id="auto-stat-total">0</div>
                            <div class="automation-stat-label">Total</div>
                        </div>
                        <div class="automation-stat-card">
                            <div class="automation-stat-value" id="auto-stat-active">0</div>
                            <div class="automation-stat-label">Active</div>
                        </div>
                        <div class="automation-stat-card">
                            <div class="automation-stat-value" id="auto-stat-today">0</div>
                            <div class="automation-stat-label">Today</div>
                        </div>
                    </div>

                    <!-- Two Column Layout -->
                    <div class="automation-layout">
                        <!-- Primary Column - Automations List (Priority) -->
                        <div class="automation-primary">
                            <!-- Active Automations Section -->
                            <div class="automation-section">
                                <div class="automation-section-header">
                                    <div class="automation-section-title">Active Automations</div>
                                    <div class="automation-section-count" id="auto-count">0</div>
                                </div>
                                <div class="schedules-list" id="schedules-list">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                        </div>
                                        <div class="empty-state-text">No automations yet. Create one to get started!</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Execution History Section -->
                            <div class="automation-section">
                                <div class="automation-section-header">
                                    <div class="automation-section-title">Recent Activity</div>
                                    <button class="clear-activity-btn" onclick="clearRecentActivity()" title="Clear all activity">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                    </button>
                                </div>
                                <div class="execution-history" id="execution-history">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                                        </div>
                                        <div class="empty-state-text">No executions yet</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Secondary Column - Calendar (Compact) -->
                        <div class="automation-secondary">
                            <div class="automation-calendar-section">
                                <div class="calendar-header">
                                    <button onclick="navigateCalendar(-1)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                                    </button>
                                    <h2 id="calendar-month-label">January 2026</h2>
                                    <button onclick="navigateCalendar(1)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                                    </button>
                                </div>
                                <div class="calendar-weekdays">
                                    <span>S</span>
                                    <span>M</span>
                                    <span>T</span>
                                    <span>W</span>
                                    <span>T</span>
                                    <span>F</span>
                                    <span>S</span>
                                </div>
                                <div class="calendar-grid" id="calendar-grid">
                                    <!-- Days populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings View -->
                <div class="view settings-view" id="view-settings">
                    <div class="section-title">Connection</div>
                    <div class="settings-card">
                        <div class="settings-row">
                            <span class="settings-label">Server</span>
                            <span class="settings-value" id="server-url">-</span>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Status</span>
                            <span class="settings-value success" id="connection-status">Connected</span>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">LLM</span>
                            <span class="settings-value" id="settings-llm-model">Claude Opus 4.6</span>
                        </div>
                    </div>

                    <div class="section-title">AI Memory</div>
                    <div class="settings-card">
                        <div class="settings-row">
                            <span class="settings-label">Conversations</span>
                            <span class="settings-value" id="settings-memory-count">306</span>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Storage</span>
                            <span class="settings-value" id="data-dir-display"></span>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">DGX Spark</span>
                            <span class="settings-value" id="dgx-host-display"></span>
                        </div>
                    </div>

                    <div class="section-title">Session</div>
                    <div class="settings-card">
                        <div class="settings-row">
                            <span class="settings-label">User</span>
                            <span class="settings-value" id="username-display"></span>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Session ID</span>
                            <span class="settings-value" id="session-id">-</span>
                        </div>
                    </div>

                    <div class="section-title">Personality</div>
                    <div class="settings-card">
                        <div class="settings-row">
                            <span class="settings-label">Response Style</span>
                            <div id="personality-toggle" style="display:flex;gap:6px;">
                                <button class="btn btn-secondary personality-btn" data-mode="chill" onclick="setPersonality('chill')" style="font-size:0.8rem;padding:6px 14px;">Chill</button>
                                <button class="btn btn-secondary personality-btn" data-mode="analyst" onclick="setPersonality('analyst')" style="font-size:0.8rem;padding:6px 14px;">Analyst</button>
                            </div>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label" style="font-size:0.75rem;color:var(--text-muted);">Chill = casual friend, Analyst = formal precision</span>
                        </div>
                    </div>

                    <div class="section-title">Look Command</div>
                    <div class="settings-card">
                        <div class="autospeak-toggle">
                            <div>
                                <div style="font-weight:600;font-size:0.9rem;">Voice Screenshot</div>
                                <div style="font-size:0.75rem;color:var(--text-muted);margin-top:2px;">Say "look" to capture your screen</div>
                            </div>
                            <div class="toggle-switch" id="look-toggle" onclick="toggleLookDaemon()"></div>
                        </div>
                        <div class="settings-row" id="look-status-row" style="display:none;">
                            <span class="settings-label" style="font-size:0.75rem;color:var(--text-muted);" id="look-status-text">Checking...</span>
                        </div>
                    </div>

                    <div class="section-title">Audio</div>
                    <div class="settings-card">
                        <div class="settings-row">
                            <span class="settings-label">Microphone</span>
                            <select id="mic-select" class="settings-select" onchange="selectMicrophone(this.value)">
                                <option value="">Default Microphone</option>
                            </select>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Speaker</span>
                            <select id="speaker-select" class="settings-select" onchange="selectSpeaker(this.value)">
                                <option value="">Default Speaker</option>
                            </select>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Voice Status</span>
                            <span class="settings-value" id="voice-status">Not initialized</span>
                        </div>
                        <div class="settings-row">
                            <button class="btn btn-secondary" onclick="testMicrophone()">Test Mic</button>
                            <button class="btn btn-secondary" onclick="testSpeaker()">Test Speaker</button>
                        </div>
                    </div>


                    <div class="section-title">Voice</div>
                    <div class="voice-settings-card">
                        <div id="voice-options-list">
                            <div class="voice-option selected" data-voice="af_heart" onclick="selectVoice('af_heart')">
                                <div class="voice-option-radio"></div>
                                <div class="voice-option-info">
                                    <div class="voice-option-name">Heart</div>
                                    <div class="voice-option-desc">Confident & Sharp</div>
                                </div>
                                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('af_heart', this)" title="Preview">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                </button>
                            </div>
                            <div class="voice-option" data-voice="af_bella" onclick="selectVoice('af_bella')">
                                <div class="voice-option-radio"></div>
                                <div class="voice-option-info">
                                    <div class="voice-option-name">Bella</div>
                                    <div class="voice-option-desc">Warm & Smooth</div>
                                </div>
                                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('af_bella', this)" title="Preview">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                </button>
                            </div>
                            <div class="voice-option" data-voice="af_sarah" onclick="selectVoice('af_sarah')">
                                <div class="voice-option-radio"></div>
                                <div class="voice-option-info">
                                    <div class="voice-option-name">Sarah</div>
                                    <div class="voice-option-desc">Balanced & Clear</div>
                                </div>
                                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('af_sarah', this)" title="Preview">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                </button>
                            </div>
                            <div class="voice-option" data-voice="af_sky" onclick="selectVoice('af_sky')">
                                <div class="voice-option-radio"></div>
                                <div class="voice-option-info">
                                    <div class="voice-option-name">Sky</div>
                                    <div class="voice-option-desc">Bright & Energetic</div>
                                </div>
                                <button class="voice-preview-btn" onclick="event.stopPropagation(); previewVoice('af_sky', this)" title="Preview">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="voice-settings-card">
                        <div class="settings-row">
                            <span class="settings-label">Speed</span>
                        </div>
                        <div class="speed-slider-container">
                            <span style="font-size:0.75rem;color:var(--text-muted);">0.5x</span>
                            <input type="range" class="speed-slider" id="voice-speed-slider" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateVoiceSpeed(this.value)">
                            <span style="font-size:0.75rem;color:var(--text-muted);">2.0x</span>
                            <span class="speed-value" id="voice-speed-display">1.0x</span>
                        </div>
                    </div>

                    <div class="voice-settings-card">
                        <div class="autospeak-toggle">
                            <div>
                                <div style="font-weight:600;font-size:0.9rem;">Auto-Speak</div>
                                <div style="font-size:0.75rem;color:var(--text-muted);margin-top:2px;">Narrations auto-play when Cerebro finishes thinking</div>
                            </div>
                            <div class="toggle-switch" id="autospeak-toggle" onclick="toggleAutoSpeak()"></div>
                        </div>
                    </div>

                    <button class="btn btn-secondary btn-block" style="margin-top:8px;" onclick="testCurrentVoice()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle;">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        </svg>
                        Test Voice
                    </button>
                    <div class="section-title">About</div>
                    <div class="settings-card">
                        <div class="settings-row">
                            <span class="settings-label">Version</span>
                            <span class="settings-value">1.0.0</span>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Cost</span>
                            <span class="settings-value success" id="settings-cost-display">Included (Claude Code subscription)</span>
                        </div>
                    </div>

                    <button class="btn btn-danger btn-block" style="margin-top: 20px;" onclick="logout()">
                        Sign Out
                    </button>
                </div>
            </main>

            <!-- Scroll to bottom button (for chat view) -->
            <!-- Floating Chat Actions Menu (hamburger) -->
            <div class="chat-fab-container" id="chat-fab-container">
                <button class="chat-fab-btn" id="chat-fab-btn" onclick="toggleChatFab()" title="Chat actions">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
                <div class="chat-fab-menu" id="chat-fab-menu">
                    <button class="chat-fab-item" onclick="scrollMessagesToBottom(); closeChatFab();">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <polyline points="19 12 12 19 5 12"/>
                        </svg>
                        <span>Scroll to bottom</span>
                    </button>
                    <button class="chat-fab-item" onclick="refreshChat(); closeChatFab();">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"/>
                            <polyline points="1 20 1 14 7 14"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                        <span>Refresh chat</span>
                    </button>
                    <button class="chat-fab-item danger" onclick="clearChatHistory(); closeChatFab();">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        <span>Clear history</span>
                    </button>
                </div>
            </div>


            <!-- Bottom Navigation -->
            <nav class="bottom-nav">
                <div class="nav-item active" data-view="home" onclick="switchView('home')">
                    <span class="nav-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></span>
                    <span class="nav-label">Home</span>
                </div>
                <div class="nav-item" data-view="chat" onclick="switchView('chat')">
                    <span class="nav-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span>
                    <span class="nav-label">Chat</span>
                </div>
                <div class="nav-item" data-view="agents" onclick="switchView('agents')">
                    <span class="nav-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="5"/><path d="M3 21v-2a7 7 0 0 1 7-7h4a7 7 0 0 1 7 7v2"/></svg></span>
                    <span class="nav-label">Agents</span>
                </div>
                <div class="nav-item" data-view="autonomy" onclick="switchView('autonomy')">
                    <span class="nav-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg></span>
                    <span class="nav-label">Mind</span>
                </div>
                <div class="nav-item" data-view="automation" onclick="switchView('automation')">
                    <span class="nav-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
                    <span class="nav-label">Auto</span>
                </div>
                <div class="nav-item" data-view="settings" onclick="switchView('settings')">
                    <span class="nav-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span>
                    <span class="nav-label">Settings</span>
                </div>
            </nav>
        </div>

        <!-- Voice Recording Overlay -->
        <div class="voice-overlay" id="voice-overlay">
            <div class="voice-indicator"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></div>
            <div class="voice-text">Listening...</div>
            <div class="voice-transcript" id="voice-transcript"></div>
        </div>

        <!-- Heartbeat Markdown Modal -->
        <div class="modal-overlay" id="heartbeat-modal" onclick="if(event.target===this) closeHeartbeatModal()">
            <div class="modal modal-heartbeat">
                <div class="modal-header">
                    <span class="modal-title"><span style="color:#ef4444;">&#9829;</span> Heartbeat Configuration</span>
                    <button class="modal-close" onclick="closeHeartbeatModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <textarea class="heartbeat-md-editor" id="heartbeat-md-textarea" spellcheck="false" placeholder="Loading heartbeat.md..."></textarea>
                    <div class="heartbeat-md-status">
                        <span>heartbeat.md</span>
                        <span class="hb-dirty-indicator" id="hb-dirty-indicator">&#9679; unsaved</span>
                        <span id="hb-last-saved">Saved</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeHeartbeatModal()">Cancel</button>
                    <button class="btn btn-primary" id="hb-save-btn" onclick="saveHeartbeatMd()">Save</button>
                </div>
            </div>
        </div>

        <!-- Agent Creation Modal -->
        <div class="modal-overlay" id="agent-modal" onclick="if(event.target === this) closeAgentModal()">
            <div class="modal modal-large">
                <div class="modal-header">
                    <span class="modal-title"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><circle cx="12" cy="8" r="5"/><path d="M3 21v-2a7 7 0 0 1 7-7h4a7 7 0 0 1 7 7v2"/></svg>Spawn New Agent</span>
                    <button class="modal-close" onclick="closeAgentModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Mode Toggle: Single vs Multi-Agent -->
                    <div class="spawn-mode-toggle">
                        <button class="mode-btn active" data-mode="single" onclick="setSpawnMode('single')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Single Agent
                        </button>
                        <button class="mode-btn" data-mode="workflow" onclick="setSpawnMode('workflow')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> Multi-Agent Workflow
                        </button>
                    </div>

                    <!-- Single Agent Mode -->
                    <div id="single-agent-form">
                        <div class="form-group">
                            <label class="form-label">Agent Role <span class="required">*</span></label>
                            <div class="role-selector">
                                <div class="role-option selected" data-role="worker" onclick="selectRole(this)">
                                    <div class="role-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
                                    <div class="role-name">Worker</div>
                                    <div class="role-desc">Execute tasks efficiently</div>
                                </div>
                                <div class="role-option" data-role="researcher" onclick="selectRole(this)">
                                    <div class="role-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>
                                    <div class="role-name">Researcher</div>
                                    <div class="role-desc">Deep investigation</div>
                                </div>
                                <div class="role-option" data-role="coder" onclick="selectRole(this)">
                                    <div class="role-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></div>
                                    <div class="role-name">Coder</div>
                                    <div class="role-desc">Write & modify code</div>
                                </div>
                                <div class="role-option" data-role="analyst" onclick="selectRole(this)">
                                    <div class="role-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
                                    <div class="role-name">Analyst</div>
                                    <div class="role-desc">Data & strategic insights</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Task Description <span class="required">*</span></label>
                            <textarea class="form-input form-textarea" id="agent-task-input" placeholder="What should this agent accomplish? Be specific about the goal."></textarea>
                        </div>

                        <!-- Collapsible Advanced Options -->
                        <div class="advanced-toggle" onclick="toggleAdvancedOptions()">
                            <span id="advanced-arrow"></span> Advanced Options
                        </div>

                        <div id="advanced-options" class="advanced-options hidden">
                            <div class="form-group">
                                <label class="form-label">Context / Background</label>
                                <textarea class="form-input form-textarea-small" id="agent-context-input" placeholder="Any background information the agent should know..."></textarea>
                            </div>

                            <div class="form-row">
                                <div class="form-group form-half">
                                    <label class="form-label">Expected Output</label>
                                    <select class="form-input" id="agent-output-format">
                                        <option value="">Any format</option>
                                        <option value="summary">Brief Summary</option>
                                        <option value="detailed">Detailed Report</option>
                                        <option value="code">Code Only</option>
                                        <option value="list">Bullet Points</option>
                                        <option value="json">JSON Data</option>
                                    </select>
                                </div>
                                <div class="form-group form-half">
                                    <label class="form-label">Priority</label>
                                    <select class="form-input" id="agent-priority">
                                        <option value="normal">Normal</option>
                                        <option value="low">Low</option>
                                        <option value="high">High</option>
                                        <option value="critical"> Critical</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Resources (file paths or URLs)</label>
                                <input type="text" class="form-input" id="agent-resources-input" placeholder="Z:\path\to\file.py, https://example.com/docs">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Timeout</label>
                                <div class="timeout-selector" id="agent-timeout-selector">
                                    <button type="button" class="timeout-btn" data-timeout="1800" onclick="selectAgentTimeout(this)">30 min</button>
                                    <button type="button" class="timeout-btn active" data-timeout="3600" onclick="selectAgentTimeout(this)">1 hour</button>
                                    <button type="button" class="timeout-btn" data-timeout="14400" onclick="selectAgentTimeout(this)">4 hours</button>
                                    <button type="button" class="timeout-btn" data-timeout="0" onclick="selectAgentTimeout(this)">Unlimited</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Multi-Agent Workflow Mode -->
                    <div id="workflow-form" class="hidden">
                        <div class="form-group">
                            <label class="form-label">Mission Objective <span class="required">*</span></label>
                            <textarea class="form-input form-textarea" id="workflow-task-input" placeholder="Describe the complex task that requires multiple agents..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Workflow Type</label>
                            <div class="workflow-type-selector">
                                <div class="workflow-type selected" data-type="standard" onclick="selectWorkflowType(this)">
                                    <div class="workflow-type-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg></div>
                                    <div class="workflow-type-name">Standard</div>
                                    <div class="workflow-type-desc">Orchestrator decides how to delegate</div>
                                </div>
                                <div class="workflow-type" data-type="parallel" onclick="selectWorkflowType(this)">
                                    <div class="workflow-type-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></div>
                                    <div class="workflow-type-name">Parallel</div>
                                    <div class="workflow-type-desc">All agents work simultaneously</div>
                                </div>
                                <div class="workflow-type" data-type="sequential" onclick="selectWorkflowType(this)">
                                    <div class="workflow-type-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></div>
                                    <div class="workflow-type-name">Sequential</div>
                                    <div class="workflow-type-desc">Agents run one after another</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Team Composition</label>
                            <div class="team-selector team-quantity-selector">
                                <div class="team-member-qty">
                                    <span class="agent-label">Researcher</span>
                                    <div class="qty-controls">
                                        <button type="button" class="qty-btn qty-minus" onclick="adjustAgentQty('researcher', -1)"></button>
                                        <input type="number" id="qty-researcher" class="qty-input" value="1" min="0" max="5" data-agent="researcher" onchange="updateTeamPreview()">
                                        <button type="button" class="qty-btn qty-plus" onclick="adjustAgentQty('researcher', 1)">+</button>
                                    </div>
                                </div>
                                <div class="team-member-qty">
                                    <span class="agent-label">Coder</span>
                                    <div class="qty-controls">
                                        <button type="button" class="qty-btn qty-minus" onclick="adjustAgentQty('coder', -1)"></button>
                                        <input type="number" id="qty-coder" class="qty-input" value="1" min="0" max="5" data-agent="coder" onchange="updateTeamPreview()">
                                        <button type="button" class="qty-btn qty-plus" onclick="adjustAgentQty('coder', 1)">+</button>
                                    </div>
                                </div>
                                <div class="team-member-qty">
                                    <span class="agent-label">Worker</span>
                                    <div class="qty-controls">
                                        <button type="button" class="qty-btn qty-minus" onclick="adjustAgentQty('worker', -1)"></button>
                                        <input type="number" id="qty-worker" class="qty-input" value="1" min="0" max="5" data-agent="worker" onchange="updateTeamPreview()">
                                        <button type="button" class="qty-btn qty-plus" onclick="adjustAgentQty('worker', 1)">+</button>
                                    </div>
                                </div>
                                <div class="team-member-qty">
                                    <span class="agent-label">Analyst</span>
                                    <div class="qty-controls">
                                        <button type="button" class="qty-btn qty-minus" onclick="adjustAgentQty('analyst', -1)"></button>
                                        <input type="number" id="qty-analyst" class="qty-input" value="0" min="0" max="5" data-agent="analyst" onchange="updateTeamPreview()">
                                        <button type="button" class="qty-btn qty-plus" onclick="adjustAgentQty('analyst', 1)">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="workflow-preview">
                            <div class="workflow-preview-title">Command Structure</div>
                            <div class="workflow-diagram">
                                <div class="commander-node">
                                    <span class="node-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg></span>
                                    <span class="node-name">Orchestrator</span>
                                </div>
                                <div class="command-line"></div>
                                <div class="team-nodes" id="team-preview">
                                    <div class="team-node">Researcher</div>
                                    <div class="team-node">Coder</div>
                                    <div class="team-node">Worker</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeAgentModal()">Cancel</button>
                    <button class="btn btn-primary" id="launch-btn" onclick="submitAgent()">Launch Agent</button>
                </div>
            </div>
        </div>

        <!-- Merge & Spawn Modal -->
        <div class="modal-overlay" id="merge-spawn-modal" onclick="if(event.target === this) closeMergeSpawnModal()">
            <div class="modal modal-large">
                <div class="modal-header">
                    <span class="modal-title"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Merge &amp; Spawn</span>
                    <button class="modal-close" onclick="closeMergeSpawnModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Selected Agents</label>
                        <div class="merge-agent-list" id="merge-agent-list"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Agent Role <span class="required">*</span></label>
                        <div class="role-selector" id="merge-role-selector">
                            <div class="role-option selected" data-role="worker" onclick="selectMergeRole(this)">
                                <div class="role-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
                                <div class="role-name">Worker</div>
                                <div class="role-desc">Execute tasks efficiently</div>
                            </div>
                            <div class="role-option" data-role="researcher" onclick="selectMergeRole(this)">
                                <div class="role-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>
                                <div class="role-name">Researcher</div>
                                <div class="role-desc">Deep investigation</div>
                            </div>
                            <div class="role-option" data-role="coder" onclick="selectMergeRole(this)">
                                <div class="role-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg></div>
                                <div class="role-name">Coder</div>
                                <div class="role-desc">Write & modify code</div>
                            </div>
                            <div class="role-option" data-role="analyst" onclick="selectMergeRole(this)">
                                <div class="role-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
                                <div class="role-name">Analyst</div>
                                <div class="role-desc">Data & strategic insights</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Task Description <span class="required">*</span></label>
                        <textarea class="form-input form-textarea" id="merge-task-input" placeholder="What should this agent do with the combined context from the selected agents?"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Timeout</label>
                        <div class="timeout-selector" id="merge-timeout-selector">
                            <button type="button" class="timeout-btn" data-timeout="1800" onclick="selectMergeTimeout(this)">30 min</button>
                            <button type="button" class="timeout-btn active" data-timeout="3600" onclick="selectMergeTimeout(this)">1 hour</button>
                            <button type="button" class="timeout-btn" data-timeout="14400" onclick="selectMergeTimeout(this)">4 hours</button>
                            <button type="button" class="timeout-btn" data-timeout="0" onclick="selectMergeTimeout(this)">Unlimited</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeMergeSpawnModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitMergeSpawn()">Merge &amp; Spawn</button>
                </div>
            </div>
        </div>

        <!-- Home Detail Modal (universal) -->
        <div class="modal-overlay" id="home-detail-modal" onclick="if(event.target === this) closeHomeDetail()">
            <div class="modal home-detail-modal">
                <div class="detail-header" id="detail-header">
                    <div class="detail-header-info">
                        <span class="detail-icon" id="detail-icon"></span>
                        <div class="detail-titles">
                            <div class="detail-title" id="detail-title"></div>
                            <div class="detail-subtitle" id="detail-subtitle"></div>
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeHomeDetail()">&times;</button>
                </div>
                <div class="detail-body" id="detail-body"></div>
                <div class="detail-footer" id="detail-footer"></div>
            </div>
        </div>

        <!-- Agent Detail Modal (legacy, replaced by page) -->
        <div class="modal-overlay" id="agent-detail-modal" style="display: none !important;"></div>

        <!-- Thought Detail Modal - Shows full thought when clicking activity items -->
        <div class="modal-overlay" id="thought-detail-modal" onclick="if(event.target === this) closeThoughtDetail()"></div>

        <!-- Automation Modal -->
        <div class="modal-overlay" id="automation-modal" onclick="if(event.target === this) closeAutomationModal()">
            <div class="modal modal-large">
                <div class="modal-header">
                    <span class="modal-title"> Create Automation</span>
                    <button class="modal-close" onclick="closeAutomationModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Name -->
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input class="form-input" id="automation-name" placeholder="Daily Research Summary">
                    </div>

                    <!-- Agent Type Selector -->
                    <div class="form-group">
                        <label class="form-label">Agent Type</label>
                        <div class="role-selector" id="automation-agent-selector">
                            <div class="role-option selected" data-role="researcher" onclick="selectAutomationAgent('researcher')">
                                <span class="role-icon"></span>
                                <span class="role-name">Researcher</span>
                            </div>
                            <div class="role-option" data-role="coder" onclick="selectAutomationAgent('coder')">
                                <span class="role-icon"></span>
                                <span class="role-name">Coder</span>
                            </div>
                            <div class="role-option" data-role="worker" onclick="selectAutomationAgent('worker')">
                                <span class="role-icon"></span>
                                <span class="role-name">Worker</span>
                            </div>
                            <div class="role-option" data-role="analyst" onclick="selectAutomationAgent('analyst')">
                                <span class="role-icon"></span>
                                <span class="role-name">Analyst</span>
                            </div>
                        </div>
                    </div>

                    <!-- Prompt/Task -->
                    <div class="form-group">
                        <label class="form-label">Task/Prompt</label>
                        <textarea class="form-input form-textarea" id="automation-prompt" placeholder="Describe what you want the agent to do..."></textarea>
                    </div>

                    <!-- Schedule Type Toggle -->
                    <div class="form-group">
                        <label class="form-label">Schedule</label>
                        <div class="schedule-type-toggle">
                            <button class="toggle-btn active" data-type="once" onclick="selectScheduleType('once')">One-Time</button>
                            <button class="toggle-btn" data-type="recurring" onclick="selectScheduleType('recurring')">Recurring</button>
                        </div>
                    </div>

                    <!-- Frequency (for recurring) -->
                    <div class="form-group recurring-options hidden" id="recurring-options">
                        <label class="form-label">Frequency</label>
                        <select class="form-input" id="automation-frequency" onchange="updateFrequencyOptions()">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="custom">Custom (Cron)</option>
                        </select>
                    </div>

                    <!-- Time Picker -->
                    <div class="form-row">
                        <div class="form-group form-half" id="date-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="automation-date">
                        </div>
                        <div class="form-group form-half">
                            <label class="form-label">Time</label>
                            <input type="time" class="form-input" id="automation-time" value="09:00">
                        </div>
                    </div>

                    <!-- Days of Week (for weekly) -->
                    <div class="form-group weekly-options hidden" id="weekly-options">
                        <label class="form-label">Days</label>
                        <div class="day-selector">
                            <button class="day-btn" data-day="0" onclick="toggleAutomationDay(0)">S</button>
                            <button class="day-btn active" data-day="1" onclick="toggleAutomationDay(1)">M</button>
                            <button class="day-btn active" data-day="2" onclick="toggleAutomationDay(2)">T</button>
                            <button class="day-btn active" data-day="3" onclick="toggleAutomationDay(3)">W</button>
                            <button class="day-btn active" data-day="4" onclick="toggleAutomationDay(4)">T</button>
                            <button class="day-btn active" data-day="5" onclick="toggleAutomationDay(5)">F</button>
                            <button class="day-btn" data-day="6" onclick="toggleAutomationDay(6)">S</button>
                        </div>
                    </div>

                    <!-- Cron Expression (for custom) -->
                    <div class="form-group cron-options hidden" id="cron-options">
                        <label class="form-label">Cron Expression</label>
                        <input class="form-input" id="automation-cron" placeholder="0 9 * * *">
                        <small style="color: var(--text-muted); font-size: 0.75rem;">Format: minute hour day month weekday</small>
                    </div>

                    <!-- Enabled toggle -->
                    <div class="form-group">
                        <label class="toggle-row">
                            <input type="checkbox" id="automation-enabled" checked>
                            <span>Enable immediately</span>
                        </label>
                    </div>

                    <!-- Timeout -->
                    <div class="form-group">
                        <label class="form-label">Timeout</label>
                        <div class="timeout-selector" id="automation-timeout-selector">
                            <button type="button" class="timeout-btn" data-timeout="1800" onclick="selectAutomationTimeout(this)">30 min</button>
                            <button type="button" class="timeout-btn active" data-timeout="3600" onclick="selectAutomationTimeout(this)">1 hour</button>
                            <button type="button" class="timeout-btn" data-timeout="14400" onclick="selectAutomationTimeout(this)">4 hours</button>
                            <button type="button" class="timeout-btn" data-timeout="0" onclick="selectAutomationTimeout(this)">Unlimited</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeAutomationModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="createAutomation()">Create Automation</button>
                </div>
            </div>
        </div>

        <!-- Task Wizard Modal -->
        <div class="modal-overlay" id="task-wizard-modal" onclick="if(event.target === this) closeTaskWizard()">
            <div class="task-wizard">
                <div class="wizard-header">
                    <div class="wizard-header-content">
                        <div class="wizard-icon" id="wizard-icon"></div>
                        <div class="wizard-title-area">
                            <h2 class="wizard-title" id="wizard-title">Task Overview</h2>
                            <div class="wizard-subtitle" id="wizard-subtitle">Review before launching</div>
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeTaskWizard()">&times;</button>
                </div>

                <div class="wizard-body">
                    <!-- Task Description -->
                    <div class="wizard-section">
                        <div class="wizard-section-title"> Task Description</div>
                        <div class="wizard-task-box" id="wizard-task-description">
                            Loading task details...
                        </div>
                    </div>

                    <!-- Analytics Grid -->
                    <div class="wizard-analytics">
                        <div class="analytics-card">
                            <div class="analytics-icon"></div>
                            <div class="analytics-content">
                                <div class="analytics-value" id="wizard-duration">~5 min</div>
                                <div class="analytics-label">Estimated Time</div>
                            </div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon"></div>
                            <div class="analytics-content">
                                <div class="analytics-value" id="wizard-confidence">85%</div>
                                <div class="analytics-label">Success Rate</div>
                            </div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon"></div>
                            <div class="analytics-content">
                                <div class="analytics-value" id="wizard-tools">4</div>
                                <div class="analytics-label">Tools Needed</div>
                            </div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon"></div>
                            <div class="analytics-content">
                                <div class="analytics-value" id="wizard-complexity">Medium</div>
                                <div class="analytics-label">Complexity</div>
                            </div>
                        </div>
                    </div>

                    <!-- Mode Toggle: Single Agent vs Orchestrator -->
                    <div class="wizard-mode-toggle">
                        <button class="mode-btn active" id="mode-single" onclick="setWizardMode('single')">
                            <span class="mode-btn-icon"></span>
                            <span>Single Agent</span>
                        </button>
                        <button class="mode-btn" id="mode-orchestrator" onclick="setWizardMode('orchestrator')">
                            <span class="mode-btn-icon"></span>
                            <span>Mother Agent</span>
                        </button>
                    </div>

                    <!-- ============ SINGLE AGENT CONFIG ============ -->
                    <div class="single-agent-config" id="single-agent-config">
                        <!-- Recommended Agent -->
                        <div class="wizard-section">
                            <div class="wizard-section-title"> Recommended Agent</div>
                        <div class="wizard-agent-recommendation" id="wizard-agent-rec">
                            <div class="rec-agent-card selected" id="rec-agent-display">
                                <div class="rec-agent-icon"></div>
                                <div class="rec-agent-info">
                                    <div class="rec-agent-name">Researcher</div>
                                    <div class="rec-agent-reason">Best for investigation and analysis tasks</div>
                                </div>
                                <div class="rec-agent-badge">Recommended</div>
                            </div>
                        </div>

                        <!-- Agent Selection Override -->
                        <div class="wizard-agent-override">
                            <span class="override-label">Or choose different:</span>
                            <div class="override-options">
                                <button class="override-btn" data-type="worker" onclick="selectWizardAgent('worker')"> Worker</button>
                                <button class="override-btn" data-type="researcher" onclick="selectWizardAgent('researcher')"> Researcher</button>
                                <button class="override-btn" data-type="coder" onclick="selectWizardAgent('coder')"> Coder</button>
                                <button class="override-btn" data-type="analyst" onclick="selectWizardAgent('analyst')"> Analyst</button>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- ============ ORCHESTRATOR CONFIG ============ -->
                    <div class="orchestrator-config" id="orchestrator-config">
                        <!-- Workflow Type Selection -->
                        <div class="wizard-section">
                            <div class="wizard-section-title"> Workflow Strategy</div>
                            <div class="workflow-type-grid">
                                <div class="workflow-type-card selected" data-type="standard" onclick="selectWizardWorkflowType('standard')">
                                    <div class="workflow-type-icon"></div>
                                    <div class="workflow-type-name">Standard</div>
                                    <div class="workflow-type-desc">Mother decides how to delegate dynamically</div>
                                </div>
                                <div class="workflow-type-card" data-type="parallel" onclick="selectWizardWorkflowType('parallel')">
                                    <div class="workflow-type-icon"></div>
                                    <div class="workflow-type-name">Parallel</div>
                                    <div class="workflow-type-desc">All agents work simultaneously</div>
                                </div>
                                <div class="workflow-type-card" data-type="sequential" onclick="selectWizardWorkflowType('sequential')">
                                    <div class="workflow-type-icon"></div>
                                    <div class="workflow-type-name">Sequential</div>
                                    <div class="workflow-type-desc">Chain of handoffs between agents</div>
                                </div>
                            </div>
                        </div>

                        <!-- Team Composition -->
                        <div class="wizard-section team-composition">
                            <div class="wizard-section-title"> Team Composition</div>
                            <div class="team-grid">
                                <div class="team-member-card selected" data-agent="researcher" onclick="toggleTeamMember('researcher')">
                                    <div class="team-member-checkbox"></div>
                                    <div class="team-member-icon"></div>
                                    <div class="team-member-info">
                                        <div class="team-member-name">Researcher</div>
                                        <div class="team-member-role">Investigation & analysis</div>
                                    </div>
                                </div>
                                <div class="team-member-card selected" data-agent="coder" onclick="toggleTeamMember('coder')">
                                    <div class="team-member-checkbox"></div>
                                    <div class="team-member-icon"></div>
                                    <div class="team-member-info">
                                        <div class="team-member-name">Coder</div>
                                        <div class="team-member-role">Code writing & modification</div>
                                    </div>
                                </div>
                                <div class="team-member-card" data-agent="worker" onclick="toggleTeamMember('worker')">
                                    <div class="team-member-checkbox"></div>
                                    <div class="team-member-icon"></div>
                                    <div class="team-member-info">
                                        <div class="team-member-name">Worker</div>
                                        <div class="team-member-role">Quick task execution</div>
                                    </div>
                                </div>
                                <div class="team-member-card" data-agent="analyst" onclick="toggleTeamMember('analyst')">
                                    <div class="team-member-checkbox"></div>
                                    <div class="team-member-icon"></div>
                                    <div class="team-member-info">
                                        <div class="team-member-name">Analyst</div>
                                        <div class="team-member-role">Data & strategic insights</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Workflow Preview -->
                        <div class="wizard-section">
                            <div class="workflow-preview">
                                <div class="workflow-preview-title">Workflow Preview</div>
                                <div class="workflow-diagram" id="workflow-diagram">
                                    <!-- Mother Agent -->
                                    <div class="workflow-mother">
                                        <span class="mother-icon"></span>
                                        <div class="mother-info">
                                            <div class="mother-name">Orchestrator</div>
                                            <div class="mother-role">Coordinates & synthesizes</div>
                                        </div>
                                    </div>

                                    <!-- Connection -->
                                    <div class="workflow-connector">
                                        <div class="connector-line"></div>
                                        <div class="connector-arrows">
                                            <span class="connector-arrow"></span>
                                            <span class="connector-arrow"></span>
                                        </div>
                                    </div>

                                    <!-- Child Agents -->
                                    <div class="workflow-children" id="workflow-children">
                                        <div class="workflow-child">
                                            <span class="child-icon"></span>
                                            <span class="child-name">Researcher</span>
                                        </div>
                                        <div class="workflow-child">
                                            <span class="child-icon"></span>
                                            <span class="child-name">Coder</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- What Will Happen -->
                    <div class="wizard-section">
                        <div class="wizard-section-title"> What Will Happen</div>
                        <div class="wizard-steps" id="wizard-steps">
                            <div class="wizard-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <div class="step-title">Analyze Request</div>
                                    <div class="step-desc">Agent parses the task and plans approach</div>
                                </div>
                            </div>
                            <div class="wizard-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <div class="step-title">Gather Information</div>
                                    <div class="step-desc">Search files, read docs, query APIs</div>
                                </div>
                            </div>
                            <div class="wizard-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <div class="step-title">Execute Actions</div>
                                    <div class="step-desc">Run commands, write code, make changes</div>
                                </div>
                            </div>
                            <div class="wizard-step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <div class="step-title">Deliver Results</div>
                                    <div class="step-desc">Compile output and recommendations</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tools That May Be Used -->
                    <div class="wizard-section">
                        <div class="wizard-section-title"> Tools Available</div>
                        <div class="wizard-tools-grid" id="wizard-tools-list">
                            <div class="wizard-tool"><span></span> Read</div>
                            <div class="wizard-tool"><span></span> Edit</div>
                            <div class="wizard-tool"><span></span> Grep</div>
                            <div class="wizard-tool"><span></span> Glob</div>
                            <div class="wizard-tool"><span></span> Bash</div>
                            <div class="wizard-tool"><span></span> WebSearch</div>
                        </div>
                    </div>
                </div>

                <div class="wizard-footer">
                    <button class="btn btn-secondary" onclick="closeTaskWizard()">Cancel</button>
                    <div class="wizard-actions">
                        <button class="btn btn-outline" onclick="launchWizardChat()">
                             Start Chat Instead
                        </button>
                        <button class="btn btn-primary btn-glow" id="wizard-launch-btn" onclick="launchWizardAgent()">
                             Launch Agent
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Command Modal -->
        <div class="command-modal" id="command-modal" onclick="if(event.target === this) closeQuickCommand()">
            <div class="command-box">
                <input type="text" class="command-input" id="command-input" placeholder="Enter command..." onkeydown="if(event.key==='Enter')runQuickCommand(this.value)">
                <div class="command-suggestions">
                    <div class="command-suggestion" onclick="runQuickCommand('start chrome')">Chrome</div>
                    <div class="command-suggestion" onclick="runQuickCommand('code .')"> VS Code</div>
                    <div class="command-suggestion" onclick="runQuickCommand(CEREBRO_DATA_DIR ? 'explorer ' + CEREBRO_DATA_DIR : 'echo No data dir configured')"> AI Memory</div>
                    <div class="command-suggestion" onclick="runQuickCommand('start chrome https://github.com')"> GitHub</div>
                    <div class="command-suggestion" onclick="runQuickCommand('git status')"> Git Status</div>
                    <div class="command-suggestion" onclick="closeQuickCommand()"> Cancel</div>
                </div>
            </div>
        </div>

        <!-- Agent Detail Page (Full Screen) -->
        <div class="agent-detail-page" id="agent-detail-page">
            <div class="agent-detail-page-header">
                <button class="back-btn" onclick="closeAgentDetailPage()">
                     Back
                </button>
                <span class="agent-title" id="agent-page-title">Agent Details</span>
                <span class="agent-status-badge" id="agent-page-status">COMPLETED</span>
            </div>

            <!-- Scrollable content area - contains both output AND chat -->
            <div class="agent-detail-content" id="agent-page-content">
                <!-- Agent output rendered here by JavaScript -->
                <div id="agent-output-area"></div>

                <!-- Inline Chat for Agent Questions (INSIDE scrollable area) -->
                <div class="agent-chat-container" id="agent-chat-container">
                    <div class="agent-chat-messages" id="agent-chat-messages">
                        <!-- User questions and responses appear here -->
                    </div>
                </div>
            </div>

            <!-- Quick Ask Input - fixed above footer -->
            <div class="agent-ask-input-area" id="agent-ask-area" style="display: none;">
                <input type="text" class="agent-ask-input" id="agent-ask-input" placeholder="Ask a question about this output..." onkeydown="if(event.key==='Enter')submitAgentQuestion()">
                <button class="agent-ask-send" onclick="submitAgentQuestion()">Send</button>
            </div>

            <div class="agent-actions-footer" id="agent-actions-footer">
                <div class="followup-instructions-container" id="followup-instructions-container" style="display: none; width: 100%; margin-bottom: 12px;">
                    <textarea id="followup-instructions"
                              placeholder="Add specific instructions for the agent (e.g., 'Execute option 1' or 'Focus on the TTS integration')..."
                              rows="2"
                              style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 14px; resize: vertical; min-height: 50px;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; width: 100%;">
                    <button class="agent-action-btn secondary" onclick="openAgentChatPage(currentDetailAgentId)">
                         Ask Question
                    </button>
                    <button class="agent-action-btn primary" id="continue-agent-btn" onclick="executeAgentFollowUp()">
                        Execute Task
                    </button>
                </div>
            </div>
        </div>

        <!-- Agent Chat Page (Full Screen Dedicated Chat) -->
        <div class="agent-chat-page" id="agent-chat-page">
            <div class="agent-chat-page-header">
                <button class="back-btn" onclick="closeAgentChatPage()"> Back</button>
                <span class="agent-chat-page-title" id="agent-chat-page-title">Chat with Agent</span>
                <span class="agent-status-badge" id="agent-chat-page-status">COMPLETED</span>
            </div>

            <!-- Collapsible Context Summary -->
            <div class="agent-context-summary" id="agent-context-summary">
                <div class="context-toggle" onclick="toggleContextSummary()">
                    <span class="context-toggle-icon" id="context-toggle-icon"></span>
                    <span>Agent Context</span>
                </div>
                <div class="context-details" id="context-details">
                    <div class="context-task" id="context-task"></div>
                    <div class="context-output-preview" id="context-output-preview"></div>
                </div>
            </div>

            <!-- Chat Messages Area -->
            <div class="agent-chat-messages-area" id="agent-chat-messages-area">
                <!-- Chat messages rendered here -->
            </div>

            <!-- Chat Input Area -->
            <div class="agent-chat-input-area">
                <input type="text" class="agent-chat-input" id="agent-chat-page-input"
                       placeholder="Ask about the agent's work..."
                       onkeydown="if(event.key==='Enter')submitAgentChatQuestion()">
                <button class="agent-chat-send-btn" onclick="submitAgentChatQuestion()">Send</button>
            </div>
        </div>
    </div>

    <script src="/static/socket.io.min.js"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const CEREBRO_CONFIG = window.CEREBRO_CONFIG || {};
        const currentHost = window.location.hostname;
        const currentPort = window.location.port || '59000';
        const isElectron = navigator.userAgent.includes('Electron');
        const API_URL = CEREBRO_CONFIG.apiUrl || (isElectron ? 'http://localhost:59000' : `http://${currentHost}:${currentPort}`);
        const CEREBRO_TTS_URL = CEREBRO_CONFIG.ttsUrl || '';
        const CEREBRO_DGX_HOST = CEREBRO_CONFIG.dgxHost || '';
        const CEREBRO_DATA_DIR = CEREBRO_CONFIG.dataDir || '';
        const CEREBRO_CDP_URL = CEREBRO_CONFIG.cdpUrl || 'http://localhost:9222';
        const CEREBRO_USERNAME = CEREBRO_CONFIG.username || 'Professor';

        console.log('Cerebro connecting to:', API_URL);

        let token = localStorage.getItem('cerebro_token');
        let socket = null;
        let sessionId = null;
        let recognition = null;
        let isRecording = false;

        // TTS Configuration
        const TTS_URL = CEREBRO_TTS_URL || '/tts';
        const TTS_CONFIG = { voice: localStorage.getItem("cerebro_tts_voice") || "af_heart", speed: parseFloat(localStorage.getItem("cerebro_tts_speed") || "1.0"), format: "mp3", autoSpeak: localStorage.getItem("cerebro_tts_autospeak") === "true" };
        let currentAudio = null;
        let isSpeaking = false;
        let conversationalMode = false;
        let silenceTimer = null;

        // ==================== AUTH ====================
        async function login() {
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('login-error');
            errorEl.style.display = 'none';

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (!response.ok) {
                    throw new Error('Invalid password');
                }

                const data = await response.json();
                token = data.token;
                localStorage.setItem('cerebro_token', token);
                showApp();
            } catch (e) {
                errorEl.textContent = e.message || 'Login failed';
                errorEl.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('cerebro_token');
            token = null;
            location.reload();
        }

        function showApp() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('server-url').textContent = API_URL.replace('http://', '');
            initApp();
        }

        // ==================== INIT ====================
        async function initApp() {
            updateDateTime();
            setInterval(updateDateTime, 60000);

            // Restore auto-awake checkbox state from localStorage
            const autoAwakeCheckbox = document.getElementById('auto-awake-checkbox');
            if (autoAwakeCheckbox) {
                const saved = localStorage.getItem('cerebro_auto_awake');
                autoAwakeCheckbox.checked = saved === null ? true : saved === 'true';
            }

            // Initialize the living presence card
            initCerebroPresence();

            // Hide chat input initially (only show on chat tab)
            const chatInput = document.querySelector('.chat-input-area');
            if (chatInput) chatInput.style.display = 'none';

            // Load persistent chat history
            await loadChatHistory();

            await loadBriefing();
            loadHomepage(); // Non-blocking parallel homepage load
            await loadSmartSuggestions();
            await loadAgents();
            await loadRecentAgents();
            await loadNotifications();
            await loadDirectives();
            await loadInsights();
            connectSocket();
            await fetchModelsFromServer();
            initVoice();
            loadAudioDevices();
            initVoiceSettings();
            loadPersonality();
            loadLookStatus();

            // Init TTS orb click - conversational mode toggle
            const navOrb = document.getElementById('nav-orb-container');
            if (navOrb) {
                navOrb.addEventListener('click', () => {
                    if (conversationalMode) {
                        stopConversationalMode();
                        return;
                    }
                    if (isSpeaking) { stopSpeaking(); return; }
                    if (isRecording) { showToast('Stop recording first'); return; }
                    startConversationalMode();
                });
                navOrb.title = 'Click to start/stop voice conversation';
            }

            handleMobileKeyboard();

            // Refresh live activity every 15 seconds
            setInterval(loadLiveActivity, 15000);

            // Request notification permission for agent alerts
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // ==================== HOMEPAGE DASHBOARD ====================

        async function loadHomepage() {
            await Promise.allSettled([
                loadSmartActions(),
                loadLiveActivity(),
                loadHomeGoals(),
                loadProjectTracker(),
                loadMemoryIntelligence(),
            ]);
        }

        const ACTION_ICONS = {
            rocket: '\u{1F680}', play: '\u25B6\uFE0F', target: '\u{1F3AF}', alert: '\u26A0\uFE0F', book: '\u{1F4DA}'
        };

        // ==================== SMOOTH CHAT TRANSITION + CONTEXT SYSTEM ====================
        let pendingChatContext = null;
        let isViewTransitioning = false;

        function openActionChat(contextData) {
            if (isViewTransitioning) return;
            pendingChatContext = typeof contextData === 'string'
                ? { rawText: contextData } : contextData;
            closeHomeDetail();
            setTimeout(function() {
                switchView('chat');
                setTimeout(function() {
                    if (pendingChatContext) injectContextBubble(pendingChatContext);
                }, 600);
            }, 320);
        }

        function slideToView(targetViewName, callback) {
            switchView(targetViewName);
            setTimeout(function() {
                if (callback) callback();
            }, 600);
        }

        function injectContextBubble(contextData) {
            var existing = document.querySelector('.message.context-system');
            if (existing) existing.parentNode.removeChild(existing);

            var bubble = document.createElement('div');
            bubble.className = 'message context-system';

            // Header
            var header = document.createElement('div');
            header.className = 'context-system-header';

            var label = document.createElement('div');
            label.className = 'context-system-label';
            var svgNS = 'http://www.w3.org/2000/svg';
            var svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('viewBox', '0 0 16 16');
            var path = document.createElementNS(svgNS, 'path');
            path.setAttribute('d', 'M8 1a7 7 0 100 14A7 7 0 008 1zm0 2a1 1 0 110 2 1 1 0 010-2zm2 8H6v-1h1V7H6V6h3v4h1v1z');
            svg.appendChild(path);
            label.appendChild(svg);
            label.appendChild(document.createTextNode(' Context Loaded'));

            var dismissBtn = document.createElement('button');
            dismissBtn.className = 'context-system-dismiss';
            dismissBtn.textContent = '\u00D7';
            dismissBtn.onclick = function() { dismissContextBubble(bubble); };

            header.appendChild(label);
            header.appendChild(dismissBtn);
            bubble.appendChild(header);

            // Body
            var body = document.createElement('div');
            body.className = 'context-system-body';

            if (contextData.project) {
                var nameEl = document.createElement('div');
                nameEl.className = 'context-project-name';
                var iconSpan = document.createElement('span');
                iconSpan.className = 'ctx-icon';
                iconSpan.textContent = contextData.icon || '\u{1F4C1}';
                nameEl.appendChild(iconSpan);
                nameEl.appendChild(document.createTextNode(contextData.project));
                body.appendChild(nameEl);
            }

            if (contextData.summary) {
                body.appendChild(createContextField('Summary', contextData.summary));
            }

            if (contextData.next_action) {
                body.appendChild(createContextField('Next Action', contextData.next_action, 'next-action'));
            }

            if (contextData.description && !contextData.project) {
                body.appendChild(createContextField('Description', contextData.description));
            }

            if (contextData.title && !contextData.project) {
                body.appendChild(createContextField('Task', contextData.title));
            }

            if (contextData.key_files && contextData.key_files.length > 0) {
                var filesField = document.createElement('div');
                filesField.className = 'context-field';
                var filesLabel = document.createElement('div');
                filesLabel.className = 'context-field-label';
                filesLabel.textContent = 'Key Files';
                filesField.appendChild(filesLabel);
                var filesRow = document.createElement('div');
                filesRow.className = 'context-files-row';
                contextData.key_files.forEach(function(f) {
                    var pill = document.createElement('span');
                    pill.className = 'context-file-pill';
                    pill.textContent = f;
                    pill.title = f;
                    filesRow.appendChild(pill);
                });
                filesField.appendChild(filesRow);
                body.appendChild(filesField);
            }

            if (contextData.rawText && !contextData.project && !contextData.description && !contextData.title) {
                body.appendChild(createContextField('Context', contextData.rawText));
            }

            bubble.appendChild(body);

            var messages = document.getElementById('messages');
            if (messages) {
                messages.appendChild(bubble);
                scrollMessagesToBottom();
            }

            var chatInput = document.getElementById('chat-input');
            if (chatInput) chatInput.focus();
        }

        function createContextField(labelText, value, extraClass) {
            var field = document.createElement('div');
            field.className = 'context-field' + (extraClass ? ' ' + extraClass : '');
            var lbl = document.createElement('div');
            lbl.className = 'context-field-label';
            lbl.textContent = labelText;
            var val = document.createElement('div');
            val.className = 'context-field-value';
            val.textContent = value;
            field.appendChild(lbl);
            field.appendChild(val);
            return field;
        }

        function dismissContextBubble(bubble) {
            if (!bubble) return;
            bubble.classList.add('dismissing');
            setTimeout(function() {
                if (bubble.parentNode) bubble.parentNode.removeChild(bubble);
            }, 300);
            pendingChatContext = null;
        }

        // ==================== HOMEPAGE V2: UNIVERSAL DETAIL MODAL ====================
        function openHomeDetail(type, data) {
            var modal = document.getElementById('home-detail-modal');
            var header = document.getElementById('detail-header');
            var iconEl = document.getElementById('detail-icon');
            var titleEl = document.getElementById('detail-title');
            var subtitleEl = document.getElementById('detail-subtitle');
            var body = document.getElementById('detail-body');
            var footer = document.getElementById('detail-footer');

            header.className = 'detail-header type-' + type;

            var icons = { action: '\u{1F680}', goal: '\u{1F3AF}', project: '\u{1F4C1}', stat: '\u{1F4CA}', activity: '\u26A1' };
            iconEl.textContent = data.icon || icons[type] || '\u2139\uFE0F';
            titleEl.textContent = data.title || data.name || data.description || '';
            subtitleEl.textContent = data.subtitle || buildSubtitle(type, data);

            body.textContent = '';
            body.appendChild(buildDetailContent(type, data));

            footer.textContent = '';
            footer.appendChild(buildDetailActions(type, data));

            modal.classList.add('active');
        }

        function closeHomeDetail() {
            document.getElementById('home-detail-modal').classList.remove('active');
        }

        function buildSubtitle(type, data) {
            switch(type) {
                case 'action': return data.iconClass ? data.iconClass.charAt(0).toUpperCase() + data.iconClass.slice(1) + ' action' : 'Suggested action';
                case 'goal': return 'Priority: ' + (data.priority || 'medium');
                case 'project': return 'Status: ' + (data.status || 'unknown').replace(/_/g, ' ');
                case 'stat': return 'System metric';
                case 'activity': return data.type || 'Live service';
                default: return '';
            }
        }

        function buildDetailContent(type, data) {
            var frag = document.createDocumentFragment();

            if (type === 'stat') {
                var sec = document.createElement('div');
                sec.className = 'detail-section';
                var val = document.createElement('div');
                val.className = 'detail-section-content';
                val.style.fontSize = '2rem';
                val.style.fontWeight = '800';
                val.style.textAlign = 'center';
                val.style.padding = '10px 0';
                val.textContent = data.value || '--';
                sec.appendChild(val);
                frag.appendChild(sec);

                if (data.context) {
                    var ctx = document.createElement('div');
                    ctx.className = 'detail-section';
                    var lbl = document.createElement('div');
                    lbl.className = 'detail-section-label';
                    lbl.textContent = 'About';
                    ctx.appendChild(lbl);
                    var cnt = document.createElement('div');
                    cnt.className = 'detail-section-content';
                    cnt.textContent = data.context;
                    ctx.appendChild(cnt);
                    frag.appendChild(ctx);
                }
            }

            if (type === 'action') {
                if (data.description) {
                    var sec = document.createElement('div');
                    sec.className = 'detail-section';
                    var lbl = document.createElement('div');
                    lbl.className = 'detail-section-label';
                    lbl.textContent = 'Description';
                    sec.appendChild(lbl);
                    var cnt = document.createElement('div');
                    cnt.className = 'detail-section-content';
                    cnt.textContent = data.description;
                    sec.appendChild(cnt);
                    frag.appendChild(sec);
                }
                if (data.context) {
                    var sec2 = document.createElement('div');
                    sec2.className = 'detail-section';
                    var lbl2 = document.createElement('div');
                    lbl2.className = 'detail-section-label';
                    lbl2.textContent = 'Context';
                    sec2.appendChild(lbl2);
                    var cnt2 = document.createElement('div');
                    cnt2.className = 'detail-section-content';
                    cnt2.style.fontFamily = 'monospace';
                    cnt2.style.fontSize = '0.78rem';
                    cnt2.style.background = 'rgba(255,255,255,0.03)';
                    cnt2.style.padding = '8px 10px';
                    cnt2.style.borderRadius = '8px';
                    cnt2.textContent = data.context;
                    sec2.appendChild(cnt2);
                    frag.appendChild(sec2);
                }
            }

            if (type === 'goal') {
                if (data.description) {
                    var sec = document.createElement('div');
                    sec.className = 'detail-section';
                    var lbl = document.createElement('div');
                    lbl.className = 'detail-section-label';
                    lbl.textContent = 'Description';
                    sec.appendChild(lbl);
                    var cnt = document.createElement('div');
                    cnt.className = 'detail-section-content';
                    cnt.textContent = data.description;
                    sec.appendChild(cnt);
                    frag.appendChild(sec);
                }

                var subgoals = data.subgoals || [];
                if (subgoals.length > 0) {
                    var done = subgoals.filter(function(s) { return s.completed || s.status === 'completed'; }).length;
                    var pct = Math.round((done / subgoals.length) * 100);

                    var progSec = document.createElement('div');
                    progSec.className = 'detail-section';
                    var progLbl = document.createElement('div');
                    progLbl.className = 'detail-section-label';
                    progLbl.textContent = 'Progress (' + done + '/' + subgoals.length + ')';
                    progSec.appendChild(progLbl);
                    var bar = document.createElement('div');
                    bar.className = 'detail-progress-bar';
                    var fill = document.createElement('div');
                    fill.className = 'detail-progress-fill';
                    fill.style.width = pct + '%';
                    bar.appendChild(fill);
                    progSec.appendChild(bar);
                    frag.appendChild(progSec);

                    var sgSec = document.createElement('div');
                    sgSec.className = 'detail-section';
                    var sgLbl = document.createElement('div');
                    sgLbl.className = 'detail-section-label';
                    sgLbl.textContent = 'Subgoals';
                    sgSec.appendChild(sgLbl);
                    var sgList = document.createElement('div');
                    sgList.className = 'detail-subgoal-list';
                    subgoals.forEach(function(sg) {
                        var isDone = sg.completed || sg.status === 'completed';
                        var item = document.createElement('div');
                        item.className = 'detail-subgoal-item' + (isDone ? ' done' : '');
                        var check = document.createElement('span');
                        check.className = 'detail-subgoal-check';
                        check.textContent = isDone ? '\u2713' : '';
                        item.appendChild(check);
                        var text = document.createElement('span');
                        text.textContent = typeof sg === 'string' ? sg : (sg.description || sg.text || '');
                        item.appendChild(text);
                        sgList.appendChild(item);
                    });
                    sgSec.appendChild(sgList);
                    frag.appendChild(sgSec);
                }

                var blockers = data.blockers || [];
                if (blockers.length > 0) {
                    var bSec = document.createElement('div');
                    bSec.className = 'detail-section';
                    var bLbl = document.createElement('div');
                    bLbl.className = 'detail-section-label';
                    bLbl.textContent = 'Blockers';
                    bSec.appendChild(bLbl);
                    var bList = document.createElement('div');
                    bList.className = 'detail-blocker-list';
                    blockers.forEach(function(b) {
                        var pill = document.createElement('span');
                        pill.className = 'detail-blocker-pill';
                        pill.textContent = typeof b === 'string' ? b : (b.description || '');
                        bList.appendChild(pill);
                    });
                    bSec.appendChild(bList);
                    frag.appendChild(bSec);
                }
            }

            if (type === 'project') {
                if (data.summary) {
                    var sec = document.createElement('div');
                    sec.className = 'detail-section';
                    var lbl = document.createElement('div');
                    lbl.className = 'detail-section-label';
                    lbl.textContent = 'Summary';
                    sec.appendChild(lbl);
                    var cnt = document.createElement('div');
                    cnt.className = 'detail-section-content';
                    cnt.textContent = data.summary;
                    sec.appendChild(cnt);
                    frag.appendChild(sec);
                }
                if (data.next_action) {
                    var sec2 = document.createElement('div');
                    sec2.className = 'detail-section';
                    var lbl2 = document.createElement('div');
                    lbl2.className = 'detail-section-label';
                    lbl2.textContent = 'Next Action';
                    sec2.appendChild(lbl2);
                    var cnt2 = document.createElement('div');
                    cnt2.className = 'detail-section-content';
                    cnt2.style.borderLeft = '3px solid var(--accent)';
                    cnt2.style.paddingLeft = '10px';
                    cnt2.textContent = data.next_action;
                    sec2.appendChild(cnt2);
                    frag.appendChild(sec2);
                }
                if (data.key_files && data.key_files.length > 0) {
                    var sec3 = document.createElement('div');
                    sec3.className = 'detail-section';
                    var lbl3 = document.createElement('div');
                    lbl3.className = 'detail-section-label';
                    lbl3.textContent = 'Key Files';
                    sec3.appendChild(lbl3);
                    var fList = document.createElement('div');
                    fList.className = 'detail-file-list';
                    data.key_files.forEach(function(f) {
                        var fi = document.createElement('div');
                        fi.className = 'detail-file-item';
                        fi.textContent = f;
                        fList.appendChild(fi);
                    });
                    sec3.appendChild(fList);
                    frag.appendChild(sec3);
                }
            }

            if (type === 'activity') {
                var sec = document.createElement('div');
                sec.className = 'detail-section';
                var lbl = document.createElement('div');
                lbl.className = 'detail-section-label';
                lbl.textContent = 'Details';
                sec.appendChild(lbl);
                var cnt = document.createElement('div');
                cnt.className = 'detail-section-content';
                var bodyId = data.type === 'agents' ? 'live-agents-body' : data.type === 'health' ? 'live-health-body' : 'live-autonomy-body';
                var srcBody = document.getElementById(bodyId);
                if (srcBody) {
                    var clone = srcBody.cloneNode(true);
                    cnt.appendChild(clone);
                } else {
                    cnt.textContent = 'No details available';
                }
                sec.appendChild(cnt);
                frag.appendChild(sec);
            }

            return frag;
        }

        function buildDetailActions(type, data) {
            var frag = document.createDocumentFragment();

            if (type === 'stat') {
                var btn = document.createElement('button');
                btn.className = 'detail-action-btn primary';
                btn.textContent = 'Explore in Chat';
                btn.onclick = function() { openActionChat({ type: 'stat', rawText: 'Tell me about my ' + (data.name || 'stats') }); };
                frag.appendChild(btn);
            }

            if (type === 'action') {
                var btn1 = document.createElement('button');
                btn1.className = 'detail-action-btn primary';
                btn1.textContent = 'Open in Chat';
                btn1.onclick = function() { openActionChat({ type: 'action', title: data.title || '', context: data.context || '', description: data.description || '' }); };
                frag.appendChild(btn1);
                var btn2 = document.createElement('button');
                btn2.className = 'detail-action-btn';
                btn2.textContent = 'Spawn Agent';
                btn2.onclick = function() { closeHomeDetail(); if (typeof openAgentModal === 'function') openAgentModal(data.context || data.title || ''); else openActionChat({ type: 'action', title: data.title || '', context: data.context || '' }); };
                frag.appendChild(btn2);
            }

            if (type === 'goal') {
                var btn1 = document.createElement('button');
                btn1.className = 'detail-action-btn primary';
                btn1.textContent = 'Pursue in Chat';
                btn1.onclick = function() { openActionChat({ type: 'goal', description: data.description || '' }); };
                frag.appendChild(btn1);
                var btn2 = document.createElement('button');
                btn2.className = 'detail-action-btn';
                btn2.textContent = 'Update Goal';
                btn2.onclick = function() { openActionChat({ type: 'goal', description: data.description || '', title: 'Update Goal Status' }); };
                frag.appendChild(btn2);
            }

            if (type === 'project') {
                var btn1 = document.createElement('button');
                btn1.className = 'detail-action-btn primary';
                btn1.textContent = 'Continue in Chat';
                btn1.onclick = function() { openActionChat({ type: 'project', project: data.project || '', summary: data.summary || '', next_action: data.next_action || '', key_files: data.key_files || [], icon: data.icon || '' }); };
                frag.appendChild(btn1);
                var btn2 = document.createElement('button');
                btn2.className = 'detail-action-btn';
                btn2.textContent = 'Spawn Agent';
                btn2.onclick = function() { closeHomeDetail(); if (typeof openAgentModal === 'function') openAgentModal('Continue: ' + (data.project || '')); else openActionChat({ type: 'project', project: data.project || '', summary: data.summary || '', next_action: data.next_action || '', key_files: data.key_files || [] }); };
                frag.appendChild(btn2);
            }

            if (type === 'activity') {
                var btn = document.createElement('button');
                btn.className = 'detail-action-btn primary';
                btn.textContent = 'View Details';
                btn.onclick = function() {
                    closeHomeDetail();
                    if (data.type === 'agents') switchView('agents');
                    else if (data.type === 'health') switchView('settings');
                    else switchView('chat');
                };
                frag.appendChild(btn);
            }

            return frag;
        }

        // ==================== HOMEPAGE V2: COLLAPSIBLE SECTIONS ====================
        var _sectionDefaults = { activity: false, goals: false, projects: true, memory: true };

        function initCollapsibleSections() {
            var stored = {};
            try { stored = JSON.parse(localStorage.getItem('home-section-state') || '{}'); } catch(e) {}
            Object.keys(_sectionDefaults).forEach(function(key) {
                var collapsed = stored.hasOwnProperty(key) ? stored[key] : _sectionDefaults[key];
                var sectionMap = { activity: 'home-section-activity', goals: 'home-goals-section', projects: 'home-section-projects', memory: 'home-section-memory' };
                var el = document.getElementById(sectionMap[key]);
                if (el) {
                    if (collapsed) el.classList.add('collapsed');
                    else el.classList.remove('collapsed');
                }
            });
        }

        function toggleSection(sectionId) {
            var sectionMap = { activity: 'home-section-activity', goals: 'home-goals-section', projects: 'home-section-projects', memory: 'home-section-memory' };
            var el = document.getElementById(sectionMap[sectionId]);
            if (!el) return;
            el.classList.toggle('collapsed');
            var stored = {};
            try { stored = JSON.parse(localStorage.getItem('home-section-state') || '{}'); } catch(e) {}
            stored[sectionId] = el.classList.contains('collapsed');
            localStorage.setItem('home-section-state', JSON.stringify(stored));
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                var modal = document.getElementById('home-detail-modal');
                if (modal && modal.classList.contains('active')) {
                    closeHomeDetail();
                }
            }
        });

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCollapsibleSections);
        } else {
            initCollapsibleSections();
        }

        function buildActionCards(actions) {
            const frag = document.createDocumentFragment();
            actions.forEach((a, index) => {
                const card = document.createElement('div');
                card.className = 'action-card stagger-in';
                card.style.setProperty('--si', index);
                card.onclick = () => openHomeDetail('action', { title: a.title || '', description: a.description || '', context: a.context || '', icon: ACTION_ICONS[a.icon] || '\u{1F680}', iconClass: a.icon || 'rocket' });

                const icon = document.createElement('div');
                icon.className = 'action-card-icon ' + (a.icon || 'rocket');
                icon.textContent = ACTION_ICONS[a.icon] || '\u{1F680}';
                card.appendChild(icon);

                const title = document.createElement('div');
                title.className = 'action-card-title';
                title.textContent = a.title || '';
                card.appendChild(title);

                const desc = document.createElement('div');
                desc.className = 'action-card-desc';
                desc.textContent = a.description || '';
                card.appendChild(desc);

                const go = document.createElement('span');
                go.className = 'action-card-go';
                go.textContent = 'Go \u2192';
                card.appendChild(go);

                frag.appendChild(card);
            });
            return frag;
        }

        async function loadSmartActions() {
            const container = document.getElementById('smart-actions-container');
            try {
                const resp = await fetch(API_URL + '/api/smart-actions', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await resp.json();
                const actions = data.actions || [];

                container.textContent = '';
                if (actions.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'live-empty';
                    empty.textContent = "No actions right now \u2014 you're all caught up!";
                    container.appendChild(empty);
                    return;
                }
                container.appendChild(buildActionCards(actions));
            } catch (e) {
                container.textContent = '';
                const empty = document.createElement('div');
                empty.className = 'live-empty';
                empty.textContent = 'Could not load actions';
                container.appendChild(empty);
            }
        }

        async function loadLiveActivity() {
            const headers = { 'Authorization': 'Bearer ' + token };
            const [agentsResp, statusResp, autonomyResp] = await Promise.allSettled([
                fetch(API_URL + '/agents', { headers }),
                fetch(API_URL + '/system-status', { headers }),
                fetch(API_URL + '/api/autonomy/status', { headers }),
            ]);

            // Running agents
            const agentsBody = document.getElementById('live-agents-body');
            try {
                const agentsData = agentsResp.status === 'fulfilled' ? await agentsResp.value.json() : {};
                const running = (agentsData.agents || []).filter(a => a.status === 'running' || a.status === 'working');
                agentsBody.textContent = '';
                if (running.length === 0) {
                    const e = document.createElement('div');
                    e.className = 'live-empty';
                    e.textContent = 'No agents running';
                    agentsBody.appendChild(e);
                } else {
                    running.forEach((a, index) => {
                        const row = document.createElement('div');
                        row.className = 'live-agent-item stagger-in';
                        row.style.setProperty('--si', index);
                        row.onclick = () => switchView('agents');
                        const dot = document.createElement('div');
                        dot.className = 'live-agent-dot';
                        row.appendChild(dot);
                        const task = document.createElement('span');
                        task.className = 'live-agent-task';
                        task.textContent = a.task || a.id || 'Agent';
                        row.appendChild(task);
                        const time = document.createElement('span');
                        time.className = 'live-agent-time';
                        time.textContent = a.started_at ? getTimeAgo(a.started_at) : '';
                        row.appendChild(time);
                        agentsBody.appendChild(row);
                    });
                }
                const countEl = document.getElementById('active-agents-count');
                if (countEl) countEl.textContent = running.length;
            } catch (e) {
                agentsBody.textContent = '';
                const empty = document.createElement('div');
                empty.className = 'live-empty';
                empty.textContent = 'No agents running';
                agentsBody.appendChild(empty);
            }

            // System status
            try {
                const statusData = statusResp.status === 'fulfilled' ? await statusResp.value.json() : {};
                const grid = document.getElementById('system-status-grid');
                if (grid && statusData.services) {
                    grid.textContent = '';
                    var statusIndex = 0;
                    Object.entries(statusData.services).forEach(([name, info]) => {
                        const status = (typeof info === 'object' ? info.status : info) || 'unknown';
                        const cls = (status === 'online' || status === 'ok' || status === 'connected') ? 'online' :
                                    (status === 'offline' || status === 'error') ? 'offline' : 'unknown';
                        const item = document.createElement('div');
                        item.className = 'status-item stagger-in';
                        item.style.setProperty('--si', statusIndex++);
                        const dot = document.createElement('span');
                        dot.className = 'status-dot ' + cls;
                        item.appendChild(dot);
                        const n = document.createElement('span');
                        n.className = 'status-name';
                        n.textContent = name;
                        item.appendChild(n);
                        grid.appendChild(item);
                    });
                }
            } catch (e) {}

            // Autonomy
            const autoBody = document.getElementById('live-autonomy-body');
            try {
                const autoData = autonomyResp.status === 'fulfilled' ? await autonomyResp.value.json() : {};
                autoBody.textContent = '';
                const row = document.createElement('div');
                row.className = 'autonomy-status-row';
                const badge = document.createElement('span');
                if (autoData.status === 'running' || autoData.running) {
                    badge.className = 'autonomy-badge running';
                    badge.textContent = 'Running';
                    row.appendChild(badge);
                    const lvl = document.createElement('span');
                    lvl.textContent = 'Level ' + (autoData.autonomy_level || autoData.level || 1);
                    row.appendChild(lvl);
                } else {
                    badge.className = 'autonomy-badge idle';
                    badge.textContent = 'Idle';
                    row.appendChild(badge);
                }
                autoBody.appendChild(row);
            } catch (e) {
                autoBody.textContent = '';
                const row = document.createElement('div');
                row.className = 'autonomy-status-row';
                const badge = document.createElement('span');
                badge.className = 'autonomy-badge idle';
                badge.textContent = 'Idle';
                row.appendChild(badge);
                autoBody.appendChild(row);
            }
        }

        async function loadHomeGoals() {
            const container = document.getElementById('home-goals-list');
            try {
                const resp = await fetch(API_URL + '/api/goals', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await resp.json();
                const goals = (data.goals || []).slice(0, 4);

                const countEl = document.getElementById('home-goals-count');
                if (countEl) countEl.textContent = goals.length;
                const badgeEl = document.getElementById('goals-count-badge');
                if (badgeEl) badgeEl.textContent = goals.length;

                container.textContent = '';
                if (goals.length === 0) {
                    const e = document.createElement('div');
                    e.className = 'live-empty';
                    e.textContent = 'No active goals';
                    container.appendChild(e);
                    return;
                }

                goals.forEach((g, index) => {
                    const p = g.priority || 'medium';
                    const subgoals = g.subgoals || [];
                    const done = subgoals.filter(s => s.completed || s.status === 'completed').length;
                    const pct = subgoals.length > 0 ? Math.round((done / subgoals.length) * 100) : 0;
                    const blockers = g.blockers || [];

                    const row = document.createElement('div');
                    row.className = 'goal-compact-row stagger-in';
                    row.style.setProperty('--si', index);
                    row.onclick = () => openHomeDetail('goal', {
                        title: g.description || 'Goal',
                        description: g.description || '',
                        priority: p,
                        subgoals: subgoals,
                        blockers: blockers,
                        icon: '\u{1F3AF}'
                    });

                    // Priority dot
                    const dot = document.createElement('span');
                    dot.className = 'goal-priority-dot ' + p;
                    row.appendChild(dot);

                    // Description (truncated)
                    const descEl = document.createElement('span');
                    descEl.className = 'goal-compact-desc';
                    descEl.textContent = g.description || '';
                    row.appendChild(descEl);

                    // Mini progress bar
                    if (subgoals.length > 0) {
                        const miniBar = document.createElement('div');
                        miniBar.className = 'goal-mini-progress';
                        const miniFill = document.createElement('div');
                        miniFill.className = 'goal-mini-progress-fill';
                        miniFill.style.width = pct + '%';
                        miniBar.appendChild(miniFill);
                        row.appendChild(miniBar);
                    }

                    // Priority badge
                    const badge = document.createElement('span');
                    badge.className = 'goal-compact-badge ' + p;
                    badge.textContent = p;
                    row.appendChild(badge);

                    container.appendChild(row);
                });
            } catch (e) {
                container.textContent = '';
                const empty = document.createElement('div');
                empty.className = 'live-empty';
                empty.textContent = 'Could not load goals';
                container.appendChild(empty);
            }
        }

        async function loadProjectTracker() {
            const container = document.getElementById('project-tracker-container');
            try {
                const resp = await fetch(API_URL + '/api/workstreams', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await resp.json();
                const ws = data.workstreams || [];

                container.textContent = '';
                if (ws.length === 0) {
                    const e = document.createElement('div');
                    e.className = 'live-empty';
                    e.textContent = 'No active projects';
                    container.appendChild(e);
                    return;
                }

                // Update projects count badge
                const projBadge = document.getElementById('projects-count-badge');
                if (projBadge) projBadge.textContent = ws.length;

                ws.forEach((w, index) => {
                    const st = (w.status || 'unknown').replace(/ /g, '_');
                    const card = document.createElement('div');
                    card.className = 'project-card stagger-in';
                    card.style.setProperty('--si', index);
                    card.onclick = () => openHomeDetail('project', {
                        title: w.project || 'Project',
                        project: w.project || '',
                        status: st,
                        summary: w.summary || '',
                        next_action: w.next_action || '',
                        key_files: w.key_files || [],
                        icon: '\u{1F4C1}'
                    });

                    const hdr = document.createElement('div');
                    hdr.className = 'project-card-header';
                    const name = document.createElement('span');
                    name.className = 'project-card-name';
                    name.textContent = w.project || '';
                    hdr.appendChild(name);
                    const badge = document.createElement('span');
                    badge.className = 'project-status-badge ' + st;
                    badge.textContent = st.replace(/_/g, ' ');
                    hdr.appendChild(badge);
                    card.appendChild(hdr);

                    const summary = document.createElement('div');
                    summary.className = 'project-card-summary';
                    summary.textContent = w.summary || '';
                    card.appendChild(summary);

                    if (w.next_action) {
                        const na = document.createElement('div');
                        na.className = 'project-next-action';
                        na.textContent = w.next_action;
                        card.appendChild(na);
                    }

                    const btn = document.createElement('button');
                    btn.className = 'project-continue-btn';
                    btn.textContent = 'Continue';
                    btn.onclick = (e) => { e.stopPropagation(); openHomeDetail('project', { title: w.project || 'Project', project: w.project || '', status: st, summary: w.summary || '', next_action: w.next_action || '', key_files: w.key_files || [], icon: '\u{1F4C1}' }); };
                    card.appendChild(btn);

                    container.appendChild(card);
                });
            } catch (e) {
                container.textContent = '';
                const empty = document.createElement('div');
                empty.className = 'live-empty';
                empty.textContent = 'Could not load projects';
                container.appendChild(empty);
            }
        }

        function animateValueChange(el, newText) {
            if (!el || el.textContent === String(newText)) return;
            el.style.transition = 'opacity 0.15s ease, transform 0.15s ease';
            el.style.opacity = '0.4';
            el.style.transform = 'scale(0.95)';
            setTimeout(function() {
                el.textContent = newText;
                el.style.opacity = '1';
                el.style.transform = 'scale(1)';
            }, 150);
        }

        async function loadMemoryIntelligence() {
            try {
                const resp = await fetch(API_URL + '/api/memory-intelligence', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const d = await resp.json();

                const set = (id, val) => {
                    const el = document.getElementById(id);
                    animateValueChange(el, val);
                };

                set('intel-total-memories', (d.total_memories || 0).toLocaleString());
                set('intel-recent-learnings', d.recent_learnings || 0);
                set('intel-patterns', d.promoted_patterns || 0);
                set('intel-contradictions', d.contradictions_pending || 0);
                set('intel-health', (d.knowledge_health || 0) + '%');
                set('intel-faiss', d.faiss_size_mb ? d.faiss_size_mb + 'MB' : '--');

                // Also update hero pills
                set('home-learnings-count', d.total_learnings || 0);
                set('home-patterns-count', d.promoted_patterns || 0);
                set('system-health', (d.knowledge_health || 0) + '%');
            } catch (e) {
                // Silently fail - tiles will show --
            }
        }

        // ==================== INTEREST SUGGESTIONS (LEGACY) ====================
        let interestSuggestions = { fun_project: null, business_feature: null, claude_choice: null };

        async function loadInterestSuggestions() {
            try {
                const response = await fetch(`${API_URL}/suggestions/interests`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to load interest suggestions');
                const data = await response.json();
                interestSuggestions = data;
                renderInterestSuggestions();
            } catch (error) {
                console.error('Failed to load interest suggestions:', error);
                // Show fallback with all three types
                document.getElementById('interest-cards').innerHTML = `
                    <div class="interest-card fun-project" onclick="startChat('Suggest a fun project for me based on my interests')">
                        <span class="interest-type-badge">Fun Project</span>
                        <div class="interest-card-title">Suggest Something Fun</div>
                        <div class="interest-card-desc">Let me think of a fun project based on your interests</div>
                    </div>
                    <div class="interest-card business-feature" onclick="startChat('Suggest a business feature I could build')">
                        <span class="interest-type-badge">Business</span>
                        <div class="interest-card-title">Business Enhancement</div>
                        <div class="interest-card-desc">Get ideas for improving your business applications</div>
                    </div>
                    <div class="interest-card claude-choice" onclick="startChat('What feature would help you assist me better?')">
                        <span class="interest-type-badge">Claude's Choice</span>
                        <div class="interest-card-title">Help Me Help You</div>
                        <div class="interest-card-desc">Let me suggest ways to improve our collaboration</div>
                    </div>
                `;
            }
        }

        function renderInterestSuggestions() {
            const container = document.getElementById('interest-cards');
            if (!container) return;

            const typeLabels = { fun: 'Fun Project', business: 'Business', claude: "Claude's Choice" };
            const typeClasses = { fun: 'fun-project', business: 'business-feature', claude: 'claude-choice' };

            container.innerHTML = ['fun_project', 'business_feature', 'claude_choice'].map(key => {
                const s = interestSuggestions[key];
                if (!s) return '';
                const typeKey = s.interestType;
                return `
                    <div class="interest-card ${typeClasses[typeKey]}" data-suggestion-id="${s.id}" data-interest-type="${typeKey}" onclick="startInterestTask('${key}')">
                        <button class="interest-dismiss-btn" onclick="event.stopPropagation(); dismissInterestSuggestion('${s.id}', '${typeKey}', '${key}')" title="Not interested">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                        <div class="interest-card-header">
                            <span class="interest-type-badge">${typeLabels[typeKey]}</span>
                        </div>
                        <div class="interest-card-title">${escapeHtml(s.title)}</div>
                        <div class="interest-card-desc">${escapeHtml(s.description)}</div>
                        <div class="interest-card-reason">${escapeHtml(s.reason || '')}</div>
                    </div>
                `;
            }).join('');
        }

        async function dismissInterestSuggestion(suggestionId, interestType, suggestionKey) {
            const card = document.querySelector(`[data-suggestion-id="${suggestionId}"]`);
            if (!card) return;

            // Animate out
            card.style.transform = 'scale(0.9)';
            card.style.opacity = '0.5';

            try {
                const suggestion = interestSuggestions[suggestionKey];
                const response = await fetch(`${API_URL}/suggestions/dismiss`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        suggestion_id: suggestionId,
                        category: suggestion?.type || '',
                        title: suggestion?.title || '',
                        interest_type: interestType,
                        regenerate: true
                    })
                });
                const data = await response.json();

                if (data.replacement) {
                    // Update the suggestion
                    interestSuggestions[suggestionKey] = data.replacement;
                    renderInterestSuggestions();

                    // Animate in the new card
                    const newCard = document.querySelector(`[data-suggestion-id="${data.replacement.id}"]`);
                    if (newCard) {
                        newCard.style.transform = 'scale(0.9)';
                        newCard.style.opacity = '0';
                        setTimeout(() => {
                            newCard.style.transition = 'all 0.3s ease';
                            newCard.style.transform = 'scale(1)';
                            newCard.style.opacity = '1';
                        }, 50);
                    }
                }
            } catch (error) {
                console.error('Failed to dismiss suggestion:', error);
                card.style.transform = '';
                card.style.opacity = '1';
            }
        }

        function startInterestTask(suggestionKey) {
            const suggestion = interestSuggestions[suggestionKey];
            if (!suggestion) return;

            // Open the task wizard with this suggestion instead of starting chat directly
            openInterestWizard(suggestion);
        }

        function openInterestWizard(suggestion) {
            // Set the current wizard suggestion
            currentWizardSuggestion = suggestion;

            // Reset to single agent mode
            wizardMode = 'single';
            document.getElementById('mode-single').classList.add('active');
            document.getElementById('mode-orchestrator').classList.remove('active');
            document.getElementById('single-agent-config').classList.remove('hidden');
            document.getElementById('orchestrator-config').classList.remove('active');
            document.getElementById('wizard-launch-btn').innerHTML = ' Launch Agent';

            // Reset orchestrator settings to defaults
            wizardWorkflowType = 'standard';
            wizardTeamMembers = ['researcher', 'coder'];
            document.querySelectorAll('.workflow-type-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.type === 'standard');
            });
            document.querySelectorAll('.team-member-card').forEach(card => {
                const agent = card.dataset.agent;
                card.classList.toggle('selected', agent === 'researcher' || agent === 'coder');
            });

            // Analyze the task to determine recommended agent and metrics
            const analysis = analyzeTask(suggestion);
            selectedWizardAgent = analysis.recommendedAgent;

            // Populate wizard content
            document.getElementById('wizard-title').textContent = suggestion.title;

            // Add context based on interest type
            const typeLabels = {
                'fun': ' Fun Project',
                'business': ' Business Feature',
                'claude': ' Claude\'s Suggestion'
            };
            const typeLabel = typeLabels[suggestion.interestType] || 'Suggested Task';
            document.getElementById('wizard-subtitle').textContent = typeLabel + ' - Review before launching';

            document.getElementById('wizard-task-description').textContent = suggestion.action || suggestion.description;

            // Set icon based on suggestion type or interest type
            const iconMap = {
                'star': '', 'rocket': '', 'brain': '', 'folder': '',
                'code': '', 'robot': '', 'search': '', 'chat': '', 'default': ''
            };
            document.getElementById('wizard-icon').textContent = iconMap[suggestion.icon] || iconMap['default'];

            // Populate analytics
            document.getElementById('wizard-duration').textContent = analysis.estimatedDuration;
            document.getElementById('wizard-confidence').textContent = Math.round((suggestion.confidence || 0.85) * 100) + '%';
            document.getElementById('wizard-tools').textContent = analysis.toolsNeeded;
            document.getElementById('wizard-complexity').textContent = analysis.complexity;

            // Update recommended agent display
            updateWizardAgentDisplay(analysis.recommendedAgent, analysis.agentReason);

            // Update steps based on agent type
            updateWizardSteps(analysis.recommendedAgent);

            // Update tools list
            updateWizardTools(analysis.recommendedAgent);

            // Highlight selected agent override button
            document.querySelectorAll('.override-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.type === analysis.recommendedAgent);
            });

            // Show orchestrator suggestion hint if applicable
            const orchestratorBtn = document.getElementById('mode-orchestrator');
            if (analysis.suggestOrchestrator) {
                orchestratorBtn.innerHTML = `
                    <span class="mode-btn-icon"></span>
                    <span>Mother Agent</span>
                    <span class="mode-hint"></span>
                `;
                orchestratorBtn.title = analysis.orchestratorReason;
            } else {
                orchestratorBtn.innerHTML = `
                    <span class="mode-btn-icon"></span>
                    <span>Mother Agent</span>
                `;
                orchestratorBtn.title = '';
            }

            // Show modal
            document.body.classList.add('modal-open');
            document.getElementById('task-wizard-modal').classList.add('active');
        }

        async function refreshInterestSuggestions() {
            const btn = document.querySelector('.refresh-interests-btn');
            const container = document.getElementById('interest-cards');

            // Show loading state
            if (btn) {
                btn.style.animation = 'spin 1s linear infinite';
                btn.disabled = true;
            }

            // Show generating message
            if (container) {
                container.innerHTML = `
                    <div class="generating-suggestions" style="grid-column: 1 / -1; text-align: center; padding: 30px; color: var(--text-muted);">
                        <div class="spinner" style="margin: 0 auto 12px;"></div>
                        <span>Claude is generating personalized suggestions...</span>
                    </div>
                `;
            }

            try {
                // Call the refresh endpoint which forces Claude to regenerate
                const response = await fetch(`${API_URL}/suggestions/interests/refresh`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.suggestions) {
                        interestSuggestions = data.suggestions;
                        renderInterestSuggestions();
                        showToast('Fresh suggestions generated!', 'success');
                    }
                } else {
                    throw new Error('Failed to refresh');
                }
            } catch (error) {
                console.error('Refresh failed:', error);
                showToast('Failed to generate new suggestions', 'error');
                // Fall back to loading cached
                await loadInterestSuggestions();
            }

            // Reset button
            if (btn) {
                btn.style.animation = '';
                btn.disabled = false;
            }
        }

        // ==================== SMART SUMMARY CARD ====================
        let smartSummaryData = { activeWork: null, agentsToReview: [] };

        async function loadSmartSuggestions() {
            // This now loads the Smart Summary Card data
            await loadSmartSummary();
        }

        async function loadSmartSummary() {
            try {
                // Fetch active work and agents in parallel
                const [suggestionsRes, agentsRes] = await Promise.all([
                    fetch(`${API_URL}/suggestions`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${API_URL}/agents`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                const suggestionsData = await suggestionsRes.json();
                const agentsData = await agentsRes.json();

                // Extract active work from suggestions
                const suggestions = suggestionsData.suggestions || [];
                const activeWorkSuggestion = suggestions.find(s => s.type === 'active_project');

                // Get agents that need review (completed in last 24h)
                const now = Date.now();
                const agentsToReview = (agentsData.agents || [])
                    .filter(a => a.status === 'completed')
                    .filter(a => {
                        const completedAt = new Date(a.completed_at || a.created_at).getTime();
                        return (now - completedAt) < 24 * 60 * 60 * 1000; // Last 24 hours
                    })
                    .slice(0, 3); // Max 3

                smartSummaryData = {
                    activeWork: activeWorkSuggestion ? {
                        project: activeWorkSuggestion.title.replace('Continue: ', ''),
                        nextAction: activeWorkSuggestion.description,
                        phase: activeWorkSuggestion.phase,
                        action: activeWorkSuggestion.action
                    } : null,
                    agentsToReview: agentsToReview
                };

                renderSmartSummary();
            } catch (error) {
                console.error('Failed to load smart summary:', error);
                smartSummaryData = { activeWork: null, agentsToReview: [] };
                renderSmartSummary();
            }
        }

        function renderSmartSummary() {
            const { activeWork, agentsToReview } = smartSummaryData;
            const hasActiveWork = !!activeWork;
            const hasAgents = agentsToReview.length > 0;

            // Update subtitle
            const subtitle = document.getElementById('summary-subtitle');
            if (subtitle) {
                if (hasActiveWork && hasAgents) {
                    subtitle.textContent = `Active project + ${agentsToReview.length} agent${agentsToReview.length > 1 ? 's' : ''} to review`;
                } else if (hasActiveWork) {
                    subtitle.textContent = 'You have an active project';
                } else if (hasAgents) {
                    subtitle.textContent = `${agentsToReview.length} agent${agentsToReview.length > 1 ? 's' : ''} to review`;
                } else {
                    subtitle.textContent = 'Ready to help you get started';
                }
            }

            // Update badges
            const badgesContainer = document.getElementById('summary-badges');
            if (badgesContainer) {
                badgesContainer.textContent = '';
                const addBadge = (cls, text) => {
                    const span = document.createElement('span');
                    span.className = 'summary-badge ' + cls;
                    span.textContent = text;
                    badgesContainer.appendChild(span);
                };
                if (hasActiveWork) addBadge('active', 'Active');
                if (hasAgents) addBadge('agents', agentsToReview.length.toString());
                if (!hasActiveWork && !hasAgents) addBadge('empty', 'Clear');
            }

            // Update active work section
            const activeWorkSection = document.getElementById('active-work-section');
            const activeWorkSummary = document.getElementById('active-work-summary');
            if (activeWorkSection && activeWorkSummary) {
                if (hasActiveWork) {
                    activeWorkSection.style.display = 'block';
                    activeWorkSummary.textContent = '';
                    const projDiv = document.createElement('div');
                    projDiv.className = 'active-work-project';
                    projDiv.textContent = activeWork.project;
                    activeWorkSummary.appendChild(projDiv);
                    const nextDiv = document.createElement('div');
                    nextDiv.className = 'active-work-next';
                    nextDiv.textContent = activeWork.nextAction;
                    activeWorkSummary.appendChild(nextDiv);
                    if (activeWork.phase) {
                        const phaseDiv = document.createElement('div');
                        phaseDiv.className = 'active-work-phase';
                        phaseDiv.textContent = activeWork.phase;
                        activeWorkSummary.appendChild(phaseDiv);
                    }
                } else {
                    activeWorkSection.style.display = 'none';
                }
            }

            // Update agents section
            const agentsSection = document.getElementById('agents-review-section');
            const agentsList = document.getElementById('agents-review-list');
            if (agentsSection && agentsList) {
                if (hasAgents) {
                    agentsSection.style.display = 'block';
                    agentsList.textContent = '';
                    agentsToReview.forEach(agent => {
                        const item = document.createElement('div');
                        item.className = 'agent-review-item';
                        item.onclick = () => viewAgent(agent.id);
                        const info = document.createElement('div');
                        info.className = 'agent-review-info';
                        const dot = document.createElement('div');
                        dot.className = 'agent-review-status completed';
                        const name = document.createElement('span');
                        name.className = 'agent-review-name';
                        name.textContent = 'Agent #' + agent.id.slice(0, 8);
                        info.appendChild(dot);
                        info.appendChild(name);
                        const action = document.createElement('span');
                        action.className = 'agent-review-action';
                        action.textContent = 'View Results';
                        item.appendChild(info);
                        item.appendChild(action);
                        agentsList.appendChild(item);
                    });
                } else {
                    agentsSection.style.display = 'none';
                }
            }

            // Show/hide no items message
            const noItemsMessage = document.getElementById('no-items-message');
            if (noItemsMessage) noItemsMessage.style.display = (!hasActiveWork && !hasAgents) ? 'block' : 'none';
        }

        function toggleSmartSummary() {
            const card = document.getElementById('smart-summary-card');
            card.classList.toggle('expanded');
        }

        function continueActiveWork() {
            if (smartSummaryData.activeWork && smartSummaryData.activeWork.action) {
                startChat(smartSummaryData.activeWork.action);
            } else if (smartSummaryData.activeWork) {
                startChat(`Let's continue working on ${smartSummaryData.activeWork.project}. ${smartSummaryData.activeWork.nextAction}`);
            }
        }

        function askWhatToWorkOn() {
            startChat("Based on my memory, goals, and recent work - what should I focus on right now? Give me 2-3 specific, actionable suggestions with concrete next steps.");
        }

        function viewAgent(agentId) {
            // Switch to agents view and highlight the agent
            switchView('agents');
            setTimeout(() => {
                const agentCard = document.querySelector(`[data-agent-id="${agentId}"]`);
                if (agentCard) {
                    agentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    agentCard.style.animation = 'pulse 0.5s ease-in-out 2';
                }
            }, 300);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, "\\'");
        }

        // ==================== TASK WIZARD ====================
        let currentWizardSuggestion = null;
        let selectedWizardAgent = 'researcher';

        function openTaskWizard(suggestionIndex) {
            const suggestions = window.currentSuggestions;
            if (!suggestions || !suggestions[suggestionIndex]) return;

            const suggestion = suggestions[suggestionIndex];
            currentWizardSuggestion = suggestion;

            // Reset to single agent mode
            wizardMode = 'single';
            document.getElementById('mode-single').classList.add('active');
            document.getElementById('mode-orchestrator').classList.remove('active');
            document.getElementById('single-agent-config').classList.remove('hidden');
            document.getElementById('orchestrator-config').classList.remove('active');
            document.getElementById('wizard-launch-btn').innerHTML = ' Launch Agent';

            // Reset orchestrator settings to defaults
            wizardWorkflowType = 'standard';
            wizardTeamMembers = ['researcher', 'coder'];
            document.querySelectorAll('.workflow-type-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.type === 'standard');
            });
            document.querySelectorAll('.team-member-card').forEach(card => {
                const agent = card.dataset.agent;
                card.classList.toggle('selected', agent === 'researcher' || agent === 'coder');
            });

            // Analyze the task to determine recommended agent and metrics
            const analysis = analyzeTask(suggestion);
            selectedWizardAgent = analysis.recommendedAgent;

            // Populate wizard content
            document.getElementById('wizard-title').textContent = suggestion.title;
            document.getElementById('wizard-subtitle').textContent = 'Review task details before launching';
            document.getElementById('wizard-task-description').textContent = suggestion.action || suggestion.description;

            // Set icon based on suggestion type
            const iconMap = {
                'rocket': '', 'folder': '', 'brain': '', 'code': '',
                'robot': '', 'search': '', 'chat': '', 'default': ''
            };
            document.getElementById('wizard-icon').textContent = iconMap[suggestion.icon] || iconMap['default'];

            // Populate analytics
            document.getElementById('wizard-duration').textContent = analysis.estimatedDuration;
            document.getElementById('wizard-confidence').textContent = Math.round(suggestion.confidence * 100) + '%';
            document.getElementById('wizard-tools').textContent = analysis.toolsNeeded;
            document.getElementById('wizard-complexity').textContent = analysis.complexity;

            // Update recommended agent display
            updateWizardAgentDisplay(analysis.recommendedAgent, analysis.agentReason);

            // Update steps based on agent type
            updateWizardSteps(analysis.recommendedAgent);

            // Update tools list
            updateWizardTools(analysis.recommendedAgent);

            // Highlight selected agent override button
            document.querySelectorAll('.override-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.type === analysis.recommendedAgent);
            });

            // Show orchestrator suggestion hint if applicable
            const orchestratorBtn = document.getElementById('mode-orchestrator');
            if (analysis.suggestOrchestrator) {
                orchestratorBtn.innerHTML = `
                    <span class="mode-btn-icon"></span>
                    <span>Mother Agent</span>
                    <span class="mode-hint"></span>
                `;
                orchestratorBtn.title = analysis.orchestratorReason;
            } else {
                orchestratorBtn.innerHTML = `
                    <span class="mode-btn-icon"></span>
                    <span>Mother Agent</span>
                `;
                orchestratorBtn.title = '';
            }

            // Show modal
            document.body.classList.add('modal-open');
            document.getElementById('task-wizard-modal').classList.add('active');
        }

        function closeTaskWizard() {
            document.body.classList.remove('modal-open');
            document.getElementById('task-wizard-modal').classList.remove('active');
            currentWizardSuggestion = null;
        }

        function analyzeTask(suggestion) {
            const text = (suggestion.action || suggestion.description || '').toLowerCase();
            const title = (suggestion.title || '').toLowerCase();

            // Determine recommended agent based on keywords
            let recommendedAgent = 'worker';
            let agentReason = 'General task execution';

            if (text.includes('research') || text.includes('find') || text.includes('search') ||
                text.includes('investigate') || text.includes('analyze') || title.includes('review')) {
                recommendedAgent = 'researcher';
                agentReason = 'Task involves investigation and information gathering';
            } else if (text.includes('code') || text.includes('implement') || text.includes('fix') ||
                       text.includes('write') || text.includes('create') || text.includes('build') ||
                       title.includes('ui') || title.includes('feature')) {
                recommendedAgent = 'coder';
                agentReason = 'Task requires writing or modifying code';
            } else if (text.includes('analyze') || text.includes('report') || text.includes('metrics') ||
                       text.includes('data') || text.includes('statistics')) {
                recommendedAgent = 'analyst';
                agentReason = 'Task requires data analysis and insights';
            } else if (text.includes('continue') || text.includes('follow up') || title.includes('agent')) {
                recommendedAgent = 'worker';
                agentReason = 'Follow-up task for efficient execution';
            }

            // Estimate duration based on complexity
            let estimatedDuration = '~3-5 min';
            let complexity = 'Medium';
            let toolsNeeded = 4;

            if (text.length > 200 || text.includes('comprehensive') || text.includes('detailed')) {
                estimatedDuration = '~10-15 min';
                complexity = 'High';
                toolsNeeded = 6;
            } else if (text.length < 50) {
                estimatedDuration = '~1-2 min';
                complexity = 'Low';
                toolsNeeded = 2;
            }

            // Adjust based on confidence
            if (suggestion.confidence < 0.7) {
                estimatedDuration = '~5-10 min';
                complexity = 'Medium-High';
            }

            // Detect if task might benefit from orchestrator mode
            let suggestOrchestrator = false;
            let orchestratorReason = '';

            const orchestratorKeywords = ['comprehensive', 'full', 'complete', 'entire', 'all aspects',
                'multiple', 'various', 'end-to-end', 'full stack', 'research and implement',
                'analyze and build', 'investigate and fix', 'plan and execute'];

            for (const keyword of orchestratorKeywords) {
                if (text.includes(keyword) || title.includes(keyword)) {
                    suggestOrchestrator = true;
                    orchestratorReason = `Task mentions "${keyword}" - may benefit from multiple specialized agents`;
                    break;
                }
            }

            // Also suggest for very complex/long tasks
            if (text.length > 300 || complexity === 'High') {
                suggestOrchestrator = true;
                orchestratorReason = orchestratorReason || 'Complex task may benefit from team coordination';
            }

            return {
                recommendedAgent,
                agentReason,
                estimatedDuration,
                complexity,
                toolsNeeded,
                suggestOrchestrator,
                orchestratorReason
            };
        }

        function updateWizardAgentDisplay(agentType, reason) {
            const agentInfo = {
                'worker': { icon: '', name: 'Worker', desc: 'Fast task execution with minimal overhead' },
                'researcher': { icon: '', name: 'Researcher', desc: 'Deep investigation and thorough analysis' },
                'coder': { icon: '', name: 'Coder', desc: 'Expert code writing and modification' },
                'analyst': { icon: '', name: 'Analyst', desc: 'Data analysis and strategic insights' }
            };

            const info = agentInfo[agentType] || agentInfo.worker;

            document.getElementById('rec-agent-display').innerHTML = `
                <div class="rec-agent-icon">${info.icon}</div>
                <div class="rec-agent-info">
                    <div class="rec-agent-name">${info.name}</div>
                    <div class="rec-agent-reason">${reason}</div>
                </div>
                <div class="rec-agent-badge">Recommended</div>
            `;
        }

        function selectWizardAgent(agentType) {
            selectedWizardAgent = agentType;

            // Update button states
            document.querySelectorAll('.override-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.type === agentType);
            });

            // Update the recommendation display
            const reasons = {
                'worker': 'You selected Worker for efficient task execution',
                'researcher': 'You selected Researcher for thorough investigation',
                'coder': 'You selected Coder for code-related work',
                'analyst': 'You selected Analyst for data analysis'
            };

            updateWizardAgentDisplay(agentType, reasons[agentType]);
            updateWizardSteps(agentType);
            updateWizardTools(agentType);
        }

        function updateWizardSteps(agentType) {
            const stepsMap = {
                'worker': [
                    { title: 'Parse Request', desc: 'Understand the task requirements' },
                    { title: 'Execute Actions', desc: 'Run commands and make changes directly' },
                    { title: 'Verify Results', desc: 'Confirm the task was completed' },
                    { title: 'Report Output', desc: 'Deliver concise results' }
                ],
                'researcher': [
                    { title: 'Analyze Request', desc: 'Break down research objectives' },
                    { title: 'Gather Information', desc: 'Search files, docs, and web resources' },
                    { title: 'Verify & Cross-Reference', desc: 'Validate findings from multiple sources' },
                    { title: 'Synthesize Report', desc: 'Compile comprehensive findings' }
                ],
                'coder': [
                    { title: 'Understand Codebase', desc: 'Read existing code and patterns' },
                    { title: 'Plan Implementation', desc: 'Design the solution approach' },
                    { title: 'Write/Modify Code', desc: 'Implement changes with precision' },
                    { title: 'Verify Changes', desc: 'Ensure code works as expected' }
                ],
                'analyst': [
                    { title: 'Define Metrics', desc: 'Identify what to measure and analyze' },
                    { title: 'Collect Data', desc: 'Gather relevant information and stats' },
                    { title: 'Analyze Patterns', desc: 'Find trends and correlations' },
                    { title: 'Generate Insights', desc: 'Produce actionable recommendations' }
                ]
            };

            const steps = stepsMap[agentType] || stepsMap.worker;

            document.getElementById('wizard-steps').innerHTML = steps.map((step, i) => `
                <div class="wizard-step">
                    <div class="step-number">${i + 1}</div>
                    <div class="step-content">
                        <div class="step-title">${step.title}</div>
                        <div class="step-desc">${step.desc}</div>
                    </div>
                </div>
            `).join('');
        }

        function updateWizardTools(agentType) {
            const toolsMap = {
                'worker': [' Read', ' Edit', ' Bash', ' Write'],
                'researcher': [' Read', ' Grep', ' Glob', ' WebSearch', ' WebFetch'],
                'coder': [' Read', ' Edit', ' Write', ' Grep', ' Bash', ' Glob'],
                'analyst': [' Read', ' Grep', ' Glob', ' Bash', ' Data Analysis']
            };

            const tools = toolsMap[agentType] || toolsMap.worker;

            document.getElementById('wizard-tools-list').innerHTML = tools.map(tool => `
                <div class="wizard-tool">${tool}</div>
            `).join('');
        }

        function launchWizardChat() {
            if (!currentWizardSuggestion) return;

            const task = currentWizardSuggestion.action || currentWizardSuggestion.description;
            closeTaskWizard();
            startChat(task);
        }

        // ==================== ORCHESTRATOR MODE ====================
        let wizardMode = 'single';  // 'single' or 'orchestrator'
        let wizardWorkflowType = 'standard';
        let wizardTeamMembers = ['researcher', 'coder'];

        function setWizardMode(mode) {
            wizardMode = mode;

            // Update toggle buttons
            document.getElementById('mode-single').classList.toggle('active', mode === 'single');
            document.getElementById('mode-orchestrator').classList.toggle('active', mode === 'orchestrator');

            // Show/hide config sections
            document.getElementById('single-agent-config').classList.toggle('hidden', mode !== 'single');
            document.getElementById('orchestrator-config').classList.toggle('active', mode === 'orchestrator');

            // Update launch button text
            const launchBtn = document.getElementById('wizard-launch-btn');
            if (mode === 'orchestrator') {
                launchBtn.innerHTML = ' Launch Workflow';
            } else {
                launchBtn.innerHTML = ' Launch Agent';
            }

            // Update analytics for orchestrator mode
            if (mode === 'orchestrator') {
                updateOrchestratorAnalytics();
                updateWizardStepsForOrchestrator();
                updateWizardToolsForOrchestrator();
                updateWorkflowPreview();
            } else {
                // Restore single agent analytics
                const analysis = analyzeTask(currentWizardSuggestion);
                document.getElementById('wizard-duration').textContent = analysis.estimatedDuration;
                document.getElementById('wizard-confidence').textContent = Math.round(currentWizardSuggestion.confidence * 100) + '%';
                document.getElementById('wizard-tools').textContent = analysis.toolsNeeded;
                document.getElementById('wizard-complexity').textContent = analysis.complexity;
                updateWizardSteps(selectedWizardAgent);
                updateWizardTools(selectedWizardAgent);
            }
        }

        function selectWizardWorkflowType(type) {
            wizardWorkflowType = type;

            // Update cards
            document.querySelectorAll('.workflow-type-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.type === type);
            });

            // Update preview animation style
            updateWorkflowPreview();
            updateOrchestratorAnalytics();
            updateWizardStepsForOrchestrator();
        }

        function toggleTeamMember(agent) {
            const card = document.querySelector(`.team-member-card[data-agent="${agent}"]`);
            const isSelected = card.classList.contains('selected');

            // Ensure at least one member is selected
            if (isSelected && wizardTeamMembers.length <= 1) {
                return; // Can't deselect the last member
            }

            card.classList.toggle('selected');

            if (isSelected) {
                wizardTeamMembers = wizardTeamMembers.filter(m => m !== agent);
            } else {
                wizardTeamMembers.push(agent);
            }

            // Update workflow preview
            updateWorkflowPreview();
            updateOrchestratorAnalytics();
        }

        function updateWorkflowPreview() {
            const childrenContainer = document.getElementById('workflow-children');
            const agentIcons = {
                'researcher': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
                'coder': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
                'worker': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
                'analyst': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>'
            };
            const agentNames = {
                'researcher': 'Researcher',
                'coder': 'Coder',
                'worker': 'Worker',
                'analyst': 'Analyst'
            };

            // Determine animation class based on workflow type
            const animClass = wizardWorkflowType === 'parallel' ? 'parallel' :
                              wizardWorkflowType === 'sequential' ? 'sequential' : '';

            childrenContainer.innerHTML = wizardTeamMembers.map((agent, idx) => `
                <div class="workflow-child ${animClass} ${wizardWorkflowType === 'sequential' && idx === 0 ? 'active' : ''}">
                    <span class="child-icon">${agentIcons[agent]}</span>
                    <span class="child-name">${agentNames[agent]}</span>
                </div>
            `).join('');

            // Update connector arrows to match team size
            const arrowsContainer = document.querySelector('.connector-arrows');
            if (arrowsContainer) {
                const arrows = wizardTeamMembers.map(() => '<span class="connector-arrow"></span>').join('');
                arrowsContainer.innerHTML = arrows;
            }
        }

        function updateOrchestratorAnalytics() {
            // Orchestrator mode takes longer but has higher success with complex tasks
            const baseTime = wizardTeamMembers.length * 3;
            const typeMultiplier = wizardWorkflowType === 'parallel' ? 0.7 :
                                   wizardWorkflowType === 'sequential' ? 1.3 : 1;
            const estimatedMin = Math.round(baseTime * typeMultiplier);

            document.getElementById('wizard-duration').textContent = `~${estimatedMin}-${estimatedMin + 5} min`;
            document.getElementById('wizard-confidence').textContent = Math.min(95, 75 + wizardTeamMembers.length * 5) + '%';
            document.getElementById('wizard-tools').textContent = wizardTeamMembers.length + 1;
            document.getElementById('wizard-complexity').textContent = wizardTeamMembers.length >= 3 ? 'High' : 'Medium';
        }

        function updateWizardStepsForOrchestrator() {
            const workflowSteps = {
                'standard': [
                    { title: 'Mission Analysis', desc: 'Orchestrator decomposes the task into subtasks' },
                    { title: 'Team Delegation', desc: 'Assigns subtasks to appropriate agents' },
                    { title: 'Parallel Execution', desc: 'Agents work on their assigned subtasks' },
                    { title: 'Progress Monitoring', desc: 'Orchestrator tracks and adapts as needed' },
                    { title: 'Synthesis', desc: 'Results compiled into comprehensive output' }
                ],
                'parallel': [
                    { title: 'Mission Briefing', desc: 'All agents receive their assignments' },
                    { title: 'Simultaneous Execution', desc: 'Agents work in parallel on subtasks' },
                    { title: 'Result Collection', desc: 'Orchestrator gathers all outputs' },
                    { title: 'Final Synthesis', desc: 'Combine results into unified deliverable' }
                ],
                'sequential': [
                    { title: 'First Agent Start', desc: 'Initial agent begins the task' },
                    { title: 'Handoff Protocol', desc: 'Context passed to next agent in chain' },
                    { title: 'Progressive Build', desc: 'Each agent adds to the previous work' },
                    { title: 'Final Review', desc: 'Orchestrator validates complete result' }
                ]
            };

            const steps = workflowSteps[wizardWorkflowType] || workflowSteps.standard;

            document.getElementById('wizard-steps').innerHTML = steps.map((step, i) => `
                <div class="wizard-step">
                    <div class="step-number">${i + 1}</div>
                    <div class="step-content">
                        <div class="step-title">${step.title}</div>
                        <div class="step-desc">${step.desc}</div>
                    </div>
                </div>
            `).join('');
        }

        function updateWizardToolsForOrchestrator() {
            // Orchestrator has access to all tools plus agent spawning
            const tools = ['Read', 'Edit', 'Grep', 'Glob', 'Bash', 'WebSearch', 'Agent Spawn'];

            document.getElementById('wizard-tools-list').innerHTML = tools.map(tool => `
                <div class="wizard-tool">${tool}</div>
            `).join('');
        }

        async function launchWizardWorkflow() {
            if (!currentWizardSuggestion) return;

            const task = currentWizardSuggestion.action || currentWizardSuggestion.description;

            try {
                const response = await fetch(`${API_URL}/workflows`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        task: task,
                        workflow_type: wizardWorkflowType,
                        agent_composition: wizardTeamMembers
                    })
                });

                if (!response.ok) throw new Error('Failed to spawn workflow');

                const data = await response.json();
                console.log('Workflow spawned:', data);

                closeTaskWizard();

                // Switch to agents view to show the workflow
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelector('.nav-item[data-view="agents"]').classList.add('active');
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById('view-agents').classList.add('active');

                // Refresh agents list
                await loadAgents();

            } catch (e) {
                console.error('Error spawning workflow:', e);
                alert('Failed to launch workflow: ' + e.message);
            }
        }

        // Override the launch button behavior based on mode
        function launchWizardAgent() {
            if (wizardMode === 'orchestrator') {
                launchWizardWorkflow();
            } else {
                if (!currentWizardSuggestion) return;
                const task = currentWizardSuggestion.action || currentWizardSuggestion.description;
                closeTaskWizard();
                spawnAgentEnhanced(task, selectedWizardAgent, null, null, 'normal', null);
            }
        }

        // Legacy function - now just refreshes smart summary
        async function refreshSuggestions() {
            await loadSmartSummary();
        }

        function updateDateTime() {
            const now = new Date();
            const hour = now.getHours();

            // Dynamic greetings based on time
            let greeting = 'Good evening';
            let statusMessage = 'Winding down with you';
            if (hour < 6) {
                greeting = 'Burning the midnight oil';
                statusMessage = 'Night owl mode activated';
            } else if (hour < 12) {
                greeting = 'Good morning';
                statusMessage = 'Fresh and ready to go';
            } else if (hour < 17) {
                greeting = 'Good afternoon';
                statusMessage = 'In the zone with you';
            } else if (hour < 21) {
                greeting = 'Good evening';
                statusMessage = 'Evening productivity mode';
            }

            // Update presence greeting
            const presenceGreeting = document.getElementById('presence-greeting');
            if (presenceGreeting) {
                presenceGreeting.textContent = `${greeting}, ${CEREBRO_USERNAME}`;
            }

            // Update status text if not overridden by agents
            const activeCount = Object.values(agents).filter(a => a.status === 'running').length;
            const statusText = document.getElementById('cerebro-status-text');
            if (statusText && activeCount === 0) {
                statusText.textContent = statusMessage;
            }

            // Legacy support
            const legacyGreeting = document.getElementById('greeting');
            if (legacyGreeting) {
                legacyGreeting.textContent = `${greeting}, ${CEREBRO_USERNAME}`;
            }
            const legacyDate = document.getElementById('current-date');
            if (legacyDate) {
                legacyDate.textContent = now.toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric'
                });
            }

            // Hero bar datetime
            const heroDate = document.getElementById('hero-datetime');
            if (heroDate) {
                heroDate.textContent = now.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                }) + ' ' + now.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit'
                });
            }
        }

        // ==================== CEREBRO PRESENCE SYSTEM ====================

        // Thought bubbles - contextual messages
        const thoughtBubbles = [
            "I've been keeping track of everything. Your memory bank is growing nicely.",
            "Need help debugging something? I'm always ready to dive in.",
            "I noticed some interesting patterns in your recent work. Want me to analyze them?",
            "The DGX is humming along. Ready to spin up some agents whenever you are.",
            "Your AI Memory system is holding 306+ conversations. That's a lot of wisdom stored!",
            "Multi-agent workflows are ready. Want to tackle something complex together?",
            "I'm always learning from our conversations. Thanks for teaching me.",
            "The NAS is healthy and there's plenty of room for more memories.",
            "Ready to research, code, analyze, or just chat. What's on your mind?",
            "Your emotion tracker shows you're focused. Perfect time for deep work!",
        ];

        let currentThoughtIndex = 0;

        function updateThoughtBubble() {
            const bubble = document.getElementById('thought-bubble');
            if (!bubble) return;

            // Rotate through thoughts
            currentThoughtIndex = (currentThoughtIndex + 1) % thoughtBubbles.length;

            // Fade out
            bubble.style.opacity = '0';
            bubble.style.transform = 'translateY(5px)';

            setTimeout(() => {
                bubble.textContent = thoughtBubbles[currentThoughtIndex];
                bubble.style.opacity = '1';
                bubble.style.transform = 'translateY(0)';
            }, 300);
        }

        // Update Cerebro's status based on activity
        function updateCerebroStatus() {
            const indicator = document.getElementById('cerebro-status-indicator');
            const statusText = document.getElementById('cerebro-status-text');
            const presenceCard = document.getElementById('cerebro-presence');
            const activeAgentsDisplay = document.getElementById('active-agents-count');

            if (!indicator || !statusText) return;

            const runningAgents = Object.values(agents).filter(a => a.status === 'running');
            const activeCount = runningAgents.length;

            // Update agent count
            if (activeAgentsDisplay) {
                activeAgentsDisplay.textContent = activeCount;
            }

            // Update presence card class
            if (presenceCard) {
                presenceCard.classList.toggle('active-agents', activeCount > 0);
            }

            // Update nav orb state to match
            const navOrb = document.getElementById('nav-orb-container');
            if (navOrb) {
                navOrb.classList.toggle('active-agents', activeCount > 0);
            }

            if (activeCount > 0) {
                indicator.className = 'status-indicator processing';
                statusText.textContent = `Running ${activeCount} agent${activeCount > 1 ? 's' : ''}...`;
            } else {
                indicator.className = 'status-indicator';
                // Will be updated by updateDateTime
            }
        }

        // Fetch and display mood from emotion tracker
        async function updateMoodIndicator() {
            const moodEmoji = document.getElementById('mood-emoji');
            const moodText = document.getElementById('mood-text');
            const moodIndicator = document.getElementById('mood-indicator');

            if (!moodEmoji || !moodText) return;

            try {
                // Try to read mood from local file or API
                const response = await fetch(`${API_URL}/api/mood`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                }).catch(() => null);

                if (response && response.ok) {
                    const mood = await response.json();
                    const moodMap = {
                        'happy': { text: 'You seem happy!' },
                        'sad': { text: 'Feeling down?' },
                        'angry': { text: 'Seems intense' },
                        'neutral': { text: 'You seem focused' },
                        'surprised': { text: 'Something surprising?' },
                        'fearful': { text: 'Everything okay?' },
                        'disgusted': { text: 'Not impressed, huh?' }
                    };

                    const emotion = mood.dominant_emotion || 'neutral';
                    const mapped = moodMap[emotion] || moodMap.neutral;

                    moodEmoji.textContent = '';
                    moodText.textContent = mapped.text;
                    moodIndicator.style.display = 'inline-flex';
                } else {
                    // Default state - no mood tracker running
                    moodEmoji.textContent = '';
                    moodText.textContent = "Let's get things done";
                }
            } catch (e) {
                // Mood tracker not available
                moodEmoji.textContent = '';
                moodText.textContent = "Ready when you are";
            }
        }

        // Update system health display
        async function updateSystemHealth() {
            const healthDisplay = document.getElementById('system-health');
            if (!healthDisplay) return;

            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    const data = await response.json();
                    const isHealthy = data.status === 'healthy';
                    healthDisplay.textContent = isHealthy ? '100%' : 'Degraded';
                    healthDisplay.style.color = isHealthy ? '#22c55e' : '#f59e0b';
                }
            } catch (e) {
                healthDisplay.textContent = '--';
            }
        }

        // Initialize presence card updates
        function initCerebroPresence() {
            // Initial updates
            updateDateTime();
            updateCerebroStatus();
            updateMoodIndicator();
            updateSystemHealth();

            // Rotate thought bubbles every 30 seconds
            setInterval(updateThoughtBubble, 30000);

            // Update mood every 60 seconds
            setInterval(updateMoodIndicator, 60000);

            // Update system health every 30 seconds
            setInterval(updateSystemHealth, 30000);
        }

        async function loadBriefing() {
            try {
                const response = await fetch(`${API_URL}/briefing`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load');

                const data = await response.json();

                // Update greeting from backend (has real username)
                if (data.greeting) {
                    const presenceGreeting = document.getElementById('presence-greeting');
                    if (presenceGreeting) presenceGreeting.textContent = data.greeting;
                    const legacyGreeting = document.getElementById('greeting');
                    if (legacyGreeting) legacyGreeting.textContent = data.greeting;
                }

                // Update memory count (total across conversations + facts + learnings)
                if (data.memory_stats) {
                    const total = (data.memory_stats.conversations || 0) + (data.memory_stats.facts || 0) + (data.memory_stats.learnings || 0);
                    document.getElementById('memory-count').textContent = total.toLocaleString();
                    document.getElementById('settings-memory-count').textContent = total.toLocaleString();
                }

                // Note: Active work is now shown in smart suggestions

            } catch (e) {
                console.error('Briefing error:', e);
            }
        }

        // ==================== SYSTEM STATUS ====================
        async function loadSystemStatus() {
            try {
                const response = await fetch(`${API_URL}/system-status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const data = await response.json();
                const grid = document.getElementById('system-status-grid');

                let html = '';
                for (const [key, service] of Object.entries(data.services || {})) {
                    const statusClass = service.status === 'online' ? 'online' : service.status === 'offline' ? 'offline' : 'unknown';
                    html += `
                        <div class="status-item">
                            <span class="status-dot ${statusClass}"></span>
                            <span class="status-name">${service.name}</span>
                        </div>
                    `;
                }

                grid.innerHTML = html || '<div class="status-item"><span class="status-dot unknown"></span><span class="status-name">No services</span></div>';

            } catch (e) {
                console.error('System status error:', e);
            }
        }

        // ==================== RECENT AGENTS ====================
        async function loadRecentAgents() {
            try {
                const response = await fetch(`${API_URL}/agents/history?limit=5`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const data = await response.json();
                const section = document.getElementById('recent-agents-section');
                const list = document.getElementById('recent-agents-list');

                if (data.agents && data.agents.length > 0) {
                    section.style.display = 'block';
                    list.innerHTML = data.agents.map(agent => `
                        <div class="recent-agent-item" onclick="viewAgentFromHistory('${agent.id}')">
                            <div class="recent-agent-info">
                                <div class="recent-agent-task">${escapeHtml(agent.task || 'Agent task')}</div>
                                <div class="recent-agent-meta">#${agent.id.slice(0,8)}  ${agent.tools_used?.length || 0} tools used</div>
                            </div>
                            <span class="recent-agent-status ${agent.status}">${agent.status?.toUpperCase() || 'DONE'}</span>
                        </div>
                    `).join('');
                } else {
                    section.style.display = 'none';
                }

            } catch (e) {
                console.error('Recent agents error:', e);
            }
        }

        async function viewAgentFromHistory(agentId) {
            try {
                const response = await fetch(`${API_URL}/agents/history/${agentId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const agent = await response.json();
                    agents[agentId] = agent;
                    openAgentDetailPage(agentId);
                }
            } catch (e) {
                console.error('Failed to load agent:', e);
            }
        }

        // ==================== MEMORY SEARCH ====================
        async function searchMemory() {
            const input = document.getElementById('memory-search-input');
            const query = input.value.trim();

            if (!query) return;

            const results = document.getElementById('search-results');
            results.style.display = 'block';
            results.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Searching...</div>';

            try {
                const response = await fetch(`${API_URL}/memory/search?q=${encodeURIComponent(query)}&limit=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Search failed');

                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    results.innerHTML = data.results.map(r => `
                        <div class="search-result-item" onclick="handleSearchResult('${r.type}', '${r.id}')">
                            <div class="search-result-type">${r.type}</div>
                            <div class="search-result-title">${escapeHtml(r.title)}</div>
                            <div class="search-result-snippet">${escapeHtml(r.snippet?.replace(/\\n/g, ' ') || '')}</div>
                        </div>
                    `).join('');
                } else {
                    results.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No results found</div>';
                }

            } catch (e) {
                results.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--red);">Search error</div>';
            }
        }

        function handleSearchResult(type, id) {
            // Navigate to chat and ask about this result
            startChat(`Tell me about ${type} "${id}" from my AI Memory`);
        }

        // ==================== QUICK COMMAND ====================
        function openQuickCommand() {
            document.body.classList.add('modal-open');
            document.getElementById('command-modal').classList.add('active');
            document.getElementById('command-input').focus();
        }

        function closeQuickCommand() {
            document.body.classList.remove('modal-open');
            document.getElementById('command-modal').classList.remove('active');
            document.getElementById('command-input').value = '';
        }

        async function runQuickCommand(command) {
            if (!command) return;

            closeQuickCommand();

            // Show feedback
            showToast(`Running: ${command}`);

            try {
                const response = await fetch(`${API_URL}/command?command=${encodeURIComponent(command)}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.error) {
                    showToast(`Error: ${data.error}`, 'error');
                } else {
                    showToast('Command executed', 'success');
                }

            } catch (e) {
                showToast('Command failed', 'error');
            }
        }

                // ==================== SECURITY ALERT FUNCTIONS ====================
        function showSecurityAlert(data) {
            // Remove any existing alert
            document.getElementById('security-alert-overlay')?.remove();

            const devices = data.devices || [];

            const overlay = document.createElement('div');
            overlay.id = 'security-alert-overlay';
            overlay.className = 'security-alert-overlay visible';

            const popup = document.createElement('div');
            popup.className = 'security-alert-popup';

            // Header
            const header = document.createElement('div');
            header.className = 'security-alert-header';
            const headerLeft = document.createElement('div');
            headerLeft.className = 'security-alert-header-left';
            const icon = document.createElement('div');
            icon.className = 'security-alert-icon';
            icon.textContent = '\u26A0';
            const label = document.createElement('div');
            label.className = 'security-alert-label';
            label.textContent = 'Network Security';
            headerLeft.appendChild(icon);
            headerLeft.appendChild(label);
            const severity = document.createElement('div');
            severity.className = 'security-alert-severity';
            severity.textContent = 'CRITICAL';
            const closeBtn = document.createElement('button');
            closeBtn.className = 'security-alert-close';
            closeBtn.textContent = '\u00D7';
            closeBtn.onclick = dismissSecurityAlert;
            header.appendChild(headerLeft);
            header.appendChild(severity);
            header.appendChild(closeBtn);

            // Body
            const body = document.createElement('div');
            body.className = 'security-alert-body';
            const title = document.createElement('div');
            title.className = 'security-alert-title';
            title.textContent = devices.length + ' Unknown Device' + (devices.length !== 1 ? 's' : '') + ' Detected on Network';
            body.appendChild(title);

            devices.forEach(d => {
                const card = document.createElement('div');
                card.className = 'security-alert-device';
                const ipLine = document.createElement('div');
                const ipLabel = document.createElement('strong');
                ipLabel.textContent = 'IP: ';
                ipLine.appendChild(ipLabel);
                ipLine.appendChild(document.createTextNode(d.ip || '?'));
                const macLine = document.createElement('div');
                const macLabel = document.createElement('strong');
                macLabel.textContent = 'MAC: ';
                macLine.appendChild(macLabel);
                macLine.appendChild(document.createTextNode(d.mac || '?'));
                const vendorLine = document.createElement('div');
                const vendorLabel = document.createElement('strong');
                vendorLabel.textContent = 'Vendor: ';
                vendorLine.appendChild(vendorLabel);
                vendorLine.appendChild(document.createTextNode(d.vendor || 'Unknown'));
                card.appendChild(ipLine);
                card.appendChild(macLine);
                card.appendChild(vendorLine);
                body.appendChild(card);
            });

            const timestamp = document.createElement('div');
            timestamp.className = 'security-alert-timestamp';
            timestamp.textContent = 'Detected: ' + new Date(data.timestamp || Date.now()).toLocaleString() + ' | Source: ' + (data.source || 'Darkhorse Network Monitor');
            body.appendChild(timestamp);

            // Actions
            const actions = document.createElement('div');
            actions.className = 'security-alert-actions';
            const dismissBtn = document.createElement('button');
            dismissBtn.className = 'security-alert-btn dismiss';
            dismissBtn.textContent = 'Dismiss';
            dismissBtn.onclick = dismissSecurityAlert;
            const investigateBtn = document.createElement('button');
            investigateBtn.className = 'security-alert-btn investigate';
            investigateBtn.textContent = 'Investigate';
            investigateBtn.onclick = investigateSecurityAlert;
            actions.appendChild(dismissBtn);
            actions.appendChild(investigateBtn);

            popup.appendChild(header);
            popup.appendChild(body);
            popup.appendChild(actions);
            overlay.appendChild(popup);
            document.body.appendChild(overlay);

            // Play alert sound
            playSecurityAlertSound();

            // Browser notification if permitted
            if (Notification.permission === 'granted') {
                new Notification('UNKNOWN DEVICE ON NETWORK', {
                    body: devices.map(d => d.ip + ' (' + d.mac + ')').join(', '),
                    tag: 'network-security',
                    requireInteraction: true
                });
            }
        }

        function dismissSecurityAlert() {
            const overlay = document.getElementById('security-alert-overlay');
            if (overlay) {
                const popup = overlay.querySelector('.security-alert-popup');
                if (popup) popup.classList.add('dismissing');
                setTimeout(() => overlay.remove(), 300);
            }
        }

        function investigateSecurityAlert() {
            dismissSecurityAlert();
            // Switch to Stored tab where the alert cards are
            const storedTab = document.querySelector('[onclick*="stored"], [data-tab="stored"]');
            if (storedTab) storedTab.click();
            else showToast('Check the Stored tab for alert details');
        }

        function playSecurityAlertSound() {
            // Three ascending beeps using Web Audio API
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                [0, 0.2, 0.4].forEach((delay, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = 800 + (i * 200);
                    osc.type = 'square';
                    gain.gain.value = 0.15;
                    osc.start(ctx.currentTime + delay);
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + 0.15);
                    osc.stop(ctx.currentTime + delay + 0.15);
                });
            } catch(e) {
                console.log('Could not play alert sound:', e);
            }
        }

        function showToast(message, type = 'info') {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'error' ? 'var(--red)' : type === 'success' ? 'var(--green)' : 'var(--accent)'};
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                font-size: 0.9rem;
                z-index: 9999;
                animation: fadeIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // ==================== HUMAN-IN-THE-LOOP AUTH ====================
        let pendingAuthSession = null;

        function showAuthModal(data) {
            pendingAuthSession = data.session_id;

            // Remove existing modal if any
            document.getElementById('auth-modal')?.remove();

            const modal = document.createElement('div');
            modal.id = 'auth-modal';
            modal.innerHTML = `
                <div class="auth-modal-backdrop"></div>
                <div class="auth-modal-content">
                    <div class="auth-modal-icon"></div>
                    <h3>Authentication Required</h3>
                    <p class="auth-reason">${data.reason || 'The browser needs you to log in or complete a CAPTCHA.'}</p>
                    <p class="auth-instruction">${data.message || 'Please complete the authentication in the browser window that opened.'}</p>
                    ${data.url ? `<p class="auth-url"><code>${data.url}</code></p>` : ''}
                    <div class="auth-buttons">
                        <button class="auth-done-btn" onclick="completeAuth()">
                             Done - I've authenticated
                        </button>
                        <button class="auth-cancel-btn" onclick="cancelAuth()">
                             Cancel
                        </button>
                    </div>
                    <p class="auth-hint">The skill will continue automatically after you authenticate.</p>
                </div>
            `;
            document.body.appendChild(modal);

            // Add styles if not already present
            if (!document.getElementById('auth-modal-styles')) {
                const styles = document.createElement('style');
                styles.id = 'auth-modal-styles';
                styles.textContent = `
                    #auth-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .auth-modal-backdrop {
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.7);
                    }
                    .auth-modal-content {
                        position: relative;
                        background: var(--panel-bg, #1a1a2e);
                        border-radius: 16px;
                        padding: 32px;
                        max-width: 450px;
                        text-align: center;
                        border: 2px solid var(--accent, #6366f1);
                        animation: modalSlideIn 0.3s ease;
                    }
                    @keyframes modalSlideIn {
                        from { transform: translateY(-20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    .auth-modal-icon {
                        font-size: 48px;
                        margin-bottom: 16px;
                    }
                    .auth-modal-content h3 {
                        color: var(--accent, #6366f1);
                        margin: 0 0 12px 0;
                        font-size: 1.4rem;
                    }
                    .auth-reason {
                        color: #f0f0f0;
                        margin: 0 0 8px 0;
                        font-size: 1rem;
                    }
                    .auth-instruction {
                        color: #a0a0a0;
                        margin: 0 0 16px 0;
                        font-size: 0.9rem;
                    }
                    .auth-url {
                        margin: 0 0 16px 0;
                    }
                    .auth-url code {
                        background: rgba(255,255,255,0.1);
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 0.8rem;
                        word-break: break-all;
                    }
                    .auth-buttons {
                        display: flex;
                        gap: 12px;
                        justify-content: center;
                        margin: 20px 0;
                    }
                    .auth-done-btn {
                        background: var(--green, #22c55e);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 1rem;
                        cursor: pointer;
                        font-weight: 600;
                        transition: transform 0.2s, background 0.2s;
                    }
                    .auth-done-btn:hover {
                        background: #16a34a;
                        transform: scale(1.02);
                    }
                    .auth-cancel-btn {
                        background: transparent;
                        color: #a0a0a0;
                        border: 1px solid #a0a0a0;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 1rem;
                        cursor: pointer;
                        transition: background 0.2s;
                    }
                    .auth-cancel-btn:hover {
                        background: rgba(255,255,255,0.1);
                    }
                    .auth-hint {
                        color: #707070;
                        font-size: 0.8rem;
                        margin: 0;
                    }
                `;
                document.head.appendChild(styles);
            }

            // Play notification sound if available
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleP//');
                audio.volume = 0.3;
                audio.play().catch(() => {});
            } catch(e) {}
        }

        function hideAuthModal() {
            document.getElementById('auth-modal')?.remove();
            pendingAuthSession = null;
        }

        async function completeAuth() {
            if (!pendingAuthSession) {
                hideAuthModal();
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/auth/continue/${pendingAuthSession}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showToast(' Authentication confirmed, continuing...', 'success');
                } else {
                    showToast('Failed to send continue signal', 'error');
                }
            } catch (e) {
                console.error('Error completing auth:', e);
                showToast('Error confirming authentication', 'error');
            }

            hideAuthModal();
        }

        async function cancelAuth() {
            if (!pendingAuthSession) {
                hideAuthModal();
                return;
            }

            try {
                await fetch(`${API_URL}/api/auth/cancel/${pendingAuthSession}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (e) {
                console.error('Error cancelling auth:', e);
            }

            hideAuthModal();
            showToast('Authentication cancelled', 'warning');
        }

        // Check for pending auth on page load
        async function checkPendingAuth() {
            try {
                const response = await fetch(`${API_URL}/api/auth/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.count > 0) {
                    // Show modal for the first pending auth
                    showAuthModal(data.pending[0]);
                }
            } catch (e) {
                console.error('Error checking pending auth:', e);
            }
        }

        // Check for pending auth after a brief delay
        setTimeout(checkPendingAuth, 2000);

        // ==================== SOCKET.IO ====================
        let mySocketId = null;

        function connectSocket() {
            socket = io(API_URL, { auth: { token } });

            socket.on('connect', () => {
                console.log('Socket connected');
                mySocketId = socket.id;
                document.getElementById('status-dot').classList.remove('offline');
                document.getElementById('status-text').textContent = 'Online';
                document.getElementById('connection-status').textContent = 'Connected';
                document.getElementById('connection-status').classList.add('success');
            });

            socket.on('disconnect', () => {
                console.log('Socket disconnected');
                document.getElementById('status-dot').classList.add('offline');
                document.getElementById('status-text').textContent = 'Offline';
                document.getElementById('connection-status').textContent = 'Disconnected';
                document.getElementById('connection-status').classList.remove('success');
            });

            // Handle chat responses (broadcast to all devices)
            socket.on('chat_response', handleChatResponse);

            // Handle device sync - show number of connected devices
            socket.on('device_sync', (data) => {
                console.log('Device sync:', data);
                const deviceCountEl = document.getElementById('device-count');
                if (deviceCountEl) {
                    deviceCountEl.textContent = data.devices || 1;
                }
            });

            // Handle cross-device chat sync - show messages from other devices
            socket.on('chat_sync', (data) => {
                console.log('Chat sync:', data);
                // Only render if message came from another device
                if (data.from_device !== mySocketId && data.type === 'user_message') {
                    // Switch to chat view to show the message
                    switchView('chat');
                    // Add the message to chat (it came from another device)
                    addMessage(data.content, 'user');
                    // Show loading for the response
                    currentAssistantMessage = addMessage('', 'assistant');
                    const orbWrapper = currentAssistantMessage.querySelector('.assistant-card-body .message-content-wrapper');
                    if (orbWrapper) orbWrapper.innerHTML = '<div class="thinking-orb-container"><div class="thinking-orb-dot"></div><span class="thinking-orb-label">Thinking...</span></div>';
                }
            });

            // Handle model change from another device (cross-device sync)
            socket.on('model_changed', (data) => {
                console.log('[Model] Model changed via sync:', data.model);
                if (data.model && MODEL_OPTIONS[data.model]) {
                    selectedModel = data.model;
                    localStorage.setItem('cerebro_selected_model', data.model);
                    updateModelSelectorUI();
                }
            });

            // Handle agent updates in real-time
            socket.on('agent_update', (agent) => {
                console.log('Agent update:', agent);
                handleAgentUpdate(agent);
            });

            socket.on('agent_completed', (agent) => {
                console.log('Agent completed:', agent);
                handleAgentCompleted(agent);
                // Auto-store agent result
                const agentId = agent.agent_id || agent.id || ('agent_' + Date.now());
                fetch(`${API_URL}/api/stored-items`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: 'stored_agent_' + agentId,
                        type: 'agent_result',
                        title: ((agent.call_sign || agent.name || 'Agent') + ': ' + (agent.task || agent.directive || '')).substring(0, 80),
                        content: (agent.output || agent.result || agent.summary || '').substring(0, 500),
                        metadata: { agent_id: agentId, call_sign: agent.call_sign || agent.name, task: agent.task || agent.directive, output: agent.output || agent.result, completed_at: new Date().toISOString() },
                        status: 'pending',
                        source_id: agentId
                    })
                }).catch(e => console.error('Failed to store agent result:', e));
            });

            // Listen for notifications
            socket.on('notification', (notif) => {
                console.log('Notification received:', notif);
                handleNewNotification(notif);
            });

            // Listen for ask response ready (background question processing)
            socket.on('ask_response_ready', (data) => {
                console.log('Ask response ready:', data);
                handleAskResponseReady(data);
            });

            // Listen for wallet updates (real-time from agent POST /api/wallet/log)
            socket.on('wallet_update', (entry) => {
                console.log('Wallet update:', entry);
                // Refresh wallet data to get updated totals + badge
                fetchWalletData();
            });

// ==================== NETWORK SECURITY ALERT ====================
            socket.on('network_security_alert', (data) => {
                console.log('SECURITY ALERT:', data);
                showSecurityAlert(data);
            });


            // Listen for agent archive updates
            socket.on('agent_archived', (data) => {
                console.log('Agent archived:', data);
                if (agents[data.agent_id]) {
                    agents[data.agent_id].archived = data.archived;
                    renderAgents();
                }
            });

            // Listen for directive updates (auto-refresh)
            let directiveRefreshTimeout = null;
            const debouncedLoadDirectives = () => {
                if (directiveRefreshTimeout) clearTimeout(directiveRefreshTimeout);
                directiveRefreshTimeout = setTimeout(() => {
                    loadDirectives();
                }, 1000); // Debounce 1 second for frequent updates
            };

            socket.on('directive_added', (directive) => {
                console.log('Directive added:', directive);
                loadDirectives();
                // Update voice with acknowledgment
                updateCerebroVoice('acknowledge', {
                    task: directive.text || directive.task || 'your request'
                });
            });

            socket.on('directive_completed', (data) => {
                console.log('Directive completed:', data);
                loadDirectives();
                // Update voice with completion
                updateCerebroVoice('completed', {
                    task: data.directive_text || data.task || 'the task',
                    preview: data.final_answer ? data.final_answer.substring(0, 200) : null
                });
            });

            socket.on('directive_updated', (data) => {
                console.log('Directive updated:', data);
                debouncedLoadDirectives();
                // Update voice with progress
                if (data.latest_finding) {
                    updateCerebroVoice('finding', {
                        count: data.findings_count,
                        type: data.latest_finding.type,
                        preview: data.latest_finding.content?.substring(0, 100)
                    });
                }
            });
        }

        // ==================== NOTIFICATIONS ====================
        let notificationsCache = [];

        async function loadNotifications() {
            try {
                const response = await fetch(`${API_URL}/notifications?limit=20`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                notificationsCache = data.notifications || [];
                updateNotificationBadge(data.unread_count || 0);
                renderNotifications();
            } catch (e) {
                console.error('Failed to load notifications:', e);
            }
        }

        function handleNewNotification(notif) {
            // Add to cache
            notificationsCache.unshift(notif);
            if (notificationsCache.length > 50) {
                notificationsCache = notificationsCache.slice(0, 50);
            }

            // Update badge
            const unreadCount = notificationsCache.filter(n => !n.read).length;
            updateNotificationBadge(unreadCount);

            // Animate bell
            const bell = document.getElementById('notification-bell');
            bell.classList.add('has-new');
            setTimeout(() => bell.classList.remove('has-new'), 500);

            // Re-render if panel is open
            const panel = document.getElementById('notification-panel');
            if (!panel.classList.contains('hidden')) {
                renderNotifications();
            }
        }

        function handleAskResponseReady(data) {
            // If currently viewing this agent's chat page, add the response
            if (currentAgentChatId === data.agent_id) {
                addAgentChatPageMessage('assistant', data.answer);
            }
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-badge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function toggleNotificationPanel() {
            const panel = document.getElementById('notification-panel');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                renderNotifications();
            } else {
                panel.classList.add('hidden');
            }
        }

        // Close panel when clicking outside
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('notification-panel');
            const bell = document.getElementById('notification-bell');
            if (panel && !panel.contains(e.target) && !bell.contains(e.target)) {
                panel.classList.add('hidden');
            }
        });

        function renderNotifications() {
            const container = document.getElementById('notification-list');

            if (notificationsCache.length === 0) {
                container.innerHTML = '<div class="no-notifications">No notifications</div>';
                return;
            }

            container.innerHTML = notificationsCache.map(notif => {
                const icon = notif.type === 'agent_complete' ? '' :
                             notif.type === 'agent_failed' ? '' :
                             notif.type === 'ask_response' ? '' : '';
                const timeAgo = getTimeAgo(notif.created_at);

                return `
                    <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="handleNotificationClick('${notif.id}', '${notif.agent_id || ''}')">
                        <span class="notification-icon">${icon}</span>
                        <div class="notification-content">
                            <div class="notification-title">${escapeHtml(notif.title)}</div>
                            <div class="notification-message">${escapeHtml(notif.message)}</div>
                            <div class="notification-time">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function handleNotificationClick(notifId, agentId) {
            // Mark as read
            try {
                await fetch(`${API_URL}/notifications/${notifId}/read`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Update local cache
                const notif = notificationsCache.find(n => n.id === notifId);
                if (notif) notif.read = true;

                const unreadCount = notificationsCache.filter(n => !n.read).length;
                updateNotificationBadge(unreadCount);
                renderNotifications();
            } catch (e) {
                console.error('Failed to mark notification read:', e);
            }

            // Close panel
            document.getElementById('notification-panel').classList.add('hidden');

            // Navigate to agent if applicable
            if (agentId) {
                switchView('agents');
                // Load agent and show detail or chat page
                setTimeout(() => {
                    if (agents[agentId]) {
                        openAgentChatPage(agentId);
                    } else {
                        showAgentDetail(agentId);
                    }
                }, 100);
            }
        }

        async function markAllNotificationsRead() {
            try {
                await fetch(`${API_URL}/notifications/read-all`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                notificationsCache.forEach(n => n.read = true);
                updateNotificationBadge(0);
                renderNotifications();
            } catch (e) {
                console.error('Failed to mark all read:', e);
            }
        }

        // ==================== CONTEXT ATTACH SYSTEM ====================

        // Global state for attached context references
        let attachedContextRefs = [];
        let activeContextMenu = null;
        window.messageChunkMap = {};  // Map message IDs to chunk info

        function showContextMenu(event, messageElement) {
            event.preventDefault();
            event.stopPropagation();
            hideContextMenu();

            const msgId = messageElement.getAttribute('data-message-id');
            const content = messageElement.getAttribute('data-text') || messageElement.textContent.substring(0, 500);

            const menu = document.createElement('div');
            menu.className = 'context-attach-menu';
            menu.innerHTML = `
                <div class="context-attach-menu-item" onclick="attachAsContext('${msgId}')">
                     Attach as context
                </div>
                <div class="context-attach-menu-item" onclick="copyMessageText('${msgId}')">
                     Copy text
                </div>
            `;

            // Position menu at cursor
            menu.style.left = `${Math.min(event.pageX, window.innerWidth - 200)}px`;
            menu.style.top = `${Math.min(event.pageY, window.innerHeight - 100)}px`;

            document.body.appendChild(menu);
            activeContextMenu = menu;

            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', hideContextMenu, { once: true });
            }, 10);
        }

        function hideContextMenu() {
            if (activeContextMenu) {
                activeContextMenu.remove();
                activeContextMenu = null;
            }
        }

        function attachAsContext(msgId) {
            hideContextMenu();

            const msgData = window.messageChunkMap[msgId];
            const messageEl = document.querySelector(`[data-message-id="${msgId}"]`);

            if (!msgData && !messageEl) {
                showToast('Message not found');
                return;
            }

            const content = msgData?.content || messageEl?.getAttribute('data-text') || messageEl?.textContent || '';
            const preview = content.slice(0, 40) + (content.length > 40 ? '...' : '');

            // Check if already attached
            if (attachedContextRefs.some(ref => ref.message_id === msgId)) {
                showToast('Already attached');
                return;
            }

            attachedContextRefs.push({
                message_id: msgId,
                chunk_id: msgData?.chunk_id || null,
                conversation_id: msgData?.conversation_id || null,
                preview: preview,
                fallback_content: content
            });

            // Mark message as attached
            if (messageEl) messageEl.classList.add('attached');

            renderAttachedContexts();
            showToast('Context attached');
        }

        function copyMessageText(msgId) {
            hideContextMenu();
            const msgData = window.messageChunkMap[msgId];
            const messageEl = document.querySelector(`[data-message-id="${msgId}"]`);
            const content = msgData?.content || messageEl?.getAttribute('data-text') || messageEl?.textContent || '';

            navigator.clipboard.writeText(content).then(() => {
                showToast('Copied to clipboard');
            }).catch(() => {
                showToast('Failed to copy');
            });
        }

        function removeAttachedContext(index) {
            const ref = attachedContextRefs[index];
            if (ref?.message_id) {
                const el = document.querySelector(`[data-message-id="${ref.message_id}"]`);
                if (el) el.classList.remove('attached');
            }
            attachedContextRefs.splice(index, 1);
            renderAttachedContexts();
        }

        function renderAttachedContexts() {
            // Find current input area based on active view
            let inputArea = null;
            const agentChatPage = document.getElementById('agent-chat-page');

            if (agentChatPage && agentChatPage.classList.contains('active')) {
                inputArea = document.querySelector('#agent-chat-page .agent-chat-input-area');
            } else {
                inputArea = document.querySelector('.chat-input-area');
            }

            if (!inputArea) return;

            // Remove existing container
            let container = inputArea.querySelector('.attached-contexts');

            if (attachedContextRefs.length === 0) {
                if (container) container.remove();
                return;
            }

            if (!container) {
                container = document.createElement('div');
                container.className = 'attached-contexts';
                inputArea.insertBefore(container, inputArea.firstChild);
            }

            container.innerHTML = attachedContextRefs.map((ref, i) => `
                <div class="attached-context-badge">
                    <span class="badge-icon"></span>
                    <span class="preview">${escapeHtml(ref.preview)}</span>
                    <span class="remove-btn" onclick="removeAttachedContext(${i})"></span>
                </div>
            `).join('');
        }

        function clearAttachedContexts() {
            attachedContextRefs.forEach(ref => {
                if (ref?.message_id) {
                    const el = document.querySelector(`[data-message-id="${ref.message_id}"]`);
                    if (el) el.classList.remove('attached');
                }
            });
            attachedContextRefs = [];
            renderAttachedContexts();
        }

        function getContextRefsForSend() {
            // Prepare context refs for backend and clear
            const refs = attachedContextRefs.map(ref => ({
                chunk_id: ref.chunk_id,
                conversation_id: ref.conversation_id,
                preview: ref.preview,
                fallback_content: ref.fallback_content
            }));
            clearAttachedContexts();
            return refs.length > 0 ? refs : undefined;
        }

        // ==================== CHAT ====================
        function startChat(prompt) {
            switchView('chat');
            document.getElementById('chat-input').value = prompt;
            setTimeout(() => sendMessage(), 100);
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        let currentAssistantMessage = null;

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();

            if (!content) return;

            // Build backend payload with context prepended (if any)
            let actualContent = content;
            if (pendingChatContext) {
                const ctx = pendingChatContext;
                let prefix = '';
                if (ctx.project) {
                    prefix = 'Context: Working on "' + ctx.project + '".';
                    if (ctx.summary) prefix += ' Summary: ' + ctx.summary;
                    if (ctx.next_action) prefix += ' Next action: ' + ctx.next_action;
                    if (ctx.key_files && ctx.key_files.length) prefix += ' Key files: ' + ctx.key_files.join(', ');
                } else if (ctx.rawText) {
                    prefix = 'Context: ' + ctx.rawText;
                } else if (ctx.description) {
                    prefix = 'Context: ' + ctx.description;
                } else if (ctx.title) {
                    prefix = 'Context: ' + ctx.title;
                }
                if (prefix) actualContent = prefix + '\n\n' + content;
                pendingChatContext = null;
                var ctxBubble = document.querySelector('.message.context-system');
                if (ctxBubble) dismissContextBubble(ctxBubble);
            }

            // Clear previous tool tracking
            currentToolMessage = null;
            toolMessages = {};
            toolTrackerData = { tools: [], count: 0, currentTool: null };

            addMessage(content, 'user');
            input.value = '';

            document.getElementById('send-btn').disabled = true;

            currentAssistantMessage = addMessage('', 'assistant');
            currentAssistantMessage.setAttribute('data-text', '');
            // Show thinking orb while waiting for response
            const thinkWrapper = currentAssistantMessage.querySelector('.assistant-card-body .message-content-wrapper');
            if (thinkWrapper) thinkWrapper.innerHTML = '<div class="thinking-orb-container"><div class="thinking-orb-dot"></div><span class="thinking-orb-label">Thinking...</span></div>';

            if (socket && socket.connected) {
                socket.emit('chat_message', { content: actualContent, session_id: sessionId, model: getSelectedModel(), browser_enabled: chatBrowserEnabled });
            } else {
                try {
                    const response = await fetch(`${API_URL}/chat`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content: actualContent, session_id: sessionId, model: getSelectedModel() })
                    });

                    const data = await response.json();
                    const fbWrapper = currentAssistantMessage.querySelector('.assistant-card-body .message-content-wrapper');
                    if (fbWrapper) { fbWrapper.innerHTML = safeMarkdown(data.content); }
                    currentAssistantMessage.setAttribute('data-text', data.content || '');
                    if (data.session_id) {
                        sessionId = data.session_id;
                        document.getElementById('session-id').textContent = sessionId.substring(0, 8) + '...';
                    }
                } catch (e) {
                    const errWrapper = currentAssistantMessage.querySelector('.assistant-card-body .message-content-wrapper');
                    if (errWrapper) errWrapper.textContent = 'Error: Could not reach server';
                }
            }

            document.getElementById('send-btn').disabled = false;
        }

        let currentToolMessage = null;
        let toolMessages = {};  // Track tool messages by name (legacy, kept for compat)
        let toolTrackerData = { tools: [], count: 0, currentTool: null };

        function updateToolTracker(messageEl) {
            if (!messageEl) return;
            const tracker = messageEl.querySelector('.tool-tracker');
            if (!tracker) return;

            const td = toolTrackerData;
            if (td.tools.length === 0) {
                tracker.style.display = 'none';
                return;
            }
            tracker.style.display = 'block';

            const allDone = td.tools.every(t => t.done);
            const runningCount = td.tools.filter(t => !t.done).length;

            let barHTML = '<div class="tool-tracker-bar' + (tracker.querySelector('.tool-tracker-bar.expanded') ? ' expanded' : '') + '">';
            if (!allDone) {
                barHTML += '<div class="tool-tracker-spinner"></div>';
            } else {
                barHTML += '<span class="tool-tracker-done-check">&#10003;</span>';
            }
            barHTML += '<span class="tool-tracker-count">' + td.tools.length + ' tool' + (td.tools.length !== 1 ? 's' : '') + (allDone ? ' used' : ' running') + '</span>';
            if (td.currentTool && !allDone) {
                barHTML += '<span class="tool-tracker-current">' + td.currentTool + '</span>';
            }
            barHTML += '<svg class="tool-tracker-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>';
            barHTML += '</div>';

            let listHTML = '<div class="tool-tracker-list">';
            td.tools.forEach(t => {
                const iconClass = t.done ? 'done' : 'running';
                const icon = t.done ? '&#10003;' : '&#9679;';
                listHTML += '<div class="tool-tracker-item"><span class="tt-icon ' + iconClass + '">' + icon + '</span><span class="tt-name">' + t.name + '</span></div>';
            });
            listHTML += '</div>';

            tracker.innerHTML = barHTML + listHTML;

            // Add click handler for expand/collapse
            const bar = tracker.querySelector('.tool-tracker-bar');
            if (bar) {
                bar.onclick = function() { this.classList.toggle('expanded'); };
            }
        }

        function handleChatResponse(data) {
            if (!currentAssistantMessage) return;

            if (data.type === 'text') {
                // Remove thinking orb or spinner if present
                const orb = currentAssistantMessage.querySelector('.thinking-orb-container');
                if (orb) orb.remove();
                const spinner = currentAssistantMessage.querySelector('.spinner');
                if (spinner) spinner.remove();
                // Append new text to existing content
                const existingText = currentAssistantMessage.getAttribute('data-text') || '';
                const newText = existingText + data.content;
                currentAssistantMessage.setAttribute('data-text', newText);
                const wrapper = currentAssistantMessage.querySelector('.assistant-card-body .message-content-wrapper');
                if (wrapper) {
                    wrapper.innerHTML = safeMarkdown(newText);
                }
                // Smart auto-scroll: follow text if user is near the bottom
                var sc = document.getElementById('messages');
                if (sc && (sc.scrollHeight - sc.scrollTop - sc.clientHeight) < 150) {
                    sc.scrollTop = sc.scrollHeight;
                }
            } else if (data.type === 'tool') {
                // Add tool to tracker instead of creating separate messages
                toolTrackerData.tools.push({ name: data.name, done: false });
                toolTrackerData.count = toolTrackerData.tools.length;
                toolTrackerData.currentTool = data.name;
                updateToolTracker(currentAssistantMessage);
            } else if (data.type === 'tool_result') {
                // Mark tool as done in tracker
                const tool = toolTrackerData.tools.find(t => t.name === data.name && !t.done);
                if (tool) tool.done = true;
                // Update current tool to next running one
                const running = toolTrackerData.tools.find(t => !t.done);
                toolTrackerData.currentTool = running ? running.name : null;
                updateToolTracker(currentAssistantMessage);
            } else if (data.type === 'session') {
                sessionId = data.session_id;
                document.getElementById('session-id').textContent = sessionId.substring(0, 8) + '...';
            } else if (data.type === 'done' || data.type === 'end') {
                // Mark all tools as done in tracker
                toolTrackerData.tools.forEach(t => t.done = true);
                toolTrackerData.currentTool = null;
                updateToolTracker(currentAssistantMessage);
                // Also clean up any legacy .message.tool elements
                document.querySelectorAll('.message.tool').forEach(el => el.remove());
                // Reset tracker state for next message
                toolTrackerData = { tools: [], count: 0, currentTool: null };
                currentToolMessage = null;
                toolMessages = {};
                // Re-enable send button
                document.getElementById('send-btn').disabled = false;
                // Save chat history after response completes
                debouncedSave();

                // Update model badge in card header
                if (currentAssistantMessage && data.model) {
                    const modelInfo = MODEL_OPTIONS[data.model];
                    if (modelInfo) {
                        const modelBadge = currentAssistantMessage.querySelector('.assistant-card-model');
                        if (modelBadge) {
                            modelBadge.innerHTML = '<span class="model-dot ' + modelInfo.dotClass + '"></span> ' + modelInfo.label;
                        }
                    }
                }

                // Speak response in conversational mode
                if (conversationalMode && currentAssistantMessage) {
                    const responseText = currentAssistantMessage.getAttribute('data-text');
                    console.log('[Conv] Response complete, will speak:', responseText?.substring(0, 50) + '...');
                    if (responseText && responseText.trim()) {
                        setTimeout(() => speak(responseText), 500);
                    } else {
                        // No response to speak, resume listening
                        console.log('[Conv] No response text, resuming listen');
                        setTimeout(() => startConversationalListen(), 500);
                    }
                }
            }

            const container = document.getElementById('messages');
            container.scrollTop = container.scrollHeight;
        }

        function formatTimestamp(date) {
            if (!date) date = new Date();
            const h = date.getHours();
            const m = date.getMinutes().toString().padStart(2, '0');
            const ampm = h >= 12 ? 'PM' : 'AM';
            return `${h % 12 || 12}:${m} ${ampm}`;
        }

        function buildAssistantCard(content, options = {}) {
            const message = document.createElement('div');
            message.className = 'message assistant';
            const msgId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            message.setAttribute('data-message-id', msgId);
            message.setAttribute('data-text', content || '');

            // Card header with timestamp and model
            const header = document.createElement('div');
            header.className = 'assistant-card-header';
            const meta = document.createElement('div');
            meta.className = 'assistant-card-meta';
            const ts = document.createElement('span');
            ts.className = 'assistant-card-timestamp';
            ts.textContent = options.timestamp || formatTimestamp();
            meta.appendChild(ts);
            const modelBadge = document.createElement('span');
            modelBadge.className = 'assistant-card-model';
            if (options.model && MODEL_OPTIONS[options.model]) {
                const info = MODEL_OPTIONS[options.model];
                modelBadge.innerHTML = '<span class="model-dot ' + info.dotClass + '"></span> ' + info.label;
            }
            meta.appendChild(modelBadge);
            header.appendChild(meta);
            message.appendChild(header);

            // Tool tracker (hidden by default, populated by Step 3)
            const tracker = document.createElement('div');
            tracker.className = 'tool-tracker';
            tracker.style.display = 'none';
            message.appendChild(tracker);

            // Card body
            const body = document.createElement('div');
            body.className = 'assistant-card-body';
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'message-content-wrapper';
            if (content) contentWrapper.innerHTML = safeMarkdown(content);
            body.appendChild(contentWrapper);
            message.appendChild(body);

            // Card actions (speak button)
            const actions = document.createElement('div');
            actions.className = 'assistant-card-actions';
            const speakBtn = document.createElement('button');
            speakBtn.className = 'chat-speak-btn';
            speakBtn.title = 'Listen to this message';
            speakBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>';
            speakBtn.onclick = function() { speakMessageContent(message, this); };
            actions.appendChild(speakBtn);
            message.appendChild(actions);

            // Store in session for chunk mapping
            window.messageChunkMap[msgId] = {
                content: content,
                type: 'assistant',
                timestamp: new Date().toISOString(),
                chunk_id: null,
                conversation_id: null
            };

            // Context menu
            message.classList.add('attachable');
            message.addEventListener('contextmenu', (e) => showContextMenu(e, message));

            return message;
        }

        function addMessage(content, type) {
            const container = document.getElementById('messages');

            if (type === 'assistant') {
                const message = buildAssistantCard(content);
                container.appendChild(message);
                if (content) debouncedSave();
                return message;
            }

            const message = document.createElement('div');
            message.className = `message ${type}`;
            const msgId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            message.setAttribute('data-message-id', msgId);

            if (type === 'tool') {
                message.innerHTML = '<div class="tool-spinner"></div>' + content;
            } else {
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'message-content-wrapper';
                contentWrapper.innerHTML = safeMarkdown(content);
                message.appendChild(contentWrapper);
                message.setAttribute('data-text', content);

                // User timestamp
                if (type === 'user') {
                    const ts = document.createElement('div');
                    ts.className = 'user-msg-timestamp';
                    ts.textContent = formatTimestamp();
                    message.appendChild(ts);
                }

                // Store in session for chunk mapping
                window.messageChunkMap[msgId] = {
                    content: content,
                    type: type,
                    timestamp: new Date().toISOString(),
                    chunk_id: null,
                    conversation_id: null
                };

                // Add context menu handler for attachable messages
                message.classList.add('attachable');
                message.addEventListener('contextmenu', (e) => showContextMenu(e, message));
            }

            container.appendChild(message);

            // Auto-scroll to bottom when user sends a message or assistant starts
            if (type === 'user' || type === 'assistant') {
                scrollMessagesToBottom();
            }

            // Save chat history for persistence (skip tool messages)
            if (type !== 'tool' && content) {
                debouncedSave();
            }

            return message;
        }

        // ==================== SIMULATION CARD ====================
        function fmtSimCurrency(v) {
            if (v == null || isNaN(v)) return 'N/A';
            const abs = Math.abs(v);
            const sign = v < 0 ? '-' : '';
            if (abs >= 1e6) return sign + '$' + (abs / 1e6).toFixed(2) + 'M';
            if (abs >= 1e3) return sign + '$' + (abs / 1e3).toFixed(1) + 'k';
            return sign + '$' + abs.toFixed(2);
        }

        function getSimRiskLevel(std, mean) {
            if (!mean || mean === 0) return { label: 'N/A', class: 'risk-low' };
            const cv = Math.abs(std / mean);
            if (cv < 0.15) return { label: 'LOW', class: 'risk-low' };
            if (cv < 0.4) return { label: 'MEDIUM', class: 'risk-medium' };
            if (cv < 0.8) return { label: 'HIGH', class: 'risk-high' };
            return { label: 'EXTREME', class: 'risk-extreme' };
        }

        function escapeSimHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function renderSimulationCard(data) {
            const container = document.getElementById('messages');
            const message = document.createElement('div');
            message.className = 'message assistant';

            const stats = data.statistics || {};
            const risk = getSimRiskLevel(stats.std || 0, stats.mean || 0);
            const ci = stats.confidence_interval_95 || [0, 0];
            const pct = stats.percentiles || {};

            // Build the card element
            const card = document.createElement('div');
            card.className = 'simulation-card';

            // -- Header --
            const header = document.createElement('div');
            header.className = 'sim-header';
            const headerIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            headerIcon.setAttribute('width', '18');
            headerIcon.setAttribute('height', '18');
            headerIcon.setAttribute('viewBox', '0 0 24 24');
            headerIcon.setAttribute('fill', 'none');
            headerIcon.setAttribute('stroke', 'currentColor');
            headerIcon.setAttribute('stroke-width', '2');
            headerIcon.setAttribute('stroke-linecap', 'round');
            headerIcon.setAttribute('stroke-linejoin', 'round');
            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            polyline.setAttribute('points', '22 12 18 12 15 21 9 3 6 12 2 12');
            headerIcon.appendChild(polyline);
            header.appendChild(headerIcon);
            const headerTitle = document.createElement('span');
            headerTitle.className = 'sim-header-title';
            headerTitle.textContent = 'Simulation Results';
            header.appendChild(headerTitle);
            card.appendChild(header);

            // -- Query --
            const queryDiv = document.createElement('div');
            queryDiv.className = 'sim-query';
            queryDiv.textContent = data.query || 'Simulation';
            card.appendChild(queryDiv);

            // -- Stats Grid --
            const grid = document.createElement('div');
            grid.className = 'sim-stats-grid';

            function makeStatCell(label, valueText, extraClass, badgeHtml) {
                const cell = document.createElement('div');
                cell.className = 'sim-stat-cell';
                const lbl = document.createElement('div');
                lbl.className = 'sim-stat-label';
                lbl.textContent = label;
                cell.appendChild(lbl);
                const val = document.createElement('div');
                val.className = 'sim-stat-value' + (extraClass ? ' ' + extraClass : '');
                if (badgeHtml) {
                    const badge = document.createElement('span');
                    badge.className = 'sim-risk-badge ' + risk.class;
                    badge.textContent = risk.label;
                    val.appendChild(badge);
                } else {
                    val.textContent = valueText;
                }
                cell.appendChild(val);
                return cell;
            }

            grid.appendChild(makeStatCell('Expected Value', fmtSimCurrency(stats.mean), 'accent', false));
            grid.appendChild(makeStatCell('Risk Level', '', '', true));
            grid.appendChild(makeStatCell('95% Confidence', fmtSimCurrency(ci[0]) + ' - ' + fmtSimCurrency(ci[1]), '', false));
            grid.appendChild(makeStatCell('Std Deviation', fmtSimCurrency(stats.std), '', false));
            card.appendChild(grid);

            // -- Sparkline --
            const sparkPoints = [pct['5'], pct['25'], pct['50'], pct['75'], pct['95']].filter(v => v != null);
            if (sparkPoints.length >= 3) {
                const spMin = Math.min(...sparkPoints);
                const spMax = Math.max(...sparkPoints);
                const spRange = spMax - spMin || 1;
                const svgW = 260;
                const svgH = 40;

                const sparkWrap = document.createElement('div');
                sparkWrap.className = 'sim-sparkline';
                const sparkLabel = document.createElement('div');
                sparkLabel.className = 'sim-sparkline-label';
                sparkLabel.textContent = 'Distribution (5th - 95th percentile)';
                sparkWrap.appendChild(sparkLabel);

                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('viewBox', '0 0 ' + svgW + ' ' + svgH);
                svg.setAttribute('preserveAspectRatio', 'none');

                const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                const grad = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                grad.setAttribute('id', 'simGrad');
                grad.setAttribute('x1', '0'); grad.setAttribute('y1', '0');
                grad.setAttribute('x2', '0'); grad.setAttribute('y2', '1');
                const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                stop1.setAttribute('offset', '0%'); stop1.setAttribute('stop-color', 'rgba(139,92,246,0.35)');
                const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                stop2.setAttribute('offset', '100%'); stop2.setAttribute('stop-color', 'rgba(139,92,246,0.02)');
                grad.appendChild(stop1); grad.appendChild(stop2);
                defs.appendChild(grad); svg.appendChild(defs);

                const coords = sparkPoints.map((v, i) => {
                    const x = (i / (sparkPoints.length - 1)) * svgW;
                    const y = svgH - ((v - spMin) / spRange) * (svgH - 4) - 2;
                    return { x, y };
                });

                const areaStr = coords.map(c => c.x + ',' + c.y).join(' ') + ' ' + svgW + ',' + svgH + ' 0,' + svgH;
                const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                polygon.setAttribute('points', areaStr);
                polygon.setAttribute('fill', 'url(#simGrad)');
                svg.appendChild(polygon);

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                line.setAttribute('points', coords.map(c => c.x + ',' + c.y).join(' '));
                line.setAttribute('fill', 'none');
                line.setAttribute('stroke', '#8b5cf6');
                line.setAttribute('stroke-width', '2');
                line.setAttribute('stroke-linecap', 'round');
                line.setAttribute('stroke-linejoin', 'round');
                svg.appendChild(line);

                coords.forEach(c => {
                    const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    dot.setAttribute('cx', c.x); dot.setAttribute('cy', c.y);
                    dot.setAttribute('r', '3');
                    dot.setAttribute('fill', '#a78bfa');
                    dot.setAttribute('stroke', '#12121a');
                    dot.setAttribute('stroke-width', '1.5');
                    svg.appendChild(dot);
                });

                sparkWrap.appendChild(svg);
                card.appendChild(sparkWrap);
            }

            // -- Analysis section --
            if (data.analysis) {
                const a = data.analysis;
                const analysisDiv = document.createElement('div');
                analysisDiv.className = 'sim-analysis';
                const aTitle = document.createElement('div');
                aTitle.className = 'sim-analysis-title';
                aTitle.textContent = 'Analysis';
                analysisDiv.appendChild(aTitle);

                if (a.summary) {
                    const sumDiv = document.createElement('div');
                    sumDiv.className = 'sim-analysis-summary';
                    sumDiv.textContent = a.summary;
                    analysisDiv.appendChild(sumDiv);
                }

                if (a.key_findings && a.key_findings.length > 0) {
                    const ul = document.createElement('ul');
                    ul.className = 'sim-findings';
                    a.key_findings.forEach(finding => {
                        const li = document.createElement('li');
                        li.textContent = finding;
                        ul.appendChild(li);
                    });
                    analysisDiv.appendChild(ul);
                }

                card.appendChild(analysisDiv);
            }

            // -- Actions --
            const actions = document.createElement('div');
            actions.className = 'sim-actions';
            const viewBtn = document.createElement('button');
            viewBtn.className = 'sim-btn primary';
            const btnIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            btnIcon.setAttribute('width', '12'); btnIcon.setAttribute('height', '12');
            btnIcon.setAttribute('viewBox', '0 0 24 24');
            btnIcon.setAttribute('fill', 'none');
            btnIcon.setAttribute('stroke', 'currentColor');
            btnIcon.setAttribute('stroke-width', '2');
            const p1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            p1.setAttribute('d', 'M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6');
            const p2 = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            p2.setAttribute('points', '15 3 21 3 21 9');
            const p3 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            p3.setAttribute('x1', '10'); p3.setAttribute('y1', '14');
            p3.setAttribute('x2', '21'); p3.setAttribute('y2', '3');
            btnIcon.appendChild(p1); btnIcon.appendChild(p2); btnIcon.appendChild(p3);
            viewBtn.appendChild(btnIcon);
            viewBtn.appendChild(document.createTextNode(' View in SimEngine'));
            viewBtn.addEventListener('click', () => window.open(CEREBRO_CONFIG.simEngineUrl || 'http://localhost:5173', '_blank'));
            actions.appendChild(viewBtn);
            card.appendChild(actions);

            message.appendChild(card);
            container.appendChild(message);
        }

        function showSimulationModal(data) {
            // Remove any existing modal
            var old = document.getElementById('sim-modal-overlay');
            if (old) old.remove();

            var stats = data.statistics || {};
            var risk = getSimRiskLevel(stats.std || 0, stats.mean || 0);
            var ci = stats.confidence_interval_95 || [0, 0];
            var pct = stats.percentiles || {};
            var meta = data.metadata || {};
            var analysis = data.analysis || {};

            // Overlay
            var overlay = document.createElement('div');
            overlay.id = 'sim-modal-overlay';
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;backdrop-filter:blur(4px);';
            overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });

            // Modal container
            var modal = document.createElement('div');
            modal.style.cssText = 'background:#1a1a2e;border:1px solid rgba(139,92,246,0.3);border-radius:16px;padding:28px;max-width:520px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(139,92,246,0.15);';

            // Header row
            var headerRow = document.createElement('div');
            headerRow.style.cssText = 'display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;';
            var headerLeft = document.createElement('div');
            headerLeft.style.cssText = 'display:flex;align-items:center;gap:10px;';
            var hIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            hIcon.setAttribute('width','22'); hIcon.setAttribute('height','22'); hIcon.setAttribute('viewBox','0 0 24 24');
            hIcon.setAttribute('fill','none'); hIcon.setAttribute('stroke','#8b5cf6'); hIcon.setAttribute('stroke-width','2');
            var hPoly = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            hPoly.setAttribute('points','22 12 18 12 15 21 9 3 6 12 2 12');
            hIcon.appendChild(hPoly);
            headerLeft.appendChild(hIcon);
            var hTitle = document.createElement('span');
            hTitle.style.cssText = 'font-size:1.15rem;font-weight:600;color:#e2e8f0;';
            hTitle.textContent = 'Simulation Results';
            headerLeft.appendChild(hTitle);
            headerRow.appendChild(headerLeft);
            var closeBtn = document.createElement('button');
            closeBtn.style.cssText = 'background:none;border:none;color:#888;font-size:1.4rem;cursor:pointer;padding:4px 8px;';
            closeBtn.textContent = '\u00d7';
            closeBtn.addEventListener('click', function() { overlay.remove(); });
            headerRow.appendChild(closeBtn);
            modal.appendChild(headerRow);

            // Query label
            var queryDiv = document.createElement('div');
            queryDiv.style.cssText = 'color:#a78bfa;font-size:0.85rem;margin-bottom:16px;padding:8px 12px;background:rgba(139,92,246,0.08);border-radius:8px;';
            queryDiv.textContent = data.query || 'Simulation';
            modal.appendChild(queryDiv);

            // Stats grid
            var grid = document.createElement('div');
            grid.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;';

            function makeCell(label, value, isRisk) {
                var cell = document.createElement('div');
                cell.style.cssText = 'background:rgba(255,255,255,0.03);border-radius:10px;padding:12px;';
                var lbl = document.createElement('div');
                lbl.style.cssText = 'color:#888;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.5px;';
                lbl.textContent = label;
                cell.appendChild(lbl);
                var val = document.createElement('div');
                val.style.cssText = 'margin-top:4px;';
                if (isRisk) {
                    var badge = document.createElement('span');
                    var badgeColors = risk.label === 'LOW' ? 'background:rgba(34,197,94,0.15);color:#22c55e;' :
                        risk.label === 'MEDIUM' ? 'background:rgba(234,179,8,0.15);color:#eab308;' :
                        risk.label === 'HIGH' ? 'background:rgba(239,68,68,0.15);color:#ef4444;' :
                        'background:rgba(139,92,246,0.15);color:#a78bfa;';
                    badge.style.cssText = 'padding:3px 10px;border-radius:12px;font-size:0.75rem;font-weight:600;' + badgeColors;
                    badge.textContent = risk.label;
                    val.appendChild(badge);
                } else {
                    val.style.cssText += 'color:' + (label === 'Expected Value' ? '#8b5cf6' : '#e2e8f0') + ';font-size:' + (label === 'Expected Value' ? '1.3rem' : '0.95rem') + ';font-weight:' + (label === 'Expected Value' ? '700' : '600') + ';';
                    val.textContent = value;
                }
                cell.appendChild(val);
                return cell;
            }

            grid.appendChild(makeCell('Expected Value', fmtSimCurrency(stats.mean), false));
            grid.appendChild(makeCell('Risk Level', '', true));
            grid.appendChild(makeCell('95% Confidence', fmtSimCurrency(ci[0]) + ' \u2013 ' + fmtSimCurrency(ci[1]), false));
            grid.appendChild(makeCell('Std Deviation', fmtSimCurrency(stats.std), false));
            modal.appendChild(grid);

            // Sparkline
            var sparkPts = [pct['5'], pct['25'], pct['50'], pct['75'], pct['95']].filter(function(v) { return v != null; });
            if (sparkPts.length >= 3) {
                var spMin = Math.min.apply(null, sparkPts);
                var spMax = Math.max.apply(null, sparkPts);
                var spRange = spMax - spMin || 1;
                var sparkWrap = document.createElement('div');
                sparkWrap.style.cssText = 'margin-bottom:16px;';
                var sparkLabel = document.createElement('div');
                sparkLabel.style.cssText = 'color:#666;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;';
                sparkLabel.textContent = 'Distribution (5th \u2013 95th percentile)';
                sparkWrap.appendChild(sparkLabel);

                var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('viewBox', '0 0 320 50');
                svg.setAttribute('preserveAspectRatio', 'none');
                svg.style.cssText = 'width:100%;height:50px;';

                var defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                var grad = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                grad.setAttribute('id', 'smGrad'); grad.setAttribute('x1','0'); grad.setAttribute('y1','0'); grad.setAttribute('x2','0'); grad.setAttribute('y2','1');
                var s1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','rgba(139,92,246,0.35)');
                var s2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','rgba(139,92,246,0.02)');
                grad.appendChild(s1); grad.appendChild(s2); defs.appendChild(grad); svg.appendChild(defs);

                var coords = sparkPts.map(function(v, i) {
                    return { x: (i / (sparkPts.length - 1)) * 320, y: 50 - ((v - spMin) / spRange) * 44 - 3 };
                });

                var polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                polygon.setAttribute('points', coords.map(function(c){return c.x+','+c.y;}).join(' ') + ' 320,50 0,50');
                polygon.setAttribute('fill', 'url(#smGrad)');
                svg.appendChild(polygon);

                var line = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                line.setAttribute('points', coords.map(function(c){return c.x+','+c.y;}).join(' '));
                line.setAttribute('fill','none'); line.setAttribute('stroke','#8b5cf6');
                line.setAttribute('stroke-width','2.5'); line.setAttribute('stroke-linecap','round'); line.setAttribute('stroke-linejoin','round');
                svg.appendChild(line);

                sparkWrap.appendChild(svg);
                modal.appendChild(sparkWrap);
            }

            // Metadata line
            if (meta.iterations) {
                var metaDiv = document.createElement('div');
                metaDiv.style.cssText = 'color:#666;font-size:0.75rem;margin-bottom:12px;';
                metaDiv.textContent = (meta.method || 'monte_carlo').replace(/_/g, ' ') + ' \u00b7 ' + meta.iterations.toLocaleString() + ' iterations' + (meta.elapsed_seconds ? ' \u00b7 ' + meta.elapsed_seconds.toFixed(2) + 's' : '');
                modal.appendChild(metaDiv);
            }

            // Analysis section
            if (analysis.summary || (analysis.key_findings && analysis.key_findings.length > 0)) {
                var aSep = document.createElement('div');
                aSep.style.cssText = 'border-top:1px solid rgba(255,255,255,0.06);padding-top:12px;margin-top:4px;';
                var aLabel = document.createElement('div');
                aLabel.style.cssText = 'color:#888;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;';
                aLabel.textContent = 'Analysis';
                aSep.appendChild(aLabel);
                if (analysis.summary) {
                    var sumDiv = document.createElement('div');
                    sumDiv.style.cssText = 'color:#ccc;font-size:0.85rem;margin-bottom:8px;';
                    sumDiv.textContent = analysis.summary;
                    aSep.appendChild(sumDiv);
                }
                if (analysis.key_findings && analysis.key_findings.length > 0) {
                    var ul = document.createElement('ul');
                    ul.style.cssText = 'margin:0;padding-left:16px;color:#aaa;font-size:0.8rem;';
                    analysis.key_findings.forEach(function(f) {
                        var li = document.createElement('li');
                        li.style.cssText = 'margin-bottom:4px;';
                        li.textContent = f;
                        ul.appendChild(li);
                    });
                    aSep.appendChild(ul);
                }
                modal.appendChild(aSep);
            }

            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        // ==================== PERSONALITY TOGGLE ====================
        function setPersonality(mode) {
            localStorage.setItem('cerebro_personality', mode);
            document.querySelectorAll('.personality-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
            fetch(`${API_URL}/api/cerebro/personality`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ personality_mode: mode })
            }).catch(e => console.error('Failed to set personality:', e));
        }
        function loadPersonality() {
            const saved = localStorage.getItem('cerebro_personality');
            if (saved) {
                document.querySelectorAll('.personality-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === saved));
            } else {
                fetch(`${API_URL}/api/cerebro/personality`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                }).then(r => r.json()).then(data => {
                    const mode = data.personality_mode || 'chill';
                    localStorage.setItem('cerebro_personality', mode);
                    document.querySelectorAll('.personality-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
                }).catch(() => setPersonality('chill'));
            }
        }

        // ==================== LOOK COMMAND TOGGLE ====================
        let _lookRunning = false;

        async function loadLookStatus() {
            try {
                const resp = await fetch(`${API_URL}/api/look/status`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await resp.json();
                _lookRunning = data.running;
                const toggle = document.getElementById('look-toggle');
                const statusRow = document.getElementById('look-status-row');
                const statusText = document.getElementById('look-status-text');
                if (toggle) toggle.classList.toggle('active', _lookRunning);
                if (statusRow && statusText) {
                    if (_lookRunning) {
                        statusRow.style.display = '';
                        statusText.textContent = `Running (PID ${data.pid})`;
                        statusText.style.color = 'var(--success, #22c55e)';
                    } else {
                        statusRow.style.display = 'none';
                    }
                }
            } catch (e) {
                console.error('Failed to load look status:', e);
            }
        }

        async function toggleLookDaemon() {
            const enable = !_lookRunning;
            const toggle = document.getElementById('look-toggle');
            const statusRow = document.getElementById('look-status-row');
            const statusText = document.getElementById('look-status-text');

            // Optimistic UI
            if (toggle) toggle.classList.toggle('active', enable);
            if (statusRow && statusText) {
                statusRow.style.display = '';
                statusText.textContent = enable ? 'Starting...' : 'Stopping...';
                statusText.style.color = 'var(--text-muted)';
            }

            try {
                const resp = await fetch(`${API_URL}/api/look/toggle`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enable })
                });
                const data = await resp.json();
                _lookRunning = data.running;

                if (toggle) toggle.classList.toggle('active', _lookRunning);
                if (statusRow && statusText) {
                    if (_lookRunning) {
                        statusRow.style.display = '';
                        statusText.textContent = `Running (PID ${data.pid})`;
                        statusText.style.color = 'var(--success, #22c55e)';
                        showToast('Look daemon started');
                    } else {
                        statusRow.style.display = 'none';
                        showToast('Look daemon stopped');
                    }
                }
            } catch (e) {
                console.error('Failed to toggle look daemon:', e);
                showToast('Failed to toggle look daemon', 'error');
                // Revert UI
                if (toggle) toggle.classList.toggle('active', _lookRunning);
                loadLookStatus();
            }
        }

        // ==================== SIM CLARIFICATION POPUP ====================
        function showSimClarificationModal(data) {
            var old = document.getElementById('sim-clarify-overlay');
            if (old) old.remove();
            var overlay = document.createElement('div');
            overlay.id = 'sim-clarify-overlay';
            overlay.className = 'sim-clarify-overlay';
            var modal = document.createElement('div');
            modal.className = 'sim-clarify-modal';
            var header = document.createElement('div');
            header.className = 'sim-clarify-header';
            var hIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            hIcon.setAttribute('width','20'); hIcon.setAttribute('height','20'); hIcon.setAttribute('viewBox','0 0 24 24');
            hIcon.setAttribute('fill','none'); hIcon.setAttribute('stroke','#8b5cf6'); hIcon.setAttribute('stroke-width','2');
            var c1 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            c1.setAttribute('cx','12'); c1.setAttribute('cy','12'); c1.setAttribute('r','10');
            var p1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            p1.setAttribute('d','M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3');
            var l1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            l1.setAttribute('x1','12'); l1.setAttribute('y1','17'); l1.setAttribute('x2','12.01'); l1.setAttribute('y2','17');
            hIcon.appendChild(c1); hIcon.appendChild(p1); hIcon.appendChild(l1);
            header.appendChild(hIcon);
            header.appendChild(document.createTextNode(' Cerebro needs some details'));
            modal.appendChild(header);
            var ctx = document.createElement('div');
            ctx.className = 'sim-clarify-context';
            ctx.textContent = data.directive_text || data.original_query;
            modal.appendChild(ctx);
            var form = document.createElement('div');
            (data.questions || []).forEach(function(q) {
                var field = document.createElement('div');
                field.className = 'sim-clarify-field';
                var label = document.createElement('label');
                label.textContent = q.label;
                field.appendChild(label);
                if (q.type === 'select' && q.options) {
                    var sel = document.createElement('select');
                    sel.dataset.qid = q.id;
                    var emptyOpt = document.createElement('option');
                    emptyOpt.value = ''; emptyOpt.textContent = 'Select...';
                    sel.appendChild(emptyOpt);
                    q.options.forEach(function(opt) {
                        var o = document.createElement('option');
                        o.value = opt; o.textContent = opt;
                        sel.appendChild(o);
                    });
                    field.appendChild(sel);
                } else {
                    var inp = document.createElement('input');
                    inp.type = 'text'; inp.dataset.qid = q.id; inp.placeholder = q.label;
                    field.appendChild(inp);
                }
                form.appendChild(field);
            });
            modal.appendChild(form);
            var submitBtn = document.createElement('button');
            submitBtn.className = 'sim-clarify-submit';
            submitBtn.textContent = 'Run Simulation';
            submitBtn.addEventListener('click', function() {
                var answers = {};
                form.querySelectorAll('[data-qid]').forEach(function(el) { answers[el.dataset.qid] = el.value; });
                socket.emit('simulation_clarification_response', { request_id: data.id, answers: answers });
                overlay.remove();
            });
            modal.appendChild(submitBtn);
            overlay.appendChild(modal);
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    socket.emit('simulation_clarification_response', { request_id: data.id, answers: {} });
                    overlay.remove();
                }
            });
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape' && document.getElementById('sim-clarify-overlay')) {
                    socket.emit('simulation_clarification_response', { request_id: data.id, answers: {} });
                    overlay.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            });
            document.body.appendChild(overlay);
        }

        // ==================== SIM FOLLOW-UP SUGGESTIONS ====================
        let lastSimContext = null;
        function renderSimFollowups(messageEl, data) {
            lastSimContext = data;
            var wrap = document.createElement('div');
            wrap.className = 'sim-followups';
            (data.suggestions || []).forEach(function(s) {
                var pill = document.createElement('button');
                pill.className = 'sim-followup-pill';
                pill.textContent = s;
                pill.addEventListener('click', function() { sendSimFollowup(s, data); });
                wrap.appendChild(pill);
            });
            var inputWrap = document.createElement('div');
            inputWrap.className = 'sim-followup-input-wrap';
            var inp = document.createElement('input');
            inp.className = 'sim-followup-input';
            inp.placeholder = 'Ask about these results...';
            inp.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && inp.value.trim()) { sendSimFollowup(inp.value.trim(), data); inp.value = ''; }
            });
            var sendBtn = document.createElement('button');
            sendBtn.className = 'sim-followup-send';
            sendBtn.textContent = 'Ask';
            sendBtn.addEventListener('click', function() {
                if (inp.value.trim()) { sendSimFollowup(inp.value.trim(), data); inp.value = ''; }
            });
            inputWrap.appendChild(inp); inputWrap.appendChild(sendBtn);
            wrap.appendChild(inputWrap);
            messageEl.appendChild(wrap);
        }
        async function sendSimFollowup(question, simContext) {
            var stats = simContext.sim_data ? simContext.sim_data.statistics || {} : {};
            var contextHint = 'Context: Previously simulated "' + (simContext.query || '') +
                '" with expected value $' + (stats.mean || 0).toFixed(2) +
                ', std $' + (stats.std || 0).toFixed(2) + '. ';
            var input = document.getElementById('cerebro-chat-field');
            if (input) {
                input.value = contextHint + question;
                await sendChatMessage();
            }
        }

        function formatMessage(text) {
            if (!text) return '';

            // Basic markdown: code blocks
            text = text.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            // Inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Bold
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            // Line breaks
            text = text.replace(/\n/g, '<br>');

            return text;
        }

        // ==================== CHAT PERSISTENCE ====================
        const CHAT_STORAGE_KEY = 'cerebro_chat_history';
        const MAX_CHAT_MESSAGES = 200; // Keep last 200 messages

        function saveChatHistory() {
            try {
                const container = document.getElementById('messages');
                const messages = [];

                container.querySelectorAll('.message').forEach(msg => {
                    // Skip tool messages and empty messages
                    if (msg.classList.contains('tool')) return;

                    const type = msg.classList.contains('user') ? 'user' : 'assistant';
                    const content = msg.getAttribute('data-text') || msg.textContent.trim();

                    if (content) {
                        const entry = { type, content, timestamp: Date.now() };
                        // Save model info from card header
                        if (type === 'assistant') {
                            const modelEl = msg.querySelector('.assistant-card-model');
                            if (modelEl && modelEl.textContent.trim()) {
                                const dotEl = modelEl.querySelector('.model-dot');
                                if (dotEl) {
                                    // Reverse-lookup model id from dotClass
                                    const cls = dotEl.className.replace('model-dot ', '').trim();
                                    for (const [id, info] of Object.entries(MODEL_OPTIONS)) {
                                        if (info.dotClass === cls) { entry.model = id; break; }
                                    }
                                }
                            }
                        }
                        messages.push(entry);
                    }
                });

                // Keep only the last MAX_CHAT_MESSAGES
                const trimmed = messages.slice(-MAX_CHAT_MESSAGES);

                localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify({
                    messages: trimmed,
                    sessionId: sessionId,
                    lastSaved: Date.now()
                }));

                // Also save to backend for cross-device sync (fire and forget)
                saveChatToBackend(trimmed);

            } catch (e) {
                console.error('Failed to save chat history:', e);
            }
        }

        async function saveChatToBackend(messages) {
            try {
                await fetch(`${API_URL}/chat/history`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ messages, session_id: sessionId })
                });
            } catch (e) {
                // Silent fail - localStorage is primary
            }
        }

        async function loadChatHistory() {
            try {
                // Get both localStorage and backend data, use whichever has more messages
                let localData = null;
                let backendData = null;

                // Try localStorage first (instant display)
                const stored = localStorage.getItem(CHAT_STORAGE_KEY);
                if (stored) {
                    localData = JSON.parse(stored);
                    if (localData.messages && localData.messages.length > 0) {
                        // Show immediately for instant UX
                        renderChatHistory(localData.messages);
                        if (localData.sessionId) {
                            sessionId = localData.sessionId;
                            document.getElementById('session-id').textContent = sessionId.substring(0, 8) + '...';
                        }
                        console.log(`Loaded ${localData.messages.length} messages from localStorage`);
                    }
                }

                // Always check backend for newer/more messages (cross-device sync)
                try {
                    const response = await fetch(`${API_URL}/chat/history`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        backendData = await response.json();
                    }
                } catch (e) {
                    console.log('Backend chat history unavailable');
                }

                // If backend has more messages, use it instead
                const localCount = localData?.messages?.length || 0;
                const backendCount = backendData?.messages?.length || 0;

                if (backendCount > localCount) {
                    console.log(`Backend has more messages (${backendCount} vs ${localCount}), syncing...`);
                    renderChatHistory(backendData.messages);
                    if (backendData.session_id) {
                        sessionId = backendData.session_id;
                        document.getElementById('session-id').textContent = sessionId.substring(0, 8) + '...';
                    }
                    // Update localStorage with backend data
                    localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify({
                        messages: backendData.messages,
                        sessionId: backendData.session_id,
                        lastSaved: Date.now()
                    }));
                }

            } catch (e) {
                console.error('Failed to load chat history:', e);
            }
        }

        function renderChatHistory(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = ''; // Clear default welcome message

            messages.forEach(msg => {
                if (msg.type === 'assistant') {
                    const ts = msg.timestamp ? formatTimestamp(new Date(msg.timestamp)) : null;
                    const messageEl = buildAssistantCard(msg.content, {
                        timestamp: ts,
                        model: msg.model || null
                    });
                    container.appendChild(messageEl);
                } else {
                    const messageEl = document.createElement('div');
                    messageEl.className = `message ${msg.type}`;
                    messageEl.setAttribute('data-text', msg.content);

                    const contentWrapper = document.createElement('div');
                    contentWrapper.className = 'message-content-wrapper';
                    contentWrapper.innerHTML = safeMarkdown(msg.content);
                    messageEl.appendChild(contentWrapper);

                    if (msg.type === 'user') {
                        const ts = document.createElement('div');
                        ts.className = 'user-msg-timestamp';
                        ts.textContent = msg.timestamp ? formatTimestamp(new Date(msg.timestamp)) : '';
                        messageEl.appendChild(ts);
                    }

                    container.appendChild(messageEl);
                }
            });

            // Scroll to bottom after render
            requestAnimationFrame(function() {
                container.scrollTop = container.scrollHeight;
            });
        }

        async function clearChatHistory() {
            if (!await cerebroConfirm('Clear all chat history? This cannot be undone.', { title: 'Clear History', danger: true, confirmText: 'Clear' })) return;

            localStorage.removeItem(CHAT_STORAGE_KEY);

            // Clear from backend too
            fetch(`${API_URL}/chat/history`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            }).catch(() => {});

            // Reset the chat view
            const container = document.getElementById('messages');
            container.innerHTML = '';
            const welcomeText = `Hey ${CEREBRO_USERNAME}! I'm Cerebro, your AI command center. I can spawn agents, search your memory, run automations, or help with anything else. What do you need?`;
            const welcomeMsg = buildAssistantCard(welcomeText, { timestamp: 'Welcome' });
            container.appendChild(welcomeMsg);

            // Generate new session ID
            sessionId = 'session_' + Math.random().toString(36).substring(2, 10);
            document.getElementById('session-id').textContent = sessionId.substring(0, 8) + '...';
        }

        // Debounced save to avoid too many writes
        let saveTimeout = null;
        function debouncedSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveChatHistory, 1000);
        }

        // ==================== QUICK ACTIONS ====================
        async function runQuickAction(command) {
            // Visual feedback
            const btn = event?.target?.closest('.action-btn');
            if (btn) btn.classList.add('active');

            // Switch to chat immediately for better UX
            switchView('chat');
            addMessage(`Run: ${command}`, 'user');

            // Show loading
            const assistantMsg = addMessage('', 'assistant');
            const qaWrapper = assistantMsg.querySelector('.assistant-card-body .message-content-wrapper');
            if (qaWrapper) qaWrapper.innerHTML = '<div class="thinking-orb-container"><div class="thinking-orb-dot"></div><span class="thinking-orb-label">Running...</span></div>';

            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: `Run this command: ${command}`,
                        session_id: sessionId,
                        model: getSelectedModel()
                    })
                });

                const data = await response.json();
                if (qaWrapper) qaWrapper.innerHTML = safeMarkdown(data.content || 'Done!');
                assistantMsg.setAttribute('data-text', data.content || 'Done!');

            } catch (e) {
                console.error('Quick action error:', e);
                if (qaWrapper) qaWrapper.textContent = 'Error: Could not execute command';
            }

            if (btn) {
                setTimeout(() => btn.classList.remove('active'), 200);
            }
        }

        // ==================== VOICE ====================
        function initVoice() {
            const hasWebkit = 'webkitSpeechRecognition' in window;
            const hasStandard = 'SpeechRecognition' in window;
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            console.log('[Voice] initVoice - webkit:', hasWebkit, 'standard:', hasStandard, 'mobile:', isMobile, 'iOS:', isIOS);

            if (!hasWebkit && !hasStandard) {
                const msg = isMobile
                    ? (isIOS ? 'Voice mode requires desktop Chrome (not supported on iOS)' : 'Voice not supported - try desktop Chrome')
                    : 'Voice requires Chrome or Edge browser';
                console.error('[Voice] Speech Recognition NOT available:', msg);
                showToast(msg);
                updateVoiceStatus();
                return;
            }
            if (hasWebkit || hasStandard) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                console.log('[Voice] Recognition initialized:', !!recognition);
                updateVoiceStatus();

                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    console.log('[Voice] Transcript:', transcript);
                    document.getElementById('voice-transcript').textContent = transcript;
                    document.getElementById('chat-input').value = transcript;

                    // Auto-stop after silence in conversational mode
                    if (conversationalMode && transcript.trim()) {
                        clearTimeout(silenceTimer);
                        console.log('[Conv] Setting 2s silence timer...');
                        silenceTimer = setTimeout(() => {
                            console.log('[Conv] Silence timer fired, stopping voice');
                            if (isRecording && conversationalMode) {
                                stopVoice();
                            }
                        }, 2000); // 2 second silence = end of utterance
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech error:', event.error);
                    stopVoice();
                };

                recognition.onend = () => {
                    if (isRecording) {
                        stopVoice();
                    }
                };
            } else {
                console.log('[Voice] Speech recognition NOT supported in this browser');
                document.getElementById('voice-btn').style.display = 'none';
                updateVoiceStatus();
            }
        }

        function startVoice() {
            if (!recognition) return;

            // Stop TTS if speaking (prevents mic picking up speaker output)
            if (isSpeaking) stopSpeaking();

            isRecording = true;
            document.getElementById('voice-overlay').classList.add('active');
            document.getElementById('voice-btn').classList.add('recording');
            document.getElementById('voice-transcript').textContent = '';

            try {
                recognition.start();
            } catch (e) {
                console.error('Voice start error:', e);
            }
        }

        function stopVoice() {
            if (!recognition) return;

            clearTimeout(silenceTimer);
            isRecording = false;
            document.getElementById('voice-overlay').classList.remove('active');
            document.getElementById('voice-btn').classList.remove('recording');

            try {
                recognition.stop();
            } catch (e) {
                console.error('Voice stop error:', e);
            }

            // Auto-send if there's content
            const input = document.getElementById('chat-input');
            console.log('[Voice] stopVoice - input value:', input.value);
            if (input.value.trim()) {
                console.log('[Conv] Sending message:', input.value.trim().substring(0, 50));
                setTimeout(() => {
                    switchView('chat');
                    sendMessage();
                }, 300);
            } else {
                console.log('[Conv] No content to send');
            }

            // Remove listening state from orb
            document.getElementById('nav-orb-container')?.classList.remove('listening');
        }

        // ==================== TTS ====================
        async function speak(text) {
            if (isSpeaking) { stopSpeaking(); return; }

            // Strip markdown for cleaner speech
            text = text
                .replace(/```[\s\S]*?```/g, ' code block ')
                .replace(/\*\*([^*]+)\*\*/g, '$1')
                .replace(/\*([^*]+)\*/g, '$1')
                .replace(/#{1,6}\s/g, '')
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
                .replace(/`([^`]+)`/g, '$1')
                .replace(/\n{2,}/g, '. ')
                .replace(/\n/g, ' ')
                .trim();
            if (text.length > 500) {
                var cp = text.lastIndexOf('.', 500);
                if (cp < 200) cp = text.lastIndexOf(' ', 500);
                if (cp < 200) cp = 500;
                text = text.substring(0, cp + 1);
            }
            if (!text) return;

            try {
                setSpeakingState(true, 'loading');
                const response = await fetch(`${TTS_URL}/v1/audio/speech`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: 'kokoro', input: text, voice: TTS_CONFIG.voice, response_format: 'mp3', speed: TTS_CONFIG.speed })
                });

                if (!response.ok) throw new Error('TTS failed');

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                currentAudio = new Audio(audioUrl);
                // Apply selected speaker output if browser supports it
                if (selectedSpeakerId && currentAudio.setSinkId) {
                    try { await currentAudio.setSinkId(selectedSpeakerId); } catch(e) {}
                }
                setSpeakingState(true, 'speaking');

                currentAudio.onended = () => {
                    console.log('[TTS] Audio ended, conversationalMode:', conversationalMode);
                    setSpeakingState(false);
                    URL.revokeObjectURL(audioUrl);
                    currentAudio = null;
                    // Auto-listen after speaking in conversational mode
                    if (conversationalMode) {
                        console.log('[Conv] Will start listening in 300ms...');
                        setTimeout(() => startConversationalListen(), 300);
                    }
                };
                currentAudio.onerror = () => { setSpeakingState(false); showToast('Audio failed'); };

                await currentAudio.play();
            } catch (e) {
                console.error('TTS error:', e);
                setSpeakingState(false);
                // Fallback to browser speech synthesis
                try {
                    if (window.speechSynthesis) {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.rate = TTS_CONFIG.speed;
                        utterance.onend = () => {
                            setSpeakingState(false);
                            if (conversationalMode) {
                                setTimeout(() => startConversationalListen(), 300);
                            }
                        };
                        setSpeakingState(true);
                        window.speechSynthesis.speak(utterance);
                    } else {
                        showToast('Voice unavailable');
                    }
                } catch (fallbackErr) {
                    showToast('Voice unavailable');
                }
            }
        }

        function stopSpeaking() {
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            setSpeakingState(false);
        }

        function setSpeakingState(speaking, phase) {
            isSpeaking = speaking;
            const orb = document.getElementById('nav-orb-container');
            if (orb) {
                if (!speaking) {
                    orb.classList.remove('speaking', 'loading-tts');
                } else if (phase === 'loading') {
                    orb.classList.add('loading-tts');
                    orb.classList.remove('speaking');
                } else {
                    orb.classList.add('speaking');
                    orb.classList.remove('loading-tts');
                }
            }
        }

        // Speak a specific chat message (used by the speaker button on each message)
        let currentSpeakingBtn = null;
        async function speakMessageContent(messageElement, btnElement) {
            var rawText = messageElement.getAttribute('data-text');
            if (!rawText) return;
            // Strip markdown for cleaner speech
            var text = rawText
                .replace(/```[\s\S]*?```/g, ' code block ')
                .replace(/\*\*([^*]+)\*\*/g, '$1')
                .replace(/\*([^*]+)\*/g, '$1')
                .replace(/#{1,6}\s/g, '')
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
                .replace(/`([^`]+)`/g, '$1')
                .replace(/[\-*]{3,}/g, '')
                .replace(/^[\s]*[\-*+]\s/gm, '')
                .replace(/^[\s]*\d+\.\s/gm, '')
                .replace(/\n{2,}/g, '. ')
                .replace(/\n/g, ' ')
                .trim();
            if (text.length > 500) {
                var ci = text.lastIndexOf('.', 500);
                if (ci < 200) ci = text.lastIndexOf(' ', 500);
                if (ci < 200) ci = 500;
                text = text.substring(0, ci + 1);
            }

            // If already speaking this message, stop
            if (isSpeaking && currentSpeakingBtn === btnElement) {
                stopSpeaking();
                btnElement.classList.remove('speaking');
                currentSpeakingBtn = null;
                return;
            }

            // Stop any other speech and clear previous button state
            if (isSpeaking) {
                stopSpeaking();
            }
            if (currentSpeakingBtn) {
                currentSpeakingBtn.classList.remove('speaking');
            }

            // Set this button as loading (immediate visual feedback)
            currentSpeakingBtn = btnElement;
            btnElement.classList.add('loading');

            try {
                setSpeakingState(true, 'loading');
                const response = await fetch(`${TTS_URL}/v1/audio/speech`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: 'kokoro', input: text, voice: TTS_CONFIG.voice, response_format: 'mp3', speed: TTS_CONFIG.speed })
                });

                if (!response.ok) throw new Error('TTS failed');

                // Switch from loading spinner to speaking pulse
                btnElement.classList.remove('loading');
                btnElement.classList.add('speaking');

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                currentAudio = new Audio(audioUrl);
                // Apply selected speaker output if browser supports it
                if (selectedSpeakerId && currentAudio.setSinkId) {
                    try { await currentAudio.setSinkId(selectedSpeakerId); } catch(e) {}
                }
                setSpeakingState(true, 'speaking');

                currentAudio.onended = () => {
                    setSpeakingState(false);
                    URL.revokeObjectURL(audioUrl);
                    currentAudio = null;
                    if (currentSpeakingBtn) {
                        currentSpeakingBtn.classList.remove('speaking', 'loading');
                        currentSpeakingBtn = null;
                    }
                };
                currentAudio.onerror = () => {
                    setSpeakingState(false);
                    if (currentSpeakingBtn) {
                        currentSpeakingBtn.classList.remove('speaking', 'loading');
                        currentSpeakingBtn = null;
                    }
                    showToast('Audio failed');
                };

                await currentAudio.play();
            } catch (e) {
                console.error('TTS error:', e);
                setSpeakingState(false);
                if (currentSpeakingBtn) {
                    currentSpeakingBtn.classList.remove('speaking', 'loading');
                    currentSpeakingBtn = null;
                }
                // Fallback to browser speech synthesis
                try {
                    if (window.speechSynthesis) {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.rate = 1.0;
                        utterance.onend = () => {
                            if (currentSpeakingBtn) {
                                currentSpeakingBtn.classList.remove('speaking');
                                currentSpeakingBtn = null;
                            }
                        };
                        window.speechSynthesis.speak(utterance);
                        currentSpeakingBtn = btnElement;
                        btnElement.classList.add('speaking');
                    } else {
                        showToast('Voice unavailable');
                    }
                } catch (fallbackErr) {
                    showToast('Voice unavailable');
                }
            }
        }


        // ==================== VOICE SETTINGS ====================
        let _voicePreviewAudio = null;

        function selectVoice(voice) {
            TTS_CONFIG.voice = voice;
            localStorage.setItem('cerebro_tts_voice', voice);
            // Update UI
            document.querySelectorAll('.voice-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.voice === voice);
            });
        }

        function updateVoiceSpeed(value) {
            const speed = parseFloat(value);
            TTS_CONFIG.speed = speed;
            localStorage.setItem('cerebro_tts_speed', speed.toString());
            document.getElementById('voice-speed-display').textContent = speed.toFixed(1) + 'x';
        }

        function toggleAutoSpeak() {
            TTS_CONFIG.autoSpeak = !TTS_CONFIG.autoSpeak;
            localStorage.setItem('cerebro_tts_autospeak', TTS_CONFIG.autoSpeak.toString());
            document.getElementById('autospeak-toggle').classList.toggle('active', TTS_CONFIG.autoSpeak);
        }

        async function previewVoice(voice, btnEl) {
            // Stop any current preview
            if (_voicePreviewAudio) {
                _voicePreviewAudio.pause();
                _voicePreviewAudio = null;
                document.querySelectorAll('.voice-preview-btn.playing').forEach(b => b.classList.remove('playing'));
            }

            btnEl.classList.add('playing');

            try {
                const response = await fetch(`${TTS_URL}/v1/audio/speech`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'kokoro',
                        input: 'Hello Professor, I am Cerebro. How can I help you today?',
                        voice: voice,
                        response_format: 'wav',
                        speed: TTS_CONFIG.speed
                    })
                });

                if (!response.ok) throw new Error('TTS preview failed');

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                _voicePreviewAudio = new Audio(url);
                _voicePreviewAudio.onended = () => {
                    btnEl.classList.remove('playing');
                    URL.revokeObjectURL(url);
                    _voicePreviewAudio = null;
                };
                _voicePreviewAudio.onerror = () => {
                    btnEl.classList.remove('playing');
                    _voicePreviewAudio = null;
                };
                await _voicePreviewAudio.play();
            } catch (e) {
                console.error('Voice preview error:', e);
                btnEl.classList.remove('playing');
                showToast('Voice preview failed');
            }
        }

        async function testCurrentVoice() {
            const greetings = [
                'Systems online. All modules nominal, Professor.',
                'Cerebro standing by. What would you like me to work on?',
                'I have analyzed the data. Ready to present findings.',
                'Running diagnostics. Everything checks out.'
            ];
            const text = greetings[Math.floor(Math.random() * greetings.length)];
            await speak(text);
        }

        function initVoiceSettings() {
            // Restore saved voice selection
            const savedVoice = localStorage.getItem('cerebro_tts_voice') || 'af_heart';
            selectVoice(savedVoice);

            // Restore speed
            const savedSpeed = parseFloat(localStorage.getItem('cerebro_tts_speed') || '1.0');
            const slider = document.getElementById('voice-speed-slider');
            if (slider) {
                slider.value = savedSpeed;
                document.getElementById('voice-speed-display').textContent = savedSpeed.toFixed(1) + 'x';
            }

            // Restore auto-speak
            if (TTS_CONFIG.autoSpeak) {
                const toggle = document.getElementById('autospeak-toggle');
                if (toggle) toggle.classList.add('active');
            }
        }
        function getCerebroGreeting() {
            const hour = new Date().getHours();
            const time = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
            return `${time} ${CEREBRO_USERNAME}. I am Cerebro. How may I assist you today?`;
        }

        // ==================== AUDIO DEVICES ====================
        let selectedMicId = null;
        let selectedSpeakerId = null;

        async function loadAudioDevices() {
            // Guard: if mediaDevices API not available (insecure context), bail gracefully
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                console.warn('[Audio] mediaDevices API not available (needs HTTPS or localhost)');
                var voiceStatus = document.getElementById('voice-status');
                if (voiceStatus) voiceStatus.textContent = 'Audio API unavailable';
                return;
            }

            try {
                var devices = await navigator.mediaDevices.enumerateDevices();
                var hasLabels = devices.some(function(d) { return d.label; });

                if (!hasLabels) {
                    // No labels  need mic permission first. Add hint option.
                    var micSelect = document.getElementById('mic-select');
                    if (micSelect) {
                        var hint = document.createElement('option');
                        hint.value = '__request_permission__';
                        hint.textContent = 'Grant access via Test Mic button';
                        micSelect.appendChild(hint);
                    }
                    updateVoiceStatus();
                    console.log('[Audio] No labels yet  permission needed');
                    return;
                }

                populateDeviceSelects(devices);
                updateVoiceStatus();
                console.log('[Audio] Devices loaded:', devices.length);
            } catch (e) {
                console.error('[Audio] enumerateDevices failed:', e);
                updateVoiceStatus();
            }
        }

        function populateDeviceSelects(devices) {
            const micSelect = document.getElementById('mic-select');
            const speakerSelect = document.getElementById('speaker-select');
            const savedMic = localStorage.getItem('cerebro_mic_id');
            const savedSpeaker = localStorage.getItem('cerebro_speaker_id');

            if (micSelect) {
                while (micSelect.firstChild) micSelect.removeChild(micSelect.firstChild);
                const defOpt = document.createElement('option');
                defOpt.value = '';
                defOpt.textContent = 'Default Microphone';
                micSelect.appendChild(defOpt);

                devices.filter(d => d.kind === 'audioinput').forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.deviceId;
                    opt.textContent = d.label || ('Microphone ' + micSelect.options.length);
                    if (d.deviceId === savedMic) opt.selected = true;
                    micSelect.appendChild(opt);
                });
                if (savedMic) selectedMicId = savedMic;
            }

            if (speakerSelect) {
                // Firefox doesn't support audiooutput enumeration
                const outputs = devices.filter(d => d.kind === 'audiooutput');
                while (speakerSelect.firstChild) speakerSelect.removeChild(speakerSelect.firstChild);

                if (outputs.length === 0) {
                    const defOpt = document.createElement('option');
                    defOpt.value = '';
                    defOpt.textContent = 'System Default (browser managed)';
                    speakerSelect.appendChild(defOpt);
                    speakerSelect.disabled = true;
                } else {
                    const defOpt = document.createElement('option');
                    defOpt.value = '';
                    defOpt.textContent = 'Default Speaker';
                    speakerSelect.appendChild(defOpt);
                    speakerSelect.disabled = false;
                    outputs.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.deviceId;
                        opt.textContent = d.label || ('Speaker ' + speakerSelect.options.length);
                        if (d.deviceId === savedSpeaker) opt.selected = true;
                        speakerSelect.appendChild(opt);
                    });
                    if (savedSpeaker) selectedSpeakerId = savedSpeaker;
                }
            }
        }

        // Re-enumerate after permission is granted (called after testMicrophone)
        async function refreshAudioDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                populateDeviceSelects(devices);
                updateVoiceStatus();
            } catch (e) {
                console.error('[Audio] Refresh devices failed:', e);
            }
        }

        function selectMicrophone(deviceId) {
            if (deviceId === '__request_permission__') {
                testMicrophone();
                return;
            }
            selectedMicId = deviceId || null;
            localStorage.setItem('cerebro_mic_id', deviceId || '');
            console.log('[Audio] Mic selected:', deviceId);
            showToast('Microphone updated');
        }

        function selectSpeaker(deviceId) {
            selectedSpeakerId = deviceId || null;
            localStorage.setItem('cerebro_speaker_id', deviceId || '');
            if (currentAudio && currentAudio.setSinkId && deviceId) {
                currentAudio.setSinkId(deviceId).catch(function(){});
            }
            console.log('[Audio] Speaker selected:', deviceId);
            showToast('Speaker updated');
        }

        async function testMicrophone() {
            showToast('Requesting microphone access...');
            const voiceStatus = document.getElementById('voice-status');
            try {
                const constraints = selectedMicId && selectedMicId !== '__request_permission__'
                    ? { audio: { deviceId: { exact: selectedMicId } } }
                    : { audio: true };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);

                if (voiceStatus) voiceStatus.textContent = 'Listening...';
                showToast('Listening for 3 seconds...');

                setTimeout(function() {
                    stream.getTracks().forEach(function(t) { t.stop(); });
                    if (voiceStatus) voiceStatus.textContent = 'Mic works!';
                    showToast('Microphone test passed');
                    // Now that we have permission, refresh device lists with labels
                    refreshAudioDevices();
                }, 3000);
            } catch (e) {
                console.error('[Audio] Mic test failed:', e);
                if (voiceStatus) voiceStatus.textContent = 'Permission denied';
                if (e.name === 'NotAllowedError') {
                    showToast('Microphone permission denied. Check browser settings.');
                } else if (e.name === 'NotFoundError') {
                    showToast('No microphone found');
                } else {
                    showToast('Microphone test failed');
                }
            }
        }

        function testSpeaker() {
            speak('Testing speaker. Can you hear me?');
        }

        function updateVoiceStatus() {
            var voiceStatus = document.getElementById('voice-status');
            if (!voiceStatus) return;

            var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            var isFirefox = navigator.userAgent.indexOf('Firefox') !== -1;

            // Update speaker select for Firefox (no setSinkId support)
            if (isFirefox) {
                var speakerSelect = document.getElementById('speaker-select');
                if (speakerSelect && !speakerSelect.disabled) {
                    while (speakerSelect.firstChild) speakerSelect.removeChild(speakerSelect.firstChild);
                    var opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'System Default (Firefox)';
                    speakerSelect.appendChild(opt);
                    speakerSelect.disabled = true;
                }
            }

            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                voiceStatus.textContent = isIOS ? 'Not supported on iOS' : (isMobile ? 'Use desktop Chrome' : (isFirefox ? 'STT: Chrome/Edge only' : 'Use Chrome/Edge'));
                voiceStatus.className = 'settings-value';
                voiceStatus.style.color = '#ef4444';
            } else if (recognition) {
                voiceStatus.textContent = 'Ready';
                voiceStatus.className = 'settings-value success';
            } else {
                voiceStatus.textContent = 'TTS ready, STT not initialized';
                voiceStatus.className = 'settings-value';
            }
        }

        // ==================== CONVERSATIONAL MODE ====================
        function startConversationalMode() {
            // Ensure voice is initialized
            if (!recognition) {
                console.log('[Conv] Recognition not ready, initializing...');
                initVoice();
            }
            if (!recognition) {
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                showToast(isIOS ? 'Voice mode requires desktop (not iOS)' : 'Voice not supported - use desktop Chrome');
                return;
            }
            conversationalMode = true;
            document.getElementById('nav-orb-container')?.classList.add('conversational');
            showToast('Voice mode active');
            speak(getCerebroGreeting());
        }

        function stopConversationalMode() {
            conversationalMode = false;
            document.getElementById('nav-orb-container')?.classList.remove('conversational', 'listening');
            if (isRecording) stopVoice();
            if (isSpeaking) stopSpeaking();
            showToast('Voice mode ended');
        }

        function startConversationalListen() {
            if (!conversationalMode || !recognition) {
                console.log('[Conv] Cannot start listen - mode:', conversationalMode, 'recognition:', !!recognition);
                return;
            }

            console.log('[Conv] Starting to listen...');
            document.getElementById('nav-orb-container')?.classList.add('listening');
            isRecording = true;
            document.getElementById('voice-overlay').classList.add('active');
            document.getElementById('voice-transcript').textContent = '';

            try {
                recognition.start();
                console.log('[Conv] Recognition started');
            } catch (e) {
                console.error('[Conv] Listen error:', e);
                stopConversationalMode();
            }
        }

        // ==================== AGENTS ====================
        let agents = {};

        // Helper: Check if sub-agent belongs to parent's current run
        // Filters out stale sub-agents from previous tasks/continuations
        function isCurrentRunSubAgent(child, parent) {
            if (!child || !parent) return false;

            const childName = child.call_sign || child.id;
            const childId = child.id;

            // If parent has output that mentions this sub-agent, it's from current run
            if (parent.output && parent.output.length > 0) {
                if (parent.output.includes(childName) || parent.output.includes(childId)) {
                    return true;
                }
                // If parent has substantial output but doesn't mention this child,
                // it's likely from a previous run
                if (parent.output.length > 200) {
                    return false;
                }
            }

            // If parent is still running or has minimal output, use time-based filtering
            // Sub-agent must have been created after parent started (with small buffer)
            if (parent.started_at) {
                const parentStarted = new Date(parent.started_at);
                const childCreated = new Date(child.created_at);
                // 10 second buffer for timing discrepancies
                return childCreated >= new Date(parentStarted.getTime() - 10000);
            }

            // Fallback: include if created within reasonable window of parent
            const parentCreated = new Date(parent.created_at);
            const childCreated = new Date(child.created_at);
            return childCreated >= parentCreated;
        }

        async function loadAgents() {
            try {
                // Load active/recent agents from memory
                const response = await fetch(`${API_URL}/agents`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                data.agents.forEach(agent => {
                    agents[agent.id] = agent;
                });

                // Also load from persistent history (including archived)
                try {
                    const historyResponse = await fetch(`${API_URL}/agents/history?limit=50&include_archived=true`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const historyData = await historyResponse.json();

                    // Also load archived agents
                    const allHistoryAgents = [
                        ...(historyData.agents || []),
                        ...(historyData.archived || [])
                    ];

                    // Merge history agents (don't overwrite active ones)
                    for (const agent of allHistoryAgents) {
                        if (!agents[agent.id]) {
                            // Load full details for history agents
                            try {
                                const detailResponse = await fetch(`${API_URL}/agents/history/${agent.id}`, {
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                if (detailResponse.ok) {
                                    const fullAgent = await detailResponse.json();
                                    agents[agent.id] = fullAgent;
                                } else {
                                    // Use basic info if detail fetch fails
                                    agents[agent.id] = {
                                        ...agent,
                                        output: '(Output not loaded - tap to view)',
                                        status: agent.status || 'completed'
                                    };
                                }
                            } catch (e) {
                                agents[agent.id] = { ...agent, output: '', status: agent.status || 'completed' };
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Failed to load agent history:', e);
                }

                renderAgents();
            } catch (e) {
                console.error('Failed to load agents:', e);
            }
        }

        function renderAgents() {
            const container = document.getElementById('agents-container');
            const archivedContainer = document.getElementById('archived-agents-container');

            const allAgents = Object.values(agents).sort((a, b) =>
                new Date(b.created_at) - new Date(a.created_at)
            );

            // Scheduler agents are routed to the Idle tab via getAgentSource()
            const nonSchedulerAgents = allAgents;

            // Filter by active tab source
            const tabAgents = nonSchedulerAgents.filter(a => getAgentSource(a) === activeAgentsTab);

            // Split into active and archived
            const activeAgents = tabAgents.filter(a => !a.archived);
            const archivedAgents = tabAgents.filter(a => a.archived);

            // Group child agents by parent (filter to current run only)
            const childAgentsByParent = {};
            const parentAgents = [];

            for (const agent of activeAgents) {
                if (agent.parent_agent_id) {
                    const parent = agents[agent.parent_agent_id];
                    if (parent && isCurrentRunSubAgent(agent, parent)) {
                        if (!childAgentsByParent[agent.parent_agent_id]) {
                            childAgentsByParent[agent.parent_agent_id] = [];
                        }
                        childAgentsByParent[agent.parent_agent_id].push(agent);
                    }
                } else {
                    parentAgents.push(agent);
                }
            }

            // Sort children by created_at within each parent
            for (const parentId in childAgentsByParent) {
                childAgentsByParent[parentId].sort((a, b) =>
                    new Date(a.created_at) - new Date(b.created_at)
                );
            }

            const runningCount = activeAgents.filter(a => a.status === 'running' || a.status === 'queued').length;
            document.getElementById('agents-count').textContent = `${runningCount} running`;
            document.getElementById('archived-count').textContent = `(${archivedAgents.length})`;

            // Empty state messages per tab
            const emptyMessages = {
                user: 'Spawn agents from the button below or chat',
                cerebro: 'Cerebro will spawn agents when processing directives',
                idle: 'Idle task agents appear during downtime'
            };

            // Render only parent agents (children are nested inside)
            if (parentAgents.length === 0) {
                const noAgentsDiv = document.createElement('div');
                noAgentsDiv.className = 'no-agents';
                noAgentsDiv.innerHTML = '<div class="no-agents-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="8" r="5"/><path d="M3 21v-2a7 7 0 0 1 7-7h4a7 7 0 0 1 7 7v2"/></svg></div>';
                const titleDiv = document.createElement('div');
                titleDiv.textContent = 'No agents running';
                const subtitleDiv = document.createElement('div');
                subtitleDiv.style.cssText = 'font-size: 0.85rem; margin-top: 8px; color: var(--text-muted);';
                subtitleDiv.textContent = emptyMessages[activeAgentsTab] || emptyMessages.user;
                noAgentsDiv.appendChild(titleDiv);
                noAgentsDiv.appendChild(subtitleDiv);
                container.replaceChildren(noAgentsDiv);
            } else {
                container.innerHTML = parentAgents.map(agent =>
                    renderAgentCard(agent, false, childAgentsByParent[agent.id] || [])
                ).join('');
            }

            // Group archived child agents by parent
            const archivedChildrenByParent = {};
            const archivedParentAgents = [];

            for (const agent of archivedAgents) {
                if (agent.parent_agent_id) {
                    const parent = agents[agent.parent_agent_id];
                    if (parent && isCurrentRunSubAgent(agent, parent)) {
                        if (!archivedChildrenByParent[agent.parent_agent_id]) {
                            archivedChildrenByParent[agent.parent_agent_id] = [];
                        }
                        archivedChildrenByParent[agent.parent_agent_id].push(agent);
                    }
                } else {
                    archivedParentAgents.push(agent);
                }
            }

            // Render archived agents
            if (archivedContainer) {
                if (archivedParentAgents.length === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.style.cssText = 'text-align: center; padding: 20px; color: var(--text-muted);';
                    emptyDiv.textContent = 'No archived agents';
                    archivedContainer.replaceChildren(emptyDiv);
                } else {
                    archivedContainer.innerHTML = archivedParentAgents.map(agent =>
                        renderAgentCard(agent, true, archivedChildrenByParent[agent.id] || [])
                    ).join('');
                }
            }

            // Show/hide archive section based on count
            const archiveSection = document.getElementById('archive-section');
            if (archiveSection) {
                archiveSection.style.display = archivedAgents.length > 0 || tabAgents.length > 0 ? 'block' : 'none';
            }

            // Reapply select mode class after re-render
            if (agentSelectMode) {
                container.classList.add('select-mode');
                if (archivedContainer) archivedContainer.classList.add('select-mode');
            }

            // Update floating agent status panel
            updateAgentsStatusPanel();
        }

        // ===== AGENTS STATUS PANEL (Floating) =====
        let agentsPanelExpanded = false;

        function toggleAgentsPanel() {
            const panel = document.getElementById('agents-status-panel');
            agentsPanelExpanded = !agentsPanelExpanded;
            panel.classList.toggle('expanded', agentsPanelExpanded);
        }

        function updateAgentsStatusPanel() {
            const panel = document.getElementById('agents-status-panel');
            const countEl = document.getElementById('agents-status-count');
            const bodyEl = document.getElementById('agents-status-body');

            if (!panel || !countEl || !bodyEl) return;

            // Get running/queued agents only (active agents)
            const activeAgents = Object.values(agents).filter(a =>
                a.status === 'running' || a.status === 'queued'
            );

            // Update count
            countEl.textContent = activeAgents.length;
            countEl.classList.toggle('zero', activeAgents.length === 0);

            // Highlight panel when agents are active
            panel.classList.toggle('has-agents', activeAgents.length > 0);

            // Render agent items
            if (activeAgents.length === 0) {
                bodyEl.innerHTML = '<div class="agents-status-empty">No active agents</div>';
            } else {
                bodyEl.innerHTML = activeAgents.map(agent => {
                    const displayName = agent.call_sign || agent.id;
                    const taskPreview = (agent.task || '').substring(0, 50) + ((agent.task || '').length > 50 ? '...' : '');
                    const agentType = agent.type || 'worker';

                    return `
                        <div class="agents-status-item" onclick="showAgentDetail('${agent.id}');">
                            <div class="agent-status-dot ${agent.status}"></div>
                            <div class="agent-status-info">
                                <div class="agent-status-name">${displayName}</div>
                                <div class="agent-status-task">${taskPreview}</div>
                            </div>
                            <span class="agent-status-type">${agentType}</span>
                        </div>
                    `;
                }).join('');
            }
        }

        // Call on initial load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(updateAgentsStatusPanel, 1000);
        });

        function renderAgentCard(agent, isArchived, childAgents = []) {
            const toolsHtml = (agent.tools_used || []).map(t =>
                `<span class="agent-tool">${t}</span>`
            ).join('');

            const timeAgo = getTimeAgo(agent.created_at);
            const outputPreview = agent.output ?
                agent.output.slice(-200).replace(/</g, '&lt;') : '';

            const hasOutput = agent.output && agent.output.length > 0;
            const statusIcon = agent.status === 'running' ? '' :
                               agent.status === 'completed' ? '' :
                               agent.status === 'failed' ? '' : '';

            const displayName = agent.call_sign || agent.id;
            const hasChildren = childAgents.length > 0;

            // Sub-agent count badge (clickable to expand)
            let subAgentBadge = '';
            if (hasChildren) {
                const runningChildren = childAgents.filter(c => c.status === 'running').length;
                const badgeText = runningChildren > 0
                    ? `${childAgents.length} sub-agents (${runningChildren} running)`
                    : `${childAgents.length} sub-agent${childAgents.length > 1 ? 's' : ''}`;
                subAgentBadge = `
                    <span class="sub-agent-count-badge" onclick="event.stopPropagation(); toggleSubAgents('${agent.id}')" title="Click to view sub-agents">
                        ${badgeText}
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </span>
                `;
            }

            // Render sub-agents section
            let subAgentsHtml = '';
            if (hasChildren) {
                const subAgentCards = childAgents.map(child => {
                    const childStatusIcon = child.status === 'running' ? '' :
                                           child.status === 'completed' ? '' :
                                           child.status === 'failed' ? '' : '';
                    const childName = child.call_sign || child.id;
                    const childTools = (child.tools_used || []).slice(0, 3).map(t =>
                        `<span class="sub-agent-tool">${t}</span>`
                    ).join('');
                    const moreTools = (child.tools_used || []).length > 3
                        ? `<span class="sub-agent-tool">+${child.tools_used.length - 3}</span>`
                        : '';

                    return `
                        <div class="sub-agent-card ${child.status}" onclick="event.stopPropagation(); showAgentDetail('${child.id}')">
                            <div class="sub-agent-header">
                                <span class="sub-agent-name">
                                     ${escapeHtml(childName)}
                                </span>
                                <span class="sub-agent-status ${child.status}">${childStatusIcon} ${child.status.toUpperCase()}</span>
                            </div>
                            <div class="sub-agent-task">${escapeHtml(child.task.slice(0, 100))}${child.task.length > 100 ? '...' : ''}</div>
                            ${childTools ? `<div class="sub-agent-tools">${childTools}${moreTools}</div>` : ''}
                        </div>
                    `;
                }).join('');

                subAgentsHtml = `
                    <div class="sub-agents-container" id="sub-agents-${agent.id}">
                        <div class="sub-agents-header">
                            <span class="sub-agents-title">Sub-Agents</span>
                        </div>
                        ${subAgentCards}
                    </div>
                `;
            }

            const archiveBtn = isArchived
                ? `<button class="agent-archive-btn" onclick="event.stopPropagation(); unarchiveAgent('${agent.id}')"> Unarchive</button>`
                : `<button class="agent-archive-btn" onclick="event.stopPropagation(); archiveAgent('${agent.id}')"> Archive</button>`;

            const isSelected = selectedAgentIds.has(agent.id);
            const selectCheckbox = `<div class="agent-select-checkbox ${isSelected ? 'checked' : ''}" onclick="toggleAgentSelection('${agent.id}', event)"></div>`;

            return `
                <div class="agent-card ${agent.status} ${isArchived ? 'archived' : ''} ${hasChildren ? 'has-children' : ''} ${isSelected ? 'selected' : ''}" onclick="if(agentSelectMode){toggleAgentSelection('${agent.id}', event)}else{showAgentDetail('${agent.id}')}" style="position: relative;" data-agent-id="${agent.id}">
                    ${selectCheckbox}
                    ${archiveBtn}
                    <div class="agent-header">
                        <span class="agent-id"> ${displayName} ${subAgentBadge}</span>
                        <span class="agent-status ${agent.status}">${statusIcon} ${agent.status.toUpperCase()}</span>
                    </div>
                    <div class="agent-task">${escapeHtml(agent.task.slice(0, 200))}${agent.task.length > 200 ? '...' : ''}</div>
                    ${toolsHtml ? `<div class="agent-tools">${toolsHtml}</div>` : ''}
                    ${outputPreview ? `<div class="agent-output">${outputPreview}</div>` : `<div class="agent-output" style="color: var(--text-muted); font-style: italic;">${agent.status === 'running' ? 'Working...' : agent.status === 'completed' ? 'No output captured' : 'Waiting...'}</div>`}
                    ${agent.error ? `<div style="color: var(--red); font-size: 0.8rem; margin-top: 8px;">Error: ${escapeHtml(agent.error)}</div>` : ''}
                    <div class="agent-time">${timeAgo}</div>
                    <div class="agent-expand-hint">Tap to view details</div>
                    ${subAgentsHtml}
                </div>
            `;
        }

        function toggleSubAgents(agentId) {
            const container = document.getElementById(`sub-agents-${agentId}`);
            const badge = document.querySelector(`[data-agent-id="${agentId}"] .sub-agent-count-badge`);

            if (container) {
                container.classList.toggle('expanded');
                if (badge) {
                    badge.classList.toggle('expanded');
                }
            }
        }

        // ===== AGENTS TAB CONTROL =====
        let activeAgentsTab = 'user';  // 'user', 'cerebro', 'idle'

        function getAgentSource(agent) {
            // Completed/failed scheduler agents route to idle tab for review
            if (agent.source === 'scheduler') return 'idle';
            // Explicit source field (new agents)
            if (agent.source) return agent.source;
            // Legacy fallback: directive_id implies cerebro
            if (agent.directive_id) return 'cerebro';
            // Default: user
            return 'user';
        }

        function switchAgentsTab(tab) {
            activeAgentsTab = tab;
            // Update tab buttons
            document.querySelectorAll('.agents-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            // Show/hide spawn button (only on 'user' tab)
            const spawnBtn = document.querySelector('.spawn-agent-btn');
            if (spawnBtn) spawnBtn.style.display = tab === 'user' ? '' : 'none';
            // Collapse archive when switching tabs
            archiveSectionExpanded = false;
            const icon = document.getElementById('archive-toggle-icon');
            const archContainer = document.getElementById('archived-agents-container');
            if (icon) icon.classList.remove('expanded');
            if (archContainer) archContainer.classList.add('hidden');
            // Re-render
            renderAgents();
        }

        let archiveSectionExpanded = false;

        function toggleArchiveSection() {
            archiveSectionExpanded = !archiveSectionExpanded;
            const icon = document.getElementById('archive-toggle-icon');
            const container = document.getElementById('archived-agents-container');

            if (archiveSectionExpanded) {
                icon.classList.add('expanded');
                container.classList.remove('hidden');
            } else {
                icon.classList.remove('expanded');
                container.classList.add('hidden');
            }
        }

        async function archiveAgent(agentId) {
            try {
                await fetch(`${API_URL}/agents/${agentId}/archive`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Update local cache
                if (agents[agentId]) {
                    agents[agentId].archived = true;
                    agents[agentId].archived_at = new Date().toISOString();
                }

                renderAgents();
            } catch (e) {
                console.error('Failed to archive agent:', e);
            }
        }

        async function unarchiveAgent(agentId) {
            try {
                await fetch(`${API_URL}/agents/${agentId}/unarchive`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Update local cache
                if (agents[agentId]) {
                    agents[agentId].archived = false;
                    agents[agentId].archived_at = null;
                }

                renderAgents();
            } catch (e) {
                console.error('Failed to unarchive agent:', e);
            }
        }

        function getTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        async function spawnAgent(task, agentType = 'worker') {
            try {
                // Check if this is a follow-up from another agent
                let parentAgentId = null;
                let context = null;

                if (window.pendingFollowUpParent) {
                    parentAgentId = window.pendingFollowUpParent.id;
                    // Include parent's output as context for better continuity
                    context = `Parent Agent: ${window.pendingFollowUpParent.call_sign}\nParent Task: ${window.pendingFollowUpParent.task}\n\nParent Output:\n${window.pendingFollowUpParent.output.slice(-6000)}`;
                    window.pendingFollowUpParent = null; // Clear after use
                }

                // Get attached context refs
                const contextRefs = getContextRefsForSend();

                const response = await fetch(`${API_URL}/agents`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task,
                        agent_type: agentType,
                        parent_agent_id: parentAgentId,
                        context: context,
                        context_refs: contextRefs
                    })
                });

                const data = await response.json();
                console.log('Agent spawned:', data);

                // Switch to agents view to see it running
                switchView('agents');

            } catch (e) {
                console.error('Failed to spawn agent:', e);
                alert('Failed to spawn agent');
            }
        }

        let selectedAgentRole = 'worker';
        let selectedWorkflowType = 'standard';
        let currentSpawnMode = 'single';
        let agentTimeout = 3600; // default 1 hour

        // Agent select mode (context fusion)
        let agentSelectMode = false;
        let selectedAgentIds = new Set();
        let mergeSelectedRole = 'worker';
        let mergeTimeout = 3600;

        function selectAgentTimeout(btn) {
            document.querySelectorAll('#agent-timeout-selector .timeout-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            agentTimeout = parseInt(btn.dataset.timeout);
        }

        function showSpawnAgentDialog() {
            document.body.classList.add('modal-open');
            document.getElementById('agent-modal').classList.add('active');
            document.getElementById('agent-task-input').value = '';
            document.getElementById('agent-task-input').focus();
            // Reset to single mode
            setSpawnMode('single');
            // Reset timeout to default
            agentTimeout = 3600;
            document.querySelectorAll('#agent-timeout-selector .timeout-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.timeout) === 3600);
            });
        }

        function closeAgentModal() {
            document.body.classList.remove('modal-open');
            document.getElementById('agent-modal').classList.remove('active');
            // Reset advanced options
            document.getElementById('advanced-options').classList.add('hidden');
            document.getElementById('advanced-arrow').textContent = '';
        }

        function selectRole(element) {
            document.querySelectorAll('.role-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedAgentRole = element.dataset.role;
        }

        // ==================== AGENT SELECT MODE (Context Fusion) ====================

        function toggleAgentSelectMode() {
            agentSelectMode = !agentSelectMode;
            const btn = document.getElementById('agent-select-toggle-btn');
            const container = document.getElementById('agents-container');
            const archivedContainer = document.getElementById('archived-agents-container');

            if (agentSelectMode) {
                btn.textContent = 'Cancel';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-danger');
                container.classList.add('select-mode');
                if (archivedContainer) archivedContainer.classList.add('select-mode');
            } else {
                btn.textContent = 'Select';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-secondary');
                container.classList.remove('select-mode');
                if (archivedContainer) archivedContainer.classList.remove('select-mode');
                clearAgentSelection();
            }
        }

        function toggleAgentSelection(agentId, event) {
            if (event) event.stopPropagation();
            if (!agentSelectMode) return;

            if (selectedAgentIds.has(agentId)) {
                selectedAgentIds.delete(agentId);
            } else {
                selectedAgentIds.add(agentId);
            }
            updateAgentSelectionUI();
        }

        function updateAgentSelectionUI() {
            // Update card visual states
            document.querySelectorAll('.agent-card[data-agent-id]').forEach(card => {
                const id = card.dataset.agentId;
                const checkbox = card.querySelector('.agent-select-checkbox');
                if (selectedAgentIds.has(id)) {
                    card.classList.add('selected');
                    if (checkbox) checkbox.classList.add('checked');
                } else {
                    card.classList.remove('selected');
                    if (checkbox) checkbox.classList.remove('checked');
                }
            });

            // Show/hide selection action bar
            const bar = document.getElementById('selection-action-bar');
            const count = selectedAgentIds.size;
            if (count > 0) {
                bar.style.display = 'flex';
                document.getElementById('selection-count').textContent = `${count} agent${count > 1 ? 's' : ''} selected`;
            } else {
                bar.style.display = 'none';
            }
        }

        function clearAgentSelection() {
            selectedAgentIds.clear();
            updateAgentSelectionUI();
        }

        function showMergeSpawnModal() {
            // Populate the selected agents list using safe DOM methods
            const listEl = document.getElementById('merge-agent-list');
            listEl.textContent = ''; // Clear safely
            for (const agentId of selectedAgentIds) {
                const agent = agents[agentId];
                if (agent) {
                    const item = document.createElement('div');
                    item.className = 'merge-agent-item';

                    const callsign = document.createElement('span');
                    callsign.className = 'agent-callsign';
                    callsign.textContent = agent.call_sign || agent.id;

                    const badge = document.createElement('span');
                    badge.className = 'agent-type-badge';
                    badge.textContent = agent.type || 'worker';

                    const preview = document.createElement('span');
                    preview.className = 'agent-task-preview';
                    preview.textContent = agent.task.slice(0, 100);

                    item.appendChild(callsign);
                    item.appendChild(badge);
                    item.appendChild(preview);
                    listEl.appendChild(item);
                }
            }

            // Reset form
            document.getElementById('merge-task-input').value = '';
            mergeSelectedRole = 'worker';
            mergeTimeout = 3600;
            document.querySelectorAll('#merge-role-selector .role-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.role === 'worker');
            });
            document.querySelectorAll('#merge-timeout-selector .timeout-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.timeout) === 3600);
            });

            // Show modal
            document.body.classList.add('modal-open');
            document.getElementById('merge-spawn-modal').classList.add('active');
            setTimeout(() => document.getElementById('merge-task-input').focus(), 100);
        }

        function closeMergeSpawnModal() {
            document.body.classList.remove('modal-open');
            document.getElementById('merge-spawn-modal').classList.remove('active');
        }

        function selectMergeRole(element) {
            document.querySelectorAll('#merge-role-selector .role-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            mergeSelectedRole = element.dataset.role;
        }

        function selectMergeTimeout(btn) {
            document.querySelectorAll('#merge-timeout-selector .timeout-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            mergeTimeout = parseInt(btn.dataset.timeout);
        }

        async function submitMergeSpawn() {
            const task = document.getElementById('merge-task-input').value.trim();
            if (!task) {
                alert('Please enter a task description.');
                return;
            }
            if (selectedAgentIds.size === 0) {
                alert('No agents selected.');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/agents`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task,
                        agent_type: mergeSelectedRole,
                        source_agents: Array.from(selectedAgentIds),
                        timeout: mergeTimeout
                    })
                });

                const data = await response.json();
                console.log('Merged agent spawned:', data);

                // Close modal and exit select mode
                closeMergeSpawnModal();
                agentSelectMode = true; // force toggle off
                toggleAgentSelectMode();

                switchView('agents');
            } catch (e) {
                console.error('Failed to spawn merged agent:', e);
                alert('Failed to spawn merged agent');
            }
        }

        // ==================== END AGENT SELECT MODE ====================

        function setSpawnMode(mode) {
            currentSpawnMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            document.getElementById('single-agent-form').classList.toggle('hidden', mode !== 'single');
            document.getElementById('workflow-form').classList.toggle('hidden', mode !== 'workflow');

            // Update launch button text
            const launchBtn = document.getElementById('launch-btn');
            if (mode === 'workflow') {
                launchBtn.textContent = ' Deploy Workflow';
            } else {
                launchBtn.textContent = ' Launch Agent';
            }
        }

        function selectWorkflowType(element) {
            document.querySelectorAll('.workflow-type').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedWorkflowType = element.dataset.type;
        }

        function toggleAdvancedOptions() {
            const options = document.getElementById('advanced-options');
            const arrow = document.getElementById('advanced-arrow');
            if (options.classList.contains('hidden')) {
                options.classList.remove('hidden');
                arrow.textContent = '';
            } else {
                options.classList.add('hidden');
                arrow.textContent = '';
            }
        }

        function adjustAgentQty(agentType, delta) {
            const input = document.getElementById('qty-' + agentType);
            const newVal = Math.max(0, Math.min(5, parseInt(input.value || 0) + delta));
            input.value = newVal;
            updateTeamPreview();
        }

        function updateTeamPreview() {
            const preview = document.getElementById('team-preview');
            const icons = {
                'researcher': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
                'coder': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
                'worker': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
                'analyst': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>'
            };
            const names = {
                'researcher': 'Researcher',
                'coder': 'Coder',
                'worker': 'Worker',
                'analyst': 'Analyst'
            };

            let html = '';
            ['researcher', 'coder', 'worker', 'analyst'].forEach(agent => {
                const qty = parseInt(document.getElementById('qty-' + agent)?.value || 0);
                for (let i = 0; i < qty; i++) {
                    const suffix = qty > 1 ? ` #${i + 1}` : '';
                    html += `<div class="team-node"><span>${icons[agent]}</span> ${names[agent]}${suffix}</div>`;
                }
            });

            preview.innerHTML = html || '<div class="team-node" style="opacity: 0.5">No agents selected</div>';
        }

        function getTeamComposition() {
            const team = [];
            ['researcher', 'coder', 'worker', 'analyst'].forEach(agent => {
                const qty = parseInt(document.getElementById('qty-' + agent)?.value || 0);
                for (let i = 0; i < qty; i++) {
                    team.push(agent);
                }
            });
            return team;
        }

        // Update preview on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateTeamPreview();
        });

        function submitAgent() {
            if (currentSpawnMode === 'workflow') {
                submitWorkflow();
                return;
            }

            const task = document.getElementById('agent-task-input').value.trim();
            if (!task) {
                document.getElementById('agent-task-input').focus();
                return;
            }

            // Gather advanced options
            const context = document.getElementById('agent-context-input')?.value.trim() || null;
            const expectedOutputFormat = document.getElementById('agent-output-format')?.value || null;
            const priority = document.getElementById('agent-priority')?.value || 'normal';
            const resourcesRaw = document.getElementById('agent-resources-input')?.value.trim() || '';
            const resources = resourcesRaw ? resourcesRaw.split(',').map(r => r.trim()).filter(r => r) : null;

            // Build expected output description based on selection
            let expectedOutput = null;
            if (expectedOutputFormat) {
                const formatDescriptions = {
                    'summary': 'Provide a brief summary (2-3 paragraphs maximum)',
                    'detailed': 'Provide a comprehensive detailed report with sections',
                    'code': 'Output code only with minimal explanation',
                    'list': 'Format output as bullet points',
                    'json': 'Output structured JSON data'
                };
                expectedOutput = formatDescriptions[expectedOutputFormat];
            }

            spawnAgentEnhanced(task, selectedAgentRole, context, expectedOutput, priority, resources, agentTimeout);
            closeAgentModal();
        }

        async function spawnAgentEnhanced(task, agentType, context, expectedOutput, priority, resources, timeout = 3600) {
            try {
                const response = await fetch(`${API_URL}/agents`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task,
                        agent_type: agentType,
                        context,
                        expected_output: expectedOutput,
                        priority,
                        resources,
                        timeout
                    })
                });

                const data = await response.json();
                console.log('Agent spawned:', data);
                switchView('agents');
            } catch (e) {
                console.error('Failed to spawn agent:', e);
                alert('Failed to spawn agent');
            }
        }

        async function submitWorkflow() {
            const task = document.getElementById('workflow-task-input').value.trim();
            if (!task) {
                document.getElementById('workflow-task-input').focus();
                return;
            }

            // Get team composition with quantities
            const agentComposition = getTeamComposition();

            if (agentComposition.length === 0) {
                alert('Please select at least one team member');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/workflows`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task,
                        workflow_type: selectedWorkflowType,
                        agent_composition: agentComposition
                    })
                });

                const data = await response.json();
                console.log('Workflow deployed:', data);
                closeAgentModal();
                switchView('agents');
            } catch (e) {
                console.error('Failed to deploy workflow:', e);
                alert('Failed to deploy workflow');
            }
        }

        // Handle agent updates from WebSocket
        function handleAgentUpdate(agent) {
            agents[agent.id] = agent;
            renderAgents();
            updateCerebroStatus();  // Update presence card
            if (_currentMindTab === 'agents') renderMindAgents();
            updateAgentsTabBadge();
        }

        function handleAgentCompleted(agent) {
            agents[agent.id] = agent;
            renderAgents();
            updateCerebroStatus();  // Update presence card
            if (_currentMindTab === 'agents') renderMindAgents();
            updateAgentsTabBadge();

            // Also update detail modal if it's open for this agent
            if (currentDetailAgentId === agent.id) {
                showAgentDetail(agent.id);
            }

            // Show notification
            if (Notification.permission === 'granted') {
                new Notification('Agent Completed', {
                    body: agent.task.slice(0, 50) + '...'
                });
            }
        }

        // ==================== AGENT DETAIL PAGE ====================
        let currentDetailAgentId = null;

        function showAgentDetail(agentId) {
            const agent = agents[agentId];
            if (!agent) {
                console.error('Agent not found:', agentId);
                return;
            }

            currentDetailAgentId = agentId;

            // Mark agent as viewed
            fetch(`${API_URL}/agents/${agentId}/view`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            }).catch(console.error);

            // Update header - use call sign if available, otherwise ID
            const agentType = agent.type || 'worker';
            const typeEmoji = agentType === 'researcher' ? '' :
                              agentType === 'coder' ? '' :
                              agentType === 'analyst' ? '' : '';

            const displayName = agent.call_sign || agent.id;
            let titleText = `${typeEmoji} Agent ${displayName}`;

            // Show continuation count if this agent has been continued
            if (agent.continuation_count && agent.continuation_count > 0) {
                titleText += ` [Run #${agent.continuation_count + 1}]`;
            }

            // Show parent relationship if this is a follow-up
            if (agent.parent_agent_id) {
                const parentAgent = agents[agent.parent_agent_id];
                const parentName = parentAgent ? (parentAgent.call_sign || parentAgent.id) : agent.parent_agent_id;
                titleText += ` ( from ${parentName})`;
            }

            document.getElementById('agent-page-title').textContent = titleText;

            // Clear chat messages and hide ask input
            document.getElementById('agent-chat-messages').innerHTML = '';
            document.getElementById('agent-ask-area').style.display = 'none';

            // Load any existing conversation for this agent
            if (agent.conversation && agent.conversation.length > 0) {
                renderAgentConversation(agent.conversation);
            }

            const statusBadge = document.getElementById('agent-page-status');
            statusBadge.textContent = agent.status.toUpperCase();
            statusBadge.className = `agent-status-badge ${agent.status}`;

            // Calculate duration
            const duration = agent.completed_at && agent.started_at ?
                formatDuration(new Date(agent.completed_at) - new Date(agent.started_at)) :
                (agent.started_at ? 'Running...' : 'Queued');

            // Build tools HTML
            const toolsHtml = agent.tools_used.length > 0 ?
                agent.tools_used.map(t => `<span class="agent-tool-badge">${t}</span>`).join('') :
                '<span style="color: var(--text-muted);">No tools used yet</span>';

            // Get output and render as markdown
            const outputText = agent.output || 'No output captured yet.';
            let renderedOutput = '';
            try {
                // Configure marked for safety
                if (typeof marked !== 'undefined') {
                    marked.setOptions({
                        breaks: true,
                        gfm: true
                    });
                    renderedOutput = marked.parse(outputText);
                } else {
                    renderedOutput = `<pre>${escapeHtml(outputText)}</pre>`;
                }
            } catch (e) {
                console.error('Markdown parse error:', e);
                renderedOutput = `<pre>${escapeHtml(outputText)}</pre>`;
            }

            // Extract recommendations from output
            const recommendations = extractRecommendations(outputText);

            // Build recommendations section
            let recommendationsHtml = '';
            if (recommendations.length > 0) {
                const recsItems = recommendations.map((rec, i) => `
                    <div class="recommendation-item">
                        <div class="recommendation-text">${escapeHtml(rec)}</div>
                        <button class="recommendation-btn" onclick="executeRecommendation(${i})">
                            Execute
                        </button>
                    </div>
                `).join('');

                recommendationsHtml = `
                    <div class="recommendations-section">
                        <div class="recommendations-title">
                             Recommended Actions
                        </div>
                        ${recsItems}
                    </div>
                `;
            }

            // Build sub-agents section (if this is a parent agent)
            // Filter to only show sub-agents from the CURRENT run (not previous tasks)
            let subAgentsHtml = '';
            const childAgents = Object.values(agents).filter(a =>
                a.parent_agent_id === agent.id && isCurrentRunSubAgent(a, agent)
            );
            if (childAgents.length > 0) {
                // Sort by created_at
                childAgents.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

                const subAgentCards = childAgents.map(child => {
                    const childStatusIcon = child.status === 'running' ? '' :
                                           child.status === 'completed' ? '' :
                                           child.status === 'failed' ? '' : '';
                    const childName = child.call_sign || child.id;

                    return `
                        <div class="sub-agent-nav-card ${child.status}" onclick="showAgentDetail('${child.id}')">
                            <div class="sub-agent-nav-name"> ${escapeHtml(childName)}</div>
                            <div class="sub-agent-nav-task">${escapeHtml(child.task.slice(0, 80))}${child.task.length > 80 ? '...' : ''}</div>
                            <span class="sub-agent-nav-status ${child.status}">${childStatusIcon} ${child.status.toUpperCase()}</span>
                        </div>
                    `;
                }).join('');

                subAgentsHtml = `
                    <div class="agent-section">
                        <div class="agent-section-title">
                             Sub-Agents (${childAgents.length})
                        </div>
                        <div class="sub-agents-nav">
                            ${subAgentCards}
                        </div>
                    </div>
                `;
            }

            // Build the page content - render into output area (NOT page-content, to preserve chat)
            document.getElementById('agent-output-area').innerHTML = `
                <div class="agent-info-card">
                    <div class="agent-info-row">
                        <div class="agent-info-item">
                            <span class="label">Type:</span>
                            <span class="value">${agentType}</span>
                        </div>
                        <div class="agent-info-item">
                            <span class="label">Duration:</span>
                            <span class="value">${duration}</span>
                        </div>
                        <div class="agent-info-item">
                            <span class="label">Created:</span>
                            <span class="value">${new Date(agent.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="agent-task-box">${escapeHtml(agent.task)}</div>
                </div>

                <div class="agent-section">
                    <div class="agent-section-title">
                         Tools Used (${agent.tools_used.length})
                    </div>
                    <div class="agent-tools-list">${toolsHtml}</div>
                </div>

                ${subAgentsHtml}

                ${agent.error ? `
                <div class="agent-section">
                    <div class="agent-section-title" style="color: var(--red);"> Error</div>
                    <div style="background: rgba(239,68,68,0.1); border: 1px solid var(--red); border-radius: 12px; padding: 14px; color: var(--red);">
                        ${escapeHtml(agent.error)}
                    </div>
                </div>
                ` : ''}

                ${recommendationsHtml}

                <div class="agent-section">
                    <div class="agent-section-title">
                         Output
                    </div>
                    <div class="agent-output-rendered">
                        ${renderedOutput}
                    </div>
                </div>
            `;

            // Update continue button and instructions textarea based on status
            const continueBtn = document.getElementById('continue-agent-btn');
            const instructionsContainer = document.getElementById('followup-instructions-container');
            const instructionsInput = document.getElementById('followup-instructions');
            const continuationCount = agent.continuation_count || 0;

            if (agent.status === 'completed' && !agent.error) {
                continueBtn.style.display = 'flex';
                instructionsContainer.style.display = 'block';
                instructionsInput.value = ''; // Clear previous instructions
                if (continuationCount > 0) {
                    continueBtn.innerHTML = ` Continue (Run #${continuationCount + 1})`;
                    instructionsInput.placeholder = 'Add instructions for the next run (e.g., "Execute option 1" or "Focus on implementation")...';
                } else {
                    continueBtn.innerHTML = ' Continue with Follow-up';
                    instructionsInput.placeholder = 'Add specific instructions (e.g., "Implement the first recommendation" or "Focus on the TTS option")...';
                }
            } else if (agent.status === 'running') {
                continueBtn.style.display = 'none';
                instructionsContainer.style.display = 'none';
            } else {
                continueBtn.style.display = 'flex';
                instructionsContainer.style.display = 'block';
                continueBtn.innerHTML = ' Retry Task';
                instructionsInput.placeholder = 'Add instructions for the retry (e.g., "Try a different approach" or "Skip the failing step")...';
            }

            // Show the page
            document.getElementById('agent-detail-page').classList.add('active');
        }

        function closeAgentDetailPage() {
            document.getElementById('agent-detail-page').classList.remove('active');
            currentDetailAgentId = null;
        }

        // Legacy alias for compatibility
        function closeAgentDetailModal() {
            closeAgentDetailPage();
        }

        // Show agent detail from Recent Activity in Auto view
        async function showExecutionAgentDetail(agentId) {
            // Check if agent is already loaded
            if (!agents[agentId]) {
                // Try history first (for completed agents), then active agents
                let loaded = false;

                // Try history endpoint first
                try {
                    const historyResponse = await fetch(`${API_URL}/agents/history/${agentId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (historyResponse.ok) {
                        const agent = await historyResponse.json();
                        agent.tools_used = agent.tools_used || [];
                        agents[agentId] = agent;
                        loaded = true;
                    }
                } catch (e) {
                    console.log('History lookup failed, trying active agents');
                }

                // Try active agents endpoint if history failed
                if (!loaded) {
                    try {
                        const activeResponse = await fetch(`${API_URL}/agents/${agentId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (activeResponse.ok) {
                            const agent = await activeResponse.json();
                            agent.tools_used = agent.tools_used || [];
                            agents[agentId] = agent;
                            loaded = true;
                        }
                    } catch (e) {
                        console.log('Active agents lookup failed');
                    }
                }

                if (!loaded) {
                    showToast('Agent data no longer available. This is an older execution.', 'warning');
                    return;
                }
            }

            // Ensure tools_used exists before showing detail
            if (!agents[agentId].tools_used) {
                agents[agentId].tools_used = [];
            }

            // Show the agent detail page
            showAgentDetail(agentId);
        }

        // ==================== AGENT CHAT PAGE ====================
        let currentAgentChatId = null;
        let contextCollapsed = false;

        async function openAgentChatPage(agentId) {
            if (!agentId) return;

            currentAgentChatId = agentId;

            // Try to get agent from cache or load it
            let agent = agents[agentId];
            if (!agent) {
                try {
                    const response = await fetch(`${API_URL}/agents/history/${agentId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        agent = await response.json();
                    }
                } catch (e) {
                    console.error('Failed to load agent:', e);
                }
            }

            if (!agent) {
                alert('Agent not found');
                return;
            }

            // Mark as viewed
            fetch(`${API_URL}/agents/${agentId}/view`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            }).catch(console.error);

            // Update header
            const displayName = agent.call_sign || agent.id;
            const typeEmoji = agent.type === 'researcher' ? '' :
                              agent.type === 'coder' ? '' :
                              agent.type === 'analyst' ? '' : '';
            document.getElementById('agent-chat-page-title').textContent = `${typeEmoji} Agent ${displayName}`;

            const statusBadge = document.getElementById('agent-chat-page-status');
            statusBadge.textContent = agent.status.toUpperCase();
            statusBadge.className = `agent-status-badge ${agent.status}`;

            // Populate context summary
            document.getElementById('context-task').textContent = agent.task || 'No task';
            document.getElementById('context-output-preview').textContent =
                (agent.output || 'No output').slice(0, 300) + '...';

            // Reset context state
            contextCollapsed = false;
            document.getElementById('context-toggle-icon').classList.remove('collapsed');
            document.getElementById('context-details').classList.remove('collapsed');

            // Clear and load chat messages
            const messagesArea = document.getElementById('agent-chat-messages-area');
            messagesArea.innerHTML = '';

            // Load existing conversation
            try {
                const convResponse = await fetch(`${API_URL}/agents/${agentId}/conversation`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (convResponse.ok) {
                    const convData = await convResponse.json();
                    const conversation = convData.conversation || [];
                    conversation.forEach(msg => {
                        addAgentChatPageMessage(msg.role, msg.content);
                    });
                }
            } catch (e) {
                console.error('Failed to load conversation:', e);
            }

            // Show the page
            document.getElementById('agent-chat-page').classList.add('active');

            // Focus input
            setTimeout(() => {
                document.getElementById('agent-chat-page-input').focus();
            }, 100);
        }

        function closeAgentChatPage() {
            document.getElementById('agent-chat-page').classList.remove('active');
            currentAgentChatId = null;
        }

        function toggleContextSummary() {
            contextCollapsed = !contextCollapsed;
            const icon = document.getElementById('context-toggle-icon');
            const details = document.getElementById('context-details');

            if (contextCollapsed) {
                icon.classList.add('collapsed');
                details.classList.add('collapsed');
            } else {
                icon.classList.remove('collapsed');
                details.classList.remove('collapsed');
            }
        }

        async function submitAgentChatQuestion() {
            const input = document.getElementById('agent-chat-page-input');
            const question = input.value.trim();

            if (!question || !currentAgentChatId) return;

            // Clear input
            input.value = '';

            // Get attached context refs
            const contextRefs = getContextRefsForSend();

            // Add user message
            addAgentChatPageMessage('user', question);

            // Add thinking indicator
            const thinkingId = addAgentChatPageMessage('assistant', ' Processing...', true);

            try {
                // Use background processing by default
                const response = await fetch(`${API_URL}/agents/${currentAgentChatId}/ask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        question: question,
                        background: false,  // Use synchronous for now - we handle via Socket.IO too
                        context_refs: contextRefs
                    })
                });

                const data = await response.json();

                // Remove thinking message
                const thinkingMsg = document.getElementById(thinkingId);
                if (thinkingMsg) thinkingMsg.remove();

                if (data.answer) {
                    addAgentChatPageMessage('assistant', data.answer);
                } else if (data.error) {
                    addAgentChatPageMessage('assistant', `Error: ${data.error}`);
                } else if (data.status === 'processing') {
                    addAgentChatPageMessage('assistant', 'Processing in background... You\'ll be notified when ready.');
                }

            } catch (e) {
                console.error('Submit error:', e);
                const thinkingMsg = document.getElementById(thinkingId);
                if (thinkingMsg) thinkingMsg.remove();
                addAgentChatPageMessage('assistant', 'Failed to send question. Please try again.');
            }
        }

        function addAgentChatPageMessage(role, content, isThinking = false) {
            const container = document.getElementById('agent-chat-messages-area');
            const msgId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const label = role === 'user' ? 'You' : 'Claude';

            const msgEl = document.createElement('div');
            msgEl.id = msgId;
            msgEl.setAttribute('data-message-id', msgId);
            msgEl.setAttribute('data-text', content);
            msgEl.className = `agent-chat-page-message ${role}${isThinking ? ' thinking' : ''}`;
            msgEl.innerHTML = `
                <div class="chat-label">${label}</div>
                <div class="chat-content">${escapeHtml(content)}</div>
            `;

            // Store in session for chunk mapping and add context menu
            if (!isThinking) {
                window.messageChunkMap[msgId] = {
                    content: content,
                    type: role,
                    timestamp: new Date().toISOString(),
                    chunk_id: null,
                    conversation_id: null
                };
                msgEl.classList.add('attachable');
                msgEl.addEventListener('contextmenu', (e) => showContextMenu(e, msgEl));
            }

            container.appendChild(msgEl);
            container.scrollTop = container.scrollHeight;

            return msgId;
        }

        function extractRecommendations(text) {
            const recommendations = [];

            // Look for common recommendation patterns
            const patterns = [
                /(?:recommend|suggest|should|consider|try|install|add|create|implement)[:\s]+([^\n.!?]+[.!?]?)/gi,
                /\*\*(?:HIGH|MEDIUM|LOW)\*\*\s*[-]\s*([^\n]+)/gi,
                /(?:Priority|Action):\s*([^\n]+)/gi,
                /(?:Next steps?|To do|TODO)[:\s]*([^\n]+)/gi,
            ];

            for (const pattern of patterns) {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const rec = match[1].trim();
                    if (rec.length > 10 && rec.length < 200 && !recommendations.includes(rec)) {
                        recommendations.push(rec);
                    }
                    if (recommendations.length >= 5) break;
                }
                if (recommendations.length >= 5) break;
            }

            // Also look for bullet points with action verbs
            const bulletPattern = /^[\s]*[-*]\s*((?:Add|Create|Install|Implement|Set up|Configure|Enable|Update|Fix|Build)[^.\n]+)/gim;
            let match;
            while ((match = bulletPattern.exec(text)) !== null && recommendations.length < 5) {
                const rec = match[1].trim();
                if (rec.length > 10 && !recommendations.includes(rec)) {
                    recommendations.push(rec);
                }
            }

            return recommendations.slice(0, 5);
        }

        function executeRecommendation(index) {
            const agent = agents[currentDetailAgentId];
            if (!agent) return;

            const recommendations = extractRecommendations(agent.output || '');
            if (index >= recommendations.length) return;

            const rec = recommendations[index];

            // Create a follow-up task based on the recommendation
            const followUpTask = `Based on the previous research (Agent #${agent.id}), execute this recommendation: ${rec}

Context from previous agent:
- Original task: ${agent.task}
- Tools used: ${agent.tools_used.join(', ')}

Please proceed with implementing this recommendation. You have full permissions.`;

            closeAgentDetailPage();
            spawnAgent(followUpTask, 'worker');
        }

        // Toggle the ask question input
        function toggleAgentAsk() {
            const askArea = document.getElementById('agent-ask-area');
            if (askArea.style.display === 'none') {
                askArea.style.display = 'flex';
                document.getElementById('agent-ask-input').focus();
            } else {
                askArea.style.display = 'none';
            }
        }

        // Submit a question about the agent's output
        async function submitAgentQuestion() {
            const input = document.getElementById('agent-ask-input');
            const question = input.value.trim();

            if (!question || !currentDetailAgentId) return;

            // Clear input
            input.value = '';

            // Add user message to chat
            addAgentChatMessage('user', question);

            // Show loading
            addAgentChatMessage('assistant', ' Thinking...');

            try {
                const response = await fetch(`${API_URL}/agents/${currentDetailAgentId}/ask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ question })
                });

                const data = await response.json();

                // Remove loading message
                const messages = document.getElementById('agent-chat-messages');
                const loadingMsg = messages.lastChild;
                if (loadingMsg && loadingMsg.textContent.includes('Thinking')) {
                    loadingMsg.remove();
                }

                if (data.answer) {
                    addAgentChatMessage('assistant', data.answer);
                } else if (data.error) {
                    addAgentChatMessage('assistant', `Error: ${data.error}`);
                }

            } catch (e) {
                console.error('Ask error:', e);
                const messages = document.getElementById('agent-chat-messages');
                const loadingMsg = messages.lastChild;
                if (loadingMsg) loadingMsg.remove();
                addAgentChatMessage('assistant', 'Failed to get response. Please try again.');
            }
        }

        // Add a message to the agent chat
        function addAgentChatMessage(role, content) {
            const container = document.getElementById('agent-chat-messages');
            const label = role === 'user' ? 'You' : 'Claude';
            const msgId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

            const msgDiv = document.createElement('div');
            msgDiv.className = `agent-chat-message ${role}`;
            msgDiv.setAttribute('data-message-id', msgId);
            msgDiv.setAttribute('data-text', content);
            msgDiv.innerHTML = `
                <div class="chat-label">${label}</div>
                <div class="chat-content">${role === 'assistant' ? (typeof marked !== 'undefined' ? marked.parse(content) : content) : escapeHtml(content)}</div>
            `;

            // Store in session for chunk mapping and add context menu
            window.messageChunkMap[msgId] = {
                content: content,
                type: role,
                timestamp: new Date().toISOString(),
                chunk_id: null,
                conversation_id: null
            };
            msgDiv.classList.add('attachable');
            msgDiv.addEventListener('contextmenu', (e) => showContextMenu(e, msgDiv));

            container.appendChild(msgDiv);

            // Scroll to bottom
            const pageContent = document.getElementById('agent-page-content');
            pageContent.scrollTop = pageContent.scrollHeight;
        }

        // Render existing conversation
        function renderAgentConversation(conversation) {
            conversation.forEach(msg => {
                addAgentChatMessage(msg.role, msg.content);
            });
        }

        // Execute Task - continue work on existing agent (preserves identity)
        async function executeAgentFollowUp() {
            const agent = agents[currentDetailAgentId];
            if (!agent) {
                showToast('Agent not found', 'error');
                return;
            }

            const displayName = agent.call_sign || agent.id;

            // Get custom instructions from textarea
            const customInstructions = document.getElementById('followup-instructions')?.value?.trim() || '';

            // Build continuation instructions based on agent state + custom input
            let instructions = '';
            if (agent.error || agent.status === 'failed') {
                instructions = `The previous attempt failed with error: ${agent.error || 'Unknown error'}. Please retry with a different approach.`;
                if (customInstructions) {
                    instructions += `\n\nUser's specific instructions: ${customInstructions}`;
                }
            } else if (customInstructions) {
                // User provided specific instructions - use those
                instructions = customInstructions;
            } else {
                // Default instructions
                instructions = 'Continue from where you left off. Review your previous work and proceed with any remaining tasks. If you completed research, now take ACTION on the recommendations.';
            }

            try {
                // Show loading state
                const btn = document.getElementById('continue-agent-btn');
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = ' Continuing...';
                }

                // Call the continue endpoint (NOT spawning new agent!)
                const response = await fetch(`${API_URL}/agents/${agent.id}/continue`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ instructions })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to continue agent');
                }

                const result = await response.json();

                // Update UI - agent keeps SAME identity
                showToast(`Agent ${result.call_sign} is continuing (run #${result.continuation_count})...`, 'success');

                // Update agent status in local cache
                if (agents[result.agent_id]) {
                    agents[result.agent_id].status = 'running';
                    agents[result.agent_id].continuation_count = result.continuation_count;
                }

                // Close detail page and switch to agents view
                closeAgentDetailPage();
                switchView('agents');

                // Reload agents list to show updated status
                await loadAgents();

            } catch (error) {
                console.error('Follow-up error:', error);
                showToast(`Failed to continue agent: ${error.message}`, 'error');

                const btn = document.getElementById('continue-agent-btn');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = ' Continue with Follow-up';
                }
            }
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            if (seconds < 60) return `${seconds}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            if (minutes < 60) return `${minutes}m ${remainingSeconds}s`;
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            return `${hours}h ${remainingMinutes}m`;
        }

        function copyAgentOutput() {
            const agent = agents[currentDetailAgentId];
            if (!agent || !agent.output) {
                alert('No output to copy');
                return;
            }

            navigator.clipboard.writeText(agent.output).then(() => {
                // Find the copy button (could be in footer)
                const btns = document.querySelectorAll('.agent-action-btn.secondary');
                btns.forEach(btn => {
                    if (btn.textContent.includes('Copy')) {
                        btn.innerHTML = ' Copied!';
                        setTimeout(() => {
                            btn.innerHTML = ' Copy';
                        }, 2000);
                    }
                });
            }).catch(err => {
                console.error('Copy failed:', err);
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = agent.output;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            });
        }

        // ==================== NAVIGATION ====================
        let currentView = 'home';
        const VIEW_ORDER = { home: 0, chat: 1, agents: 2, autonomy: 3, automation: 4, settings: 5 };

        function _switchViewCore(viewName) {
            currentView = viewName;
            // Close any open slide panels when switching views
            closeSlidePanel();

            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            const view = document.getElementById(`view-${viewName}`);
            if (view) view.classList.add('active');

            const nav = document.querySelector(`.nav-item[data-view="${viewName}"]`);
            if (nav) nav.classList.add('active');

            // Scroll main content to top when switching views (except chat)
            const mainContent = document.querySelector('.main-content');
            if (mainContent && viewName !== 'chat') {
                mainContent.scrollTo({ top: 0, behavior: 'instant' });
            }

            // Show/hide chat input and FAB menu based on view
            const chatInput = document.querySelector('.chat-input-area');
            const chatFab = document.getElementById('chat-fab-container');
            if (viewName === 'chat') {
                if (chatInput) chatInput.style.display = 'block';
                if (chatFab) chatFab.classList.add('visible');
            } else {
                if (chatInput) chatInput.style.display = 'none';
                if (chatFab) { chatFab.classList.remove('visible'); closeChatFab(); }
            }

            // Load agents when switching to agents view
            if (viewName === 'agents') {
                loadAgents();
            }

            // Load autonomy status when switching to autonomy view
            if (viewName === 'autonomy') {
                loadAutonomyStatus();
            }

            // Load schedules when switching to automation view
            if (viewName === 'automation') {
                loadSchedules();
                loadExecutionHistory();
            }
        }

        function switchView(viewName, instant) {
            if (instant || isViewTransitioning || viewName === currentView) {
                _switchViewCore(viewName);
                if (viewName === 'chat') {
                    setTimeout(function() { scrollMessagesToBottom(true); }, 50);
                }
                return;
            }

            isViewTransitioning = true;

            // Step 1: Fade in translucent overlay (hides everything briefly)
            var overlay = document.createElement('div');
            overlay.className = 'view-transition-overlay';
            document.body.appendChild(overlay);
            overlay.offsetHeight; // force reflow
            overlay.classList.add('active');

            // Step 2: After overlay is opaque, switch view underneath
            setTimeout(function() {
                _switchViewCore(viewName);

                var newViewEl = document.getElementById('view-' + viewName);
                if (newViewEl) {
                    // Hide content while it loads behind overlay
                    newViewEl.classList.add('view-entering');
                    newViewEl.classList.remove('view-entered');
                }

                // Step 3: Wait for content to render, then reveal
                setTimeout(function() {
                    // For chat view: scroll to bottom BEFORE revealing (so it's already at bottom)
                    if (viewName === 'chat') {
                        scrollMessagesToBottom(true); // instant scroll
                        var chatInputEl = document.getElementById('chat-input');
                        if (chatInputEl) chatInputEl.focus();
                    }

                    // Fade overlay away
                    overlay.classList.remove('active');
                    overlay.classList.add('fade-out');

                    if (newViewEl) {
                        // Reveal content with smooth entrance
                        newViewEl.classList.remove('view-entering');
                        newViewEl.classList.add('view-entered');
                        retriggerStaggerAnimations(newViewEl);

                        // Clean up transition class after animations complete
                        setTimeout(function() {
                            newViewEl.classList.remove('view-entered');
                        }, 500);
                    }

                    // Remove overlay element after it fades out
                    setTimeout(function() {
                        if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                        isViewTransitioning = false;
                    }, 300);
                }, 120); // brief wait for content to render behind overlay
            }, 160); // wait for overlay fade-in
        }

        function retriggerStaggerAnimations(viewEl) {
            viewEl.querySelectorAll('.stagger-in').forEach(function(el) {
                el.style.animation = 'none';
                el.offsetHeight; // force reflow
                el.style.animation = '';
            });
            // Also retrigger nth-child based staggers (agent-card, interest-card, stat-pill)
            viewEl.querySelectorAll('.agent-card, .interest-card, .stat-pill').forEach(function(el) {
                el.style.animation = 'none';
                el.offsetHeight;
                el.style.animation = '';
            });
        }

        // Chat FAB (floating action button) menu toggle
        function toggleChatFab() {
            const btn = document.getElementById('chat-fab-btn');
            const menu = document.getElementById('chat-fab-menu');
            if (btn && menu) {
                btn.classList.toggle('open');
                menu.classList.toggle('open');
            }
        }

        function closeChatFab() {
            const btn = document.getElementById('chat-fab-btn');
            const menu = document.getElementById('chat-fab-menu');
            if (btn && menu) {
                btn.classList.remove('open');
                menu.classList.remove('open');
            }
        }

        // Close FAB menu when clicking outside
        document.addEventListener('click', (e) => {
            const container = document.getElementById('chat-fab-container');
            if (container && !container.contains(e.target)) {
                closeChatFab();
            }
            // Also close model dropdown when clicking outside
            const modelWrapper = document.querySelector('.model-selector-wrapper');
            if (modelWrapper && !modelWrapper.contains(e.target)) {
                closeModelDropdown();
            }
        });

        // ==================== MODEL SELECTOR ====================
        const MODEL_OPTIONS = {
            'claude-opus-4-6': { label: 'Opus 4.6', fullName: 'Claude Opus 4.6', dotClass: 'opus', desc: 'Most capable' },
            'claude-sonnet-4-5-20250929': { label: 'Sonnet 4.5', fullName: 'Claude Sonnet 4.5', dotClass: 'sonnet', desc: 'Balanced' },
            'claude-haiku-4-5-20251001': { label: 'Haiku 4.5', fullName: 'Claude Haiku 4.5', dotClass: 'haiku', desc: 'Fastest' }
        };

        let selectedModel = localStorage.getItem('cerebro_selected_model') || 'claude-sonnet-4-5-20250929';

        function initModelSelector() {
            // Validate stored model
            if (!MODEL_OPTIONS[selectedModel]) {
                selectedModel = 'claude-sonnet-4-5-20250929';
            }
            updateModelSelectorUI();
        }

        function toggleModelDropdown() {
            const btn = document.getElementById('model-selector-btn');
            const dropdown = document.getElementById('model-dropdown');
            if (btn && dropdown) {
                btn.classList.toggle('open');
                dropdown.classList.toggle('open');
            }
        }

        function closeModelDropdown() {
            const btn = document.getElementById('model-selector-btn');
            const dropdown = document.getElementById('model-dropdown');
            if (btn && dropdown) {
                btn.classList.remove('open');
                dropdown.classList.remove('open');
            }
        }

        function selectModel(modelId) {
            if (!MODEL_OPTIONS[modelId]) return;
            selectedModel = modelId;
            localStorage.setItem('cerebro_selected_model', modelId);
            updateModelSelectorUI();
            closeModelDropdown();
            // Sync model selection to server and other devices
            if (socket && socket.connected) {
                socket.emit('change_model', { model: modelId });
            }
        }

        async function fetchModelsFromServer() {
            try {
                const response = await fetch(`${API_URL}/api/models`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                if (data.models && Array.isArray(data.models)) {
                    console.log('[Model] Loaded models from server:', data.models.length);
                    // Validate current selection against server models
                    const serverModelIds = new Set(data.models.map(m => m.id));
                    if (!serverModelIds.has(selectedModel)) {
                        console.log('[Model] Selected model not available on server, falling back to default');
                        selectedModel = data.default || 'claude-sonnet-4-5-20250929';
                        localStorage.setItem('cerebro_selected_model', selectedModel);
                        updateModelSelectorUI();
                    }
                }
            } catch (e) {
                console.warn('[Model] Failed to fetch models from server:', e.message);
                // Continue with local defaults - non-critical
            }
        }

        function updateModelSelectorUI() {
            const info = MODEL_OPTIONS[selectedModel];
            if (!info) return;

            // Update old selector button (hidden but kept for compat)
            const label = document.getElementById('model-selector-label');
            const dot = document.getElementById('model-dot-indicator');
            if (label) label.textContent = info.label;
            if (dot) dot.className = 'model-dot ' + info.dotClass;

            // Update NEW input bar model selector
            const inputLabel = document.getElementById('input-model-label');
            const inputDot = document.getElementById('input-model-dot');
            if (inputLabel) inputLabel.textContent = info.label;
            if (inputDot) inputDot.className = 'model-dot ' + info.dotClass;

            // Update dropdown selected state (both old and new dropdowns)
            document.querySelectorAll('.model-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.model === selectedModel);
            });

            // Close input dropdown after selection
            closeInputModelDropdown();

            // Update settings view
            const settingsLlm = document.getElementById('settings-llm-model');
            if (settingsLlm) settingsLlm.textContent = info.fullName;

            // Update cost display based on model tier
            const costDisplay = document.getElementById('settings-cost-display');
            if (costDisplay) {
                const tierCost = {
                    'claude-opus-4-6': 'Premium tier (Claude Code sub)',
                    'claude-sonnet-4-5-20250929': 'Standard tier (Claude Code sub)',
                    'claude-haiku-4-5-20251001': 'Fast tier (Claude Code sub)'
                };
                costDisplay.textContent = tierCost[selectedModel] || 'Included (Claude Code subscription)';
            }
        }

        // === INPUT BAR MODEL SELECTOR ===
        function toggleInputModelDropdown() {
            const btn = document.getElementById('input-model-btn');
            const dropdown = document.getElementById('input-model-dropdown');
            if (btn && dropdown) {
                btn.classList.toggle('open');
                dropdown.classList.toggle('open');
            }
        }

        function closeInputModelDropdown() {
            const btn = document.getElementById('input-model-btn');
            const dropdown = document.getElementById('input-model-dropdown');
            if (btn) btn.classList.remove('open');
            if (dropdown) dropdown.classList.remove('open');
        }

        // Close input model dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.input-model-selector')) {
                closeInputModelDropdown();
            }
        });

        function sendQuickAction(text) {
            const input = document.getElementById('chat-input');
            if (input) {
                input.value = text;
                sendMessage();
            }
        }

        function triggerFileAttach() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.style.display = 'none';
            fileInput.onchange = function() {
                if (fileInput.files && fileInput.files[0]) {
                    const fileName = fileInput.files[0].name;
                    const input = document.getElementById('chat-input');
                    if (input) {
                        input.value = (input.value ? input.value + ' ' : '') + '[Attached: ' + fileName + ']';
                        input.focus();
                    }
                }
                fileInput.remove();
            };
            document.body.appendChild(fileInput);
            fileInput.click();
        }

        function getSelectedModel() {
            return selectedModel;
        }

        function getModelDisplayName(modelId) {
            const info = MODEL_OPTIONS[modelId];
            return info ? info.label : modelId;
        }

        // Initialize on load
        initModelSelector();

        function scrollMessagesToBottom(instant) {
            var container = document.getElementById('messages');
            if (!container) return;

            // Force layout calculation first
            container.offsetHeight;

            // Set scroll position directly
            container.scrollTop = container.scrollHeight;

            // Also scroll the last message into view as a fallback
            var lastMsg = container.lastElementChild;
            if (lastMsg) {
                lastMsg.scrollIntoView({ behavior: instant ? 'instant' : 'smooth', block: 'end' });
            }
        }

        // Handle mobile keyboard - adjust layout when keyboard opens
        function handleMobileKeyboard() {
            const chatInput = document.querySelector('.chat-input-area');
            const bottomNav = document.querySelector('.bottom-nav');
            const messagesContainer = document.getElementById('messages');
            const visualViewport = window.visualViewport;

            if (visualViewport && chatInput) {
                visualViewport.addEventListener('resize', () => {
                    // Check if keyboard is likely open (viewport height reduced)
                    const keyboardHeight = window.innerHeight - visualViewport.height;
                    if (keyboardHeight > 100) {
                        // Keyboard is open - hide bottom nav and adjust input position
                        document.body.classList.add('keyboard-open');
                        if (bottomNav) bottomNav.style.display = 'none';
                        chatInput.style.bottom = `0px`;
                        // Adjust messages padding so it doesn't hide behind input
                        if (messagesContainer) {
                            messagesContainer.style.paddingBottom = '100px';
                        }
                    } else {
                        // Keyboard closed - show bottom nav and reset input
                        document.body.classList.remove('keyboard-open');
                        if (bottomNav) bottomNav.style.display = 'flex';
                        chatInput.style.bottom = `calc(var(--nav-height) + var(--safe-bottom))`;
                        // Reset messages padding
                        if (messagesContainer) {
                            messagesContainer.style.paddingBottom = '';
                        }
                    }
                    // Don't auto-scroll here - it fires too often on mobile and causes jitter
                });
            }
        }

        // Refresh chat - reload chat history from server without clearing messages
        async function refreshChat() {
            const refreshBtn = event?.target?.closest('.chat-action-btn');
            if (refreshBtn) {
                refreshBtn.style.animation = 'spin 0.5s linear';
                setTimeout(() => refreshBtn.style.animation = '', 500);
            }

            try {
                await loadChatHistory();
                scrollMessagesToBottom();
                console.log('Chat refreshed');
            } catch (e) {
                console.error('Failed to refresh chat:', e);
            }
        }

        // ==================== AUTONOMY SYSTEM ====================
        let autonomyState = {
            status: 'stopped',
            level: 2,
            cycles: 0,
            phase: 'idle'
        };
        let thoughtStream = [];

        async function loadAutonomyStatus() {
            try {
                const response = await fetch(`${API_URL}/api/autonomy/status`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await response.json();

                if (data.available) {
                    autonomyState = {
                        status: data.status || 'stopped',
                        level: data.autonomy_level || 2,
                        cycles: data.cycles_completed || 0,
                        phase: data.current_phase || 'idle',
                        // NEW: Include actions and pending from status response
                        actions: data.actions_completed || 0,
                        pending: data.pending_count || 0,
                        fullAutonomy: data.full_autonomy_enabled || false
                    };
                    updateAutonomyUI();

                    // Load recent thoughts and populate activity log
                    loadRecentThoughts();
                    loadPendingApprovals();
                    loadProactiveQuestions();
                    loadCerebroChat();  // Load conversation history
                    loadStoredItems();  // Load stored items for Stored tab
                    loadHeartbeatConfig();  // Load heartbeat monitor config
                } else {
                    showToast('Autonomy system not available', 'warning');
                }
            } catch (e) {
                console.error('Failed to load autonomy status:', e);
            }
        }

        async function loadRecentThoughts() {
            try {
                const response = await fetch(`${API_URL}/api/autonomy/thoughts?limit=30`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await response.json();

                if (data.thoughts) {
                    thoughtStream = data.thoughts;
                    renderThoughtStream();

                    // Populate cycle-based activity from thoughts (all phases)
                    data.thoughts.slice().reverse().forEach(function(thought) {
                        if (thought && thought.phase && thought.content) {
                            addThoughtToCycle(thought);
                        }
                    });
                }
            } catch (e) {
                console.error('Failed to load thoughts:', e);
            }
        }

        // Load proactive questions from backend
        async function loadProactiveQuestions() {
            try {
                const response = await fetch(`${API_URL}/api/autonomy/questions`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await response.json();

                // Clear and repopulate proactiveQuestions array
                proactiveQuestions.length = 0;
                if (data.questions && data.questions.length > 0) {
                    data.questions.forEach(q => {
                        if (!q.answered) {
                            proactiveQuestions.push({
                                id: q.id,
                                question: q.question,
                                type: q.type || 'general',
                                options: q.options || [],
                                paths: q.paths || [],
                                timestamp: q.timestamp
                            });
                        }
                    });
                }
                // Update the questions badge
                updateQuestionsBadge();
            } catch (e) {
                console.error('Failed to load proactive questions:', e);
            }
        }

        async function loadPendingApprovals() {
            try {
                const response = await fetch(`${API_URL}/api/autonomy/pending`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await response.json();

                const statPendingEl = document.getElementById('stat-pending');
                const pendingApprovalsEl = document.getElementById('pending-approvals');

                if (data.pending && data.pending.length > 0) {
                    renderPendingApprovals(data.pending);
                    if (statPendingEl) statPendingEl.textContent = data.pending.length;
                } else {
                    if (pendingApprovalsEl) pendingApprovalsEl.style.display = 'none';
                    if (statPendingEl) statPendingEl.textContent = '0';
                }
            } catch (e) {
                console.error('Failed to load pending approvals:', e);
            }
        }

        // ===== CEREBRO'S VOICE - Dynamic conversational updates =====
        let currentVoiceTimeout = null;
        let voiceQueue = [];
        let currentActiveDirective = null;

        function updateCerebroVoice(type, data = {}) {
            const voiceContent = document.getElementById('voice-content');
            const voiceLabel = document.querySelector('.voice-label span:last-child');
            if (!voiceContent) return;

            let message = '';
            let label = 'Cerebro';

            switch (type) {
                case 'acknowledge':
                    const taskPreview = data.task?.substring(0, 50) || 'your request';
                    currentActiveDirective = data.task;
                    message = `Got it! I'm diving into "${taskPreview}${data.task?.length > 50 ? '...' : ''}"  let me see what I can find for you.`;
                    label = 'Cerebro  Starting';
                    break;

                case 'working':
                    message = `Still exploring ${data.task || 'this'}... I'm pulling together some interesting information for you.`;
                    label = 'Cerebro  Researching';
                    break;

                case 'finding':
                    const findingType = data.type || 'something';
                    const preview = data.preview?.replace(/\*\*/g, '').substring(0, 80) || '';
                    const count = data.count || 1;

                    if (findingType === 'web_search') {
                        message = `Found something interesting! "${preview}${preview.length >= 80 ? '...' : ''}"  I've gathered ${count} findings so far.`;
                    } else if (findingType === 'insight') {
                        message = `Aha! Here's an insight: "${preview}${preview.length >= 80 ? '...' : ''}"`;
                    } else {
                        message = `Making progress... ${count} findings gathered. Latest: "${preview}${preview.length >= 80 ? '...' : ''}"`;
                    }
                    label = 'Cerebro  Discovering';
                    break;

                case 'completed':
                    const taskName = data.task?.substring(0, 40) || 'the task';
                    if (data.preview) {
                        const cleanPreview = data.preview.replace(/\*\*/g, '').replace(/Task findings.*?:/g, '').trim();
                        message = `Done! Here's what I found: "${cleanPreview.substring(0, 120)}${cleanPreview.length > 120 ? '...' : ''}"  Check the Completed section for the full details!`;
                    } else {
                        message = `All done with "${taskName}"! Check the Completed section to see what I found.`;
                    }
                    label = 'Cerebro  Complete ';
                    currentActiveDirective = null;
                    break;

                case 'thinking':
                    if (data.message) {
                        // Rich message from processThoughtVoice
                        message = data.message;
                        label = data.customLabel || `Cerebro \u2022 ${data.phase?.charAt(0).toUpperCase() + data.phase?.slice(1) || 'Thinking'}`;
                    } else {
                        const phases = {
                            observe: "I'm scanning for patterns and gathering context...",
                            orient: "Processing what I've learned, forming connections...",
                            decide: "Weighing my options, deciding what to do next...",
                            act: "Taking action now \u2014 watch what happens...",
                            reflect: "Reflecting on what just happened, learning from it..."
                        };
                        message = phases[data.phase] || "Thinking...";
                        label = `Cerebro \u2022 ${data.phase?.charAt(0).toUpperCase() + data.phase?.slice(1) || 'Thinking'}`;
                    }
                    break;

                case 'idle':
                    message = "I'm here. Give me something to think about, or ask me anything.";
                    label = 'Cerebro';
                    break;

                case 'dormant':
                    message = "I'm here, waiting in the quiet dark. Touch the orb to awaken me, and tell me what you'd like me to think about.";
                    label = 'Cerebro';
                    break;

                default:
                    message = data.message || "Thinking...";
            }

            // Animate the text change
            voiceContent.style.opacity = '0';
            setTimeout(() => {
                voiceContent.textContent = message;
                voiceContent.dataset.userSet = 'true';
                voiceContent.style.opacity = '1';
            }, 150);

            // Update label if element exists
            if (voiceLabel) {
                voiceLabel.textContent = label;
            }

            // Inject status thoughts into chat feed
            if (typeof injectStatusToChat === 'function') {
                injectStatusToChat(message, label);
            }

            // For completed messages, revert to idle after a while
            if (type === 'completed') {
                if (currentVoiceTimeout) clearTimeout(currentVoiceTimeout);
                currentVoiceTimeout = setTimeout(() => {
                    if (autonomyState.status === 'running') {
                        updateCerebroVoice('idle');
                    } else {
                        updateCerebroVoice('dormant');
                    }
                }, 15000); // Show completion message for 15 seconds
            }
        }

        function updateAutonomyUI() {
            const orb = document.getElementById('consciousness-orb');
            const statusText = document.getElementById('consciousness-status-text');
            const awakenBtn = document.getElementById('awaken-btn');
            const voiceContent = document.getElementById('voice-content');
            const slider = document.getElementById('autonomy-level-slider');

            // Reset orb classes
            if (orb) {
                orb.className = 'consciousness-orb';

                if (autonomyState.status === 'running') {
                    orb.classList.add('active');

                    // Phase-specific consciousness states
                    const phaseMap = {
                        'observe': { class: 'observing', text: 'perceiving' },
                        'orient': { class: 'thinking', text: 'contemplating' },
                        'decide': { class: 'deciding', text: 'deliberating' },
                        'act': { class: 'acting', text: 'manifesting' },
                        'reflect': { class: 'reflecting', text: 'introspecting' },
                        'idle': { class: 'thinking', text: 'dreaming' }
                    };

                    const phaseInfo = phaseMap[autonomyState.phase] || phaseMap.idle;
                    orb.classList.add(phaseInfo.class);

                    if (statusText) statusText.textContent = phaseInfo.text;

                    // Voice is now handled by updateCerebroVoice() via socket events
                    // Only set idle message if nothing else is happening
                    if (voiceContent && !voiceContent.dataset.userSet && !currentActiveDirective) {
                        updateCerebroVoice('idle');
                    }
                } else {
                    orb.classList.add('dormant');
                    if (statusText) statusText.textContent = 'dormant';
                    if (voiceContent && !voiceContent.dataset.userSet) {
                        updateCerebroVoice('dormant');
                    }
                }
            }

            // Update awaken button
            if (awakenBtn) {
                if (autonomyState.status === 'running') {
                    awakenBtn.textContent = 'Rest';
                    awakenBtn.classList.add('active');
                } else {
                    awakenBtn.textContent = 'Awaken';
                    awakenBtn.classList.remove('active');
                }
            }

            // Update slider
            if (slider) {
                slider.value = autonomyState.level;
                updateLevelLabels(autonomyState.level);
            }

            // Update stats (both tech panel and sidebar)
            const cyclesEl = document.getElementById('stat-cycles');
            const sidebarCyclesEl = document.getElementById('sidebar-stat-cycles');
            const newCycles = autonomyState.cycles || 0;
            if (cyclesEl) cyclesEl.textContent = newCycles;
            if (sidebarCyclesEl) sidebarCyclesEl.textContent = newCycles;

            const actionsEl = document.getElementById('stat-actions');
            const sidebarActionsEl = document.getElementById('sidebar-stat-actions');
            const newActions = autonomyState.actions || 0;
            if (actionsEl) actionsEl.textContent = newActions;
            if (sidebarActionsEl) sidebarActionsEl.textContent = newActions;

            const pendingEl = document.getElementById('stat-pending');
            const sidebarPendingEl = document.getElementById('sidebar-stat-pending');
            const newPending = autonomyState.pending || 0;
            if (pendingEl) pendingEl.textContent = newPending;
            if (sidebarPendingEl) sidebarPendingEl.textContent = newPending;

            // Update sidebar level display
            const sidebarLevelDisplay = document.getElementById('controls-current-level');
            if (sidebarLevelDisplay) sidebarLevelDisplay.textContent = autonomyState.level || 2;

            // Update sidebar slider
            const sidebarSlider = document.getElementById('sidebar-level-slider');
            if (sidebarSlider) sidebarSlider.value = autonomyState.level || 2;

            // Update full autonomy toggle in sidebar
            const sidebarFullAutonomyToggle = document.getElementById('sidebar-full-autonomy-toggle');
            if (sidebarFullAutonomyToggle) {
                sidebarFullAutonomyToggle.checked = autonomyState.fullAutonomy || false;
            }
            const sidebarFullAutonomySection = document.getElementById('controls-full-autonomy');
            if (sidebarFullAutonomySection) {
                if (autonomyState.fullAutonomy) {
                    sidebarFullAutonomySection.classList.add('enabled');
                } else {
                    sidebarFullAutonomySection.classList.remove('enabled');
                }
            }

            // Add/remove autonomy-running class for emergency stop visibility
            const autonomyView = document.getElementById('view-autonomy');
            if (autonomyView) {
                if (autonomyState.status === 'running') {
                    autonomyView.classList.add('autonomy-running');
                } else {
                    autonomyView.classList.remove('autonomy-running');
                }
            }

            // Legacy support - fake these for old code
            const legacyOrb = document.getElementById('autonomy-orb');
            if (legacyOrb) {
                // For old code that might still reference this
            }

            // ===== UPDATE STATUS CARDS =====
            updateStatusCards();

            // ===== SYNC SLIDE PANEL STATS =====
            syncStatEl('sidebar-stat-cycles', 'slide-stat-cycles');
            syncStatEl('sidebar-stat-actions', 'slide-stat-actions');
            syncStatEl('sidebar-stat-pending', 'slide-stat-pending');
            const slideLevelSlider = document.getElementById('slide-level-slider');
            if (slideLevelSlider) slideLevelSlider.value = autonomyState.level || 2;
            const slideLevelValue = document.getElementById('slide-level-value');
            if (slideLevelValue) slideLevelValue.textContent = autonomyState.level || 2;
            const slideFullToggle = document.getElementById('slide-full-autonomy-toggle');
            if (slideFullToggle) slideFullToggle.checked = autonomyState.fullAutonomy || false;

            // Update tamagotchi panel if available
            if (typeof updateTamagotchiUI === 'function') updateTamagotchiUI();
        }

        // ===== STATUS CARDS UPDATE =====
        function updateStatusCards() {
            // Phase card
            const phaseDot = document.getElementById('status-card-phase-dot');
            const phaseValue = document.getElementById('status-card-phase-value');
            const phaseNames = {
                'observe': 'Observing',
                'orient': 'Orienting',
                'decide': 'Deciding',
                'act': 'Acting',
                'reflect': 'Reflecting',
                'idle': 'Idle'
            };

            if (autonomyState.status === 'running') {
                const phase = autonomyState.phase || 'idle';
                if (phaseDot) {
                    phaseDot.className = 'status-card-dot';
                    phaseDot.classList.add('phase-' + phase);
                }
                if (phaseValue) phaseValue.textContent = phaseNames[phase] || 'Active';
            } else {
                if (phaseDot) {
                    phaseDot.className = 'status-card-dot phase-dormant';
                }
                if (phaseValue) phaseValue.textContent = 'Dormant';
            }

            // Actions card
            const actionsValue = document.getElementById('status-card-actions-value');
            if (actionsValue) actionsValue.textContent = autonomyState.actions || 0;

            // Focus card
            const focusValue = document.getElementById('status-card-focus-value');
            const focusCount = document.getElementById('focus-count');
            if (focusValue && focusCount) focusValue.textContent = focusCount.textContent || '0';

            // Autonomy level card
            const autonomyValue = document.getElementById('status-card-autonomy-value');
            if (autonomyValue) autonomyValue.textContent = 'Lv ' + (autonomyState.level || 2);

            // Update status strip
            updateStatusStrip();
        }

        function updateStatusStrip() {
            // Focus text
            const stripFocusText = document.getElementById('strip-focus-text');
            const stripFocusCount = document.getElementById('strip-focus-count');
            const focusCountEl = document.getElementById('focus-count');

            if (currentActiveDirective && stripFocusText) {
                const text = typeof currentActiveDirective === 'string' ? currentActiveDirective : (currentActiveDirective.text || 'Active focus');
                stripFocusText.textContent = text.length > 35 ? text.substring(0, 35) + '...' : text;
            } else if (stripFocusText) {
                stripFocusText.textContent = 'No active focus';
            }
            if (stripFocusCount && focusCountEl) stripFocusCount.textContent = focusCountEl.textContent || '0';

            // Completed count
            const stripCompletedCount = document.getElementById('strip-completed-count');
            const completedCountEl = document.getElementById('completed-count');
            if (stripCompletedCount && completedCountEl) stripCompletedCount.textContent = completedCountEl.textContent || '0';

            // Skills count
            const stripSkillsCount = document.getElementById('strip-skills-count');
            const skillCountEl = document.getElementById('skill-count');
            if (stripSkillsCount && skillCountEl) stripSkillsCount.textContent = skillCountEl.textContent || '0';

            // Sync orb panel badge counts
            const orbFocusCount = document.getElementById('orb-focus-count');
            if (orbFocusCount && focusCountEl) orbFocusCount.textContent = focusCountEl.textContent || '0';
            const orbCompletedCount = document.getElementById('orb-completed-count');
            if (orbCompletedCount && completedCountEl) orbCompletedCount.textContent = completedCountEl.textContent || '0';
            const orbSkillsCount = document.getElementById('orb-skills-count');
            if (orbSkillsCount && skillCountEl) orbSkillsCount.textContent = skillCountEl.textContent || '0';
        }

        // Toggle tech panel visibility
        function toggleTechPanel() {
            const panel = document.getElementById('tech-panel');
            if (panel) {
                panel.classList.toggle('expanded');
            }
        }

        // Add a message to Cerebro's voice stream
        function addVoiceMessage(text, type = 'thought') {
            const history = document.getElementById('message-history');
            if (!history) return;

            const message = document.createElement('div');
            message.className = `voice-message ${type}`;
            message.innerHTML = `
                <div class="message-text">${escapeHtml(text)}</div>
                <div class="message-meta">
                    <span class="message-type">${type}</span>
                    <span>${new Date().toLocaleTimeString()}</span>
                </div>
            `;

            history.insertBefore(message, history.firstChild);

            // Keep only last 20 messages
            while (history.children.length > 20) {
                history.removeChild(history.lastChild);
            }
        }

        // Update directives display in the new format
        function renderDirectivesNew() {
            const container = document.getElementById('active-directives');
            if (!container) return;

            const activeDirectives = (window.directivesList || []).filter(d => d.status === 'active' || d.status === 'pending');

            if (activeDirectives.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = activeDirectives.map(d => `
                <div class="directive-tag">
                    <span class="status-dot"></span>
                    <span>${escapeHtml(d.text.substring(0, 50))}${d.text.length > 50 ? '...' : ''}</span>
                    <span class="remove" onclick="deleteDirective('${d.id}')">&times;</span>
                </div>
            `).join('');
        }

        // Placeholder for legacy - keep functionality working
        function updateAutonomyUILegacy() {
            // Legacy compatibility - old code paths
        }

        function updateLevelLabelsNew(level) {
            document.querySelectorAll('.level-mark').forEach(mark => {
                mark.classList.remove('active');
                if (parseInt(mark.dataset.level) === parseInt(level)) {
                    mark.classList.add('active');
                }
            });
        }

        function updateLevelLabels(level) {
            // Update old-style labels
            document.querySelectorAll('.level-label').forEach(label => {
                label.classList.remove('active');
                if (parseInt(label.dataset.level) === parseInt(level)) {
                    label.classList.add('active');
                }
            });
            // Update new-style marks
            document.querySelectorAll('.level-mark').forEach(mark => {
                mark.classList.remove('active');
                if (parseInt(mark.dataset.level) === parseInt(level)) {
                    mark.classList.add('active');
                }
            });
            // Update compact marks in sidebar
            document.querySelectorAll('.level-mark-compact').forEach(mark => {
                mark.classList.remove('active');
                if (parseInt(mark.dataset.level) === parseInt(level)) {
                    mark.classList.add('active');
                }
            });
            // Update sidebar level display
            const sidebarLevelDisplay = document.getElementById('controls-current-level');
            if (sidebarLevelDisplay) sidebarLevelDisplay.textContent = level;
        }

        // ========================================
        // DIRECTIVES - Give the AI missions/goals
        // ========================================
        let directives = [];

        async function loadDirectives() {
            try {
                const response = await fetch(`${API_URL}/api/directives`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    directives = data.directives || [];
                    renderDirectives();
                }
            } catch (e) {
                console.error('Failed to load directives:', e);
            }
        }

        // Auto-resize textarea as user types
        function autoResizeDirective(textarea) {
            // Reset height to auto to get the correct scrollHeight
            textarea.style.height = 'auto';
            // Set to scrollHeight but cap at max-height (200px from CSS)
            const newHeight = Math.min(textarea.scrollHeight, 200);
            textarea.style.height = newHeight + 'px';
        }

        // Handle keydown - Enter submits, Shift+Enter adds newline
        function handleDirectiveKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                addDirective();
            }
        }

        async function addDirective() {
            const input = document.getElementById('directive-input');
            const text = input.value.trim();
            if (!text) return;

            try {
                const response = await fetch(`${API_URL}/api/directives`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text })
                });
                const data = await response.json();
                if (data.success) {
                    directives.unshift(data.directive);
                    input.value = '';
                    // Reset textarea height after clearing
                    input.style.height = 'auto';
                    renderDirectives();
                    showToast('Directive added - AI will work on this', 'success');
                } else {
                    showToast(data.error || 'Failed to add directive', 'error');
                }
            } catch (e) {
                showToast('Failed to add directive', 'error');
            }
        }

        async function completeDirective(id) {
            try {
                const response = await fetch(`${API_URL}/api/directives/${id}/complete`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                if (response.ok) {
                    directives = directives.filter(d => d.id !== id);
                    renderDirectives();
                    showToast('Directive marked complete', 'info');
                }
            } catch (e) {
                showToast('Failed to complete directive', 'error');
            }
        }

        async function deleteDirective(id) {
            try {
                const response = await fetch(`${API_URL}/api/directives/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                if (response.ok) {
                    directives = directives.filter(d => d.id !== id);
                    renderDirectives();
                    showToast('Directive removed', 'info');
                }
            } catch (e) {
                showToast('Failed to delete directive', 'error');
            }
        }

        function renderDirectives() {
            // Store for the new UI
            window.directivesList = directives;

            // Render new consciousness-style directive tags
            const newContainer = document.getElementById('active-directives');
            if (newContainer) {
                const activeDirectives = directives.filter(d => d.status !== 'completed');

                if (activeDirectives.length === 0) {
                    newContainer.innerHTML = '';
                } else {
                    newContainer.innerHTML = activeDirectives.map(d => `
                        <div class="directive-tag">
                            <span class="status-dot"></span>
                            <span>${escapeHtml(d.text.substring(0, 50))}${d.text.length > 50 ? '...' : ''}</span>
                            <span class="remove" onclick="deleteDirective('${d.id}')">&times;</span>
                        </div>
                    `).join('');
                }
            }

            // Sync to Current Focus sidebar
            syncDirectivesToFocus();

            // Sync to orb tabbed panel
            if (typeof renderOrbDirectives === 'function') renderOrbDirectives();

            // Legacy container support (hidden)
            const container = document.getElementById('directives-list');
            const countEl = document.getElementById('directives-count');

            if (!container) return;

            const activeDirectives = directives.filter(d => d.status !== 'completed');
            if (countEl) countEl.textContent = `${activeDirectives.length} active`;

            if (activeDirectives.length === 0) {
                container.innerHTML = `
                    <div class="directives-empty">
                        <div class="directives-empty-icon"></div>
                        <div>No active directives</div>
                        <div style="font-size: 0.75rem; margin-top: 4px;">Give the AI something to learn or work on</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = activeDirectives.map(d => `
                <div class="directive-item" data-id="${d.id}">
                    <div class="directive-content">
                        <div class="directive-text">${escapeHtml(d.text)}</div>
                        <div class="directive-meta">
                            <span class="directive-status ${d.status === 'active' ? 'active' : 'pending'}">
                                ${d.status === 'active' ? ' Working on it' : ' Queued'}
                            </span>
                            <span>${formatTimeAgo(new Date(d.created_at))}</span>
                        </div>
                    </div>
                    <div class="directive-actions">
                        <button class="directive-action-btn" onclick="completeDirective('${d.id}')" title="Mark as done"></button>
                        <button class="directive-action-btn delete" onclick="deleteDirective('${d.id}')" title="Remove"></button>
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        // ========================================
        // INSIGHTS - What Cerebro Found
        // ========================================
        let insights = [];

        async function loadInsights() {
            try {
                const response = await fetch(`${API_URL}/api/insights`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    insights = (data.insights || []).map(i => ({
                        ...i,
                        timestamp: new Date(i.timestamp)
                    }));
                    renderInsights();
                }
            } catch (e) {
                console.error('Failed to load insights:', e);
            }
        }

        function addInsight(suggestion) {
            const insight = {
                id: suggestion.id || `insight_${Date.now()}`,
                title: suggestion.title || 'New Insight',
                content: suggestion.description || suggestion.content || '',
                confidence: suggestion.confidence || 0.7,
                source: suggestion.source || 'cognitive_loop',
                timestamp: new Date()
            };

            insights.unshift(insight);
            if (insights.length > 20) insights.pop();

            renderInsights();

            // Also add to activity feed
            addActivityItem({
                type: 'suggestion',
                text: ` ${insight.title}`,
                timestamp: new Date()
            });
        }

        function dismissInsight(id) {
            insights = insights.filter(i => i.id !== id);
            renderInsights();
        }

        function renderInsights() {
            const container = document.getElementById('insights-list');
            const countEl = document.getElementById('insights-count');

            if (!container) return;

            if (countEl) countEl.textContent = `${insights.length} insight${insights.length !== 1 ? 's' : ''}`;

            if (insights.length === 0) {
                container.innerHTML = `
                    <div class="insights-empty">
                        <div class="insights-empty-icon"></div>
                        <div class="insights-empty-text">No insights yet</div>
                        <div class="insights-empty-hint">Cerebro will share findings and suggestions here as it researches your directives</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = insights.map(i => `
                <div class="insight-card" data-id="${i.id}">
                    <div class="insight-card-header">
                        <div class="insight-card-title">
                            <span></span>
                            ${escapeHtml(i.title)}
                        </div>
                        <span class="insight-card-badge">${i.source === 'cognitive_loop' ? 'AI Generated' : 'Manual'}</span>
                    </div>
                    <div class="insight-card-content">${escapeHtml(i.content)}</div>
                    <div class="insight-card-meta">
                        <div class="insight-confidence">
                            <span>Confidence:</span>
                            <div class="insight-confidence-bar">
                                <div class="insight-confidence-fill" style="width: ${Math.round(i.confidence * 100)}%"></div>
                            </div>
                            <span>${Math.round(i.confidence * 100)}%</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>${formatTimeAgo(i.timestamp)}</span>
                            <button class="insight-dismiss" onclick="dismissInsight('${i.id}')">Dismiss</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Activity feed items
        let activityItems = [];

        function addActivityItem(item) {
            activityItems.unshift({
                ...item,
                id: `activity_${Date.now()}`,
                timestamp: item.timestamp || new Date()
            });
            if (activityItems.length > 50) activityItems.pop();
            renderActivityFeed();
        }

        function renderActivityFeed() {
            const container = document.getElementById('activity-feed');

            if (!container) return;

            if (activityItems.length === 0) {
                container.innerHTML = `
                    <div class="goals-empty" style="padding: 20px;">
                        <div style="font-size: 0.8rem; color: var(--text-muted);">No activity yet</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">Memory searches, learnings, and actions will appear here</div>
                    </div>
                `;
                return;
            }

            const icons = {
                'search': '',
                'suggestion': '',
                'learning': '',
                'action': '',
                'error': '',
                'success': ''
            };

            container.innerHTML = activityItems.slice(0, 15).map(item => `
                <div class="activity-item" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-card); border-radius: 8px; margin-bottom: 6px;">
                    <span style="font-size: 1rem;">${icons[item.type] || ''}</span>
                    <div style="flex: 1;">
                        <div style="font-size: 0.85rem; color: var(--text-primary);">${escapeHtml(item.text)}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">${formatTimeAgo(item.timestamp)}</div>
                    </div>
                </div>
            `).join('');
        }

        async function toggleAutonomy() {
            if (autonomyState.status === 'running') {
                // Stop
                try {
                    const response = await fetch(`${API_URL}/api/autonomy/stop`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ reason: 'User disabled' })
                    });
                    const data = await response.json();
                    if (data.success) {
                        autonomyState.status = 'stopped';
                        updateAutonomyUI();
                        showToast('Autonomy disabled', 'info');
                    }
                } catch (e) {
                    showToast('Failed to stop autonomy', 'error');
                }
            } else {
                // Start
                try {
                    const level = parseInt(document.getElementById('autonomy-level-slider').value);
                    const response = await fetch(`${API_URL}/api/autonomy/start?level=${level}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                    });
                    const data = await response.json();
                    if (data.success) {
                        autonomyState.status = 'running';
                        autonomyState.level = level;
                        updateAutonomyUI();
                        showToast(`Autonomy enabled at level ${level}`, 'success');
                    } else {
                        showToast(data.error || 'Failed to start', 'error');
                    }
                } catch (e) {
                    showToast('Failed to start autonomy', 'error');
                }
            }
        }

        async function setAutonomyLevel(level) {
            updateLevelLabels(level);
            try {
                const response = await fetch(`${API_URL}/api/autonomy/level?level=${level}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await response.json();
                if (data.success) {
                    autonomyState.level = level;
                    showToast(`Autonomy level set to ${level}`, 'info');
                }
            } catch (e) {
                console.error('Failed to set level:', e);
            }
        }

        async function toggleFullAutonomy(enabled) {
            // Confirm if enabling
            if (enabled) {
                const confirmed = await cerebroConfirm(
                    'When enabled, the AI can spawn Claude Code agents to write files, run commands, and execute real tasks. This uses your Anthropic subscription.',
                    { title: 'Enable Full Autonomy?', confirmText: 'Enable' }
                );
                if (!confirmed) {
                    // Reset both toggles
                    const mainToggle = document.getElementById('full-autonomy-toggle');
                    const sidebarToggle = document.getElementById('sidebar-full-autonomy-toggle');
                    if (mainToggle) mainToggle.checked = false;
                    if (sidebarToggle) sidebarToggle.checked = false;
                    return;
                }
            }

            try {
                const response = await fetch(`${API_URL}/api/autonomy/full-autonomy?enabled=${enabled}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await response.json();
                if (data.success) {
                    autonomyState.fullAutonomy = enabled;
                    updateFullAutonomyUI(enabled);
                    showToast(
                        enabled
                            ? ' Full Autonomy ENABLED - Can spawn Claude agents'
                            : ' Full Autonomy DISABLED - Thinking mode only',
                        enabled ? 'warning' : 'info'
                    );
                }
            } catch (e) {
                console.error('Failed to toggle full autonomy:', e);
                document.getElementById('full-autonomy-toggle').checked = !enabled;
                showToast('Failed to toggle full autonomy', 'error');
            }
        }

        function updateFullAutonomyUI(enabled) {
            // Update main panel elements
            const section = document.getElementById('full-autonomy-section');
            const warning = document.getElementById('full-autonomy-warning');
            const desc = document.getElementById('full-autonomy-desc');
            const toggle = document.getElementById('full-autonomy-toggle');

            if (toggle) toggle.checked = enabled;

            if (enabled) {
                if (section) section.classList.add('enabled');
                if (warning) warning.style.display = 'block';
                if (desc) {
                    desc.textContent = 'ACTIVE - Claude agents can be spawned';
                    desc.style.color = 'var(--red)';
                }
            } else {
                if (section) section.classList.remove('enabled');
                if (warning) warning.style.display = 'none';
                if (desc) {
                    desc.textContent = 'Can spawn Claude agents (uses subscription)';
                    desc.style.color = 'var(--text-muted)';
                }
            }

            // Update sidebar elements
            const sidebarToggle = document.getElementById('sidebar-full-autonomy-toggle');
            const sidebarSection = document.getElementById('controls-full-autonomy');

            if (sidebarToggle) sidebarToggle.checked = enabled;
            if (sidebarSection) {
                if (enabled) {
                    sidebarSection.classList.add('enabled');
                } else {
                    sidebarSection.classList.remove('enabled');
                }
            }

            // Store in autonomy state
            autonomyState.fullAutonomy = enabled;
        }

        async function emergencyStop() {
            if (!await cerebroConfirm('This will immediately halt the cognitive loop and stop all running agents.', { title: 'Emergency Stop', danger: true, confirmText: 'Stop Everything' })) {
                return;
            }

            try {
                // Stop cognitive loop
                const response = await fetch(`${API_URL}/api/autonomy/emergency-stop`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await response.json();

                // Also kill all running agents
                const agentsKilled = await killAllRunningAgents();

                if (data.success) {
                    autonomyState.status = 'stopped';
                    updateAutonomyUI();
                    const agentMsg = agentsKilled > 0 ? ` (${agentsKilled} agents stopped)` : '';
                    showToast(` Emergency stop activated!${agentMsg}`, 'warning');
                }
            } catch (e) {
                showToast('Failed to trigger emergency stop', 'error');
            }
        }

        // Kill all running agents
        async function killAllRunningAgents() {
            try {
                // Get all agents
                const response = await fetch(`${API_URL}/agents`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await response.json();
                const runningAgents = (data.agents || []).filter(a =>
                    a.status === 'running' || a.status === 'queued'
                );

                // Kill each running agent
                let killed = 0;
                for (const agent of runningAgents) {
                    try {
                        await fetch(`${API_URL}/agents/${agent.id}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                        });
                        killed++;
                    } catch (e) {
                        console.error(`Failed to kill agent ${agent.id}:`, e);
                    }
                }

                // Refresh agents list
                if (killed > 0) await loadAgents();

                return killed;
            } catch (e) {
                console.error('Failed to get agents:', e);
                return 0;
            }
        }

        // ===== FLOATING SIDEBARS - Activity & Questions =====

        // === Cycle-based Activity Data Model ===
        let activityCycles = {};      // { cycleNumber: { number, startTime, endTime, steps:[], status, decision } }
        let activityCycleOrder = [];  // [3, 2, 1] newest first
        let _runningCycleNumber = 0;

        // Legacy compat - still needed by some callers
        let activityLog = [];
        let proactiveQuestions = [];
        let currentQuestion = null;

        // Activity log clear persistence - stores timestamp of when log was cleared
        let activityLogClearedAt = parseInt(localStorage.getItem('cerebro_activity_cleared_at') || '0');

        function toggleSidebar(type) {
            // Legacy compatibility: now opens slide panels instead
            if (type === 'activity') {
                openSlidePanel('activity');
            } else if (type === 'questions') {
                openSlidePanel('skills');
            }
        }

        // Slide-out panel management
        let currentSlidePanel = null;

        function openSlidePanel(panelType) {
            closeSlidePanel(); // Close any open panel first
            const panel = document.getElementById(`slide-panel-${panelType}`);
            const backdrop = document.getElementById('slide-panel-backdrop');
            if (panel) {
                panel.classList.add('open');
                if (backdrop) backdrop.classList.add('visible');
                currentSlidePanel = panelType;
                // Sync content when opening
                if (panelType === 'activity') {
                    syncActivityToSlidePanel();
                } else if (panelType === 'skills') {
                    syncMindDetailsToSlidePanel();
                }
            }
        }

        function closeSlidePanel() {
            document.querySelectorAll('.slide-panel.open').forEach(p => p.classList.remove('open'));
            const backdrop = document.getElementById('slide-panel-backdrop');
            if (backdrop) backdrop.classList.remove('visible');
            currentSlidePanel = null;
        }

        function syncActivityToSlidePanel() {
            // renderCycleList already renders into both containers directly
            renderCycleList();
            // Sync stats
            syncStatEl('sidebar-stat-cycles', 'slide-stat-cycles');
            syncStatEl('sidebar-stat-actions', 'slide-stat-actions');
            syncStatEl('sidebar-stat-pending', 'slide-stat-pending');
        }

        function syncMindDetailsToSlidePanel() {
            // Clone focus, completed, skills content
            syncContentClone('focus-container', 'slide-focus-container');
            syncContentClone('completed-container', 'slide-completed-container');
            syncContentClone('skills-list', 'slide-skills-list');
            // Sync counts
            syncStatEl('focus-count', 'slide-focus-count');
            syncStatEl('completed-count', 'slide-completed-count');
            syncStatEl('skill-count', 'slide-skill-count');
        }

        function syncStatEl(fromId, toId) {
            const from = document.getElementById(fromId);
            const to = document.getElementById(toId);
            if (from && to) to.textContent = from.textContent;
        }

        function syncContentClone(fromId, toId) {
            const from = document.getElementById(fromId);
            const to = document.getElementById(toId);
            if (from && to) {
                to.textContent = '';
                Array.from(from.childNodes).forEach(node => {
                    to.appendChild(node.cloneNode(true));
                });
            }
        }

        // Alive pulse control
        function setAlivePulse(show) {
            const dot = document.getElementById('alive-pulse-dot');
            if (dot) dot.classList.toggle('hidden', !show);
        }

        // Track last activity to avoid duplicates
        let lastActivityPhase = null;
        let lastActivityContent = null;
        let idleCount = 0;

        function addThoughtToCycle(thought) {
            const cycleNum = thought.cycle_number || (thought.metadata && thought.metadata.cycle_number) || _runningCycleNumber || 1;

            // Filter out items older than cleared timestamp
            if (thought.timestamp) {
                const itemTime = new Date(thought.timestamp).getTime();
                if (itemTime < activityLogClearedAt) return;
            }

            if (!activityCycles[cycleNum]) {
                activityCycles[cycleNum] = {
                    number: cycleNum,
                    startTime: thought.timestamp,
                    endTime: thought.timestamp,
                    steps: [],
                    status: 'running',
                    decision: null
                };
                // Insert in order (newest first)
                if (!activityCycleOrder.includes(cycleNum)) {
                    activityCycleOrder.unshift(cycleNum);
                    activityCycleOrder.sort((a, b) => b - a);
                }
            }

            const cycle = activityCycles[cycleNum];
            cycle.endTime = thought.timestamp || cycle.endTime;

            const step = {
                phase: (thought.phase || '').toLowerCase(),
                content: thought.fullContent || thought.content || '',
                reasoning: thought.reasoning || '',
                confidence: thought.confidence || 0,
                timestamp: thought.timestamp,
                metadata: thought.metadata || {},
                isBrowserStep: thought.is_browser_step || (thought.metadata && thought.metadata.is_browser_step) || false,
                browserStepData: thought.browser_step_data || (thought.metadata && thought.metadata.browser_step_data) || null,
                fullThought: thought
            };

            cycle.steps.push(step);

            // Extract decision summary
            if (step.phase === 'decide') {
                const actionType = (thought.metadata && thought.metadata.action_type) || thought.action_type || '';
                cycle.decision = actionType || step.content.substring(0, 60);
            }

            // Mark completed when reflect phase arrives
            if (step.phase === 'reflect') {
                cycle.status = 'completed';
            }

            _runningCycleNumber = cycleNum;
            renderCycleList();
        }

        // Legacy wrapper - redirects old callers to new cycle system
        function addActivityLogItem(phase, content, timestamp, fullThought) {
            const thought = fullThought || { phase: phase, content: content, timestamp: timestamp || new Date().toISOString() };
            if (!thought.phase) thought.phase = phase;
            if (!thought.content) thought.content = content;
            if (!thought.timestamp) thought.timestamp = timestamp || new Date().toISOString();
            addThoughtToCycle(thought);
        }

        function _cycleFmt(d) {
            return String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
        }

        function renderCycleList() {
            ['activity-log-container', 'slide-activity-log'].forEach(function(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                const countEl = document.getElementById('activity-count');
                if (countEl) countEl.textContent = activityCycleOrder.length;

                container.textContent = '';

                if (activityCycleOrder.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'sidebar-empty';
                    const txt = document.createElement('div');
                    txt.className = 'sidebar-empty-text';
                    txt.style.opacity = '0.4';
                    txt.style.fontSize = '0.72rem';
                    txt.textContent = 'Waiting for activity...';
                    empty.appendChild(txt);
                    container.appendChild(empty);
                    return;
                }

                activityCycleOrder.forEach(function(cycleNum) {
                    const cycle = activityCycles[cycleNum];
                    if (!cycle) return;

                    const row = document.createElement('div');
                    row.className = 'cycle-row' + (cycle.status === 'running' ? ' running' : '');
                    row.onclick = function() { showCycleDetail(cycleNum); };

                    // Cycle number
                    const numEl = document.createElement('span');
                    numEl.className = 'cycle-number';
                    numEl.textContent = '#' + cycleNum;

                    // Time range
                    const timeEl = document.createElement('span');
                    timeEl.className = 'cycle-time';
                    const s = new Date(cycle.startTime);
                    const e = new Date(cycle.endTime);
                    timeEl.textContent = _cycleFmt(s) + '\u2192' + _cycleFmt(e);

                    // Step count
                    const stepsEl = document.createElement('span');
                    stepsEl.className = 'cycle-steps';
                    const mainSteps = cycle.steps.filter(function(s) { return !s.isBrowserStep; }).length;
                    const browserSteps = cycle.steps.filter(function(s) { return s.isBrowserStep; }).length;
                    stepsEl.textContent = '[' + mainSteps + (browserSteps ? '+' + browserSteps : '') + ']';

                    // Decision summary (truncated)
                    const decEl = document.createElement('span');
                    decEl.className = 'cycle-decision';
                    const decText = cycle.decision || '';
                    decEl.textContent = decText.length > 30 ? decText.substring(0,30) + '...' : decText;

                    // Status indicator
                    const statusEl = document.createElement('span');
                    statusEl.className = 'cycle-status ' + cycle.status;
                    statusEl.textContent = cycle.status === 'completed' ? '\u2713' : cycle.status === 'running' ? '\u25C9' : '\u2717';

                    row.appendChild(numEl);
                    row.appendChild(timeEl);
                    row.appendChild(stepsEl);
                    row.appendChild(decEl);
                    row.appendChild(statusEl);
                    container.appendChild(row);
                });
            });
        }

        // Legacy alias
        function renderActivityLog() { renderCycleList(); }

        function clearActivityLog() {
            activityCycles = {};
            activityCycleOrder = [];
            _runningCycleNumber = 0;
            activityLog = [];
            // Persist cleared state - any thoughts before this timestamp will be ignored
            activityLogClearedAt = Date.now();
            localStorage.setItem('cerebro_activity_cleared_at', activityLogClearedAt.toString());
            renderCycleList();
            showToast('Activity log cleared', 'success');
        }

        // Show cycle detail modal with tree/hierarchy view
        function showCycleDetail(cycleNum) {
            const cycle = activityCycles[cycleNum];
            if (!cycle) return;

            // Remove existing modal
            const old = document.getElementById('cycle-modal-overlay');
            if (old) old.remove();

            const overlay = document.createElement('div');
            overlay.id = 'cycle-modal-overlay';
            overlay.className = 'cycle-modal-overlay';
            overlay.addEventListener('click', function(ev) { if (ev.target === overlay) overlay.remove(); });

            const modal = document.createElement('div');
            modal.className = 'cycle-modal';

            // Header
            const header = document.createElement('div');
            header.className = 'cycle-modal-header';
            const titleEl = document.createElement('span');
            titleEl.className = 'cycle-modal-title';
            titleEl.textContent = 'Cycle ' + cycleNum + (cycle.decision ? ' \u2014 ' + cycle.decision : '');
            const closeBtn = document.createElement('button');
            closeBtn.className = 'cycle-modal-close';
            closeBtn.textContent = '\u00D7';
            closeBtn.onclick = function() { overlay.remove(); };
            header.appendChild(titleEl);
            header.appendChild(closeBtn);
            modal.appendChild(header);

            // Meta line
            const metaDiv = document.createElement('div');
            metaDiv.className = 'cycle-modal-meta';
            var _s = new Date(cycle.startTime);
            var _e = new Date(cycle.endTime);
            var _mainSteps = cycle.steps.filter(function(st) { return !st.isBrowserStep; }).length;
            var _browserSteps = cycle.steps.filter(function(st) { return st.isBrowserStep; }).length;
            metaDiv.textContent = _cycleFmt(_s) + ' \u2192 ' + _cycleFmt(_e) + '  \u2022  ' + _mainSteps + ' phases' + (_browserSteps ? ' + ' + _browserSteps + ' browser steps' : '') + '  \u2022  ' + cycle.status;
            modal.appendChild(metaDiv);

            // Build tree: group steps by phase
            var phaseOrder = ['observe', 'orient', 'decide', 'act', 'reflect'];
            var mainStepsList = cycle.steps.filter(function(st) { return !st.isBrowserStep; });
            var browserStepsList = cycle.steps.filter(function(st) { return st.isBrowserStep; });

            phaseOrder.forEach(function(phase) {
                var phaseSteps = mainStepsList.filter(function(st) { return st.phase === phase; });
                if (phaseSteps.length === 0) return;

                var step = phaseSteps[0];
                var phaseDiv = document.createElement('div');
                phaseDiv.className = 'cycle-tree-phase';

                // Phase header (clickable)
                var phaseHeader = document.createElement('div');
                phaseHeader.className = 'cycle-tree-phase-header';

                var chevron = document.createElement('span');
                chevron.className = 'cycle-tree-chevron';
                chevron.textContent = '\u25B8';

                var badge = document.createElement('span');
                badge.className = 'cycle-tree-phase-badge ' + phase;
                badge.textContent = phase.toUpperCase();

                var timeSpan = document.createElement('span');
                timeSpan.className = 'cycle-tree-phase-time';
                if (step.timestamp) {
                    var td = new Date(step.timestamp);
                    timeSpan.textContent = _cycleFmt(td) + ':' + String(td.getSeconds()).padStart(2,'0');
                }

                var summarySpan = document.createElement('span');
                summarySpan.className = 'cycle-tree-phase-summary';
                var summaryText = step.content || '';
                summarySpan.textContent = summaryText.length > 80 ? summaryText.substring(0, 80) + '...' : summaryText;

                phaseHeader.appendChild(chevron);
                phaseHeader.appendChild(badge);
                phaseHeader.appendChild(timeSpan);
                phaseHeader.appendChild(summarySpan);

                // Details panel (hidden by default)
                var details = document.createElement('div');
                details.className = 'cycle-tree-details';

                // Full content
                var contentLabel = document.createElement('div');
                contentLabel.className = 'cycle-tree-detail-label';
                contentLabel.textContent = 'Content';
                var contentDiv = document.createElement('div');
                contentDiv.className = 'cycle-tree-detail-content';
                contentDiv.textContent = step.content;
                details.appendChild(contentLabel);
                details.appendChild(contentDiv);

                // Reasoning
                if (step.reasoning) {
                    var reasonLabel = document.createElement('div');
                    reasonLabel.className = 'cycle-tree-detail-label';
                    reasonLabel.textContent = 'Reasoning';
                    var reasonDiv = document.createElement('div');
                    reasonDiv.className = 'cycle-tree-detail-content';
                    reasonDiv.style.color = 'rgba(255,255,255,0.5)';
                    reasonDiv.textContent = step.reasoning;
                    details.appendChild(reasonLabel);
                    details.appendChild(reasonDiv);
                }

                // Confidence bar
                if (step.confidence > 0) {
                    var confDiv = document.createElement('div');
                    confDiv.className = 'cycle-tree-confidence';
                    var pct = Math.round(step.confidence * 100);
                    var confColor = step.confidence > 0.7 ? '#10b981' : step.confidence > 0.4 ? '#f59e0b' : '#ef4444';
                    var confLabel = document.createElement('span');
                    confLabel.style.cssText = 'font-size:0.68rem;color:var(--text-muted)';
                    confLabel.textContent = 'Confidence: ';
                    var confBarOuter = document.createElement('span');
                    confBarOuter.className = 'cycle-tree-confidence-bar';
                    var confBarInner = document.createElement('span');
                    confBarInner.className = 'cycle-tree-confidence-fill';
                    confBarInner.style.width = pct + '%';
                    confBarInner.style.background = confColor;
                    confBarOuter.appendChild(confBarInner);
                    var confText = document.createElement('span');
                    confText.style.cssText = 'font-size:0.68rem;color:' + confColor;
                    confText.textContent = pct + '%';
                    confDiv.appendChild(confLabel);
                    confDiv.appendChild(confBarOuter);
                    confDiv.appendChild(confText);
                    details.appendChild(confDiv);
                }

                // Browser steps nested under ACT
                if (phase === 'act' && browserStepsList.length > 0) {
                    var bsContainer = document.createElement('div');
                    bsContainer.className = 'cycle-tree-browser-steps';
                    var bsLabel = document.createElement('div');
                    bsLabel.className = 'cycle-tree-detail-label';
                    bsLabel.textContent = 'Browser Steps (' + browserStepsList.length + ')';
                    bsContainer.appendChild(bsLabel);

                    browserStepsList.forEach(function(bs) {
                        var bsData = bs.browserStepData || {};
                        var bsRow = document.createElement('div');
                        bsRow.className = 'cycle-tree-browser-step';

                        var bsNum = document.createElement('span');
                        bsNum.className = 'cycle-tree-browser-step-num';
                        bsNum.textContent = bsData.step_number || '#';

                        var bsAction = document.createElement('span');
                        bsAction.className = 'cycle-tree-browser-step-action';
                        bsAction.textContent = bsData.action || bs.content.substring(0, 40);

                        var bsDetail = document.createElement('span');
                        bsDetail.className = 'cycle-tree-browser-step-detail';
                        bsDetail.textContent = (bsData.reasoning || '').substring(0, 60);

                        bsRow.appendChild(bsNum);
                        bsRow.appendChild(bsAction);
                        bsRow.appendChild(bsDetail);
                        bsContainer.appendChild(bsRow);
                    });
                    details.appendChild(bsContainer);
                }

                // Toggle expand/collapse
                phaseHeader.onclick = function() {
                    details.classList.toggle('open');
                    chevron.classList.toggle('open');
                };

                phaseDiv.appendChild(phaseHeader);
                phaseDiv.appendChild(details);
                modal.appendChild(phaseDiv);
            });

            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        // Legacy compat
        function showThoughtDetail(idx) {
            if (activityCycleOrder.length > 0 && idx < activityCycleOrder.length) {
                showCycleDetail(activityCycleOrder[idx]);
            }
        }

        function closeThoughtDetail() {
            var modal = document.getElementById('thought-detail-modal');
            if (modal) modal.classList.remove('active');
            var overlay = document.getElementById('cycle-modal-overlay');
            if (overlay) overlay.remove();
        }

        // ==================== CEREBRO CHAT (Conversational Interface) ====================

        // Store for Cerebro conversation (proper chat history)
        let cerebroChat = [];

        let _cerebroChatLoaded = false;
        async function loadCerebroChat(force = false) {
            // Skip reload if already loaded and not forced - prevents wiping in-flight messages
            if (_cerebroChatLoaded && !force) {
                renderChatMessages();
                return;
            }
            try {
                const response = await fetch(`${API_URL}/api/autonomy/chat`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await response.json();
                if (data.messages) {
                    // Preserve any in-flight messages (typing indicators, unsaved user msgs)
                    const inFlight = cerebroChat.filter(m => m.typing || (m.id && m.id.startsWith('msg_') && !data.messages.find(s => s.id === m.id)));
                    cerebroChat = [...data.messages, ...inFlight];
                    _cerebroChatLoaded = true;
                    renderChatMessages();
                }
            } catch (e) {
                console.error('Failed to load Cerebro chat:', e);
            }
        }

        async function clearCerebroChat() {
            if (!await cerebroConfirm('Clear conversation with Cerebro?', { title: 'Clear Chat', danger: true, confirmText: 'Clear' })) return;
            try {
                await fetch(`${API_URL}/api/autonomy/chat`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                cerebroChat = [];
                renderChatMessages();
                showToast('Chat cleared', 'success');
            } catch (e) {
                console.error('Failed to clear chat:', e);
            }
        }

        // ===== NEW CHAT SYSTEM =====
        async function sendChatMessage() {
            const input = document.getElementById('cerebro-chat-field');
            const btn = document.querySelector('.chat-send-btn');
            const message = input?.value?.trim();

            if (!message) return;

            // Disable input while processing
            if (input) input.disabled = true;
            if (btn) btn.disabled = true;

            // Add user message immediately
            cerebroChat.push({
                id: 'msg_' + Date.now(),
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });
            renderChatMessages();

            // Clear input
            if (input) input.value = '';

            // Add typing indicator
            const typingId = 'typing_' + Date.now();
            cerebroChat.push({
                id: typingId,
                role: 'assistant',
                typing: true,
                timestamp: new Date().toISOString()
            });
            renderChatMessages();

            try {
                const response = await fetch(`${API_URL}/api/autonomy/ask`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question: message })
                });

                const data = await response.json();

                // Remove typing and add real response
                cerebroChat = cerebroChat.filter(m => m.id !== typingId);
                cerebroChat.push({
                    id: 'msg_' + (Date.now() + 1),
                    role: 'assistant',
                    content: data.answer || 'I couldn\'t formulate a response.',
                    timestamp: new Date().toISOString()
                });
                renderChatMessages();

            } catch (e) {
                console.error('Failed to message Cerebro:', e);
                cerebroChat = cerebroChat.filter(m => m.id !== typingId);
                cerebroChat.push({
                    id: 'msg_' + (Date.now() + 1),
                    role: 'assistant',
                    content: 'Sorry, I couldn\'t process that right now.',
                    timestamp: new Date().toISOString()
                });
                renderChatMessages();
            }

            // Re-enable input
            if (input) input.disabled = false;
            if (btn) btn.disabled = false;
            if (input) input.focus();
        }

        function smartAutoScroll(container) {
            if (!container) return;
            // Only auto-scroll if user is near the bottom (within 150px)
            const threshold = 150;
            const isNearBottom = (container.scrollHeight - container.scrollTop - container.clientHeight) < threshold;
            if (isNearBottom) {
                container.scrollTop = container.scrollHeight;
            }
        }

        function renderChatMessages() {
            const container = document.getElementById('cerebro-chat-area');
            if (!container) return;

            if (cerebroChat.length === 0) {
                container.innerHTML = `
                    <div class="chat-welcome">
                        <div class="chat-welcome-icon"></div>
                        <div class="chat-welcome-text">Chat with Cerebro</div>
                        <div class="chat-welcome-hint">Ask anything or give me a task</div>
                    </div>
                `;
                return;
            }

            let html = '';
            cerebroChat.forEach((msg, idx) => {
                if (msg.typing) {
                    html += `
                        <div class="chat-message cerebro typing">
                            <div class="typing-indicator">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                    `;
                } else if (msg.isNarration || msg.isIdleNarration) {
                    const label = msg.isIdleNarration ? 'IDLE' : 'LIVE';
                    const narrationHtml = safeMarkdown(msg.content);
                    html += `
                        <div class="chat-message cerebro narration" data-msg-idx="${idx}">
                            <div class="narration-label"><span class="narration-dot"></span>${label}</div>
                            <div class="chat-message-content narration-content">${narrationHtml}</div>
                        </div>
                    `;
                } else if (msg.isQuestion) {
                    html += `
                        <div class="chat-message cerebro narration" data-msg-idx="${idx}" style="border-color: rgba(234,179,8,0.35); background: rgba(234,179,8,0.04);">
                            <div class="narration-label" style="color: #facc15;"><span class="narration-dot" style="background: #facc15;"></span>INPUT NEEDED</div>
                            <div class="chat-message-content">${escapeHtml(msg.content)}</div>
                        </div>
                    `;
                } else if (msg.type === 'browser_step') {
                    const screenshotHtml = msg.screenshot
                        ? `<img src="data:image/png;base64,${msg.screenshot}" style="max-width:100%;border-radius:8px;margin-top:8px;cursor:pointer;" onclick="window.open(this.src,'_blank')" />`
                        : '';
                    html += `
                        <div class="chat-message cerebro narration" data-msg-idx="${idx}" style="border-color: rgba(96,165,250,0.35); background: rgba(96,165,250,0.04);">
                            <div class="narration-label" style="color: #60a5fa;"><span class="narration-dot" style="background: #60a5fa;"></span>BROWSER</div>
                            <div class="chat-message-content">${escapeHtml(msg.content)}</div>
                            ${screenshotHtml}
                        </div>
                    `;
                } else {
                    const isUser = msg.role === 'user';
                    const speakerBtn = !isUser ? `
                        <button class="chat-speak-btn" onclick="speakChatMessage(${idx}, this)" title="Listen">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                            </svg>
                        </button>
                    ` : '';
                    const renderedContent = isUser ? escapeHtml(msg.content) : safeMarkdown(msg.content);
                    html += `
                        <div class="chat-message ${isUser ? 'user' : 'cerebro'}" data-msg-idx="${idx}">
                            <div class="chat-message-content">${renderedContent}</div>
                            ${speakerBtn}
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
            smartAutoScroll(container);

            // Update questions badge
            updateQuestionsBadge();
        }

        // ===== MIND CHAT (Centered chat below orb) =====
        // Mirrors the sidebar chat functionality in the new centered layout

        // Track status message in chat
        let currentStatusMsgId = null;

        function injectStatusToChat(text, label) {
            if (!text || text.includes('Touch the orb to awaken me')) return;
            // Skip status injection when narration is active (narration replaces status updates)
            if (window._narrationActive) return;

            // Remove previous status message
            if (currentStatusMsgId) {
                cerebroChat = cerebroChat.filter(m => m.id !== currentStatusMsgId);
            }

            // Add new status message (special type)
            currentStatusMsgId = 'status_' + Date.now();
            cerebroChat.push({
                id: currentStatusMsgId,
                role: 'assistant',
                content: text,
                timestamp: new Date().toISOString(),
                isStatus: true,
                statusLabel: label || 'Cerebro'
            });

            renderChatMessages();
        }

        // Safe markdown rendering helper - sanitized via DOMPurify
        function safeMarkdown(text) {
            try {
                const raw = typeof marked !== 'undefined' ? marked.parse(text || '') : escapeHtml(text || '');
                return typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(raw) : escapeHtml(text || '');
            } catch(e) {
                return escapeHtml(text || '');
            }
        }

        // Determine card phase from message data
        function getCardPhase(msg) {
            // New: message_type takes priority for badge/styling
            if (msg.message_type && ['thought', 'action', 'message', 'alert'].includes(msg.message_type)) {
                return msg.message_type;
            }
            if (msg.isIdleNarration || msg.isIdle) return 'idle';
            if (msg.isQuestion) return 'input';
            if (msg.phases && msg.phases.length > 0) {
                const p = msg.phases[msg.phases.length - 1];
                if (['observe', 'orient', 'decide', 'act', 'reflect', 'idle'].includes(p)) return p;
            }
            if (msg.isNarration) return 'observe';
            return '';
        }

        // Build a structured card element (all content sanitized via DOMPurify)
        function buildCardElement(msg, phase) {
            const div = document.createElement('div');
            let cardClasses = 'mind-chat-msg card';
            if (msg.isIdleNarration || msg.isIdle) cardClasses += ' idle-card';
            if (msg.isQuestion) cardClasses += ' question-card';
            // Apply message_type card styling
            if (msg.message_type && ['thought', 'action', 'message', 'alert'].includes(msg.message_type)) {
                cardClasses += ' ' + msg.message_type + '-card';
            }
            div.className = cardClasses;

            // Header
            const header = document.createElement('div');
            header.className = 'card-header';
            const headerLeft = document.createElement('div');
            headerLeft.className = 'card-header-left';

            // LIVE dot for active narration
            if (msg.isNarration && !msg.isIdleNarration) {
                const dot = document.createElement('span');
                dot.className = 'card-live-dot';
                headerLeft.appendChild(dot);
            }

            // Phase badge
            if (phase) {
                const badge = document.createElement('span');
                const phaseLabel = phase === 'input' ? 'INPUT NEEDED' : phase.toUpperCase();
                badge.className = 'card-phase ' + (phase === 'input' ? 'orient' : phase);
                badge.textContent = phaseLabel;
                headerLeft.appendChild(badge);
            }

            header.appendChild(headerLeft);

            // Timestamp
            const ts = document.createElement('span');
            ts.className = 'card-timestamp';
            try {
                const d = new Date(msg.timestamp || Date.now());
                ts.textContent = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            } catch(e) { ts.textContent = ''; }
            header.appendChild(ts);
            div.appendChild(header);

            // Body
            const body = document.createElement('div');
            body.className = 'card-body';

            const content = document.createElement('div');
            content.className = 'card-content';
            // Content is sanitized by safeMarkdown (DOMPurify)
            const sanitizedHtml = safeMarkdown(msg.content);
            content.appendChild(document.createRange().createContextualFragment(sanitizedHtml));

            // Collapsible for long content
            if ((msg.content || '').length > 300) {
                content.classList.add('collapsed');
                body.appendChild(content);
                const expandBtn = document.createElement('button');
                expandBtn.className = 'card-expand-btn';
                expandBtn.textContent = '[ expand ]';
                expandBtn.onclick = () => {
                    content.classList.toggle('collapsed');
                    expandBtn.textContent = content.classList.contains('collapsed') ? '[ expand ]' : '[ collapse ]';
                };
                body.appendChild(expandBtn);
            } else {
                body.appendChild(content);
            }

            // Browser step screenshot
            if (msg.type === 'browser_step' && msg.screenshot) {
                const img = document.createElement('img');
                img.src = 'data:image/png;base64,' + msg.screenshot;
                img.style.cssText = 'max-width:100%;border-radius:8px;margin-top:8px;cursor:pointer;';
                img.onclick = () => window.open(img.src, '_blank');
                body.appendChild(img);
            }

            // Question-specific elements
            if (msg.isQuestion) {
                if (msg.context) {
                    const ctx = document.createElement('div');
                    ctx.className = 'question-card-context';
                    ctx.textContent = msg.context;
                    body.appendChild(ctx);
                }
                const replyBtn = document.createElement('button');
                replyBtn.className = 'question-reply-btn';
                replyBtn.textContent = 'Reply to this';
                replyBtn.onclick = () => setReplyContext(msg.questionId, msg.content);
                body.appendChild(replyBtn);
            }

            div.appendChild(body);
            return div;
        }

        function renderMindChat() {
            const container = document.getElementById('mind-chat-messages');
            if (!container) return;

            if (cerebroChat.length === 0) {
                container.textContent = '';
                const welcome = document.createElement('div');
                welcome.className = 'mind-chat-welcome';
                welcome.appendChild(Object.assign(document.createElement('div'), { className: 'mind-chat-welcome-icon', textContent: '' }));
                welcome.appendChild(Object.assign(document.createElement('div'), { className: 'mind-chat-welcome-text', textContent: 'Chat with Cerebro' }));
                welcome.appendChild(Object.assign(document.createElement('div'), { className: 'mind-chat-welcome-hint', textContent: 'Ask anything or give me a task' }));
                container.appendChild(welcome);
                return;
            }

            container.textContent = '';

            // Cap rendered messages to last 100 for performance
            const maxRender = 100;
            const startIdx = Math.max(0, cerebroChat.length - maxRender);
            if (startIdx > 0) {
                const loadMore = document.createElement('div');
                loadMore.className = 'mind-chat-load-more';
                loadMore.textContent = `${startIdx} earlier messages...`;
                loadMore.onclick = () => {
                    cerebroChat._renderAll = true;
                    renderMindChat();
                };
                container.appendChild(loadMore);
            }

            const renderFrom = cerebroChat._renderAll ? 0 : startIdx;
            delete cerebroChat._renderAll;

            // Merge consecutive narration messages of the SAME type into a single card
            let lastNarrationCard = null;
            let lastNarrationContentEl = null;
            let lastNarrationMsgType = null;

            for (let i = renderFrom; i < cerebroChat.length; i++) {
                const msg = cerebroChat[i];

                if (msg.typing) {
                    lastNarrationCard = null;
                    const div = document.createElement('div');
                    div.className = 'mind-chat-msg cerebro typing';
                    const indicator = document.createElement('div');
                    indicator.className = 'typing-indicator';
                    for (let j = 0; j < 3; j++) indicator.appendChild(document.createElement('span'));
                    div.appendChild(indicator);
                    container.appendChild(div);
                } else if (msg.role === 'user') {
                    lastNarrationCard = null;
                    const div = document.createElement('div');
                    div.className = 'mind-chat-msg user';
                    // Show reply-to banner if this was a reply
                    if (msg.replyToContent) {
                        const banner = document.createElement('div');
                        banner.className = 'msg-reply-banner';
                        banner.textContent = msg.replyToContent.substring(0, 80) + (msg.replyToContent.length > 80 ? '...' : '');
                        div.appendChild(banner);
                        div.style.borderLeft = '2px solid rgba(139,92,246,0.4)';
                    } else if (msg.replyTo) {
                        div.title = 'Reply to question';
                        div.style.borderLeft = '2px solid #facc15';
                    }
                    div.appendChild(document.createTextNode(msg.content));
                    container.appendChild(div);
                    // Timestamp
                    const tsDiv = document.createElement('div');
                    tsDiv.className = 'msg-timestamp';
                    tsDiv.textContent = formatMsgTime(msg.timestamp);
                    container.appendChild(tsDiv);
                } else if (msg.isStatus) {
                    lastNarrationCard = null;
                    const div = document.createElement('div');
                    div.className = 'mind-chat-msg status';
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'status-label';
                    const dot = document.createElement('span');
                    dot.className = 'status-dot';
                    labelDiv.appendChild(dot);
                    labelDiv.appendChild(document.createTextNode(msg.statusLabel || 'Cerebro'));
                    div.appendChild(labelDiv);
                    const contentDiv = document.createElement('div');
                    contentDiv.textContent = msg.content;
                    div.appendChild(contentDiv);
                    container.appendChild(div);
                    const tsDiv = document.createElement('div');
                    tsDiv.className = 'msg-timestamp';
                    tsDiv.textContent = formatMsgTime(msg.timestamp);
                    container.appendChild(tsDiv);
                } else if (msg.isNarration || msg.isIdleNarration || msg.isQuestion) {
                    const curMsgType = msg.message_type || 'narration';
                    // Questions always get their own card
                    if (msg.isQuestion) {
                        lastNarrationCard = null;
                        lastNarrationMsgType = null;
                        const phase = getCardPhase(msg);
                        container.appendChild(buildCardElement(msg, phase));
                    } else if (lastNarrationCard && !msg.isQuestion && curMsgType === lastNarrationMsgType) {
                        // Merge into existing narration card of SAME type  append content
                        const newContent = (msg.content || '').trim();
                        if (newContent && lastNarrationContentEl) {
                            const sep = document.createElement('div');
                            sep.style.cssText = 'border-top:1px solid rgba(139,92,246,0.1); margin:6px 0;';
                            lastNarrationContentEl.appendChild(sep);
                            const fragment = document.createRange().createContextualFragment(safeMarkdown(newContent));
                            lastNarrationContentEl.appendChild(fragment);
                        }
                    } else {
                        // New card (first narration, or different message_type)
                        const phase = getCardPhase(msg);
                        const card = buildCardElement(msg, phase);
                        // Click-to-reply on narration cards
                        card.onclick = (e) => {
                            if (e.target.closest('button') || e.target.closest('a')) return;
                            setChatReplyTo(msg.id, msg.content);
                        };
                        container.appendChild(card);
                        lastNarrationCard = card;
                        lastNarrationContentEl = card.querySelector('.card-content');
                        lastNarrationMsgType = curMsgType;
                    }
                } else {
                    lastNarrationCard = null;
                    // Regular assistant message - use card if it has phase info
                    const phase = getCardPhase(msg);
                    if (phase) {
                        const card = buildCardElement(msg, phase);
                        card.onclick = (e) => {
                            if (e.target.closest('button') || e.target.closest('a')) return;
                            setChatReplyTo(msg.id, msg.content);
                        };
                        container.appendChild(card);
                    } else {
                        // Plain assistant message with markdown rendering
                        const div = document.createElement('div');
                        div.className = 'mind-chat-msg cerebro';
                        const sanitized = safeMarkdown(msg.content);
                        div.appendChild(document.createRange().createContextualFragment(sanitized));
                        // Click-to-reply
                        div.onclick = (e) => {
                            if (e.target.closest('a')) return;
                            setChatReplyTo(msg.id, msg.content);
                        };
                        container.appendChild(div);
                        // Timestamp
                        const tsDiv = document.createElement('div');
                        tsDiv.className = 'msg-timestamp';
                        tsDiv.textContent = formatMsgTime(msg.timestamp);
                        container.appendChild(tsDiv);
                    }
                }
            }
            smartAutoScroll(container);
        }

        // Mind chat FAB functions
        function toggleMindFab() {
            const btn = document.getElementById('mind-fab-btn');
            const menu = document.getElementById('mind-fab-menu');
            if (btn && menu) {
                btn.classList.toggle('open');
                menu.classList.toggle('open');
            }
        }
        function closeMindFab() {
            const btn = document.getElementById('mind-fab-btn');
            const menu = document.getElementById('mind-fab-menu');
            if (btn && menu) {
                btn.classList.remove('open');
                menu.classList.remove('open');
            }
        }
        function scrollMindChatToBottom() {
            const container = document.getElementById('mind-chat-messages');
            if (container) container.scrollTop = container.scrollHeight;
        }
        async function refreshMindChat() {
            await loadCerebroChat(true);  // force reload from server
            renderMindChat();
            showToast('Chat refreshed', 'success');
        }
        // Close mind fab when clicking outside
        document.addEventListener('click', (e) => {
            const container = document.querySelector('.mind-fab-container');
            if (container && !container.contains(e.target)) {
                closeMindFab();
            }
        });

        // Override renderChatMessages to also update mind chat
        const _origRenderChat = renderChatMessages;
        renderChatMessages = function() {
            _origRenderChat();
            renderMindChat();
        };

        // ===== ORB TABBED PANEL =====
        let currentOrbTab = 'info';

        function switchOrbTab(tabName) {
            currentOrbTab = tabName;
            document.querySelectorAll('.orb-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.orb-tab[data-orbtab="${tabName}"]`)?.classList.add('active');
            document.querySelectorAll('.orb-tab-pane').forEach(p => p.classList.remove('active'));
            document.getElementById(`orb-pane-${tabName}`)?.classList.add('active');
            if (tabName === 'info') updateTamagotchiUI();
            if (tabName === 'completed') renderOrbCompleted();
            if (tabName === 'command') renderOrbCommand();
            if (tabName === 'browser') renderOrbBrowser();
        }

        // ===== TAMAGOTCHI HEALTH ENGINE =====
        const tamagotchiState = {
            mood: 'content',
            energy: 0,
            memoryHealth: { nas: false, faiss: false, faiss_mb: 0 },
            xp: 0,
            level: 1,
            levelProgress: 0,
            lastInteraction: Date.now(),
            recentErrors: [],
            actionTimestamps: [],
            hitlPending: false
        };

        function recordAction() {
            tamagotchiState.actionTimestamps.push(Date.now());
            const oneHourAgo = Date.now() - 3600000;
            tamagotchiState.actionTimestamps = tamagotchiState.actionTimestamps.filter(t => t > oneHourAgo);
        }
        function recordError() {
            tamagotchiState.recentErrors.push(Date.now());
            const fiveMinAgo = Date.now() - 300000;
            tamagotchiState.recentErrors = tamagotchiState.recentErrors.filter(t => t > fiveMinAgo);
        }
        function recordInteraction() {
            tamagotchiState.lastInteraction = Date.now();
        }

        function computeEnergy() {
            const oneHourAgo = Date.now() - 3600000;
            const recent = tamagotchiState.actionTimestamps.filter(t => t > oneHourAgo);
            const raw = Math.min(recent.length / 60, 1);
            const lastAction = tamagotchiState.actionTimestamps.length > 0
                ? tamagotchiState.actionTimestamps[tamagotchiState.actionTimestamps.length - 1] : 0;
            const idleMin = (Date.now() - lastAction) / 60000;
            const drain = Math.max(0, idleMin - 2) * 0.02;
            return Math.max(0, Math.min(1, raw - drain));
        }

        function computeMood() {
            const fiveMinAgo = Date.now() - 300000;
            const recentErrors = tamagotchiState.recentErrors.filter(t => t > fiveMinAgo).length;
            const idleMinutes = (Date.now() - tamagotchiState.lastInteraction) / 60000;
            const energy = computeEnergy();
            if (recentErrors >= 3) return 'frustrated';
            if (tamagotchiState.hitlPending) return 'confused';
            if (idleMinutes > 30) return 'lonely';
            if (idleMinutes > 10) return 'bored';
            if (energy > 0.7 && idleMinutes < 2) return 'excited';
            if (energy > 0.3 || idleMinutes < 5) return 'happy';
            return 'content';
        }

        function updateOrbMood(mood) {
            const orb = document.getElementById('consciousness-orb');
            if (!orb) return;
            ['mood-excited','mood-happy','mood-content','mood-bored','mood-lonely','mood-confused','mood-frustrated']
                .forEach(c => orb.classList.remove(c));
            if (mood !== 'content') {
                orb.classList.add('mood-' + mood);
            }
        }

        function updateTamagotchiUI() {
            const energy = computeEnergy();
            const mood = computeMood();
            tamagotchiState.mood = mood;
            tamagotchiState.energy = energy;

            // Mood bar
            const moodFill = document.getElementById('tama-mood-fill');
            const moodLabel = document.getElementById('tama-mood-label');
            const moodLevels = { excited: 95, happy: 75, content: 60, bored: 40, lonely: 20, confused: 50, frustrated: 30 };
            if (moodFill) {
                moodFill.style.width = (moodLevels[mood] || 50) + '%';
                moodFill.className = 'tama-bar-fill mood-fill ' + mood;
            }
            if (moodLabel) moodLabel.textContent = mood.charAt(0).toUpperCase() + mood.slice(1);

            // Energy bar
            const energyFill = document.getElementById('tama-energy-fill');
            const energyValue = document.getElementById('tama-energy-value');
            if (energyFill) energyFill.style.width = Math.round(energy * 100) + '%';
            if (energyValue) energyValue.textContent = Math.round(energy * 100) + '%';

            // Memory health bar
            const memFill = document.getElementById('tama-memory-fill');
            const memValue = document.getElementById('tama-memory-value');
            const mh = tamagotchiState.memoryHealth;
            let memPct = 0;
            let memClass = 'memory-fill';
            let memText = 'Offline';
            if (mh.nas) {
                memPct = mh.faiss ? 100 : 50;
                memClass = mh.faiss ? 'memory-fill' : 'memory-fill degraded';
                memText = mh.faiss ? ('OK (' + mh.faiss_mb + 'MB)') : 'NAS only';
            } else {
                memClass = 'memory-fill offline';
            }
            if (memFill) { memFill.style.width = memPct + '%'; memFill.className = 'tama-bar-fill ' + memClass; }
            if (memValue) memValue.textContent = memText;

            // XP bar
            const xpFill = document.getElementById('tama-xp-fill');
            const xpValue = document.getElementById('tama-xp-value');
            if (xpFill) xpFill.style.width = Math.round(tamagotchiState.levelProgress * 100) + '%';
            if (xpValue) xpValue.textContent = 'Lv ' + tamagotchiState.level + ' \u00b7 ' + tamagotchiState.xp + ' XP';

            // Phase indicator
            const phaseDot = document.getElementById('tama-phase-dot');
            const phaseLabel = document.getElementById('tama-phase-label');
            const phaseMap = {
                'observe': { cls: 'observing', label: 'Observing' },
                'orient': { cls: 'running', label: 'Orienting' },
                'decide': { cls: 'running', label: 'Deciding' },
                'act': { cls: 'acting', label: 'Acting' },
                'reflect': { cls: 'running', label: 'Reflecting' },
                'idle': { cls: 'running', label: 'Idle' }
            };
            const phase = (typeof autonomyState !== 'undefined' && autonomyState.status === 'running')
                ? (phaseMap[autonomyState.phase] || { cls: 'running', label: 'Active' })
                : { cls: 'dormant', label: 'Dormant' };
            if (phaseDot) phaseDot.className = 'tama-phase-dot ' + phase.cls;
            if (phaseLabel) phaseLabel.textContent = phase.label;

            // Autonomy pips (clickable)
            const pipsContainer = document.getElementById('tama-autonomy-pips');
            if (pipsContainer) {
                const lvl = (typeof autonomyState !== 'undefined' ? autonomyState.level : 2) || 2;
                pipsContainer.textContent = '';
                for (let i = 1; i <= 5; i++) {
                    const pip = document.createElement('span');
                    pip.className = 'tama-pip' + (i <= lvl ? ' filled' : '');
                    pip.title = 'Level ' + i;
                    pip.dataset.level = i;
                    pip.onclick = function() {
                        const newLevel = parseInt(this.dataset.level);
                        if (typeof setAutonomyLevel === 'function') {
                            setAutonomyLevel(newLevel);
                        }
                        // Immediately update pips visually
                        pipsContainer.querySelectorAll('.tama-pip').forEach(function(p) {
                            if (parseInt(p.dataset.level) <= newLevel) {
                                p.classList.add('filled');
                            } else {
                                p.classList.remove('filled');
                            }
                        });
                    };
                    pipsContainer.appendChild(pip);
                }
            }

            // Mini stat cards
            const sa = document.getElementById('tama-stat-actions');
            const sc = document.getElementById('tama-stat-cycles');
            const sp = document.getElementById('tama-stat-pending');
            if (typeof autonomyState !== 'undefined') {
                if (sa) sa.textContent = autonomyState.actions || 0;
                if (sc) sc.textContent = autonomyState.cycles || 0;
                if (sp) sp.textContent = autonomyState.pending || 0;
            }

            // Apply mood to orb
            updateOrbMood(mood);
        }

        async function fetchTamagotchiBackend() {
            try {
                const resp = await fetch(API_URL + '/api/cerebro/tamagotchi');
                if (resp.ok) {
                    const data = await resp.json();
                    tamagotchiState.xp = data.lifetime_xp || 0;
                    tamagotchiState.level = data.level || 1;
                    tamagotchiState.levelProgress = data.level_progress || 0;
                    tamagotchiState.memoryHealth.nas = data.memory_health?.nas_connected || false;
                    tamagotchiState.memoryHealth.faiss = data.memory_health?.faiss_ok || false;
                    tamagotchiState.memoryHealth.faiss_mb = data.memory_health?.faiss_size_mb || 0;
                }
            } catch (e) { /* Backend unavailable */ }
        }

        // Merged command tab renderer  directives + focus as cards
        function renderOrbCommand() {
            const container = document.getElementById('orb-active-directives');
            if (!container) return;
            const active = (directives || []).filter(d => d.status !== 'completed');
            const focusItems = (typeof currentFocus !== 'undefined' ? currentFocus : []);
            container.textContent = '';

            if (active.length === 0 && focusItems.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'orb-command-empty';
                empty.textContent = 'No active directives. Give Cerebro a task below.';
                container.appendChild(empty);
                return;
            }

            // Only show FOCUS for items Cerebro is actively working on (status === 'active')
            const activeFocusItems = focusItems.filter(item => item.status === 'active');
            const focusIds = new Set(activeFocusItems.map(item => item.id));

            activeFocusItems.forEach(function(item) {
                const card = document.createElement('div');
                card.className = 'directive-card';
                const badge = document.createElement('span');
                badge.className = 'directive-status-badge active';
                badge.textContent = 'Focus';
                const text = document.createElement('span');
                text.className = 'directive-card-text';
                text.textContent = item.text || item.name || 'Task';
                card.appendChild(badge);
                card.appendChild(text);
                container.appendChild(card);
            });

            // Show remaining directives (skip ones already shown as FOCUS)
            active.filter(d => !focusIds.has(d.id)).forEach(function(d) {
                const card = document.createElement('div');
                card.className = 'directive-card';
                const badge = document.createElement('span');
                badge.className = 'directive-status-badge pending';
                badge.textContent = 'Pending';
                const text = document.createElement('span');
                text.className = 'directive-card-text';
                text.textContent = d.text;
                const btn = document.createElement('button');
                btn.className = 'directive-card-btn';
                btn.title = 'Complete';
                btn.onclick = function() { completeDirective(d.id); };
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('viewBox', '0 0 24 24');
                svg.setAttribute('width', '14');
                svg.setAttribute('height', '14');
                svg.setAttribute('fill', 'none');
                svg.setAttribute('stroke', 'currentColor');
                svg.setAttribute('stroke-width', '2');
                const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                polyline.setAttribute('points', '20 6 9 17 4 12');
                svg.appendChild(polyline);
                btn.appendChild(svg);
                card.appendChild(badge);
                card.appendChild(text);
                card.appendChild(btn);
                container.appendChild(card);
            });
        }

        // Start tamagotchi timers
        setInterval(updateTamagotchiUI, 30000);
        setInterval(fetchTamagotchiBackend, 120000);
        setTimeout(function() { fetchTamagotchiBackend().then(function() { updateTamagotchiUI(); }); }, 2000);

        async function addOrbDirective() {
            const input = document.getElementById('orb-directive-input');
            const text = input?.value?.trim();
            if (!text) return;
            const autoAwake = document.getElementById('auto-awake-checkbox')?.checked ?? true;
            try {
                const response = await fetch(`${API_URL}/api/directives`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text, auto_awake: autoAwake })
                });
                const data = await response.json();
                if (data.success) {
                    directives.unshift(data.directive);
                    input.value = '';
                    renderDirectives();
                    recordInteraction();
                    recordAction();
                    showToast('Directive added', 'success');
                } else {
                    showToast(data.error || 'Failed', 'error');
                }
            } catch (e) {
                showToast('Failed to add directive', 'error');
            }
        }

        function renderOrbDirectives() {
            // Delegate to the new card-based renderer
            if (typeof renderOrbCommand === 'function') return renderOrbCommand();
        }

        function renderOrbFocus() {
            const container = document.getElementById('orb-focus-list');
            const countEl = document.getElementById('orb-focus-count');
            if (!container) return;
            const items = typeof currentFocus !== 'undefined' ? currentFocus : [];
            if (countEl) countEl.textContent = items.length;
            container.textContent = '';
            if (items.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'orb-pane-empty';
                empty.textContent = 'No active focus items';
                container.appendChild(empty);
                return;
            }
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'orb-list-item';
                el.onclick = () => { openSlidePanel('skills'); switchToTab('focus'); };
                const dot = document.createElement('span');
                dot.className = 'item-dot active';
                const text = document.createElement('span');
                text.className = 'item-text';
                text.textContent = item.text || item.name || 'Task';
                const meta = document.createElement('span');
                meta.className = 'item-meta';
                meta.textContent = item.status === 'active' ? 'Working' : 'Queued';
                el.appendChild(dot);
                el.appendChild(text);
                el.appendChild(meta);
                container.appendChild(el);
            });
        }

        function renderOrbCompleted() {
            const container = document.getElementById('orb-completed-list');
            const countEl = document.getElementById('orb-completed-count');
            if (!container) return;
            const items = typeof completedTasks !== 'undefined' ? completedTasks : [];
            if (countEl) countEl.textContent = items.length;
            container.textContent = '';
            if (items.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'orb-pane-empty';
                empty.textContent = 'No completed tasks yet';
                container.appendChild(empty);
                return;
            }
            // Clear all button
            const clearRow = document.createElement('div');
            clearRow.style.cssText = 'display:flex;justify-content:flex-end;padding:4px 8px 2px;';
            const clearBtn = document.createElement('button');
            clearBtn.style.cssText = 'background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.7rem;display:flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;transition:all 0.2s;';
            clearBtn.onmouseenter = () => { clearBtn.style.color = '#f87171'; clearBtn.style.background = 'rgba(248,113,113,0.1)'; };
            clearBtn.onmouseleave = () => { clearBtn.style.color = 'var(--text-muted)'; clearBtn.style.background = 'none'; };
            clearBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg> Clear all';
            clearBtn.onclick = () => clearCompletedDirectives();
            clearRow.appendChild(clearBtn);
            container.appendChild(clearRow);

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'orb-list-item';
                el.onclick = () => { openSlidePanel('skills'); switchToTab('completed'); };
                const dot = document.createElement('span');
                dot.className = 'item-dot done';
                const text = document.createElement('span');
                text.className = 'item-text';
                text.textContent = item.text || item.name || 'Task';
                const meta = document.createElement('span');
                meta.className = 'item-meta';
                meta.textContent = formatTimeAgo(new Date(item.completed_at || item.created_at));
                el.appendChild(dot);
                el.appendChild(text);
                el.appendChild(meta);
                container.appendChild(el);
            });
        }

        function renderOrbSkills() {
            const container = document.getElementById('orb-skills-list');
            const countEl = document.getElementById('orb-skills-count');
            if (!container) return;
            const items = typeof window.skillsList !== 'undefined' ? window.skillsList : [];
            if (countEl) countEl.textContent = items.length;
            container.textContent = '';
            if (items.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'orb-pane-empty';
                empty.textContent = 'No learned skills yet';
                container.appendChild(empty);
                return;
            }
            items.forEach(s => {
                const el = document.createElement('div');
                el.className = 'orb-list-item';
                const dot = document.createElement('span');
                dot.className = 'item-dot skill';
                const text = document.createElement('span');
                text.className = 'item-text';
                text.textContent = s.name || s.skill_name || 'Skill';
                const meta = document.createElement('span');
                meta.className = 'item-meta';
                meta.textContent = s.success_rate ? Math.round(s.success_rate * 100) + '%' : '';
                el.appendChild(dot);
                el.appendChild(text);
                el.appendChild(meta);
                container.appendChild(el);
            });
        }

        async function sendMindChatMessage() {
            const input = document.getElementById('mind-chat-field');
            const btn = document.querySelector('.mind-chat-send-btn');
            const message = input?.value?.trim();

            if (!message) return;

            // Tamagotchi: record user interaction
            recordInteraction();
            recordAction();

            // === REPLY CONTEXT: Route to HITL response ===
            if (_replyContext) {
                const qId = _replyContext.questionId;

                // Add user reply to chat
                cerebroChat.push({
                    id: 'msg_' + Date.now(),
                    role: 'user',
                    content: message,
                    timestamp: new Date().toISOString(),
                    replyTo: qId
                });
                if (input) input.value = '';
                renderChatMessages();

                // Emit HITL response
                if (socket) {
                    const popup = hitlPopups.find(p => p.id === qId);
                    socket.emit('human_input_response', {
                        request_id: qId,
                        directive_id: popup ? (popup.data.directive_id || '') : '',
                        answer: message,
                        timestamp: new Date().toISOString()
                    });
                }

                // Dismiss the modal popup
                dismissHITLPopup(qId);

                // Clear reply context
                clearReplyContext();

                // Re-enable input
                if (input) input.disabled = false;
                if (btn) btn.disabled = false;

                showToast('Response sent to Cerebro', 'success');
                return;
            }

            // Capture reply context before clearing
            const replyTo = _chatReplyTo ? { id: _chatReplyTo.id, content: _chatReplyTo.content } : null;
            clearChatReplyTo();

            // Disable input
            if (input) input.disabled = true;
            if (btn) btn.disabled = true;

            // Add user message (with reply context if replying)
            const userMsg = {
                id: 'msg_' + Date.now(),
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            };
            if (replyTo) {
                userMsg.replyToId = replyTo.id;
                userMsg.replyToContent = replyTo.content;
            }
            cerebroChat.push(userMsg);
            renderChatMessages();

            // Clear input
            if (input) input.value = '';

            // v2.0: ALL messages route as directives  Claude Code agents
            // Agent narration streams back via cerebro_narration socket events
            const autoAwake = document.getElementById('auto-awake-checkbox')?.checked ?? true;
            try {
                const response = await fetch(`${API_URL}/api/directives`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: replyTo ? `[Replying to: "${replyTo.content.substring(0, 200)}"]\n\n${message}` : message,
                        auto_awake: autoAwake
                    })
                });
                const data = await response.json();
                cerebroChat.push({
                    id: 'msg_' + (Date.now() + 1),
                    role: 'assistant',
                    content: 'Working on it...',
                    timestamp: new Date().toISOString()
                });
                renderChatMessages();
            } catch (e) {
                console.error('Directive submit error:', e);
                cerebroChat.push({
                    id: 'msg_' + (Date.now() + 1),
                    role: 'assistant',
                    content: 'Failed to submit directive. Try the Command tab instead.',
                    timestamp: new Date().toISOString()
                });
                renderChatMessages();
            }

            // Re-enable
            if (input) input.disabled = false;
            if (btn) btn.disabled = false;
            if (input) input.focus();
        }

        // Text-to-Speech for Cerebro messages
        let currentSpeech = null;
        async function speakText(text, btnElement) {
            // Stop any current speech
            stopSpeaking();

            // If clicking the same button that was playing, just stop
            if (btnElement && (btnElement.classList.contains('speaking') || btnElement.classList.contains('loading'))) {
                btnElement.classList.remove('speaking', 'loading');
                return;
            }

            // Clear all speaking/loading states
            document.querySelectorAll('.chat-speak-btn.speaking, .chat-speak-btn.loading, .voice-speak-btn.speaking, .voice-speak-btn.loading').forEach(function(btn) {
                btn.classList.remove('speaking', 'loading');
            });

            // Strip markdown/HTML for cleaner speech
            var cleanText = text
                .replace(/```[\s\S]*?```/g, ' code block ')
                .replace(/\*\*([^*]+)\*\*/g, '$1')
                .replace(/\*([^*]+)\*/g, '$1')
                .replace(/#{1,6}\s/g, '')
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
                .replace(/`([^`]+)`/g, '$1')
                .replace(/[\-*]{3,}/g, '')
                .replace(/^[\s]*[\-*+]\s/gm, '')
                .replace(/^[\s]*\d+\.\s/gm, '')
                .replace(/\n{2,}/g, '. ')
                .replace(/\n/g, ' ')
                .trim();

            // Cap at ~500 chars for speed (Kokoro CPU gets slow on long text)
            if (cleanText.length > 500) {
                var cutPoint = cleanText.lastIndexOf('.', 500);
                if (cutPoint < 200) cutPoint = cleanText.lastIndexOf(' ', 500);
                if (cutPoint < 200) cutPoint = 500;
                cleanText = cleanText.substring(0, cutPoint + 1);
            }
            if (!cleanText) return;

            // Immediate loading feedback
            if (btnElement) btnElement.classList.add('loading');
            setSpeakingState(true, 'loading');

            try {
                var response = await fetch(TTS_URL + '/v1/audio/speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'kokoro',
                        input: cleanText,
                        voice: TTS_CONFIG.voice,
                        response_format: 'mp3',
                        speed: TTS_CONFIG.speed
                    })
                });

                if (!response.ok) throw new Error('TTS ' + response.status);

                // Switch loading -> speaking
                if (btnElement) {
                    btnElement.classList.remove('loading');
                    btnElement.classList.add('speaking');
                }
                setSpeakingState(true, 'speaking');

                var audioBlob = await response.blob();
                var audioUrl = URL.createObjectURL(audioBlob);
                currentAudio = new Audio(audioUrl);

                if (selectedSpeakerId && currentAudio.setSinkId) {
                    try { await currentAudio.setSinkId(selectedSpeakerId); } catch(e) {}
                }

                currentAudio.onended = function() {
                    setSpeakingState(false);
                    URL.revokeObjectURL(audioUrl);
                    currentAudio = null;
                    if (btnElement) btnElement.classList.remove('speaking', 'loading');
                };
                currentAudio.onerror = function() {
                    setSpeakingState(false);
                    if (btnElement) btnElement.classList.remove('speaking', 'loading');
                    showToast('Audio playback failed');
                };

                await currentAudio.play();
            } catch (e) {
                console.error('[TTS] speakText error:', e);
                setSpeakingState(false);
                if (btnElement) btnElement.classList.remove('speaking', 'loading');

                // Fallback: browser speech synthesis
                try {
                    if (window.speechSynthesis) {
                        var utterance = new SpeechSynthesisUtterance(cleanText);
                        utterance.rate = TTS_CONFIG.speed;
                        utterance.onend = function() {
                            if (btnElement) btnElement.classList.remove('speaking');
                        };
                        if (btnElement) btnElement.classList.add('speaking');
                        window.speechSynthesis.speak(utterance);
                    } else {
                        showToast('Voice unavailable');
                    }
                } catch (fb) {
                    showToast('Voice unavailable');
                }
            }
        }

        // Speak the main voice content (center bubble)
        function speakVoiceContent() {
            const voiceContent = document.getElementById('voice-content');
            const btn = document.getElementById('voice-speak-btn');
            if (voiceContent) {
                speakText(voiceContent.textContent, btn);
            }
        }

        // Speak a chat message by index (avoids escaping issues)
        function speakChatMessage(msgIdx, btnElement) {
            if (cerebroChat[msgIdx]) {
                speakText(cerebroChat[msgIdx].content, btnElement);
            }
        }

        function updateQuestionsBadge() {
            const badge = document.getElementById('cerebro-questions-badge');
            const countEl = document.getElementById('questions-badge-count');

            if (!badge) return;

            if (proactiveQuestions.length > 0) {
                badge.style.display = 'flex';
                if (countEl) countEl.textContent = proactiveQuestions.length;
            } else {
                badge.style.display = 'none';
            }
        }

        // ===== QUESTIONS WIZARD =====
        let wizardCurrentIndex = 0;

        function openQuestionsWizard() {
            if (proactiveQuestions.length === 0) {
                showToast('No questions from Cerebro', 'info');
                return;
            }

            wizardCurrentIndex = 0;
            const overlay = document.getElementById('questions-wizard-overlay');
            if (overlay) {
                overlay.classList.add('active');
                renderWizardQuestion();
            }
        }

        function closeQuestionsWizard() {
            const overlay = document.getElementById('questions-wizard-overlay');
            if (overlay) overlay.classList.remove('active');
        }

        function closeWizardIfBackground(event) {
            if (event.target.classList.contains('questions-wizard-overlay')) {
                closeQuestionsWizard();
            }
        }

        function renderWizardQuestion() {
            const content = document.getElementById('wizard-content');
            const progressBar = document.getElementById('wizard-progress-bar');
            const progressText = document.getElementById('wizard-progress-text');
            const prevBtn = document.getElementById('wizard-prev-btn');
            const nextBtn = document.getElementById('wizard-next-btn');

            if (!content || proactiveQuestions.length === 0) return;

            const question = proactiveQuestions[wizardCurrentIndex];
            const total = proactiveQuestions.length;
            const progress = ((wizardCurrentIndex + 1) / total) * 100;

            // Update progress
            if (progressBar) progressBar.style.setProperty('--progress', `${progress}%`);
            if (progressText) progressText.textContent = `${wizardCurrentIndex + 1} of ${total}`;

            // Update buttons
            if (prevBtn) prevBtn.disabled = wizardCurrentIndex === 0;
            if (nextBtn) nextBtn.textContent = wizardCurrentIndex === total - 1 ? 'Done ' : 'Next ';

            // Render question
            content.innerHTML = `
                <div class="wizard-question-tag">${question.type || question.tag || 'Question'}</div>
                <div class="wizard-question-text">${escapeHtml(question.question)}</div>
                <textarea class="wizard-answer-input" id="wizard-answer-field" placeholder="Type your answer..."></textarea>
            `;
        }

        function prevWizardQuestion() {
            if (wizardCurrentIndex > 0) {
                wizardCurrentIndex--;
                renderWizardQuestion();
            }
        }

        async function nextWizardQuestion() {
            const answerField = document.getElementById('wizard-answer-field');
            const answer = answerField?.value?.trim();
            const question = proactiveQuestions[wizardCurrentIndex];

            // If there's an answer, submit it
            if (answer && question) {
                try {
                    await fetch(`${API_URL}/api/autonomy/answer`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            question_id: question.id,
                            answer: answer
                        })
                    });

                    // Add to chat as a record
                    cerebroChat.push({
                        id: 'msg_' + Date.now(),
                        role: 'user',
                        content: `[Re: ${question.question.substring(0, 30)}...] ${answer}`,
                        timestamp: new Date().toISOString()
                    });

                    // Remove from questions
                    await dismissQuestion(question.id);
                } catch (e) {
                    console.error('Failed to submit answer:', e);
                }
            }

            // Move to next or close
            if (wizardCurrentIndex < proactiveQuestions.length - 1) {
                wizardCurrentIndex++;
                renderWizardQuestion();
            } else {
                closeQuestionsWizard();
                renderChatMessages();
                showToast('All questions answered!', 'success');
            }
        }

        function skipWizardQuestion() {
            const question = proactiveQuestions[wizardCurrentIndex];
            if (question) {
                dismissQuestion(question.id);
            }

            if (proactiveQuestions.length === 0) {
                closeQuestionsWizard();
                showToast('Questions cleared', 'info');
            } else {
                if (wizardCurrentIndex >= proactiveQuestions.length) {
                    wizardCurrentIndex = proactiveQuestions.length - 1;
                }
                renderWizardQuestion();
            }
        }

        // Legacy alias
        async function askCerebro() {
            // Redirect to new system
            const oldInput = document.getElementById('ask-cerebro-field');
            const newInput = document.getElementById('cerebro-chat-field');
            if (oldInput && newInput) {
                newInput.value = oldInput.value;
                oldInput.value = '';
            }
            await sendChatMessage();
        }

        function renderCerebroChat() {
            // Render both chat and update badge
            renderChatMessages();
            updateQuestionsBadge();
        }

        function answerProactiveQuestion(questionId) {
            // Find the question index
            const idx = proactiveQuestions.findIndex(q => q.id === questionId);
            if (idx === -1) return;

            // Open the wizard at this question
            wizardCurrentIndex = idx;
            openQuestionsWizard();
        }

        // Legacy alias for compatibility
        function renderQuestionsWithAnswers() {
            renderCerebroChat();
        }

        function addProactiveQuestion(question, context, tag = 'curious') {
            const item = {
                id: Date.now(),
                question: question,
                context: context,
                tag: tag,
                timestamp: new Date().toISOString()
            };

            proactiveQuestions.unshift(item);
            if (proactiveQuestions.length > 20) proactiveQuestions.pop();

            updateQuestionsBadge();  // Update the questions badge

            // Expand sidebar if collapsed and new question arrives
            const sidebar = document.getElementById('sidebar-questions');
            if (sidebar && sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
            }
        }

        function renderProactiveQuestions() {
            // Use the combined renderer that shows both answers and questions
            renderQuestionsWithAnswers();
        }

        // Current Focus - what Cerebro is working on
        let currentFocus = [];

        function updateCurrentFocus(focusItems) {
            currentFocus = focusItems || [];
            renderCurrentFocus();
            if (typeof renderOrbFocus === 'function') renderOrbFocus();
        }

        function renderCurrentFocus() {
            const container = document.getElementById('focus-container');
            const countEl = document.getElementById('focus-count');

            if (!container) return;

            if (countEl) countEl.textContent = currentFocus.length;

            if (currentFocus.length === 0) {
                container.innerHTML = `
                    <div class="section-empty">
                        <div class="section-empty-icon"></div>
                        <div class="section-empty-text">No active focus<br>Give Cerebro a directive</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = currentFocus.map(item => {
                const isGoal = item.type === 'goal';
                const typeIcon = isGoal ? '' : '';
                const typeLabel = isGoal ? 'Goal' : 'Task';
                const statusLabel = item.paused ? 'Paused' : (item.status === 'pending' ? 'Queued' : (isGoal ? 'Active' : 'Working'));

                return `
                <div class="focus-item ${item.status || 'active'}${item.paused ? ' paused' : ''}${isGoal ? ' goal-type' : ' task-type'}"
                     data-id="${item.id || ''}"
                     onclick="openFindingsPopup('${item.id || ''}')">
                    <div class="focus-item-status">
                        <div class="focus-status-indicator"></div>
                        <span class="focus-type-badge" title="${typeLabel}">${typeIcon}</span>
                        <span class="focus-status-label">${statusLabel}</span>
                    </div>
                    <div class="focus-item-text">${escapeHtml(item.text || item.directive || item.goal || '')}</div>
                    <div class="focus-item-progress" title="${item.saturation || 0}% ${isGoal ? 'progress' : 'completion'}">
                        <div class="focus-progress-bar ${isGoal ? 'goal-bar' : 'task-bar'}" style="width: ${item.saturation || 0}%"></div>
                    </div>
                    <div class="focus-item-controls" onclick="event.stopPropagation()">
                        <button class="focus-control-btn view" onclick="openFindingsPopup('${item.id || ''}')">View</button>
                        <button class="focus-control-btn pause" onclick="toggleDirectivePauseById('${item.id || ''}')">
                            ${item.paused ? 'Resume' : 'Pause'}
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        // Update focus when directives change
        function syncDirectivesToFocus() {
            const activeItems = directives.filter(d => d.status !== 'completed');
            const focusItems = activeItems.map((d, i) => ({
                id: d.id,
                text: d.text,
                type: d.type || 'task',  // task or goal
                status: d.status === 'active' ? 'active' : 'pending',
                paused: d.paused || false,
                saturation: d.saturation || 0,
                created_at: d.created_at
            }));
            updateCurrentFocus(focusItems);

            // Also update completed tasks
            const completedItems = directives.filter(d => d.status === 'completed');
            updateCompletedTasks(completedItems);
        }

        // ========================================
        // COMPLETED TASKS - Task History
        // ========================================
        let completedTasks = [];

        function updateCompletedTasks(items) {
            completedTasks = items || [];
            renderCompletedTasks();
            if (typeof renderOrbCompleted === 'function') renderOrbCompleted();
        }

        function renderCompletedTasks() {
            const container = document.getElementById('completed-container');
            const countEl = document.getElementById('completed-count');

            if (!container) return;

            if (countEl) countEl.textContent = completedTasks.length;

            if (completedTasks.length === 0) {
                container.innerHTML = `
                    <div class="section-empty">
                        <div class="section-empty-icon"></div>
                        <div class="section-empty-text">No completed tasks yet</div>
                    </div>
                `;
                return;
            }

            // Sort by completion time (most recent first)
            const sorted = [...completedTasks].sort((a, b) => {
                const timeA = a.completed_at ? new Date(a.completed_at) : new Date(a.created_at);
                const timeB = b.completed_at ? new Date(b.completed_at) : new Date(b.created_at);
                return timeB - timeA;
            });

            container.innerHTML = sorted.map(item => {
                const isGoal = item.type === 'goal';
                const typeIcon = isGoal ? '' : '';
                const typeLabel = isGoal ? 'Goal' : 'Task';
                const completedTime = item.completed_at ? formatTimeAgo(new Date(item.completed_at)) : 'Recently';

                return `
                <div class="completed-item" data-id="${item.id || ''}" onclick="openFindingsPopup('${item.id || ''}')">
                    <div class="completed-item-header">
                        <span class="completed-item-icon">${typeIcon}</span>
                        <span class="completed-item-text">${escapeHtml(item.text || '')}</span>
                    </div>
                    <div class="completed-item-meta">
                        <span class="completed-item-time">Completed ${completedTime}</span>
                        <span class="completed-item-type">${typeLabel}</span>
                    </div>
                </div>
            `}).join('');
        }

        async function clearCompletedDirectives() {
            try {
                const response = await fetch(`${API_URL}/api/directives/completed/clear`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                if (response.ok) {
                    directives = directives.filter(d => d.status !== 'completed');
                    completedTasks = [];
                    renderCompletedTasks();
                    if (typeof renderOrbCompleted === 'function') renderOrbCompleted();
                    renderDirectives();
                    showToast('Completed tasks cleared', 'info');
                } else {
                    showToast('Failed to clear completed tasks', 'error');
                }
            } catch (e) {
                showToast('Failed to clear completed tasks', 'error');
            }
        }

        function toggleCompletedSection() {
            const section = document.querySelector('.section-completed');
            if (section) {
                section.classList.toggle('section-collapsed');
            }
        }

        // ========================================
        // FINDINGS POPUP - Research Results
        // ========================================
        let currentFindingsDirective = null;
        let currentFindings = { all: [], observations: [], learnings: [], insights: [] };

        async function openFindingsPopup(directiveId) {
            if (!directiveId) return;

            const directive = directives.find(d => d.id === directiveId);
            if (!directive) return;

            currentFindingsDirective = directive;

            // Update header info
            const directiveText = document.getElementById('findings-directive-text');
            const statusDot = document.getElementById('findings-status-dot');
            const statusText = document.getElementById('findings-status-text');
            const startedText = document.getElementById('findings-started');

            if (directiveText) directiveText.textContent = directive.text;

            const isCompleted = directive.status === 'completed';

            if (statusDot) {
                statusDot.className = 'findings-meta-dot ' + (isCompleted ? 'completed' : directive.paused ? 'paused' : 'active');
            }
            if (statusText) {
                if (isCompleted) {
                    statusText.textContent = 'Completed';
                } else {
                    statusText.textContent = directive.paused ? 'Paused' : 'Actively researching';
                }
            }
            if (startedText && directive.created_at) {
                if (isCompleted && directive.completed_at) {
                    startedText.textContent = `Completed ${formatTimeAgo(new Date(directive.completed_at))}`;
                } else {
                    startedText.textContent = `Started ${formatTimeAgo(new Date(directive.created_at))}`;
                }
            }

            // Update findings count
            const findingsCount = document.getElementById('findings-count');
            if (findingsCount) {
                findingsCount.textContent = `${directive.findings_count || 0} findings`;
            }

            // Update pause button - hide for completed tasks
            const pauseBtn = document.getElementById('findings-pause-btn');
            const completeBtn = document.querySelector('.findings-btn.danger');
            if (pauseBtn) {
                if (isCompleted) {
                    pauseBtn.style.display = 'none';
                } else {
                    pauseBtn.style.display = 'block';
                    pauseBtn.textContent = directive.paused ? 'Resume Research' : 'Pause Research';
                }
            }
            if (completeBtn) {
                completeBtn.style.display = isCompleted ? 'none' : 'block';
            }

            // Show overlay
            const overlay = document.getElementById('findings-overlay');
            if (overlay) overlay.classList.add('active');

            // Load findings from backend
            await loadDirectiveFindings(directiveId);
        }

        function closeFindingsPopup() {
            const overlay = document.getElementById('findings-overlay');
            if (overlay) overlay.classList.remove('active');
            currentFindingsDirective = null;
        }

        function closeFindingsIfBackground(event) {
            if (event.target.classList.contains('findings-overlay')) {
                closeFindingsPopup();
            }
        }

        async function loadDirectiveFindings(directiveId) {
            try {
                const response = await fetch(`${API_URL}/api/directives/${directiveId}/findings`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });

                if (response.ok) {
                    const data = await response.json();

                    // Organize findings by type
                    currentFindings = {
                        all: data.findings || [],
                        observations: (data.findings || []).filter(f => f.type === 'observation'),
                        learnings: (data.findings || []).filter(f => f.type === 'learning'),
                        insights: (data.findings || []).filter(f => f.type === 'insight')
                    };

                    // Update counts
                    updateFindingsCounts();

                    // Update saturation
                    const saturation = data.saturation || 0;
                    const saturationFill = document.getElementById('saturation-fill');
                    const saturationPercent = document.getElementById('saturation-percent');
                    if (saturationFill) saturationFill.style.width = `${saturation}%`;
                    if (saturationPercent) saturationPercent.textContent = `${saturation}%`;

                    // For completed tasks, show Summary tab first to display final answer
                    const directive = currentFindingsDirective;
                    if (directive && directive.status === 'completed') {
                        switchFindingsTab('summary');
                    } else {
                        // Render current tab
                        renderFindings('all');
                    }
                } else {
                    // No findings endpoint yet, show empty state
                    currentFindings = { all: [], observations: [], learnings: [], insights: [] };
                    updateFindingsCounts();
                    renderFindings('all');
                }
            } catch (e) {
                console.error('Failed to load findings:', e);
                currentFindings = { all: [], observations: [], learnings: [], insights: [] };
                updateFindingsCounts();
                renderFindings('all');
            }
        }

        function updateFindingsCounts() {
            const countAll = document.getElementById('findings-count-all');
            const countObs = document.getElementById('findings-count-observations');
            const countLearn = document.getElementById('findings-count-learnings');
            const countInsight = document.getElementById('findings-count-insights');
            const countHeader = document.getElementById('findings-count');

            if (countAll) countAll.textContent = currentFindings.all.length;
            if (countObs) countObs.textContent = currentFindings.observations.length;
            if (countLearn) countLearn.textContent = currentFindings.learnings.length;
            if (countInsight) countInsight.textContent = currentFindings.insights.length;
            if (countHeader) countHeader.textContent = `${currentFindings.all.length} findings`;
        }

        function switchFindingsTab(tab) {
            // Update active tab
            document.querySelectorAll('.findings-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });

            // Handle Summary tab specially
            if (tab === 'summary') {
                renderSummary();
            } else {
                // Render findings for this tab
                renderFindings(tab);
            }
        }

        let cachedSummary = null;

        async function renderSummary() {
            const container = document.getElementById('findings-content');
            if (!container || !currentFindingsDirective) return;

            const directive = currentFindingsDirective;
            const isCompleted = directive.status === 'completed';

            // For completed tasks with a final_answer, show it immediately
            if (isCompleted && directive.final_answer) {
                const htmlContent = markdownToHtml(directive.final_answer);
                container.innerHTML = `
                    <div class="summary-content active" style="position: relative;">
                        <div class="final-answer-banner">
                            <span class="final-answer-icon"></span>
                            <span class="final-answer-label">Task Completed</span>
                        </div>
                        <div class="summary-report final-answer-content">
                            <h3 style="margin-top: 0; color: #10b981;">Cerebro's Answer</h3>
                            ${htmlContent}
                        </div>
                        <div class="summary-actions">
                            <button class="summary-action-btn secondary" onclick="switchFindingsTab('all')">
                                View All ${currentFindings.all.length} Findings
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            // Show loading state
            container.innerHTML = `
                <div class="summary-content active" style="position: relative;">
                    <div class="summary-loading">
                        <div class="summary-loading-spinner"></div>
                        <div>Generating summary report...</div>
                        <div style="font-size: 0.8rem; margin-top: 8px; opacity: 0.7;">Cerebro is synthesizing all findings</div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`${API_URL}/api/directives/${currentFindingsDirective.id}/summary`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await response.json();

                if (data.success && data.summary) {
                    // Convert markdown to HTML (basic conversion)
                    const htmlContent = markdownToHtml(data.summary);

                    container.innerHTML = `
                        <div class="summary-content active" style="position: relative;">
                            <button class="summary-refresh-btn" onclick="refreshSummary()"> Refresh</button>
                            <div class="summary-report">
                                ${htmlContent}
                            </div>
                            <div class="summary-actions">
                                ${data.saturation >= 80 && data.directive_type === 'task' ? `
                                    <button class="summary-action-btn primary" onclick="markDirectiveComplete()">
                                         Mark Task Complete
                                    </button>
                                ` : ''}
                                <button class="summary-action-btn secondary" onclick="switchFindingsTab('all')">
                                    View All Findings
                                </button>
                            </div>
                        </div>
                    `;
                    cachedSummary = data.summary;
                } else {
                    container.innerHTML = `
                        <div class="summary-content active">
                            <div class="findings-empty">
                                <div class="findings-empty-icon"></div>
                                <div class="findings-empty-text">Could not generate summary. Try again later.</div>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Failed to load summary:', e);
                container.innerHTML = `
                    <div class="summary-content active">
                        <div class="findings-empty">
                            <div class="findings-empty-icon"></div>
                            <div class="findings-empty-text">Error loading summary: ${e.message}</div>
                        </div>
                    </div>
                `;
            }
        }

        function refreshSummary() {
            cachedSummary = null;
            renderSummary();
        }

        function markdownToHtml(md) {
            // Basic markdown to HTML conversion
            return md
                // Headers
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Code
                .replace(/`(.*?)`/g, '<code>$1</code>')
                // Lists
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
                // Wrap consecutive li in ul
                .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
                // Paragraphs (lines not starting with special chars)
                .replace(/^(?!<[hul]|<li)(.*$)/gim, (match) => match.trim() ? `<p>${match}</p>` : '')
                // Clean up empty paragraphs
                .replace(/<p><\/p>/g, '')
                // Line breaks
                .replace(/\n\n/g, '<br>');
        }

        function renderFindings(tab) {
            const container = document.getElementById('findings-content');
            if (!container) return;

            const findings = currentFindings[tab] || [];

            if (findings.length === 0) {
                container.innerHTML = `
                    <div class="findings-empty">
                        <div class="findings-empty-icon"></div>
                        <div class="findings-empty-text">
                            ${tab === 'all'
                                ? 'No findings yet. Cerebro is still researching...'
                                : `No ${tab} found yet.`}
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = findings.map(f => `
                <div class="finding-item ${f.type || 'observation'}">
                    <div class="finding-type">
                        <span class="finding-type-dot"></span>
                        <span>${f.type || 'observation'}</span>
                    </div>
                    <div class="finding-text">${escapeHtml(f.content || f.text || '')}</div>
                    ${f.timestamp ? `<div class="finding-time">${formatTimeAgo(new Date(f.timestamp))}</div>` : ''}
                </div>
            `).join('');
        }

        async function toggleDirectivePause() {
            if (!currentFindingsDirective) return;
            await toggleDirectivePauseById(currentFindingsDirective.id);

            // Update UI
            const directive = directives.find(d => d.id === currentFindingsDirective.id);
            if (directive) {
                currentFindingsDirective = directive;
                const statusDot = document.getElementById('findings-status-dot');
                const statusText = document.getElementById('findings-status-text');
                const pauseBtn = document.getElementById('findings-pause-btn');

                if (statusDot) {
                    statusDot.className = 'findings-meta-dot ' + (directive.paused ? 'paused' : 'active');
                }
                if (statusText) {
                    statusText.textContent = directive.paused ? 'Paused' : 'Actively researching';
                }
                if (pauseBtn) {
                    pauseBtn.textContent = directive.paused ? 'Resume Research' : 'Pause Research';
                }
            }
        }

        async function toggleDirectivePauseById(directiveId) {
            try {
                const response = await fetch(`${API_URL}/api/directives/${directiveId}/toggle-pause`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    // Update local directive
                    const directive = directives.find(d => d.id === directiveId);
                    if (directive) {
                        directive.paused = data.paused;
                    }
                    renderDirectives();
                    showToast(data.paused ? 'Research paused' : 'Research resumed', 'info');
                }
            } catch (e) {
                console.error('Failed to toggle pause:', e);
                showToast('Failed to toggle pause', 'error');
            }
        }

        async function markDirectiveComplete() {
            if (!currentFindingsDirective) return;

            await completeDirective(currentFindingsDirective.id);
            closeFindingsPopup();
        }

        function openQuestionInput(questionId) {
            const question = proactiveQuestions.find(q => q.id === questionId);
            if (!question) return;

            currentQuestion = question;

            const inputText = document.getElementById('question-input-text');
            const answerField = document.getElementById('question-answer-field');
            const overlay = document.getElementById('question-input-overlay');

            if (inputText) inputText.textContent = question.question;
            if (answerField) answerField.value = '';
            if (overlay) overlay.classList.add('active');

            // Focus the textarea
            setTimeout(() => {
                const field = document.getElementById('question-answer-field');
                if (field) field.focus();
            }, 100);
        }

        function closeQuestionInput() {
            const overlay = document.getElementById('question-input-overlay');
            if (overlay) overlay.classList.remove('active');
            currentQuestion = null;
        }

        async function submitQuestionAnswer() {
            if (!currentQuestion) return;

            const answerField = document.getElementById('question-answer-field');
            const answer = answerField ? answerField.value.trim() : '';
            if (!answer) {
                showToast('Please provide an answer', 'warning');
                return;
            }

            try {
                // Send answer to backend
                const response = await fetch(`${API_URL}/api/autonomy/answer-question`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question_id: currentQuestion.id,
                        question: currentQuestion.question,
                        answer: answer
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('Thank you for sharing!', 'success');

                    // Remove question from list
                    dismissQuestion(currentQuestion.id);
                    closeQuestionInput();

                    // Add to activity log
                    addActivityLogItem('ask', `Answered: "${currentQuestion.question.substring(0, 50)}..."`);
                }
            } catch (e) {
                console.error('Failed to submit answer:', e);
                showToast('Failed to submit answer', 'error');
            }
        }

        async function dismissQuestion(questionId) {
            const idx = proactiveQuestions.findIndex(q => q.id === questionId);
            if (idx !== -1) {
                proactiveQuestions.splice(idx, 1);
                updateQuestionsBadge();
            }

            // Also delete from backend for persistence
            try {
                await fetch(`${API_URL}/api/autonomy/questions/${questionId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
            } catch (e) {
                console.error('Failed to delete question from backend:', e);
            }
        }

        async function clearAllQuestions() {
            if (!await cerebroConfirm('Clear all questions from Cerebro?', { title: 'Clear Questions', danger: true, confirmText: 'Clear' })) return;

            // Clear local array
            proactiveQuestions.length = 0;
            updateQuestionsBadge();

            // Clear from backend
            try {
                await fetch(`${API_URL}/api/autonomy/questions`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                showToast('Questions cleared', 'success');
            } catch (e) {
                console.error('Failed to clear questions:', e);
                showToast('Failed to clear questions', 'error');
            }
        }

        async function approveAction(actionId) {
            try {
                const response = await fetch(`${API_URL}/api/autonomy/approve/${actionId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await response.json();
                if (data.success) {
                    showToast('Action approved', 'success');
                    loadPendingApprovals();
                }
            } catch (e) {
                showToast('Failed to approve action', 'error');
            }
        }

        async function rejectAction(actionId) {
            try {
                const response = await fetch(`${API_URL}/api/autonomy/reject/${actionId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await response.json();
                if (data.success) {
                    showToast('Action rejected', 'info');
                    loadPendingApprovals();
                }
            } catch (e) {
                showToast('Failed to reject action', 'error');
            }
        }

        function renderThoughtStream() {
            const container = document.getElementById('thought-stream');
            const countEl = document.getElementById('thought-count');

            // Phase display names and icons for clarity
            const phaseDisplay = {
                observe: { name: 'OBSERVING', icon: '', color: '#3b82f6' },
                orient: { name: 'ANALYZING', icon: '', color: '#8b5cf6' },
                decide: { name: 'DECIDING', icon: '', color: '#f59e0b' },
                act: { name: 'ACTING', icon: '', color: '#ef4444' },
                reflect: { name: 'REFLECTING', icon: '', color: '#10b981' },
                idle: { name: 'IDLE', icon: '', color: '#6b7280' }
            };

            // Guard against missing elements
            if (!container) return;

            if (thoughtStream.length === 0) {
                const isRunning = autonomyState.status === 'running';
                container.innerHTML = isRunning ? `
                    <div class="goals-empty" style="padding: 30px;">
                        <div style="font-size: 2rem; animation: pulse 1.5s ease-in-out infinite;"></div>
                        <div style="margin-top: 8px; color: var(--accent);">Mind awakening...</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">First thoughts coming soon</div>
                    </div>` : `
                    <div class="goals-empty" style="padding: 30px;">
                        <div style="font-size: 2rem; opacity: 0.3;"></div>
                        <div style="margin-top: 8px;">Mind at rest</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Click the orb to awaken</div>
                    </div>`;
                if (countEl) countEl.textContent = isRunning ? 'awakening...' : '0 thoughts';
                return;
            }

            if (countEl) countEl.textContent = `${thoughtStream.length} thoughts`;
            container.innerHTML = thoughtStream.map(thought => {
                const time = new Date(thought.timestamp).toLocaleTimeString();
                const date = new Date(thought.timestamp).toLocaleDateString();
                const confidence = Math.round((thought.confidence || 0.5) * 100);
                const phase = phaseDisplay[thought.phase] || phaseDisplay.idle;

                // Check if this is a session marker
                if (thought.is_session_marker || thought.metadata?.is_session_marker) {
                    const markerType = thought.metadata?.marker_type || (thought.content?.includes('START') ? 'start' : 'end');
                    const levelName = thought.metadata?.level_name || '';
                    const cycles = thought.metadata?.cycles_completed || '';

                    if (markerType === 'start') {
                        return `
                            <div class="session-marker session-start">
                                <div class="session-marker-line"></div>
                                <div class="session-marker-content">
                                    <span class="session-marker-icon"></span>
                                    <span class="session-marker-text">Session Started</span>
                                    ${levelName ? `<span class="session-marker-level">${levelName}</span>` : ''}
                                </div>
                                <div class="session-marker-time">${date} ${time}</div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="session-marker session-end">
                                <div class="session-marker-line"></div>
                                <div class="session-marker-content">
                                    <span class="session-marker-icon"></span>
                                    <span class="session-marker-text">Session Ended</span>
                                    ${cycles ? `<span class="session-marker-cycles">${cycles} cycles</span>` : ''}
                                </div>
                                <div class="session-marker-time">${date} ${time}</div>
                            </div>
                        `;
                    }
                }

                // Make content more readable
                let content = thought.content || '';
                // Highlight key actions/decisions
                content = content.replace(/Decided:/gi, '<strong>Decision:</strong>');
                content = content.replace(/Observed:/gi, '<strong>Saw:</strong>');
                content = content.replace(/Recorded solution:/gi, '<strong>Learned:</strong>');

                return `
                    <div class="thought-item">
                        <div class="thought-header">
                            <span class="thought-phase" style="background: ${phase.color}20; color: ${phase.color}; border: 1px solid ${phase.color}40;">
                                ${phase.icon} ${phase.name}
                            </span>
                            <span class="thought-time">${time}</span>
                        </div>
                        <div class="thought-content">${escapeHtml(content).replace(/&lt;strong&gt;/g, '<strong>').replace(/&lt;\/strong&gt;/g, '</strong>')}</div>
                        <div class="thought-confidence">
                            <div class="thought-confidence-bar">
                                <div class="thought-confidence-fill" style="width: ${confidence}%; background: ${phase.color}"></div>
                            </div>
                            <span class="thought-confidence-value">${confidence}% confident</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPendingApprovals(pending) {
            const container = document.getElementById('pending-approvals');
            const listEl = document.getElementById('pending-approvals-list');

            // Guard against missing elements
            if (!container || !listEl) return;

            if (pending.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            listEl.innerHTML = pending.map(action => `
                <div class="approval-card">
                    <div class="approval-header">
                        <span class="approval-action">${escapeHtml(action.action_type)}</span>
                        <span class="approval-risk ${action.risk_level}">${action.risk_level}</span>
                    </div>
                    <div class="approval-description">${escapeHtml(action.description)}</div>
                    <div class="approval-buttons">
                        <button class="approval-btn approve" onclick="approveAction('${action.id}')"> Approve</button>
                        <button class="approval-btn reject" onclick="rejectAction('${action.id}')"> Reject</button>
                    </div>
                </div>
            `).join('');
        }

        function addThoughtToStream(thought) {
            // Add new thought at the beginning
            thoughtStream.unshift(thought);
            // Keep only last 50
            if (thoughtStream.length > 50) {
                thoughtStream = thoughtStream.slice(0, 50);
            }
            renderThoughtStream();

            // === NEW: Update Cerebro's voice with the thought ===
            updateCerebroVoice(thought);

            // === ADD TO CYCLE-BASED ACTIVITY LOG (all phases) ===
            if (thought && thought.phase && thought.content) {
                addThoughtToCycle(thought);
                setAlivePulse(false); // OODA is active, hide idle pulse
            }

            // Add to activity feed for notable events
            if (thought.phase === 'act' && thought.content) {
                const actionMatch = thought.content.match(/Executed:\s*(\w+)/);
                if (actionMatch) {
                    addActivityItem({
                        type: 'action',
                        text: `Executed: ${actionMatch[1]}`,
                        timestamp: new Date(thought.timestamp)
                    });
                }
            } else if (thought.phase === 'reflect' && thought.type === 'learning') {
                addActivityItem({
                    type: 'learning',
                    text: thought.content || 'Recorded a learning',
                    timestamp: new Date(thought.timestamp)
                });
            } else if (thought.phase === 'decide' && thought.metadata?.action_type && thought.metadata?.action_type !== 'no_action') {
                addActivityItem({
                    type: 'search',
                    text: `Decided: ${thought.metadata.action_type}`,
                    timestamp: new Date(thought.timestamp)
                });
            }

            // Enhanced highlight for new thought - makes it feel ALIVE
            const firstThought = document.querySelector('.thought-item');
            if (firstThought) {
                firstThought.classList.add('new');
                firstThought.classList.add('typing');
                setTimeout(() => firstThought.classList.remove('typing'), 800);
                setTimeout(() => firstThought.classList.remove('new'), 2500);
            }

            // Flash the consciousness orb
            const orb = document.getElementById('consciousness-orb');
            if (orb) {
                orb.style.transition = 'transform 0.15s ease';
                orb.style.transform = 'scale(1.02)';
                setTimeout(() => orb.style.transform = '', 150);
            }
        }

        // Update Cerebro's voice with a thought (first-person communication)
        // Convert raw thought objects to rich voice messages
        // (Called from thought_stream handler - delegates to main updateCerebroVoice)
        function processThoughtVoice(thought) {
            const content = thought.content || '';
            let voiceText = '';

            switch (thought.phase) {
                case 'observe':
                    if (content.includes('goals')) {
                        voiceText = "I'm scanning your goals and active projects...";
                    } else if (content.includes('memory')) {
                        voiceText = "I'm reaching into the memory banks, gathering context...";
                    } else {
                        voiceText = "I sense " + content.replace(/^Saw:|^Observed:/i, '').trim().toLowerCase();
                    }
                    break;
                case 'orient':
                    voiceText = thought.reasoning || ("I'm thinking about what this means... " + content.substring(0, 100));
                    break;
                case 'decide':
                    voiceText = (content.includes('no_action') || content.includes('No action'))
                        ? "I've considered my options. For now, I'll continue observing."
                        : "I've decided: " + content.replace(/^Decision:|^Decided:/i, '').trim();
                    break;
                case 'act':
                    voiceText = "I'm taking action now. " + content.replace(/^Executed:|^Action:/i, '').trim();
                    break;
                case 'reflect':
                    if (content.includes('success') || content.includes('Success')) {
                        voiceText = "That worked well. I'm remembering this for next time.";
                    } else if (content.includes('failed') || content.includes('error')) {
                        voiceText = "That didn't go as planned. Let me learn from this...";
                    } else {
                        voiceText = "Reflecting on what just happened... " + content.substring(0, 80);
                    }
                    break;
                default:
                    voiceText = content.substring(0, 150);
            }

            if (voiceText) {
                const label = 'Cerebro \u2022 ' + (thought.phase?.charAt(0).toUpperCase() + thought.phase?.slice(1) || 'Thinking');
                updateCerebroVoice('thinking', { phase: thought.phase, message: voiceText, customLabel: label });
            }
        }

        // Socket.IO listeners for autonomy events
        function setupAutonomySocketListeners() {
            if (!socket) {
                console.log('[Autonomy] Socket not ready, will retry...');
                setTimeout(setupAutonomySocketListeners, 1000);
                return;
            }
            socket.on('autonomy_status', (data) => {
                autonomyState = {
                    status: data.status || 'stopped',
                    level: data.autonomy_level || 2,
                    cycles: data.cycles_completed || 0,
                    phase: data.current_phase || 'idle',
                    fullAutonomy: data.full_autonomy_enabled || false,
                    // Include actions and pending from status
                    actions: data.actions_completed || autonomyState.actions || 0,
                    pending: data.pending_count || autonomyState.pending || 0
                };
                updateAutonomyUI();

                // Show/hide live pulse indicator
                const pulse = document.getElementById('thought-pulse');
                if (pulse) {
                    pulse.style.display = data.status === 'running' ? 'inline-block' : 'none';
                }

                // Reset narration active flag when loop stops
                if (data.status === 'stopped' || data.status === 'error') {
                    window._narrationActive = false;
                    setAlivePulse(false);
                }
            });

            socket.on('thought_stream', (thought) => {
                addThoughtToStream(thought);
                // Track action for tamagotchi energy
                if (typeof recordAction === 'function') recordAction();
                // Update voice with rich thought-specific messages
                if (thought && thought.phase) {
                    processThoughtVoice(thought);
                }
            });

            socket.on('approval_needed', (action) => {
                showToast(` Approval needed: ${action.action_type}`, 'warning');
                loadPendingApprovals();
            });

            socket.on('emergency_stop', () => {
                autonomyState.status = 'stopped';
                updateAutonomyUI();
                showToast(' Emergency stop triggered!', 'error');
            });

            // Proactive questions - Cerebro asking the user meaningful questions
            socket.on('proactive_question', async (data) => {
                console.log('[Autonomy] Received proactive question:', data);
                addProactiveQuestion(
                    data.question || 'What are you thinking about?',
                    data.context || null,
                    data.tag || 'curious'
                );
                showToast(' Cerebro has a question for you', 'info');

                // PERSIST the question to backend for page refresh survival
                try {
                    await fetch(`${API_URL}/api/autonomy/questions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            question: data.question,
                            type: data.type || 'general',
                            options: data.options || [],
                            paths: data.paths || [],
                            directive_id: data.directive_id || ''
                        })
                    });
                } catch (e) {
                    console.error('Failed to persist question:', e);
                }
            });

            // Cognitive suggestions - insights from the AI
            socket.on('cognitive_suggestion', (suggestion) => {
                console.log('[Autonomy] Received suggestion:', suggestion);
                addInsight(suggestion);

                // Also add to voice stream as an insight message
                const voiceContent = document.getElementById('voice-content');
                if (voiceContent) {
                    voiceContent.textContent = suggestion.suggestion || suggestion.content || "I've discovered something interesting...";
                    voiceContent.classList.add('typing');
                    setTimeout(() => voiceContent.classList.remove('typing'), 2000);
                }

                // Add to message history as an insight
                addVoiceMessage(suggestion.suggestion || suggestion.content || "I found something.", 'insight');

                showToast(' Cerebro has a suggestion!', 'info');
            });

            // Debug feed listener - shows raw LLM calls and API activity
            socket.on('debug_feed', (event) => {
                addDebugEvent(event);

                // Handle skill-related debug events (event.type is set by _emit_debug)
                const eventType = event.type || event.event_type;
                if (eventType === 'skill_learned') {
                    console.log('[Skills] Skill learned via debug_feed:', event);
                    addSkillToPanel(event);  // event contains skill data directly
                    showToast(` New skill learned: ${event.name}`, 'success');
                    loadSkills(true);  // Reload skills to sync cache
                } else if (eventType === 'skill_reused') {
                    showToast(` Reused skill: ${event.skill_name}`, 'info');
                } else if (eventType === 'skill_verified') {
                    showToast(` Skill verified: ${event.skill_id}`, 'success');
                    loadSkills(true);
                }
            });

            // Activity backfill on connect - reconstruct cycles from server history
            socket.on('activity_backfill', (data) => {
                if (data && data.activity && data.activity.length > 0) {
                    console.log('[Activity] Backfill received:', data.activity.length, 'entries');
                    // Process oldest first so cycles build chronologically
                    var sorted = data.activity.slice().sort(function(a, b) {
                        return new Date(a.timestamp) - new Date(b.timestamp);
                    });
                    sorted.forEach(function(item) { addThoughtToCycle(item); });
                }
            });

            // Skills events (direct socket events, backup for debug_feed)
            socket.on('skill_learned', (data) => {
                console.log('[Skills] Skill learned (direct):', data);
                addSkillToPanel(data);
                showToast(` New skill learned: ${data.name}`, 'success');
                loadSkills(true);  // Sync cache
            });

            socket.on('skill_reused', (data) => {
                console.log('[Skills] Skill reused:', data);
                showToast(` Reused skill: ${data.skill_name}`, 'info');
                // Highlight the skill in the panel if visible
                const skillCard = document.querySelector(`[data-skill-id="${data.skill_id}"]`);
                if (skillCard) {
                    skillCard.classList.add('skill-active');
                    setTimeout(() => skillCard.classList.remove('skill-active'), 2000);
                }
            });

            socket.on('skill_executed', (data) => {
                console.log('[Skills] Skill executed:', data);
                if (data.success) {
                    showToast(` Skill executed: ${data.skill_name}`, 'success');
                } else {
                    showToast(` Skill failed: ${data.error || 'Unknown error'}`, 'error');
                }
            });

            socket.on('skill_verified', (data) => {
                console.log('[Skills] Skill verified:', data);
                showToast(
                    data.success
                        ? ` Skill verified: ${data.skill_name}`
                        : ` Skill verification failed: ${data.skill_name}`,
                    data.success ? 'success' : 'warning'
                );
                // Reload skills to show updated status
                loadSkills();
            });

            // === STORED ITEMS: Real-time sync ===
            socket.on('cerebro_stored_item_added', (item) => {
                storedItems.unshift(item);
                updateStoredBadge();
                if (_currentMindTab === 'answers') renderAnswerItems();
                else if (_currentMindTab === 'stored') renderStoredItems();
            });
            socket.on('cerebro_stored_item_removed', (data) => {
                storedItems = storedItems.filter(i => i.id !== data.id);
                updateStoredBadge();
                if (_currentMindTab === 'answers') renderAnswerItems();
                else if (_currentMindTab === 'stored') renderStoredItems();
            });

            // === HEARTBEAT: Monitor results ===
            socket.on('cerebro_heartbeat_complete', (data) => {
                const label = data.changed
                    ? `${data.findings_count} finding${data.findings_count > 1 ? 's' : ''}`
                    : 'All clear';
                const color = data.changed ? '#eab308' : 'var(--text-muted)';
                // Update slide panel
                const lastEl = document.getElementById('slide-heartbeat-last');
                if (lastEl) {
                    lastEl.textContent = label;
                    lastEl.style.color = color;
                }
                // Update floating editor status
                const editorStatus = document.getElementById('hb-editor-status');
                if (editorStatus) {
                    editorStatus.textContent = `Last: ${label}`;
                    editorStatus.style.color = color;
                }
                // Pulse heart icon when findings exist
                const heartBtn = document.getElementById('heartbeat-config-btn');
                if (heartBtn) {
                    if (data.changed) heartBtn.classList.add('has-findings');
                    else heartBtn.classList.remove('has-findings');
                }
                // Terminal activity log: add HB line only when findings exist
                if (data.changed) {
                    const cnt = data.findings_count || 0;
                    const hasAlert = (data.findings || []).some(f => f.severity === 'alert');
                    const tag = hasAlert ? 'alert' : 'hb';
                    addActivityLogItem(tag,
                        `${cnt} finding${cnt !== 1 ? 's' : ''} detected`,
                        data.timestamp || new Date().toISOString(), data);
                }
                // Alive pulse: show after heartbeat (idle state)
                setAlivePulse(true);
            });
            socket.on('cerebro_heartbeat_config_updated', (config) => {
                _heartbeatConfig = config;
                renderHeartbeatMonitors();
            });

            // === NARRATION: Live thought narration from Cerebro ===
            socket.on('cerebro_narration', (data) => {
                console.log('[Narration] Received:', data);
                window._narrationActive = true;
                const isIdle = data.is_idle || false;
                const content = (data.content || '').trim();
                // Skip empty narration (is_final signals with deduped content)
                if (!content && !data.is_final) return;
                if (content) {
                    cerebroChat.push({
                        id: data.id || ('narr_' + Date.now()),
                        role: 'assistant',
                        content: content,
                        timestamp: data.timestamp || new Date().toISOString(),
                        isNarration: true,
                        isIdleNarration: isIdle,
                        isIdle: isIdle,
                        phases: data.phases || [],
                        directive: data.directive || '',
                        message_type: data.message_type || ''
                    });
                }
                // When agent finishes, add step summary
                if (data.is_final && _agentBrowserStepCount > 0) {
                    cerebroChat.push({
                        id: 'step_summary_' + Date.now(),
                        role: 'assistant',
                        content: 'Browser task completed  ' + _agentBrowserStepCount + ' steps executed. See Browser tab for details.',
                        timestamp: new Date().toISOString(),
                        isNarration: true,
                        phases: ['act']
                    });
                    _agentBrowserStepCount = 0;
                }
                renderChatMessages();
                renderMindChat();
                // Auto-speak narration content
                if (content && TTS_CONFIG.autoSpeak && !isIdle && data.is_final) {
                    speak(content);
                }
            });

            // SimEngine simulation events
            socket.on('simulation_started', (data) => {
                console.log('[SimEngine] Simulation started:', data);
                addMessage(`Running simulation: "${data.query}"...`, 'tool');
            });

            socket.on('simulation_complete', (data) => {
                console.log('[SimEngine] Simulation complete:', data);
                renderSimulationCard(data);
                showSimulationModal(data);
                showToast('Simulation complete! Click to view results.', 'success');
                // Auto-store simulation result
                const simTs = Date.now();
                fetch(`${API_URL}/api/stored-items`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: 'stored_sim_' + simTs,
                        type: 'simulation',
                        title: data.query || 'Simulation Result',
                        content: [data.expected_value && ('EV: ' + data.expected_value), data.confidence && ('Confidence: ' + data.confidence), data.risk_assessment].filter(Boolean).join(' | ') || 'Completed',
                        metadata: data,
                        status: 'pending',
                        source_id: 'sim_' + simTs
                    })
                }).catch(e => console.error('Failed to store simulation:', e));
            });

            socket.on('simulation_error', (data) => {
                console.log('[SimEngine] Simulation error:', data);
                addMessage(`Simulation failed: ${data.error}`, 'assistant');
            });

            socket.on('simulation_clarification_needed', (data) => {
                console.log('[SimEngine] Clarification needed:', data);
                showSimClarificationModal(data);
            });

            socket.on('simulation_analysis_chat', (data) => {
                console.log('[SimEngine] Analysis chat:', data);
                var msgEl = addMessage(data.message, 'assistant');
                if (msgEl && data.suggestions && data.suggestions.length > 0) {
                    renderSimFollowups(msgEl, data);
                }
                // Also push to cerebro chat sidebar
                cerebroChat.push({
                    id: 'msg_' + Date.now(),
                    role: 'assistant',
                    content: data.message,
                    timestamp: new Date().toISOString()
                });
                renderChatMessages();
            });

            // Human-in-the-loop authentication
            socket.on('auth_needed', (data) => {
                console.log('[Auth] Authentication needed:', data);
                showAuthModal(data);
            });

            socket.on('auth_continued', (data) => {
                console.log('[Auth] Authentication completed:', data);
                hideAuthModal();
                showToast(' Authentication completed, resuming...', 'success');
            });

            console.log('[Autonomy] Socket listeners registered');
        }

        // Initialize autonomy socket listeners when socket is ready
        setTimeout(setupAutonomySocketListeners, 500);

        // ==================== HUMAN-IN-THE-LOOP POPUP SYSTEM ====================
        // NOTE: All dynamic content is sanitized via escapeHtml() before DOM insertion,
        // following the same pattern used throughout this codebase (renderThoughtStream,
        // renderPendingApprovals, formatDebugEvent, etc.)
        let hitlPopups = [];
        let hitlBrowserScreenshot = null;

        // Reply context state for question-in-chat replies
        let _replyContext = null;

        // General reply-to-message context (for replying to any assistant message)
        let _chatReplyTo = null;

        function formatMsgTime(ts) {
            if (!ts) return '';
            const d = new Date(ts);
            const now = new Date();
            const isToday = d.toDateString() === now.toDateString();
            const time = d.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});
            if (isToday) return time;
            return d.toLocaleDateString([], {month: 'short', day: 'numeric'}) + ', ' + time;
        }

        function setChatReplyTo(msgId, msgContent) {
            _chatReplyTo = { id: msgId, content: msgContent };
            const inputArea = document.querySelector('.mind-chat-input-bar');
            if (!inputArea) return;
            clearChatReplyTo(true);
            const bar = document.createElement('div');
            bar.className = 'reply-context-bar general';
            bar.id = 'chat-reply-bar';
            const textSpan = document.createElement('span');
            textSpan.className = 'reply-context-text';
            const preview = (msgContent || '').substring(0, 100) + ((msgContent || '').length > 100 ? '...' : '');
            textSpan.textContent = 'Replying to: ' + preview;
            bar.appendChild(textSpan);
            const closeBtn = document.createElement('button');
            closeBtn.className = 'reply-context-close';
            closeBtn.textContent = '\u00D7';
            closeBtn.onclick = (e) => { e.stopPropagation(); clearChatReplyTo(); };
            bar.appendChild(closeBtn);
            inputArea.insertBefore(bar, inputArea.firstChild);
            const input = document.getElementById('mind-chat-field');
            if (input) input.focus();
        }

        function clearChatReplyTo(skipNull) {
            const existing = document.getElementById('chat-reply-bar');
            if (existing) existing.remove();
            if (!skipNull) _chatReplyTo = null;
        }

        // Tab flash state
        let _tabFlashInterval = null;
        let _originalTitle = document.title;

        function playHITLNotificationSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                // Two-tone: D5 -> G5
                const osc1 = audioCtx.createOscillator();
                const osc2 = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                osc1.frequency.value = 587; // D5
                osc2.frequency.value = 784; // G5
                osc1.connect(gain);
                osc2.connect(gain);
                gain.connect(audioCtx.destination);
                osc1.start(audioCtx.currentTime);
                osc1.stop(audioCtx.currentTime + 0.25);
                osc2.start(audioCtx.currentTime + 0.25);
                osc2.stop(audioCtx.currentTime + 0.5);
            } catch(e) { console.log('[HITL] Sound failed:', e); }
        }

        function startTabFlash(message) {
            stopTabFlash();
            _originalTitle = document.title;
            let toggle = false;
            _tabFlashInterval = setInterval(() => {
                document.title = toggle ? message : _originalTitle;
                toggle = !toggle;
            }, 1000);
            // Stop on window focus
            window.addEventListener('focus', stopTabFlash, { once: true });
        }

        function stopTabFlash() {
            if (_tabFlashInterval) {
                clearInterval(_tabFlashInterval);
                _tabFlashInterval = null;
                document.title = _originalTitle;
            }
        }

        function setReplyContext(questionId, questionText) {
            _replyContext = { questionId, text: questionText };
            // Show reply bar above input
            const inputArea = document.querySelector('.mind-chat-input-bar');
            if (!inputArea) return;
            // Remove existing bar if any
            clearReplyContext(true);
            const bar = document.createElement('div');
            bar.className = 'reply-context-bar';
            bar.id = 'reply-context-bar';
            const textSpan = document.createElement('span');
            textSpan.className = 'reply-context-text';
            textSpan.textContent = 'Replying to: ' + (questionText || '').substring(0, 80) + ((questionText || '').length > 80 ? '...' : '');
            bar.appendChild(textSpan);
            const closeBtn = document.createElement('button');
            closeBtn.className = 'reply-context-close';
            closeBtn.textContent = '\u00D7';
            closeBtn.onclick = () => clearReplyContext();
            bar.appendChild(closeBtn);
            inputArea.insertBefore(bar, inputArea.firstChild);
            // Focus input
            const input = document.getElementById('mind-chat-field');
            if (input) input.focus();
        }

        function clearReplyContext(skipNull) {
            const existing = document.getElementById('reply-context-bar');
            if (existing) existing.remove();
            if (!skipNull) _replyContext = null;
        }

        const OODA_PHASE_ICONS = {
            observe: { icon: '\uD83D\uDC41\uFE0F', label: 'OBSERVE' },
            orient:  { icon: '\uD83E\uDDED', label: 'ORIENT' },
            decide:  { icon: '\uD83E\uDDE0', label: 'DECIDE' },
            act:     { icon: '\u26A1', label: 'ACT' }
        };

        function showHITLPopup(data) {
            const container = document.getElementById('hitl-popup-container');
            if (!container) return;

            const popupId = data.id || ('hitl-' + Date.now());
            const urgency = escapeHtml(data.urgency || 'medium');
            const isApproval = data.type === 'approval';
            const questionText = escapeHtml(data.question || 'Cerebro needs your input');
            const contextText = data.context ? escapeHtml(data.context) : '';
            const directiveId = escapeHtml(data.directive_id || '');

            // Build popup using DOM methods for safety
            const popup = document.createElement('div');
            popup.className = 'hitl-popup';
            popup.id = popupId;
            popup.dataset.directiveId = directiveId;

            // -- Header --
            const header = document.createElement('div');
            header.className = 'hitl-popup-header';

            const headerLeft = document.createElement('div');
            headerLeft.className = 'hitl-popup-header-left';

            const iconDiv = document.createElement('div');
            iconDiv.className = 'hitl-popup-icon';
            iconDiv.textContent = isApproval ? '\uD83D\uDEE1\uFE0F' : '\uD83E\uDDE0';

            const labelSpan = document.createElement('span');
            labelSpan.className = 'hitl-popup-label';
            labelSpan.textContent = isApproval ? 'Approval Needed' : 'Input Needed';

            headerLeft.appendChild(iconDiv);
            headerLeft.appendChild(labelSpan);

            const urgencySpan = document.createElement('span');
            urgencySpan.className = 'hitl-popup-urgency ' + urgency;
            urgencySpan.textContent = urgency;

            const closeBtn = document.createElement('button');
            closeBtn.className = 'hitl-popup-close';
            closeBtn.textContent = '\u00D7';
            closeBtn.onclick = () => dismissHITLPopup(popupId);

            header.appendChild(headerLeft);
            header.appendChild(urgencySpan);
            header.appendChild(closeBtn);
            popup.appendChild(header);

            // -- Body --
            const body = document.createElement('div');
            body.className = 'hitl-popup-body';

            const questionDiv = document.createElement('div');
            questionDiv.className = 'hitl-popup-question';
            questionDiv.textContent = data.question || 'Cerebro needs your input';

            body.appendChild(questionDiv);

            if (contextText) {
                const ctxDiv = document.createElement('div');
                ctxDiv.className = 'hitl-popup-context';
                ctxDiv.textContent = data.context;
                body.appendChild(ctxDiv);
            }

            // Browser preview
            var rawScreenshot = data.screenshot || hitlBrowserScreenshot;
            var screenshotSrc = rawScreenshot && !rawScreenshot.startsWith('data:') ? 'data:image/png;base64,' + rawScreenshot : rawScreenshot;
            if (screenshotSrc) {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'hitl-browser-preview';
                previewDiv.title = 'Click to view live browser';
                previewDiv.onclick = () => openBrowserView();

                const img = document.createElement('img');
                img.src = screenshotSrc;
                img.alt = 'Browser view';
                img.onerror = function() {
                    this.style.display = 'none';
                };

                const overlay = document.createElement('div');
                overlay.className = 'hitl-browser-preview-overlay';
                const lbl1 = document.createElement('span');
                lbl1.className = 'hitl-browser-preview-label';
                lbl1.textContent = 'Live Browser';
                const lbl2 = document.createElement('span');
                lbl2.className = 'hitl-browser-preview-label';
                lbl2.style.color = 'var(--accent-light)';
                lbl2.textContent = 'Click to open';
                overlay.appendChild(lbl1);
                overlay.appendChild(lbl2);

                previewDiv.appendChild(img);
                previewDiv.appendChild(overlay);
                body.appendChild(previewDiv);
            }

            // Chrome desktop hint when browser is running
            if (data.browser_url || browserState.running) {
                const chromeHint = document.createElement('div');
                chromeHint.className = 'hitl-popup-context';
                chromeHint.style.borderLeftColor = 'var(--accent)';
                chromeHint.textContent = 'Chrome is open on your desktop - switch to the Chrome window to interact.';
                body.appendChild(chromeHint);
            }

            popup.appendChild(body);

            // -- Actions --
            if (isApproval) {
                const actions = document.createElement('div');
                actions.className = 'hitl-popup-actions';

                const approveBtn = document.createElement('button');
                approveBtn.className = 'hitl-action-btn approve';
                approveBtn.textContent = 'Approve';
                approveBtn.onclick = () => submitHITLResponse(popupId, 'approved');

                const rejectBtn = document.createElement('button');
                rejectBtn.className = 'hitl-action-btn reject';
                rejectBtn.textContent = 'Reject';
                rejectBtn.onclick = () => submitHITLResponse(popupId, 'rejected');

                actions.appendChild(approveBtn);
                actions.appendChild(rejectBtn);
                popup.appendChild(actions);
            } else {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'hitl-popup-answer';

                const textarea = document.createElement('textarea');
                textarea.className = 'hitl-answer-input';
                textarea.id = 'hitl-input-' + popupId;
                textarea.rows = 2;
                textarea.placeholder = 'Type your answer...';
                textarea.onkeydown = (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        submitHITLResponse(popupId);
                    }
                };

                answerDiv.appendChild(textarea);
                popup.appendChild(answerDiv);

                const actions = document.createElement('div');
                actions.className = 'hitl-popup-actions';

                const sendBtn = document.createElement('button');
                sendBtn.className = 'hitl-action-btn submit';
                sendBtn.textContent = 'Send';
                sendBtn.onclick = () => submitHITLResponse(popupId);

                const viewBtn = document.createElement('a');
                viewBtn.className = 'hitl-view-browser-btn';
                viewBtn.title = 'View what Cerebro sees';
                if (browserState.running) {
                    viewBtn.textContent = 'Open Chrome';
                    viewBtn.style.background = 'rgba(139, 92, 246, 0.3)';
                    viewBtn.style.borderColor = 'rgba(139, 92, 246, 0.5)';
                } else {
                    viewBtn.textContent = 'View Browser';
                }
                viewBtn.onclick = () => openBrowserView();

                actions.appendChild(sendBtn);
                actions.appendChild(viewBtn);
                popup.appendChild(actions);
            }

            // -- Secondary actions: Skip & Delay --
            const secondary = document.createElement('div');
            secondary.className = 'hitl-secondary-actions';

            const skipBtn = document.createElement('button');
            skipBtn.className = 'hitl-action-btn secondary skip';
            skipBtn.textContent = 'Skip';
            skipBtn.onclick = () => skipHITL(popupId);

            const delayBtn = document.createElement('button');
            delayBtn.className = 'hitl-action-btn secondary delay';
            delayBtn.textContent = 'Delay';
            delayBtn.onclick = () => delayHITL(popupId);

            secondary.appendChild(skipBtn);
            secondary.appendChild(delayBtn);
            popup.appendChild(secondary);

            container.appendChild(popup);

            // Show the overlay
            container.classList.add('visible');

            // Track popup (no timer)
            const popupRecord = {
                id: popupId,
                data: data,
                element: popup,
                createdAt: Date.now()
            };
            hitlPopups.push(popupRecord);

            // Play notification sound (Web Audio API two-tone)
            playHITLNotificationSound();

            // Flash tab title
            startTabFlash('Cerebro needs input');

            // Inject question into Mind chat as question card
            cerebroChat.push({
                id: 'q_' + popupId,
                role: 'assistant',
                content: data.question || 'Cerebro needs your input',
                timestamp: new Date().toISOString(),
                isQuestion: true,
                questionId: popupId,
                context: data.context || '',
                directiveId: data.directive_id || ''
            });
            renderChatMessages();
            renderMindChat();

            // Sidebar pulse indicator
            const sidebar = document.getElementById('sidebar-questions');
            if (sidebar) sidebar.classList.add('has-pending-hitl');

            // Persist as proactive question for page refresh survival
            addProactiveQuestion(
                data.question || 'Cerebro needs your input',
                data.context || null,
                data.type === 'approval' ? 'approval' : 'input-needed'
            );
        }

        function submitHITLResponse(popupId, action) {
            const popup = hitlPopups.find(p => p.id === popupId);
            if (!popup) return;

            let response;
            if (action === 'approved' || action === 'rejected') {
                response = { approved: action === 'approved' };
            } else {
                const input = document.getElementById('hitl-input-' + popupId);
                const answer = input ? input.value.trim() : '';
                if (!answer) {
                    if (input) {
                        input.style.borderColor = 'var(--red)';
                        setTimeout(() => { input.style.borderColor = ''; }, 600);
                    }
                    return;
                }
                response = { answer: answer };
            }

            if (socket) {
                socket.emit('human_input_response', {
                    request_id: popupId,
                    directive_id: popup.data.directive_id || '',
                    ...response,
                    timestamp: new Date().toISOString()
                });
            }

            const el = popup.element;
            if (el) {
                el.style.borderColor = 'var(--green)';
                el.style.boxShadow = '0 0 30px rgba(34, 197, 94, 0.3)';
            }

            showToast(action === 'rejected' ? 'Response sent: Rejected' : 'Response sent to Cerebro', 'success');
            setTimeout(() => dismissHITLPopup(popupId), 500);

            // Remove answered item from Answers tab
            if (popup.data._storedItemId) {
                deleteStoredItem(popup.data._storedItemId);
            }
        }

        function dismissHITLPopup(popupId) {
            const idx = hitlPopups.findIndex(p => p.id === popupId);
            if (idx === -1) return;

            const popup = hitlPopups[idx];

            const el = popup.element;
            if (el) {
                el.classList.add('dismissing');
                setTimeout(() => el.remove(), 300);
            }

            hitlPopups.splice(idx, 1);

            // Update tamagotchi HITL state
            if (typeof tamagotchiState !== 'undefined') {
                tamagotchiState.hitlPending = hitlPopups.length > 0;
            }

            // Hide overlay when no popups remain
            if (hitlPopups.length === 0) {
                const container = document.getElementById('hitl-popup-container');
                if (container) container.classList.remove('visible');

                const sidebar = document.getElementById('sidebar-questions');
                if (sidebar) sidebar.classList.remove('has-pending-hitl');
            }

            // Stop tab flash
            stopTabFlash();
        }

        // ==================== HEARTBEAT MONITOR ====================

        let _heartbeatConfig = null;

        const MONITOR_LABELS = {
            git_repos: 'Git Repos',
            file_changes: 'File Changes',
            memory_health: 'Memory Health',
            system_health: 'System Health'
        };

        async function loadHeartbeatConfig() {
            try {
                const resp = await fetch(`${API_URL}/api/heartbeat/config`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                if (resp.ok) {
                    _heartbeatConfig = await resp.json();
                    renderHeartbeatMonitors();
                }
            } catch (e) {
                console.warn('[Heartbeat] Failed to load config:', e);
            }
        }

        function renderHeartbeatMonitors() {
            if (!_heartbeatConfig) return;
            const container = document.getElementById('slide-heartbeat-monitors');
            if (!container) return;

            // Update interval slider
            const slider = document.getElementById('slide-heartbeat-interval');
            const valEl = document.getElementById('slide-heartbeat-interval-value');
            if (slider) slider.value = _heartbeatConfig.interval_minutes || 15;
            if (valEl) valEl.textContent = `${_heartbeatConfig.interval_minutes || 15}m`;

            // Render monitor toggles using safe DOM methods
            container.textContent = '';
            const monitors = _heartbeatConfig.monitors || {};
            for (const [key, cfg] of Object.entries(monitors)) {
                const label = document.createElement('label');
                label.style.cssText = 'display:flex; align-items:center; gap:6px; cursor:pointer;';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = !!cfg.enabled;
                cb.style.cssText = 'accent-color:var(--accent); width:14px; height:14px;';
                cb.addEventListener('change', function() { toggleHeartbeatMonitor(key, this.checked); });
                const span = document.createElement('span');
                span.style.cssText = 'font-size:0.68rem; color:var(--text-secondary);';
                span.textContent = MONITOR_LABELS[key] || key;
                label.appendChild(cb);
                label.appendChild(span);
                container.appendChild(label);
            }
        }

        async function updateHeartbeatInterval(value) {
            const valEl = document.getElementById('slide-heartbeat-interval-value');
            if (valEl) valEl.textContent = `${value}m`;
            try {
                await fetch(`${API_URL}/api/heartbeat/config`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ interval_minutes: parseInt(value) })
                });
            } catch (e) {
                console.warn('[Heartbeat] Failed to update interval:', e);
            }
        }

        async function toggleHeartbeatMonitor(name, enabled) {
            try {
                await fetch(`${API_URL}/api/heartbeat/config`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ monitors: { [name]: { enabled } } })
                });
            } catch (e) {
                console.warn('[Heartbeat] Failed to toggle monitor:', e);
            }
        }

        // ==================== HEARTBEAT MODAL (Markdown Editor) ====================

        let _heartbeatMdOriginal = '';

        async function openHeartbeatModal() {
            const modal = document.getElementById('heartbeat-modal');
            const textarea = document.getElementById('heartbeat-md-textarea');
            const dirtyEl = document.getElementById('hb-dirty-indicator');
            const savedEl = document.getElementById('hb-last-saved');
            if (!modal || !textarea) return;

            textarea.value = 'Loading...';
            modal.classList.add('active');

            try {
                const res = await fetch(`${API_URL}/api/heartbeat/md`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await res.json();
                textarea.value = data.content || '';
                _heartbeatMdOriginal = textarea.value;
            } catch (e) {
                textarea.value = '# Error loading heartbeat.md\n\n' + e.message;
                _heartbeatMdOriginal = '';
            }
            if (dirtyEl) dirtyEl.classList.remove('visible');
            if (savedEl) savedEl.textContent = 'Saved';
        }

        function closeHeartbeatModal() {
            const modal = document.getElementById('heartbeat-modal');
            const textarea = document.getElementById('heartbeat-md-textarea');
            if (!modal) return;
            // Warn if unsaved
            if (textarea && textarea.value !== _heartbeatMdOriginal) {
                if (!confirm('You have unsaved changes. Discard?')) return;
            }
            modal.classList.remove('active');
        }

        async function saveHeartbeatMd() {
            const textarea = document.getElementById('heartbeat-md-textarea');
            const dirtyEl = document.getElementById('hb-dirty-indicator');
            const savedEl = document.getElementById('hb-last-saved');
            const saveBtn = document.getElementById('hb-save-btn');
            if (!textarea) return;

            if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Saving...'; }

            try {
                const res = await fetch(`${API_URL}/api/heartbeat/md`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`
                    },
                    body: JSON.stringify({ content: textarea.value })
                });
                const data = await res.json();
                if (data.success) {
                    _heartbeatMdOriginal = textarea.value;
                    if (dirtyEl) dirtyEl.classList.remove('visible');
                    if (savedEl) savedEl.textContent = 'Saved just now';
                    // Sync slide panel slider if interval changed
                    if (data.parsed && data.parsed.interval_minutes) {
                        const slideSlider = document.getElementById('slide-heartbeat-interval');
                        const slideVal = document.getElementById('slide-heartbeat-interval-value');
                        if (slideSlider) slideSlider.value = data.parsed.interval_minutes;
                        if (slideVal) slideVal.textContent = data.parsed.interval_minutes + 'm';
                    }
                }
            } catch (e) {
                if (savedEl) savedEl.textContent = 'Save failed!';
                console.error('[Heartbeat MD] Save error:', e);
            }
            if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save'; }
        }

        // Dirty indicator + keyboard shortcuts for heartbeat textarea
        (function() {
            const textarea = document.getElementById('heartbeat-md-textarea');
            if (!textarea) return;

            textarea.addEventListener('input', function() {
                const dirtyEl = document.getElementById('hb-dirty-indicator');
                if (dirtyEl) {
                    if (textarea.value !== _heartbeatMdOriginal) dirtyEl.classList.add('visible');
                    else dirtyEl.classList.remove('visible');
                }
            });

            textarea.addEventListener('keydown', function(e) {
                // Tab inserts 4 spaces
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 4;
                    this.dispatchEvent(new Event('input'));
                }
                // Ctrl+S saves
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveHeartbeatMd();
                }
            });
        })();

        // ==================== STORED ITEMS (Delayed questions, sims, agent results) ====================

        let storedItems = [];
        let _currentMindTab = 'chat';

        function switchMindTab(tab) {
            _currentMindTab = tab;
            const chatMsgs = document.getElementById('mind-chat-messages');
            const answersDiv = document.getElementById('mind-answers-items');
            const storedDiv = document.getElementById('mind-stored-items');
            const agentsDiv = document.getElementById('mind-agents-items');
            const walletDiv = document.getElementById('mind-wallet-items');
            const inputBar = document.querySelector('.mind-chat-input-bar');
            const fabContainer = document.querySelector('.mind-fab-container');
            document.querySelectorAll('.mind-chat-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            // Hide all panes
            if (chatMsgs) chatMsgs.style.display = 'none';
            if (answersDiv) answersDiv.classList.add('hidden');
            if (storedDiv) storedDiv.classList.add('hidden');
            if (agentsDiv) agentsDiv.classList.add('hidden');
            if (walletDiv) walletDiv.classList.add('hidden');
            if (inputBar) inputBar.style.display = 'none';
            if (fabContainer) fabContainer.style.display = 'none';

            // Stop wallet polling when leaving wallet tab
            if (tab !== 'wallet') stopWalletPolling();

            if (tab === 'chat') {
                if (chatMsgs) chatMsgs.style.display = '';
                if (inputBar) inputBar.style.display = '';
                if (fabContainer) fabContainer.style.display = '';
            } else if (tab === 'answers') {
                if (answersDiv) answersDiv.classList.remove('hidden');
                renderAnswerItems();
            } else if (tab === 'agents') {
                if (agentsDiv) agentsDiv.classList.remove('hidden');
                renderMindAgents();
            } else if (tab === 'wallet') {
                if (walletDiv) walletDiv.classList.remove('hidden');
                fetchWalletData();
                startWalletPolling();
            } else {
                if (storedDiv) storedDiv.classList.remove('hidden');
                renderStoredItems();
            }
        }

        function renderMindAgents() {
            const container = document.getElementById('mind-agents-items');
            if (!container) return;
            container.textContent = '';

            // Filter to only Cerebro-spawned and scheduler agents (not manual user agents)
            const cerebroAgents = Object.values(agents).filter(a =>
                a.source === 'cerebro' || a.source === 'scheduler'
            );

            // Separate running/queued from completed
            const running = cerebroAgents.filter(a => a.status === 'running');
            const queued = cerebroAgents.filter(a => a.status === 'queued');
            const recent = cerebroAgents.filter(a => a.status === 'completed' || a.status === 'failed')
                .sort((a, b) => (b.completed_at || '').localeCompare(a.completed_at || ''))
                .slice(0, 5);

            if (running.length === 0 && queued.length === 0 && recent.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'mind-agents-empty';
                const iconDiv = document.createElement('div');
                iconDiv.className = 'empty-icon';
                iconDiv.textContent = '\u{1F916}';
                const textDiv = document.createElement('div');
                textDiv.textContent = 'No Cerebro agents active';
                const hintDiv = document.createElement('div');
                hintDiv.style.cssText = 'font-size:0.72rem;margin-top:4px;color:rgba(255,255,255,0.2)';
                hintDiv.textContent = 'Agents spawned by directives and automations appear here';
                emptyDiv.append(iconDiv, textDiv, hintDiv);
                container.appendChild(emptyDiv);
                return;
            }

            // Queue header
            const header = document.createElement('div');
            header.className = 'mind-agents-queue-header';
            const stats = document.createElement('div');
            stats.className = 'queue-stats';
            const runSpan = document.createElement('span');
            runSpan.textContent = running.length;
            const queueSpan = document.createElement('span');
            queueSpan.textContent = queued.length;
            stats.append(runSpan, ' running \u00B7 ', queueSpan, ' queued');
            header.appendChild(stats);
            container.appendChild(header);

            // Queued agents first
            for (const a of queued) {
                container.appendChild(buildMindAgentCard(a, 'queued'));
            }
            // Running agents
            for (const a of running) {
                container.appendChild(buildMindAgentCard(a, 'running'));
            }
            // Recent completed (last 5)
            if (recent.length > 0) {
                const recentLabel = document.createElement('div');
                recentLabel.style.cssText = 'font-size:0.7rem;color:rgba(255,255,255,0.25);padding:8px 4px 4px;text-transform:uppercase;letter-spacing:0.5px';
                recentLabel.textContent = 'Recent';
                container.appendChild(recentLabel);
                for (const a of recent) {
                    container.appendChild(buildMindAgentCard(a, a.status));
                }
            }
        }

        function buildMindAgentCard(agent, status) {
            const card = document.createElement('div');
            card.className = 'mind-agent-card';
            card.addEventListener('click', () => showAgentDetail(agent.id));

            const iconDiv = document.createElement('div');
            iconDiv.className = 'agent-icon';
            iconDiv.textContent = agent.role_icon || '\u{1F916}';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'agent-info';
            const callsignDiv = document.createElement('div');
            callsignDiv.className = 'agent-callsign';
            callsignDiv.textContent = agent.call_sign || agent.id;
            const typeSpan = document.createElement('span');
            typeSpan.style.cssText = 'font-size:0.68rem;color:rgba(255,255,255,0.3);font-weight:400;margin-left:6px';
            typeSpan.textContent = agent.type || '';
            callsignDiv.appendChild(typeSpan);
            const taskDiv = document.createElement('div');
            taskDiv.className = 'agent-task-preview';
            taskDiv.textContent = (agent.task || '').substring(0, 80);
            infoDiv.append(callsignDiv, taskDiv);

            const dot = document.createElement('div');
            const statusClass = status === 'running' ? 'running' : status === 'queued' ? 'queued' : (status === 'completed' ? 'completed' : 'failed');
            dot.className = 'agent-status-dot ' + statusClass;
            if (status === 'completed') dot.style.background = 'var(--green)';
            else if (status === 'failed') dot.style.background = 'var(--red)';

            card.append(iconDiv, infoDiv, dot);
            return card;
        }

        function updateAgentsTabBadge() {
            const badge = document.getElementById('agents-tab-badge');
            if (!badge) return;
            const count = Object.values(agents).filter(a =>
                (a.source === 'cerebro' || a.source === 'scheduler') &&
                (a.status === 'running' || a.status === 'queued')
            ).length;
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = '';
            } else {
                badge.style.display = 'none';
            }
        }

        //  Wallet Tab 
        let _walletData = null;
        let _walletPeriod = 'today';
        let _walletPollTimer = null;

        async function fetchWalletData() {
            try {
                const resp = await fetch(`${API_URL}/api/wallet/summary`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                if (resp.ok) {
                    _walletData = await resp.json();
                    updateWalletBadge();
                    if (_currentMindTab === 'wallet') renderWallet();
                }
            } catch (e) {
                console.error('Wallet fetch failed:', e);
            }
        }

        function _walletPnlClass(v) { return v > 0 ? 'positive' : v < 0 ? 'negative' : 'zero'; }
        function _walletSign(v) { return v > 0 ? '+' : ''; }

        function renderWallet() {
            const container = document.getElementById('mind-wallet-items');
            if (!container) return;
            container.textContent = '';

            if (!_walletData) {
                const empty = document.createElement('div');
                empty.className = 'wallet-empty';
                const ico = document.createElement('div');
                ico.className = 'empty-icon';
                ico.textContent = '\u{1F4B0}';
                const txt = document.createElement('div');
                txt.textContent = 'Loading wallet...';
                empty.append(ico, txt);
                container.appendChild(empty);
                return;
            }

            // P&L Header
            const header = document.createElement('div');
            header.className = 'wallet-pnl-header';

            const label = document.createElement('div');
            label.className = 'wallet-pnl-label';
            const periodLabels = { today: "Today's", week: 'This Week', month: 'This Month', all: 'All Time' };
            label.textContent = (periodLabels[_walletPeriod] || "Today's") + ' P&L';
            header.appendChild(label);

            const total = _walletData.totals[_walletPeriod] || 0;
            const amtDiv = document.createElement('div');
            amtDiv.className = 'wallet-pnl-amount ' + _walletPnlClass(total);
            amtDiv.textContent = _walletSign(total) + '$' + total.toFixed(2);
            header.appendChild(amtDiv);

            const unrealized = _walletData.unrealized || 0;
            if (unrealized !== 0) {
                const uDiv = document.createElement('div');
                uDiv.className = 'wallet-pnl-unrealized';
                const posCount = (_walletData.open_positions || []).length;
                uDiv.textContent = 'Unrealized: ' + _walletSign(unrealized) + '$' + unrealized.toFixed(2) + ' (' + posCount + ' position' + (posCount !== 1 ? 's' : '') + ')';
                header.appendChild(uDiv);
            }

            const periodBar = document.createElement('div');
            periodBar.className = 'wallet-period-bar';
            for (const p of ['today', 'week', 'month', 'all']) {
                const btn = document.createElement('button');
                btn.className = 'wallet-period-btn' + (_walletPeriod === p ? ' active' : '');
                btn.textContent = p.charAt(0).toUpperCase() + p.slice(1);
                btn.addEventListener('click', () => setWalletPeriod(p));
                periodBar.appendChild(btn);
            }
            header.appendChild(periodBar);
            container.appendChild(header);

            // Two-column layout: Open | History
            const cols = document.createElement('div');
            cols.className = 'wallet-columns';

            //  Open column 
            const openCol = document.createElement('div');
            openCol.className = 'wallet-col';
            const openHeader = document.createElement('div');
            openHeader.className = 'wallet-col-header';
            openHeader.textContent = 'Open';
            openCol.appendChild(openHeader);
            const openContent = document.createElement('div');
            openContent.className = 'wallet-col-content';

            const positions = _walletData.open_positions || [];
            if (positions.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'wallet-col-empty';
                emptyMsg.textContent = 'No open positions';
                openContent.appendChild(emptyMsg);
            } else {
                for (const pos of positions) {
                    openContent.appendChild(buildPositionCard(pos));
                }
            }
            openCol.appendChild(openContent);

            //  History column 
            const histCol = document.createElement('div');
            histCol.className = 'wallet-col';
            const histHeader = document.createElement('div');
            histHeader.className = 'wallet-col-header';
            histHeader.textContent = 'History';
            histCol.appendChild(histHeader);
            const histContent = document.createElement('div');
            histContent.className = 'wallet-col-content';

            const history = _walletData.history || [];
            if (history.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'wallet-col-empty';
                emptyMsg.textContent = 'No activity yet';
                histContent.appendChild(emptyMsg);
            } else {
                for (const entry of history) {
                    histContent.appendChild(buildWalletEntryCard(entry));
                }
            }
            histCol.appendChild(histContent);

            cols.append(openCol, histCol);
            container.appendChild(cols);
        }

        function buildPositionCard(pos) {
            const card = document.createElement('div');
            card.className = 'wallet-position-card';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'wallet-entry-info';
            const sym = document.createElement('div');
            sym.className = 'pos-symbol';
            sym.textContent = pos.symbol || '';
            const detail = document.createElement('div');
            detail.className = 'pos-detail';
            const qty = parseFloat(pos.qty) || 0;
            const side = pos.side || (qty > 0 ? 'long' : 'short');
            const price = pos.avg_entry_price ? parseFloat(pos.avg_entry_price).toFixed(2) : '';
            const cur = pos.current_price ? parseFloat(pos.current_price).toFixed(2) : '';
            detail.textContent = side.toUpperCase() + ' ' + Math.abs(qty) + (price ? ' @ $' + price : '') + (cur ? '  $' + cur : '');
            infoDiv.append(sym, detail);

            const pnlDiv = document.createElement('div');
            pnlDiv.className = 'pos-pnl';
            const upl = parseFloat(pos.unrealized_pl) || 0;
            pnlDiv.className = 'pos-pnl ' + _walletPnlClass(upl);
            pnlDiv.textContent = _walletSign(upl) + '$' + upl.toFixed(2);

            card.append(infoDiv, pnlDiv);
            return card;
        }

        function buildWalletEntryCard(entry) {
            const card = document.createElement('div');
            const cat = entry.category || 'other';
            card.className = 'wallet-entry-card cat-' + cat;

            const infoDiv = document.createElement('div');
            infoDiv.className = 'wallet-entry-info';

            const descDiv = document.createElement('div');
            descDiv.className = 'wallet-entry-desc';
            descDiv.textContent = entry.description || 'Activity';

            const metaDiv = document.createElement('div');
            metaDiv.className = 'wallet-entry-meta';
            const catSpan = document.createElement('span');
            catSpan.className = 'wallet-entry-category cat-' + cat;
            catSpan.textContent = cat;
            const timeSpan = document.createElement('span');
            try {
                const d = new Date(entry.timestamp);
                timeSpan.textContent = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch (e) { timeSpan.textContent = ''; }
            metaDiv.append(catSpan, timeSpan);
            if (entry.source && entry.source !== cat) {
                const srcSpan = document.createElement('span');
                srcSpan.textContent = entry.source;
                metaDiv.appendChild(srcSpan);
            }
            infoDiv.append(descDiv, metaDiv);

            const pnlDiv = document.createElement('div');
            const pnl = parseFloat(entry.pnl) || 0;
            pnlDiv.className = 'wallet-entry-pnl ' + _walletPnlClass(pnl);
            pnlDiv.textContent = _walletSign(pnl) + '$' + pnl.toFixed(2);

            card.append(infoDiv, pnlDiv);
            return card;
        }

        function setWalletPeriod(period) {
            _walletPeriod = period;
            renderWallet();
        }

        function startWalletPolling() {
            stopWalletPolling();
            _walletPollTimer = setInterval(() => {
                if (_currentMindTab === 'wallet') fetchWalletData();
            }, 45000);
        }

        function stopWalletPolling() {
            if (_walletPollTimer) {
                clearInterval(_walletPollTimer);
                _walletPollTimer = null;
            }
        }

        function updateWalletBadge() {
            const badge = document.getElementById('wallet-badge');
            if (!badge) return;
            const count = _walletData ? (_walletData.today_count || 0) : 0;
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = '';
            } else {
                badge.style.display = 'none';
            }
        }

        // Initial wallet badge fetch on page load
        setTimeout(() => fetchWalletData(), 3000);

        async function loadStoredItems() {
            try {
                const resp = await fetch(`${API_URL}/api/stored-items`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                if (resp.ok) {
                    const data = await resp.json();
                    storedItems = data.items || [];
                    updateStoredBadge();
                    if (_currentMindTab === 'stored') renderStoredItems();
                    if (_currentMindTab === 'answers') renderAnswerItems();
                }
            } catch (e) {
                console.error('Failed to load stored items:', e);
            }
        }

        function relativeTime(isoStr) {
            const diff = Date.now() - new Date(isoStr).getTime();
            const mins = Math.floor(diff / 60000);
            if (mins < 1) return 'just now';
            if (mins < 60) return mins + ' min ago';
            const hrs = Math.floor(mins / 60);
            if (hrs < 24) return hrs + 'h ago';
            const days = Math.floor(hrs / 24);
            return days + 'd ago';
        }

        function _buildStoredEmptyState() {
            const wrap = document.createElement('div');
            wrap.className = 'mind-stored-items-empty';
            const icon = document.createElement('div');
            icon.className = 'mind-stored-items-empty-icon';
            icon.textContent = '\uD83D\uDCE6';
            const msg = document.createElement('div');
            msg.textContent = 'No stored items yet';
            const hint = document.createElement('div');
            hint.style.fontSize = '0.75rem';
            hint.textContent = 'Delayed questions, simulations, and agent results will appear here';
            wrap.appendChild(icon);
            wrap.appendChild(msg);
            wrap.appendChild(hint);
            return wrap;
        }

        function getAnswerItems() {
            return storedItems.filter(i => i.type === 'question' || i.type === 'approval');
        }
        function getStoredOnlyItems() {
            return storedItems.filter(i => i.type !== 'question' && i.type !== 'approval');
        }

        function _buildAnswersEmptyState() {
            const wrap = document.createElement('div');
            wrap.className = 'mind-stored-items-empty';
            const icon = document.createElement('div');
            icon.className = 'mind-stored-items-empty-icon';
            icon.textContent = '\uD83E\uDDE0';
            const msg = document.createElement('div');
            msg.textContent = 'No questions from Cerebro';
            const hint = document.createElement('div');
            hint.style.fontSize = '0.75rem';
            hint.textContent = 'Questions and approval requests will appear here';
            wrap.appendChild(icon);
            wrap.appendChild(msg);
            wrap.appendChild(hint);
            return wrap;
        }

        function renderAnswerItems() {
            const container = document.getElementById('mind-answers-items');
            if (!container) return;
            container.textContent = '';
            const items = getAnswerItems();
            if (items.length === 0) {
                container.appendChild(_buildAnswersEmptyState());
                return;
            }
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'stored-item-card type-' + (item.type || 'question');
                card.onclick = (e) => {
                    if (e.target.closest('.stored-item-delete')) return;
                    onStoredItemClick(item);
                };
                const header = document.createElement('div');
                header.className = 'stored-item-card-header';
                const statusDot = document.createElement('div');
                statusDot.className = 'stored-item-status-dot ' + (item.status || 'pending');
                header.appendChild(statusDot);
                const badge = document.createElement('span');
                badge.className = 'stored-item-badge ' + (item.type || 'question');
                const badgeLabels = { question: 'Input Needed', approval: 'Approval Needed', alert: 'Alert' };
                badge.textContent = badgeLabels[item.type] || item.type;
                header.appendChild(badge);
                const timeSpan = document.createElement('span');
                timeSpan.className = 'stored-item-time';
                timeSpan.textContent = relativeTime(item.created_at);
                header.appendChild(timeSpan);
                card.appendChild(header);
                const title = document.createElement('div');
                title.className = 'stored-item-title';
                title.textContent = item.title || 'Stored Item';
                card.appendChild(title);
                if (item.content) {
                    const preview = document.createElement('div');
                    preview.className = 'stored-item-content-preview';
                    preview.textContent = item.content.substring(0, 200);
                    card.appendChild(preview);
                }
                const delBtn = document.createElement('button');
                delBtn.className = 'stored-item-delete';
                delBtn.textContent = '\u2715';
                delBtn.title = 'Remove';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteStoredItem(item.id); };
                card.appendChild(delBtn);
                container.appendChild(card);
            });
        }

        function renderStoredItems() {
            const container = document.getElementById('mind-stored-items');
            if (!container) return;
            container.textContent = '';
            const items = getStoredOnlyItems();
            if (items.length === 0) {
                container.appendChild(_buildStoredEmptyState());
                return;
            }
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'stored-item-card type-' + (item.type || 'question');
                card.onclick = (e) => {
                    if (e.target.closest('.stored-item-delete')) return;
                    onStoredItemClick(item);
                };

                // Header
                const header = document.createElement('div');
                header.className = 'stored-item-card-header';

                const statusDot = document.createElement('div');
                statusDot.className = 'stored-item-status-dot ' + (item.status || 'pending');
                header.appendChild(statusDot);

                const badge = document.createElement('span');
                badge.className = 'stored-item-badge ' + (item.type || 'question');
                const badgeLabels = { question: 'Input Needed', approval: 'Approval Needed', simulation: 'Simulation', agent_result: 'Agent Complete', finding: 'Finding', alert: 'Alert' };
                badge.textContent = badgeLabels[item.type] || item.type;
                header.appendChild(badge);

                const timeSpan = document.createElement('span');
                timeSpan.className = 'stored-item-time';
                timeSpan.textContent = relativeTime(item.created_at);
                header.appendChild(timeSpan);

                card.appendChild(header);

                // Title
                const title = document.createElement('div');
                title.className = 'stored-item-title';
                title.textContent = item.title || 'Stored Item';
                card.appendChild(title);

                // Content preview
                if (item.content) {
                    const preview = document.createElement('div');
                    preview.className = 'stored-item-content-preview';
                    preview.textContent = item.content.substring(0, 200);
                    card.appendChild(preview);
                }

                // Delete button
                const delBtn = document.createElement('button');
                delBtn.className = 'stored-item-delete';
                delBtn.textContent = '\u2715';
                delBtn.title = 'Remove';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteStoredItem(item.id); };
                card.appendChild(delBtn);

                container.appendChild(card);
            });
        }

        function onStoredItemClick(item) {
            if (item.type === 'question' || item.type === 'approval') {
                reopenStoredQuestion(item);
            } else if (item.type === 'simulation') {
                if (item.metadata) showSimulationModal(item.metadata);
                markStoredItemViewed(item.id);
            } else {
                // agent_result / finding / alert: show detail popup
                showStoredItemDetail(item);
                markStoredItemViewed(item.id);
            }
        }

        function parseAlertFields(content) {
            const fields = {};
            if (!content) return fields;
            const regex = /\*\*([^*]+):\*\*\s*(.+)/g;
            let match;
            while ((match = regex.exec(content)) !== null) {
                fields[match[1].trim()] = match[2].trim();
            }
            return fields;
        }

        function showStoredItemDetail(item) {
            // Remove any existing detail overlay
            const existing = document.querySelector('.stored-item-detail-overlay');
            if (existing) existing.remove();

            const type = item.type || 'finding';
            const icons = { alert: '\u26a0\ufe0f', finding: '\ud83d\udd0d', agent_result: '\u2705' };
            const typeLabels = { alert: 'Network Alert', finding: 'Finding', agent_result: 'Agent Result' };

            // Overlay
            const overlay = document.createElement('div');
            overlay.className = 'stored-item-detail-overlay';
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) dismissStoredItemDetail();
            });

            // Popup
            const popup = document.createElement('div');
            popup.className = 'stored-item-detail-popup type-' + type;

            // Header
            const header = document.createElement('div');
            header.className = 'stored-item-detail-header type-' + type;

            const icon = document.createElement('div');
            icon.className = 'stored-item-detail-icon type-' + type;
            icon.textContent = icons[type] || '\ud83d\udccc';
            header.appendChild(icon);

            const headerText = document.createElement('div');
            headerText.className = 'stored-item-detail-header-text';
            const typeLabel = document.createElement('div');
            typeLabel.className = 'stored-item-detail-type-label type-' + type;
            typeLabel.textContent = typeLabels[type] || type;
            headerText.appendChild(typeLabel);
            const titleEl = document.createElement('div');
            titleEl.className = 'stored-item-detail-title';
            titleEl.textContent = item.title || 'Stored Item';
            headerText.appendChild(titleEl);
            header.appendChild(headerText);

            const closeBtn = document.createElement('button');
            closeBtn.className = 'stored-item-detail-close';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = dismissStoredItemDetail;
            header.appendChild(closeBtn);
            popup.appendChild(header);

            // Body
            const body = document.createElement('div');
            body.className = 'stored-item-detail-body';

            if (type === 'alert') {
                const fields = parseAlertFields(item.content);
                if (Object.keys(fields).length > 0) {
                    const grid = document.createElement('div');
                    grid.className = 'stored-item-detail-fields';
                    for (const [key, val] of Object.entries(fields)) {
                        const label = document.createElement('div');
                        label.className = 'stored-item-detail-field-label';
                        label.textContent = key;
                        grid.appendChild(label);
                        const value = document.createElement('div');
                        value.className = 'stored-item-detail-field-value';
                        value.textContent = val;
                        grid.appendChild(value);
                    }
                    body.appendChild(grid);
                } else {
                    const md = document.createElement('div');
                    md.className = 'stored-item-detail-markdown';
                    md.innerHTML = typeof safeMarkdown === 'function' ? safeMarkdown(item.content || '') : (item.content || '');
                    body.appendChild(md);
                }
            } else {
                const md = document.createElement('div');
                md.className = 'stored-item-detail-markdown';
                md.innerHTML = typeof safeMarkdown === 'function' ? safeMarkdown(item.content || '') : (item.content || '');
                body.appendChild(md);
            }

            // Metadata section
            if (item.metadata && Object.keys(item.metadata).length > 0) {
                const metaDiv = document.createElement('div');
                metaDiv.className = 'stored-item-detail-meta';
                const metaKeys = ['source', 'directive_id', 'agent_type', 'category'];
                for (const k of metaKeys) {
                    if (item.metadata[k]) {
                        const row = document.createElement('div');
                        row.className = 'stored-item-detail-meta-row';
                        row.innerHTML = '<span>' + k.replace(/_/g, ' ') + '</span><span>' + item.metadata[k] + '</span>';
                        metaDiv.appendChild(row);
                    }
                }
                if (metaDiv.children.length > 0) body.appendChild(metaDiv);
            }

            // Timestamp
            if (item.created_at) {
                const ts = document.createElement('div');
                ts.className = 'stored-item-detail-timestamp';
                try {
                    ts.textContent = new Date(item.created_at).toLocaleString();
                } catch(e) { ts.textContent = item.created_at; }
                body.appendChild(ts);
            }

            popup.appendChild(body);

            // Actions
            const actions = document.createElement('div');
            actions.className = 'stored-item-detail-actions';

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'stored-item-detail-btn delete';
            deleteBtn.textContent = 'Delete';
            deleteBtn.onclick = () => {
                deleteStoredItem(item.id);
                dismissStoredItemDetail();
            };
            actions.appendChild(deleteBtn);

            const investBtn = document.createElement('button');
            investBtn.className = 'stored-item-detail-btn investigate type-' + type;
            investBtn.textContent = 'Investigate';
            investBtn.onclick = () => investigateStoredItem(item);
            actions.appendChild(investBtn);

            popup.appendChild(actions);
            overlay.appendChild(popup);
            document.body.appendChild(overlay);

            // Escape key handler
            overlay._escHandler = (e) => {
                if (e.key === 'Escape') dismissStoredItemDetail();
            };
            document.addEventListener('keydown', overlay._escHandler);
        }

        function dismissStoredItemDetail() {
            const overlay = document.querySelector('.stored-item-detail-overlay');
            if (!overlay) return;
            const popup = overlay.querySelector('.stored-item-detail-popup');
            if (popup) popup.classList.add('closing');
            overlay.classList.add('closing');
            if (overlay._escHandler) {
                document.removeEventListener('keydown', overlay._escHandler);
            }
            setTimeout(() => overlay.remove(), 200);
        }

        async function investigateStoredItem(item) {
            dismissStoredItemDetail();
            const directiveText = 'Investigate stored ' + (item.type || 'item') + ': ' + (item.title || '') + '. Details: ' + (item.content || '').substring(0, 500);
            try {
                const resp = await fetch(API_URL + '/api/directives', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('cerebro_token'), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: directiveText, priority: item.type === 'alert' ? 'high' : 'normal' })
                });
                if (resp.ok) {
                    showToast('Investigation directive created', 'success');
                } else {
                    showToast('Failed to create directive', 'error');
                }
            } catch (e) {
                console.error('Failed to create investigation directive:', e);
                showToast('Failed to create directive: ' + e.message, 'error');
            }
        }

        function reopenStoredQuestion(item) {
            const popupData = {
                id: item.source_id || item.id,
                question: item.content || item.title,
                context: item.metadata?.context || '',
                urgency: item.metadata?.urgency || 'medium',
                type: item.type === 'approval' ? 'approval' : 'question',
                directive_id: item.metadata?.directive_id || '',
                options: item.metadata?.options || [],
                _storedItemId: item.id
            };
            showHITLPopup(popupData);
        }

        async function markStoredItemViewed(itemId) {
            const item = storedItems.find(i => i.id === itemId);
            if (item && item.status === 'pending') {
                item.status = 'viewed';
                updateStoredBadge();
                if (_currentMindTab === 'answers') renderAnswerItems();
                else if (_currentMindTab === 'stored') renderStoredItems();
                try {
                    await fetch(`${API_URL}/api/stored-items/${encodeURIComponent(itemId)}`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'viewed' })
                    });
                } catch (e) { console.error('Failed to update stored item:', e); }
            }
        }

        async function deleteStoredItem(itemId) {
            storedItems = storedItems.filter(i => i.id !== itemId);
            updateStoredBadge();
            if (_currentMindTab === 'answers') renderAnswerItems();
            else if (_currentMindTab === 'stored') renderStoredItems();
            try {
                await fetch(`${API_URL}/api/stored-items/${encodeURIComponent(itemId)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
            } catch (e) { console.error('Failed to delete stored item:', e); }
        }

        function updateStoredBadge() {
            // Answers badge - count pending questions/approvals
            const answersBadge = document.getElementById('answers-badge');
            if (answersBadge) {
                const answerCount = storedItems.filter(i =>
                    (i.type === 'question' || i.type === 'approval') && i.status === 'pending'
                ).length;
                answersBadge.textContent = answerCount;
                answersBadge.style.display = answerCount > 0 ? '' : 'none';
            }
            // Stored badge - count pending non-question items
            const storedBadge = document.getElementById('stored-badge');
            if (storedBadge) {
                const storedCount = storedItems.filter(i =>
                    i.type !== 'question' && i.type !== 'approval' && i.status === 'pending'
                ).length;
                storedBadge.textContent = storedCount;
                storedBadge.style.display = storedCount > 0 ? '' : 'none';
            }
        }

        function skipHITL(popupId) {
            if (socket) {
                const popup = hitlPopups.find(p => p.id === popupId);
                socket.emit('human_input_response', {
                    request_id: popupId,
                    directive_id: popup ? (popup.data.directive_id || '') : '',
                    answer: '__SKIPPED__',
                    timestamp: new Date().toISOString()
                });
            }
            dismissHITLPopup(popupId);
        }

        async function delayHITL(popupId) {
            const popup = hitlPopups.find(p => p.id === popupId);
            if (!popup) { dismissHITLPopup(popupId); return; }
            const data = popup.data;
            const item = {
                id: 'stored_' + popupId,
                type: data.type === 'approval' ? 'approval' : 'question',
                title: (data.question || 'Cerebro Question').substring(0, 80),
                content: data.question || '',
                metadata: {
                    request_id: popupId,
                    context: data.context || '',
                    urgency: data.urgency || 'medium',
                    type: data.type || 'question',
                    options: data.options || [],
                    directive_id: data.directive_id || '',
                    chrome_hint: data.browser_url || ''
                },
                created_at: new Date().toISOString(),
                status: 'pending',
                source_id: popupId
            };
            try {
                await fetch(`${API_URL}/api/stored-items`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(item)
                });
            } catch (e) { console.error('Failed to store delayed question:', e); }
            dismissHITLPopup(popupId);
            showToast('Question saved to Answers tab', 'info');
        }

        // ==================== END STORED ITEMS ====================

        function openBrowserView() {
            // Chrome is running on the desktop - show a helpful message
            if (browserState.running) {
                var url = browserState.currentUrl || '';
                showToast('Chrome is open on your desktop - switch to the Chrome window' + (url ? ': ' + url : ''), 'info');
            }
            // Also open CDP inspector as fallback
            window.open(CEREBRO_CDP_URL, '_blank');
        }

        async function fetchBrowserScreenshot() {
            try {
                const response = await fetch(API_URL + '/api/browser/screenshot', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('cerebro_token') }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.screenshot) {
                        var b64src = data.screenshot.startsWith('data:') ? data.screenshot : 'data:image/png;base64,' + data.screenshot;
                        hitlBrowserScreenshot = b64src;
                        document.querySelectorAll('.hitl-browser-preview img').forEach(img => {
                            img.src = b64src;
                        });
                    }
                }
            } catch(e) { /* Screenshot is optional */ }
        }

        function setupHITLSocketListeners() {
            if (!socket) {
                setTimeout(setupHITLSocketListeners, 1000);
                return;
            }

            socket.on('human_input_needed', (data) => {
                console.log('[HITL] Human input needed:', data);
                if (typeof tamagotchiState !== 'undefined') tamagotchiState.hitlPending = true;
                showHITLPopup(data);
            });

            // === BROWSER STEP: Live exploration progress (Browser tab only, no chat clutter) ===
            socket.on('browser_step', (data) => {
                _agentBrowserStepCount++;
                browserStepLog.push({ step: data.step, action: data.action, reasoning: data.reasoning || '', screenshot: data.screenshot || '' });
                if (browserStepLog.length > 100) browserStepLog.shift();
                renderBrowserStepLog();
            });

            socket.on('browser_screenshot', (data) => {
                if (data.screenshot) {
                    var b64src = data.screenshot.startsWith('data:') ? data.screenshot : 'data:image/png;base64,' + data.screenshot;
                    hitlBrowserScreenshot = b64src;
                    document.querySelectorAll('.hitl-browser-preview img').forEach(img => {
                        img.src = b64src;
                    });
                }
            });

            // Voice Screenshot - toast + overlay + chat injection
            socket.on('voice_screenshot', (data) => {
                console.log('[VoiceScreenshot] Received:', data.window_title);
                const imgSrc = data.image_base64.startsWith('data:')
                    ? data.image_base64
                    : 'data:image/jpeg;base64,' + data.image_base64;

                // --- Toast notification (built with safe DOM methods) ---
                const existingToast = document.querySelector('.voice-screenshot-toast');
                if (existingToast) existingToast.remove();

                const toast = document.createElement('div');
                toast.className = 'voice-screenshot-toast';

                const header = document.createElement('div');
                header.className = 'vs-toast-header';

                const label = document.createElement('span');
                label.className = 'vs-toast-label';
                label.textContent = 'Voice Capture';

                const title = document.createElement('span');
                title.className = 'vs-toast-title';
                title.textContent = data.window_title || 'Screenshot';

                const closeBtn = document.createElement('button');
                closeBtn.className = 'vs-toast-close';
                closeBtn.textContent = String.fromCharCode(215);
                closeBtn.onclick = function(e) {
                    e.stopPropagation();
                    toast.remove();
                };

                header.appendChild(label);
                header.appendChild(title);
                header.appendChild(closeBtn);

                const thumb = document.createElement('img');
                thumb.className = 'vs-toast-thumb';
                thumb.src = imgSrc;
                thumb.alt = 'screenshot';

                toast.appendChild(header);
                toast.appendChild(thumb);

                toast.onclick = function() {
                    toast.remove();
                    showVoiceScreenshotOverlay(imgSrc, data.window_title || 'Screenshot');
                };
                document.body.appendChild(toast);

                // Auto-dismiss after 8s
                setTimeout(function() {
                    if (toast.parentNode) {
                        toast.classList.add('dismissing');
                        setTimeout(function() { toast.remove(); }, 300);
                    }
                }, 8000);

                // --- Inject into mind chat ---
                if (typeof cerebroChat !== 'undefined') {
                    cerebroChat.push({
                        id: 'vs_' + Date.now(),
                        role: 'assistant',
                        type: 'browser_step',
                        content: 'Voice capture: ' + (data.window_title || 'Screenshot'),
                        screenshot: data.image_base64,
                        timestamp: data.timestamp || new Date().toISOString(),
                        isNarration: true,
                        phases: ['observe']
                    });
                    if (typeof renderChatMessages === 'function') renderChatMessages();
                    if (typeof renderMindChat === 'function') renderMindChat();
                }
            });


            socket.on('loop_phase_change', (data) => {
                console.log('[HITL] Phase change:', data);
                const phaseInfo = OODA_PHASE_ICONS[data.phase] || { icon: '', label: data.phase };

                const phaseEl = document.getElementById('current-ooda-phase');
                if (phaseEl) {
                    phaseEl.className = 'ooda-phase-indicator ' + (data.phase || '');
                    phaseEl.textContent = phaseInfo.icon + ' ' + phaseInfo.label;
                }

                if (data.summary) {
                    addThoughtToCycle({
                        phase: data.phase || '',
                        content: data.summary,
                        timestamp: data.timestamp || new Date().toISOString(),
                        cycle_number: data.cycle_number || _runningCycleNumber || 0,
                        metadata: data.metadata || {}
                    });
                    setAlivePulse(false);
                }

                // Update status bar phase text
                const phaseBar = document.getElementById('status-card-phase-value');
                if (phaseBar) phaseBar.textContent = (data.phase || 'idle').charAt(0).toUpperCase() + (data.phase || 'idle').slice(1);

                // Push phase changes to mind chat as status messages
                if (data.summary && typeof injectStatusToChat === 'function') {
                    const label = 'Cerebro \u2022 ' + (phaseInfo.label || data.phase);
                    injectStatusToChat(data.summary, label);
                }
            });

            console.log('[HITL] Socket listeners registered');
        }

        setTimeout(setupHITLSocketListeners, 600);

        // Periodic real-time sync: refresh autonomy status + directives every 15s
        setInterval(async () => {
            if (currentView === 'autonomy') {
                try {
                    const response = await fetch(`${API_URL}/api/autonomy/status`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                    });
                    const data = await response.json();
                    if (data.available) {
                        autonomyState = {
                            status: data.status || 'stopped',
                            level: data.autonomy_level || 2,
                            cycles: data.cycles_completed || 0,
                            phase: data.current_phase || 'idle',
                            actions: data.actions_completed || 0,
                            pending: data.pending_count || 0,
                            fullAutonomy: data.full_autonomy_enabled || false
                        };
                        updateAutonomyUI();
                    }
                } catch (e) { /* silent */ }
            }
        }, 15000);

        // Periodic directive sync every 20s when on Mind page
        setInterval(() => {
            if (currentView === 'autonomy' && typeof loadDirectives === 'function') {
                loadDirectives();
            }
        }, 20000);

        // Periodically fetch browser screenshots when autonomy is running AND browser is active
        setInterval(() => {
            if (autonomyState.status === 'running' && browserState.running) {
                fetchBrowserScreenshot();
            }
        }, 10000);

        // ==================== BROWSER CONTROL PANEL ====================
        let browserStepLog = [];
        let _agentBrowserStepCount = 0;

        let browserState = {
            running: false,
            paused: false,
            tabs: [],
            currentUrl: '',
            actionNeeded: false,
            actionDescription: ''
        };
        let browserScreenshotInterval = null;
        let chatBrowserEnabled = false;  // Local toggle: allow browser use from Chat page

        async function launchBrowser() {
            try {
                const resp = await fetch(API_URL + '/api/browser/launch', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('cerebro_token'),
                        'Content-Type': 'application/json'
                    }
                });
                if (resp.ok) {
                    const data = await resp.json();
                    browserState.running = true;
                    browserState.paused = false;
                    updateBrowserPanel();
                    showToast('Chrome launched', 'success');
                } else {
                    const err = await resp.json().catch(() => ({}));
                    showToast('Failed to launch: ' + (err.detail || 'Unknown error'), 'error');
                }
            } catch(e) {
                showToast('Browser launch failed: ' + e.message, 'error');
            }
        }

        async function stopBrowser() {
            try {
                const resp = await fetch(API_URL + '/api/browser/shutdown', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('cerebro_token') }
                });
                if (resp.ok) {
                    browserState.running = false;
                    browserState.paused = false;
                    browserState.tabs = [];
                    browserState.currentUrl = '';
                    browserState.actionNeeded = false;
                    updateBrowserPanel();
                    showToast('Chrome stopped', 'success');
                }
            } catch(e) {
                showToast('Failed to stop browser: ' + e.message, 'error');
            }
        }

        async function pauseBrowser() {
            try {
                const resp = await fetch(API_URL + '/api/browser/pause', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('cerebro_token') }
                });
                if (resp.ok) {
                    browserState.paused = true;
                    updateBrowserPanel();
                    showToast('You have control - Chrome is on your desktop', 'success');
                }
            } catch(e) {
                showToast('Failed to pause: ' + e.message, 'error');
            }
        }

        async function resumeBrowser() {
            try {
                const resp = await fetch(API_URL + '/api/browser/resume', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('cerebro_token') }
                });
                if (resp.ok) {
                    browserState.paused = false;
                    browserState.actionNeeded = false;
                    updateBrowserPanel();
                    showToast('Cerebro has control again', 'success');
                }
            } catch(e) {
                showToast('Failed to resume: ' + e.message, 'error');
            }
        }

        async function signalUserDone() {
            try {
                const resp = await fetch(API_URL + '/api/browser/user-done', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('cerebro_token') }
                });
                if (resp.ok) {
                    browserState.paused = false;
                    browserState.actionNeeded = false;
                    updateBrowserPanel();
                    hideUserActionBanner();
                    showToast('Handing back to Cerebro', 'success');
                }
            } catch(e) {
                showToast('Failed to signal done: ' + e.message, 'error');
            }
        }

        async function fetchBrowserStatus() {
            try {
                const resp = await fetch(API_URL + '/api/browser/status', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('cerebro_token') }
                });
                if (resp.ok) {
                    const data = await resp.json();
                    browserState.running = data.running || false;
                    browserState.paused = data.paused || false;
                    browserState.currentUrl = data.current_url || '';
                    updateBrowserPanel();
                }
            } catch(e) { /* Status check is optional */ }
        }

        async function refreshBrowserScreenshot() {
            try {
                const resp = await fetch(API_URL + '/api/browser/screenshot', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('cerebro_token') }
                });
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.screenshot) {
                        var b64src = data.screenshot.startsWith('data:') ? data.screenshot : 'data:image/png;base64,' + data.screenshot;
                        hitlBrowserScreenshot = b64src;
                        const previewImg = document.getElementById('browser-preview-img');
                        if (previewImg) previewImg.src = b64src;
                        // Also update HITL popup screenshots
                        document.querySelectorAll('.hitl-browser-preview img').forEach(function(img) {
                            img.src = b64src;
                        });
                    }
                }
            } catch(e) { /* Screenshot optional */ }
        }

        async function fetchBrowserTabs() {
            try {
                const resp = await fetch(API_URL + '/api/browser/tabs', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('cerebro_token') }
                });
                if (resp.ok) {
                    const data = await resp.json();
                    browserState.tabs = data.tabs || [];
                    updateBrowserTabs(browserState.tabs);
                }
            } catch(e) { /* Tab list optional */ }
        }

        // Chat page browser toggle  launch or stop the shared browser
        async function toggleChatBrowser() {
            chatBrowserEnabled = !chatBrowserEnabled;
            updateChatBrowserBtn();
        }

        // Reflect local chatBrowserEnabled toggle on the button
        function updateChatBrowserBtn() {
            var btn = document.getElementById('chat-browser-btn');
            var dot = document.getElementById('chat-browser-dot');
            if (!btn) return;
            if (chatBrowserEnabled) {
                btn.classList.add('browser-active');
                btn.title = 'Browser enabled for chat  Click to disable';
                if (dot) { dot.classList.add('running'); dot.classList.remove('paused'); }
            } else {
                btn.classList.remove('browser-active');
                btn.title = 'Enable browser for chat';
                if (dot) { dot.classList.remove('running', 'paused'); }
            }
        }

        function updateBrowserPanel() {
            var dot = document.getElementById('browser-status-dot');
            var statusText = document.getElementById('browser-status-text');
            var launchBtn = document.getElementById('browser-launch-btn');
            var launchLabel = document.getElementById('browser-launch-label');
            var controlToggle = document.getElementById('browser-control-toggle');
            var controlLabel = document.getElementById('browser-control-label');
            var urlInput = document.getElementById('browser-url-input');
            var stoppedView = document.getElementById('browser-tab-stopped');
            var runningView = document.getElementById('browser-tab-running');

            // Status dot
            if (dot) {
                dot.classList.remove('running', 'paused', 'stopped');
                if (browserState.running && !browserState.paused) {
                    dot.classList.add('running');
                } else if (browserState.paused) {
                    dot.classList.add('paused');
                } else {
                    dot.classList.add('stopped');
                }
            }

            // Status text
            if (statusText) {
                statusText.classList.remove('running', 'paused');
                if (browserState.running && !browserState.paused) {
                    statusText.textContent = 'Running';
                    statusText.classList.add('running');
                } else if (browserState.paused) {
                    statusText.textContent = "You're in control";
                    statusText.classList.add('paused');
                } else {
                    statusText.textContent = 'Stopped';
                }
            }

            // Launch/Stop button (compact)
            if (launchBtn && launchLabel) {
                if (browserState.running) {
                    launchBtn.classList.add('stop');
                    launchLabel.textContent = 'Stop';
                } else {
                    launchBtn.classList.remove('stop');
                    launchLabel.textContent = 'Launch';
                }
            }

            // Toggle stopped/running views
            if (stoppedView && runningView) {
                if (browserState.running) {
                    stoppedView.style.display = 'none';
                    runningView.style.display = 'flex';
                } else {
                    stoppedView.style.display = 'flex';
                    runningView.style.display = 'none';
                }
            }

            // Control toggle
            if (controlToggle && controlLabel) {
                if (browserState.paused) {
                    controlToggle.classList.add('give-back');
                    controlLabel.textContent = 'Give Back to Cerebro';
                } else {
                    controlToggle.classList.remove('give-back');
                    controlLabel.textContent = 'Take Control';
                }
            }

            // URL input  only update if not currently focused
            if (urlInput && document.activeElement !== urlInput) {
                urlInput.value = browserState.currentUrl || '';
            }

            // Tab badge sync
            updateBrowserTabBadge();

            // Start/stop screenshot interval (4s)
            if (browserState.running && !browserScreenshotInterval) {
                browserScreenshotInterval = setInterval(function() {
                    refreshBrowserScreenshot();
                    fetchBrowserTabs();
                }, 4000);
                refreshBrowserScreenshot();
                fetchBrowserTabs();
            } else if (!browserState.running && browserScreenshotInterval) {
                clearInterval(browserScreenshotInterval);
                browserScreenshotInterval = null;
            }
        }

        function updateBrowserTabs(tabs) {
            var container = document.getElementById('browser-tab-list');
            if (!container) return;

            // Clear existing tabs
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            if (!tabs || tabs.length === 0) return;

            tabs.forEach(function(tab) {
                var item = document.createElement('div');
                item.className = 'browser-tab-item';
                if (tab.active) item.classList.add('active-tab');

                if (tab.favicon) {
                    var favicon = document.createElement('img');
                    favicon.className = 'browser-tab-favicon';
                    favicon.src = tab.favicon;
                    favicon.alt = '';
                    favicon.onerror = function() { this.style.display = 'none'; };
                    item.appendChild(favicon);
                }

                var title = document.createElement('span');
                title.className = 'browser-tab-title';
                title.textContent = tab.title || tab.url || 'Untitled';
                item.appendChild(title);

                container.appendChild(item);
            });
        }

        function showUserActionBanner(description) {
            browserState.actionNeeded = true;
            browserState.actionDescription = description || 'Please complete an action in the browser.';
            var banner = document.getElementById('browser-action-banner');
            var desc = document.getElementById('browser-action-desc');
            if (banner) banner.classList.add('visible');
            if (desc) desc.textContent = browserState.actionDescription;

            // Play notification sound
            try {
                var audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleP//');
                audio.volume = 0.3;
                audio.play().catch(function() {});
            } catch(e) {}
        }

        function hideUserActionBanner() {
            browserState.actionNeeded = false;
            var banner = document.getElementById('browser-action-banner');
            if (banner) banner.classList.remove('visible');
        }

        function toggleBrowserLaunch() {
            if (browserState.running) {
                stopBrowser();
            } else {
                launchBrowser();
            }
        }

        function toggleBrowserControl() {
            if (browserState.paused) {
                resumeBrowser();
            } else {
                pauseBrowser();
            }
        }

        function renderOrbBrowser() {
            var stopped = document.getElementById('browser-tab-stopped');
            var running = document.getElementById('browser-tab-running');
            if (!stopped || !running) return;
            if (browserState.running) {
                stopped.style.display = 'none';
                running.style.display = 'flex';
                renderBrowserStepLog();
                refreshBrowserScreenshot();
            } else {
                stopped.style.display = 'flex';
                running.style.display = 'none';
            }
        }

        function renderBrowserStepLog() {
            var container = document.getElementById('browser-step-log');
            var header = document.getElementById('browser-step-log-header');
            var countEl = document.getElementById('browser-step-count');
            if (!container) return;

            if (browserStepLog.length === 0) {
                if (header) header.style.display = 'none';
                while (container.firstChild) container.removeChild(container.firstChild);
                return;
            }
            if (header) header.style.display = 'flex';
            if (countEl) countEl.textContent = browserStepLog.length;

            while (container.firstChild) container.removeChild(container.firstChild);
            browserStepLog.forEach(function(entry) {
                var el = document.createElement('div');
                el.className = 'browser-step-entry';

                var numEl = document.createElement('span');
                numEl.className = 'step-num';
                numEl.textContent = '#' + entry.step;
                el.appendChild(numEl);

                var bodyEl = document.createElement('div');
                bodyEl.className = 'step-body';
                var actionEl = document.createElement('div');
                actionEl.className = 'step-action';
                actionEl.textContent = entry.action || 'Action';
                bodyEl.appendChild(actionEl);
                if (entry.reasoning) {
                    var reasonEl = document.createElement('div');
                    reasonEl.className = 'step-reasoning';
                    reasonEl.textContent = entry.reasoning.substring(0, 120);
                    bodyEl.appendChild(reasonEl);
                }
                el.appendChild(bodyEl);

                if (entry.screenshot) {
                    var thumb = document.createElement('img');
                    thumb.className = 'step-thumb';
                    thumb.src = entry.screenshot.startsWith('data:') ? entry.screenshot : 'data:image/png;base64,' + entry.screenshot;
                    thumb.alt = '';
                    el.appendChild(thumb);
                }

                container.appendChild(el);
            });
            container.scrollTop = container.scrollHeight;
        }

        async function navigateBrowserUrl(url) {
            if (!url) return;
            if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
            try {
                await fetch(API_URL + '/api/browser/navigate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('cerebro_token')
                    },
                    body: JSON.stringify({ url: url })
                });
            } catch(e) { console.error('[Browser] Navigate error:', e); }
        }

        function updateBrowserTabBadge() {
            var badge = document.getElementById('orb-browser-badge');
            var indicator = document.getElementById('orb-browser-status-indicator');
            if (!badge || !indicator) return;
            indicator.classList.remove('running', 'paused', 'stopped');
            if (browserState.running) {
                badge.style.display = 'inline-flex';
                indicator.classList.add(browserState.paused ? 'paused' : 'running');
            } else {
                badge.style.display = 'none';
            }
        }

        function setupBrowserSocketListeners() {
            if (!socket) {
                setTimeout(setupBrowserSocketListeners, 1000);
                return;
            }

            socket.on('browser_launched', function(data) {
                console.log('[Browser] Launched:', data);
                browserState.running = true;
                browserState.paused = false;
                updateBrowserPanel();
            });

            socket.on('browser_shutdown', function(data) {
                console.log('[Browser] Shutdown:', data);
                browserState.running = false;
                browserState.paused = false;
                browserState.tabs = [];
                browserState.currentUrl = '';
                browserState.actionNeeded = false;
                browserStepLog = [];
                _agentBrowserStepCount = 0;
                hideUserActionBanner();
                updateBrowserPanel();
            });

            socket.on('browser_paused', function(data) {
                console.log('[Browser] Paused (user control):', data);
                browserState.paused = true;
                updateBrowserPanel();
            });

            socket.on('browser_resumed', function(data) {
                console.log('[Browser] Resumed (Cerebro control):', data);
                browserState.paused = false;
                browserState.actionNeeded = false;
                hideUserActionBanner();
                updateBrowserPanel();
            });

            socket.on('browser_navigated', function(data) {
                console.log('[Browser] Navigated:', data);
                if (data.url) {
                    browserState.currentUrl = data.url;
                    var urlInput = document.getElementById('browser-url-input');
                    if (urlInput && document.activeElement !== urlInput) {
                        urlInput.value = data.url;
                    }
                }
            });

            socket.on('browser_tab_opened', function(data) {
                console.log('[Browser] Tab opened:', data);
                fetchBrowserTabs();
            });

            socket.on('browser_tab_closed', function(data) {
                console.log('[Browser] Tab closed:', data);
                fetchBrowserTabs();
            });

            socket.on('browser_user_action_needed', function(data) {
                console.log('[Browser] User action needed:', data);
                browserState.paused = true;
                updateBrowserPanel();
                showUserActionBanner(data.description || data.message || 'Cerebro needs you to take action in Chrome.');
            });

            console.log('[Browser] Socket listeners registered');
        }

        setTimeout(setupBrowserSocketListeners, 700);

        // Fetch initial browser status on load
        setTimeout(fetchBrowserStatus, 1500);

        // Poll browser status every 10s as fallback (in case socket events are missed)
        setInterval(fetchBrowserStatus, 10000);

        // ==================== SKILLS SYSTEM ====================
        let skillsCache = [];
        let currentTab = 'focus'; // 'focus', 'completed', or 'skills'

        // Switch between Focus, Completed, and Skills tabs
        function switchToTab(tabName) {
            currentTab = tabName;

            // Update tab active states (both old sidebar and slide panel)
            ['tab-focus', 'tab-completed', 'tab-skills', 'slide-tab-focus', 'slide-tab-completed', 'slide-tab-skills'].forEach(id => {
                document.getElementById(id)?.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`)?.classList.add('active');
            document.getElementById(`slide-tab-${tabName}`)?.classList.add('active');

            // Show/hide content (old sidebar containers)
            document.getElementById('focus-container')?.classList.add('hidden');
            document.getElementById('completed-container')?.classList.add('hidden');
            document.getElementById('skills-list')?.classList.add('hidden');

            // Show/hide content (slide panel containers)
            document.getElementById('slide-focus-container')?.classList.add('hidden');
            document.getElementById('slide-completed-container')?.classList.add('hidden');
            document.getElementById('slide-skills-list')?.classList.add('hidden');

            if (tabName === 'focus') {
                document.getElementById('focus-container')?.classList.remove('hidden');
                document.getElementById('slide-focus-container')?.classList.remove('hidden');
            } else if (tabName === 'completed') {
                document.getElementById('completed-container')?.classList.remove('hidden');
                document.getElementById('slide-completed-container')?.classList.remove('hidden');
            } else if (tabName === 'skills') {
                document.getElementById('skills-list')?.classList.remove('hidden');
                document.getElementById('slide-skills-list')?.classList.remove('hidden');
                loadSkills(); // Reload skills when viewing
            }

            // Sync content to slide panel
            if (currentSlidePanel === 'skills') {
                syncMindDetailsToSlidePanel();
            }
        }

        // Legacy functions for backwards compatibility
        function switchToCompletedView() { switchToTab('completed'); }
        function switchToSkillsView() { switchToTab('skills'); }

        async function loadSkills(forceReload = true) {
            try {
                // First reload skills from disk to catch newly created ones
                if (forceReload) {
                    console.log('[Skills] Reloading from disk...');
                    const reloadResp = await fetch(`${API_URL}/api/skills/reload`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                    });
                    if (!reloadResp.ok) {
                        const errText = await reloadResp.text();
                        console.error('[Skills] Reload failed:', reloadResp.status, errText);
                    } else {
                        const reloadData = await reloadResp.json();
                        console.log('[Skills] Reloaded:', reloadData);
                    }
                }

                // Then fetch the skills list
                const response = await fetch(`${API_URL}/api/skills`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await response.json();
                skillsCache = data.skills || [];
                window.skillsList = skillsCache;
                renderSkillsList(skillsCache);
                const countEl = document.getElementById('skill-count');
                if (countEl) countEl.textContent = data.count || 0;
                if (typeof renderOrbSkills === 'function') renderOrbSkills();
                console.log('[Skills] Loaded', skillsCache.length, 'skills');
            } catch (e) {
                console.error('[Skills] Failed to load:', e);
            }
        }

        function renderSkillsList(skills) {
            const container = document.getElementById('skills-list');
            if (!container) return;

            if (!skills || skills.length === 0) {
                container.innerHTML = `
                    <div class="skills-empty">
                        <div style="font-size: 1.5rem; opacity: 0.4;"></div>
                        <div>No learned skills yet</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">
                            Skills are automatically created when Cerebro explores websites
                        </div>
                    </div>`;
                return;
            }

            container.innerHTML = skills.map(skill => {
                const statusClass = skill.status === 'verified' ? 'verified' :
                                   skill.status === 'failed' ? 'failed' : 'unverified';
                const statusLabel = skill.status === 'draft' ? 'new' : skill.status;
                // Clean up auto-generated names
                let displayName = skill.name.replace(/^auto_/, '').replace(/_/g, ' ');
                if (displayName.length > 40) displayName = displayName.substring(0, 40) + '...';
                // Truncate description
                let desc = skill.description || '';
                if (desc.length > 80) desc = desc.substring(0, 80) + '...';
                return `
                    <div class="skill-card" data-skill-id="${skill.id}">
                        <div class="skill-header">
                            <span class="skill-name">${displayName}</span>
                            <span class="skill-status ${statusClass}">${statusLabel}</span>
                        </div>
                        <div class="skill-description">${desc}</div>
                        <div class="skill-meta">
                            <span>${skill.steps?.length || 0} steps</span>
                            <span></span>
                            <span>Used ${skill.success_count || 0}x</span>
                        </div>
                        <div class="skill-actions">
                            <button onclick="executeSkill('${skill.id}')" class="skill-btn primary"> Run</button>
                            <button onclick="verifySkill('${skill.id}')" class="skill-btn secondary"> Verify</button>
                            <button onclick="deleteSkill('${skill.id}')" class="skill-btn danger"></button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addSkillToPanel(skill) {
            const container = document.getElementById('skills-list');
            if (!container) return;

            // Remove empty state if present
            const emptyState = container.querySelector('.skills-empty');
            if (emptyState) emptyState.remove();

            // Check if skill already exists
            const existing = container.querySelector(`[data-skill-id="${skill.skill_id || skill.id}"]`);
            if (existing) return;

            const skillId = skill.skill_id || skill.id;
            const card = document.createElement('div');
            card.className = 'skill-card skill-new';
            card.dataset.skillId = skillId;
            card.innerHTML = `
                <div class="skill-header">
                    <span class="skill-name">${skill.name}</span>
                    <span class="skill-status unverified">new</span>
                </div>
                <div class="skill-description">${skill.description || ''}</div>
                <div class="skill-actions">
                    <button onclick="executeSkill('${skillId}')" class="skill-btn primary"> Run</button>
                    <button onclick="verifySkill('${skillId}')" class="skill-btn secondary"> Verify</button>
                </div>
            `;
            container.prepend(card);

            // Update count
            const count = document.getElementById('skill-count');
            if (count) count.textContent = parseInt(count.textContent || '0') + 1;

            // Animate
            setTimeout(() => card.classList.remove('skill-new'), 100);
        }

        async function executeSkill(skillId) {
            console.log('[Skill] Executing:', skillId);
            showToast('Executing skill...', 'info');
            try {
                const response = await fetch(`${API_URL}/api/skills/${skillId}/execute`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                console.log('[Skill] Response status:', response.status);
                const result = await response.json();
                console.log('[Skill] Result:', result);
                if (result.success) {
                    showToast(' Skill executed successfully', 'success');
                    // Show output in a modal
                    showSkillOutput(skillId, result);
                } else {
                    showToast(` Skill failed: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (e) {
                console.error('[Skill] Error:', e);
                showToast('Failed to execute skill', 'error');
            }
        }

        function showSkillOutput(skillId, result) {
            // Convert output to markdown format (like agent output)
            const output = result.output;
            let markdownContent = '';

            // Build structured markdown
            markdownContent += `## Skill Execution Complete\n\n`;
            markdownContent += `**Status:** ${result.steps_completed}/${result.total_steps} steps completed in ${(result.duration_ms / 1000).toFixed(1)}s\n\n`;

            if (Array.isArray(output)) {
                // Numbered list (like headlines)
                markdownContent += `### Results (${output.length} items)\n\n`;
                output.forEach((item, i) => {
                    // Handle items that might have titles/urls or just be strings
                    if (typeof item === 'object' && item !== null) {
                        if (item.title && item.url) {
                            markdownContent += `${i + 1}. [${item.title}](${item.url})\n`;
                        } else if (item.title) {
                            markdownContent += `${i + 1}. **${item.title}**\n`;
                        } else {
                            markdownContent += `${i + 1}. ${JSON.stringify(item)}\n`;
                        }
                    } else {
                        markdownContent += `${i + 1}. ${String(item)}\n`;
                    }
                });
            } else if (typeof output === 'string') {
                markdownContent += `### Output\n\n${output}\n`;
            } else if (output && typeof output === 'object') {
                // Object output - format as key-value pairs
                markdownContent += `### Data\n\n`;
                for (const [key, value] of Object.entries(output)) {
                    if (Array.isArray(value)) {
                        markdownContent += `**${key}:**\n`;
                        value.forEach((v, i) => {
                            markdownContent += `  ${i + 1}. ${String(v)}\n`;
                        });
                    } else {
                        markdownContent += `- **${key}:** ${String(value)}\n`;
                    }
                }
            } else {
                markdownContent += `*No output data captured*\n`;
            }

            // Render markdown using marked.js (like agent output does)
            let renderedHtml = '';
            try {
                if (typeof marked !== 'undefined') {
                    marked.setOptions({ breaks: true, gfm: true });
                    renderedHtml = marked.parse(markdownContent);
                } else {
                    renderedHtml = `<pre>${escapeHtml(markdownContent)}</pre>`;
                }
            } catch (e) {
                console.error('Markdown parse error:', e);
                renderedHtml = `<pre>${escapeHtml(markdownContent)}</pre>`;
            }

            // Create modal with agent-output-rendered styling
            const modal = document.createElement('div');
            modal.className = 'skill-output-modal';
            modal.innerHTML = `
                <div class="skill-output-backdrop" onclick="this.parentElement.remove()"></div>
                <div class="skill-output-content">
                    <div class="skill-output-header">
                        <div class="skill-output-title">
                            <span class="skill-output-icon"></span>
                            <span>OUTPUT</span>
                        </div>
                        <button class="skill-output-close" onclick="this.closest('.skill-output-modal').remove()"></button>
                    </div>
                    <div class="skill-output-body">
                        <div class="agent-output-rendered">
                            ${renderedHtml}
                        </div>
                    </div>
                    <div class="skill-output-actions">
                        <button onclick="copySkillOutput()" class="skill-output-btn"> Copy</button>
                        <button onclick="this.closest('.skill-output-modal').remove()" class="skill-output-btn primary">Done</button>
                    </div>
                </div>
            `;

            // Store output for copy (store markdown for better copy)
            window._lastSkillOutput = output;
            window._lastSkillMarkdown = markdownContent;

            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('visible'), 10);
        }

        function copySkillOutput() {
            // Use the markdown format for better copying
            let text = window._lastSkillMarkdown || '';
            if (!text && window._lastSkillOutput) {
                const output = window._lastSkillOutput;
                if (Array.isArray(output)) {
                    text = output.map((item, i) => `${i + 1}. ${typeof item === 'object' ? (item.title || JSON.stringify(item)) : item}`).join('\n');
                } else if (typeof output === 'string') {
                    text = output;
                } else {
                    text = JSON.stringify(output, null, 2);
                }
            }
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard', 'success');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function verifySkill(skillId) {
            showToast('Verifying skill...', 'info');
            try {
                const response = await fetch(`${API_URL}/api/skills/${skillId}/verify`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ dry_run: true, auto_heal: true })
                });
                const result = await response.json();
                showToast(
                    result.success ? ' Skill verified!' : ' Skill verification failed',
                    result.success ? 'success' : 'warning'
                );
                // Reload skills to show updated status
                loadSkills();
            } catch (e) {
                showToast('Failed to verify skill', 'error');
            }
        }

        async function deleteSkill(skillId) {
            if (!await cerebroConfirm('Delete this skill? This cannot be undone.', { title: 'Delete Skill', danger: true, confirmText: 'Delete' })) return;
            try {
                await fetch(`${API_URL}/api/skills/${skillId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                loadSkills();
                showToast('Skill deleted', 'info');
            } catch (e) {
                showToast('Failed to delete skill', 'error');
            }
        }

        function toggleSkillsPanel() {
            const section = document.getElementById('skills-section');
            if (section) section.classList.toggle('collapsed');
        }

        // Load skills on page load
        setTimeout(loadSkills, 1000);

        // ==================== DEBUG FEED SYSTEM ====================
        let debugEvents = [];
        const MAX_DEBUG_EVENTS = 100;

        function toggleDebugFeed() {
            const section = document.getElementById('debug-feed-section');
            section.classList.toggle('collapsed');
        }

        function clearDebugFeed() {
            debugEvents = [];
            const content = document.getElementById('debug-feed-content');
            content.innerHTML = `
                <div class="debug-feed-empty">
                    <div style="font-size: 1.2rem; opacity: 0.4;"></div>
                    <div>Debug feed cleared</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted);">New events will appear here</div>
                </div>`;
            document.getElementById('debug-feed-count').textContent = '0 events';
        }

        function addDebugEvent(event) {
            // Add to array
            debugEvents.unshift(event);
            if (debugEvents.length > MAX_DEBUG_EVENTS) {
                debugEvents.pop();
            }

            // Update count
            const countEl = document.getElementById('debug-feed-count');
            if (countEl) countEl.textContent = `${debugEvents.length} events`;

            // Render event
            const content = document.getElementById('debug-feed-content');
            if (!content) return;

            // Remove empty state if present
            const emptyState = content.querySelector('.debug-feed-empty');
            if (emptyState) {
                emptyState.remove();
            }

            // Create event element
            const eventEl = document.createElement('div');
            eventEl.className = `debug-event ${event.type}`;
            eventEl.innerHTML = formatDebugEvent(event);

            // Prepend to content
            content.insertBefore(eventEl, content.firstChild);

            // Limit DOM elements
            while (content.children.length > MAX_DEBUG_EVENTS) {
                content.removeChild(content.lastChild);
            }
        }

        function formatDebugEvent(event) {
            const time = new Date(event.timestamp).toLocaleTimeString();
            const phase = event.phase ? `<span class="debug-event-phase">${event.phase}</span>` : '';

            let contentHtml = '';

            switch (event.type) {
                case 'llm_prompt':
                    contentHtml = `
                        ${phase}<span class="model"> ${event.model || getModelDisplayName(getSelectedModel())}</span>
                        <pre>${escapeHtml(event.prompt || '')}</pre>
                        <div style="font-size: 0.6rem; color: var(--text-muted); margin-top: 4px;">
                            Full prompt: ${event.full_prompt_length || 0} chars
                        </div>`;
                    break;

                case 'llm_response':
                    contentHtml = `
                        ${phase}<span class="model"> ${event.model || getModelDisplayName(getSelectedModel())}</span>
                        <span class="tokens">${event.tokens || 0} tokens</span>
                        <span class="duration">${event.tokens_per_sec || 0} tok/s  ${event.duration_ms || 0}ms</span>
                        <pre>${escapeHtml(event.content || '')}</pre>
                        ${event.thinking ? `<div class="thinking"> ${escapeHtml(event.thinking)}</div>` : ''}`;
                    break;

                case 'api_call':
                    contentHtml = `
                        ${phase}<span style="color: var(--blue);"> ${event.method || 'GET'}</span>
                        <span style="color: var(--text-primary);">${event.endpoint || ''}</span>`;
                    break;

                case 'api_response':
                    contentHtml = `
                        ${phase}<span style="color: var(--green);"> ${event.status || 200}</span>
                        <span>${event.endpoint || ''}</span>
                        ${event.count !== undefined ? `<span class="tokens">${event.count} items</span>` : ''}`;
                    break;

                case 'api_error':
                    contentHtml = `
                        <span style="color: var(--red);"> ${event.endpoint || ''}</span>
                        <pre style="color: var(--red);">${escapeHtml(event.error || 'Unknown error')}</pre>`;
                    break;

                case 'action_execute':
                    contentHtml = `
                        ${phase}<span style="color: var(--yellow);"> EXECUTING:</span>
                        <span style="color: var(--text-primary);">${event.action_type || ''}</span>
                        ${event.target ? `<span> ${event.target}</span>` : ''}
                        <span class="debug-event-phase" style="background: rgba(234, 179, 8, 0.2); color: var(--yellow);">${event.risk_level || 'LOW'}</span>`;
                    break;

                case 'action_result':
                    const success = event.success ? '' : '';
                    const color = event.success ? 'var(--green)' : 'var(--red)';
                    contentHtml = `
                        ${phase}<span style="color: ${color};">${success} ${event.action_type || ''}</span>
                        ${event.output ? `<pre>${escapeHtml(event.output)}</pre>` : ''}`;
                    break;

                default:
                    contentHtml = `<pre>${JSON.stringify(event, null, 2)}</pre>`;
            }

            return `
                <div class="debug-event-header">
                    <span class="debug-event-type">${event.type.replace('_', ' ')}</span>
                    <span class="debug-event-time">${time}</span>
                </div>
                <div class="debug-event-content">${contentHtml}</div>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== GOALS SYSTEM ====================
        let goals = [];
        let pendingChatMessage = null;

        async function loadGoals() {
            try {
                const response = await fetch(`${API_URL}/api/goals`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });
                const data = await response.json();

                if (data.success && data.goals) {
                    goals = data.goals;
                    renderGoals();
                }
            } catch (e) {
                console.error('Failed to load goals:', e);
            }
        }

        function renderGoals() {
            const activeContainer = document.getElementById('active-goals');
            const blockedContainer = document.getElementById('blocked-goals');
            const completedContainer = document.getElementById('completed-goals');

            // Filter goals by status
            const active = goals.filter(g => g.status === 'active' && !g.known_blockers?.length);
            const blocked = goals.filter(g => g.status === 'active' && g.known_blockers?.length > 0);
            const completed = goals.filter(g => g.status === 'completed');

            // Render active goals
            if (active.length > 0) {
                activeContainer.innerHTML = active.map(createGoalCard).join('');
            } else {
                activeContainer.innerHTML = `
                    <div class="goals-empty">
                        <div class="goals-empty-icon"></div>
                        <div>No active goals</div>
                        <div style="font-size: 0.8rem; margin-top: 4px;">Create one to get started</div>
                    </div>`;
            }

            // Render blocked goals
            if (blocked.length > 0) {
                blockedContainer.innerHTML = blocked.map(g => createGoalCard(g, 'blocked')).join('');
            } else {
                blockedContainer.innerHTML = `
                    <div class="goals-empty" style="opacity: 0.6;">
                        <div>No blocked goals</div>
                    </div>`;
            }

            // Render completed goals
            if (completed.length > 0) {
                completedContainer.innerHTML = completed.slice(0, 5).map(g => createGoalCard(g, 'completed')).join('');
            } else {
                completedContainer.innerHTML = `
                    <div class="goals-empty" style="opacity: 0.6;">
                        <div>No completed goals</div>
                    </div>`;
            }
        }

        function createGoalCard(goal, status = 'active') {
            const priorityClass = goal.priority || 'medium';
            const blockers = goal.known_blockers || [];
            const subgoals = goal.subgoals || [];

            return `
                <div class="goal-card ${status}" data-id="${goal.goal_id}" onclick="showGoalDetail('${goal.goal_id}')">
                    <div class="goal-header">
                        <span class="goal-priority ${priorityClass}">${priorityClass}</span>
                        ${goal.progress_history ? `<span class="goal-progress">${goal.progress_history.length} updates</span>` : ''}
                    </div>
                    <h4 class="goal-title">${escapeHtml(goal.description.slice(0, 100))}${goal.description.length > 100 ? '...' : ''}</h4>
                    ${subgoals.length > 0 ? `
                        <div class="goal-subtasks">
                            ${subgoals.slice(0, 3).map((s, i) => `
                                <div class="subtask">
                                    <span class="subtask-check"></span>
                                    ${escapeHtml(s.slice(0, 50))}
                                </div>
                            `).join('')}
                            ${subgoals.length > 3 ? `<div class="subtask" style="opacity: 0.6;">+${subgoals.length - 3} more</div>` : ''}
                        </div>
                    ` : ''}
                    ${blockers.length > 0 ? `
                        <div class="goal-blockers">
                            ${blockers.slice(0, 2).map(b => `
                                <span class="blocker-tag"> ${escapeHtml(b.slice(0, 30))}${b.length > 30 ? '...' : ''}</span>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="goal-actions" onclick="event.stopPropagation()">
                        <button onclick="pursueGoal('${goal.goal_id}')"> Pursue</button>
                        ${status !== 'completed' ? `<button onclick="completeGoal('${goal.goal_id}')"> Complete</button>` : ''}
                    </div>
                </div>
            `;
        }

        function openGoalModal() {
            const modalHtml = `
                <div class="modal-overlay active" id="goal-modal" onclick="if(event.target === this) closeGoalModal()">
                    <div class="modal prediction-modal">
                        <div class="modal-header">
                            <span class="modal-icon"></span>
                            <h3>Create New Goal</h3>
                        </div>
                        <div class="modal-body">
                            <div class="goal-form-group">
                                <label class="goal-form-label">What do you want to accomplish?</label>
                                <textarea class="goal-form-input" id="goal-description" placeholder="e.g., Set up automated backup system for NAS" style="height: 80px;"></textarea>
                            </div>
                            <div class="goal-form-group">
                                <label class="goal-form-label">Priority</label>
                                <select class="goal-form-input" id="goal-priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn-secondary" onclick="closeGoalModal()">Cancel</button>
                            <button class="btn-primary" onclick="createGoal()">Create Goal</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('goal-description').focus();
        }

        function closeGoalModal() {
            const modal = document.getElementById('goal-modal');
            if (modal) modal.remove();
        }

        async function createGoal() {
            const description = document.getElementById('goal-description').value.trim();
            const priority = document.getElementById('goal-priority').value;

            if (!description) {
                showToast('Please enter a goal description', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/goals`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ description, priority })
                });

                if (response.ok) {
                    showToast('Goal created!', 'success');
                    closeGoalModal();
                    await loadGoals();
                } else {
                    showToast('Failed to create goal', 'error');
                }
            } catch (e) {
                console.error('Error creating goal:', e);
                showToast('Error creating goal', 'error');
            }
        }

        async function completeGoal(goalId) {
            try {
                const response = await fetch(`${API_URL}/api/goals/${goalId}/complete`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}` }
                });

                if (response.ok) {
                    showToast('Goal completed! ', 'success');
                    await loadGoals();
                }
            } catch (e) {
                console.error('Error completing goal:', e);
            }
        }

        async function pursueGoal(goalId) {
            const goal = goals.find(g => g.goal_id === goalId);
            if (!goal) return;

            showToast('Spawning agent to pursue goal...', 'info');

            try {
                // Create an agent to pursue this goal
                const response = await fetch(`${API_URL}/agents`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task: `Work on achieving this goal: ${goal.description}\n\nBreak it down into actionable steps and start executing.`,
                        agent_type: 'worker',
                        context: `Goal ID: ${goalId}, Priority: ${goal.priority}`
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showToast('Agent spawned to pursue goal!', 'success');
                    switchView('agents');
                }
            } catch (e) {
                console.error('Error pursuing goal:', e);
                showToast('Failed to spawn agent', 'error');
            }
        }

        function showGoalDetail(goalId) {
            // For now, just show the pursue/edit options
            const goal = goals.find(g => g.goal_id === goalId);
            if (!goal) return;
            // Could expand to a full detail view later
        }

        // ==================== PREDICTIVE INTERRUPTS ====================
        async function analyzeMessageBeforeSending(message) {
            try {
                const response = await fetch(`${API_URL}/api/chat/analyze`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cerebro_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                if (data.warnings && data.warnings.length > 0) {
                    // Show warning modal
                    pendingChatMessage = message;
                    showPredictionWarningModal(data.warnings, data.suggestions || []);
                    return false; // Don't send yet
                }

                return true; // OK to send
            } catch (e) {
                console.error('Error analyzing message:', e);
                return true; // On error, let it through
            }
        }

        function showPredictionWarningModal(warnings, suggestions) {
            const warningsHtml = warnings.map(w => `
                <div class="warning-item">
                    <span class="confidence">${Math.round((w.confidence || 0.7) * 100)}%</span>
                    <span class="text">${escapeHtml(w.warning || w.pattern)}</span>
                </div>
            `).join('');

            const alternativesHtml = suggestions.length > 0 ? `
                <div class="prediction-alternatives">
                    <h4>Suggestions:</h4>
                    <ul>
                        ${suggestions.map((s, i) => `
                            <li onclick="useSuggestion('${escapeHtml(s.message || s)}')">${escapeHtml(s.message || s)}</li>
                        `).join('')}
                    </ul>
                </div>
            ` : '';

            const modalHtml = `
                <div class="modal-overlay" id="prediction-modal" onclick="if(event.target === this) closePredictionModal()">
                    <div class="modal prediction-modal">
                        <div class="modal-header">
                            <span class="modal-icon"></span>
                            <h3>Cerebro Detected a Potential Issue</h3>
                        </div>
                        <div class="modal-body">
                            <div class="prediction-warnings">
                                ${warningsHtml}
                            </div>
                            ${alternativesHtml}
                        </div>
                        <div class="modal-actions">
                            <button class="btn-secondary" onclick="cancelPredictedAction()">Cancel</button>
                            <button class="btn-primary" onclick="proceedAnyway()">Proceed Anyway</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closePredictionModal() {
            const modal = document.getElementById('prediction-modal');
            if (modal) modal.remove();
            pendingChatMessage = null;
        }

        function cancelPredictedAction() {
            closePredictionModal();
            showToast('Action cancelled', 'info');
        }

        function proceedAnyway() {
            closePredictionModal();
            if (pendingChatMessage) {
                // Send the message directly without re-analyzing
                sendMessageDirect(pendingChatMessage);
                pendingChatMessage = null;
            }
        }

        function useSuggestion(suggestion) {
            closePredictionModal();
            // Put suggestion in chat input
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.value = suggestion;
                chatInput.focus();
            }
        }

        // Helper to send message without analysis (after warning accepted)
        function sendMessageDirect(message) {
            if (socket && socket.connected) {
                socket.emit('chat_message', {
                    content: message,
                    session_id: 'default',
                    model: getSelectedModel()
                });

                // Add user message to UI
                addMessage('user', message);
                scrollMessagesToBottom();
            }
        }

        // Escape HTML helper
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== AUTOMATION SYSTEM ====================
        let schedules = [];
        let currentCalendarDate = new Date();
        let automationAgentType = 'researcher';
        let automationScheduleType = 'once';
        let automationFrequency = 'daily';
        let automationDaysOfWeek = [1, 2, 3, 4, 5]; // Mon-Fri default
        let automationTimeout = 3600; // default 1 hour

        function selectAutomationTimeout(btn) {
            document.querySelectorAll('#automation-timeout-selector .timeout-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            automationTimeout = parseInt(btn.dataset.timeout);
        }

        async function loadSchedules() {
            try {
                const response = await fetch(`${API_URL}/schedules`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                schedules = data.schedules || [];
            } catch (error) {
                console.error('Failed to load schedules:', error);
                schedules = [];
            }
            // Always render even if API fails
            renderSchedulesList();
            renderCalendar();
        }

        async function loadExecutionHistory() {
            try {
                const response = await fetch(`${API_URL}/schedules/history?limit=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                renderExecutionHistory(data.executions || []);
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }

        async function clearRecentActivity() {
            if (!await cerebroConfirm('Clear all recent activity? This cannot be undone.', { title: 'Clear Activity', danger: true, confirmText: 'Clear' })) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/schedules/history`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    renderExecutionHistory([]);
                    showToast('Activity cleared', 'success');
                } else {
                    showToast('Failed to clear activity', 'error');
                }
            } catch (error) {
                console.error('Failed to clear activity:', error);
                showToast('Failed to clear activity', 'error');
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const label = document.getElementById('calendar-month-label');
            if (!grid || !label) return;

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            label.textContent = `${monthNames[month]} ${year}`;

            // Get first day of month and total days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            // Get schedules for this month
            const monthSchedules = getSchedulesForMonth(year, month);

            grid.innerHTML = '';

            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                grid.innerHTML += `<div class="calendar-day other-month"><span class="day-number">${day}</span></div>`;
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = isCurrentMonth && today.getDate() === day;
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const daySchedules = monthSchedules.filter(s => s.dates && s.dates.includes(dateStr));

                let eventsHtml = '';
                daySchedules.forEach(s => {
                    eventsHtml += `<div class="event-dot ${s.agent_type}"></div>`;
                });

                grid.innerHTML += `
                    <div class="calendar-day ${isToday ? 'today' : ''}" onclick="showDaySchedules('${dateStr}')">
                        <span class="day-number">${day}</span>
                        <div class="day-events">${eventsHtml}</div>
                    </div>
                `;
            }

            // Next month days to fill grid
            const totalCells = firstDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let day = 1; day <= remainingCells; day++) {
                grid.innerHTML += `<div class="calendar-day other-month"><span class="day-number">${day}</span></div>`;
            }
        }

        function getSchedulesForMonth(year, month) {
            // Calculate which dates each schedule runs on this month
            return schedules.map(schedule => {
                const dates = [];
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                if (schedule.schedule_type === 'once' && schedule.date) {
                    const schedDate = new Date(schedule.date);
                    if (schedDate.getFullYear() === year && schedDate.getMonth() === month) {
                        dates.push(schedule.date);
                    }
                } else if (schedule.schedule_type === 'recurring') {
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const dayOfWeek = date.getDay();

                        if (schedule.frequency === 'daily') {
                            dates.push(`${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                        } else if (schedule.frequency === 'weekly' && schedule.days_of_week && schedule.days_of_week.includes(dayOfWeek)) {
                            dates.push(`${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                        } else if (schedule.frequency === 'monthly' && day === 1) {
                            dates.push(`${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                        }
                    }
                }

                return { ...schedule, dates };
            });
        }

        function navigateCalendar(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        function showDaySchedules(dateStr) {
            // Could show a popup with that day's schedules
            console.log('Day clicked:', dateStr);
        }

        function renderSchedulesList() {
            const list = document.getElementById('schedules-list');
            if (!list) return;

            // Update stats
            updateAutomationStats();

            if (schedules.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        </div>
                        <div class="empty-state-text">No automations yet. Create one to get started!</div>
                    </div>
                `;
                return;
            }

            const agentIcons = {
                'researcher': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
                'coder': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
                'worker': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
                'analyst': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>'
            };
            const defaultIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="5"/><path d="M3 21v-2a7 7 0 0 1 7-7h4a7 7 0 0 1 7 7v2"/></svg>';

            list.innerHTML = schedules.map(schedule => {
                const icon = agentIcons[schedule.agent_type] || defaultIcon;
                const timing = schedule.schedule_type === 'once'
                    ? `${schedule.date} at ${schedule.time}`
                    : `${schedule.frequency} at ${schedule.time}`;
                const badge = schedule.schedule_type === 'recurring'
                    ? '<span class="schedule-badge recurring">recurring</span>'
                    : '<span class="schedule-badge">one-time</span>';

                return `
                    <div class="schedule-card" onclick="openEditAutomationModal('${schedule.id}')" style="cursor: pointer;">
                        <div class="schedule-toggle" onclick="event.stopPropagation()">
                            <input type="checkbox" ${schedule.enabled ? 'checked' : ''}
                                   onchange="toggleSchedule('${schedule.id}', this.checked)">
                        </div>
                        <div class="schedule-info">
                            <div class="schedule-name">${icon} ${schedule.name}</div>
                            <div class="schedule-timing">${timing} ${badge}</div>
                        </div>
                        <div class="schedule-actions" onclick="event.stopPropagation()">
                            <button class="run-btn" onclick="runScheduleNow('${schedule.id}')" title="Run now">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            </button>
                            <button class="delete-btn" onclick="deleteSchedule('${schedule.id}')" title="Delete">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateAutomationStats() {
            const totalEl = document.getElementById('auto-stat-total');
            const activeEl = document.getElementById('auto-stat-active');
            const todayEl = document.getElementById('auto-stat-today');
            const countEl = document.getElementById('auto-count');

            if (totalEl) totalEl.textContent = schedules.length;
            if (activeEl) activeEl.textContent = schedules.filter(s => s.enabled).length;
            if (countEl) countEl.textContent = schedules.length;

            // Count schedules that run today
            const today = new Date().toISOString().split('T')[0];
            const todayCount = schedules.filter(s => {
                if (!s.enabled) return false;
                if (s.schedule_type === 'once') return s.date === today;
                if (s.schedule_type === 'recurring') {
                    if (s.frequency === 'daily') return true;
                    if (s.frequency === 'weekly') {
                        const dayOfWeek = new Date().getDay();
                        return s.days_of_week && s.days_of_week.includes(dayOfWeek);
                    }
                }
                return false;
            }).length;
            if (todayEl) todayEl.textContent = todayCount;
        }

        function renderExecutionHistory(executions) {
            const container = document.getElementById('execution-history');
            if (!container) return;

            if (executions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                        </div>
                        <div class="empty-state-text">No executions yet</div>
                    </div>
                `;
                return;
            }

            const statusIcons = {
                'success': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>',
                'failed': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
                'running': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>'
            };
            const defaultStatusIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>';

            container.innerHTML = executions.map(exec => {
                const time = new Date(exec.started_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const date = new Date(exec.started_at).toLocaleDateString([], { month: 'short', day: 'numeric' });
                const icon = statusIcons[exec.status] || defaultStatusIcon;

                // Make clickable if agent_id exists
                const clickable = exec.agent_id ? 'clickable' : '';
                const onclick = exec.agent_id ? `onclick="showExecutionAgentDetail('${exec.agent_id}')"` : '';

                return `
                    <div class="execution-item ${clickable}" ${onclick}>
                        <div class="execution-time">${date}<br>${time}</div>
                        <div class="execution-status ${exec.status}">${icon}</div>
                        <div class="execution-info">
                            <div class="execution-name">${exec.schedule_name}</div>
                            <div class="execution-type">${exec.trigger}  ${exec.agent_type}</div>
                        </div>
                        ${exec.agent_id ? '<div class="execution-arrow"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function openCreateAutomationModal() {
            // Reset edit mode
            editingScheduleId = null;

            // Reset form
            document.getElementById('automation-name').value = '';
            document.getElementById('automation-prompt').value = '';
            document.getElementById('automation-time').value = '09:00';
            document.getElementById('automation-enabled').checked = true;

            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('automation-date').value = tomorrow.toISOString().split('T')[0];

            // Reset toggles
            automationAgentType = 'researcher';
            automationScheduleType = 'once';
            automationFrequency = 'daily';
            automationDaysOfWeek = [1, 2, 3, 4, 5];
            automationTimeout = 3600;

            // Reset UI
            document.querySelectorAll('#automation-agent-selector .role-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.role === 'researcher');
            });
            document.querySelectorAll('.schedule-type-toggle .toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === 'once');
            });
            document.querySelectorAll('.day-selector .day-btn').forEach(btn => {
                const day = parseInt(btn.dataset.day);
                btn.classList.toggle('active', automationDaysOfWeek.includes(day));
            });
            document.querySelectorAll('#automation-timeout-selector .timeout-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.timeout) === 3600);
            });

            // Hide recurring options
            document.getElementById('recurring-options').classList.add('hidden');
            document.getElementById('weekly-options').classList.add('hidden');
            document.getElementById('cron-options').classList.add('hidden');
            document.getElementById('date-group').style.display = 'block';

            // Reset modal title and button for create mode
            document.querySelector('#automation-modal .modal-title').textContent = ' Create Automation';
            document.querySelector('#automation-modal .modal-footer .btn-primary').textContent = 'Create Automation';
            document.querySelector('#automation-modal .modal-footer .btn-primary').onclick = createAutomation;

            document.body.classList.add('modal-open');
            document.getElementById('automation-modal').classList.add('active');
        }

        function closeAutomationModal() {
            document.body.classList.remove('modal-open');
            document.getElementById('automation-modal').classList.remove('active');
        }

        function selectAutomationAgent(agentType) {
            automationAgentType = agentType;
            document.querySelectorAll('#automation-agent-selector .role-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.role === agentType);
            });
        }

        function selectScheduleType(type) {
            automationScheduleType = type;
            document.querySelectorAll('.schedule-type-toggle .toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });

            const recurringOptions = document.getElementById('recurring-options');
            const dateGroup = document.getElementById('date-group');

            if (type === 'recurring') {
                recurringOptions.classList.remove('hidden');
                dateGroup.style.display = 'none';
                updateFrequencyOptions();
            } else {
                recurringOptions.classList.add('hidden');
                dateGroup.style.display = 'block';
                document.getElementById('weekly-options').classList.add('hidden');
                document.getElementById('cron-options').classList.add('hidden');
            }
        }

        function updateFrequencyOptions() {
            const frequency = document.getElementById('automation-frequency').value;
            automationFrequency = frequency;

            const weeklyOptions = document.getElementById('weekly-options');
            const cronOptions = document.getElementById('cron-options');

            weeklyOptions.classList.toggle('hidden', frequency !== 'weekly');
            cronOptions.classList.toggle('hidden', frequency !== 'custom');
        }

        function toggleAutomationDay(day) {
            const btn = document.querySelector(`.day-selector .day-btn[data-day="${day}"]`);
            const index = automationDaysOfWeek.indexOf(day);

            if (index > -1) {
                automationDaysOfWeek.splice(index, 1);
                btn.classList.remove('active');
            } else {
                automationDaysOfWeek.push(day);
                automationDaysOfWeek.sort();
                btn.classList.add('active');
            }
        }

        let editingScheduleId = null; // Track if we're editing

        async function createAutomation() {
            const name = document.getElementById('automation-name').value.trim();
            const prompt = document.getElementById('automation-prompt').value.trim();

            if (!name || !prompt) {
                alert('Please enter a name and task/prompt');
                return;
            }

            const data = {
                name: name,
                agent_type: automationAgentType,
                prompt: prompt,
                schedule_type: automationScheduleType,
                frequency: automationFrequency,
                date: document.getElementById('automation-date').value,
                time: document.getElementById('automation-time').value,
                days_of_week: automationDaysOfWeek,
                cron: document.getElementById('automation-cron')?.value || null,
                enabled: document.getElementById('automation-enabled').checked,
                timeout: automationTimeout
            };

            try {
                const response = await fetch(`${API_URL}/schedules`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeAutomationModal();
                    loadSchedules();
                    loadExecutionHistory();
                } else {
                    const err = await response.json();
                    alert('Failed to create automation: ' + (err.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to create automation:', error);
                alert('Failed to create automation');
            }
        }

        async function openEditAutomationModal(scheduleId) {
            // Find the schedule
            const schedule = schedules.find(s => s.id === scheduleId);
            if (!schedule) {
                console.error('Schedule not found:', scheduleId);
                return;
            }

            editingScheduleId = scheduleId;

            // Pre-populate the form
            document.getElementById('automation-name').value = schedule.name || '';
            document.getElementById('automation-prompt').value = schedule.prompt || '';
            document.getElementById('automation-time').value = schedule.time || '09:00';
            document.getElementById('automation-date').value = schedule.date || '';
            document.getElementById('automation-enabled').checked = schedule.enabled !== false;

            // Set agent type
            automationAgentType = schedule.agent_type || 'researcher';
            document.querySelectorAll('#automation-agent-selector .role-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.role === automationAgentType);
            });

            // Set timeout
            automationTimeout = schedule.timeout || 3600;
            document.querySelectorAll('#automation-timeout-selector .timeout-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.timeout) === automationTimeout);
            });

            // Set schedule type
            automationScheduleType = schedule.schedule_type || 'once';
            document.querySelectorAll('.schedule-type-toggle .toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === automationScheduleType);
            });

            // Set frequency
            automationFrequency = schedule.frequency || 'daily';
            document.getElementById('automation-frequency').value = automationFrequency;

            // Set days of week
            automationDaysOfWeek = schedule.days_of_week || [1, 2, 3, 4, 5];
            document.querySelectorAll('.day-selector .day-btn').forEach(btn => {
                const day = parseInt(btn.dataset.day);
                btn.classList.toggle('active', automationDaysOfWeek.includes(day));
            });

            // Set cron if exists
            if (schedule.cron) {
                document.getElementById('automation-cron').value = schedule.cron;
            }

            // Show/hide appropriate options
            const recurringOptions = document.getElementById('recurring-options');
            const dateGroup = document.getElementById('date-group');
            const weeklyOptions = document.getElementById('weekly-options');
            const cronOptions = document.getElementById('cron-options');

            if (automationScheduleType === 'recurring') {
                recurringOptions.classList.remove('hidden');
                dateGroup.style.display = 'none';
                weeklyOptions.classList.toggle('hidden', automationFrequency !== 'weekly');
                cronOptions.classList.toggle('hidden', automationFrequency !== 'custom');
            } else {
                recurringOptions.classList.add('hidden');
                dateGroup.style.display = 'block';
                weeklyOptions.classList.add('hidden');
                cronOptions.classList.add('hidden');
            }

            // Update modal title and button
            document.querySelector('#automation-modal .modal-title').textContent = ' Edit Automation';
            document.querySelector('#automation-modal .modal-footer .btn-primary').textContent = 'Save Changes';
            document.querySelector('#automation-modal .modal-footer .btn-primary').onclick = updateAutomation;

            document.body.classList.add('modal-open');
            document.getElementById('automation-modal').classList.add('active');
        }

        async function updateAutomation() {
            if (!editingScheduleId) return;

            const name = document.getElementById('automation-name').value.trim();
            const prompt = document.getElementById('automation-prompt').value.trim();

            if (!name || !prompt) {
                alert('Please enter a name and task/prompt');
                return;
            }

            const data = {
                name: name,
                agent_type: automationAgentType,
                prompt: prompt,
                schedule_type: automationScheduleType,
                frequency: automationFrequency,
                date: document.getElementById('automation-date').value,
                time: document.getElementById('automation-time').value,
                days_of_week: automationDaysOfWeek,
                cron: document.getElementById('automation-cron')?.value || null,
                enabled: document.getElementById('automation-enabled').checked,
                timeout: automationTimeout
            };

            try {
                const response = await fetch(`${API_URL}/schedules/${editingScheduleId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeAutomationModal();
                    loadSchedules();
                } else {
                    const err = await response.json();
                    alert('Failed to update automation: ' + (err.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to update automation:', error);
                alert('Failed to update automation');
            }
        }

        async function runScheduleNow(scheduleId) {
            try {
                await fetch(`${API_URL}/schedules/${scheduleId}/run`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                // Refresh history after a short delay
                setTimeout(() => loadExecutionHistory(), 1000);
            } catch (error) {
                console.error('Failed to run schedule:', error);
            }
        }

        async function toggleSchedule(scheduleId, enabled) {
            try {
                await fetch(`${API_URL}/schedules/${scheduleId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
                loadSchedules();
            } catch (error) {
                console.error('Failed to toggle schedule:', error);
            }
        }

        async function deleteSchedule(scheduleId) {
            if (!await cerebroConfirm('Delete this automation?', { title: 'Delete Automation', danger: true, confirmText: 'Delete' })) return;

            try {
                await fetch(`${API_URL}/schedules/${scheduleId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadSchedules();
            } catch (error) {
                console.error('Failed to delete schedule:', error);
            }
        }

        // ==================== PARTICLE BACKGROUND ====================
        function initParticleBackground() {
            if (typeof tsParticles === 'undefined') return;

            tsParticles.load("particles-bg", {
                particles: {
                    number: { value: 40, density: { enable: true, value_area: 1000 } },
                    color: { value: ["#8b5cf6", "#a78bfa", "#6d28d9"] },
                    opacity: {
                        value: 0.3,
                        animation: { enable: true, speed: 0.5, minimumValue: 0.1, sync: false }
                    },
                    size: {
                        value: { min: 1, max: 3 },
                        animation: { enable: true, speed: 2, minimumValue: 0.5, sync: false }
                    },
                    move: {
                        enable: true,
                        speed: 0.3,
                        direction: "none",
                        random: true,
                        straight: false,
                        outModes: { default: "out" }
                    },
                    links: {
                        enable: true,
                        color: "#8b5cf6",
                        opacity: 0.15,
                        distance: 120,
                        width: 1
                    }
                },
                interactivity: {
                    events: {
                        onHover: { enable: true, mode: "grab" },
                        onClick: { enable: true, mode: "push" }
                    },
                    modes: {
                        grab: { distance: 150, links: { opacity: 0.3 } },
                        push: { quantity: 2 }
                    }
                },
                detectRetina: true,
                fpsLimit: 60
            });
        }

        // ==================== GSAP ANIMATION UTILITIES ====================
        function animateMessageIn(element, isUser = false) {
            if (typeof gsap === 'undefined') {
                element.style.animation = 'messageIn 0.3s ease forwards';
                return;
            }

            gsap.fromTo(element,
                {
                    opacity: 0,
                    y: 20,
                    scale: 0.95,
                    filter: 'blur(8px)'
                },
                {
                    opacity: 1,
                    y: 0,
                    scale: 1,
                    filter: 'blur(0px)',
                    duration: 0.4,
                    ease: 'power2.out'
                }
            );

            if (!isUser) {
                gsap.fromTo(element,
                    { boxShadow: '0 0 40px rgba(139, 92, 246, 0.4)' },
                    { boxShadow: '0 4px 16px rgba(0, 0, 0, 0.4)', duration: 0.8, delay: 0.2 }
                );
            }
        }

        function initCardHoverEffects() {
            document.querySelectorAll('.agent-card, .suggestion-card').forEach(card => {
                card.addEventListener('mouseenter', () => {
                    if (typeof gsap !== 'undefined') {
                        gsap.to(card, { y: -4, duration: 0.3, ease: 'power2.out' });
                    }
                });

                card.addEventListener('mouseleave', () => {
                    if (typeof gsap !== 'undefined') {
                        gsap.to(card, { y: 0, duration: 0.3, ease: 'power2.out' });
                    }
                });
            });
        }

        function animateListIn(selector) {
            if (typeof gsap === 'undefined') return;

            const elements = document.querySelectorAll(selector);
            gsap.fromTo(elements,
                { opacity: 0, y: 30 },
                {
                    opacity: 1,
                    y: 0,
                    duration: 0.4,
                    stagger: 0.08,
                    ease: 'power2.out'
                }
            );
        }

        function addRippleEffect(button) {
            button.addEventListener('click', function(e) {
                const rect = this.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const ripple = document.createElement('span');
                ripple.className = 'ripple';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                this.appendChild(ripple);

                if (typeof gsap !== 'undefined') {
                    gsap.fromTo(ripple,
                        { scale: 0, opacity: 0.5 },
                        {
                            scale: 4,
                            opacity: 0,
                            duration: 0.6,
                            ease: 'power2.out',
                            onComplete: () => ripple.remove()
                        }
                    );
                } else {
                    setTimeout(() => ripple.remove(), 600);
                }
            });
        }

        // ==================== STARTUP ====================
        document.addEventListener('DOMContentLoaded', async () => {
            // Populate configurable display values
            const dgxDisplay = document.getElementById('dgx-host-display');
            if (dgxDisplay) dgxDisplay.textContent = CEREBRO_DGX_HOST || 'Not configured';
            const dataDirDisplay = document.getElementById('data-dir-display');
            if (dataDirDisplay) dataDirDisplay.textContent = CEREBRO_DATA_DIR || 'Not configured';
            const usernameDisplay = document.getElementById('username-display');
            if (usernameDisplay) usernameDisplay.textContent = CEREBRO_USERNAME;
            const presenceGreeting = document.getElementById('presence-greeting');
            if (presenceGreeting && presenceGreeting.textContent === 'Hey') {
                presenceGreeting.textContent = `Hey ${CEREBRO_USERNAME}`;
            }

            if (token) {
                // Validate token before showing app
                try {
                    const response = await fetch(`${API_URL}/briefing`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        showApp();
                    } else {
                        // Token invalid - clear and show login
                        console.log('Token invalid, clearing...');
                        localStorage.removeItem('cerebro_token');
                        token = null;
                    }
                } catch (e) {
                    console.error('Token validation failed:', e);
                    // Don't clear token on network error, might be temporary
                }
            }

            document.getElementById('password-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') login();
            });

            // Auto-resize chat input
            const chatInput = document.getElementById('chat-input');
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
            });

            // Initialize particle background
            initParticleBackground();

            // Initialize GSAP hover effects
            initCardHoverEffects();

            // Add ripple effects to primary/secondary buttons
            document.querySelectorAll('.btn-primary, .btn-secondary').forEach(addRippleEffect);
        });
    </script>

    <!-- Cerebro Custom Confirm Dialog -->
    <div class="cerebro-confirm-overlay" id="cerebro-confirm-overlay">
        <div class="cerebro-confirm-box">
            <div class="cerebro-confirm-header">
                <div class="cerebro-confirm-icon warn" id="cerebro-confirm-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                </div>
                <div class="cerebro-confirm-title" id="cerebro-confirm-title">Are you sure?</div>
            </div>
            <div class="cerebro-confirm-body" id="cerebro-confirm-body"></div>
            <div class="cerebro-confirm-actions">
                <button class="cerebro-confirm-btn cancel" id="cerebro-confirm-cancel">Cancel</button>
                <button class="cerebro-confirm-btn confirm" id="cerebro-confirm-ok">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Custom confirm dialog - replaces browser confirm()
        function cerebroConfirm(message, options = {}) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('cerebro-confirm-overlay');
                const titleEl = document.getElementById('cerebro-confirm-title');
                const bodyEl = document.getElementById('cerebro-confirm-body');
                const okBtn = document.getElementById('cerebro-confirm-ok');
                const cancelBtn = document.getElementById('cerebro-confirm-cancel');
                const iconEl = document.getElementById('cerebro-confirm-icon');

                titleEl.textContent = options.title || 'Are you sure?';
                bodyEl.textContent = message;
                okBtn.textContent = options.confirmText || 'Confirm';
                cancelBtn.textContent = options.cancelText || 'Cancel';

                // Danger style
                if (options.danger) {
                    iconEl.className = 'cerebro-confirm-icon danger';
                    okBtn.className = 'cerebro-confirm-btn confirm danger';
                } else {
                    iconEl.className = 'cerebro-confirm-icon warn';
                    okBtn.className = 'cerebro-confirm-btn confirm';
                }

                overlay.classList.add('active');

                function cleanup(result) {
                    overlay.classList.remove('active');
                    okBtn.removeEventListener('click', onConfirm);
                    cancelBtn.removeEventListener('click', onCancel);
                    overlay.removeEventListener('click', onBackdrop);
                    document.removeEventListener('keydown', onKey);
                    resolve(result);
                }
                function onConfirm() { cleanup(true); }
                function onCancel() { cleanup(false); }
                function onBackdrop(e) { if (e.target === overlay) cleanup(false); }
                function onKey(e) { if (e.key === 'Escape') cleanup(false); if (e.key === 'Enter') cleanup(true); }

                okBtn.addEventListener('click', onConfirm);
                cancelBtn.addEventListener('click', onCancel);
                overlay.addEventListener('click', onBackdrop);
                document.addEventListener('keydown', onKey);

                okBtn.focus();
            });
        }
    </script>

    <!-- Voice Screenshot Overlay -->
    <div class="voice-screenshot-overlay" id="voiceScreenshotOverlay" onclick="if(event.target===this) closeVoiceScreenshotOverlay();">
        <button class="vs-overlay-close" onclick="closeVoiceScreenshotOverlay()">&times;</button>
        <img id="vsOverlayImg" src="" alt="Voice Screenshot" />
        <div class="vs-overlay-bar">
            <span class="vs-window-title" id="vsOverlayTitle"></span>
        </div>
    </div>

    <script>
        function showVoiceScreenshotOverlay(src, title) {
            var overlay = document.getElementById('voiceScreenshotOverlay');
            document.getElementById('vsOverlayImg').src = src;
            document.getElementById('vsOverlayTitle').textContent = title;
            overlay.classList.add('active');
            document.body.classList.add('modal-open');
        }
        function closeVoiceScreenshotOverlay() {
            var overlay = document.getElementById('voiceScreenshotOverlay');
            overlay.classList.remove('active');
            document.body.classList.remove('modal-open');
        }
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                var overlay = document.getElementById('voiceScreenshotOverlay');
                if (overlay && overlay.classList.contains('active')) {
                    closeVoiceScreenshotOverlay();
                }
            }
        });
    </script>

</body>
</html>
